<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>전투 관전</title>
<script src="/socket.io/socket.io.js"></script>
<style>
:root {
  --deep-navy: #0a0f1a;
  --navy: #0f1419;
  --navy-light: #1a1f26;
  --gold: #E5C88A;
  --gold-light: #F5E6B8;
  --gold-dark: #C8A882;
  --accent: #2a3441;
  --text-primary: #F5E6B8;
  --text-secondary: #D4C39A;
  --border: rgba(229, 200, 138, 0.3);
  --border-light: rgba(229, 200, 138, 0.15);
  --shadow: rgba(229, 200, 138, 0.2);
  --glass: rgba(15, 20, 25, 0.85);
  --glass-dark: rgba(10, 15, 26, 0.9);
  --success: #27ae60;
  --warning: #f39c12;
  --danger: #e74c3c;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  -webkit-tap-highlight-color: transparent;
}

body {
  background: linear-gradient(135deg, var(--deep-navy) 0%, var(--navy) 50%, var(--navy-light) 100%);
  color: var(--text-primary);
  font-family: 'Times New Roman', serif;
  min-height: 100vh;
  overflow-x: hidden;
  position: relative;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: 
    radial-gradient(circle at 20% 20%, rgba(229, 200, 138, 0.05) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(229, 200, 138, 0.05) 0%, transparent 50%),
    radial-gradient(circle at 40% 60%, rgba(229, 200, 138, 0.03) 0%, transparent 50%);
  pointer-events: none;
  z-index: -1;
}

.spectator-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.spectator-header {
  background: var(--glass-dark);
  border: 2px solid var(--border);
  border-radius: 16px;
  padding: 25px;
  backdrop-filter: blur(20px);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(229, 200, 138, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.spectator-title {
  font-size: 2.2rem;
  color: var(--gold);
  text-shadow: 0 0 20px rgba(229, 200, 138, 0.5);
  letter-spacing: 1px;
  margin: 0;
}

.connection-status {
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
  border: 2px solid;
  display: flex;
  align-items: center;
  gap: 8px;
}

.connection-status.connected {
  background: var(--success);
  color: white;
  border-color: var(--success);
}

.connection-status.disconnected {
  background: var(--danger);
  color: white;
  border-color: var(--danger);
}

.status-indicator {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: currentColor;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.auth-screen {
  background: var(--glass-dark);
  border: 2px solid var(--border);
  border-radius: 16px;
  padding: 40px;
  text-align: center;
  backdrop-filter: blur(20px);
  max-width: 500px;
  margin: 50px auto;
}

.auth-title {
  color: var(--gold);
  font-size: 1.8rem;
  margin-bottom: 30px;
  text-shadow: 0 0 15px rgba(229, 200, 138, 0.4);
}

.form-group {
  margin-bottom: 20px;
  text-align: left;
}

.form-label {
  color: var(--gold);
  font-weight: 600;
  margin-bottom: 8px;
  display: block;
  font-size: 14px;
}

.form-input {
  width: 100%;
  background: var(--navy-light);
  border: 2px solid var(--border-light);
  border-radius: 10px;
  padding: 12px 16px;
  color: var(--text-primary);
  font-size: 16px;
  transition: all 0.3s ease;
}

.form-input:focus {
  outline: none;
  border-color: var(--gold);
  box-shadow: 0 0 0 3px rgba(229, 200, 138, 0.1);
}

.btn {
  background: var(--gold-dark);
  border: 2px solid var(--gold);
  border-radius: 10px;
  padding: 12px 24px;
  color: var(--navy);
  cursor: pointer;
  font-size: 16px;
  font-weight: 600;
  transition: all 0.3s ease;
  width: 100%;
  margin-top: 20px;
}

.btn:hover {
  background: var(--gold);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(229, 200, 138, 0.4);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
  box-shadow: none !important;
}

.btn-primary {
  background: var(--gold-dark);
  border-color: var(--gold);
  color: var(--navy);
}

.waiting-message {
  background: var(--glass-dark);
  border: 2px solid var(--border);
  border-radius: 16px;
  padding: 60px 40px;
  text-align: center;
  backdrop-filter: blur(20px);
  margin: 50px auto;
  max-width: 600px;
}

.waiting-text {
  font-size: 1.8rem;
  color: var(--gold);
  margin-bottom: 15px;
  text-shadow: 0 0 15px rgba(229, 200, 138, 0.4);
}

.waiting-subtitle {
  color: var(--text-secondary);
  font-size: 1.1rem;
  line-height: 1.5;
}

.status-panel {
  background: var(--glass-dark);
  border: 2px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  backdrop-filter: blur(15px);
}

.status-title {
  color: var(--gold);
  font-size: 1.3rem;
  margin-bottom: 15px;
}

.status-text {
  color: var(--text-primary);
  font-size: 1.1rem;
  font-weight: 600;
}

.turn-info {
  background: var(--navy-light);
  border: 2px solid var(--border-light);
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  margin-bottom: 20px;
}

.turn-text {
  color: var(--gold);
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 10px;
}

.turn-timer {
  color: var(--text-secondary);
  font-size: 1rem;
}

.battle-arena {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 30px;
  margin-bottom: 30px;
}

.team-panel {
  background: var(--glass);
  border: 2px solid var(--border-light);
  border-radius: 12px;
  padding: 25px;
  backdrop-filter: blur(15px);
}

.team-title {
  color: var(--gold);
  font-size: 1.4rem;
  text-align: center;
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 2px solid var(--border-light);
  text-shadow: 0 0 10px rgba(229, 200, 138, 0.3);
}

.player-card {
  background: var(--navy-light);
  border: 1px solid var(--border-light);
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 15px;
  transition: all 0.3s ease;
}

.player-card.active {
  border-color: var(--gold);
  box-shadow: 0 0 15px rgba(229, 200, 138, 0.3);
}

.player-card.dead {
  opacity: 0.4;
  filter: grayscale(1);
}

.player-avatar {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: var(--accent);
  border: 2px solid var(--border-light);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--gold);
  font-weight: 600;
  font-size: 18px;
}

.player-info {
  flex: 1;
}

.player-name {
  color: var(--gold);
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 5px;
}

.player-hp {
  margin-bottom: 8px;
}

.hp-bar {
  background: var(--navy);
  border: 1px solid var(--border-light);
  border-radius: 10px;
  height: 8px;
  overflow: hidden;
  position: relative;
}

.hp-fill {
  background: linear-gradient(90deg, var(--success), var(--warning), var(--danger));
  height: 100%;
  transition: width 0.5s ease;
  border-radius: 10px;
}

.hp-text {
  color: var(--text-secondary);
  font-size: 12px;
  margin-top: 2px;
}

.player-stats {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr 1fr;
  gap: 5px;
  font-size: 11px;
  color: var(--text-secondary);
}

.stat-item {
  text-align: center;
  background: var(--navy);
  border-radius: 4px;
  padding: 2px 4px;
}

.player-buffs {
  margin-top: 8px;
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
}

.buff-icon {
  background: var(--accent);
  color: var(--gold);
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 600;
}

.logs-section {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 20px;
}

.log-panel {
  background: var(--glass);
  border: 2px solid var(--border-light);
  border-radius: 12px;
  padding: 20px;
  backdrop-filter: blur(15px);
}

.log-title {
  color: var(--gold);
  font-size: 1.3rem;
  margin-bottom: 15px;
  text-align: center;
}

.log-area {
  background: var(--navy);
  border: 1px solid var(--border-light);
  border-radius: 8px;
  height: 300px;
  overflow-y: auto;
  padding: 15px;
  font-family: 'Courier New', monospace;
  font-size: 13px;
  line-height: 1.4;
  color: var(--text-secondary);
}

.log-entry {
  margin-bottom: 8px;
  padding: 4px 0;
}

.log-entry.system {
  color: var(--gold);
}

.log-entry.action {
  color: var(--text-primary);
}

.log-entry.damage {
  color: var(--danger);
}

.log-entry.heal {
  color: var(--success);
}

.cheer-section {
  background: var(--glass);
  border: 2px solid var(--border-light);
  border-radius: 12px;
  padding: 20px;
  backdrop-filter: blur(15px);
}

.cheer-title {
  color: var(--gold);
  font-size: 1.2rem;
  margin-bottom: 15px;
  text-align: center;
}

.cheer-buttons {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 15px;
}

.cheer-btn {
  background: var(--accent);
  border: 2px solid var(--border-light);
  border-radius: 8px;
  padding: 8px 12px;
  color: var(--text-primary);
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s ease;
  text-align: center;
}

.cheer-btn:hover {
  background: var(--gold-dark);
  border-color: var(--gold);
  color: var(--navy);
  transform: translateY(-1px);
}

.cheer-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

.chat-area {
  background: var(--navy);
  border: 1px solid var(--border-light);
  border-radius: 8px;
  height: 150px;
  overflow-y: auto;
  padding: 10px;
  font-family: 'Courier New', monospace;
  font-size: 12px;
  line-height: 1.3;
  color: var(--text-secondary);
}

.chat-entry {
  margin-bottom: 4px;
}

.chat-entry.spectator {
  color: var(--warning);
}

.chat-entry.admin {
  color: var(--gold);
  font-weight: 600;
}

.hidden {
  display: none !important;
}

/* 반응형 디자인 */
@media (max-width: 1024px) {
  .battle-arena {
    grid-template-columns: 1fr;
  }
  
  .logs-section {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 768px) {
  .spectator-container {
    padding: 15px;
  }
  
  .spectator-header {
    flex-direction: column;
    gap: 15px;
    text-align: center;
  }
  
  .spectator-title {
    font-size: 1.8rem;
  }
  
  .cheer-buttons {
    grid-template-columns: 1fr;
  }
  
  .player-stats {
    grid-template-columns: 1fr 1fr;
  }
  
  .player-card {
    flex-direction: column;
    text-align: center;
    gap: 10px;
  }
  
  .player-avatar {
    width: 50px;
    height: 50px;
    font-size: 16px;
  }
}

@media (max-width: 480px) {
  .spectator-container {
    padding: 10px;
  }
  
  .spectator-title {
    font-size: 1.5rem;
  }
  
  .team-panel,
  .log-panel,
  .cheer-section {
    padding: 15px;
  }
  
  .auth-screen {
    padding: 30px 20px;
    margin: 20px auto;
  }
  
  .waiting-message {
    padding: 40px 20px;
    margin: 20px auto;
  }
  
  .waiting-text {
    font-size: 1.5rem;
  }
  
  .log-area,
  .chat-area {
    height: 200px;
  }
}
</style>
</head>
<body>
  <div class="spectator-container">
    <!-- 헤더 -->
    <div class="spectator-header">
      <h1 class="spectator-title">전투 관전</h1>
      <div id="connectionStatus" class="connection-status disconnected">
        <span class="status-indicator"></span>
        연결 끊김
      </div>
    </div>

    <!-- 인증 화면 -->
    <div id="authScreen" class="auth-screen">
      <h2 class="auth-title">관전자 입장</h2>
      
      <div class="form-group">
        <label class="form-label">관전자 이름</label>
        <input type="text" id="spectatorNameInput" class="form-input" placeholder="관전자 이름을 입력하세요" maxlength="20">
      </div>
      
      <div class="form-group">
        <label class="form-label">전투 ID</label>
        <input type="text" id="battleIdInput" class="form-input" placeholder="전투 ID를 입력하세요">
      </div>
      
      <div class="form-group">
        <label class="form-label">관전자 OTP</label>
        <input type="text" id="spectatorOtpInput" class="form-input" placeholder="OTP를 입력하세요">
      </div>
      
      <button onclick="authenticateSpectator()" class="btn btn-primary">
        관전 시작
      </button>
      
      <div style="margin-top: 20px; padding: 15px; background: var(--navy-light); border-radius: 8px; font-size: 14px; color: var(--text-secondary);">
        관전자는 채팅을 할 수 없으며, 간단한 응원 메시지만 전송할 수 있습니다.
      </div>
    </div>

    <!-- 대기 화면 -->
    <div id="waitingScreen" class="waiting-message hidden">
      <div class="waiting-text">전투 준비 중...</div>
      <div class="waiting-subtitle">전투가 시작될 때까지 기다려주세요</div>
    </div>

    <!-- 메인 관전 화면 -->
    <div id="spectatorScreen" class="hidden">
      <!-- 상태 패널 -->
      <div class="status-panel">
        <h3 class="status-title">전투 상태</h3>
        <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 10px;">
          <span class="status-indicator" id="battleStatusIndicator"></span>
          <span id="battleStatusText" class="status-text">대기중</span>
        </div>
        <div id="battleModeText" class="status-text" style="font-size: 1rem; color: var(--text-secondary);">-</div>
      </div>

      <!-- 턴 정보 -->
      <div id="turnInfo" class="turn-info hidden">
        <div id="turnText" class="turn-text">전투 준비 중...</div>
        <div id="turnTimer" class="turn-timer"></div>
      </div>

      <!-- 전투 아레나 -->
      <div class="battle-arena">
        <div class="team-panel">
          <h3 id="team1Title" class="team-title">불사조 기사단</h3>
          <div id="team1Players"></div>
        </div>
        
        <div class="team-panel">
          <h3 id="team2Title" class="team-title">죽음을 먹는자들</h3>
          <div id="team2Players"></div>
        </div>
      </div>

      <!-- 로그 섹션 -->
      <div class="logs-section">
        <div class="log-panel">
          <h3 class="log-title">전투 로그</h3>
          <div id="battleLog" class="log-area"></div>
        </div>
        
        <div class="cheer-section">
          <h3 class="cheer-title">응원하기</h3>
          
          <div class="cheer-buttons">
            <button class="cheer-btn" onclick="sendCheer('힘내!')">힘내!</button>
            <button class="cheer-btn" onclick="sendCheer('지지마!')">지지마!</button>
            <button class="cheer-btn" onclick="sendCheer('이길 수 있어!')">이길 수 있어!</button>
            <button class="cheer-btn" onclick="sendCheer('포기하지 마!')">포기하지 마!</button>
            <button class="cheer-btn" onclick="sendCheer('화이팅!')">화이팅!</button>
            <button class="cheer-btn" onclick="sendCheer('대박!')">대박!</button>
          </div>
          
          <div class="log-title" style="font-size: 1rem; margin: 15px 0 10px 0;">채팅</div>
          <div id="chatLog" class="chat-area"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let socket = null;
    let battleId = null;
    let spectatorName = null;
    let isAuthenticated = false;
    let currentBattle = null;

    // URL 파라미터에서 정보 추출
    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        battleId: params.get('battle'),
        token: params.get('token')
      };
    }

    // 페이지 로드 시 URL 파라미터 자동 입력
    window.addEventListener('load', () => {
      const params = getUrlParams();
      if (params.battleId) {
        document.getElementById('battleIdInput').value = params.battleId;
      }
      if (params.token) {
        document.getElementById('spectatorOtpInput').value = params.token;
      }
    });

    // Socket.IO 연결 초기화
    function initializeSocket() {
      if (socket) return;
      
      socket = io({
        transports: ['websocket', 'polling'],
        timeout: 20000,
        forceNew: true
      });

      socket.on('connect', () => {
        updateConnectionStatus(true);
        console.log('Socket 연결됨');
      });

      socket.on('disconnect', () => {
        updateConnectionStatus(false);
        console.log('Socket 연결 해제됨');
      });

      socket.on('authSuccess', (data) => {
        console.log('인증 성공', data);
        isAuthenticated = true;
        currentBattle = data.battle;
        
        document.getElementById('authScreen').classList.add('hidden');
        
        if (currentBattle.status === 'waiting') {
          document.getElementById('waitingScreen').classList.remove('hidden');
        } else {
          showSpectatorScreen();
        }
      });

      socket.on('authError', (error) => {
        console.log('인증 실패', error);
        alert('인증 실패: ' + error);
        isAuthenticated = false;
      });

      socket.on('battleUpdate', (battle) => {
        console.log('전투 업데이트', battle);
        currentBattle = battle;
        updateBattleDisplay();
        
        if (battle.status === 'ongoing' && !document.getElementById('spectatorScreen').classList.contains('hidden')) {
          // 이미 관전 화면이 표시된 경우
        } else if (battle.status === 'ongoing') {
          document.getElementById('waitingScreen').classList.add('hidden');
          showSpectatorScreen();
        }
      });

      socket.on('chatMessage', (data) => {
        addChatMessage(data);
      });
    }

    // 관전자 인증
    function authenticateSpectator() {
      const name = document.getElementById('spectatorNameInput').value.trim();
      const battleIdInput = document.getElementById('battleIdInput').value.trim();
      const otp = document.getElementById('spectatorOtpInput').value.trim();

      if (!name) {
        alert('관전자 이름을 입력하세요.');
        return;
      }

      if (!battleIdInput) {
        alert('전투 ID를 입력하세요.');
        return;
      }

      if (!otp) {
        alert('OTP를 입력하세요.');
        return;
      }

      battleId = battleIdInput;
      spectatorName = name;

      initializeSocket();

      // 인증 요청
      socket.emit('spectatorAuth', {
        battleId: battleId,
        otp: otp,
        spectatorName: spectatorName
      });
    }

    // 연결 상태 업데이트
    function updateConnectionStatus(connected) {
      const statusElement = document.getElementById('connectionStatus');
      if (connected) {
        statusElement.className = 'connection-status connected';
        statusElement.innerHTML = '<span class="status-indicator"></span>연결됨';
      } else {
        statusElement.className = 'connection-status disconnected';
        statusElement.innerHTML = '<span class="status-indicator"></span>연결 끊김';
      }
    }

    // 관전 화면 표시
    function showSpectatorScreen() {
      document.getElementById('waitingScreen').classList.add('hidden');
      document.getElementById('spectatorScreen').classList.remove('hidden');
      updateBattleDisplay();
    }

    // 전투 상태 업데이트
    function updateBattleDisplay() {
      if (!currentBattle) return;

      // 전투 상태
      const statusText = document.getElementById('battleStatusText');
      const statusIndicator = document.getElementById('battleStatusIndicator');
      
      switch (currentBattle.status) {
        case 'waiting':
          statusText.textContent = '대기중';
          break;
        case 'ongoing':
          statusText.textContent = '진행중';
          document.getElementById('turnInfo').classList.remove('hidden');
          updateTurnInfo();
          break;
        case 'ended':
          statusText.textContent = '종료';
          document.getElementById('turnInfo').classList.add('hidden');
          break;
      }

      // 전투 모드
      document.getElementById('battleModeText').textContent = `모드: ${currentBattle.mode}`;

      // 팀 플레이어 표시
      updateTeamPlayers('team1', currentBattle.teams.team1);
      updateTeamPlayers('team2', currentBattle.teams.team2);

      // 전투 로그 업데이트
      updateBattleLog();
    }

    // 턴 정보 업데이트
    function updateTurnInfo() {
      if (!currentBattle || currentBattle.status !== 'ongoing') return;

      const turnText = document.getElementById('turnText');
      const turnTimer = document.getElementById('turnTimer');

      if (currentBattle.currentTeam) {
        const teamName = currentBattle.teams[currentBattle.currentTeam].name;
        turnText.textContent = `${teamName} 팀 차례`;
        
        // 턴 타이머 (5분)
        if (currentBattle.turnStartTime) {
          const elapsed = Date.now() - currentBattle.turnStartTime;
          const remaining = Math.max(0, 300000 - elapsed); // 5분
          const minutes = Math.floor(remaining / 60000);
          const seconds = Math.floor((remaining % 60000) / 1000);
          turnTimer.textContent = `남은 시간: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
      } else {
        turnText.textContent = '전투 준비 중...';
        turnTimer.textContent = '';
      }
    }

    // 팀 플레이어 업데이트
    function updateTeamPlayers(teamId, team) {
      const container = document.getElementById(teamId + 'Players');
      if (!container || !team || !team.players) return;

      container.innerHTML = '';

      team.players.forEach(player => {
        const playerCard = document.createElement('div');
        playerCard.className = 'player-card';
        
        if (!player.alive) {
          playerCard.classList.add('dead');
        }
        
        if (currentBattle.status === 'ongoing' && player.team === currentBattle.currentTeam && !player.hasActed) {
          playerCard.classList.add('active');
        }

        const hpPercentage = Math.max(0, (player.hp / player.maxHp) * 100);
        
        const buffs = [];
        if (player.buffs && player.buffs.attack_buff) buffs.push('공격↑');
        if (player.buffs && player.buffs.defense_buff) buffs.push('방어↑');
        if (player.isDefending) buffs.push('방어');
        if (player.isDodging) buffs.push('회피');
        
        playerCard.innerHTML = `
          <div class="player-avatar">
            ${player.imageUrl ? `<img src="${player.imageUrl}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">` : player.name.charAt(0)}
          </div>
          <div class="player-info">
            <div class="player-name">${player.name}</div>
            <div class="player-hp">
              <div class="hp-bar">
                <div class="hp-fill" style="width: ${hpPercentage}%"></div>
              </div>
              <div class="hp-text">${player.hp}/${player.maxHp} HP</div>
            </div>
            <div class="player-stats">
              <div class="stat-item">공격 ${player.stats.attack}</div>
              <div class="stat-item">방어 ${player.stats.defense}</div>
              <div class="stat-item">민첩 ${player.stats.agility}</div>
              <div class="stat-item">행운 ${player.stats.luck}</div>
            </div>
            ${buffs.length > 0 ? `
              <div class="player-buffs">
                ${buffs.map(buff => `<span class="buff-icon">${buff}</span>`).join('')}
              </div>
            ` : ''}
          </div>
        `;
        
        container.appendChild(playerCard);
      });
    }

    // 전투 로그 업데이트
    function updateBattleLog() {
      if (!currentBattle || !currentBattle.battleLog) return;

      const logArea = document.getElementById('battleLog');
      logArea.innerHTML = '';

      currentBattle.battleLog.slice(-50).forEach(entry => {
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry ${entry.type}`;
        
        const timestamp = new Date(entry.timestamp).toLocaleTimeString();
        logEntry.innerHTML = `[${timestamp}] ${entry.message}`;
        
        logArea.appendChild(logEntry);
      });

      logArea.scrollTop = logArea.scrollHeight;
    }

    // 채팅 메시지 추가
    function addChatMessage(data) {
      const chatArea = document.getElementById('chatLog');
      const chatEntry = document.createElement('div');
      chatEntry.className = `chat-entry ${data.senderType}`;
      
      const timestamp = new Date(data.timestamp).toLocaleTimeString();
      chatEntry.innerHTML = `[${timestamp}] ${data.sender}: ${data.message}`;
      
      chatArea.appendChild(chatEntry);
      chatArea.scrollTop = chatArea.scrollHeight;

      // 최대 50개 메시지 유지
      while (chatArea.children.length > 50) {
        chatArea.removeChild(chatArea.firstChild);
      }
    }

    // 응원 메시지 전송
    function sendCheer(message) {
      if (!socket || !isAuthenticated) {
        alert('연결이 끊어졌습니다. 페이지를 새로고침하세요.');
        return;
      }

      socket.emit('cheerMessage', { message });
      
      // 응원 메시지 전송 후 잠시 비활성화
      const cheerBtns = document.querySelectorAll('.cheer-btn');
      cheerBtns.forEach(btn => {
        btn.disabled = true;
      });
      
      setTimeout(() => {
        cheerBtns.forEach(btn => {
          btn.disabled = false;
        });
      }, 3000); // 3초 쿨다운
    }

    // 키보드 이벤트
    document.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        if (document.getElementById('authScreen').style.display !== 'none') {
          authenticateSpectator();
        }
      }
    });

    // 1초마다 턴 타이머 업데이트
    setInterval(() => {
      if (currentBattle && currentBattle.status === 'ongoing') {
        updateTurnInfo();
      }
    }, 1000);

    // 페이지 언로드 시 소켓 정리
    window.addEventListener('beforeunload', () => {
      if (socket) {
        socket.disconnect();
      }
    });

    // 하트비트 (연결 유지)
    setInterval(() => {
      if (socket && socket.connected) {
        socket.emit('heartbeat');
      }
    }, 30000);

    console.log('관전자 페이지 로드 완료');
  </script>
</body>
</html>
