<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PYXIS 관전자</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;800;900&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
<script src="/socket.io/socket.io.js"></script>
<style>
  :root{
    /* 네이비 + 골드 팔레트 */
    --navy:#001E35;
    --navy-0:#001528;
    --navy-1:#012443;
    --glass:#05223fcc;
    --glass-2:#062846cc;
    --border:#0b2a4a;
    --border-2:#0a355e;

    --ink:#F2F1ED;
    --muted:#BFD0E1;

    --gold:#D4BA8D;
    --gold-2:#E5D7BE;

    --blur: blur(12px) saturate(120%);
    --lift: 0 14px 30px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.03);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:"Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    background:
      radial-gradient(1200px 600px at 20% -10%, rgba(212,186,141,.10), transparent 60%),
      linear-gradient(180deg, var(--navy-0) 0%, var(--navy) 40%, var(--navy-1) 100%);
  }

  header{position:relative; padding:18px 16px 8px 16px}
  header::before{
    content:""; position:absolute; inset:-35% -10% auto -10%; height:320px;
    background:conic-gradient(from 0deg, rgba(212,186,141,.20), rgba(212,186,141,.05), rgba(212,186,141,.20));
    filter:blur(48px); animation:spin 36s linear infinite; opacity:.55; pointer-events:none;
  }
  @keyframes spin{to{transform:rotate(360deg)}}
  .wrap{max-width:1280px; margin:0 auto}
  .brand{
    font-family:"Cinzel", serif; font-weight:900; letter-spacing:.06em;
    font-size:30px; display:inline-block;
    background:linear-gradient(180deg,var(--gold-2),var(--gold));
    -webkit-background-clip:text; background-clip:text; color:transparent;
  }

  /* 그리드 레이아웃 */
  .stage{display:grid; grid-template-columns:260px 1fr 260px; gap:14px; padding:12px 16px}
  @media (max-width:1100px){ .stage{grid-template-columns:1fr} }

  .card{
    background:linear-gradient(180deg,var(--glass),var(--glass-2));
    border:1px solid var(--border); border-top:1px solid rgba(255,255,255,.05);
    border-radius:16px; padding:12px; backdrop-filter:var(--blur); box-shadow:var(--lift);
  }

  /* 좌/우 팀 패널 */
  .side{display:flex; flex-direction:column; gap:10px}
  .unit{display:flex; gap:10px; align-items:center; border:1px solid var(--border); border-radius:12px; padding:8px; background:#05243f}
  .unit .avatar{width:44px; height:44px; border-radius:8px; background:#0b1630 center/cover no-repeat; border:1px solid var(--border)}
  .unit .meta{flex:1}
  .hpbar{height:8px;background:#0a2a4a;border-radius:8px;overflow:hidden;margin-top:4px}
  .hpbar>span{display:block;height:100%;background:linear-gradient(90deg,#4aa3ff,#6ee7f9)}
  .unit.active{outline:2px solid rgba(212,186,141,.45)}
  .unit.dead{opacity:.55}

  /* 중앙 */
  .center{display:grid; grid-template-rows:auto 260px 220px; gap:12px}
  @media (max-width:1100px){ .center{grid-template-rows:auto 260px 240px} }

  .portrait{
    position:relative; min-height:200px; display:flex; align-items:flex-end; justify-content:center;
    border:1px solid var(--border); border-radius:16px;
    background:linear-gradient(180deg,#031b30,#031b30);
    overflow:hidden;
  }
  .portrait .img{
    position:absolute; bottom:0; width:40%; max-width:360px; aspect-ratio:3/4; background:#0b1630 center/cover no-repeat; border:1px solid var(--border);
    border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.45);
  }
  .portrait.left  .img{left:24px}
  .portrait.right .img{right:24px}
  .portrait .nameplate{
    position:absolute; top:10px; left:12px; right:12px; display:flex; justify-content:space-between; align-items:center;
    font-weight:700; color:var(--gold);
  }
  .portrait .stats{
    position:absolute; bottom:12px; left:12px; right:12px; display:flex; gap:12px; flex-wrap:wrap; color:#dfe9f4; font-size:14px;
    background:#05243faa; border:1px solid var(--border); border-radius:10px; padding:8px 10px;
  }

  /* 채팅/로그 뷰 (읽기 전용) */
  .view{height:100%; overflow:auto; background:#061c33; border:1px solid var(--border); border-radius:12px; padding:10px}
  .line{display:flex; gap:8px; align-items:baseline; margin-bottom:6px}
  .ts{font-size:11px;color:#8fb0ce;min-width:54px;flex:0 0 auto}

  .view::-webkit-scrollbar{height:10px;width:10px}
  .view::-webkit-scrollbar-track{background:#051628;border-radius:10px}
  .view::-webkit-scrollbar-thumb{background:#0f335a;border-radius:10px;border:2px solid #051628}

  /* 응원 프리셋 */
  .cheers{display:flex; gap:8px; flex-wrap:wrap}
  .btn{
    border:1px solid var(--border-2); color:var(--ink);
    background:linear-gradient(180deg,#0c3458,#092a4b);
    padding:10px 12px; border-radius:12px; cursor:pointer; position:relative; overflow:hidden;
    transition:transform .15s ease, box-shadow .15s ease;
  }
  .btn:hover{transform:translateY(-1px)}
  .btn.gold{border-color:#7b694d; background:linear-gradient(180deg,#E5D7BE,#D4BA8D); color:#2a200f}
  .btn[disabled]{opacity:.55; cursor:not-allowed}

  /* 인증 폼 */
  .auth{
    display:none; gap:10px; align-items:end; flex-wrap:wrap;
    border:1px solid var(--border); border-radius:12px; padding:10px; background:#05243f
  }
  .field{display:flex; flex-direction:column; gap:6px}
  .input, .select{
    padding:10px 12px; border-radius:10px; background:#05243f; color:var(--ink); border:1px solid var(--border);
  }
  .input:focus, .select:focus{outline:1px solid var(--gold); box-shadow:0 0 0 3px rgba(212,186,141,.18)}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">Pyxis</div>
  </div>
</header>

<main class="wrap stage">
  <!-- 좌측: 팀1(불사조 기사단) -->
  <aside class="side" id="teamLeft"></aside>

  <!-- 중앙 -->
  <section class="center">
    <!-- 인증 폼 (URL 파라미터 없을 때 표시) -->
    <div class="card auth" id="authBox">
      <div class="field">
        <label for="aBattle">전투 ID</label>
        <input id="aBattle" class="input" placeholder="battle_xxxxx" />
      </div>
      <div class="field">
        <label for="aToken">관전자 OTP</label>
        <input id="aToken" class="input" placeholder="관전자 OTP" />
      </div>
      <div class="field" style="min-width:220px">
        <label for="aName">표시 이름</label>
        <input id="aName" class="input" placeholder="관전자 이름" />
      </div>
      <button id="aJoin" class="btn gold">입장</button>
    </div>

    <div class="card portrait" id="portrait">
      <div class="nameplate">
        <div id="turnInfo">대기중</div>
        <div id="modeInfo" style="color:#dfe9f4; font-weight:600"></div>
      </div>
      <div class="img" id="portraitImg" style="display:none"></div>
      <div class="stats" id="portraitStats" style="display:none"></div>
    </div>

    <div class="card" style="display:grid; grid-template-rows:auto 1fr">
      <div class="cheers">
        <button class="btn gold" data-cheer="힘내!">힘내!</button>
        <button class="btn" data-cheer="지지마!">지지마!</button>
        <button class="btn" data-cheer="이길 수 있어!">이길 수 있어!</button>
        <button class="btn" data-cheer="포기하지 마!">포기하지 마!</button>
      </div>
      <div id="chat" class="view" aria-label="채팅(읽기 전용)"></div>
    </div>

    <div class="card">
      <div id="logs" class="view" aria-label="전투 로그"></div>
    </div>
  </section>

  <!-- 우측: 팀2(죽음을 먹는 자들) -->
  <aside class="side" id="teamRight"></aside>
</main>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  const teamLeft  = $('teamLeft');
  const teamRight = $('teamRight');
  const portrait  = $('portrait');
  const portraitImg = $('portraitImg');
  const portraitStats = $('portraitStats');
  const turnInfo  = $('turnInfo');
  const modeInfo  = $('modeInfo');

  const chatEl = $('chat');
  const logsEl = $('logs');

  const authBox = $('authBox'), aBattle=$('aBattle'), aToken=$('aToken'), aName=$('aName'), aJoin=$('aJoin');

  const socket = io({ path: '/socket.io/' });
  let state = null;

  // URL 파라미터 → 자동 인증
  const qs = new URLSearchParams(location.search);
  let battle = qs.get('battle') || '';
  let token  = qs.get('token')  || '';
  let name   = qs.get('name')   || '';

  if (!battle || !token || !name) {
    authBox.style.display = 'flex';
  } else {
    tryAuth(battle, token, name);
  }

  aJoin.onclick = ()=>{
    const b=aBattle.value.trim(), t=aToken.value.trim(), n=aName.value.trim();
    if (!b || !t || !n) return alert('전투 ID / 관전자 OTP / 이름을 입력하세요');
    tryAuth(b,t,n);
  };

  function tryAuth(b,t,n){
    socket.emit('auth', { battle:b, token:t, role:'spectator', name:n }, (ack)=>{
      if (!ack || !ack.ok) { alert('인증 실패'); return; }
      authBox.style.display = 'none';
      battle=b; token=t; name=n;
      state = ack.state;
      renderAll();
    });
  }

  // 공통 포맷
  function fmtTs(ts){ try{ return new Date(ts).toLocaleTimeString([], {hour12:false}); }catch{return '--:--:--';} }
  function appendChat(m){
    const row = document.createElement('div'); row.className='line';
    const ts = document.createElement('span'); ts.className='ts'; ts.textContent = fmtTs(m.ts||Date.now());
    const body = document.createElement('span');
    if (m.type === 'system')      body.textContent = '[시스템] ' + m.text;
    else if (m.type === 'cheer')  body.textContent = '[응원] ' + (m.from||'관전자') + ': ' + m.text;
    else if (m.type === 'chat')   body.textContent = '[전체] ' + (m.from||'') + ': ' + (m.text||m.message||'');
    else                          body.textContent = m.text || JSON.stringify(m);
    row.appendChild(ts); row.appendChild(body);
    chatEl.appendChild(row); chatEl.scrollTop = chatEl.scrollHeight;
  }
  function appendLog(text){
    const row = document.createElement('div'); row.className='line';
    const ts = document.createElement('span'); ts.className='ts'; ts.textContent = fmtTs(Date.now());
    const body = document.createElement('span'); body.textContent = text;
    row.appendChild(ts); row.appendChild(body);
    logsEl.appendChild(row); logsEl.scrollTop = logsEl.scrollHeight;
  }

  // 렌더링
  function hpPct(p){ return Math.max(0, Math.min(100, Math.round((p.hp/p.maxHp)*100))); }
  function currentActorPid(){
    const t = state && state.turn;
    if (!t) return null;
    if (Array.isArray(t.pending) && t.pending.length) return t.pending[0];
    return null;
  }
  function smallUnit(p){
    const el = document.createElement('div'); el.className='unit' + (p.alive?'':' dead');
    if (currentActorPid() === p.id) el.classList.add('active');

    const av = document.createElement('div'); av.className='avatar';
    if (p.avatar) av.style.backgroundImage = `url(${p.avatar})`;
    el.appendChild(av);

    const meta = document.createElement('div'); meta.className='meta';
    const nm = document.createElement('div'); nm.style.fontWeight='700'; nm.textContent = p.name + (p.alive?'':' (불능)');
    const bar = document.createElement('div'); bar.className='hpbar'; const span = document.createElement('span'); span.style.width = hpPct(p)+'%'; bar.appendChild(span);
    const st = document.createElement('div'); st.style.color='#c7d7e6'; st.style.fontSize='12px';
    st.textContent = `공격 ${p.stats.attack} / 방어 ${p.stats.defense} / 민첩 ${p.stats.agility} / 행운 ${p.stats.luck}`;
    meta.appendChild(nm); meta.appendChild(bar); meta.appendChild(st);
    el.appendChild(meta);
    return el;
  }
  function byTeam(team){ return Object.values(state.players||{}).filter(p=>p.team===team); }
  function renderSides(){
    const left = byTeam('team1'), right = byTeam('team2');
    teamLeft.innerHTML=''; teamRight.innerHTML='';
    left.forEach(p=> teamLeft.appendChild(smallUnit(p)));
    right.forEach(p=> teamRight.appendChild(smallUnit(p)));
  }
  function renderPortrait(){
    const pid = currentActorPid();
    const p = pid ? state.players[pid] : null;

    const dir = p && p.team==='team2' ? 'right' : 'left';
    portrait.classList.toggle('left',  dir==='left');
    portrait.classList.toggle('right', dir==='right');

    const tm = p ? (p.team==='team1' ? '불사조 기사단' : '죽음을 먹는 자들') : '';
    turnInfo.textContent = p ? `${p.name}의 차례` : '대기중';
    modeInfo.textContent = state ? `${state.mode || ''}` : '';

    if (p && p.avatar){
      portraitImg.style.display='block';
      portraitImg.style.backgroundImage = `url(${p.avatar})`;
    } else {
      portraitImg.style.display='none';
      portraitImg.style.backgroundImage = '';
    }

    if (p){
      portraitStats.style.display='flex';
      portraitStats.innerHTML =
        `<div>팀: ${tm}</div>
         <div>HP: ${p.hp} / ${p.maxHp}</div>
         <div>공격 ${p.stats.attack}</div>
         <div>방어 ${p.stats.defense}</div>
         <div>민첩 ${p.stats.agility}</div>
         <div>행운 ${p.stats.luck}</div>`;
    }else{
      portraitStats.style.display='none';
      portraitStats.innerHTML = '';
    }
  }
  function renderLogsFromState(){
    logsEl.innerHTML = '';
    (state.chat||[]).slice(-200).forEach(m=>{
      if (m.type === 'system'){
        appendLog(m.text);
      }
    });
  }
  function renderAll(){
    if (!state) return;
    renderSides();
    renderPortrait();
    renderLogsFromState();
  }

  // 소켓 수신
  socket.on('state', s => { state=s; renderAll(); });
  socket.on('chat', appendChat);
  socket.on('chatError', txt => alert(txt));

  // 응원 프리셋 전송
  document.querySelectorAll('[data-cheer]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const text = btn.dataset.cheer;
      // 서버에 cheer 이벤트가 있는 경우 우선 사용, 실패 시 chatMessage(kind: 'cheer')로 폴백
      socket.emit('cheer', { text }, (ack)=>{
        if (!ack || !ack.ok){
          socket.emit('chatMessage', { message:text, channel:'all', kind:'cheer' }, ()=>{});
        }
      });
    });
  });
})();
</script>
</body>
</html>
