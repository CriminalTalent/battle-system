<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PYXIS 관전자</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;800;900&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
<script src="/socket.io/socket.io.js"></script>
<style>
  :root{
    /* 네이비 + 골드 고정 팔레트 */
    --bg-0:#05090f;
    --bg-1:#081223;
    --bg-2:#0b172d;
    --glass:#0e1a33cc;
    --glass-2:#122242cc;
    --border:#1f2b46;
    --border-2:#162139;

    --ink:#e9e3d0;
    --ink-dim:#cfc7b2;
    --muted:#9fb0d1;

    --gold:#c9a96e;
    --gold-2:#e6d2a6;

    --blur: blur(12px) saturate(120%);
    --lift: 0 14px 30px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.03);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:"Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    background:
      radial-gradient(1200px 600px at 20% -10%, rgba(201,169,110,.10), transparent 60%),
      linear-gradient(180deg, #020509 0%, #051021 40%, #0a1830 100%);
  }

  /* 헤더(브랜딩) */
  header{position:relative; padding:18px 16px 8px 16px}
  header::before{
    content:""; position:absolute; inset:-35% -10% auto -10%; height:320px;
    background:conic-gradient(from 0deg, rgba(201,169,110,.18), rgba(201,169,110,.03), rgba(201,169,110,.18));
    filter:blur(48px); animation:spin 36s linear infinite; opacity:.55; pointer-events:none;
  }
  @keyframes spin{to{transform:rotate(360deg)}}

  .wrap{max-width:1280px; margin:0 auto}
  .brand{
    font-family:"Cinzel", serif; font-weight:900; letter-spacing:.06em;
    font-size:30px; position:relative; display:inline-block;
    background:linear-gradient(180deg,var(--gold-2),var(--gold));
    -webkit-background-clip:text; background-clip:text; color:transparent;
  }

  /* 메인 3열 스테이지 */
  .stage{display:grid; grid-template-columns:260px 1fr 260px; gap:14px; padding:12px 16px}
  @media (max-width:1100px){ .stage{grid-template-columns:1fr} }

  /* 카드 */
  .card{
    background:linear-gradient(180deg,var(--glass),var(--glass-2));
    border:1px solid var(--border); border-top:1px solid rgba(255,255,255,.05);
    border-radius:16px; padding:12px; backdrop-filter:var(--blur); box-shadow:var(--lift);
  }

  /* 좌/우 팀 리스트 */
  .side{display:flex; flex-direction:column; gap:10px}
  .unit{display:flex; gap:10px; align-items:center; border:1px solid var(--border); border-radius:12px; padding:8px; background:#0f1d39}
  .unit .avatar{width:44px; height:44px; border-radius:8px; background:#0b1630 center/cover no-repeat; border:1px solid var(--border)}
  .unit .meta{flex:1}
  .hpbar{height:8px;background:#172642;border-radius:8px;overflow:hidden;margin-top:4px}
  .hpbar>span{display:block;height:100%;background:linear-gradient(90deg,#58a7ff,#67e8f9)}
  .unit.active{outline:2px solid rgba(201,169,110,.4)}
  .unit.dead{opacity:.55}

  /* 중앙 레이아웃 */
  .center{display:grid; grid-template-rows:auto auto 200px 280px 220px; gap:12px}
  @media (max-width:1100px){ .center{grid-template-rows:auto auto 200px 300px 240px} }

  /* 액티브 포트레이트(반신) */
  .portrait{
    position:relative; min-height:200px; display:flex; align-items:flex-end; justify-content:center;
    border:1px solid var(--border); border-radius:16px;
    background:linear-gradient(180deg,#0a1224,#0a1224);
    overflow:hidden;
  }
  .portrait .img{
    position:absolute; bottom:0; width:40%; max-width:360px; aspect-ratio:3/4; background:#0b1630 center/cover no-repeat; border:1px solid var(--border);
    border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.45);
  }
  .portrait.left  .img{left:24px}
  .portrait.right .img{right:24px}
  .portrait .nameplate{
    position:absolute; top:10px; left:12px; right:12px; display:flex; justify-content:space-between; align-items:center;
    font-weight:700; color:var(--gold);
  }
  .portrait .stats{
    position:absolute; bottom:12px; left:12px; right:12px; display:flex; gap:12px; flex-wrap:wrap; color:#cfd6ea; font-size:14px;
    background:#0c162eaa; border:1px solid var(--border); border-radius:10px; padding:8px 10px;
  }

  /* 응원 패널 */
  .cheers .btn{
    border:1px solid var(--border-2); color:var(--ink);
    background:linear-gradient(180deg,#213456,#172a4a);
    padding:10px 12px; border-radius:12px; cursor:pointer; position:relative; overflow:hidden;
    transition:transform .15s ease, box-shadow .15s ease;
  }
  .cheers .btn:hover{transform:translateY(-1px)}
  .cheers .row{display:flex; flex-wrap:wrap; gap:8px}
  .hint{color:#aeb7cf; font-size:12px}

  /* 채팅, 로그 */
  .chat, .logs{height:100%; overflow:auto; background:#0b1630; border:1px solid var(--border); border-radius:12px; padding:10px}
  .ts{font-size:11px;color:#8aa0c2;min-width:54px;flex:0 0 auto}
  .line{display:flex; gap:8px; align-items:baseline; margin-bottom:6px}

  .chat::-webkit-scrollbar, .logs::-webkit-scrollbar{height:10px;width:10px}
  .chat::-webkit-scrollbar-track, .logs::-webkit-scrollbar-track{background:#0b1426;border-radius:10px}
  .chat::-webkit-scrollbar-thumb, .logs::-webkit-scrollbar-thumb{background:#1e2d4f;border-radius:10px;border:2px solid #0b1426}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">Pyxis</div>
  </div>
</header>

<main class="wrap stage">
  <!-- 좌측: 팀1 -->
  <aside class="side" id="teamLeft"></aside>

  <!-- 중앙 -->
  <section class="center">
    <!-- 액티브 포트레이트 -->
    <div class="card portrait" id="portrait">
      <div class="nameplate">
        <div id="turnInfo">대기중</div>
        <div id="modeInfo" style="color:#cfd6ea; font-weight:600"></div>
      </div>
      <div class="img" id="portraitImg" style="display:none"></div>
      <div class="stats" id="portraitStats" style="display:none"></div>
    </div>

    <!-- 관전자 정보 -->
    <div class="card" id="viewerCard">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap">
        <div>
          <div id="viewerName" style="font-weight:800; color:var(--gold)"></div>
          <div id="viewerInfo" class="hint"></div>
        </div>
        <div class="hint">관전은 채팅 대신 응원 버튼만 전송됩니다.</div>
      </div>
    </div>

    <!-- 응원 버튼 -->
    <div class="card cheers">
      <div class="row">
        <button class="btn" data-cheer="힘내!">힘내!</button>
        <button class="btn" data-cheer="지지마!">지지마!</button>
        <button class="btn" data-cheer="이길 수 있어!">이길 수 있어!</button>
        <button class="btn" data-cheer="포기하지 마!">포기하지 마!</button>
      </div>
      <div class="hint" style="margin-top:6px">허용된 문구만 전송됩니다.</div>
    </div>

    <!-- 채팅(읽기 전용) -->
    <div class="card">
      <div id="chat" class="chat"></div>
    </div>

    <!-- 전투 로그 -->
    <div class="card">
      <div id="logs" class="logs"></div>
    </div>
  </section>

  <!-- 우측: 팀2 -->
  <aside class="side" id="teamRight"></aside>
</main>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  // DOM
  const teamLeft  = $('teamLeft');
  const teamRight = $('teamRight');
  const portrait  = $('portrait');
  const portraitImg = $('portraitImg');
  const portraitStats = $('portraitStats');
  const turnInfo  = $('turnInfo');
  const modeInfo  = $('modeInfo');
  const viewerName = $('viewerName');
  const viewerInfo = $('viewerInfo');

  const chatEl = $('chat');
  const logsEl = $('logs');

  // 소켓 & 상태
  const socket = io({ path: '/socket.io/' });
  let state = null;

  // 쿼리 인증
  const qs = new URLSearchParams(location.search);
  const battle = qs.get('battle');
  const token  = qs.get('token');
  const name   = qs.get('name') || '관전자';

  viewerName.textContent = name;
  viewerInfo.textContent = '관전 중';

  function fmtTs(ts){ try{ return new Date(ts).toLocaleTimeString([], {hour12:false}); }catch{return '--:--:--';} }

  function appendChat(m){
    const row = document.createElement('div'); row.className='line';
    const ts = document.createElement('span'); ts.className='ts'; ts.textContent = fmtTs(m.ts||Date.now());
    const body = document.createElement('span');
    if (m.type === 'system')      body.textContent = '[시스템] ' + m.text;
    else if (m.type === 'cheer')  body.textContent = '[응원] ' + (m.from||'관전자') + ': ' + m.text;
    else if (m.type === 'chat')   body.textContent = '[' + (m.channel==='team'?'팀':'전체') + '] ' + (m.from||'익명') + ': ' + (m.text||m.message||'');
    else                          body.textContent = m.text || JSON.stringify(m);
    row.appendChild(ts); row.appendChild(body);
    chatEl.appendChild(row); chatEl.scrollTop = chatEl.scrollHeight;
  }
  function appendLog(text){
    const row = document.createElement('div'); row.className='line';
    const ts = document.createElement('span'); ts.className='ts'; ts.textContent = fmtTs(Date.now());
    const body = document.createElement('span'); body.textContent = text;
    row.appendChild(ts); row.appendChild(body);
    logsEl.appendChild(row); logsEl.scrollTop = logsEl.scrollHeight;
  }

  function byTeam(team){ return Object.values(state.players||{}).filter(p=>p.team===team); }

  function currentActorPid(){
    const t = state && state.turn;
    if (!t) return null;
    if (Array.isArray(t.pending) && t.pending.length) return t.pending[0];
    return null;
  }

  function hpPct(p){ return Math.max(0, Math.min(100, Math.round((p.hp/p.maxHp)*100))); }

  function smallUnit(p){
    const el = document.createElement('div'); el.className='unit' + (p.alive?'':' dead');
    if (currentActorPid() === p.id) el.classList.add('active');

    const av = document.createElement('div'); av.className='avatar';
    if (p.avatar) av.style.backgroundImage = `url(${p.avatar})`;
    el.appendChild(av);

    const meta = document.createElement('div'); meta.className='meta';
    const nm = document.createElement('div'); nm.style.fontWeight='700'; nm.textContent = p.name + (p.alive?'':' (불능)');
    const bar = document.createElement('div'); bar.className='hpbar'; const span = document.createElement('span'); span.style.width = hpPct(p)+'%'; bar.appendChild(span);
    const st = document.createElement('div'); st.style.color='#aeb7cf'; st.style.fontSize='12px';
    st.textContent = `공격 ${p.stats.attack} / 방어 ${p.stats.defense} / 민첩 ${p.stats.agility} / 행운 ${p.stats.luck}`;
    meta.appendChild(nm); meta.appendChild(bar); meta.appendChild(st);
    el.appendChild(meta);
    return el;
  }

  function renderSides(){
    teamLeft.innerHTML=''; teamRight.innerHTML='';
    byTeam('team1').forEach(p=>teamLeft.appendChild(smallUnit(p)));
    byTeam('team2').forEach(p=>teamRight.appendChild(smallUnit(p)));
  }

  function renderPortrait(){
    const pid = currentActorPid();
    const p = pid ? state.players[pid] : null;
    const dir = p && p.team==='team2' ? 'right' : 'left';
    portrait.classList.toggle('left',  dir==='left');
    portrait.classList.toggle('right', dir==='right');

    const tm = p ? (p.team==='team1' ? '불사조 기사단' : '죽음을 먹는 자들') : '';
    turnInfo.textContent = p ? `${p.name}의 차례` : '대기중';
    modeInfo.textContent = state ? `${state.mode || ''}` : '';

    if (p && p.avatar){
      portraitImg.style.display='block';
      portraitImg.style.backgroundImage = `url(${p.avatar})`;
    } else {
      portraitImg.style.display='none';
      portraitImg.style.backgroundImage = '';
    }

    if (p){
      portraitStats.style.display='flex';
      portraitStats.innerHTML =
        `<div>팀: ${tm}</div>
         <div>HP: ${p.hp} / ${p.maxHp}</div>
         <div>공격 ${p.stats.attack}</div>
         <div>방어 ${p.stats.defense}</div>
         <div>민첩 ${p.stats.agility}</div>
         <div>행운 ${p.stats.luck}</div>`;
    }else{
      portraitStats.style.display='none';
      portraitStats.innerHTML = '';
    }
  }

  function renderLogsFromState(){
    logsEl.innerHTML = '';
    (state.chat||[]).slice(-200).forEach(m=>{
      if (m.type === 'system'){
        appendLog(m.text);
      }
    });
  }

  function renderAll(){
    if (!state) return;
    renderSides();
    renderPortrait();
    renderLogsFromState();
  }

  // 소켓 인증
  socket.on('connect', ()=>{
    socket.emit('auth', { battle, token, role:'spectator', name }, (ack)=>{
      if (!ack || !ack.ok) { alert('인증 실패'); return; }
      state = ack.state;
      renderAll();
    });
  });

  socket.on('state', s => { state = s; renderAll(); });
  socket.on('chat', appendChat);

  // 응원 버튼
  document.querySelectorAll('[data-cheer]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const phrase = btn.getAttribute('data-cheer');
      // 관전자 전용 이벤트 가정: cheer
      socket.emit('cheer', { text: phrase }, (ack)=>{
        if (ack && ack.error) alert('전송 실패: ' + ack.error);
      });
    });
  });
})();
</script>
</body>
</html>
