<!doctype html>
</div>


<div class="card" id="watchCard" style="display:none">
<div class="teams" id="teams"></div>


<div class="chat" id="chat"></div>
<div class="flex" style="margin-top:8px">
<button class="btn" data-p="a">응원합니다</button>
<button class="btn" data-p="b">침착하게</button>
<button class="btn" data-p="c">멋진 한 수 기대합니다</button>
<button class="btn" data-p="d">집중하세요</button>
</div>
</div>
</div>


<script>
const qs = new URLSearchParams(location.search);
const $ = (s)=>document.querySelector(s);
let socket=null; let roster=[]; let battleId=null; let spectatorToken=null;


function renderTeams(){
const left = roster.filter(p=>p.team==='team1');
const right = roster.filter(p=>p.team==='team2');
$('#teams').innerHTML = `
<div class="teamBox">
<div class="tag">불사조 기사단</div>
${left.map(p=>`<div style="margin-top:8px">• <b>${p.name}</b></div>`).join('')||'<div class="muted" style="margin-top:8px">빈 팀</div>'}
</div>
<div class="teamBox">
<div class="tag">죽음을 먹는 자들</div>
${right.map(p=>`<div style="margin-top:8px">• <b>${p.name}</b></div>`).join('')||'<div class="muted" style="margin-top:8px">빈 팀</div>'}
</div>`;
}


function addMsg(t){ const d=document.createElement('div'); d.textContent=t; $('#chat').appendChild(d); $('#chat').scrollTop=99999; }


function connect(){
socket = io();
socket.on('connect', ()=>{ socket.emit('spectatorAuth',{ battleId, token: spectatorToken, name: $('#spectatorName').value.trim() }); });
socket.on('authError', e=> alert('인증 실패: '+(e?.code||'')) );
socket.on('authSuccess', p=>{ roster=p.roster||[]; renderTeams(); $('#loginCard').style.display='none'; $('#watchCard').style.display='block'; });
socket.on('battleUpdate', ({ roster:r })=>{ roster=r||[]; renderTeams(); });
socket.on('chatMessage', (m)=> addMsg(`[플레이어] ${m.from}: ${m.text}`));
socket.on('cheerMessage', (m)=> addMsg(`[관전자] ${m.from}: ${m.text}`));
}


$('#joinBtn').onclick = ()=>{
battleId = $('#battleId').value.trim();
spectatorToken = $('#spectatorToken').value.trim();
if(!battleId||!spectatorToken) return alert('Battle ID / Spectator Token');
connect();
};


document.addEventListener('click',(e)=>{
const b=e.target.closest('button[data-p]'); if(!b||!socket) return;
socket.emit('cheerMessage',{ preset: b.dataset.p });
});


if(qs.get('battle')) $('#battleId').value = qs.get('battle');
if(qs.get('token')) $('#spectatorToken').value = qs.get('token');
if(qs.get('name')) $('#spectatorName').value = qs.get('name');
if($('#battleId').value && $('#spectatorToken').value){ battleId=$('#battleId').value; spectatorToken=$('#spectatorToken').value; connect(); }
</script>
</body>
</html>
