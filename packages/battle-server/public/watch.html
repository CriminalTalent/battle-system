<!-- packages/battle-server/public/watch.html -->
<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>PYXIS 관전자</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&display=swap" rel="stylesheet">
<script src="/socket.io/socket.io.js"></script>
<style>
  :root{
    --gold:#c9a96e;
    --ink:#e9e3d0; --ink-dim:#bfb7a5;
    --bg:#0a0f1a; --panel:#0c1326; --panel2:#0b1020;
    --line:#20283c; --line2:#1a2234;
    --blur: blur(10px) saturate(120%);
    --lift: 0 10px 22px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 600px at 20% -10%, rgba(201,169,110,.12), transparent 60%), #0a0f1a; color:var(--ink); font-family:system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif}

  header{position:relative;padding:18px 16px 10px 16px}
  header::before{
    content:""; position:absolute; inset:-40% -10% auto -10%; height:240px;
    background:conic-gradient(from 0deg, rgba(201,169,110,.18), rgba(201,169,110,.03), rgba(201,169,110,.18));
    filter:blur(40px); animation:spin 28s linear infinite; opacity:.65; pointer-events:none;
  }
  @keyframes spin{to{transform:rotate(360deg)}}
  .wrap{max-width:1280px;margin:0 auto}
  .brand{font-family:"Playfair Display", serif; font-weight:800; letter-spacing:.06em; font-size:28px; color:var(--gold); position:relative; display:inline-block}
  .twinkles{position:absolute; inset:0; pointer-events:none}
  .twinkles span{position:absolute; width:3px; height:3px; background:var(--gold); border-radius:999px; opacity:.7; animation:twinkle 2.2s ease-in-out infinite}
  .twinkles span:nth-child(1){left:10%; top:36%; animation-delay:.2s}
  .twinkles span:nth-child(2){left:32%; top:16%; animation-delay:.7s}
  .twinkles span:nth-child(3){left:60%; top:30%; animation-delay:1.2s}
  .twinkles span:nth-child(4){left:80%; top:18%; animation-delay:1.7s}
  @keyframes twinkle{0%,100%{opacity:.15; transform:scale(.7)}50%{opacity:1; transform:scale(1)}}

  .layout{display:grid;grid-template-columns:260px 1fr 260px;gap:14px;padding:10px 16px}
  @media (max-width:1100px){.layout{grid-template-columns:1fr}}
  .card{position:relative;background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--line); border-radius:16px; padding:14px; backdrop-filter:var(--blur); box-shadow:var(--lift)}
  .title{margin:0 0 8px 0; color:var(--gold); font-weight:700}

  .teams .unit{display:flex;gap:8px;align-items:center;border:1px solid var(--line2);border-radius:12px;padding:8px;background:#0c152b;margin-bottom:8px}
  .unit .av{width:44px;height:44px;border-radius:10px;background:#1a2238;overflow:hidden;border:1px solid var(--line2)}
  .unit .av img{width:100%;height:100%;object-fit:cover}
  .bar{height:8px;background:#1b2336;border-radius:8px;overflow:hidden}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,#4da3ff,#67e8f9)}
  .chat{height:520px;overflow:auto;background:#0a1326;border:1px solid var(--line);border-radius:12px;padding:10px}
  .row{display:flex;gap:8px;align-items:baseline;margin-bottom:6px}
  .ts{font-size:11px;color:#8aa0c2;min-width:54px}

  .status{display:flex;gap:10px;align-items:center;color:#a9b6d2}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0d172b}
  .pill.small{padding:4px 8px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">PYXIS
      <span class="twinkles"><span></span><span></span><span></span><span></span></span>
    </div>
    <div class="status" style="margin-top:6px">
      <span id="statusPill" class="pill small">대기중</span>
      <button class="pill small" data-cheer="힘내!">힘내!</button>
      <button class="pill small" data-cheer="지지마!">지지마!</button>
      <button class="pill small" data-cheer="이길 수 있어!">이길 수 있어!</button>
      <button class="pill small" data-cheer="포기하지 마!">포기하지 마!</button>
    </div>
  </div>
</header>

<div class="wrap layout">
  <div class="card">
    <h3 class="title">불사조 기사단</h3>
    <div id="team1" class="teams"></div>
  </div>
  <div class="card">
    <h3 class="title">실시간</h3>
    <div id="chat" class="chat"></div>
    <div style="margin-top:6px;color:#b8b3a2">관전자는 채팅을 보낼 수 없으며, 상단 버튼으로만 응원할 수 있습니다.</div>
  </div>
  <div class="card">
    <h3 class="title">죽음을 먹는 자들</h3>
    <div id="team2" class="teams"></div>
  </div>
</div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const battle = qs.get('battle');
  const token = qs.get('token');
  const name = qs.get('name') || '관전자';

  const socket = io({ path: '/socket.io/' });
  let state = null;

  const team1 = document.getElementById('team1');
  const team2 = document.getElementById('team2');
  const chatEl = document.getElementById('chat');
  const statusPill = document.getElementById('statusPill');

  function setStatusPill(status){
    statusPill.textContent = status==='waiting'?'대기중':status==='ongoing'?'진행중':status==='paused'?'일시정지':'종료';
  }
  function fmtTs(ts){ try{ return new Date(ts).toLocaleTimeString([], {hour12:false}); }catch{return '--:--:--';} }
  function appendChat(msg){
    if (!msg) return;
    const row = document.createElement('div'); row.className = 'row';
    const t = document.createElement('span'); t.className = 'ts'; t.textContent = fmtTs(msg.ts || Date.now());
    const m = document.createElement('span');
    if (msg.type === 'system') m.textContent = '[시스템] ' + msg.text;
    else if (msg.type === 'cheer') m.textContent = '[응원] ' + (msg.from||'관전자') + ': ' + msg.text;
    else if (msg.type === 'chat') m.textContent = '[' + (msg.channel === 'team' ? '팀':'전체') + '] ' + (msg.from||'익명') + ': ' + msg.text;
    row.appendChild(t); row.appendChild(m); chatEl.appendChild(row); chatEl.scrollTop = chatEl.scrollHeight;
  }

  function renderTeams(){
    if (!state) return;
    const mk = (p)=>{
      const box = document.createElement('div'); box.className = 'unit';
      const av = document.createElement('div'); av.className = 'av';
      if (p.avatar) { const img = document.createElement('img'); img.src = p.avatar; av.appendChild(img); }
      const info = document.createElement('div'); info.style.flex='1';
      const title = document.createElement('div'); title.textContent = `${p.name}${p.alive?'':' (불능)'}`;
      const bar = document.createElement('div'); bar.className='bar';
      const span = document.createElement('span'); span.style.width = `${Math.round((p.hp/p.maxHp)*100)}%`; bar.appendChild(span);
      const meta = document.createElement('div'); meta.style.color='#b8b3a2'; meta.textContent = `ATK ${p.stats.attack} / DEF ${p.stats.defense} / AGI ${p.stats.agility} / LUCK ${p.stats.luck}`;
      info.appendChild(title); info.appendChild(bar); info.appendChild(meta);
      box.appendChild(av); box.appendChild(info);
      return box;
    };
    team1.innerHTML = ''; team2.innerHTML = '';
    Object.values(state.players).filter(p=>p.team==='team1').forEach(p=>team1.appendChild(mk(p)));
    Object.values(state.players).filter(p=>p.team==='team2').forEach(p=>team2.appendChild(mk(p)));
  }

  document.querySelectorAll('button[data-cheer]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const text = btn.getAttribute('data-cheer');
      socket.emit('cheer', { text });
    });
  });

  socket.on('connect', ()=>{
    socket.emit('auth', { battle, token, role:'spectator', name }, (ack)=>{
      if (!ack || !ack.ok) { alert('인증 실패'); return; }
      state = ack.state; setStatusPill(state.status); renderTeams();
    });
  });
  socket.on('state', s => { state = s; setStatusPill(state.status); renderTeams(); });
  socket.on('chat', appendChat);
})();
</script>
</body>
</html>
