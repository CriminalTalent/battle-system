<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PYXIS 관리자</title>
<link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700;800;900&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link href="/assets/pyxis-theme.css" rel="stylesheet">
<script src="/socket.io/socket.io.js"></script>
<style>
/* 관리자 전용 스타일 */
.admin-header{
  position:relative; 
  padding:40px 20px 16px; 
  overflow:hidden;
}

.admin-header::before{
  content:''; 
  position:absolute; 
  inset:-50% -20% auto -20%; 
  height:400px;
  background:conic-gradient(from 0deg at 50% 50%, 
    rgba(212,183,126,.20) 0deg, 
    rgba(212,183,126,.08) 60deg,
    rgba(212,183,126,.25) 120deg, 
    rgba(212,183,126,.06) 180deg, 
    rgba(212,183,126,.20) 240deg, 
    rgba(212,183,126,.08) 300deg, 
    rgba(212,183,126,.20) 360deg
  );
  filter:blur(70px);
  animation:adminOrbit 55s linear infinite;
  opacity:.8;
  pointer-events:none;
  z-index:-1;
}

@keyframes adminOrbit{
  0%{transform:rotate(0deg) scale(1)}
  25%{transform:rotate(90deg) scale(1.1)}
  50%{transform:rotate(180deg) scale(.9)}
  75%{transform:rotate(270deg) scale(1.15)}
  100%{transform:rotate(360deg) scale(1)}
}

.admin-brand{
  font-family:var(--serif); 
  font-weight:900; 
  letter-spacing:.09em; 
  font-size:40px;
  background:linear-gradient(135deg, 
    var(--gold-bright) 0%, 
    var(--gold-shimmer) 20%, 
    var(--gold) 40%, 
    var(--gold-light) 60%,
    var(--gold-shimmer) 80%,
    var(--gold-bright) 100%
  );
  background-size:400% 400%;
  -webkit-background-clip:text; 
  background-clip:text; 
  -webkit-text-fill-color:transparent;
  animation:adminShimmer 4.5s ease-in-out infinite;
  position:relative;
  display:inline-block;
  text-shadow:0 4px 20px rgba(212,183,126,.4);
}

@keyframes adminShimmer{
  0%,100%{
    background-position:0% 50%;
    filter:brightness(1);
    transform:scale(1);
  }
  50%{
    background-position:100% 50%;
    filter:brightness(1.25);
    transform:scale(1.03);
  }
}

.admin-brand::after{
  content:'관리자';
  position:absolute;
  top:-10px;
  right:-65px;
  font-size:13px;
  font-weight:700;
  color:var(--gold);
  background:linear-gradient(135deg, rgba(212,183,126,.25), rgba(212,183,126,.15));
  border:1px solid var(--gold);
  border-radius:999px;
  padding:5px 14px;
  letter-spacing:.03em;
  box-shadow:0 4px 12px rgba(212,183,126,.2);
}

.admin-stage{
  display:grid; 
  grid-template-columns:1.2fr 1fr 1fr; 
  gap:24px; 
  padding:20px 24px;
  max-width:1600px;
  margin:0 auto;
}

@media (max-width:1400px){
  .admin-stage{
    grid-template-columns:1fr;
    gap:20px;
  }
}

/* 컨트롤 그리드 시스템 */
.control-grid{
  display:grid; 
  gap:16px;
}

.control-row{
  display:grid;
  grid-template-columns:2fr 1fr;
  gap:14px;
  align-items:end;
}

.control-actions{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:10px;
  margin-top:16px;
}

.control-actions .btn{
  font-size:13px;
  padding:11px 18px;
  font-weight:700;
}

@media (max-width:600px){
  .control-row{
    grid-template-columns:1fr;
  }
  .control-actions{
    grid-template-columns:1fr;
  }
}

/* 링크 섹션 개선 */
.links-section{
  margin-top:24px;
  padding-top:20px;
  border-top:2px solid rgba(212,183,126,.15);
  position:relative;
}

.links-section::before{
  content:'';
  position:absolute;
  top:-1px; left:30%; right:30%; height:1px;
  background:linear-gradient(90deg, transparent, var(--gold), transparent);
}

.link-item{
  display:flex;
  gap:10px;
  align-items:center;
  margin-bottom:12px;
  padding:12px;
  background:var(--glass-1);
  border:1px solid var(--border-subtle);
  border-radius:var(--radius-small);
  backdrop-filter:var(--blur-light);
  transition:all var(--transition-normal);
}

.link-item:hover{
  background:var(--glass-2);
  border-color:var(--border-1);
  transform:translateY(-1px);
}

.link-input{
  flex:1;
  font-size:12px;
  padding:10px 14px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  background:rgba(5,15,28,.8);
  border:1px solid var(--border-subtle);
  font-family:var(--sans);
  font-weight:500;
}

.copy-btn{
  padding:10px 16px;
  font-size:12px;
  white-space:nowrap;
  font-weight:700;
  min-width:80px;
}

/* 로스터 폼 시스템 */
.roster-form{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
  margin-bottom:20px;
  padding:20px;
  background:var(--glass-1);
  border:1px solid var(--border-subtle);
  border-radius:var(--radius);
  backdrop-filter:var(--blur-light);
}

.roster-form .field{
  min-width:0;
}

@media (max-width:800px){
  .roster-form{
    grid-template-columns:repeat(2,1fr);
  }
}

@media (max-width:500px){
  .roster-form{
    grid-template-columns:1fr;
  }
}

.stats-grid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:10px;
  margin:10px 0;
  padding:16px;
  background:var(--glass-subtle);
  border:1px solid var(--border-subtle);
  border-radius:var(--radius-small);
}

.items-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  margin:10px 0;
  padding:16px;
  background:var(--glass-subtle);
  border:1px solid var(--border-subtle);
  border-radius:var(--radius-small);
}

@media (max-width:600px){
  .stats-grid{
    grid-template-columns:repeat(2,1fr);
  }
  .items-grid{
    grid-template-columns:1fr;
  }
}

/* 팀 로스터 개선 */
.teams-roster{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
  margin-top:20px;
}

@media (max-width:700px){
  .teams-roster{
    grid-template-columns:1fr;
  }
}

.team-section{
  background:linear-gradient(
    145deg, 
    rgba(5,15,28,.6) 0%, 
    rgba(8,20,35,.5) 50%, 
    rgba(5,15,28,.6) 100%
  );
  border:1px solid var(--border-1);
  border-radius:var(--radius);
  padding:16px;
  backdrop-filter:var(--blur-light);
  box-shadow:var(--shadow-soft);
}

/* 플레이어 카드 개선 */
.player-card{
  display:grid;
  grid-template-columns:70px 1fr auto;
  gap:14px;
  align-items:center;
  padding:14px;
  margin-bottom:12px;
  background:linear-gradient(
    145deg, 
    rgba(15,20,25,.8) 0%, 
    rgba(25,31,42,.7) 50%, 
    rgba(15,20,25,.8) 100%
  );
  border:1px solid var(--border-1);
  border-radius:var(--radius);
  transition:all var(--transition-normal);
  box-shadow:var(--shadow-subtle);
}

.player-card:hover{
  transform:translateY(-2px);
  border-color:var(--border-2);
  box-shadow:var(--shadow-soft), var(--shadow-glow);
}

.player-avatar{
  width:70px;
  height:70px;
  border-radius:var(--radius-small);
  background:linear-gradient(135deg, var(--midnight), var(--navy-mist)) center/cover no-repeat;
  border:2px solid var(--border-1);
  position:relative;
  overflow:hidden;
  box-shadow:var(--shadow-subtle);
}

.player-avatar::after{
  content:'';
  position:absolute;
  inset:0;
  background:linear-gradient(
    135deg, 
    transparent 30%, 
    rgba(212,183,126,.08) 80%
  );
  opacity:.7;
}

.player-info{
  flex:1;
  min-width:0;
}

.player-name{
  font-weight:800;
  color:var(--text);
  margin-bottom:6px;
  font-size:15px;
}

.player-stats{
  font-size:11px;
  color:var(--text-muted);
  margin-bottom:8px;
  line-height:1.4;
}

.player-hp{
  height:8px;
  background:rgba(5,15,28,.9);
  border-radius:4px;
  overflow:hidden;
  position:relative;
  box-shadow:inset 0 2px 4px rgba(0,0,0,.3);
}

.player-hp::after{
  content:'';
  position:absolute;
  inset:0;
  background:linear-gradient(90deg, rgba(255,255,255,.15), transparent 40%);
  pointer-events:none;
}

.player-hp-fill{
  height:100%;
  background:linear-gradient(90deg, var(--gold-dark), var(--gold-bright));
  transition:width .6s var(--ease-smooth);
  position:relative;
  box-shadow:0 0 8px rgba(212,183,126,.4);
}

.player-items{
  font-size:10px;
  color:var(--text-muted);
  margin-top:6px;
  opacity:.8;
}

.player-actions{
  display:flex;
  gap:8px;
  align-items:center;
}

.player-actions .btn{
  font-size:11px;
  padding:8px 12px;
  min-width:auto;
  font-weight:700;
}

/* 로그 및 채팅 개선 */
.log-chat-container{
  display:flex;
  flex-direction:column;
  height:100%;
  min-height:600px;
}

.log-viewer{
  flex:1;
  background:linear-gradient(
    145deg, 
    rgba(3,12,25,.98) 0%, 
    rgba(6,18,32,.95) 50%, 
    rgba(3,12,25,.98) 100%
  );
  border:1px solid var(--border-1); 
  border-radius:var(--radius); 
  padding:20px; 
  overflow-y:auto; 
  font-size:13px;
  line-height:1.5;
  min-height:520px;
  backdrop-filter:var(--blur-medium);
  box-shadow:
    inset 0 4px 16px rgba(0,0,0,.5), 
    inset 0 1px 0 rgba(255,255,255,.02),
    var(--shadow-soft);
}

.log-entry{
  display:flex;
  gap:12px;
  align-items:baseline;
  margin-bottom:10px;
  padding:8px 12px;
  border-bottom:1px solid rgba(212,183,126,.05);
  border-radius:var(--radius-small);
  transition:background var(--transition-fast);
}

.log-entry:hover{
  background:var(--glass-1);
}

.log-time{
  font-size:11px;
  color:var(--text-muted);
  min-width:65px;
  font-weight:600;
  font-family:var(--sans);
}

.log-content{
  flex:1;
  color:var(--text-dim);
  line-height:1.4;
}

.log-entry.system .log-content{
  color:var(--gold-bright);
  font-weight:600;
}

.log-entry.admin .log-content{
  color:var(--gold-shimmer);
  font-weight:700;
}

.log-entry.action .log-content{
  color:var(--text);
  font-weight:600;
}

.chat-input-container{
  display:flex;
  gap:12px;
  align-items:center;
  margin-top:16px;
  padding:16px;
  background:linear-gradient(
    145deg, 
    rgba(15,20,25,.7) 0%, 
    rgba(25,31,42,.6) 50%, 
    rgba(15,20,25,.7) 100%
  );
  border:1px solid var(--border-1);
  border-radius:var(--radius);
  backdrop-filter:var(--blur-light);
  box-shadow:var(--shadow-subtle);
}

.chat-channel-select{
  min-width:100px;
  font-weight:600;
}

.chat-input{
  flex:1;
  font-weight:500;
}

.chat-input::placeholder{
  color:var(--text-muted);
  font-style:italic;
}

/* 특수 효과 */
.sparkle-effect{
  position:relative;
  overflow:hidden;
}

.sparkle-effect::before{
  content:'✦';
  position:absolute;
  top:10px;
  right:15px;
  color:var(--gold);
  font-size:12px;
  opacity:.6;
  animation:sparkle 3s ease-in-out infinite;
}

@keyframes sparkle{
  0%, 100%{ 
    opacity:.3; 
    transform:scale(.8) rotate(0deg); 
  }
  50%{ 
    opacity:1; 
    transform:scale(1.2) rotate(180deg); 
  }
}

/* 향상된 호버 효과 */
.enhance-hover{
  position:relative;
  overflow:hidden;
}

.enhance-hover::after{
  content:'';
  position:absolute;
  top:0; left:-100%; right:100%; bottom:0;
  background:linear-gradient(
    90deg,
    transparent,
    rgba(212,183,126,.1),
    transparent
  );
  transition:all .6s ease;
}

.enhance-hover:hover::after{
  left:100%; right:-100%;
}

/* 성공/에러 피드백 */
.feedback-success{
  background:linear-gradient(135deg, var(--success), #219a52) !important;
  color:white !important;
  border-color:var(--success) !important;
  animation:feedbackPulse .8s var(--ease-bounce);
}

.feedback-error{
  background:linear-gradient(135deg, var(--danger), #c0392b) !important;
  color:white !important;
  border-color:var(--danger) !important;
  animation:feedbackShake .6s ease-in-out;
}

@keyframes feedbackPulse{
  0%{ transform:scale(1); }
  50%{ transform:scale(1.05); }
  100%{ transform:scale(1); }
}

@keyframes feedbackShake{
  0%, 100%{ transform:translateX(0); }
  25%{ transform:translateX(-5px); }
  75%{ transform:translateX(5px); }
}

/* 모바일 최적화 */
@media (max-width:768px){
  .admin-header{
    padding:32px 16px 12px;
  }
  
  .admin-stage{
    padding:16px 20px;
    gap:16px;
  }
  
  .admin-brand{
    font-size:32px;
  }
  
  .admin-brand::after{
    top:-8px;
    right:-50px;
    font-size:11px;
    padding:4px 10px;
  }
  
  .player-card{
    grid-template-columns:60px 1fr;
    gap:12px;
  }
  
  .player-avatar{
    width:60px;
    height:60px;
  }
  
  .player-actions{
    grid-column:1 / -1;
    justify-content:flex-end;
    margin-top:8px;
  }
  
  .chat-input-container{
    flex-direction:column;
    gap:10px;
  }
  
  .chat-channel-select{
    width:100%;
    min-width:auto;
  }
}
</style>
</head>
<body>
<header class="admin-header twinkle-bg">
  <div class="wrap">
    <div class="admin-brand sparkle-effect">Pyxis</div>
  </div>
</header>

<main class="admin-stage">
  <!-- 전투 생성 및 제어 섹션 -->
  <section class="card glow-effect">
    <div class="section-header">
      <div class="section-title">전투 생성 및 제어</div>
      <div class="status-indicator">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">대기중</span>
      </div>
    </div>

    <div class="control-grid">
      <!-- 전투 생성 -->
      <div class="control-row">
        <div class="field">
          <label for="battleMode">전투 모드</label>
          <select id="battleMode" class="select enhance-hover">
            <option value="1v1">1 vs 1 - 개인전</option>
            <option value="2v2">2 vs 2 - 소규모팀</option>
            <option value="3v3">3 vs 3 - 팀전투</option>
            <option value="4v4">4 vs 4 - 대규모전</option>
          </select>
        </div>
        <button id="btnCreateBattle" class="btn btn-gold enhance-hover">전투 생성</button>
      </div>

      <!-- 전투 정보 -->
      <div class="field">
        <label for="battleId">전투 ID</label>
        <input id="battleId" class="input" readonly placeholder="생성된 전투 ID가 표시됩니다" style="font-family:var(--sans); font-weight:600; letter-spacing:.02em;">
      </div>

      <div class="row">
        <div class="field">
          <label for="adminOtp">관리자 OTP</label>
          <input id="adminOtp" class="input" readonly placeholder="관리자 인증 토큰" style="font-family:var(--sans); font-weight:600;">
        </div>
        <div class="field">
          <label for="spectatorOtp">관전자 OTP</label>
          <input id="spectatorOtp" class="input" readonly placeholder="관전자 인증 토큰" style="font-family:var(--sans); font-weight:600;">
        </div>
      </div>

      <!-- 제어 버튼 -->
      <div class="control-actions">
        <button id="btnConnect" class="btn enhance-hover">관리자 로그인</button>
        <button id="btnStartBattle" class="btn btn-gold enhance-hover">전투 시작</button>
        <button id="btnPauseBattle" class="btn enhance-hover">일시정지</button>
        <button id="btnEndBattle" class="btn btn-danger enhance-hover">전투 종료</button>
      </div>
    </div>

    <!-- 링크 생성 섹션 -->
    <div class="links-section sparkle-effect">
      <div class="section-title" style="font-size:18px; margin-bottom:16px;">링크 생성</div>
      
      <div class="field">
        <label for="spectatorUrl">관전자 링크</label>
        <div class="link-item enhance-hover">
          <input id="spectatorUrl" class="input link-input" readonly placeholder="관전자 링크가 생성됩니다">
          <button id="copySpectatorUrl" class="btn copy-btn enhance-hover">복사/발급</button>
        </div>
      </div>

      <button id="btnGenerateLinks" class="btn enhance-hover">플레이어별 링크 생성</button>
      <div id="playerLinksContainer" class="hide" style="margin-top:16px;"></div>
    </div>
  </section>

  <!-- 로그 및 채팅 섹션 -->
  <section class="card glow-effect">
    <div class="section-header">
      <div class="section-title">실시간 로그 · 채팅</div>
    </div>

    <div class="log-chat-container">
      <div id="logViewer" class="log-viewer" aria-label="전투 로그"></div>
      
      <div class="chat-input-container">
        <select id="chatChannel" class="select chat-channel-select">
          <option value="all">전체 채팅</option>
          <option value="team">팀 채팅</option>
        </select>
        <input id="chatInput" class="input chat-input" placeholder="메시지 입력 (/t 팀 채팅)" maxlength="200">
        <button id="btnSendChat" class="btn enhance-hover">전송</button>
      </div>
    </div>
  </section>

  <!-- 참여자 구성 섹션 -->
  <section class="card glow-effect">
    <div class="section-header">
      <div class="section-title">참여자 구성</div>
    </div>

    <!-- 플레이어 추가 폼 -->
    <div class="roster-form sparkle-effect">
      <div class="field">
        <label for="playerName">플레이어 이름</label>
        <input id="playerName" class="input" placeholder="이름 입력" maxlength="20">
      </div>
      
      <div class="field">
        <label for="playerTeam">소속 팀</label>
        <select id="playerTeam" class="select">
          <option value="A">불사조 기사단</option>
          <option value="B">죽음을 먹는 자들</option>
        </select>
      </div>
    </div>

    <!-- 스탯 설정 -->
    <div class="field" style="margin-bottom:16px;">
      <label>능력치 배분 (1-5점)</label>
      <div class="stats-grid">
        <div class="field">
          <label for="statAttack">공격력</label>
          <input id="statAttack" class="input" type="number" value="3" min="1" max="5">
        </div>
        <div class="field">
          <label for="statDefense">방어력</label>
          <input id="statDefense" class="input" type="number" value="3" min="1" max="5">
        </div>
        <div class="field">
          <label for="statAgility">민첩성</label>
          <input id="statAgility" class="input" type="number" value="3" min="1" max="5">
        </div>
        <div class="field">
          <label for="statLuck">행운</label>
          <input id="statLuck" class="input" type="number" value="3" min="1" max="5">
        </div>
      </div>
    </div>

    <!-- 아이템 설정 -->
    <div class="field" style="margin-bottom:20px;">
      <label>시작 아이템 (0-9개)</label>
      <div class="items-grid">
        <div class="field">
          <label for="itemHealing">디터니 (회복)</label>
          <input id="itemHealing" class="input" type="number" value="0" min="0" max="9">
        </div>
        <div class="field">
          <label for="itemAttackBoost">공격 보정기</label>
          <input id="itemAttackBoost" class="input" type="number" value="0" min="0" max="9">
        </div>
        <div class="field">
          <label for="itemDefenseBoost">방어 보정기</label>
          <input id="itemDefenseBoost" class="input" type="number" value="0" min="0" max="9">
        </div>
      </div>
    </div>

    <button id="btnAddPlayer" class="btn btn-gold enhance-hover">플레이어 추가</button>

    <!-- 현재 로스터 -->
    <div class="section-title" style="font-size:18px; margin:24px 0 16px; border-top:2px solid rgba(212,183,126,.15); padding-top:20px; position:relative;">
      현재 로스터
      <div style="position:absolute; top:-1px; left:25%; right:25%; height:1px; background:linear-gradient(90deg, transparent, var(--gold), transparent);"></div>
    </div>
    
    <div class="teams-roster">
      <div class="team-section sparkle-effect">
        <div class="team-header">불사조 기사단</div>
        <div id="team1Roster"></div>
      </div>
      
      <div class="team-section sparkle-effect">
        <div class="team-header death-eater">죽음을 먹는 자들</div>
        <div id="team2Roster"></div>
      </div>
    </div>
  </section>
</main>

<script>
(function(){
  'use strict';
  
  // DOM 요소 참조
  const $ = id => document.getElementById(id);
  
  // 전투 생성 & 제어
  const battleMode = $('battleMode');
  const btnCreateBattle = $('btnCreateBattle');
  const battleId = $('battleId');
  const adminOtp = $('adminOtp');
  const spectatorOtp = $('spectatorOtp');
  const spectatorUrl = $('spectatorUrl');
  const statusDot = $('statusDot');
  const statusText = $('statusText');
  
  // 제어 버튼
  const btnConnect = $('btnConnect');
  const btnStartBattle = $('btnStartBattle');
  const btnPauseBattle = $('btnPauseBattle');
  const btnEndBattle = $('btnEndBattle');
  
  // 링크 생성
  const btnGenerateLinks = $('btnGenerateLinks');
  const copySpectatorUrl = $('copySpectatorUrl');
  const playerLinksContainer = $('playerLinksContainer');
  
  // 채팅
  const logViewer = $('logViewer');
  const chatChannel = $('chatChannel');
  const chatInput = $('chatInput');
  const btnSendChat = $('btnSendChat');
  
  // 플레이어 추가
  const playerName = $('playerName');
  const playerTeam = $('playerTeam');
  const statAttack = $('statAttack');
  const statDefense = $('statDefense');
  const statAgility = $('statAgility');
  const statLuck = $('statLuck');
  const itemHealing = $('itemHealing');
  const itemAttackBoost = $('itemAttackBoost');
  const itemDefenseBoost = $('itemDefenseBoost');
  const btnAddPlayer = $('btnAddPlayer');
  const team1Roster = $('team1Roster');
  const team2Roster = $('team2Roster');

  // 소켓 및 상태
  const socket = io({ transports:['websocket','polling'], reconnection:true, reconnectionAttempts:Infinity });
  let currentBattleId = '';
  let battleState = null;
  let isConnected = false;

  // 유틸리티 함수
  const formatTime = timestamp => {
    try { return new Date(timestamp).toLocaleTimeString([], { hour12: false }); }
    catch { return '--:--:--'; }
  };

  const makeApiCall = async (endpoint, options = {}) => {
    try {
      const response = await fetch(endpoint, {
        headers: { 'Content-Type': 'application/json' },
        ...options
      });
      return await response.json();
    } catch (error) {
      console.error('API 호출 실패:', error);
      return { ok: false, msg: 'API 호출 실패' };
    }
  };

  const showNotification = (message, type = 'info') => {
    console.log(`[${type.toUpperCase()}] ${message}`);
    
    // 토스트 형태로 알림 표시
    const toast = document.createElement('div');
    toast.style.cssText = `
      position: fixed; top: 20px; right: 20px; z-index: 10000;
      padding: 12px 20px; border-radius: 8px; color: white; font-weight: 600;
      background: ${type === 'error' ? 'linear-gradient(135deg, #e74c3c, #c0392b)' : 
                   type === 'success' ? 'linear-gradient(135deg, #27ae60, #219a52)' : 
                   'linear-gradient(135deg, #3498db, #2980b9)'};
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transform: translateX(100%); transition: transform 0.3s ease;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.style.transform = 'translateX(0)', 100);
    setTimeout(() => {
      toast.style.transform = 'translateX(100%)';
      setTimeout(() => document.body.removeChild(toast), 300);
    }, 3000);
  };

  const updateStatus = status => {
    const statusMap = {
      lobby:   { text: '대기중', class: 'waiting' },
      active:  { text: '진행중', class: 'active' },
      ended:   { text: '종료됨', class: 'ended' },
      waiting: { text: '대기중', class: 'waiting' },
      ongoing: { text: '진행중', class: 'active' }
    };
    const info = statusMap[status] || statusMap.lobby;
    statusText.textContent = info.text;
    statusDot.className = `status-dot ${info.class}`;
  };

  const addLogEntry = (content, type = 'info') => {
    const entry = document.createElement('div');
    entry.className = `log-entry ${type}`;
    const timeSpan = document.createElement('span');
    timeSpan.className = 'log-time';
    timeSpan.textContent = formatTime(Date.now());
    const contentSpan = document.createElement('span');
    contentSpan.className = 'log-content';
    contentSpan.textContent = content;
    entry.appendChild(timeSpan);
    entry.appendChild(contentSpan);
    logViewer.appendChild(entry);
    logViewer.scrollTop = logViewer.scrollHeight;
  };

  const copyToClipboard = async (text, button) => {
    try {
      await navigator.clipboard.writeText(text);
      button.textContent = '복사완료!';
      button.classList.add('feedback-success');
      setTimeout(() => {
        button.textContent = '복사/발급';
        button.classList.remove('feedback-success');
      }, 2000);
      showNotification('링크가 클립보드에 복사되었습니다!', 'success');
    } catch {
      button.classList.add('feedback-error');
      setTimeout(() => button.classList.remove('feedback-error'), 1000);
      showNotification('클립보드 복사 실패', 'error');
    }
  };

  // 플레이어 카드 렌더링
  const renderPlayerCard = p => {
    const card = document.createElement('div');
    card.className = 'player-card enhance-hover';
    const hpPercent = Math.max(0, Math.min(100, (p.hp / 100) * 100));
    card.innerHTML = `
      <div class="player-avatar" ${p.avatar ? `style="background-image:url(${p.avatar})"` : ''}></div>
      <div class="player-info">
        <div class="player-name">${p.name}${p.hp<=0 ? ' (불능)' : ''}</div>
        <div class="player-stats">공격 ${p.atk} · 방어 ${p.def} · 민첩 ${p.agi} · 행운 ${p.luk}</div>
        <div class="player-hp">
          <div class="player-hp-fill" style="width:${hpPercent}%"></div>
        </div>
        <div class="player-items">아이템: 디터니 ${p.items?.dittany||0}, 공격보정 ${p.items?.atkBoost||0}, 방어보정 ${p.items?.defBoost||0}</div>
      </div>
      <div class="player-actions">
        <button class="btn btn-danger" disabled>제거</button>
      </div>
    `;
    return card;
  };

  const renderRoster = () => {
    team1Roster.innerHTML = '';
    team2Roster.innerHTML = '';
    if (!battleState?.teams) return;
    const teamA = battleState.teams.find(t=>t.side==='A');
    const teamB = battleState.teams.find(t=>t.side==='B');
    (teamA?.players||[]).forEach(p => team1Roster.appendChild(renderPlayerCard(p)));
    (teamB?.players||[]).forEach(p => team2Roster.appendChild(renderPlayerCard(p)));
  };

  const renderBattleState = () => {
    if (!battleState) return;
    updateStatus(battleState.status);
    renderRoster();
  };

  // 전투 생성
  btnCreateBattle.onclick = async () => {
    const mode = battleMode.value;
    btnCreateBattle.classList.add('loading');
    const result = await makeApiCall('/api/admin/battles', {
      method: 'POST',
      body: JSON.stringify({ mode })
    });
    btnCreateBattle.classList.remove('loading');
    
    if (!result?.ok) {
      btnCreateBattle.classList.add('feedback-error');
      setTimeout(() => btnCreateBattle.classList.remove('feedback-error'), 1000);
      return showNotification(result?.msg || '전투 생성 실패', 'error');
    }

    currentBattleId = result.battleId;
    battleId.value = result.battleId;
    adminOtp.value = result.adminOTP;
    spectatorOtp.value = '';
    spectatorUrl.value = '';

    btnCreateBattle.classList.add('feedback-success');
    setTimeout(() => btnCreateBattle.classList.remove('feedback-success'), 1000);
    
    addLogEntry('전투가 성공적으로 생성되었습니다', 'system');
    showNotification('전투가 생성되었습니다!', 'success');
  };

  // 소켓 로그인
  btnConnect.onclick = () => {
    if (!battleId.value || !adminOtp.value) {
      btnConnect.classList.add('feedback-error');
      setTimeout(() => btnConnect.classList.remove('feedback-error'), 1000);
      return showNotification('전투 ID와 관리자 OTP가 필요합니다', 'error');
    }
    
    btnConnect.textContent = '로그인 중...';
    btnConnect.disabled = true;
    btnConnect.classList.add('loading');

    socket.emit('join', {
      role: 'admin',
      battleId: battleId.value,
      token: adminOtp.value
    }, (ack) => {
      btnConnect.classList.remove('loading');
      
      if (ack?.ok) {
        isConnected = true;
        battleState = ack.state;
        renderBattleState();
        addLogEntry('관리자 로그인 성공', 'system');
        showNotification('관리자 권한으로 로그인되었습니다', 'success');
        
        btnConnect.textContent = '로그인 완료';
        btnConnect.classList.add('feedback-success');
        btnConnect.disabled = false;
      } else {
        btnConnect.textContent = '관리자 로그인';
        btnConnect.disabled = false;
        btnConnect.classList.add('feedback-error');
        setTimeout(() => btnConnect.classList.remove('feedback-error'), 1000);
        showNotification(ack?.msg || '관리자 로그인 실패', 'error');
      }
    });
  };

  // 전투 제어
  btnStartBattle.onclick = async () => {
    if (!battleId.value || !adminOtp.value) {
      btnStartBattle.classList.add('feedback-error');
      setTimeout(() => btnStartBattle.classList.remove('feedback-error'), 1000);
      return showNotification('전투를 먼저 생성하고 로그인하세요', 'error');
    }
    
    btnStartBattle.classList.add('loading');
    const result = await makeApiCall(`/api/admin/battles/${battleId.value}/start`, {
      method: 'POST',
      body: JSON.stringify({ adminOtp: adminOtp.value })
    });
    btnStartBattle.classList.remove('loading');
    
    if (!result?.ok) {
      btnStartBattle.classList.add('feedback-error');
      setTimeout(() => btnStartBattle.classList.remove('feedback-error'), 1000);
      return showNotification(result?.msg || '전투 시작 실패', 'error');
    }
    
    btnStartBattle.classList.add('feedback-success');
    setTimeout(() => btnStartBattle.classList.remove('feedback-success'), 1000);
    addLogEntry('전투가 시작되었습니다', 'system');
    showNotification('전투가 시작되었습니다!', 'success');
  };
  
  btnPauseBattle.onclick = () => {
    showNotification('일시정지는 현재 서버에서 미지원입니다', 'info');
  };
  
  btnEndBattle.onclick = () => {
    showNotification('전투 종료는 시간만료/전멸 시 자동 처리됩니다', 'info');
  };

  // 관전자 링크
  copySpectatorUrl.onclick = async () => {
    if (!spectatorUrl.value) {
      if (!battleId.value || !adminOtp.value) {
        copySpectatorUrl.classList.add('feedback-error');
        setTimeout(() => copySpectatorUrl.classList.remove('feedback-error'), 1000);
        return showNotification('전투 생성 및 관리자 로그인 후 사용하세요', 'error');
      }
      
      copySpectatorUrl.classList.add('loading');
      const r = await makeApiCall(`/api/admin/battles/${battleId.value}/watcher-otp`, {
        method:'POST',
        body: JSON.stringify({ adminOtp: adminOtp.value })
      });
      copySpectatorUrl.classList.remove('loading');
      
      if (!r?.ok) {
        copySpectatorUrl.classList.add('feedback-error');
        setTimeout(() => copySpectatorUrl.classList.remove('feedback-error'), 1000);
        return showNotification(r?.msg || '관전자 링크 발급 실패', 'error');
      }
      
      spectatorOtp.value = r.otp || '';
      spectatorUrl.value = r.watchURL || '';
      addLogEntry('관전자 링크가 발급되었습니다', 'system');
    }
    
    if (spectatorUrl.value) {
      copyToClipboard(spectatorUrl.value, copySpectatorUrl);
    }
  };

  // 플레이어별 링크 생성
  btnGenerateLinks.onclick = () => {
    showNotification('플레이어별 접속 링크는 "플레이어 추가" 시 각각 반환됩니다', 'info');
  };

  // 플레이어 추가
  btnAddPlayer.onclick = async () => {
    const name = (playerName.value || '').trim();
    if (!name) {
      playerName.focus();
      return showNotification('플레이어 이름을 입력하세요', 'error');
    }
    if (!battleId.value || !adminOtp.value) {
      return showNotification('전투를 먼저 생성하고 관리자 로그인하세요', 'error');
    }

    const items = {
      dittany:   Math.max(0, parseInt(itemHealing.value) || 0),
      atkBoost:  Math.max(0, parseInt(itemAttackBoost.value) || 0),
      defBoost:  Math.max(0, parseInt(itemDefenseBoost.value) || 0),
    };
    
    btnAddPlayer.classList.add('loading');
    const r = await makeApiCall(`/api/admin/battles/${battleId.value}/players`, {
      method:'POST',
      body: JSON.stringify({
        adminOtp: adminOtp.value,
        name,
        team: playerTeam.value,
        atk:  parseInt(statAttack.value)  || 3,
        def:  parseInt(statDefense.value) || 3,
        agi:  parseInt(statAgility.value) || 3,
        luk:  parseInt(statLuck.value)    || 3,
        items
      })
    });
    btnAddPlayer.classList.remove('loading');

    if (!r?.ok) {
      btnAddPlayer.classList.add('feedback-error');
      setTimeout(() => btnAddPlayer.classList.remove('feedback-error'), 1000);
      return showNotification(r?.msg || '플레이어 추가 실패', 'error');
    }

    // 접속 링크 표시
    playerLinksContainer.classList.remove('hide');
    const linkItem = document.createElement('div');
    linkItem.className = 'link-item enhance-hover sparkle-effect';
    linkItem.innerHTML = `
      <input class="input link-input" readonly value="${r.joinURL}" style="font-family:var(--sans); font-size:11px;">
      <button class="btn copy-btn">복사</button>
    `;
    const btn = linkItem.querySelector('button');
    btn.addEventListener('click', ()=> copyToClipboard(r.joinURL, btn));
    playerLinksContainer.appendChild(linkItem);

    btnAddPlayer.classList.add('feedback-success');
    setTimeout(() => btnAddPlayer.classList.remove('feedback-success'), 1000);
    
    addLogEntry(`플레이어 '${name}' 추가됨 (${playerTeam.value === 'A' ? '불사조 기사단' : '죽음을 먹는 자들'})`, 'system');
    showNotification(`${name} 플레이어가 추가되었습니다!`, 'success');

    // 상태 갱신
    if (battleState?.teams) {
      const side = playerTeam.value;
      const team = battleState.teams.find(t=>t.side===side);
      if (team) {
        team.players.push({ 
          id:r.pid, 
          name, 
          hp:100, 
          atk:parseInt(statAttack.value)||3, 
          def:parseInt(statDefense.value)||3, 
          agi:parseInt(statAgility.value)||3, 
          luk:parseInt(statLuck.value)||3,
          items: items
        });
        renderRoster();
      }
    }
    
    // 입력 리셋
    playerName.value = '';
    statAttack.value = '3';
    statDefense.value = '3';
    statAgility.value = '3';
    statLuck.value = '3';
    itemHealing.value = '0';
    itemAttackBoost.value = '0';
    itemDefenseBoost.value = '0';
  };

  // 채팅 전송
  const sendChatMessage = () => {
    const message = chatInput.value.trim();
    if (!message || !battleId.value) return;
    
    socket.emit('chat:send', {
      battleId: battleId.value,
      text: message,
      nickname: '관리자',
      role: 'admin'
    });
    chatInput.value = '';
  };
  
  btnSendChat.onclick = sendChatMessage;
  chatInput.addEventListener('keypress', (e) => { 
    if (e.key === 'Enter') sendChatMessage(); 
  });

  // 소켓 수신 이벤트
  socket.on('chat:new', (m) => {
    const scope = m.scope === 'team' ? '[팀] ' : '';
    const nick = m.from?.nickname || '익명';
    addLogEntry(`${scope}${nick}: ${m.text}`, m.from?.role === 'admin' ? 'admin' : 'info');
  });

  socket.on('log:new', (ev)=>{
    addLogEntry(ev.text || '', 'system');
  });

  socket.on('phase:change', (p)=>{
    addLogEntry(`턴 전환: ${(p.phase==='A'?'불사조 기사단':'죽음을 먹는 자들')} (라운드 ${p.round})`, 'system');
    if (battleState) { 
      battleState.phase = p.phase; 
      battleState.round = p.round; 
    }
  });

  socket.on('battle:end', (r)=>{
    addLogEntry(`전투 종료: ${r.winner==='draw'?'무승부':(r.winner==='A'?'불사조 기사단':'죽음을 먹는 자들')} 승리`, 'system');
    updateStatus('ended');
    showNotification('전투가 종료되었습니다', 'info');
  });

  socket.on('connect', () => {
    showNotification('서버에 연결되었습니다', 'success');
  });

  socket.on('disconnect', () => {
    showNotification('서버 연결이 끊어졌습니다', 'error');
  });

  // 초기화
  (function initializeFromUrl(){
    const urlParams = new URLSearchParams(window.location.search);
    const battleParam = urlParams.get('battle');
    const tokenParam = urlParams.get('token');
    if (battleParam) { 
      currentBattleId = battleParam; 
      battleId.value = battleParam; 
    }
    if (tokenParam) { 
      adminOtp.value = tokenParam; 
    }
    
    // 자동 연결 시도
    if (battleParam && tokenParam) {
      setTimeout(() => {
        btnConnect.click();
      }, 500);
    }
  })();
})();
</script>
</body>
</html>
