<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>PYXIS Battle System - 관리자</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Theme (필요 시 기존 CSS와 병행 가능) -->
  <style>
    :root{
      --deep-navy:#0a0f1a;
      --navy-1:#0f1419;
      --navy-2:#151c25;
      --navy-3:#1b2430;
      --glass-1:rgba(255,255,255,0.03);
      --glass-2:rgba(255,255,255,0.06);
      --glass-3:rgba(255,255,255,0.10);
      --text:#e8e2d3;
      --text-dim:#bfb7a4;
      --text-muted:#9f9682;
      --gold:#d4b77e;
      --gold-bright:#e7c992;
      --border:#273041;
      --border-light:#313c4e;
      --success:#29a36a;
      --success-light:rgba(41,163,106,.12);
      --warning:#d98e1a;
      --warning-light:rgba(217,142,26,.12);
      --danger:#c55353;
      --danger-light:rgba(197,83,83,.12);
      --radius:14px;
      --radius-sm:10px;
      --shadow:0 10px 24px rgba(0,0,0,.35);
      --shadow-soft:0 6px 16px rgba(0,0,0,.25);
      --blur:blur(8px);
      --transition:200ms ease;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--deep-navy);color:var(--text);font-family:'Cinzel',serif}
    .container{max-width:1600px;margin:0 auto;padding:0 20px}
    header.header{position:sticky;top:0;z-index:10;background:var(--glass-2);backdrop-filter:var(--blur);border-bottom:1px solid var(--border);}
    .title{display:flex;justify-content:center;gap:12px;align-items:baseline;padding:18px 0}
    .title-main{font-size:36px;font-weight:800;letter-spacing:2px;background:linear-gradient(135deg,var(--gold),var(--gold-bright));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
    .title-sub{font-size:14px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px}

    .grid{display:grid;grid-template-columns:420px 1fr 420px;gap:24px;padding:24px 0;align-items:start}
    @media (max-width:1200px){.grid{grid-template-columns:1fr}}
    section.card{background:var(--glass-2);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-soft);padding:24px}
    section.card h3{margin:0 0 18px;font-size:20px;color:var(--gold-bright);text-align:center;letter-spacing:1px}

    .battle-info{background:var(--glass-1);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center;margin-bottom:16px}
    .battle-id{font-size:24px;font-weight:800;color:var(--gold-bright)}
    .badge{display:inline-block;margin-top:8px;padding:6px 12px;border-radius:18px;font-size:12px;font-weight:700;letter-spacing:.5px}
    .status-waiting{background:var(--warning-light);color:var(--warning);border:1px solid var(--warning)}
    .status-active{background:var(--success-light);color:var(--success);border:1px solid var(--success)}
    .status-ended{background:var(--danger-light);color:var(--danger);border:1px solid var(--danger)}

    .form-group{margin-bottom:16px}
    .form-group label{display:block;margin-bottom:8px;font-size:12px;color:var(--text-dim);text-transform:uppercase;letter-spacing:.5px}
    input[type="text"],input[type="number"],select{
      width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--border);
      background:var(--navy-2);color:var(--text);transition:border var(--transition),background var(--transition)
    }
    input:focus,select:focus{outline:none;border-color:var(--gold);background:var(--navy-3)}
    select{appearance:none;background-image:linear-gradient(45deg,transparent 50%,var(--gold) 50%),linear-gradient(135deg,var(--gold) 50%,transparent 50%);background-position:calc(100% - 18px) calc(1em + 2px),calc(100% - 13px) calc(1em + 2px);background-size:5px 5px,5px 5px;background-repeat:no-repeat;color:var(--text)}
    .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .items-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .stat-total{margin-top:8px;text-align:center;font-size:12px;color:var(--text-muted)}
    .btn{width:100%;padding:12px 16px;border:none;border-radius:10px;background:linear-gradient(135deg,var(--gold),var(--gold-bright));color:#091019;font-weight:800;cursor:pointer;letter-spacing:.5px;box-shadow:var(--shadow-soft);transition:transform var(--transition),filter var(--transition)}
    .btn:hover{transform:translateY(-2px);filter:saturate(1.05)}
    .btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
    .btn-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn-danger{background:linear-gradient(135deg,#b94a4a,#c55353);color:#fff}
    .btn-info{background:linear-gradient(135deg,#1f6aa5,#2d7fbe);color:#fff}

    .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
    .stat-card{background:var(--glass-1);border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center}
    .stat-card .value{font-size:20px;font-weight:800;color:var(--gold-bright)}
    .stat-card .label{font-size:11px;color:var(--text-muted);text-transform:uppercase}

    .roster .team{background:var(--glass-1);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:14px}
    .team .title{color:var(--gold-bright);font-weight:700;text-align:center;margin-bottom:12px}
    .player-list{display:flex;flex-direction:column;gap:10px}
    .player{display:flex;align-items:center;gap:12px;background:var(--glass-2);border:1px solid var(--border);border-radius:10px;padding:12px}
    .player img{width:46px;height:46px;border-radius:50%;object-fit:cover;border:2px solid var(--gold)}
    .player .meta{flex:1}
    .player .name{font-weight:700}
    .player .sub{font-size:12px;color:var(--text-muted)}
    .pill{padding:4px 8px;border-radius:12px;font-size:11px;font-weight:700}
    .ready{background:var(--success-light);color:var(--success);border:1px solid var(--success)}
    .wait{background:var(--warning-light);color:var(--warning);border:1px solid var(--warning)}
    .off{background:var(--danger-light);color:var(--danger);border:1px solid var(--danger)}
    .empty{padding:18px;text-align:center;color:var(--text-muted);font-style:italic}

    .logchat .title{color:var(--gold-bright);text-align:center;margin-bottom:10px}
    .panel{background:var(--glass-1);border:1px solid var(--border);border-radius:10px;height:320px;overflow:auto;padding:12px;font-size:13px}
    .entry{background:var(--glass-2);border-left:3px solid var(--border-light);padding:10px 12px;border-radius:8px;margin-bottom:8px}
    .entry.system{border-left-color:var(--gold)}
    .entry.battle{border-left-color:#2d7fbe}
    .entry.chat{border-left-color:var(--success)}
    .chat-inputs{display:flex;gap:10px;margin-top:10px}
    .chat-inputs input{flex:1}
    .copy-list .item{background:var(--glass-2);border:1px solid var(--border);border-radius:10px;padding:10px;margin-bottom:10px}
    .copy-list .label{font-size:12px;color:var(--text-dim);margin-bottom:6px}
    .copy-list .url{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;font-size:12px;background:var(--navy-1);border:1px solid var(--border);border-radius:8px;padding:8px;cursor:pointer;word-break:break-all}
    .toast{position:fixed;top:20px;right:20px;background:var(--glass-3);border:1px solid var(--border);padding:12px 16px;border-radius:10px;box-shadow:var(--shadow);transform:translateX(400px);transition:transform var(--transition);z-index:1000}
    .toast.show{transform:translateX(0)}
    .toast.success{border-left:4px solid var(--success)}
    .toast.error{border-left:4px solid var(--danger)}
    .toast.info{border-left:4px solid var(--gold)}
    @media (max-width:768px){
      .grid{gap:16px}
      .panel{height:260px}
      .stats-grid{grid-template-columns:repeat(2,1fr)}
      .items-grid{grid-template-columns:repeat(2,1fr)}
      .btn-row{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="container title">
      <div class="title-main">PYXIS</div>
      <div class="title-sub">관리자 콘솔</div>
    </div>
  </header>

  <main class="container">
    <div class="grid">
      <!-- 좌: 전투 제어 -->
      <section class="card">
        <h3>전투 제어</h3>

        <div class="battle-info">
          <div id="battleId" class="battle-id">대기 중</div>
          <div id="battleStatus" class="badge status-waiting">대기</div>
        </div>

        <div class="form-group">
          <label>전투 모드</label>
          <select id="battleMode">
            <option value="1v1">1대1</option>
            <option value="2v2">2대2</option>
            <option value="3v3">3대3</option>
            <option value="4v4">4대4</option>
          </select>
        </div>

        <button id="btnCreateBattle" class="btn">전투 생성</button>

        <div class="btn-row">
          <button id="btnStartBattle" class="btn" disabled>전투 시작</button>
          <button id="btnEndBattle" class="btn btn-danger" disabled>전투 종료</button>
        </div>

        <button id="btnGenerateLinks" class="btn btn-info" disabled>링크 생성</button>

        <div id="linkSection" style="display:none;margin-top:14px">
          <h3 style="margin-bottom:12px">생성된 링크</h3>
          <div id="playerLinks" class="copy-list"></div>
          <div id="spectatorLink" class="copy-list"></div>
        </div>

        <div class="stats">
          <div class="stat-card">
            <div id="statPlayers" class="value">0</div>
            <div class="label">접속 플레이어</div>
          </div>
          <div class="stat-card">
            <div id="statSpectators" class="value">0</div>
            <div class="label">관전자</div>
          </div>
          <div class="stat-card">
            <div id="statTurn" class="value">0</div>
            <div class="label">현재 턴</div>
          </div>
          <div class="stat-card">
            <div id="statUptime" class="value">0:00</div>
            <div class="label">진행 시간</div>
          </div>
        </div>
      </section>

      <!-- 중: 참가자 관리 -->
      <section class="card">
        <h3>참가자 관리</h3>

        <div class="form-group">
          <label>플레이어 이름</label>
          <input id="playerName" type="text" maxlength="20" placeholder="플레이어 이름 (최대 20글자)">
        </div>

        <div class="form-group">
          <label>팀 선택</label>
          <select id="playerTeam">
            <option value="phoenix">불사조 기사단</option>
            <option value="death">죽음을 먹는 자들</option>
          </select>
        </div>

        <div class="form-group">
          <label>스탯 배분 (각 1–5, 총합 제한 없음)</label>
          <div class="stats-grid">
            <input id="statAttack"  type="number" class="stat" min="1" max="5" value="3" placeholder="공격">
            <input id="statDefense" type="number" class="stat" min="1" max="5" value="3" placeholder="방어">
            <input id="statAgility" type="number" class="stat" min="1" max="5" value="3" placeholder="민첩">
            <input id="statLuck"    type="number" class="stat" min="1" max="5" value="3" placeholder="행운">
          </div>
          <div id="statTotal" class="stat-total">총합: 12 (제한 없음)</div>
        </div>

        <div class="form-group">
          <label>시작 아이템</label>
          <div class="items-grid">
            <input id="itemDittany" type="number" min="0" max="5" value="1" placeholder="디터니" title="체력 10 회복">
            <input id="itemAttack"  type="number" min="0" max="5" value="1" placeholder="공격 보정기" title="공격력 1.5배 (성공률 10%)">
            <input id="itemDefense" type="number" min="0" max="5" value="1" placeholder="방어 보정기" title="방어력 1.5배 (성공률 10%)">
          </div>
        </div>

        <div class="form-group">
          <label>아바타 이미지 (최대 5MB)</label>
          <input id="playerAvatar" type="file" accept="image/*">
        </div>

        <button id="btnAddPlayer" class="btn">전투 참가자 추가</button>

        <div class="roster" style="margin-top:16px">
          <div class="team">
            <div class="title">불사조 기사단</div>
            <div id="phoenixTeam" class="player-list">
              <div class="empty">팀원이 없습니다</div>
            </div>
          </div>

          <div class="team">
            <div class="title">죽음을 먹는 자들</div>
            <div id="deathTeam" class="player-list">
              <div class="empty">팀원이 없습니다</div>
            </div>
          </div>
        </div>
      </section>

      <!-- 우: 로그/채팅 -->
      <section class="card logchat">
        <h3>실시간 모니터링</h3>

        <div>
          <div class="title">전투 로그</div>
          <div id="battleLog" class="panel">
            <div class="entry system">PYXIS 관리자 콘솔이 시작되었습니다.</div>
            <div class="entry system">전투 룰: 스탯 각 1–5, 체력 최대 100, 5분 턴 제한</div>
          </div>
        </div>

        <div style="margin-top:14px">
          <div class="title">실시간 채팅</div>
          <div id="chatContainer" class="panel">
            <div class="entry chat">
              <div><strong>시스템</strong> [시스템]</div>
              <div>채팅을 시작하세요!</div>
            </div>
          </div>
          <div class="chat-inputs">
            <input id="chatInput" type="text" maxlength="200" placeholder="관리자 메시지 입력...">
            <button id="btnSendChat" class="btn">전송</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <div id="toast" class="toast"></div>

  <!-- Socket.IO (고정 도메인) -->
  <script src="https://pyxisbattlesystem.monster/socket.io/socket.io.js"></script>
  <script>
    // 서버 URL
    window.PYXIS_SERVER_URL = "https://pyxisbattlesystem.monster";

    class PyxisAdmin {
      constructor(){
        this.socket = null;
        this.battle = null;
        this.connected = false;
        this.currentBattleId = null;
        this.uptimeTimer = null;
        this.startedAt = null;

        this.cacheEls();
        this.bindEvents();
        this.connect();
        this.toast("시스템이 초기화되었습니다.","info");
      }

      cacheEls(){
        // 전투 제어
        this.elBattleId = document.getElementById('battleId');
        this.elBattleStatus = document.getElementById('battleStatus');
        this.elBattleMode = document.getElementById('battleMode');
        this.btnCreate = document.getElementById('btnCreateBattle');
        this.btnStart  = document.getElementById('btnStartBattle');
        this.btnEnd    = document.getElementById('btnEndBattle');
        this.btnLinks  = document.getElementById('btnGenerateLinks');
        this.linkSection = document.getElementById('linkSection');
        this.playerLinks = document.getElementById('playerLinks');
        this.spectatorLink = document.getElementById('spectatorLink');

        // 참가자
        this.elName = document.getElementById('playerName');
        this.elTeam = document.getElementById('playerTeam');
        this.statAtk = document.getElementById('statAttack');
        this.statDef = document.getElementById('statDefense');
        this.statAgi = document.getElementById('statAgility');
        this.statLuc = document.getElementById('statLuck');
        this.elStatTotal = document.getElementById('statTotal');
        this.itemDit = document.getElementById('itemDittany');
        this.itemAtk = document.getElementById('itemAttack');
        this.itemDef = document.getElementById('itemDefense');
        this.elAvatar = document.getElementById('playerAvatar');
        this.btnAdd   = document.getElementById('btnAddPlayer');
        this.phoenixList = document.getElementById('phoenixTeam');
        this.deathList   = document.getElementById('deathTeam');

        // 통계
        this.statPlayers = document.getElementById('statPlayers');
        this.statSpecs   = document.getElementById('statSpectators');
        this.statTurn    = document.getElementById('statTurn');
        this.statUptime  = document.getElementById('statUptime');

        // 로그/채팅
        this.log = document.getElementById('battleLog');
        this.chat = document.getElementById('chatContainer');
        this.chatInput = document.getElementById('chatInput');
        this.chatSend  = document.getElementById('btnSendChat');

        // 토스트
        this.toastEl = document.getElementById('toast');
      }

      bindEvents(){
        // 버튼
        this.btnCreate.addEventListener('click', () => this.createBattle());
        this.btnStart .addEventListener('click', () => this.startBattle());
        this.btnEnd   .addEventListener('click', () => this.endBattle());
        this.btnLinks .addEventListener('click', () => this.generateLinks());

        // 참가자
        this.btnAdd.addEventListener('click', () => this.addPlayer());

        // 스탯 입력 제한 (각 1–5), 총합 표시는 참고용
        [this.statAtk, this.statDef, this.statAgi, this.statLuc].forEach(el=>{
          el.addEventListener('input', e=>{
            const v = parseInt(e.target.value||0,10);
            if (v < 1) e.target.value = 1;
            if (v > 5) e.target.value = 5;
            this.updateStatTotal();
          });
        });

        // 아이템 수량 0–5
        [this.itemDit, this.itemAtk, this.itemDef].forEach(el=>{
          el.addEventListener('input', e=>{
            const v = parseInt(e.target.value||0,10);
            if (v < 0) e.target.value = 0;
            if (v > 5) e.target.value = 5;
          });
        });

        // 채팅
        this.chatSend.addEventListener('click', () => this.sendChat());
        this.chatInput.addEventListener('keydown', e=>{
          if (e.key === 'Enter' && !e.shiftKey){
            e.preventDefault();
            this.sendChat();
          }
        });

        // 이미지 업로드 검증
        this.elAvatar.addEventListener('change', e=>{
          const f = e.target.files[0];
          if (!f) return;
          if (!f.type.startsWith('image/')){
            this.toast('이미지 파일만 업로드 가능합니다.','error');
            e.target.value = '';
            return;
          }
          if (f.size > 5 * 1024 * 1024){
            this.toast('파일 크기는 5MB 이하여야 합니다.','error');
            e.target.value = '';
          }
        });

        // 키보드 보호
        document.addEventListener('keydown', e=>{
          if (e.key === 'F5'){ e.preventDefault(); this.toast('새로고침이 비활성화되어 있습니다.','info'); }
        });

        // 네트워크
        window.addEventListener('online', () => this.toast('인터넷 연결이 복구되었습니다.','success'));
        window.addEventListener('offline', () => this.toast('인터넷 연결이 끊어졌습니다.','error'));

        // 페이지 이탈
        window.addEventListener('beforeunload', () => this.disconnect());
      }

      connect(){
        this.addLog('system','서버 연결 중...');
        this.socket = io(window.PYXIS_SERVER_URL,{transports:['websocket','polling'],timeout:20000});

        this.socket.on('connect', ()=>{
          this.connected = true;
          this.addLog('system','서버에 연결되었습니다.');
          this.toast('서버 연결 성공','success');
        });

        this.socket.on('connect_error', (err)=>{
          this.addLog('system','연결 오류: ' + err.message);
          this.toast('연결 실패','error');
        });

        this.socket.on('disconnect', (reason)=>{
          this.connected = false;
          this.addLog('system','서버 연결이 끊어졌습니다. 재연결 중...');
          this.toast('연결 끊어짐. 재연결 중...','error');
        });

        // 인증 성공 시 battle 전체 상태 수신한다고 가정
        this.socket.on('auth:success', (data)=>{
          this.battle = data.battle;
          this.currentBattleId = data.battle.id;
          this.updateUI();
          this.addLog('system',`전투 ID ${data.battle.id}로 인증되었습니다.`);
        });

        // 관리자/전투 업데이트
        this.socket.on('admin:update', (data)=>{
          this.battle = data.battle;
          this.updateUI();
          if (data.statistics) this.updateStats(data.statistics);
        });

        // 전투 생성
        this.socket.on('battle:created', (data)=>{
          this.currentBattleId = data.battleId;
          this.elBattleId.textContent = data.battleId;
          this.updateButtons();
          this.addLog('system',`전투 ID ${data.battleId}가 생성되었습니다.`);
          this.toast('전투가 생성되었습니다!','success');
        });

        // 플레이어 추가
        this.socket.on('player:added', (data)=>{
          this.addLog('system',`전투 참가자 추가: ${data.player.name} (${data.player.team === 'phoenix'?'불사조 기사단':'죽음을 먹는 자들'})`);
          this.toast(`${data.player.name}이 추가되었습니다!`,'success');
          this.clearPlayerForm();
        });

        this.socket.on('player:error', (err)=>{
          this.toast(`오류: ${err.message}`,'error');
        });

        // 진행 이벤트
        this.socket.on('battle:started', (data)=>{
          this.addLog('system',`전투가 시작되었습니다. 선공: ${data.firstTeam === 'phoenix'?'불사조 기사단':'죽음을 먹는 자들'}`);
          this.toast('전투 시작!','success');
          this.startUptime();
        });
        this.socket.on('battle:ended', (data)=>{
          const winnerText = data.winner ? (data.winner === 'phoenix'?'불사조 기사단':'죽음을 먹는 자들') + '의 승리!' : '무승부';
          this.addLog('system',`전투가 종료되었습니다. ${winnerText}`);
          this.toast(`전투 종료: ${winnerText}`,'info');
          this.stopUptime();
        });
        this.socket.on('battle:log', (entry)=> this.addLog(entry.type||'battle', entry.message));

        // 채팅
        this.socket.on('chat:message', (msg)=> this.addChat(msg));

        // 접속/준비
        this.socket.on('player:connected',   d=> this.addLog('system', `${d.playerName}이 접속했습니다.`));
        this.socket.on('player:disconnected',d=> this.addLog('system', `${d.playerName}이 연결을 끊었습니다.`));
        this.socket.on('player:ready_update',d=> this.addLog('system', `${d.playerName}: ${d.isReady?'준비 완료':'준비 취소'}`));

        // 관전자 수
        this.socket.on('spectator:count_update', d=>{
          this.statSpecs.textContent = d.count || 0;
        });

        // 턴
        this.socket.on('turn:start', d=> this.addLog('system', `${d.playerName}의 턴이 시작되었습니다. (턴 ${d.turnNumber})`));
        this.socket.on('turn:end',   ()=> this.addLog('system', '턴이 종료되었습니다.'));
      }

      // 전투 생성/시작/종료
      createBattle(){
        if (!this.connected){ this.toast('서버에 연결되지 않았습니다.','error'); return; }
        const mode = this.elBattleMode.value;
        this.addLog('system', `${mode} 전투 생성 중...`);
        this.socket.emit('admin:create_battle',{mode});
      }
      startBattle(){
        if (!this.connected || !this.currentBattleId){ this.toast('전투를 시작할 수 없습니다.','error'); return; }
        if (confirm('전투를 시작하시겠습니까?\n\n모든 플레이어가 준비 완료 상태여야 합니다.\n시작 후에는 플레이어 추가가 불가능합니다.')){
          this.addLog('system','전투 시작 요청 중...');
          this.socket.emit('admin:start_battle',{battleId:this.currentBattleId});
        }
      }
      endBattle(){
        if (!this.connected || !this.currentBattleId){ this.toast('전투를 종료할 수 없습니다.','error'); return; }
        if (confirm('전투를 강제로 종료하시겠습니까?\n\n진행 중인 모든 액션이 중단됩니다.')){
          this.addLog('system','전투 종료 요청 중...');
          this.socket.emit('admin:end_battle',{battleId:this.currentBattleId});
        }
      }

      // 플레이어 추가
      addPlayer(){
        if (!this.connected || !this.currentBattleId){ this.toast('플레이어를 추가할 수 없습니다.','error'); return; }
        const name = (this.elName.value||'').trim();
        if (!name){ this.toast('전투 참가자 이름을 입력하세요.','error'); this.elName.focus(); return; }
        if (name.length > 20){ this.toast('이름은 최대 20글자까지 입력 가능합니다.','error'); return; }

        const stats = {
          attack:  Math.max(1,Math.min(5, parseInt(this.statAtk.value)||3)),
          defense: Math.max(1,Math.min(5, parseInt(this.statDef.value)||3)),
          agility: Math.max(1,Math.min(5, parseInt(this.statAgi.value)||3)),
          luck:    Math.max(1,Math.min(5, parseInt(this.statLuc.value)||3)),
        };
        const items = {
          dittany:         Math.max(0,Math.min(5, parseInt(this.itemDit.value)||0)),
          attack_booster:  Math.max(0,Math.min(5, parseInt(this.itemAtk.value)||0)),
          defense_booster: Math.max(0,Math.min(5, parseInt(this.itemDef.value)||0)),
        };
        const payload = {
          name, team:this.elTeam.value, stats, items,
          hp:100, maxHp:100
        };

        const file = this.elAvatar.files[0];
        if (file){
          const fd = new FormData(); fd.append('avatar', file);
          this.addLog('system','아바타 업로드 중...');
          fetch('/api/upload-avatar',{method:'POST', body:fd})
            .then(r=>r.json())
            .then(j=>{
              if (j.ok){ payload.avatar = j.url; this.socket.emit('admin:add_player', payload); this.addLog('system','아바타 업로드 완료'); }
              else { this.toast(`아바타 업로드 실패: ${j.error}`,'error'); }
            })
            .catch(e=>{ console.error(e); this.toast('아바타 업로드 중 오류가 발생했습니다.','error'); });
        }else{
          this.socket.emit('admin:add_player', payload);
        }
      }

      // 링크 생성 (플레이어별 개별 복사, 관전자 링크 별도 복사)
      generateLinks(){
        if (!this.battle || !this.battle.players || this.battle.players.length===0){
          this.toast('먼저 플레이어를 추가하세요.','error'); return;
        }
        const base = window.location.origin;
        const id = this.battle.id;

        this.playerLinks.innerHTML = '';
        this.battle.players.forEach(p=>{
          const url = `${base}/player?battle=${id}&name=${encodeURIComponent(p.name)}&token=${p.token}`;
          const item = document.createElement('div');
          item.className='item';
          item.innerHTML = `
            <div class="label">${p.name} (${p.team==='phoenix'?'불사조 기사단':'죽음을 먹는 자들'})</div>
            <div class="url" data-copy="${url}">${url}</div>
          `;
          this.playerLinks.appendChild(item);
        });

        const sUrl = `${base}/spectator?battle=${id}`;
        this.spectatorLink.innerHTML = `
          <div class="item">
            <div class="label">관전자 링크 (최대 30명)</div>
            <div class="url" data-copy="${sUrl}">${sUrl}</div>
          </div>
        `;

        // 클릭 복사 단일 이벤트 위임
        this.linkSection.style.display = 'block';
        this.playerLinks.onclick = this.handleCopyClick.bind(this);
        this.spectatorLink.onclick = this.handleCopyClick.bind(this);

        this.addLog('system','접속 링크가 생성되었습니다. 클릭하여 복사하세요.');
        this.toast('링크 생성 완료! 클릭하여 복사하세요.','success');
      }
      handleCopyClick(e){
        const t = e.target.closest('.url');
        if (!t) return;
        const text = t.getAttribute('data-copy');
        navigator.clipboard.writeText(text).then(()=> this.toast('링크가 복사되었습니다.','success'));
      }

      // 채팅
      sendChat(){
        const msg = (this.chatInput.value||'').trim();
        if (!msg || !this.connected) return;
        if (msg.length > 200){ this.toast('메시지는 최대 200글자까지 입력 가능합니다.','error'); return; }
        this.socket.emit('admin:chat',{message:msg});
        this.chatInput.value=''; this.chatInput.focus();
      }

      // UI 업데이트
      updateUI(){
        if (!this.battle) return;
        this.elBattleId.textContent = this.battle.id;
        const st = this.battle.status || 'waiting';
        this.elBattleStatus.textContent = st==='waiting'?'대기':(st==='active'?'진행중':(st==='ended'?'종료':st));
        this.elBattleStatus.className = 'badge ' + (st==='waiting'?'status-waiting':(st==='active'?'status-active':'status-ended'));

        // 팀
        const phoenix = this.battle.players.filter(p=>p.team==='phoenix');
        const death   = this.battle.players.filter(p=>p.team==='death');
        this.renderTeam(this.phoenixList, phoenix);
        this.renderTeam(this.deathList, death);

        this.updateButtons();
      }
      renderTeam(root, list){
        root.innerHTML = '';
        if (!list.length){ root.innerHTML = '<div class="empty">팀원이 없습니다</div>'; return; }
        list.forEach(p=>{
          const status = p.isConnected ? (p.isReady?'ready':'wait') : 'off';
          const statusText = p.isConnected ? (p.isReady?'준비완료':'대기중') : '오프라인';
          const hpPct = Math.max(0, Math.round((p.hp/p.maxHp)*100));
          const el = document.createElement('div');
          el.className='player';
          el.innerHTML = `
            <img src="${p.avatar || '/assets/images/default-avatar.png'}" alt="${p.name}">
            <div class="meta">
              <div class="name">${p.name}</div>
              <div class="sub">공:${p.stats.attack} 방:${p.stats.defense} 민:${p.stats.agility} 행:${p.stats.luck} | HP ${p.hp}/${p.maxHp} (${hpPct}%) | 디터니:${p.items.dittany} 공보:${p.items.attack_booster} 방보:${p.items.defense_booster}</div>
            </div>
            <div class="pill ${status}">${statusText}</div>
          `;
          root.appendChild(el);
        });
      }

      updateButtons(){
        if (!this.battle) return;
        const hasPlayers = (this.battle.players||[]).length >= 2;
        const allReady = (this.battle.players||[]).length>0 && this.battle.players.every(p=>p.isReady);
        this.btnStart.disabled = !(this.battle.status==='waiting' && hasPlayers && allReady);
        this.btnEnd.disabled   = (this.battle.status==='ended');
        this.btnLinks.disabled = !(this.currentBattleId && (this.battle.players||[]).length>0);
        this.btnAdd.disabled   = (this.battle.status==='active');
      }

      updateStats(s){
        this.statPlayers.textContent = `${s.connectedPlayers}/${s.totalPlayers}`;
        this.statSpecs.textContent = s.spectators || 0;
        this.statTurn.textContent = s.turnNumber || 0;
        if (s.uptime){
          const m = Math.floor(s.uptime/60000), sec = Math.floor((s.uptime%60000)/1000);
          this.statUptime.textContent = `${m}:${String(sec).padStart(2,'0')}`;
        }
      }

      startUptime(){
        this.startedAt = Date.now();
        this.stopUptime();
        this.uptimeTimer = setInterval(()=>{
          const el = Date.now() - this.startedAt;
          const m = Math.floor(el/60000), s = Math.floor((el%60000)/1000);
          this.statUptime.textContent = `${m}:${String(s).padStart(2,'0')}`;
        },1000);
      }
      stopUptime(){ if (this.uptimeTimer){ clearInterval(this.uptimeTimer); this.uptimeTimer=null; } }

      updateStatTotal(){
        const total =
          (parseInt(this.statAtk.value||0,10))+
          (parseInt(this.statDef.value||0,10))+
          (parseInt(this.statAgi.value||0,10))+
          (parseInt(this.statLuc.value||0,10));
        this.elStatTotal.textContent = `총합: ${total} (제한 없음)`;
      }

      clearPlayerForm(){
        this.elName.value='';
        this.statAtk.value='3'; this.statDef.value='3'; this.statAgi.value='3'; this.statLuc.value='3';
        this.itemDit.value='1'; this.itemAtk.value='1'; this.itemDef.value='1';
        this.elAvatar.value='';
      }

      addLog(type, msg){
        const div = document.createElement('div');
        div.className = 'entry ' + (type||'system');
        const ts = new Date().toLocaleTimeString();
        div.textContent = `[${ts}] ${msg}`;
        this.log.appendChild(div);
        this.log.scrollTop = this.log.scrollHeight;
        if (this.log.children.length > 200) this.log.removeChild(this.log.firstChild);
      }

      addChat(data){
        const div = document.createElement('div');
        div.className = 'entry chat';
        const ts = new Date().toLocaleTimeString();
        const sender = data.senderName || '익명';
        div.innerHTML = `<div><strong>${sender}</strong> [${ts}]</div><div>${(data.message||'')}</div>`;
        this.chat.appendChild(div);
        this.chat.scrollTop = this.chat.scrollHeight;
        if (this.chat.children.length > 200) this.chat.removeChild(this.chat.firstChild);
      }

      toast(msg,type='info'){
        this.toastEl.textContent = msg;
        this.toastEl.className = `toast ${type} show`;
        setTimeout(()=>{ this.toastEl.classList.remove('show'); }, 2600);
      }

      disconnect(){
        try{ if (this.socket) this.socket.disconnect(); }catch(_){}
        this.stopUptime();
        this.addLog('system','관리자 콘솔이 종료되었습니다.');
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      window.pyxisAdmin = new PyxisAdmin();
    });
  </script>
</body>
</html>
