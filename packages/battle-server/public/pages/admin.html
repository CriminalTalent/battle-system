<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>PYXIS 관리자</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- 공용/관리자 스타일 -->
  <link rel="stylesheet" href="/assets/css/core.css" />
  <link rel="stylesheet" href="/assets/css/pyxis-unified.css" />
  <link rel="stylesheet" href="/assets/css/components.css" />
  <link rel="stylesheet" href="/assets/css/effects.css" />
  <link rel="stylesheet" href="/assets/css/admin.css" />

  <!-- 드롭다운 가독성 강화 -->
  <style>
    .admin-page select.select{
      background-color: rgba(0,8,13,.95) !important;
      color: var(--ink, #f2ead7) !important;
      border-color: var(--border-gold, rgba(220,199,162,.2)) !important;
    }
    .admin-page select.select option{
      background-color: #001E35 !important;
      color: #f2ead7 !important;
    }
    @supports (color-scheme: dark){
      .admin-page select{ color-scheme: dark; }
    }
    
    /* 연결 상태 표시 */
    .connection-indicator {
      position: fixed;
      top: 10px;
      left: 10px;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      z-index: 9999;
      transition: all 0.3s ease;
    }
    .connection-indicator.connected {
      background: #059669;
      color: white;
    }
    .connection-indicator.disconnected {
      background: #dc2626;
      color: white;
    }
    .connection-indicator.connecting {
      background: #d97706;
      color: white;
    }
  </style>
</head>
<body class="admin-page">
  <!-- 연결 상태 표시 -->
  <div id="connectionIndicator" class="connection-indicator connecting">연결 중...</div>

  <header class="pyxis-header" role="banner" aria-label="PYXIS 관리자 헤더">
    <div class="header-inner">
      <h1 class="pyxis-logo"><span class="star">✦</span> PYXIS <span class="star">✦</span></h1>
      <span id="statusPill" class="status-pill waiting" aria-live="polite">전투 대기 중</span>
    </div>
    <div class="header-bg" aria-hidden="true"></div>
  </header>

  <main id="mainView" class="container admin-container" role="main">
    <div class="grid admin-grid">
      <!-- 전투 제어 섹션 -->
      <section class="card" aria-labelledby="sec-control">
        <h2 id="sec-control" class="title">전투 제어</h2>

        <!-- 전투 생성 -->
        <div class="section">
          <div class="section-title">전투 생성</div>
          <div class="grid grid-3 compact">
            <label class="form-field">
              <span class="label">전투 모드</span>
              <select id="battleMode" class="select" aria-label="전투 모드">
                <option value="1v1">1v1</option>
                <option value="2v2">2v2</option>
                <option value="3v3">3v3</option>
                <option value="4v4">4v4</option>
              </select>
            </label>
            <button id="btnCreateBattle" class="btn-primary compact" type="button">전투 생성</button>
            <span id="battleId" class="battle-id" aria-live="polite">-</span>
          </div>
        </div>

        <!-- 전투 제어 버튼 -->
        <div class="section">
          <div class="section-title">제어</div>
          <div class="grid grid-4 compact">
            <button id="btnStart" class="btn-success compact" type="button">시작</button>
            <button id="btnPause" class="btn-warning compact" type="button">일시정지</button>
            <button id="btnResume" class="btn-info compact" type="button">재개</button>
            <button id="btnEnd" class="btn-danger compact" type="button">종료</button>
          </div>
        </div>

        <!-- 링크 생성 -->
        <div class="section">
          <div class="section-title">링크 생성</div>
          <div class="grid grid-2 compact">
            <button id="btnGenPlayerOtp" class="btn-secondary compact" type="button">참가자별 링크 생성</button>
            <button id="btnGenSpectatorOtp" class="btn-secondary compact" type="button">관전자 링크 생성</button>
          </div>
          <div class="link-display">
            <div class="link-item">
              <span class="link-label">관리자 URL:</span>
              <span id="adminUrl" class="link-value" title="클릭하여 복사">-</span>
            </div>
            <div class="link-item">
              <span class="link-label">참가자 비밀번호:</span>
              <div id="playerOtp" class="otp-value">-</div>
            </div>
            <div class="link-item">
              <span class="link-label">관전자 비밀번호:</span>
              <div id="spectatorOtp" class="otp-value">-</div>
            </div>
            <div class="link-item">
              <span class="link-label">참가자 URL:</span>
              <span id="playerUrl" class="link-value" title="클릭하여 복사">-</span>
            </div>
            <div class="link-item">
              <span class="link-label">관전자 URL:</span>
              <span id="spectatorUrl" class="link-value" title="클릭하여 복사">-</span>
            </div>
          </div>
        </div>
      </section>

      <!-- 참가자 관리 섹션 -->
      <section class="card" aria-labelledby="sec-participants">
        <h2 id="sec-participants" class="title">참가자 관리</h2>

        <!-- 전투 참가자 추가 -->
        <div class="section">
          <div class="section-title">전투 참가자 추가</div>
          <div class="grid grid-2 compact">
            <label class="form-field">
              <span class="label">이름</span>
              <input id="pName" type="text" class="input" placeholder="참가자 이름" maxlength="20" />
            </label>
            <label class="form-field">
              <span class="label">팀</span>
              <select id="pTeam" class="select" aria-label="팀 선택">
                <option value="phoenix">불사조 기사단</option>
                <option value="eaters">죽음을 먹는 자들</option>
              </select>
            </label>
          </div>

          <!-- 이미지 업로드 -->
          <div class="section-subsection">
            <div class="section-subtitle">이미지 업로드</div>
            <label class="form-field">
              <input id="pAvatar" type="file" class="input-file" accept="image/*" />
              <div class="avatar-preview-container">
                <img id="pAvatarPreview" class="avatar-preview" style="display:none;" alt="이미지 미리보기" />
                <div id="pAvatarMeta" class="file-meta"></div>
              </div>
            </label>
          </div>

          <!-- 스탯 설정 (12포인트 제한 제거) -->
          <div class="section-subsection">
            <div class="section-subtitle">스탯 배분 (각 1-10)</div>
            <div class="grid grid-4 compact">
              <label class="form-field">
                <span class="label">공격</span>
                <input id="sATK" type="number" class="input" min="1" max="10" value="3" />
              </label>
              <label class="form-field">
                <span class="label">방어</span>
                <input id="sDEF" type="number" class="input" min="1" max="10" value="3" />
              </label>
              <label class="form-field">
                <span class="label">민첩</span>
                <input id="sDEX" type="number" class="input" min="1" max="10" value="3" />
              </label>
              <label class="form-field">
                <span class="label">행운</span>
                <input id="sLUK" type="number" class="input" min="1" max="10" value="3" />
              </label>
            </div>
            <label class="form-field">
              <span class="label">체력</span>
              <input id="pHP" type="number" class="input" min="1" max="200" value="100" />
            </label>
          </div>

          <!-- 시작 아이템 -->
          <div class="section-subsection">
            <div class="section-subtitle">시작 아이템</div>
            <div class="grid grid-3 compact">
              <label class="form-field">
                <span class="label">디터니 (회복)</span>
                <input id="itemDittany" type="number" class="input" min="0" max="9" value="1" />
              </label>
              <label class="form-field">
                <span class="label">공격 보정기</span>
                <input id="itemAtkBoost" type="number" class="input" min="0" max="9" value="1" />
              </label>
              <label class="form-field">
                <span class="label">방어 보정기</span>
                <input id="itemDefBoost" type="number" class="input" min="0" max="9" value="1" />
              </label>
            </div>
          </div>

          <button id="btnAddPlayer" class="btn-primary" type="button">전투 참가자 추가</button>
          <div id="addPlayerMsg" class="message" style="display:none;"></div>
        </div>

        <!-- 팀 목록 -->
        <div class="section">
          <div class="section-title">팀 목록</div>
          <div class="grid grid-2">
            <div class="team-roster">
              <h3 class="team-title phoenix">불사조 기사단</h3>
              <div id="rosterPhoenix" class="roster-list" aria-live="polite"></div>
            </div>
            <div class="team-roster">
              <h3 class="team-title eaters">죽음을 먹는 자들</h3>
              <div id="rosterEaters" class="roster-list" aria-live="polite"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- 로그 & 채팅 섹션 -->
      <section class="card chat-section" aria-labelledby="sec-logs">
        <h2 id="sec-logs" class="title">로그 & 채팅</h2>

        <!-- 전투 로그 -->
        <div class="section">
          <div class="section-title">실시간 로그</div>
          <div id="battleLog" class="log-container" role="log" aria-live="polite"></div>
        </div>

        <!-- 채팅 -->
        <div class="section">
          <div class="section-title">관리자 채팅</div>
          <div id="chatView" class="chat-container" role="log" aria-live="polite"></div>
          <div class="chat-input">
            <input id="chatText" type="text" class="input" placeholder="메시지를 입력하세요..." maxlength="200" />
            <button id="btnChatSend" class="btn-primary compact" type="button">전송</button>
          </div>
        </div>

        <!-- 현재 관전자 수 -->
        <div class="section">
          <div class="section-title">실시간 현황</div>
          <div class="stats-grid">
            <div class="stat-item">
              <span class="stat-label">관전자</span>
              <span id="spectatorCount" class="stat-value">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">전투 참가자</span>
              <span id="playerCount" class="stat-value">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">전투 수</span>
              <span id="battleCount" class="stat-value">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">서버 상태</span>
              <span id="serverStatus" class="stat-value">확인 중</span>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- 스크립트 로드 -->
  <script src="/socket.io/socket.io.js"></script>
  <script src="/assets/js/admin.js"></script>

  <!-- 초기화 -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log('PYXIS 관리자 페이지 로드 시작');
      
      // 연결 상태 표시 업데이트
      const connectionIndicator = document.getElementById('connectionIndicator');
      
      function updateConnectionIndicator(status, text) {
        if (!connectionIndicator) return;
        connectionIndicator.className = `connection-indicator ${status}`;
        connectionIndicator.textContent = text;
      }
      
      // Socket.IO 로드 확인
      if (typeof io === 'undefined') {
        console.error('Socket.IO가 로드되지 않았습니다!');
        updateConnectionIndicator('disconnected', '연결 실패');
        alert('Socket.IO 로드 실패. 서버 연결을 확인하세요.');
        return;
      }
      
      updateConnectionIndicator('connecting', '연결 중...');
      
      // 관리자 시스템 초기화
      if (window.PyxisAdmin) {
        console.log('PyxisAdmin 초기화 중...');
        
        // 연결 상태 모니터링을 위한 이벤트 추가
        const originalSetupSocket = window.PyxisAdmin.setupSocket;
        window.PyxisAdmin.setupSocket = function() {
          originalSetupSocket.call(this);
          
          if (this.state && this.state.socket) {
            this.state.socket.on('connect', () => {
              updateConnectionIndicator('connected', '연결됨');
            });
            
            this.state.socket.on('disconnect', () => {
              updateConnectionIndicator('disconnected', '연결 해제됨');
            });
            
            this.state.socket.on('connect_error', () => {
              updateConnectionIndicator('disconnected', '연결 오류');
            });
          }
        };
        
        window.PyxisAdmin.init();
        
        // 서버 상태 모니터링
        const updateServerStats = async () => {
          try {
            const response = await fetch('/api/health');
            const data = await response.json();
            
            if (data.ok) {
              document.getElementById('serverStatus').textContent = '정상';
              document.getElementById('battleCount').textContent = data.battles || 0;
            }
          } catch (error) {
            document.getElementById('serverStatus').textContent = '오류';
          }
        };
        
        // 5초마다 서버 상태 확인
        updateServerStats();
        setInterval(updateServerStats, 5000);
        
      } else {
        console.error('PyxisAdmin이 로드되지 않았습니다!');
        updateConnectionIndicator('disconnected', '시스템 오류');
        alert('관리자 시스템 로드 실패');
      }

      console.log('PYXIS 관리자 페이지 로드 완료');
    });

    // 디버그용 전역 함수
    window.debugAdmin = function() {
      if (window.PyxisAdmin && typeof window.PyxisAdmin.getDebugInfo === 'function') {
        console.log('=== PYXIS Admin 디버그 정보 ===');
        console.log(window.PyxisAdmin.getDebugInfo());
      }
    };

    // 빠른 테스트 함수
    window.quickTest = function() {
      console.log('=== 빠른 연결 테스트 ===');
      if (window.PyxisAdmin) {
        window.PyxisAdmin.createBattle('1v1');
        setTimeout(() => {
          console.log('전투 생성 후 상태:', window.PyxisAdmin.state);
        }, 2000);
      }
    };

    // 에러 핸들링
    window.addEventListener('error', function(e) {
      console.error('JavaScript 오류:', e.error);
      document.getElementById('connectionIndicator').className = 'connection-indicator disconnected';
      document.getElementById('connectionIndicator').textContent = 'JS 오류';
    });

    window.addEventListener('unhandledrejection', function(e) {
      console.error('Promise 오류:', e.reason);
    });

    // 키보드 단축키
    document.addEventListener('keydown', function(e) {
      // Ctrl+Shift+D: 디버그 정보
      if (e.ctrlKey && e.shiftKey && e.code === 'KeyD') {
        e.preventDefault();
        window.debugAdmin();
      }
      
      // Ctrl+Shift+T: 빠른 테스트
      if (e.ctrlKey && e.shiftKey && e.code === 'KeyT') {
        e.preventDefault();
        window.quickTest();
      }
    });

    // 페이지 종료 시 경고
    window.addEventListener('beforeunload', function(e) {
      if (window.PyxisAdmin && window.PyxisAdmin.state && window.PyxisAdmin.state.battleId) {
        e.preventDefault();
        e.returnValue = '전투가 진행 중입니다. 정말 페이지를 떠나시겠습니까?';
      }
    });
  </script>
</body>
</html>
