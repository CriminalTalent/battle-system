<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>PYXIS 관리자</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Fonts: Playfair Display (serif for headings), Cinzel (logo) -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Cinzel:wght@700&family=Inter:wght@500;600&display=swap" rel="stylesheet">
  <style>
  :root{
    /* Brand colors */
    --gold-1:#DCC7A2; --gold-2:#D4BA8D;
    --ink:#EEE6D6; --ink-dim:#BEB49A;
    --bg-0:#070B12; --bg-1:#0A1220;

    /* Surfaces */
    --panel-2:rgba(0,30,53,.45); --panel-3:rgba(0,35,65,.60);
    --glass-light:rgba(255,255,255,.06);
    --border-subtle:rgba(220,199,162,.16);

    /* Accents by state */
    --ok:#7BD389; --warn:#F6D37A; --err:#FF7B7B;

    /* Layout */
    --r:12px; --blur:blur(10px); --t:.16s;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family: Inter, "Noto Sans KR", system-ui, sans-serif;
    background:linear-gradient(180deg,var(--bg-0) 0%,var(--bg-1) 100%);
  }

  /* Header with rotating radial gradient + subtle twinkle stars (no emoji used) */
  .header{
    position:sticky; top:0; z-index:20;
    border-bottom:1px solid var(--border-subtle);
    backdrop-filter:saturate(1.15) blur(8px);
    background:
      radial-gradient(120% 120% at 0% 0%, rgba(220,199,162,.10), rgba(0,0,0,0) 60%) fixed;
  }
  .header::before{
    content:"";
    position:absolute; inset:-80% -20% -40% -20%;
    background:conic-gradient(from 0deg, rgba(220,199,162,.14), rgba(0,0,0,0) 25%, rgba(212,186,141,.18) 50%, rgba(0,0,0,0) 75%, rgba(220,199,162,.14));
    animation:rotateGrad 24s linear infinite;
    filter:blur(40px) saturate(1.1); pointer-events:none;
  }
  @keyframes rotateGrad { to { transform:rotate(360deg) } }

  .brand{max-width:1180px; margin:0 auto; padding:12px 12px; display:flex; gap:12px; align-items:center; justify-content:space-between; position:relative}
  .brand-title{
    font-family: Cinzel, serif;
    letter-spacing:.12em; font-size:18px; line-height:1;
    background:linear-gradient(90deg,var(--gold-1),var(--gold-2));
    -webkit-background-clip:text; background-clip:text; color:transparent;
    position:relative; padding-left:2px;
  }
  /* Twinkle decorative stars (SVG-like via masks) */
  .brand-title::after{
    content:"";
    position:absolute; left:-18px; top:-6px; width:10px; height:10px;
    background: radial-gradient(circle at 50% 50%, var(--gold-1) 0 35%, transparent 36%),
                radial-gradient(circle at 50% 50%, transparent 0 70%, var(--gold-2) 71% 72%, transparent 73%);
    filter:drop-shadow(0 0 6px rgba(220,199,162,.45));
    animation:twinkle 2.4s ease-in-out infinite;
  }
  .brand-title::before{
    content:"";
    position:absolute; left:-4px; top:10px; width:7px; height:7px;
    background: radial-gradient(circle at 50% 50%, var(--gold-2) 0 40%, transparent 41% 100%);
    filter:drop-shadow(0 0 4px rgba(212,186,141,.55));
    animation:twinkle 3.2s ease-in-out infinite .6s;
  }
  @keyframes twinkle{
    0%,100%{opacity:.25; transform:scale(.8)}
    50%{opacity:1; transform:scale(1)}
  }

  .brand-note{font-family: Playfair Display, serif; color:var(--ink-dim); font-size:12px}

  .container{max-width:1180px; margin:0 auto; padding:12px}

  /* Responsive grid */
  .grid{display:grid; gap:12px; grid-template-columns:1.1fr 1.1fr 1fr}
  @media(max-width:1100px){.grid{grid-template-columns:1fr 1fr}}
  @media(max-width:760px){.grid{grid-template-columns:1fr}}

  .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  @media(max-width:760px){.grid-2{grid-template-columns:1fr}}

  .grid-4{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:6px}
  @media(max-width:920px){.grid-4{grid-template-columns:repeat(2,minmax(0,1fr))}}

  /* Card design with glass effect + elegant hover */
  .card{
    background:linear-gradient(180deg,var(--panel-2),var(--panel-3));
    border:1px solid var(--border-subtle);
    border-radius:var(--r); padding:12px;
    box-shadow:0 6px 20px rgba(0,0,0,.35); backdrop-filter:var(--blur);
    position:relative; overflow:hidden;
    transition:transform var(--t), box-shadow var(--t), border-color var(--t);
  }
  .card::before{
    content:"";
    position:absolute; inset:0;
    border-top:1px solid rgba(220,199,162,.12);
    pointer-events:none;
  }
  .card:hover{
    transform:translateY(-2px);
    box-shadow:0 10px 28px rgba(0,0,0,.45);
    border-color:rgba(220,199,162,.22);
  }

  .title{
    display:flex; align-items:center; justify-content:space-between;
    color:var(--gold-1); font-weight:600; letter-spacing:.04em;
    font-size:14px; margin:0 0 8px; font-family: Playfair Display, serif;
  }
  .pill{
    font-size:11px; padding:2px 8px; border-radius:999px;
    border:1px solid rgba(220,199,162,.35); color:var(--ink-dim)
  }

  .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .col{display:flex; flex-direction:column; gap:4px}
  label{font-size:11px; color:var(--ink-dim)}

  /* Inputs */
  .input,.select,.file{
    width:100%; min-width:0; padding:10px 12px; border-radius:10px;
    border:1px solid var(--border-subtle);
    background:linear-gradient(180deg, rgba(0,30,53,.35), rgba(0,30,53,.7));
    color:var(--ink); outline:none;
    transition:border-color var(--t), box-shadow var(--t), background var(--t);
  }
  .input::placeholder{color:rgba(238,230,214,.5)}
  .input:focus,.select:focus,.file:focus{
    border-color:var(--gold-1); box-shadow:0 0 0 2px rgba(220,199,162,.22)
  }

  /* Select: dark dropdown fix (including options) */
  .select{
    appearance:none; -webkit-appearance:none; -moz-appearance:none;
    background-image:
      linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,0)),
      radial-gradient(circle at right 12px top 50%, var(--gold-1) 2px, transparent 3px),
      radial-gradient(circle at right 6px top 50%, var(--gold-1) 2px, transparent 3px);
    background-repeat:no-repeat;
    background-position:0 0, right 12px center, right 6px center;
    background-size:auto, 6px 6px, 6px 6px;
    padding-right:28px;
  }
  select option{
    background:#0A1220; color:#EEE6D6;
  }

  /* Buttons: premium gradient + shimmer */
  .btn{
    appearance:none; border:1px solid rgba(220,199,162,.35);
    background:linear-gradient(135deg, rgba(0,30,53,.55), rgba(0,30,53,.85));
    color:var(--gold-1); border-radius:10px; padding:10px 12px;
    font-weight:700; letter-spacing:.02em;
    transition:transform var(--t), box-shadow var(--t), border-color var(--t);
    position:relative; overflow:hidden;
    touch-action:manipulation;
  }
  .btn::after{
    content:"";
    position:absolute; inset:0; transform:translateX(-120%);
    background:linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);
    transition:transform .6s ease;
  }
  .btn:hover{transform:translateY(-1px); box-shadow:0 6px 20px rgba(0,0,0,.35); border-color:rgba(220,199,162,.5)}
  .btn:hover::after{transform:translateX(120%)}

  .muted{color:var(--ink-dim); font-size:11px}
  .copy-grid{display:grid; gap:6px; grid-template-columns:1fr auto; align-items:center}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace; word-break:break-all; font-size:12px}

  /* Teams & participants */
  .teams{display:grid; gap:8px; grid-template-columns:1fr 1fr}
  @media(max-width:760px){.teams{grid-template-columns:1fr}}
  .team{background:linear-gradient(180deg, rgba(0,30,53,.35), rgba(0,30,53,.6)); border:1px solid var(--border-subtle); border-radius:10px; padding:8px}
  .team-head{display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; color:var(--gold-1); font-weight:700}
  .participants{display:grid; gap:6px}
  .participant{display:grid; grid-template-columns:44px 1fr auto; gap:8px; align-items:center; background:linear-gradient(180deg, rgba(0,30,53,.35), rgba(0,30,53,.55)); border:1px solid var(--border-subtle); border-radius:10px; padding:6px}
  .avatar{width:44px; height:72px; border-radius:8px; object-fit:cover; border:1px solid rgba(220,199,162,.35); background:rgba(0,0,0,.2)}
  .p-name{font-weight:700; font-size:13px}
  .p-stat{font-size:11px; color:var(--ink-dim)}
  .p-actions{display:flex; gap:6px}

  /* Timeline unified feed (taller; card spans 2 rows; width equals one column) */
  .card--timeline{grid-column:auto; grid-row:span 2; display:flex; flex-direction:column}
  .timeline{flex:1; min-height:280px; overflow:auto; border:1px solid var(--border-subtle); border-radius:10px; padding:8px; background:rgba(0,0,0,.18)}
  .timeline__line{font-size:12px; margin-bottom:4px; display:flex; gap:6px; align-items:flex-start; line-height:1.35}
  .tl__time{opacity:.7; min-width:78px}
  .tl__tag{font-size:10px; padding:1px 6px; border-radius:999px; border:1px solid rgba(220,199,162,.35); color:var(--gold-1)}
  .tl__msg{flex:1}
  .tag--sys{color:var(--ok); border-color:var(--ok)}
  .tag--chat{color:#D0B6FF; border-color:#D0B6FF}
  .tag--admin{color:var(--warn); border-color:var(--warn)}

  /* Custom scrollbar */
  .timeline::-webkit-scrollbar{width:10px}
  .timeline::-webkit-scrollbar-thumb{background:linear-gradient(var(--gold-2), var(--gold-1)); border-radius:999px}
  .timeline::-webkit-scrollbar-track{background:rgba(255,255,255,.05); border-radius:999px}

  @media(max-width:760px){
    .btn{padding:12px 14px}
    .card--timeline{grid-row:auto}
    .timeline{min-height:240px}
  }
  </style>
</head>
<body>
  <header class="header">
    <div class="brand">
      <div class="brand-title">PYXIS 관리자 콘솔</div>
      <div class="brand-note">우아한 인터페이스 · 반응형 · 실시간</div>
    </div>
  </header>

  <main class="container">
    <section class="grid">
      <!-- 전투 제어 -->
      <div class="card">
        <h3 class="title">전투 제어 <span class="pill">생성/시작/일시정지/재개/종료</span></h3>

        <div class="row" style="margin-bottom:6px">
          <label for="selMode" class="muted">전투 모드</label>
          <select id="selMode" class="select">
            <option value="1v1" selected>1 대 1</option>
            <option value="2v2">2 대 2</option>
            <option value="3v3">3 대 3</option>
            <option value="4v4">4 대 4</option>
          </select>
          <button id="btnCreate" class="btn">전투 생성</button>
        </div>

        <div class="grid-2" style="margin-bottom:6px">
          <div class="col">
            <label for="battleId">전투 ID</label>
            <input id="battleId" class="input" placeholder="생성 시 자동 입력" />
          </div>
          <input id="adminToken" class="input" placeholder="관리자 토큰(자동)" style="display:none" />
        </div>

        <div class="row" style="gap:6px;">
          <button id="btnStart" class="btn">시작</button>
          <button id="btnPause" class="btn">일시정지</button>
          <button id="btnResume" class="btn">재개</button>
          <button id="btnEnd" class="btn">종료</button>
        </div>
      </div>

      <!-- 링크/비밀번호 -->
      <div class="card">
        <h3 class="title">링크/비밀번호 <span class="pill">자동 발행</span></h3>

        <div class="copy-grid">
          <div><div class="muted">관리자 링크</div><div id="linkAdmin" class="mono"></div></div>
          <button id="copyAdmin" class="btn">복사</button>
        </div>
        <div class="copy-grid">
          <div><div class="muted">전투 참가자 링크</div><div id="linkPlayer" class="mono"></div></div>
          <button id="copyPlayer" class="btn">복사</button>
        </div>
        <div class="copy-grid">
          <div><div class="muted">관전자 링크</div><div id="linkSpectator" class="mono"></div></div>
          <button id="copySpec" class="btn">복사</button>
        </div>

        <div class="row" style="margin-top:8px">
          <label for="optOtpCount">전투 참가자 비밀번호 개수</label>
          <input id="optOtpCount" class="input" type="number" min="1" max="100" value="2" />
        </div>
        <div class="row" style="gap:6px">
          <button id="btnOtpPlayer" class="btn">전투 참가자 비밀번호 발급</button>
          <button id="btnOtpSpec" class="btn">관전자 비밀번호 발급(1개/30명)</button>
        </div>

        <div class="col" style="margin-top:8px">
          <div class="muted">최근 발급 결과</div>
          <div id="otpResult" class="mono"></div>
        </div>
      </div>

      <!-- 타임라인: 시스템/채팅/관리 통합 -->
      <div class="card card--timeline">
        <h3 class="title">타임라인 <span class="pill">시스템/채팅/관리</span></h3>
        <div id="timeline" class="timeline"></div>
        <div class="row" style="margin-top:8px">
          <input id="chatInput" class="input" placeholder="메시지를 입력하세요 (관리자 이름으로 전송)" />
          <button id="btnSendChat" class="btn">전송</button>
        </div>
      </div>

      <!-- 전투 참가자 생성 -->
      <div class="card">
        <h3 class="title">전투 참가자 생성 <span class="pill">추가</span></h3>

        <div class="grid-2">
          <div class="col">
            <label for="pName">이름</label>
            <input id="pName" class="input" placeholder="이름" />
          </div>
          <div class="col">
            <label for="pTeam">팀</label>
            <select id="pTeam" class="select">
              <option value="phoenix">불사조 기사단</option>
              <option value="eaters">죽음을 먹는 자들</option>
            </select>
          </div>
        </div>

        <div class="col" style="margin-top:6px">
          <label>능력치 (각 최대 5)</label>
          <div class="grid-4">
            <div class="col">
              <label for="pATK">공격력</label>
              <input id="pATK" class="input" type="number" value="3" min="0" max="5" />
            </div>
            <div class="col">
              <label for="pDEF">방어력</label>
              <input id="pDEF" class="input" type="number" value="3" min="0" max="5" />
            </div>
            <div class="col">
              <label for="pAGI">민첩</label>
              <input id="pAGI" class="input" type="number" value="3" min="0" max="5" />
            </div>
            <div class="col">
              <label for="pLUK">행운</label>
              <input id="pLUK" class="input" type="number" value="3" min="0" max="5" />
            </div>
          </div>
        </div>

        <div class="col" style="margin-top:6px">
          <label>아이템 수량</label>
          <div class="grid-4">
            <div class="col">
              <label for="pHeal10">디터니</label>
              <input id="pHeal10" class="input" type="number" value="0" min="0" max="99" />
            </div>
            <div class="col">
              <label for="pAtkBoost">공격 보정기</label>
              <input id="pAtkBoost" class="input" type="number" value="0" min="0" max="99" />
            </div>
            <div class="col">
              <label for="pDefBoost">방어 보정기</label>
              <input id="pDefBoost" class="input" type="number" value="0" min="0" max="99" />
            </div>
          </div>
        </div>

        <div class="grid-2" style="margin-top:6px; align-items:end">
          <div class="col">
            <label for="pAvatarFile">이미지 파일</label>
            <input id="pAvatarFile" class="file" type="file" accept="image/*" />
            <div class="muted">업로드 후 아래 URL 자동 입력</div>
          </div>
          <div class="col">
            <label for="pAvatarUrl">이미지 URL</label>
            <input id="pAvatarUrl" class="input" placeholder="/uploads/avatars/..." />
          </div>
        </div>

        <div class="row" style="margin-top:8px; gap:6px">
          <button id="btnUploadAvatar" class="btn">이미지 업로드</button>
          <button id="btnAddPlayer" class="btn">전투 참가자 추가</button>
        </div>
      </div>

      <!-- 전투 참가자 목록 -->
      <div class="card">
        <h3 class="title">전투 참가자 목록 <span class="pill">팀 현황</span></h3>
        <div class="teams">
          <div class="team">
            <div class="team-head">불사조 기사단 <span class="pill" id="cntPhoenix">0명</span></div>
            <div class="participants" id="listPhoenix"></div>
          </div>
          <div class="team">
            <div class="team-head">죽음을 먹는 자들 <span class="pill" id="cntEaters">0명</span></div>
            <div class="participants" id="listEaters"></div>
          </div>
        </div>
      </div>

    </section>
  </main>

  <script src="/socket.io/socket.io.js"></script>
  <script>
  (function(){
    const $=(s,r=document)=>r.querySelector(s);
    const qp=new URLSearchParams(location.search);

    const UI={
      timeline:null,
      init(){ this.timeline = $('#timeline'); },
      _append(type, msg, name){
        if(!this.timeline) return;
        const wrap=document.createElement('div'); wrap.className='timeline__line';
        const t=document.createElement('span'); t.className='tl__time'; t.textContent='['+new Date().toLocaleTimeString()+']';
        const tag=document.createElement('span'); tag.className='tl__tag '+(type==='sys'?'tag--sys':type==='admin'?'tag--admin':'tag--chat');
        tag.textContent=type==='sys'?'시스템':(type==='admin'?'관리':'채팅');
        const body=document.createElement('span'); body.className='tl__msg';
        if(name && type==='chat') body.textContent=`${name}: ${msg}`; else body.textContent=msg;
        wrap.appendChild(t); wrap.appendChild(tag); wrap.appendChild(body);
        this.timeline.appendChild(wrap); this.timeline.scrollTop=this.timeline.scrollHeight;
      },
      admin(m){ this._append('admin', m) },
      sys(m){ this._append('sys', m) },
      chat(m,n){ this._append('chat', m, n) },
      setText(sel, v){ const el=$(sel); if(el) el.textContent=String(v ?? '') }
    };

    async function jfetch(url,opt={}) {
      const res = await fetch(url, { headers:{'Content-Type':'application/json', ...(opt.headers||{})}, ...opt });
      let body=null; try{ body=await res.json() }catch{}
      if(!res.ok) throw new Error((body&&(body.message||body.error))||res.statusText||('HTTP '+res.status));
      return body||{};
    }
    async function post(url,data){return jfetch(url,{method:'POST',body:JSON.stringify(data||{})})}

    const API={
      create:'/api/battles',
      get:(id)=>'/api/battles/'+encodeURIComponent(id),
      start:(id)=>'/api/admin/battles/'+encodeURIComponent(id)+'/start',
      pause:(id)=>'/api/admin/battles/'+encodeURIComponent(id)+'/pause',
      resume:(id)=>'/api/admin/battles/'+encodeURIComponent(id)+'/resume',
      end:(id)=>'/api/admin/battles/'+encodeURIComponent(id)+'/end',
      links:(id)=>'/api/admin/battles/'+encodeURIComponent(id)+'/links',
      otp:(id)=>'/api/admin/battles/'+encodeURIComponent(id)+'/otp',
      addPlayer:(id)=>'/api/battles/'+encodeURIComponent(id)+'/players',
      delPlayer:(id,pid)=>'/api/battles/'+encodeURIComponent(id)+'/players/'+encodeURIComponent(pid),
      uploadAvatar:(id)=>'/api/battles/'+encodeURIComponent(id)+'/avatar',
    };

    let socket=null;
    function attachSocketListeners(){
      if(!socket) return;
      socket.on('connect',()=>{ UI.admin('소켓 연결 완료'); tryAdminAuth() });
      socket.on('disconnect',()=>{ UI.admin('소켓 연결 끊김') });
      socket.on('authSuccess',()=>{ UI.admin('관리자 인증 성공') });
      socket.on('authError',(e)=>{ UI.admin('관리자 인증 실패: '+(e&&e.error||'unknown')) });
      socket.on('error',(e)=>{ UI.admin('소켓 오류: '+(e&&e.message||e||'unknown')) });

      socket.on('battleUpdate',(snap)=>{
        UI.sys('상태 업데이트 수신');
        if(snap && typeof snap==='object') renderParticipants(snap); else refreshParticipants();
      });
      socket.on('battle:log',(p)=>{ UI.sys(p?.msg||p?.message||''); });
      socket.on('battle:chat',(p)=>{ UI.chat(p?.msg||p?.message||'', p?.name||'익명'); });
    }
    function connectSocket(){
      if(socket && socket.connected) return;
      socket = io(undefined,{ path:'/socket.io', transports:['websocket','polling'], withCredentials:true });
      attachSocketListeners();
    }
    async function tryAdminAuth(){
      const battleId = $('#battleId')?.value?.trim();
      const token = $('#adminToken')?.value?.trim();
      if(!socket || !socket.connected) return;
      if(!battleId || !token) return;
      socket.emit('adminAuth',{ battleId, token });
    }
    async function ensureAdminToken(battleId){
      const cur=$('#adminToken')?.value?.trim();
      if(cur) return cur;
      try{
        const res = await post(API.links(battleId), {});
        const link = res?.admin || res?.adminUrl || $('#linkAdmin')?.textContent || '';
        if(typeof link==='string' && link){
          const u=new URL(link, location.origin);
          const t = u.searchParams.get('token') || u.searchParams.get('admin') || u.searchParams.get('t');
          if(t){ $('#adminToken').value=t; return t; }
        }
      }catch(e){ UI.admin('관리 토큰 확보 실패(links): '+e.message); }
      return '';
    }

    function setLinks(){
      const base = location.origin.replace(/\/+$/,'');
      const bid  = $('#battleId')?.value?.trim() || '';
      const q    = bid ? ('?battle='+encodeURIComponent(bid)) : '';
      const admin = base + '/admin'     + q;
      const play  = base + '/play'      + q;
      const spec  = base + '/spectator' + q;
      $('#linkAdmin').textContent = admin;
      $('#linkPlayer').textContent = play;
      $('#linkSpectator').textContent = spec;
    }
    function copyText(t){
      if(!t) return UI.admin('복사할 내용이 없습니다');
      navigator.clipboard.writeText(t).then(()=>UI.admin('클립보드 복사 완료'), e=>UI.admin('복사 실패: '+e.message));
    }

    async function createBattle(){
      const mode=$('#selMode')?.value||'2v2';
      try{
        const res = await post(API.create,{mode});
        const id  = res?.id || res?.battle?.id;
        const tok = res?.token || res?.adminToken;
        if(!id) throw new Error('battle id 없음');
        $('#battleId').value=id;
        if(tok) $('#adminToken').value=tok;
        setLinks();
        UI.admin('전투 생성 완료: '+id);
        connectSocket();
        if(tok) tryAdminAuth();
        refreshParticipants();
        UI.sys('초기 상태 준비 완료');
      }catch(e){ UI.admin('전투 생성 실패: '+e.message) }
    }
    async function ctrlBattle(kind){
      const id=$('#battleId')?.value?.trim();
      if(!id) return UI.admin('전투 ID가 비어 있습니다');
      const map={ start:API.start(id), pause:API.pause(id), resume:API.resume(id), end:API.end(id) };
      if(!$('#adminToken').value) { await ensureAdminToken(id); }
      if(socket && socket.connected){
        await tryAdminAuth();
        await new Promise(r=>setTimeout(r,120));
      }
      try{
        await post(map[kind],{});
        UI.admin('전투 '+kind+' 요청 완료');
        if(socket && socket.connected && $('#adminToken').value){
          socket.emit('battle:'+kind, { battleId:id });
          UI.admin('전투 '+kind+' 소켓 송신');
        }
      }catch(e){ UI.admin('전투 '+kind+' 실패: '+e.message) }
    }

    function clamp(n,min,max){ n=Number(n); if(Number.isNaN(n)) n=min; return Math.max(min, Math.min(max, Math.round(n))) }
    async function uploadAvatar(){
      const id=$('#battleId')?.value?.trim(); if(!id) return UI.admin('전투 ID가 비어 있습니다');
      const file=$('#pAvatarFile')?.files?.[0]; if(!file) return UI.admin('업로드할 파일이 없습니다');
      try{
        const fd=new FormData(); fd.append('avatar', file);
        const res=await fetch(API.uploadAvatar(id),{ method:'POST', body:fd });
        const body=await res.json().catch(()=>({}));
        if(!res.ok) throw new Error(body?.message||body?.error||res.statusText);
        if(!body?.url) throw new Error('업로드 응답에 url 없음');
        $('#pAvatarUrl').value = body.url;
        UI.admin('이미지 업로드 완료');
      }catch(e){ UI.admin('이미지 업로드 실패: '+e.message) }
    }
    function buildItemsFromCounts(){
      const heal = clamp($('#pHeal10')?.value, 0, 99);
      const atk  = clamp($('#pAtkBoost')?.value, 0, 99);
      const def  = clamp($('#pDefBoost')?.value, 0, 99);
      const arr=[]; for(let i=0;i<heal;i++) arr.push('heal10'); for(let i=0;i<atk;i++) arr.push('atkBoost'); for(let i=0;i<def;i++) arr.push('defBoost');
      return arr;
    }
    async function addPlayer(){
      const id=$('#battleId')?.value?.trim(); if(!id) return UI.admin('전투 ID가 비어 있습니다');
      const name=$('#pName')?.value?.trim(); if(!name) return UI.admin('이름을 입력하세요');
      const team=$('#pTeam')?.value||'phoenix';
      const stats={
        atk: clamp($('#pATK')?.value, 0, 5),
        def: clamp($('#pDEF')?.value, 0, 5),
        agi: clamp($('#pAGI')?.value, 0, 5),
        luk: clamp($('#pLUK')?.value, 0, 5),
      };
      const items = buildItemsFromCounts();
      const avatar=($('#pAvatarUrl')?.value||'').trim() || undefined;

      try{
        const payload={ name, team, stats, items, ...(avatar?{avatar}:{}) };
        await post(API.addPlayer(id), payload);
        UI.sys('전투 참가자 추가 완료: '+name);
        $('#pName').value='';
        $('#pHeal10').value='0'; $('#pAtkBoost').value='0'; $('#pDefBoost').value='0';
        $('#pAvatarFile').value='';
        refreshParticipants();
      }catch(e){ UI.sys('전투 참가자 추가 실패: '+e.message) }
    }
    async function removeParticipant(pid){
      const id=$('#battleId')?.value?.trim(); if(!id) return UI.sys('전투 ID가 비어 있습니다');
      try{
        const res=await fetch(API.delPlayer(id,pid),{ method:'DELETE' });
        if(!res.ok){
          const body=await res.json().catch(()=>({}));
          throw new Error(body?.message||body?.error||res.statusText);
        }
        UI.sys('전투 참가자 제거 완료: '+pid);
        refreshParticipants();
      }catch(e){ UI.sys('전투 참가자 제거 실패: '+e.message) }
    }
    async function refreshParticipants(){
      const id=$('#battleId')?.value?.trim(); if(!id) return;
      try{
        const snap=await jfetch(API.get(id));
        renderParticipants(snap);
      }catch(e){
        UI.sys('전투 참가자 목록 갱신 실패: '+e.message);
      }
    }
    function renderParticipants(snap){
      const players = Array.isArray(snap?.players) ? snap.players : [];
      const phoenix = players.filter(p=>p.team==='phoenix');
      const eaters  = players.filter(p=>p.team==='eaters');

      UI.setText('#cntPhoenix', String(phoenix.length)+'명');
      UI.setText('#cntEaters',  String(eaters.length)+'명');

      const lp=$('#listPhoenix'); const le=$('#listEaters');
      if(lp) lp.innerHTML=''; if(le) le.innerHTML='';

      function nodeFor(p){
        const wrap=document.createElement('div'); wrap.className='participant';
        const img=document.createElement('img'); img.className='avatar'; img.src=p.avatar||''; img.alt=p.name||'image'; if(!p.avatar) img.style.opacity='0.35';
        const body=document.createElement('div');
        const nm=document.createElement('div'); nm.className='p-name'; nm.textContent=p.name||'(이름없음)';
        const st=document.createElement('div'); st.className='p-stat';
        const s=p.stats||{};
        const itemStr=(Array.isArray(p.items)&&p.items.length)?` · 아이템 ${p.items.join(', ')}`:'';
        st.textContent=`공격력 ${s.atk??0} / 방어력 ${s.def??0} / 민첩 ${s.agi??0} / 행운 ${s.luk??0}${itemStr}`;
        const actions=document.createElement('div'); actions.className='p-actions';
        const btnDel=document.createElement('button'); btnDel.className='btn'; btnDel.textContent='제거';
        btnDel.addEventListener('click',()=>removeParticipant(p.id));
        body.appendChild(nm); body.appendChild(st);
        wrap.appendChild(img); wrap.appendChild(body); wrap.appendChild(actions);
        actions.appendChild(btnDel);
        return wrap;
      }
      phoenix.forEach(p=>lp && lp.appendChild(nodeFor(p)));
      eaters.forEach(p=>le && le.appendChild(nodeFor(p)));
    }

    async function issueSpec(){
      const id=$('#battleId')?.value?.trim(); if(!id) return UI.admin('전투 ID가 비어 있습니다');
      try{
        const r=await post(API.otp(id),{role:'spectator'});
        $('#otpResult').textContent=JSON.stringify(r,null,2);
        UI.admin('관전자 비밀번호 발급 완료');
      }catch(e1){
        try{
          const r2=await post('/api/admin/otp',{role:'spectator',battleId:id});
          $('#otpResult').textContent=JSON.stringify(r2,null,2);
          UI.admin('관전자 비밀번호 발급 완료(폴백)');
        }catch(e2){ UI.admin('관전자 비밀번호 발급 실패: '+e2.message) }
      }
    }
    async function issuePlayer(){
      const id=$('#battleId')?.value?.trim(); if(!id) return UI.admin('전투 ID가 비어 있습니다');
      const count=Math.max(1,Math.min(100, Number($('#optOtpCount')?.value||1)));
      try{
        const r=await post(API.otp(id),{role:'player',count});
        $('#otpResult').textContent=JSON.stringify(r,null,2);
        UI.admin('전투 참가자 비밀번호 발급 완료');
      }catch(e1){
        try{
          const r2=await post('/api/admin/otp',{role:'player',count,battleId:id});
          $('#otpResult').textContent=JSON.stringify(r2,null,2);
          UI.admin('전투 참가자 비밀번호 발급 완료(폴백)');
        }catch(e2){ UI.admin('전투 참가자 비밀번호 발급 실패: '+e2.message) }
      }
    }

    function sendChat(){
      const msg = $('#chatInput')?.value?.trim();
      const battleId = $('#battleId')?.value?.trim();
      if (!msg) return;
      if (!socket || !socket.connected) { UI.chat('(오프라인) '+msg, '관리자'); return; }
      if (!battleId) { UI.chat('(전투 ID 없음) '+msg, '관리자'); return; }
      try{
        socket.emit('chat:send', { battleId, msg, name: '관리자' });
        $('#chatInput').value='';
      }catch(e){ UI.admin('채팅 전송 실패: '+(e?.message||e)); }
    }

    function wire(){
      $('#btnCreate')   ?.addEventListener('click', createBattle);
      $('#btnStart')    ?.addEventListener('click', ()=>ctrlBattle('start'));
      $('#btnPause')    ?.addEventListener('click', ()=>ctrlBattle('pause'));
      $('#btnResume')   ?.addEventListener('click', ()=>ctrlBattle('resume'));
      $('#btnEnd')      ?.addEventListener('click', ()=>ctrlBattle('end'));

      $('#btnOtpSpec')  ?.addEventListener('click', issueSpec);
      $('#btnOtpPlayer')?.addEventListener('click', issuePlayer);

      $('#battleId')    ?.addEventListener('input', setLinks);

      $('#copyAdmin')   ?.addEventListener('click', ()=>copyText($('#linkAdmin')?.textContent||''));
      $('#copyPlayer')  ?.addEventListener('click', ()=>copyText($('#linkPlayer')?.textContent||''));
      $('#copySpec')    ?.addEventListener('click', ()=>copyText($('#linkSpectator')?.textContent||''));

      $('#btnUploadAvatar')?.addEventListener('click', uploadAvatar);
      $('#btnAddPlayer')   ?.addEventListener('click', addPlayer);

      $('#btnSendChat')?.addEventListener('click', sendChat);
      $('#chatInput')  ?.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendChat(); });
    }

    (function init(){
      UI.init();
      const qb=qp.get('battle'); if(qb) $('#battleId').value=qb;
      const qt=qp.get('token')||qp.get('admin')||qp.get('t'); if(qt) $('#adminToken').value=qt;

      setLinks();
      wire();
      connectSocket();

      if($('#adminToken').value) tryAdminAuth();
      if(!$('#adminToken').value && $('#battleId').value) {
        ensureAdminToken($('#battleId').value).then(t=>{ if(t) tryAdminAuth() });
      }
      refreshParticipants();

      UI.admin('관리자 콘솔 로드 완료');
    })();
  })();
  </script>
</body>
</html>
