<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PYXIS Battle System - 관리자</title>

  <!-- Fonts & Theme -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="/assets/css/pyxis-theme.css"/>

  <style>
    /* ===== 기본 ===== */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{font-family:'Cinzel',serif;background:var(--deep-navy);color:var(--text);line-height:1.55;letter-spacing:.01em;overflow-x:hidden;font-size:14px}
    .container{max-width:1400px;margin:0 auto;padding:0 16px}

    /* ===== 헤더 ===== */
    .header{background:var(--glass-2);backdrop-filter:var(--blur-light);border-bottom:1px solid var(--border-light);padding:14px 0;position:sticky;top:0;z-index:10;box-shadow:var(--shadow-soft)}
    .title{ text-align:center }
    .title-main{ font-size:22px;font-weight:800;letter-spacing:2px;background:linear-gradient(135deg,var(--gold),var(--gold-bright));-webkit-background-clip:text;-webkit-text-fill-color:transparent }
    .title-sub{ font-size:11px;color:var(--text-muted);margin-left:6px;letter-spacing:.8px;text-transform:uppercase }

    /* ===== 레이아웃 ===== */
    .admin-grid{display:grid;grid-template-columns:360px 1fr 360px;gap:16px;padding:16px 0;align-items:start;min-height:calc(100vh - 80px)}
    @media(max-width:1200px){.admin-grid{grid-template-columns:1fr}}
    .section{background:var(--glass-2);backdrop-filter:var(--blur-light);border:1px solid var(--border-light);border-radius:10px;padding:16px;box-shadow:var(--shadow-soft)}
    .section h3{font-size:14px;font-weight:700;color:var(--gold-bright);text-align:center;margin-bottom:12px;letter-spacing:.8px}

    /* ===== 전투 정보 & 버튼 ===== */
    .battle-info{background:var(--glass-1);border:1px solid var(--border-light);border-radius:10px;padding:12px;text-align:center;margin-bottom:12px}
    .battle-id{font-size:16px;font-weight:800;color:var(--gold-bright);margin-bottom:6px}
    .battle-status{display:inline-block;padding:4px 10px;border-radius:14px;font-size:11px;font-weight:700;text-transform:uppercase}
    .status-waiting{background:var(--warning-light);color:var(--warning)}
    .status-active{background:var(--success-light);color:var(--success)}
    .status-ended{background:var(--danger-light);color:var(--danger)}

    .form-group{margin-bottom:12px}
    .form-group label{display:block;font-size:12px;font-weight:600;color:var(--text-accent);margin-bottom:6px;text-transform:uppercase}
    .form-group input,.form-group select{width:100%;background:var(--glass-1);border:1px solid var(--border-light);border-radius:8px;padding:8px 10px;color:var(--text);font-size:13px}
    .form-group input:focus,.form-group select:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 2px rgba(212,183,126,.18)}

    .control-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
    .btn{background:linear-gradient(135deg,var(--gold),var(--gold-bright));color:var(--deep-navy);border:none;border-radius:8px;padding:9px 12px;font-weight:700;cursor:pointer;box-shadow:var(--shadow-soft);text-transform:uppercase;font-size:12px}
    .btn:disabled{background:var(--glass-1);color:var(--text-muted);cursor:not-allowed}
    .btn.success{background:linear-gradient(135deg,var(--success),#1e8449);color:#fff}
    .btn.danger{background:linear-gradient(135deg,var(--danger),#a93226);color:#fff}
    .btn.info{background:linear-gradient(135deg,var(--info),#1f618d);color:#fff}

    /* ===== 참가자 관리 ===== */
    .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:6px}
    .stat-input{text-align:center;font-weight:700}
    .stat-total{text-align:center;font-size:12px;color:var(--text-muted)}

    .items-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
    .item-input{text-align:center;font-weight:600}

    .roster-section{margin-top:12px}
    .team-roster{background:var(--glass-1);border:1px solid var(--border-light);border-radius:10px;padding:12px;margin-bottom:12px}
    .team-title{text-align:center;font-weight:700;color:var(--gold-bright);margin-bottom:8px;font-size:13px}
    .player-list{display:flex;flex-direction:column;gap:8px}
    .player-item{display:flex;gap:10px;align-items:center;background:var(--glass-2);border:1px solid var(--border-subtle);border-radius:8px;padding:10px}
    .player-avatar{width:40px;height:40px;object-fit:cover;border-radius:50%;border:2px solid var(--gold)}
    .player-name{font-weight:700}
    .player-stats{font-size:11px;color:var(--text-muted)}
    .player-items{font-size:11px;color:var(--text-accent)}
    .player-status{padding:3px 8px;border-radius:12px;font-size:10px;font-weight:700;text-transform:uppercase}
    .status-ready{background:var(--success-light);color:var(--success)}
    .status-waiting{background:var(--warning-light);color:var(--warning)}
    .status-offline{background:var(--danger-light);color:var(--danger)}
    .empty-state{text-align:center;color:var(--text-muted);padding:12px;font-size:12px}

    /* ===== 로그 & 채팅 ===== */
    .log-chat-container{display:flex;flex-direction:column;gap:12px}
    .log-title,.chat-title{font-size:12px;color:var(--gold-bright);text-align:center;margin-bottom:6px;font-weight:700}
    .log-container,.chat-container{background:var(--glass-1);border:1px solid var(--border-light);border-radius:8px;height:300px;overflow-y:auto;padding:10px;font-size:12px}
    .log-entry{margin-bottom:6px;padding:7px 10px;border-left:3px solid var(--border-subtle);background:var(--glass-2);border-radius:6px}
    .log-entry.system{border-left-color:var(--gold)}
    .log-entry.battle{border-left-color:var(--info)}
    .chat-message{margin-bottom:6px;padding:7px 10px;background:rgba(39,174,96,.08);border-left:3px solid var(--success);border-radius:6px}
    .chat-message .sender{font-weight:700;color:var(--gold-bright)}
    .chat-message .timestamp{font-size:10px;color:var(--text-muted);margin-left:6px}

    /* ===== 채팅 입력창 & 버튼 (복구) ===== */
    .chat-input-container{display:flex;gap:8px;margin-top:8px}
    .chat-input{flex:1;background:var(--glass-1);border:1px solid var(--border-light);border-radius:8px;padding:8px 10px;color:var(--text);font-size:13px}
    .chat-send{background:linear-gradient(135deg,var(--success),#27ae60);color:#fff;border:none;border-radius:8px;padding:8px 12px;font-weight:700;cursor:pointer;min-width:72px;font-size:12px}

    /* ===== 링크 섹션 ===== */
    .link-section{background:var(--glass-1);border:1px solid var(--border-light);border-radius:10px;padding:12px;margin-top:10px}
    .link-item{margin-bottom:10px;padding:8px;background:var(--glass-2);border:1px solid var(--border-subtle);border-radius:6px}
    .link-label{font-size:11px;color:var(--text-accent);font-weight:700;margin-bottom:4px}
    .link-url{font-size:10px;color:var(--text-muted);font-family:monospace;word-break:break-all;background:var(--navy-surface);padding:6px 8px;border-radius:4px;cursor:pointer}

    /* ===== 토스트 ===== */
    .toast{position:fixed;top:16px;right:16px;background:var(--glass-2);border:1px solid var(--border-light);border-radius:10px;padding:10px 12px;color:var(--text);box-shadow:var(--shadow-medium);z-index:1000;transform:translateX(320px);transition:transform .22s;font-size:12px}
    .toast.show{transform:translateX(0)}
    .toast.success{border-left:4px solid var(--success)}
    .toast.error{border-left:4px solid var(--danger)}
    .toast.info{border-left:4px solid var(--info)}
  </style>
</head>
<body>
  <!-- 헤더 -->
  <header class="header">
    <div class="container">
      <h1 class="title">
        <span class="title-main">PYXIS</span>
        <span class="title-sub">관리자 콘솔</span>
      </h1>
    </div>
  </header>

  <!-- 메인 -->
  <main class="container">
    <div class="admin-grid">
      <!-- 왼쪽: 전투 제어 -->
      <section class="section">
        <h3>전투 제어</h3>

        <div class="battle-info">
          <div id="battleId" class="battle-id">대기 중</div>
          <div id="battleStatus" class="battle-status status-waiting">대기</div>
        </div>

        <div class="form-group">
          <label>전투 모드</label>
          <select id="battleMode">
            <option value="1v1">1대1</option>
            <option value="2v2">2대2</option>
            <option value="3v3">3대3</option>
            <option value="4v4">4대4</option>
          </select>
        </div>

        <button id="btnCreateBattle" class="btn">전투 생성</button>
        <div class="control-grid">
          <button id="btnStartBattle" class="btn success" disabled>전투 시작</button>
          <button id="btnEndBattle" class="btn danger" disabled>전투 종료</button>
        </div>

        <button id="btnGenerateLinks" class="btn info" disabled>링크 생성</button>

        <div id="linkSection" class="link-section" style="display:none;">
          <h4 class="team-title" style="margin:0 0 8px;">생성된 링크</h4>
          <div id="playerLinks"></div>
          <div id="spectatorLink"></div>
        </div>

        <div class="roster-section" style="margin-top:10px">
          <div class="team-roster">
            <div class="team-title">통계</div>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
              <div class="team-roster" style="padding:10px">
                <div id="statPlayers" class="battle-id" style="font-size:16px">0</div>
                <div class="stat-total">접속 전투 참가자</div>
              </div>
              <div class="team-roster" style="padding:10px">
                <div id="statSpectators" class="battle-id" style="font-size:16px">0</div>
                <div class="stat-total">관전자</div>
              </div>
              <div class="team-roster" style="padding:10px">
                <div id="statTurn" class="battle-id" style="font-size:16px">0</div>
                <div class="stat-total">현재 턴</div>
              </div>
              <div class="team-roster" style="padding:10px">
                <div id="statUptime" class="battle-id" style="font-size:16px">0:00</div>
                <div class="stat-total">진행 시간</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- 중앙: 전투 참가자 관리 -->
      <section class="section">
        <h3>전투 참가자 관리</h3>

        <div class="form-group">
          <label>전투 참가자 이름</label>
          <input id="playerName" type="text" placeholder="전투 참가자 이름 (최대 20글자)" maxlength="20"/>
        </div>

        <div class="form-group">
          <label>팀 선택</label>
          <select id="playerTeam">
            <option value="phoenix">A팀</option>
            <option value="death">B팀</option>
          </select>
        </div>

        <div class="form-group">
          <label>스탯 배분 (각 1-5)</label>
          <div class="stats-grid">
            <input id="statAttack"  type="number" class="stat-input" min="1" max="5" value="3" placeholder="공격"/>
            <input id="statDefense" type="number" class="stat-input" min="1" max="5" value="3" placeholder="방어"/>
            <input id="statAgility" type="number" class="stat-input" min="1" max="5" value="3" placeholder="민첩"/>
            <input id="statLuck"   type="number" class="stat-input" min="1" max="5" value="3" placeholder="행운"/>
          </div>
          <div id="statTotal" class="stat-total">총합: 12 (참고값)</div>
        </div>

        <div class="form-group">
          <label>시작 아이템</label>
          <div class="items-grid">
            <input id="itemDittany" type="number" class="item-input" min="0" max="5" value="1" placeholder="디터니" title="체력 10 회복"/>
            <input id="itemAttack"  type="number" class="item-input" min="0" max="5" value="1" placeholder="공격 보정기" title="공격력 1.5배 (성공률 10%)"/>
            <input id="itemDefense" type="number" class="item-input" min="0" max="5" value="1" placeholder="방어 보정기" title="방어력 1.5배 (성공률 10%)"/>
          </div>
        </div>

        <div class="form-group">
          <label>아바타 이미지 (최대 5MB)</label>
          <input id="playerAvatar" type="file" accept="image/*"/>
        </div>

        <button id="btnAddPlayer" class="btn">전투 참가자 추가</button>

        <!-- 팀 로스터 -->
        <div class="roster-section">
          <div class="team-roster team-phoenix">
            <div class="team-title">A팀</div>
            <div id="phoenixTeam" class="player-list">
              <div class="empty-state">팀원이 없습니다</div>
            </div>
          </div>

          <div class="team-roster team-death">
            <div class="team-title">B팀</div>
            <div id="deathTeam" class="player-list">
              <div class="empty-state">팀원이 없습니다</div>
            </div>
          </div>
        </div>
      </section>

      <!-- 오른쪽: 로그 & 채팅 -->
      <section class="section">
        <h3>실시간 모니터링</h3>

        <div class="log-chat-container">
          <div class="log-section">
            <div class="log-title">전투 로그</div>
            <div id="battleLog" class="log-container">
              <div class="log-entry system">PYXIS 관리자 콘솔이 시작되었습니다.</div>
              <div class="log-entry system">전투 룰: 스탯 각 1-5, 체력 최대 100, 5분 턴 제한</div>
            </div>
          </div>

          <div class="chat-section">
            <div class="chat-title">실시간 채팅</div>
            <div id="chatContainer" class="chat-container">
              <div class="chat-message">
                <span class="sender">시스템</span>
                <span class="timestamp">[시스템]</span>
                <div>채팅을 시작하세요!</div>
              </div>
            </div>

            <!-- 채팅 입력창 + 버튼 (복구됨) -->
            <div class="chat-input-container">
              <input id="chatInput" class="chat-input" type="text" placeholder="관리자 메시지 입력..." maxlength="200"/>
              <button id="btnSendChat" class="chat-send">전송</button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- 토스트 -->
  <div id="toast" class="toast"></div>

  <!-- Socket.IO -->
  <script src="https://pyxisbattlesystem.monster/socket.io/socket.io.js"></script>

  <script>
    // 전역 설정
    window.PYXIS_SERVER_URL = "https://pyxisbattlesystem.monster";

    // 내부 코드를 위해 팀 라벨 헬퍼
    function teamLabel(teamValue){
      return teamValue === 'phoenix' ? 'A팀' : 'B팀';
    }

    // URL 파라미터 파서
    function getParams(){
      const p = new URLSearchParams(location.search);
      return {
        battle: p.get('battle') || p.get('id') || null,
        password: p.get('password') || p.get('token') || null
      };
    }

    class PyxisAdminConsole {
      constructor() {
        this.socket = null;
        this.battleData = null;
        this.isConnected = false;
        this.currentBattleId = null;
        this.uptimeInterval = null;
        this.startTime = null;

        this.initElements();
        this.initEventListeners();
        this.connectSocket();
        this.showToast('시스템이 초기화되었습니다.', 'info');
      }

      /* ===== 요소 바인딩 ===== */
      initElements() {
        // 전투 제어
        this.battleIdEl = document.getElementById('battleId');
        this.battleStatusEl = document.getElementById('battleStatus');
        this.battleModeEl = document.getElementById('battleMode');
        this.btnCreateBattle = document.getElementById('btnCreateBattle');
        this.btnStartBattle = document.getElementById('btnStartBattle');
        this.btnEndBattle = document.getElementById('btnEndBattle');
        this.btnGenerateLinks = document.getElementById('btnGenerateLinks');
        this.linkSection = document.getElementById('linkSection');
        this.playerLinks = document.getElementById('playerLinks');
        this.spectatorLink = document.getElementById('spectatorLink');

        // 참가자 관리
        this.playerNameEl = document.getElementById('playerName');
        this.playerTeamEl = document.getElementById('playerTeam');
        this.statAttackEl = document.getElementById('statAttack');
        this.statDefenseEl = document.getElementById('statDefense');
        this.statAgilityEl = document.getElementById('statAgility');
        this.statLuckEl   = document.getElementById('statLuck');
        this.statTotalEl  = document.getElementById('statTotal');
        this.itemDittanyEl= document.getElementById('itemDittany');
        this.itemAttackEl = document.getElementById('itemAttack');
        this.itemDefenseEl= document.getElementById('itemDefense');
        this.playerAvatarEl = document.getElementById('playerAvatar');
        this.btnAddPlayer  = document.getElementById('btnAddPlayer');
        this.phoenixTeamEl = document.getElementById('phoenixTeam');
        this.deathTeamEl   = document.getElementById('deathTeam');

        // 통계
        this.statPlayersEl = document.getElementById('statPlayers');
        this.statSpectatorsEl = document.getElementById('statSpectators');
        this.statTurnEl = document.getElementById('statTurn');
        this.statUptimeEl = document.getElementById('statUptime');

        // 로그 & 채팅
        this.battleLogEl = document.getElementById('battleLog');
        this.chatContainerEl = document.getElementById('chatContainer');
        this.chatInputEl = document.getElementById('chatInput');
        this.btnSendChatEl = document.getElementById('btnSendChat');

        // 토스트
        this.toastEl = document.getElementById('toast');
      }

      /* ===== 이벤트 ===== */
      initEventListeners() {
        // 전투 제어
        this.btnCreateBattle.addEventListener('click', () => this.createBattle());
        this.btnStartBattle.addEventListener('click', () => this.startBattle());
        this.btnEndBattle.addEventListener('click', () => this.endBattle());
        this.btnGenerateLinks.addEventListener('click', () => this.requestLinks());

        // 참가자 추가
        this.btnAddPlayer.addEventListener('click', () => this.addPlayer());

        // 스탯 입력 보정 + 총합 표시
        [this.statAttackEl, this.statDefenseEl, this.statAgilityEl, this.statLuckEl].forEach(el => {
          el.addEventListener('input', (e) => {
            const v = parseInt(e.target.value || '0', 10);
            if (v < 1) e.target.value = 1;
            if (v > 5) e.target.value = 5;
            this.updateStatTotal();
          });
        });

        // 아이템 수량 제한
        [this.itemDittanyEl, this.itemAttackEl, this.itemDefenseEl].forEach(el => {
          el.addEventListener('input', (e) => {
            const v = parseInt(e.target.value || '0', 10);
            if (v < 0) e.target.value = 0;
            if (v > 5) e.target.value = 5;
          });
        });

        // 아바타 업로드 검증
        this.playerAvatarEl.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (!file) return;
          if (file.size > 5 * 1024 * 1024) {
            this.showToast('파일 크기는 5MB 이하여야 합니다.', 'error');
            e.target.value = '';
          } else if (!file.type.startsWith('image/')) {
            this.showToast('이미지 파일만 업로드 가능합니다.', 'error');
            e.target.value = '';
          }
        });

        // 채팅 전송 버튼
        this.btnSendChatEl.addEventListener('click', () => this.sendChat());

        // Enter로 전송 / Shift+Enter는 줄바꿈
        this.chatInputEl.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            this.sendChat();
          }
        });

        // 단축키: Ctrl+Enter 도 전송
        document.addEventListener('keydown', (e) => {
          if (e.ctrlKey && e.key === 'Enter') this.sendChat();
        });
      }

      /* ===== 소켓 연결 & 인증 ===== */
      connectSocket() {
        this.addLog('system', '서버 연결 중...');

        this.socket = io(window.PYXIS_SERVER_URL, {
          transports: ['websocket','polling'],
          timeout: 20000
        });

        this.socket.on('connect', () => {
          this.isConnected = true;
          this.addLog('system', '서버에 연결되었습니다.');
          this.showToast('서버 연결 성공', 'success');

          // URL 파라미터 기반 관리자 인증 (비밀번호/토큰)
          const { battle, password } = getParams();
          if (battle && password) {
            this.addLog('system', '관리자 인증 요청 중...');
            this.socket.emit('adminAuth', { battleId: battle, password }); // 표준 이벤트명
          }
        });

        // 인증 성공/실패 양식 모두 대응
        const onAuthSuccess = (data) => {
          this.battleData = data.battle;
          this.currentBattleId = data.battle.id;
          this.updateUI();
          this.addLog('system', `전투 ID ${data.battle.id}로 인증되었습니다.`);
        };
        const onAuthError = (err) => {
          this.addLog('system', `인증 실패: ${err.message || err}`);
          this.showToast(`인증 실패: ${err.message || err}`, 'error');
        };
        this.socket.on('authSuccess', onAuthSuccess);
        this.socket.on('auth:success', onAuthSuccess);
        this.socket.on('authError', onAuthError);
        this.socket.on('auth:error', onAuthError);

        // 전투 라이프사이클
        this.socket.on('battle:created', (data) => {
          this.currentBattleId = data.battleId;
          this.battleIdEl.textContent = data.battleId;
          this.updateButtons();
          this.addLog('system', `전투 ID ${data.battleId}가 생성되었습니다.`);
          this.showToast('전투가 생성되었습니다!', 'success');
        });

        this.socket.on('admin:update', (data) => {
          this.battleData = data.battle;
          this.updateUI();
          if (data.statistics) this.updateStatistics(data.statistics);
        });

        this.socket.on('player:added', (data) => {
          this.addLog('system', `전투 참가자 추가: ${data.player.name} (${teamLabel(data.player.team)})`);
          this.showToast(`${data.player.name}이 추가되었습니다!`, 'success');
          this.clearPlayerForm();
        });

        this.socket.on('player:error', (err) => {
          this.showToast(`오류: ${err.message}`, 'error');
        });

        this.socket.on('battle:started', (data) => {
          this.addLog('system', `전투가 시작되었습니다. 선공: ${teamLabel(data.firstTeam)}`);
          this.showToast('전투 시작!', 'success');
          this.startUptime();
        });

        this.socket.on('battle:ended', (data) => {
          const winnerText = data.winner ? `${teamLabel(data.winner)} 승리` : '무승부';
          this.addLog('system', `전투가 종료되었습니다. ${winnerText}`);
          this.showToast(`전투 종료: ${winnerText}`, 'info');
          this.stopUptime();
        });

        // 링크 응답 (서버 표준)
        this.socket.on('admin:links', (payload) => {
          this.renderLinksPayload(payload);
        });

        // 로그/채팅/기타
        this.socket.on('battle:log', (entry) => this.addLog(entry.type || 'battle', entry.message));
        this.socket.on('chat:message', (msg) => this.addChatMessage(msg));

        this.socket.on('player:connected',   d => this.addLog('system', `${d.playerName} 접속`));
        this.socket.on('player:disconnected',d => this.addLog('system', `${d.playerName} 연결 종료`));
        this.socket.on('player:ready_update',d => this.addLog('system', `${d.playerName}: ${d.isReady ? '준비 완료' : '준비 취소'}`));
        this.socket.on('battle:all_ready',   () => { this.addLog('system','모든 전투 참가자가 준비 완료되었습니다.'); this.showToast('모든 참가자 준비 완료', 'success'); });
        this.socket.on('turn:start',         d => this.addLog('system', `${d.playerName}의 턴 시작 (턴 ${d.turnNumber})`));
        this.socket.on('turn:end',           () => this.addLog('system', '턴 종료'));
        this.socket.on('spectator:count_update', d => this.statSpectatorsEl.textContent = d.count || 0);

        this.socket.on('disconnect', (reason) => {
          this.isConnected = false;
          this.addLog('system', '서버 연결이 끊어졌습니다. 재연결 중...');
          this.showToast('연결 끊어짐. 재연결 중...', 'error');
        });

        this.socket.on('reconnect', () => {
          this.addLog('system', '서버 재연결 성공');
          this.showToast('재연결 성공', 'success');
        });

        this.socket.on('connect_error', (err) => {
          this.addLog('system', `연결 오류: ${err.message}`);
          this.showToast('연결 실패', 'error');
        });

        // 네트워크 상태 토스트
        window.addEventListener('online',  () => this.showToast('인터넷 연결이 복구되었습니다.', 'success'));
        window.addEventListener('offline', () => this.showToast('인터넷 연결이 끊어졌습니다.', 'error'));
      }

      /* ===== 전투 제어 메소드 ===== */
      createBattle() {
        if (!this.socket || !this.isConnected) return this.showToast('서버에 연결되지 않았습니다.', 'error');
        const mode = this.battleModeEl.value;
        this.addLog('system', `${mode} 전투 생성 중...`);
        this.socket.emit('admin:create_battle', { mode });
      }

      startBattle() {
        if (!this.socket || !this.isConnected || !this.currentBattleId) return this.showToast('전투를 시작할 수 없습니다.', 'error');
        if (confirm('전투를 시작하시겠습니까?\n\n• 모든 전투 참가자가 준비 완료 상태여야 합니다\n• 시작 후에는 참가자 추가가 불가능합니다')) {
          this.addLog('system', '전투 시작 요청 중...');
          this.socket.emit('admin:start_battle', { battleId: this.currentBattleId });
        }
      }

      endBattle() {
        if (!this.socket || !this.isConnected || !this.currentBattleId) return this.showToast('전투를 종료할 수 없습니다.', 'error');
        if (confirm('전투를 강제로 종료하시겠습니까?\n\n진행 중인 모든 액션이 중단됩니다.')) {
          this.addLog('system', '전투 종료 요청 중...');
          this.socket.emit('admin:end_battle', { battleId: this.currentBattleId });
        }
      }

      /* ===== 참가자 ===== */
      addPlayer() {
        if (!this.socket || !this.isConnected || !this.currentBattleId) return this.showToast('전투 참가자를 추가할 수 없습니다.', 'error');

        const name = (this.playerNameEl.value || '').trim();
        if (!name) { this.showToast('전투 참가자 이름을 입력하세요.', 'error'); this.playerNameEl.focus(); return; }
        if (name.length > 20) return this.showToast('이름은 최대 20글자까지 가능합니다.', 'error');

        const stats = {
          attack:  this.clampInt(this.statAttackEl.value, 1, 5, 3),
          defense: this.clampInt(this.statDefenseEl.value,1, 5, 3),
          agility: this.clampInt(this.statAgilityEl.value,1, 5, 3),
          luck:    this.clampInt(this.statLuckEl.value,   1, 5, 3)
        };

        const items = {
          dittany:        this.clampInt(this.itemDittanyEl.value,0,5,1),
          attack_booster: this.clampInt(this.itemAttackEl.value, 0,5,1),
          defense_booster:this.clampInt(this.itemDefenseEl.value,0,5,1)
        };

        const playerData = {
          name,
          team: this.playerTeamEl.value, // 내부 값은 유지, 표시는 A/B팀
          stats,
          items,
          hp: 100,
          maxHp: 100
        };

        const avatarFile = this.playerAvatarEl.files[0];
        if (avatarFile) {
          this.uploadAvatar(avatarFile, playerData);
        } else {
          this.socket.emit('admin:add_player', playerData);
        }
      }

      uploadAvatar(file, playerData) {
        const formData = new FormData();
        formData.append('avatar', file);

        this.addLog('system', '아바타 업로드 중...');

        // 표준 업로드 경로
        fetch('/api/upload', { method: 'POST', body: formData })
          .then(r => r.json())
          .then(data => {
            if (data.ok) {
              playerData.avatar = data.url;
              this.socket.emit('admin:add_player', playerData);
              this.addLog('system', '아바타 업로드 완료');
            } else {
              this.showToast(`아바타 업로드 실패: ${data.error}`, 'error');
            }
          })
          .catch(err => {
            console.error('아바타 업로드 에러:', err);
            this.showToast('아바타 업로드 중 오류가 발생했습니다.', 'error');
          });
      }

      /* ===== 링크 생성 ===== */
      requestLinks() {
        if (!this.socket || !this.isConnected || !this.currentBattleId) {
          this.showToast('전투가 생성되지 않았습니다.', 'error');
          return;
        }
        // 서버 표준 이벤트로 요청
        this.addLog('system', '링크 생성 요청 중...');
        this.socket.emit('admin:generate_links', { battleId: this.currentBattleId });
      }

      renderLinksPayload(payload){
        const baseUrl = window.location.origin;

        // 참가자 링크
        this.playerLinks.innerHTML = '';
        if (payload && Array.isArray(payload.players)) {
          payload.players.forEach(p => {
            const url = p.url || `${baseUrl}/player?battle=${this.currentBattleId}&name=${encodeURIComponent(p.name)}&token=${encodeURIComponent(p.token||'')}`;
            const el = document.createElement('div');
            el.className = 'link-item';
            el.innerHTML = `
              <div class="link-label">${p.name} (${teamLabel(p.team)})</div>
              <div class="link-url" title="클릭하여 복사">${url}</div>
            `;
            el.querySelector('.link-url').addEventListener('click', () => {
              navigator.clipboard.writeText(url).then(()=>this.showToast('링크가 복사되었습니다.', 'success'));
            });
            this.playerLinks.appendChild(el);
          });
        } else if (this.battleData && Array.isArray(this.battleData.players)) {
          // 플랜 B: 로컬 조합
          this.battleData.players.forEach(player => {
            const playerUrl = `${baseUrl}/player?battle=${this.battleData.id}&name=${encodeURIComponent(player.name)}&token=${encodeURIComponent(player.token||'')}`;
            const linkItem = document.createElement('div');
            linkItem.className = 'link-item';
            linkItem.innerHTML = `
              <div class="link-label">${player.name} (${teamLabel(player.team)})</div>
              <div class="link-url" title="클릭하여 복사">${playerUrl}</div>
            `;
            linkItem.querySelector('.link-url').addEventListener('click', () => {
              navigator.clipboard.writeText(playerUrl).then(() => this.showToast('링크가 복사되었습니다.', 'success'));
            });
            this.playerLinks.appendChild(linkItem);
          });
        }

        // 관전자 링크
        const specUrl =
          (payload && payload.spectatorUrl)
            ? payload.spectatorUrl
            : (() => {
                const token = payload && payload.spectatorToken ? `&token=${encodeURIComponent(payload.spectatorToken)}` : '';
                return `${baseUrl}/spectator?battle=${this.currentBattleId}${token}`;
              })();

        this.spectatorLink.innerHTML = `
          <div class="link-item">
            <div class="link-label">관전자 링크 (최대 30명 / 30분 제한)</div>
            <div class="link-url" title="클릭하여 복사">${specUrl}</div>
          </div>
        `;
        this.spectatorLink.querySelector('.link-url').addEventListener('click', () => {
          navigator.clipboard.writeText(specUrl).then(() => this.showToast('관전자 링크가 복사되었습니다.', 'success'));
        });

        this.linkSection.style.display = 'block';
        this.addLog('system', '접속 링크가 생성되었습니다. 클릭하여 복사하세요.');
        this.showToast('링크 생성 완료', 'success');
      }

      /* ===== 채팅 ===== */
      sendChat() {
        const message = (this.chatInputEl.value || '').trim();
        if (!message || !this.socket || !this.isConnected) return;
        if (message.length > 200) {
          this.showToast('메시지는 최대 200글자까지 입력 가능합니다.', 'error');
          return;
        }
        this.socket.emit('admin:chat', { message });
        this.chatInputEl.value = '';
        this.chatInputEl.focus();
      }

      addChatMessage(data) {
        const div = document.createElement('div');
        div.className = 'chat-message';
        const timestamp = new Date().toLocaleTimeString();
        const senderName = data.senderName || '익명';
        const message = data.message || '';
        div.innerHTML = `
          <span class="sender">${senderName}</span>
          <span class="timestamp">[${timestamp}]</span>
          <div>${message}</div>
        `;
        this.chatContainerEl.appendChild(div);
        this.chatContainerEl.scrollTop = this.chatContainerEl.scrollHeight;
        if (this.chatContainerEl.children.length > 80) {
          this.chatContainerEl.removeChild(this.chatContainerEl.firstChild);
        }
      }

      /* ===== UI ===== */
      updateStatTotal() {
        const total = (parseInt(this.statAttackEl.value||0,10) +
                       parseInt(this.statDefenseEl.value||0,10) +
                       parseInt(this.statAgilityEl.value||0,10) +
                       parseInt(this.statLuckEl.value||0,10));
        this.statTotalEl.textContent = `총합: ${total} (참고값)`;
      }

      updateUI() {
        if (!this.battleData) return;
        this.battleIdEl.textContent = this.battleData.id;
        this.battleStatusEl.textContent = this.getStatusText(this.battleData.status);
        this.battleStatusEl.className = `battle-status status-${this.battleData.status}`;
        this.updateTeamRoster();
        this.updateButtons();
      }

      updateTeamRoster() {
        if (!this.battleData) return;

        const phoenixPlayers = this.battleData.players.filter(p => p.team === 'phoenix');
        const deathPlayers   = this.battleData.players.filter(p => p.team === 'death');

        // A팀
        this.phoenixTeamEl.innerHTML = '';
        if (phoenixPlayers.length === 0) {
          this.phoenixTeamEl.innerHTML = '<div class="empty-state">팀원이 없습니다</div>';
        } else {
          phoenixPlayers.forEach(player => this.phoenixTeamEl.appendChild(this.createPlayerItem(player)));
        }

        // B팀
        this.deathTeamEl.innerHTML = '';
        if (deathPlayers.length === 0) {
          this.deathTeamEl.innerHTML = '<div class="empty-state">팀원이 없습니다</div>';
        } else {
          deathPlayers.forEach(player => this.deathTeamEl.appendChild(this.createPlayerItem(player)));
        }
      }

      createPlayerItem(player) {
        const div = document.createElement('div');
        div.className = 'player-item';
        const status =
