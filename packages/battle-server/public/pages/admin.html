<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>PYXIS Admin – All-in-One</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts: Cinzel for logo, Playfair Display for elegant headings/body -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;600;700;800;900&family=Playfair+Display:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
  /* =========================
     PYXIS Unified Premium Theme
     ========================= */
  :root{
    /* Core Colors */
    --navy-1:#00080D;     /* requested navy1 */
    --navy-2:#001E35;     /* requested navy2 */
    --gold-1:#DCC7A2;     /* requested gold1 */
    --gold-2:#D4BA8D;     /* requested gold2 */

    /* Extended system */
    --deep: var(--navy-1);
    --mid:  #021423;
    --surf: #0b1b2f;

    --text:#f8f6f0;
    --text-dim:#d8ccb8;
    --text-muted:#b7a793;

    --border-subtle:rgba(220,199,162,.10);
    --border-1:rgba(220,199,162,.18);
    --border-2:rgba(220,199,162,.32);

    --glass-1:rgba(0,30,53,.35);
    --glass-2:rgba(0,30,53,.55);
    --glass-3:rgba(220,199,162,.08);

    --shadow-soft:0 6px 18px rgba(0,0,0,.25);
    --shadow-deep:0 14px 36px rgba(0,0,0,.35);
    --glow:0 0 18px rgba(220,199,162,.18);

    --success:#22c55e;
    --warning:#f59e0b;
    --danger:#ef4444;
    --info:#38bdf8;

    --radius:14px;
    --radius-lg:20px;

    --ease:cubic-bezier(.4,0,.2,1);
  }

  *{box-sizing:border-box;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
  html,body{height:100%;margin:0}
  body{
    font-family:"Playfair Display", system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, serif;
    color:var(--text);
    background:
      radial-gradient(1200px 1200px at 10% -10%, rgba(220,199,162,.18) 0%, rgba(220,199,162,0) 50%),
      radial-gradient(900px 900px at 90% 110%, rgba(220,199,162,.10) 0%, rgba(220,199,162,0) 55%),
      linear-gradient(145deg, var(--deep) 0%, var(--mid) 45%, var(--navy-2) 100%);
    background-attachment:fixed;
    line-height:1.6;
  }

  .container{max-width:1400px;margin:0 auto;padding:20px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:18px;align-items:start}
  @media (max-width:1000px){.row{grid-template-columns:1fr}}
  .grid{display:grid;gap:14px}

  /* =========================
     Hero with rotating background and star twinkles
     ========================= */
  .hero{
    position:relative;
    padding:56px 16px 24px;
    text-align:center;
    overflow:hidden;
  }
  .hero::before{
    content:"";
    position:absolute; inset:-40% -20% auto -20%; height:520px;
    background:conic-gradient(from 0deg at 50% 50%,
      rgba(220,199,162,.18) 0deg,
      rgba(220,199,162,.06) 60deg,
      rgba(220,199,162,.22) 120deg,
      rgba(220,199,162,.05) 180deg,
      rgba(220,199,162,.18) 240deg,
      rgba(220,199,162,.06) 300deg,
      rgba(220,199,162,.22) 360deg);
    filter:blur(90px);
    animation:rotateBg 60s linear infinite;
    opacity:.8; pointer-events:none; z-index:-2;
  }
  @keyframes rotateBg{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

  /* Starfield (no unicode icons, pure CSS dots) */
  .twinkle-layer{position:absolute; inset:0; pointer-events:none; z-index:-1}
  .twinkle{position:absolute;width:3px;height:3px;border-radius:50%;background:var(--gold-1);box-shadow:0 0 10px var(--gold-1);opacity:.35;animation:twinkle 3.6s infinite}
  @keyframes twinkle{
    0%,100%{transform:scale(1);opacity:.25}
    50%{transform:scale(1.6);opacity:.8}
  }

  .brand{
    font-family:"Cinzel", serif;
    font-weight:800;
    letter-spacing:.08em;
    font-size:clamp(32px,5vw,48px);
    display:inline-block;
    background:linear-gradient(135deg, var(--gold-1), var(--gold-2) 30%, #f0e7ce 60%, var(--gold-1));
    background-size:300% 300%;
    -webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;
    animation:shimmer 5s ease-in-out infinite;
    text-shadow:0 4px 18px rgba(220,199,162,.30);
  }
  @keyframes shimmer{
    0%,100%{background-position:0% 50%}
    50%{background-position:100% 50%}
  }

  .status-wrap{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:10px}
  .status-indicator{
    display:flex;gap:10px;align-items:center;
    padding:8px 14px;border-radius:999px;
    background:linear-gradient(145deg, rgba(0,30,53,.65), rgba(0,30,53,.45));
    border:1px solid var(--border-subtle);
    backdrop-filter:blur(8px);
    box-shadow:var(--glow);
    font-weight:700;color:var(--text-dim);
  }
  .dot{width:10px;height:10px;border-radius:50%;background:var(--warning);box-shadow:0 0 10px currentColor;transition:.25s}
  .dot.ok{background:var(--success)}
  .dot.bad{background:var(--danger)}
  .pill{
    border:1px solid var(--border-1);padding:6px 10px;border-radius:999px;
    background:rgba(220,199,162,.06);font-weight:800;font-size:12px;letter-spacing:.04em;color:var(--text-dim)
  }
  .pill.wait{color:#f59e0b;border-color:rgba(245,158,11,.45)}
  .pill.live{color:#22c55e;border-color:rgba(34,197,94,.45)}
  .pill.end{color:#ef4444;border-color:rgba(239,68,68,.45)}

  /* =========================
     Cards & Sections
     ========================= */
  .card{
    position:relative;
    background:linear-gradient(145deg, rgba(0,30,53,.78), rgba(8,25,42,.82));
    border:1px solid var(--border-1);
    border-radius:var(--radius);
    padding:22px;
    box-shadow:var(--shadow-soft), var(--glow);
    backdrop-filter:blur(14px) saturate(130%);
    transition:transform .25s var(--ease), box-shadow .25s var(--ease), border-color .25s var(--ease)
  }
  .card:hover{transform:translateY(-3px);box-shadow:var(--shadow-deep), var(--glow);border-color:var(--border-2)}

  .section-title{
    font-family:"Playfair Display", serif;
    font-weight:700; letter-spacing:.02em;
    color:var(--gold-1); font-size:20px; margin:0 0 14px; padding-left:18px; position:relative
  }
  .section-title::before{
    content:""; position:absolute; left:0; top:50%; transform:translateY(-50%);
    width:6px;height:70%; border-radius:3px;
    background:linear-gradient(180deg, var(--gold-1), var(--gold-2));
    box-shadow:0 0 10px rgba(220,199,162,.45)
  }

  /* Buttons */
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:8px;
    padding:10px 16px;border-radius:12px;border:1.5px solid var(--border-1);
    background:linear-gradient(145deg, rgba(0,30,53,.85), rgba(10,32,56,.78));
    color:var(--text);font-weight:800;cursor:pointer;user-select:none;
    transition:transform .2s var(--ease), box-shadow .2s var(--ease), border-color .2s var(--ease), color .2s var(--ease)
  }
  .btn:hover{transform:translateY(-2px);border-color:var(--gold-1);box-shadow:0 10px 26px rgba(0,0,0,.35), 0 0 18px rgba(220,199,162,.25);color:var(--gold-1)}
  .btn:active{transform:translateY(0) scale(.98)}
  .btn:disabled{opacity:.55;cursor:not-allowed;transform:none}
  .btn.gold{
    background:linear-gradient(145deg, var(--gold-1), var(--gold-2));
    color:#0a121b;border-color:#e7d9b8;box-shadow:0 6px 18px rgba(220,199,162,.35)
  }
  .btn.danger{background:linear-gradient(145deg, #ef4444, #c93333);border-color:#ef4444;color:#fff}
  .btn.ghost{background:transparent;border-color:var(--border-1);color:var(--text-dim)}

  /* Inputs */
  .field{display:flex;flex-direction:column;gap:6px}
  .field label{font-weight:800;color:var(--text-dim);font-size:12px;letter-spacing:.02em;margin-left:4px}
  .input,.select,.textarea{
    width:100%;padding:10px 12px;border-radius:10px;
    border:1px solid var(--border-1);
    background:linear-gradient(145deg, rgba(0,30,53,.62), rgba(0,30,53,.48));
    color:var(--text);
    box-shadow:inset 0 2px 6px rgba(0,0,0,.35)
  }
  .input:focus,.select:focus,.textarea:focus{
    outline:none;border-color:var(--gold-1);
    box-shadow:0 0 0 3px rgba(220,199,162,.18), 0 0 22px rgba(220,199,162,.16)
  }

  /* Roster / Log / Chat */
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:800px){.two-col{grid-template-columns:1fr}}
  .team-card .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .team-title{font-family:"Playfair Display", serif;font-weight:800;color:var(--gold-1)}
  .team-count{font-weight:800;color:var(--text-muted)}
  .player-row{
    display:flex;align-items:center;justify-content:space-between;
    padding:10px 12px;border:1px solid var(--border-1);border-radius:12px;
    background:linear-gradient(145deg, rgba(0,30,53,.55), rgba(0,30,53,.42));
  }
  .player-row+.player-row{margin-top:8px}
  .player-row .badge{display:inline-flex;align-items:center;padding:4px 8px;border-radius:8px;background:rgba(220,199,162,.12);color:var(--gold-1);font-weight:900;margin-right:8px}
  .player-row .stat{color:var(--text-muted);font-size:12px}
  .btn-row{display:flex;gap:8px}

  .box{height:260px;overflow:auto;border:1px solid var(--border-1);border-radius:12px;padding:10px;
    background:linear-gradient(145deg, rgba(5,15,28,.92), rgba(8,22,39,.90));
    box-shadow:inset 0 3px 12px rgba(0,0,0,.5)
  }
  .log-item,.chat-item{
    display:grid;grid-template-columns:70px 80px 1fr;gap:8px;align-items:baseline;
    padding:6px 8px;border-bottom:1px solid rgba(220,199,162,.10)
  }
  .log-item .time,.chat-item .time{color:var(--text-muted);font-weight:800;font-size:12px}
  .log-item .type{color:var(--gold-1);font-weight:900}
  .chat-item .type{color:var(--text-dim);font-weight:800}
  .log-item .msg,.chat-item .msg{color:var(--text)}

  .chat-input-row{display:flex;gap:8px;margin-top:8px}
  .chat-input{flex:1}

  /* Toast */
  #toast{
    position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(20px);
    background:linear-gradient(145deg, rgba(0,30,53,.95), rgba(12,32,55,.92));
    color:var(--text);padding:12px 16px;border-radius:12px;border:1px solid var(--border-1);
    box-shadow:var(--shadow-soft);opacity:0;pointer-events:none;transition:transform .25s var(--ease), opacity .25s var(--ease);z-index:9999
  }
  #toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

  /* Touch targets on mobile */
  @media (hover:none){
    .btn{padding:12px 18px}
    .input,.select{padding:12px 14px}
  }
  </style>
</head>
<body>
  <div class="container">
    <header class="hero">
      <div class="twinkle-layer" id="twinkleLayer"></div>
      <h1 class="brand">PYXIS Admin</h1>
      <div class="status-wrap">
        <div class="status-indicator">
          <span id="connDot" class="dot"></span>
          <span id="connText">연결 대기</span>
        </div>
        <span id="battleStatePill" class="pill wait">대기</span>
      </div>
    </header>

    <main class="row">
      <!-- LEFT: Controls -->
      <section class="card">
        <h2 class="section-title">전투 컨트롤</h2>

        <div class="grid" style="grid-template-columns:repeat(3,1fr)">
          <div class="field">
            <label for="battleMode">모드</label>
            <select id="battleMode" class="select">
              <option value="1v1">1v1</option>
              <option value="2v2" selected>2v2</option>
              <option value="3v3">3v3</option>
              <option value="4v4">4v4</option>
            </select>
          </div>
          <div class="field" style="grid-column:span 2">
            <label for="battleId">전투 ID</label>
            <input id="battleId" class="input" placeholder="생성 시 자동 입력" />
          </div>
        </div>

        <div class="grid" style="grid-template-columns:repeat(6,auto);align-items:center">
          <button id="createBattleBtn" class="btn gold">전투 생성</button>
          <button id="startBattleBtn" class="btn">시작</button>
          <button id="pauseBattleBtn" class="btn ghost">일시정지</button>
          <button id="endBattleBtn" class="btn danger">종료</button>
          <button id="restartBattleBtn" class="btn ghost">재시작</button>
          <button id="reconnectBtn" class="btn ghost">재연결</button>
        </div>

        <hr style="border:none;border-top:1px solid var(--border-1);margin:16px 0" />

        <h3 class="section-title">접속 링크 생성</h3>
        <div class="grid" style="grid-template-columns:1fr auto;align-items:center">
          <input id="adminLink" class="input" placeholder="Admin 링크" />
          <button id="copyAdmin" class="btn ghost" aria-label="관리자 링크 복사">복사</button>

          <input id="playerLink" class="input" placeholder="Player 링크" />
          <button id="copyPlayer" class="btn ghost" aria-label="플레이어 링크 복사">복사</button>

          <input id="spectatorLink" class="input" placeholder="Spectator 링크" />
          <button id="copySpectator" class="btn ghost" aria-label="관전자 링크 복사">복사</button>

          <div></div>
          <button id="generateLinksBtn" class="btn gold">링크 생성</button>
        </div>

        <hr style="border:none;border-top:1px solid var(--border-1);margin:16px 0" />

        <h3 class="section-title">플레이어 등록</h3>
        <div class="grid" style="grid-template-columns:repeat(2,1fr)">
          <div class="field">
            <label for="playerName">이름</label>
            <input id="playerName" class="input" placeholder="예: Harry" maxlength="40" />
          </div>
          <div class="field">
            <label for="playerTeam">팀</label>
            <select id="playerTeam" class="select">
              <option value="phoenix">불사조 기사단</option>
              <option value="eaters">죽음을 먹는 자들</option>
            </select>
          </div>

          <div class="field">
            <label for="statAtk">공격(1~5)</label>
            <input id="statAtk" type="number" min="1" max="5" class="input" value="3" />
          </div>
          <div class="field">
            <label for="statDef">방어(1~5)</label>
            <input id="statDef" type="number" min="1" max="5" class="input" value="3" />
          </div>
          <div class="field">
            <label for="statAgi">민첩(1~5)</label>
            <input id="statAgi" type="number" min="1" max="5" class="input" value="3" />
          </div>
          <div class="field">
            <label for="statLuk">행운(1~5)</label>
            <input id="statLuk" type="number" min="1" max="5" class="input" value="3" />
          </div>

          <div class="field">
            <label for="playerHp">목표 HP(시작 후 보정)</label>
            <input id="playerHp" type="number" min="1" max="1000" class="input" value="100" />
          </div>
          <div class="field">
            <label for="itemSelect">아이템</label>
            <select id="itemSelect" class="select">
              <option value="">없음</option>
              <option value="dittany">회복약(Dittany)</option>
              <option value="attackBoost">공격 보정기</option>
              <option value="defenseBoost">방어 보정기</option>
            </select>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="addPlayerBtn" class="btn gold">플레이어 추가</button>
        </div>
      </section>

      <!-- RIGHT: Roster / Chat / Log -->
      <section class="card">
        <h2 class="section-title">팀 & 실시간</h2>

        <div class="two-col">
          <div class="team-card">
            <div class="header">
              <div class="team-title">불사조 기사단</div>
              <div class="team-count"><span id="teamACount">0</span> 명</div>
            </div>
            <div id="teamPhoenix"></div>
          </div>

          <div class="team-card">
            <div class="header">
              <div class="team-title">죽음을 먹는 자들</div>
              <div class="team-count"><span id="teamBCount">0</span> 명</div>
            </div>
            <div id="teamDeathEaters"></div>
          </div>
        </div>

        <hr style="border:none;border-top:1px solid var(--border-1);margin:16px 0" />

        <div class="two-col">
          <div>
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
              <div class="team-title">전투 로그</div>
            </div>
            <div id="battleLog" class="box"></div>
          </div>
          <div>
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
              <div class="team-title">채팅</div>
            </div>
            <div id="chatMessages" class="box"></div>
            <div class="chat-input-row">
              <input id="chatInput" class="input chat-input" placeholder="메시지 입력 후 Enter" />
              <button id="chatSendBtn" class="btn">전송</button>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Toast -->
  <div id="toast" role="status" aria-live="polite"></div>

  <!-- Socket.IO loader (origin → CDN fallback) -->
  <script>
    (function ensureSocketIO(){
      if (window.io){ document.dispatchEvent(new Event('socket-io-ready')); return; }
      function add(src, onload, onerror){
        var s=document.createElement('script'); s.src=src; s.async=true; s.onload=onload; s.onerror=onerror; document.head.appendChild(s);
      }
      add('/socket.io/socket.io.js',
        function(){ document.dispatchEvent(new Event('socket-io-ready')); },
        function(){ add('https://cdn.socket.io/4.7.5/socket.io.min.js',
          function(){ document.dispatchEvent(new Event('socket-io-ready')); },
          function(){ console.warn('Socket.IO client load failed'); }
        );}
      );
    })();
  </script>

  <!-- UI helpers -->
  <script>
    (function(){
      const $=(sel,root=document)=>root.querySelector(sel);
      const $$=(sel,root=document)=>Array.from(root.querySelectorAll(sel));
      function text(el,v){ if(el) el.textContent=String(v==null?'':v); }
      function toast(msg){
        const el=$('#toast'); if(!el) return;
        el.textContent=msg; el.classList.add('show');
        clearTimeout(el._t); el._t=setTimeout(()=>el.classList.remove('show'),1600);
      }
      function setConn({ok,msg}){
        const dot=$('#connDot'), t=$('#connText');
        if(dot){ dot.classList.remove('ok','bad'); dot.classList.add(ok==null?'':ok?'ok':'bad'); }
        if(t){ text(t, msg || (ok==null?'연결 중...': ok?'연결됨':'연결 끊김')); }
      }
      window.UI={$, $$, text, toast, setConn};
    })();
  </script>

  <!-- Admin Interface -->
  <script>
    // Header starfield without unicode icons
    (function buildTwinkles(){
      const host=document.getElementById('twinkleLayer'); if(!host) return;
      const count=80;
      for(let i=0;i<count;i++){
        const s=document.createElement('div'); s.className='twinkle';
        const size=(Math.random()*2.5+1).toFixed(2);
        s.style.width=size+'px'; s.style.height=size+'px';
        s.style.left=(Math.random()*100)+'%';
        s.style.top=(Math.random()*100)+'%';
        s.style.animationDuration=(2.2+Math.random()*3.6).toFixed(2)+'s';
        s.style.opacity=(0.25+Math.random()*0.55).toFixed(2);
        host.appendChild(s);
      }
    })();

    class AdminUI {
      constructor(){
        // Socket
        this.socket=null; this.connected=false; this.authed=false;

        // State
        const url=new URL(location.href);
        this.battleId=url.searchParams.get('battle')||'';
        this.adminToken=url.searchParams.get('token')||'';
        this.players=[];

        // Intervals
        this.heartbeat=null; this.syncer=null;

        // Elements
        const $=window.UI.$;
        this.el={
          mode:$('#battleMode'), id:$('#battleId'),
          create:$('#createBattleBtn'), start:$('#startBattleBtn'),
          pause:$('#pauseBattleBtn'), end:$('#endBattleBtn'), restart:$('#restartBattleBtn'),
          reconnect:$('#reconnectBtn'),

          adminLink:$('#adminLink'), playerLink:$('#playerLink'), spectatorLink:$('#spectatorLink'),
          genLinks:$('#generateLinksBtn'), copyAdmin:$('#copyAdmin'), copyPlayer:$('#copyPlayer'), copySpectator:$('#copySpectator'),

          name:$('#playerName'), team:$('#playerTeam'),
          atk:$('#statAtk'), def:$('#statDef'), agi:$('#statAgi'), luk:$('#statLuk'),
          hp:$('#playerHp'), item:$('#itemSelect'), add:$('#addPlayerBtn'),

          teamA:$('#teamPhoenix'), teamB:$('#teamDeathEaters'),
          teamACount:$('#teamACount'), teamBCount:$('#teamBCount'),

          log:$('#battleLog'), chat:$('#chatMessages'),
          chatInput:$('#chatInput'), chatSend:$('#chatSendBtn'),

          pill:$('#battleStatePill')
        };

        // Desired HP map (apply after start)
        this.desiredHp=new Map();

        this.bind();
        this.bootstrap();
      }

      bind(){
        const e=this.el;

        e.create?.addEventListener('click',()=>this.createBattle());
        e.start?.addEventListener('click',()=>this.startBattle());
        e.pause?.addEventListener('click',()=>this.pauseBattle());
        e.end?.addEventListener('click',()=>this.endBattle());
        e.restart?.addEventListener('click',()=>this.restartBattle());
        e.reconnect?.addEventListener('click',()=>this.connect());

        e.genLinks?.addEventListener('click',()=>this.generateLinks());
        e.copyAdmin?.addEventListener('click',()=>this.copy(e.adminLink));
        e.copyPlayer?.addEventListener('click',()=>this.copy(e.playerLink));
        e.copySpectator?.addEventListener('click',()=>this.copy(e.spectatorLink));

        e.add?.addEventListener('click',()=>this.addPlayer());
        e.chatSend?.addEventListener('click',()=>this.sendChat());
        e.chatInput?.addEventListener('keydown',(ev)=>{
          if(ev.key==='Enter' && !ev.shiftKey){ ev.preventDefault(); this.sendChat(); }
        });

        // Clamp stats
        const clamp=(el,min,max)=>{ const v=Number(el.value); el.value=Number.isFinite(v)? Math.max(min,Math.min(max,v)):min; };
        ['atk','def','agi','luk'].forEach(k=>{
          e[k]?.addEventListener('change',()=>clamp(e[k],1,5));
          e[k]?.addEventListener('blur',()=>clamp(e[k],1,5));
        });
        e.hp?.addEventListener('change',()=>clamp(e.hp,1,1000));
        e.hp?.addEventListener('blur',()=>clamp(e.hp,1,1000));
      }

      bootstrap(){
        if(this.el.id) this.el.id.value=this.battleId||'';
        this.updatePill('wait');
        this.connect();
        document.addEventListener('socket-io-ready',()=>{ if(!this.connected) this.connect(); });
        window.addEventListener('beforeunload',()=>this.cleanup());
      }

      /* ========== Networking ========== */
      connect(){
        if(this.socket?.connected) return;
        // eslint-disable-next-line no-undef
        this.socket=io({transports:['websocket','polling']});

        this.socket.on('connect', ()=>{
          this.connected=true; UI.setConn({ok:true,msg:'연결 완료'});
          if(this.battleId && this.adminToken){
            this.socket.emit('adminAuth',{battleId:this.battleId, token:this.adminToken});
          }
          this.startHeartbeat();
          this.startSync();
        });
        this.socket.on('disconnect', ()=>{
          this.connected=false; UI.setConn({ok:false,msg:'연결 끊김'});
          this.stopHeartbeat(); this.stopSync();
        });

        this.socket.on('authSuccess',(payload)=>{
          this.authed=true;
          if(payload?.battle){
            this.battleId=payload.battle.id || this.battleId;
            if(this.el.id) this.el.id.value=this.battleId;
            this.updatePillByStatus(payload.battle.status||payload.battle.state);
            this.renderRoster(payload.battle.players||[]);
          }
          this.log('system','관리자 인증 성공');
        });
        this.socket.on('authError',()=>{
          this.authed=false; this.log('error','관리자 인증 실패'); UI.toast('관리자 인증 실패');
        });

        this.socket.on('battleUpdate',(state)=>{
          if(state?.id){ this.battleId=state.id; if(this.el.id) this.el.id.value=this.battleId; }
          this.updatePillByStatus(state?.status||state?.state);
          this.renderRoster(state?.players||[]);
          if(Array.isArray(state?.log)){
            state.log.slice(-5).forEach(l=>this.log(l.type||'event', l.message||''));
          }
        });

        this.socket.on('chatMessage',(msg)=>{
          this.appendChat(msg?.sender||msg?.role||'채널', msg?.message||'');
        });
      }

      startHeartbeat(){
        this.stopHeartbeat();
        this.heartbeat=setInterval(()=>{
          if(!this.socket?.connected) return;
          this.socket.emit('admin:ping',{t:Date.now()});
        },15000);
      }
      stopHeartbeat(){ if(this.heartbeat) clearInterval(this.heartbeat); this.heartbeat=null; }

      startSync(){
        this.stopSync();
        this.syncer=setInterval(()=>{
          if(this.socket?.connected && this.battleId){
            this.socket.emit('admin:requestState',{battleId:this.battleId});
          }
        },5000);
      }
      stopSync(){ if(this.syncer) clearInterval(this.syncer); this.syncer=null; }

      /* ========== REST helper ========== */
      async j(url,opts={}){
        const res=await fetch(url,{headers:{'Content-Type':'application/json'},...opts});
        const t=await res.text(); let d={}; try{ d=t? JSON.parse(t):{} }catch{ throw new Error('Invalid JSON'); }
        if(!res.ok) throw new Error(d?.error || ('HTTP '+res.status));
        return d;
      }

      /* ========== Controls ========== */
      async createBattle(){
        try{
          const mode=this.el.mode?.value||'2v2';
          const r=await this.j('/api/battles',{method:'POST', body:JSON.stringify({mode})});
          const id=r?.id||r?.battleId;
          if(!id) throw new Error('ID 없음');
          this.battleId=id; if(this.el.id) this.el.id.value=id;
          const q=new URLSearchParams(location.search); q.set('battle',id); history.replaceState(null,'',location.pathname+'?'+q.toString());
          this.log('system','전투 생성: '+id); UI.toast('전투 생성 완료');
        }catch(e){ this.log('error','전투 생성 실패: '+e.message); UI.toast('전투 생성 실패'); }
      }

      startBattle(){
        if(!this.battleId) return UI.toast('전투 ID가 없습니다');
        const payload={battleId:this.battleId};
        this.socket?.emit('battle:start', payload, (res)=>{
          if(res?.success){ this.updatePill('live'); this.log('system','전투 시작'); UI.toast('전투 시작'); this.applyDesiredHp(); }
          else{ this.log('error','전투 시작 실패'); UI.toast('전투 시작 실패'); }
        });
      }
      async pauseBattle(){
        if(!this.battleId) return UI.toast('전투 ID가 없습니다');
        try{
          await this.j(`/api/admin/battles/${encodeURIComponent(this.battleId)}/pause`,{method:'POST', body:JSON.stringify({})});
          this.updatePill('wait'); this.log('system','전투 일시정지'); UI.toast('일시정지');
        }catch(e){ this.log('error','일시정지 실패: '+e.message); UI.toast('일시정지 실패'); }
      }
      async endBattle(){
        if(!this.battleId) return UI.toast('전투 ID가 없습니다');
        try{
          await this.j(`/api/admin/battles/${encodeURIComponent(this.battleId)}/end`,{method:'POST', body:JSON.stringify({})});
          this.updatePill('end'); this.log('system','전투 종료'); UI.toast('전투 종료');
        }catch(e){ this.log('error','전투 종료 실패: '+e.message); UI.toast('전투 종료 실패'); }
      }
      async restartBattle(){
        if(!this.battleId) return UI.toast('전투 ID가 없습니다');
        try{
          await this.j(`/api/admin/battles/${encodeURIComponent(this.battleId)}/start`,{method:'POST', body:JSON.stringify({restart:true})});
          this.updatePill('live'); this.log('system','전투 재시작'); UI.toast('전투 재시작');
        }catch(e){ this.log('error','전투 재시작 실패: '+e.message); UI.toast('전투 재시작 실패'); }
      }

      /* ========== Links ========== */
      async generateLinks(){
        if(!this.battleId) return UI.toast('전투 ID가 없습니다');
        try{
          const r=await this.j(`/api/admin/battles/${encodeURIComponent(this.battleId)}/links`,{method:'POST', body:JSON.stringify({})});
          const admin=r?.admin||r?.links?.admin||''; const player=r?.player||r?.links?.player||''; const spectator=r?.spectator||r?.links?.spectator||'';
          if(this.el.adminLink) this.el.adminLink.value=admin;
          if(this.el.playerLink) this.el.playerLink.value=player;
          if(this.el.spectatorLink) this.el.spectatorLink.value=spectator;
          this.log('system','링크 생성 완료'); UI.toast('링크 생성 완료');
        }catch(e){ this.log('error','링크 생성 실패: '+e.message); UI.toast('링크 생성 실패'); }
      }
      async copy(inputEl){
        if(!inputEl || !inputEl.value) return UI.toast('복사할 링크가 없습니다');
        try{ await navigator.clipboard.writeText(inputEl.value); UI.toast('복사 완료'); }
        catch{ inputEl.select(); document.execCommand('copy'); UI.toast('복사 완료'); }
      }

      /* ========== Players ========== */
      collectPlayer(){
        const name=(this.el.name?.value||'').trim();
        const team=this.teamKey(this.el.team?.value||'phoenix');
        if(!name) { UI.toast('이름을 입력하세요'); return null; }
        const clamp=v=>{ v=Number(v); if(!Number.isFinite(v)) return 3; return Math.max(1,Math.min(5,v)); };
        const stats={atk:clamp(this.el.atk.value), def:clamp(this.el.def.value), agi:clamp(this.el.agi.value), luk:clamp(this.el.luk.value)};
        const items=this.el.item?.value? [this.el.item.value]:[];
        const hpTgt=Number(this.el.hp?.value||100); this.desiredHp.set(name, hpTgt);
        return {name, team, stats, hp:100, items};
      }
      async addPlayer(){
        if(!this.battleId) return UI.toast('먼저 전투를 생성하세요');
        const payload=this.collectPlayer(); if(!payload) return;
        try{
          const r=await this.j(`/api/battles/${encodeURIComponent(this.battleId)}/players`,{method:'POST', body:JSON.stringify(payload)});
          const p=r?.player||r; if(!p || !(p.id||p.name)) throw new Error('응답 오류');
          this.players=this.uniqueById([...this.players, p]); this.renderRoster(this.players);
          this.resetForm(); this.log('system',`플레이어 등록: ${p.name} (HP목표:${this.desiredHp.get(p.name)})`); UI.toast('플레이어 등록 완료');
        }catch(e){ this.log('error','플레이어 등록 실패: '+e.message); UI.toast('플레이어 등록 실패'); }
      }
      resetForm(){
        if(this.el.name) this.el.name.value='';
        if(this.el.team) this.el.team.value='phoenix';
        ['atk','def','agi','luk'].forEach(k=>{ if(this.el[k]) this.el[k].value=3; });
        if(this.el.hp) this.el.hp.value=100;
        if(this.el.item) this.el.item.value='';
      }

      async applyDesiredHp(){
        // Admin-side helper: calls admin command to adjust HP after battle start
        for(const p of this.players){
          const tgt=this.desiredHp.get(p.name); if(!Number.isFinite(tgt)) continue;
          const diff=tgt-100; if(diff===0) continue;
          const action= diff>0? 'heal_partial':'damage';
          const value=Math.abs(diff);
          try{
            await this.j(`/api/admin/battles/${encodeURIComponent(this.battleId)}/command`,{
              method:'POST', body:JSON.stringify({action, playerIds:[p.id], value})
            });
            this.log('system',`HP 보정: ${p.name} → ${tgt}`);
          }catch(e){
            // fallback via socket
            await new Promise((res,rej)=>{
              this.socket.emit('admin:command',{battleId:this.battleId, action, playerIds:[p.id], value}, (r)=> r?.success? res():rej(new Error(r?.error||'command failed')));
            });
            this.log('system',`HP 보정(WS): ${p.name} → ${tgt}`);
          }
        }
      }

      renderRoster(players){
        const list=Array.isArray(players)?players: [];
        this.players=this.uniqueById(list);
        const by={phoenix:[], eaters:[]};
        for(const p of this.players){ (this.teamKey(p.team)==='phoenix'? by.phoenix:by.eaters).push(p); }
        const make=(p)=>{
          const name=this.escape(p.name||'플레이어');
          const atk=p.stats?.atk ?? p.atk ?? '-';
          const def=p.stats?.def ?? p.def ?? '-';
          const agi=p.stats?.agi ?? p.agi ?? '-';
          const luk=p.stats?.luk ?? p.luk ?? '-';
          const hpTxt=(typeof p.hp==='number' && typeof p.maxHp==='number')? ` / HP ${p.hp}/${p.maxHp}` : (typeof p.hp==='number'? ` / HP ${p.hp}`:'');
          const row=document.createElement('div');
          row.className='player-row';
          row.innerHTML=`
            <div>
              <span class="badge">${name}</span>
              <span class="stat">공격 ${atk} / 방어 ${def} / 민첩 ${agi} / 행운 ${luk}${hpTxt}</span>
            </div>
            <div class="btn-row">
              <button class="btn ghost" data-kick="${this.escape(p.id||'')}" data-name="${name}">제거</button>
            </div>`;
          row.querySelector('[data-kick]')?.addEventListener('click', async ()=>{
            if(!p.id || !this.battleId) return;
            if(!confirm(`플레이어 "${p.name}"을(를) 제거하시겠습니까?`)) return;
            try{
              await this.j(`/api/battles/${encodeURIComponent(this.battleId)}/players/${encodeURIComponent(p.id)}`,{method:'DELETE'});
              this.players=this.players.filter(x=>x.id!==p.id);
              this.renderRoster(this.players);
              UI.toast('플레이어 제거됨'); this.log('system','플레이어 제거: '+p.name);
            }catch(err){ UI.toast('플레이어 제거 실패'); this.log('error','플레이어 제거 실패: '+err.message); }
          });
          return row;
        };
        const hostA=this.el.teamA, hostB=this.el.teamB;
        if(hostA) hostA.innerHTML=''; if(hostB) hostB.innerHTML='';
        by.phoenix.forEach(p=> hostA?.appendChild(make(p)));
        by.eaters.forEach(p=> hostB?.appendChild(make(p)));
        if(this.el.teamACount) this.el.teamACount.textContent=String(by.phoenix.length);
        if(this.el.teamBCount) this.el.teamBCount.textContent=String(by.eaters.length);
      }

      /* ========== Chat / Log ========== */
      sendChat(){
        const v=(this.el.chatInput?.value||'').trim(); if(!v) return;
        if(this.socket?.connected && this.authed){
          this.socket.emit('chatMessage',{role:'admin', message:v, battleId:this.battleId});
        }
        this.appendChat('관리자', v); this.el.chatInput.value='';
      }
      appendChat(sender,msg){
        const box=this.el.chat; if(!box) return;
        const t=new Date(); const hh=String(t.getHours()).padStart(2,'0'); const mm=String(t.getMinutes()).padStart(2,'0'); const ss=String(t.getSeconds()).padStart(2,'0');
        const item=document.createElement('div'); item.className='chat-item';
        item.innerHTML=`<span class="time">${hh}:${mm}:${ss}</span><span class="type">${this.escape(sender)}</span><span class="msg">${this.escape(msg)}</span>`;
        box.appendChild(item); box.scrollTop=box.scrollHeight;
      }
      log(type,msg){
        const box=this.el.log; const t=new Date(); const hh=String(t.getHours()).padStart(2,'0'); const mm=String(t.getMinutes()).padStart(2,'0'); const ss=String(t.getSeconds()).padStart(2,'0');
        if(box){
          const item=document.createElement('div'); item.className='log-item';
          item.innerHTML=`<span class="time">${hh}:${mm}:${ss}</span><span class="type">${this.escape(type)}</span><span class="msg">${this.escape(msg)}</span>`;
          box.appendChild(item); box.scrollTop=box.scrollHeight;
        }else{ console.log(`[${hh}:${mm}:${ss}] [${type}] ${msg}`); }
      }

      /* ========== Utils ========== */
      updatePill(state){
        const pill=this.el.pill; if(!pill) return;
        pill.classList.remove('wait','live','end');
        const map={wait:'대기', live:'진행', end:'종료'};
        pill.classList.add(state in map? state:'wait'); pill.textContent=map[state]||map.wait;
      }
      updatePillByStatus(st){
        const s=String(st||'').toLowerCase();
        if(/live|running|in_progress/.test(s)) return this.updatePill('live');
        if(/end|ended|finished/.test(s)) return this.updatePill('end');
        return this.updatePill('wait');
      }
      teamKey(t){
        const s=String(t||'').toLowerCase();
        if(['phoenix','a','team1'].includes(s)) return 'phoenix';
        if(['eaters','b','team2','death','deatheaters'].includes(s)) return 'eaters';
        return 'phoenix';
      }
      uniqueById(arr){
        const m=new Map(); (arr||[]).forEach(it=>{ const k=it?.id||it?.playerId||it?.name; if(!m.has(k)) m.set(k,it); }); return Array.from(m.values());
      }
      escape(v){ const d=document.createElement('div'); d.textContent=String(v??''); return d.innerHTML; }
      cleanup(){ this.stopHeartbeat(); this.stopSync(); try{ this.socket?.disconnect(); }catch{} }
    }

    let admin;
    document.addEventListener('DOMContentLoaded',()=>{ admin=new AdminUI(); window.adminInterface=admin; });
  </script>
</body>
</html>
