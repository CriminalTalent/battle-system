<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>PYXIS ê´€ë¦¬ì</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=Cinzel:wght@700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
  :root{
    --gold-1:#DCC7A2; --gold-2:#D4BA8D;
    --navy-1:#00080D; --navy-2:#001E35;
    --ink:#EEE6D6; --ink-dim:#BEB49A;
    --border-subtle:rgba(220,199,162,.16);
    --border-bright:rgba(220,199,162,.36);
    --panel-2:rgba(0,30,53,.45); --panel-3:rgba(0,35,65,.60);
    --r-sm:10px; --r-md:14px; --r-lg:18px;
    --shadow-soft:0 10px 24px rgba(0,0,0,.35);
    --shadow-lift:0 14px 32px rgba(0,0,0,.45);
    --glow-gold:0 0 22px rgba(220,199,162,.25);
    --blur:blur(10px);
    --t-fast:.18s; --t-slow:14s;
  }
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family: Inter, system-ui, "Noto Sans KR", sans-serif;
    background:
      radial-gradient(1200px 900px at 50% -220px, rgba(220,199,162,.10), transparent 60%),
      linear-gradient(180deg, #02060A 0%, #020812 30%, #030B18 60%, #030C1E 100%);
  }
  .header{
    position:relative; overflow:hidden; padding:48px 20px 32px;
    border-bottom:1px solid var(--border-subtle);
    background:linear-gradient(120deg, rgba(220,199,162,.07), rgba(0,30,53,.25)); isolation:isolate;
  }
  .header::before{
    content:""; position:absolute; inset:-60% -20% auto -20%; height:140%;
    background:conic-gradient(from 0deg, rgba(220,199,162,.18), rgba(0,30,53,0) 42%, rgba(220,199,162,.18) 70%, rgba(0,30,53,0));
    filter:blur(26px); animation:spin var(--t-slow) linear infinite; z-index:-1;
  }
  @keyframes spin{to{transform:rotate(360deg)}}
  .brand{display:flex; align-items:flex-end; gap:12px;}
  .brand-title{
    font-family: Cinzel, serif; font-weight:800; letter-spacing:.12em; font-size:28px;
    background:linear-gradient(90deg, var(--gold-1), var(--gold-2));
    -webkit-background-clip:text; background-clip:text; color:transparent;
    position:relative; padding-right:28px;
  }
  .brand-title::before,.brand-title::after{
    position:absolute; color:var(--gold-1); opacity:.65; font-family:"Times New Roman", serif; line-height:1;
    animation:twinkle 2.2s ease-in-out infinite;
  }
  .brand-title::before{content:"âœ¦"; right:12px; top:-6px; animation-delay:.2s;}
  .brand-title::after{content:"âœ§"; right:-2px; top:-2px; animation-delay:1.2s;}
  @keyframes twinkle{0%,100%{opacity:.15;transform:scale(.8)}50%{opacity:1;transform:scale(1)}}
  .brand-sub{font-family:Playfair Display, serif; font-size:14px; letter-spacing:.18em; color:var(--ink-dim); transform:translateY(2px);}

  .container{max-width:1200px; margin:0 auto; padding:20px;}
  .grid{display:grid; gap:20px; grid-template-columns:1.2fr 1.2fr 1fr;}
  @media(max-width:1080px){.grid{grid-template-columns:1fr}}

  .card{
    background:linear-gradient(180deg, var(--panel-2), var(--panel-3));
    border:1px solid var(--border-subtle); border-top-color:rgba(220,199,162,.35);
    border-radius:var(--r-md); padding:18px; box-shadow:var(--shadow-soft);
    backdrop-filter:var(--blur); -webkit-backdrop-filter:var(--blur);
    transition:transform var(--t-fast) ease;
  }
  .card:hover{transform:translateY(-2px)}
  .title{display:flex; align-items:center; justify-content:space-between; color:var(--gold-1); font-family:Playfair Display, serif; letter-spacing:.06em; font-size:18px; margin:0 0 12px;}
  .pill{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border-bright); color:var(--ink-dim);
    background:linear-gradient(180deg, rgba(0,30,53,.55), rgba(0,30,53,.8));}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
  .col{display:flex; flex-direction:column; gap:6px;}
  label{font-size:12px; color:var(--ink-dim)}
  .input,.select,.file{
    width:100%; min-width:0; padding:10px 12px; border-radius:10px;
    border:1px solid var(--border-subtle);
    background:linear-gradient(180deg, rgba(0,30,53,.4), rgba(0,30,53,.7));
    color:var(--ink); outline:none;
  }
  .input::placeholder{color:rgba(238,230,214,.55)}
  .input:focus,.select:focus,.file:focus{border-color:var(--gold-1); box-shadow:0 0 0 3px rgba(220,199,162,.18)}
  .btn{
    appearance:none; border:1px solid var(--border-bright);
    background:linear-gradient(135deg, rgba(0,30,53,.55), rgba(0,30,53,.75)) padding-box,
               linear-gradient(135deg, var(--gold-1), var(--gold-2)) border-box;
    color:var(--gold-1); border-radius:10px; padding:10px 14px; font-weight:600; letter-spacing:.04em;
    position:relative; overflow:hidden; transition:transform .18s ease, box-shadow .18s ease; box-shadow:var(--shadow-soft);
  }
  .btn:hover{transform:translateY(-2px); box-shadow:var(--shadow-lift), var(--glow-gold)}
  .btn:active{transform:translateY(0)}
  .btn.shimmer::after{content:""; position:absolute; inset:0;
    background:linear-gradient(110deg, transparent 0%, rgba(255,255,255,.18) 45%, transparent 55%);
    transform:translateX(-100%); transition:transform .7s ease;}
  .btn.shimmer:hover::after{transform:translateX(100%)}

  .muted{color:var(--ink-dim); font-size:12px}
  .copy-grid{display:grid; gap:8px; grid-template-columns:1fr auto}
  .teams{display:grid; gap:12px; grid-template-columns:1fr 1fr}
  @media(max-width:720px){.teams{grid-template-columns:1fr}}
  .team{background:linear-gradient(180deg, rgba(0,30,53,.35), rgba(0,30,53,.6)); border:1px solid var(--border-subtle); border-radius:10px; padding:10px}
  .team-head{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; color:var(--gold-1); font-weight:700; letter-spacing:.05em}
  .players{display:grid; gap:8px}
  .player{display:grid; grid-template-columns:48px 1fr auto; gap:10px; align-items:center; background:linear-gradient(180deg, rgba(0,30,53,.35), rgba(0,30,53,.55)); border:1px solid var(--border-subtle); border-radius:10px; padding:8px}
  .avatar{width:48px; height:80px; border-radius:8px; object-fit:cover; border:1px solid var(--border-bright); background:rgba(0,0,0,.2)}
  .p-name{font-weight:700; letter-spacing:.02em}
  .p-meta{font-size:12px; color:var(--ink-dim)}
  .player-actions{display:flex; gap:6px}
  .icon-btn{
    background:transparent; border:1px solid var(--border-bright); color:var(--ink-dim);
    padding:6px 8px; border-radius:8px; cursor:pointer;
  }
  .icon-btn:hover{color:#ff6b6b; border-color:#ff6b6b}

  .log{height:360px; overflow:auto; border:1px solid var(--border-subtle); border-radius:10px; padding:10px; background:linear-gradient(180deg, rgba(0,30,53,.35), rgba(0,30,53,.65))}
  .log-entry{font-size:13px; color:var(--ink); opacity:.92; border-bottom:1px dashed rgba(220,199,162,.12); padding:6px 2px}
  .log-entry .ts{color:var(--ink-dim); font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; margin-right:8px}
  .log::-webkit-scrollbar{width:10px}
  .log::-webkit-scrollbar-thumb{background:linear-gradient(180deg, var(--gold-2), var(--gold-1)); border-radius:8px}
  .log::-webkit-scrollbar-track{background:rgba(0,0,0,.2)}

  /* ==== Select dropdown dark theme fix ==== */
  .select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background:
      linear-gradient(180deg, rgba(0,30,53,.4), rgba(0,30,53,.7)) padding-box,
      linear-gradient(135deg, var(--gold-1), var(--gold-2)) border-box;
    color: var(--ink);
    border: 1px solid var(--border-subtle);
    border-radius: 10px;
  }
  select.select option, select.select optgroup {
    background-color: #0e1116;
    color: #f8f6f0;
  }
  .select:focus {
    border-color: var(--gold-1);
    box-shadow: 0 0 0 3px rgba(220,199,162,.18);
    outline: none;
  }
  .select::-ms-expand { display: none; }
  .select:disabled { opacity:.6; cursor:not-allowed; }
  select.select::-webkit-scrollbar { width:10px; }
  select.select::-webkit-scrollbar-thumb{
    background:linear-gradient(180deg, var(--gold-2), var(--gold-1)); border-radius:8px;
  }
  select.select::-webkit-scrollbar-track{ background:rgba(0,0,0,.2); }
  </style>
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="brand">
        <div class="brand-title">PYXIS</div>
        <div class="brand-sub">BATTLE ADMIN CONSOLE</div>
      </div>
      <div class="row" style="margin-top:16px">
        <button id="btnCreate" class="btn shimmer">ì „íˆ¬ ìƒì„±</button>
        <button id="btnStart" class="btn">ì‹œì‘</button>
        <button id="btnPause" class="btn">ì¼ì‹œì •ì§€</button>
        <button id="btnEnd" class="btn">ì¢…ë£Œ</button>
        <span class="pill" id="statusPill">ëŒ€ê¸°</span>
        <span class="pill" id="idPill">ID: -</span>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="grid">

      <!-- A: Battle / Links / OTP -->
      <section class="card">
        <h2 class="title">ì „íˆ¬ ì„¤ì • <span class="pill">ëª¨ë“œ</span></h2>
        <div class="row" style="margin-bottom:10px">
          <select id="mode" class="select">
            <option value="1v1">1v1</option>
            <option value="2v2" selected>2v2</option>
            <option value="3v3">3v3</option>
            <option value="4v4">4v4</option>
          </select>
          <button id="btnApplyMode" class="btn">ëª¨ë“œ ì ìš©</button>
        </div>

        <h3 class="title" style="margin-top:6px">ë§í¬ ìƒì„± <span class="pill">ë³µì‚¬</span></h3>
        <div class="copy-grid">
          <input id="adminLink" class="input" placeholder="ê´€ë¦¬ì URL" readonly>
          <button class="btn shimmer" data-copy="#adminLink">ë³µì‚¬</button>
        </div>
        <div class="copy-grid" style="margin-top:8px">
          <input id="playerLink" class="input" placeholder="ì „íˆ¬ ì°¸ì—¬ì URL" readonly>
          <button class="btn shimmer" data-copy="#playerLink">ë³µì‚¬</button>
        </div>
        <div class="copy-grid" style="margin-top:8px">
          <input id="spectatorLink" class="input" placeholder="ê´€ì „ì URL" readonly>
          <button class="btn shimmer" data-copy="#spectatorLink">ë³µì‚¬</button>
        </div>
        <p class="muted" style="margin-top:8px">battle, token íŒŒë¼ë¯¸í„°ê°€ ìë™ í¬í•¨ë©ë‹ˆë‹¤.</p>

        <h3 class="title" style="margin-top:16px">ë¹„ë°€ë²ˆí˜¸ ë°œê¸‰ <span class="pill">Player / Spectator</span></h3>
        <div class="row">
          <select id="otpRole" class="select" style="max-width:160px">
            <option value="player">ì „íˆ¬ ì°¸ì—¬ì</option>
            <option value="spectator">ê´€ì „ì</option>
          </select>
          <div class="col" style="max-width:120px">
            <label for="otpCount">ê°œìˆ˜</label>
            <input id="otpCount" class="input" type="number" min="1" max="100" value="1">
          </div>
          <button id="btnIssueOtp" class="btn">ë°œê¸‰</button>
        </div>
        <div class="col" style="margin-top:8px">
          <label for="otpResult">ë°œê¸‰ ê²°ê³¼</label>
          <textarea id="otpResult" class="input" rows="4" readonly placeholder="ì—¬ê¸°ì— ë¹„ë°€ë²ˆí˜¸ê°€ í‘œì‹œë©ë‹ˆë‹¤"></textarea>
          <div class="row">
            <button class="btn shimmer" data-copy="#otpResult" style="margin-left:auto">ê²°ê³¼ ë³µì‚¬</button>
          </div>
        </div>
      </section>

      <!-- B: Player management -->
      <section class="card">
        <h2 class="title">ì°¸ì—¬ì ê´€ë¦¬ <span class="pill">ì¶”ê°€ / ë¡œìŠ¤í„°</span></h2>
        <div class="row">
          <div class="col" style="flex:1 1 200px">
            <label for="pName">ì „íˆ¬ ì°¸ì—¬ì ì´ë¦„</label>
            <input id="pName" class="input" placeholder="ì „íˆ¬ ì°¸ì—¬ì ì´ë¦„" maxlength="20">
          </div>
          <div class="col" style="width:180px">
            <label for="pTeam">íŒ€ ì„ íƒ</label>
            <select id="pTeam" class="select">
              <option value="A">ë¶ˆì‚¬ì¡° ê¸°ì‚¬ë‹¨ (A)</option>
              <option value="B">ì£½ìŒì„ ë¨¹ëŠ” ìë“¤ (B)</option>
            </select>
          </div>
          <button id="btnAdd" class="btn shimmer" style="height:42px">ì¶”ê°€</button>
        </div>

        <div class="row" style="margin-top:6px">
          <div class="col" style="flex:1">
            <label for="pAvatarUrl">ì´ë¯¸ì§€ URL</label>
            <input id="pAvatarUrl" class="input" placeholder="https://example.com/image.png">
          </div>
        </div>
        <div class="row">
          <input id="pAvatarFile" class="file" type="file" accept="image/*" style="flex:1">
          <button id="btnUploadAvatar" class="btn">ì—…ë¡œë“œ</button>
          <span id="uploadMsg" class="muted"></span>
        </div>
        <div class="row">
          <img id="avatarPreview" class="avatar" alt="preview">
          <span class="muted">ê¶Œì¥ ë¹„ìœ¨ 2:3 (ì˜ˆ: 240Ã—360)</span>
        </div>

        <div class="row" style="margin-top:8px">
          <div class="col" style="width:90px">
            <label for="sAtk">ê³µê²©</label>
            <input id="sAtk" class="input" type="number" min="0" max="5" value="0">
          </div>
          <div class="col" style="width:90px">
            <label for="sDef">ë°©ì–´</label>
            <input id="sDef" class="input" type="number" min="0" max="5" value="0">
          </div>
          <div class="col" style="width:90px">
            <label for="sAgi">ë¯¼ì²©</label>
            <input id="sAgi" class="input" type="number" min="0" max="5" value="0">
          </div>
          <div class="col" style="width:90px">
            <label for="sLuk">í–‰ìš´</label>
            <input id="sLuk" class="input" type="number" min="0" max="5" value="0">
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div class="col" style="width:140px">
            <label for="iDet">ë””í„°ë‹ˆ</label>
            <input id="iDet" class="input" type="number" min="0" max="9" value="0">
          </div>
          <div class="col" style="width:140px">
            <label for="iAtkB">ê³µê²© ë³´ì •ê¸°</label>
            <input id="iAtkB" class="input" type="number" min="0" max="9" value="0">
          </div>
          <div class="col" style="width:140px">
            <label for="iDefB">ë°©ì–´ ë³´ì •ê¸°</label>
            <input id="iDefB" class="input" type="number" min="0" max="9" value="0">
          </div>
        </div>

        <div class="teams" style="margin-top:14px">
          <div class="team">
            <div class="team-head"><div>ë¶ˆì‚¬ì¡° ê¸°ì‚¬ë‹¨</div><div id="teamACount" class="muted">0ëª…</div></div>
            <div id="teamA" class="players"><div class="muted">íŒ€ì›ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”</div></div>
          </div>
          <div class="team">
            <div class="team-head"><div>ì£½ìŒì„ ë¨¹ëŠ” ìë“¤</div><div id="teamBCount" class="muted">0ëª…</div></div>
            <div id="teamB" class="players"><div class="muted">íŒ€ì›ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”</div></div>
          </div>
        </div>
      </section>

      <!-- C: Status / Log / Chat -->
      <section class="card">
        <h2 class="title">ì§„í–‰ ìƒí™© <span class="pill" id="turnPill">í„´: -</span></h2>
        <div class="row"><div id="statusBoard" class="input" style="height:44px; display:flex; align-items:center">ìƒíƒœ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div></div>
        <label style="margin-top:6px">ì‹¤ì‹œê°„ ë¡œê·¸</label>
        <div id="log" class="log"></div>
        <div class="row" style="margin-top:10px">
          <input id="chatInput" class="input" placeholder="ìš´ì˜ì ì±„íŒ… ì…ë ¥">
          <button id="btnChat" class="btn">ì „ì†¡</button>
        </div>
      </section>

    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
  (function(){
    "use strict";
    const $  = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));

    let battleId = null;
    let adminToken = null;
    let socket = null;

    // ë²„íŠ¼
    $("#btnCreate").addEventListener("click", createBattle);
    $("#btnStart").addEventListener("click", ()=>postAdmin("/start"));
    $("#btnPause").addEventListener("click", ()=>postAdmin("/pause"));
    $("#btnEnd").addEventListener("click",   ()=>postAdmin("/end"));
    $("#btnApplyMode").addEventListener("click", refreshState);
    $("#btnAdd").addEventListener("click", addPlayer);
    $("#btnChat").addEventListener("click", sendChat);
    $("#btnUploadAvatar").addEventListener("click", uploadAvatar);
    $("#btnIssueOtp").addEventListener("click", issueOtp);

    // ë³µì‚¬
    $$("[data-copy]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const sel = btn.getAttribute("data-copy");
        const inp = document.querySelector(sel);
        if(!inp) return;
        if (inp.select) inp.select();
        navigator.clipboard.writeText(inp.value || "");
        btn.classList.add("shimmer"); setTimeout(()=>btn.classList.remove("shimmer"), 700);
      });
    });

    // ì¿¼ë¦¬ìŠ¤íŠ¸ë§ battle/token ìˆìœ¼ë©´ ìë™ ì—°ê²°
    (function autoConnectFromQS(){
      const qs = new URLSearchParams(location.search);
      const bid = qs.get("battle"); const tok = qs.get("token");
      if(bid && tok){
        battleId = bid; adminToken = tok;
        $("#idPill").textContent = "ID: " + battleId;
        connectSocket();
        refreshState();
      }
    })();

    async function createBattle(){
      const mode = $("#mode").value;
      const r = await fetch("/api/battles", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ mode }) });
      const d = await r.json();
      battleId = d.id; adminToken = d.token;
      $("#idPill").textContent = "ID: " + battleId;
      $("#statusPill").textContent = d.battle?.status || "ëŒ€ê¸°";
      connectSocket();
      await generateLinks();
      await refreshState();
      addLogLine("system", "ì „íˆ¬ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function connectSocket(){
      if(socket) socket.disconnect();
      socket = io();
      socket.on("connect", ()=>{
        if(battleId && adminToken){
          socket.emit("adminAuth", { battleId, token: adminToken });
          socket.emit("admin:requestState", { battleId });
        }
      });
      socket.on("authSuccess", ({ battle })=>{ if(battle) renderAll(battle); });
      socket.on("battleUpdate", (battle)=> renderAll(battle));
      socket.on("chatMessage", ({ sender, message })=> addLogLine("chat", sender + ": " + String(message||"").slice(0,500)));
      socket.on("authError", (e)=> addLogLine("system", "ì¸ì¦ ì‹¤íŒ¨: " + (e?.error||"unknown")));
    }

    async function refreshState(){
      if(!battleId) return;
      const r = await fetch(`/api/battles/${encodeURIComponent(battleId)}`);
      if(!r.ok) return;
      renderAll(await r.json());
    }

    async function postAdmin(suffix){
      if(!battleId) return;
      const r = await fetch(`/api/admin/battles/${encodeURIComponent(battleId)}${suffix}`, { method:"POST" });
      if(r.ok){
        const d = await r.json().catch(()=>({}));
        if(d?.battle) renderAll(d.battle); else await refreshState();
      }
    }

    async function generateLinks(){
      if(!battleId) return;
      const r = await fetch(`/api/admin/battles/${encodeURIComponent(battleId)}/links`, { method:"POST" });
      const d = await r.json();
      $("#adminLink").value = d.admin || "";
      $("#playerLink").value = d.player || "";
      $("#spectatorLink").value = d.spectator || "";
    }

    async function addPlayer(){
      if(!battleId) return;
      const name = $("#pName").value.trim();
      if(!name){ alert("ì „íˆ¬ ì°¸ì—¬ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
      const team = $("#pTeam").value;

      const stats = {
        atk: clamp($("#sAtk").value, 0, 5),
        def: clamp($("#sDef").value, 0, 5),
        agi: clamp($("#sAgi").value, 0, 5),
        luk: clamp($("#sLuk").value, 0, 5),
      };

      const items = [];
      const det = Number($("#iDet").value||0);
      const ab  = Number($("#iAtkB").value||0);
      const db  = Number($("#iDefB").value||0);
      for(let i=0;i<det;i++) items.push("heal10");      // ë””í„°ë‹ˆ
      for(let i=0;i<ab;i++)  items.push("atkBoost");    // ê³µê²© ë³´ì •ê¸°
      for(let i=0;i<db;i++)  items.push("defBoost");    // ë°©ì–´ ë³´ì •ê¸°

      const avatar = $("#pAvatarUrl").value.trim();

      const r = await fetch(`/api/battles/${encodeURIComponent(battleId)}/players`, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ name, team, stats, items, avatar })
      });
      if(r.ok){
        $("#pName").value = "";
        await refreshState();
        addLogLine("system", `ì „íˆ¬ ì°¸ì—¬ì ì¶”ê°€: ${name}`);
      } else {
        const e = await r.json().catch(()=>({}));
        alert("ì¶”ê°€ ì‹¤íŒ¨: " + (e?.error||r.status));
      }
    }

    async function uploadAvatar(){
      if(!battleId){ alert("ì „íˆ¬ë¥¼ ë¨¼ì € ìƒì„±í•˜ì„¸ìš”."); return; }
      const f = $("#pAvatarFile").files?.[0];
      if(!f){ $("#uploadMsg").textContent = "ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”."; return; }
      const fd = new FormData();
      fd.append("avatar", f);
      const r = await fetch(`/api/battles/${encodeURIComponent(battleId)}/avatar`, { method:"POST", body: fd });
      if(!r.ok){ $("#uploadMsg").textContent = "ì—…ë¡œë“œ ì‹¤íŒ¨"; return; }
      const d = await r.json().catch(()=>({}));
      const url = d?.url || "";
      $("#pAvatarUrl").value = url;
      const pv = $("#avatarPreview"); if(pv && url) pv.src = url;
      $("#uploadMsg").textContent = url ? "ì—…ë¡œë“œ ì„±ê³µ" : "ì—…ë¡œë“œ ì™„ë£Œ";
    }

    async function issueOtp(){
      if(!battleId){ alert("ì „íˆ¬ë¥¼ ë¨¼ì € ìƒì„±í•˜ì„¸ìš”."); return; }
      const role = $("#otpRole").value;
      const count = Math.max(1, Math.min(100, Number($("#otpCount").value||1)));
      const r = await fetch(`/api/admin/battles/${encodeURIComponent(battleId)}/otp`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ role, count })
      });
      const d = await r.json().catch(()=>({}));
      if(!r.ok || !d?.ok){
        $("#otpResult").value = `ë°œê¸‰ ì‹¤íŒ¨: ${d?.error||r.status}`;
        return;
      }
      $("#otpResult").value = (d.otps||[]).join("\n");
      addLogLine("system", `ë¹„ë°€ë²ˆí˜¸ ë°œê¸‰: ${role} x${(d.otps||[]).length}`);
    }

    function sendChat(){
      if(!socket || !battleId) return;
      const msg = $("#chatInput").value; if(!msg) return;
      socket.emit("chatMessage", { role:"admin", message: msg, battleId });
      $("#chatInput").value = "";
    }

    function renderAll(b){
      $("#statusPill").textContent = b.status || "ëŒ€ê¸°";
      $("#idPill").textContent = "ID: " + (b.id || "-");
      $("#turnPill").textContent = "í„´: " + (b.turn?.current ? 1 : "-");

      const log = $("#log"); log.innerHTML = "";
      (b.log || []).slice(-200).reverse().forEach(line=>{
        const el = document.createElement("div");
        el.className = "log-entry";
        const ts = new Date(line.t || Date.now()).toLocaleTimeString();
        el.innerHTML = `<span class="ts">[${ts}]</span>${line.message}`;
        log.appendChild(el);
      });

      const a = b.players.filter(p=>p.team==="phoenix");
      const e = b.players.filter(p=>p.team==="eaters");
      renderTeam("#teamA", "#teamACount", a, b.id);
      renderTeam("#teamB", "#teamBCount", e, b.id);

      // ë§í¬ëŠ” battle ìƒì„± ì§í›„ì—ë§Œ ìƒˆë¡œ ê³ ì¹¨
      $("#statusBoard").textContent = `ëª¨ë“œ ${b.mode} / ìƒíƒœ ${b.status} / ì „íˆ¬ ì°¸ì—¬ì ${b.players.length}`;
    }

    function renderTeam(listSel, countSel, arr, battleIdLocal){
      const list = $(listSel), count = $(countSel);
      list.innerHTML = "";
      if(!arr.length){
        const d=document.createElement("div"); d.className="muted"; d.textContent="íŒ€ì›ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”"; list.appendChild(d);
      }else{
        arr.forEach(p=>{
          const item=document.createElement("div"); item.className="player";
          const img=document.createElement("img"); img.className="avatar"; img.src=p.avatar||""; img.alt=p.name||"avatar";
          const meta=document.createElement("div");
          const name=document.createElement("div"); name.className="p-name"; name.textContent=p.name||"";
          const sub=document.createElement("div"); sub.className="p-meta";
          sub.textContent=`ATK ${p.stats?.atk ?? "-"}  DEF ${p.stats?.def ?? "-"}  AGI ${p.stats?.agi ?? "-"}  LUK ${p.stats?.luk ?? "-"}`;
          meta.appendChild(name); meta.appendChild(sub);

          const actions = document.createElement("div");
          actions.className = "player-actions";
          const del = document.createElement("button");
          del.className = "icon-btn";
          del.innerHTML = "ğŸ—‘ ì‚­ì œ";
          del.title = "ì „íˆ¬ ì°¸ì—¬ì ì‚­ì œ";
          del.addEventListener("click", async ()=>{
            if(!confirm(`ì •ë§ ì‚­ì œí• ê¹Œìš”? ${p.name}`)) return;
            const r = await fetch(`/api/battles/${encodeURIComponent(battleIdLocal)}/players/${encodeURIComponent(p.id)}`, { method:"DELETE" });
            if(r.ok){ await refreshState(); addLogLine("system", `ì „íˆ¬ ì°¸ì—¬ì ì‚­ì œ: ${p.name}`); }
            else { const e = await r.json().catch(()=>({})); alert("ì‚­ì œ ì‹¤íŒ¨: " + (e?.error||r.status)); }
          });

          actions.appendChild(del);

          item.appendChild(img); item.appendChild(meta); item.appendChild(actions);
          list.appendChild(item);
        });
      }
      if(count) count.textContent = (arr.length||0) + "ëª…";
    }

    function clamp(v, min, max){
      const n = Number(v||0);
      if(Number.isNaN(n)) return min;
      return Math.max(min, Math.min(max, n));
    }

    function addLogLine(_type, text){
      const log = $("#log");
      const el = document.createElement("div");
      el.className = "log-entry";
      const ts = new Date().toLocaleTimeString();
      el.innerHTML = `<span class="ts">[${ts}]</span>${text}`;
      log.prepend(el);
    }
  })();
  </script>
</body>
</html>
