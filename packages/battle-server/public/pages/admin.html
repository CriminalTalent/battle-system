<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>PYXIS 관리자 콘솔</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/css/pyxis-theme.css?v=4" />
  <style>
    /* 관리자 전용 소폭 보완: 드롭다운/입력 대비, 타임라인 높이, 모바일 최적화 */
    select.input { appearance: none; -webkit-appearance: none; -moz-appearance: none; background: rgba(0,30,53,.8); color: #E2E8F0; }
    .copy-btn[data-copied="true"]::after { content: "복사됨"; margin-left: 8px; color: #DCC7A2; font-weight: 700; }
    .timeline { height: 560px; }
    @media (max-width: 1200px){ .timeline { height: 520px; } }
    @media (max-width: 900px){ .timeline { height: 420px; } }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700; border:1px solid rgba(220,199,162,.35); background:rgba(0,30,53,.55); color:#DCC7A2; }
    .k-cols { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:560px){ .k-cols { grid-template-columns:1fr; } }
    .roster { display:grid; grid-template-columns:1fr; gap:8px; max-height: 560px; overflow:auto; }
    .row-2col { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .row-3col { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
    .row-4col { display:grid; grid-template-columns:repeat(4, 1fr); gap:10px; }
    .stat-chip { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid rgba(220,199,162,.28); color:#E2E8F0; font-size:12px; }
    .stat-chip .sname { color:#94A3B8; }
    .team-title { display:flex; align-items:center; justify-content:space-between; margin:4px 0 8px; }
    .team-title .tlabel { color:#DCC7A2; font-weight:800; }
    .list-item { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border:1px solid rgba(220,199,162,.2); border-radius:10px; background:rgba(0,8,13,.5); }
    .list-meta { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .list-actions { display:flex; align-items:center; gap:8px; }
    .btn-danger { border-color:#EF4444; background:linear-gradient(145deg,#EF4444,#b91c1c); color:white; }
    .btn-ghost { background:transparent; border:1px solid rgba(220,199,162,.35); color:#DCC7A2; }
    .subtitle { color:#94A3B8; font-size:13px; margin:4px 0 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 style="font-family: Cinzel, serif; font-weight: 700; font-size: 28px; letter-spacing: .6px;">PYXIS 관리자 콘솔</h1>
      <div class="sub">실시간 턴제 전투 관리 · 자동 링크 발행 · 비밀번호 발급 · 전투 참가자 관리 · 타임라인</div>
    </header>

    <div class="grid" style="grid-template-columns: 380px 1fr 420px;">
      <!-- 좌측: 전투 생성/제어/비밀번호 -->
      <section class="card">
        <h3 class="title">전투 생성</h3>
        <div class="row">
          <div>
            <label class="muted" for="modeSelect">전투 모드</label>
            <select id="modeSelect" class="input">
              <option value="1v1">1v1</option>
              <option value="2v2">2v2</option>
              <option value="3v3">3v3</option>
              <option value="4v4">4v4</option>
            </select>
          </div>
          <button id="btnCreate" class="btn">생성</button>
        </div>
        <div id="createResult" style="margin-top:12px; display:none;">
          <div class="kpi">
            <div class="label">전투 ID</div>
            <input id="battleIdField" class="input" type="text" readonly />
          </div>
          <div class="kpi" style="margin-top:8px;">
            <div class="label">관리자 토큰</div>
            <input id="adminTokenField" class="input" type="text" readonly />
          </div>

          <div class="k-cols" style="margin-top:12px;">
            <div class="kpi">
              <div class="label">관리자 URL</div>
              <div class="row">
                <input id="adminUrlField" class="input" type="text" readonly />
                <button class="btn copy-btn" data-copy-target="#adminUrlField">복사</button>
              </div>
            </div>
            <div class="kpi">
              <div class="label">전투 참가자 URL</div>
              <div class="row">
                <input id="playerUrlField" class="input" type="text" readonly />
                <button class="btn copy-btn" data-copy-target="#playerUrlField">복사</button>
              </div>
            </div>
          </div>

          <div class="k-cols" style="margin-top:12px;">
            <div class="kpi">
              <div class="label">관전자 URL</div>
              <div class="row">
                <input id="spectatorUrlField" class="input" type="text" readonly />
                <button class="btn copy-btn" data-copy-target="#spectatorUrlField">복사</button>
              </div>
              <div class="subtitle">관전자 비밀번호는 30분·최대 30명 사용</div>
            </div>
            <div class="kpi">
              <div class="label">관전자 비밀번호</div>
              <div class="row">
                <input id="spectatorOtpField" class="input" type="text" readonly />
                <button class="btn copy-btn" data-copy-target="#spectatorOtpField">복사</button>
              </div>
            </div>
          </div>

          <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
            <button id="btnRegenerateLinks" class="btn btn-ghost">링크 다시 발행</button>
          </div>
        </div>

        <hr style="border:none; border-top:1px solid rgba(220,199,162,.2); margin:14px 0;" />

        <h3 class="title">전투 제어</h3>
        <div class="row-3col">
          <button id="btnStart" class="btn">시작</button>
          <button id="btnPause" class="btn">일시정지</button>
          <button id="btnEnd" class="btn btn-danger">종료</button>
        </div>

        <div class="status" id="connectionStatus" style="margin-top:12px;">
          <div class="dot"></div><span>연결 끊김</span>
        </div>

        <hr style="border:none; border-top:1px solid rgba(220,199,162,.2); margin:14px 0;" />

        <h3 class="title">비밀번호 발급</h3>
        <div class="kpi">
          <div class="label">관전자 비밀번호(30명·30분)</div>
          <div class="row">
            <button id="btnIssueSpectatorOtp" class="btn">발급</button>
            <input id="issuedSpectatorOtp" class="input" type="text" placeholder="발급 결과" readonly />
          </div>
        </div>
        <div class="kpi" style="margin-top:8px;">
          <div class="label">전투 참가자 비밀번호</div>
          <div class="row">
            <input id="playerOtpCount" class="input" type="number" min="1" max="12" value="2" />
            <button id="btnIssuePlayerOtp" class="btn">발급</button>
          </div>
          <textarea id="issuedPlayerOtps" class="input" rows="3" style="margin-top:8px;" placeholder="발급된 비밀번호 목록" readonly></textarea>
        </div>
      </section>

      <!-- 중앙: 전투 참가자 관리 -->
      <section class="card">
        <h3 class="title">전투 참가자 추가</h3>

        <div class="k-cols">
          <div>
            <label class="muted" for="pName">이름</label>
            <input id="pName" class="input" type="text" placeholder="예: 플레이어1" />
          </div>
          <div>
            <label class="muted" for="pTeam">팀</label>
            <select id="pTeam" class="input">
              <option value="phoenix">불사조 기사단</option>
              <option value="eaters">죽음을 먹는 자들</option>
            </select>
          </div>
        </div>

        <div class="k-cols" style="margin-top:10px;">
          <div>
            <label class="muted" for="pAvatarFile">이미지</label>
            <div class="row">
              <input id="pAvatarFile" class="input" type="file" accept="image/*" />
              <button id="btnUploadAvatar" class="btn">업로드</button>
            </div>
            <input id="pAvatarUrl" class="input" type="text" placeholder="업로드 후 자동 입력" style="margin-top:8px;" readonly />
          </div>
          <div>
            <label class="muted">아이템 보유 수</label>
            <div class="row-3col">
              <div>
                <div class="muted" style="margin-bottom:4px;">디터니</div>
                <input id="itemHeal10" class="input" type="number" min="0" max="9" value="0" />
              </div>
              <div>
                <div class="muted" style="margin-bottom:4px;">공격 보정기</div>
                <input id="itemAtkBoost" class="input" type="number" min="0" max="9" value="0" />
              </div>
              <div>
                <div class="muted" style="margin-bottom:4px;">방어 보정기</div>
                <input id="itemDefBoost" class="input" type="number" min="0" max="9" value="0" />
              </div>
            </div>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label class="muted">능력치 (최대 5)</label>
          <div class="row-4col">
            <div>
              <div class="muted" style="margin-bottom:4px;">공격력</div>
              <input id="statAtk" class="input" type="number" min="0" max="5" value="1" />
            </div>
            <div>
              <div class="muted" style="margin-bottom:4px;">방어력</div>
              <input id="statDef" class="input" type="number" min="0" max="5" value="1" />
            </div>
            <div>
              <div class="muted" style="margin-bottom:4px;">민첩성</div>
              <input id="statAgi" class="input" type="number" min="0" max="5" value="1" />
            </div>
            <div>
              <div class="muted" style="margin-bottom:4px;">행운</div>
              <input id="statLuk" class="input" type="number" min="0" max="5" value="1" />
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <div></div>
          <button id="btnAddPlayer" class="btn">추가</button>
        </div>

        <hr style="border:none; border-top:1px solid rgba(220,199,162,.2); margin:14px 0;" />

        <div id="battleInfo" class="kpi">
          <div class="label">전투 정보</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px;">
            <span id="battleStatusPill" class="pill">대기 중</span>
            <span class="pill" id="turnInfoPill">턴 정보 없음</span>
            <span class="pill" id="modeInfoPill">모드 미정</span>
          </div>
        </div>

        <div class="row-2col" style="margin-top:12px;">
          <div>
            <div class="team-title">
              <div class="tlabel">불사조 기사단</div>
              <div class="pill">phoenix</div>
            </div>
            <div id="rosterPhoenix" class="roster"></div>
          </div>
          <div>
            <div class="team-title">
              <div class="tlabel">죽음을 먹는 자들</div>
              <div class="pill">eaters</div>
            </div>
            <div id="rosterEaters" class="roster"></div>
          </div>
        </div>
      </section>

      <!-- 우측: 타임라인(로그+채팅 입력) -->
      <section class="card">
        <h3 class="title">타임라인</h3>
        <div id="timelineFeed" class="logbox timeline" aria-live="polite" aria-label="전투 타임라인"></div>

        <div style="margin-top:12px;">
          <label class="muted" for="adminChatInput">운영진 메시지</label>
          <div class="row">
            <input id="adminChatInput" class="input" type="text" placeholder="메시지를 입력하고 전송하세요" />
            <button id="btnAdminSendChat" class="btn">전송</button>
          </div>
          <div class="subtitle">타임라인에는 시스템 로그, 채팅, 응원이 모두 표시됩니다.</div>
        </div>
      </section>
    </div>
  </div>

  <!-- 스크립트: 소켓 및 관리자 로직 -->
  <script src="/socket.io/socket.io.js"></script>
  <script src="/assets/js/ui-helpers.js"></script>
  <script src="/assets/js/notifications.js"></script>
  <script src="/assets/js/socket-manager.js"></script>
  <script src="/assets/js/admin.js"></script>

  <!-- 공통: 복사 버튼 폴백(관리자 JS에 동일 기능이 있으면 중복 없이 작동) -->
  <script>
    document.addEventListener('click', function (e) {
      const btn = e.target.closest('[data-copy-target]');
      if (!btn) return;
      const sel = btn.getAttribute('data-copy-target');
      const el = document.querySelector(sel);
      if (!el) return;
      const val = ('value' in el) ? el.value : el.textContent;
      if (!val) return;
      navigator.clipboard.writeText(val).then(() => {
        btn.dataset.copied = 'true';
        setTimeout(() => { btn.removeAttribute('data-copied'); }, 1000);
      });
    });
  </script>
</body>
</html>
