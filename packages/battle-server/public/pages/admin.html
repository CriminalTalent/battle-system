<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>PYXIS - 관리자 콘솔</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* ====== (원본 디자인 유지) Reset & Base ====== */
        * { margin:0; padding:0; box-sizing:border-box; }

        /* ====== Design Tokens (원본) ====== */
        :root {
            --deep-navy: #00080D;
            --navy-light: #001E35;
            --navy-medium: #002A47;
            --gold-bright: #DCC7A2;
            --gold-warm: #D4BA8D;

            --surface-1: rgba(0, 30, 53, 0.85);
            --surface-2: rgba(0, 42, 71, 0.9);
            --surface-3: rgba(0, 61, 92, 0.95);
            
            --border-subtle: rgba(220, 199, 162, 0.12);
            --border-medium: rgba(220, 199, 162, 0.2);
            
            --text-bright: #FFFFFF;
            --text: rgba(255, 255, 255, 0.9);
            --text-dim: rgba(255, 255, 255, 0.7);
            --text-muted: rgba(255, 255, 255, 0.5);

            --success: #4ADE80;
            --warning: #FBBF24;
            --danger: #F87171;
            --info: #60A5FA;

            --font-display: 'Cinzel', serif;
            --font-body: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;

            --space-xs: 3px;
            --space-sm: 6px;
            --space-md: 12px;
            --space-lg: 16px;
            --space-xl: 20px;

            --radius-sm: 4px;
            --radius: 6px;
            --radius-lg: 8px;

            --shadow-subtle: 0 2px 8px rgba(0, 0, 0, 0.2);
            --shadow-soft: 0 4px 16px rgba(0, 0, 0, 0.25);
            --shadow-glow: 0 0 16px rgba(220, 199, 162, 0.25);

            --blur-light: blur(6px);
            --transition-fast: all 0.15s ease;
        }

        body {
            font-family: var(--font-body);
            background: linear-gradient(135deg, var(--deep-navy) 0%, var(--navy-light) 100%);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.5;
            font-size: 14px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-lg);
        }

        .header {
            text-align: center;
            padding: var(--space-lg) 0 var(--space-xl);
            margin-bottom: var(--space-lg);
        }

        .logo {
            font-family: var(--font-display);
            font-size: 32px;
            font-weight: 600;
            background: linear-gradient(45deg, var(--gold-bright), var(--gold-warm));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            display: inline-block;
            margin-bottom: var(--space-sm);
        }
        .logo::before {
            content: '✦';
            position: absolute; left: -20px; top: 50%;
            transform: translateY(-50%);
            font-size: 16px; color: var(--gold-bright);
            animation: twinkle 3s infinite;
        }
        .logo::after {
            content: '✧';
            position: absolute; right: -20px; top: 50%;
            transform: translateY(-50%);
            font-size: 14px; color: var(--gold-warm);
            animation: twinkle 3s infinite 1.5s;
        }
        .subtitle {
            font-size: 11px; color: var(--text-muted);
            font-weight: 500; letter-spacing: 0.1em; text-transform: uppercase;
        }

        .admin-layout {
            display: grid;
            grid-template-columns: 320px 1fr 280px;
            gap: var(--space-lg);
            min-height: calc(100vh - 160px);
        }

        .card {
            background: var(--surface-1);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius);
            padding: var(--space-lg);
            backdrop-filter: var(--blur-light);
            position: relative;
            transition: var(--transition-fast);
            height: fit-content;
        }
        .card::before {
            content: '';
            position: absolute; top:0; left:0; right:0; height:1px;
            background: linear-gradient(90deg, transparent, var(--gold-bright), transparent);
            opacity: 0.2;
        }
        .card:hover { border-color: var(--border-medium); box-shadow: var(--shadow-subtle); }
        .card-title {
            font-family: var(--font-display);
            font-size: 16px; font-weight: 600; color: var(--text-bright);
            margin-bottom: var(--space-lg); position: relative; padding-bottom: var(--space-sm);
        }
        .card-title::after {
            content: ''; position: absolute; bottom:0; left:0; width:24px; height:1px;
            background: var(--gold-bright); opacity: 0.5;
        }

        .btn {
            display:inline-flex; align-items:center; justify-content:center; gap:var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            background: var(--surface-2);
            color: var(--text); font-weight: 500; font-size: 12px;
            cursor: pointer; transition: var(--transition-fast); text-decoration:none; white-space:nowrap;
        }
        .btn:hover { border-color: var(--gold-bright); background: var(--surface-3); transform: translateY(-1px); }
        .btn-primary {
            background: linear-gradient(45deg, var(--gold-bright), var(--gold-warm));
            color: var(--deep-navy); border-color: transparent; font-weight: 600;
        }
        .btn-primary:hover { background: linear-gradient(45deg, var(--gold-warm), var(--gold-bright)); box-shadow: var(--shadow-glow); }
        .btn-success { background: var(--success); color:white; border-color: var(--success); }
        .btn-danger { background: var(--danger); color:white; border-color: var(--danger); }
        .btn:disabled { opacity: .5; cursor:not-allowed; transform:none; }

        .form-group { margin-bottom: var(--space-md); }
        .form-label { display:block; font-weight:500; color:var(--text-bright); margin-bottom:var(--space-sm); font-size:12px; }
        .form-input, .form-select {
            width:100%; padding: var(--space-sm) var(--space-md);
            background:var(--surface-2); border:1px solid var(--border-subtle);
            border-radius: var(--radius-sm); color:var(--text); font-size:12px;
            transition: var(--transition-fast);
        }
        .form-input:focus, .form-select:focus { outline:none; border-color: var(--gold-bright); box-shadow: 0 0 0 2px rgba(220,199,162,.1); }
        .form-input::placeholder { color: var(--text-muted); }

        .mode-selection {
            display:grid; grid-template-columns: repeat(4,1fr); gap: var(--space-sm); margin-bottom: var(--space-md);
        }
        .mode-btn {
            padding: var(--space-sm); background: var(--surface-2); border:1px solid var(--border-subtle);
            border-radius: var(--radius-sm); color:var(--text); cursor:pointer; transition: var(--transition-fast);
            text-align:center; font-weight:500; font-size:11px;
        }
        .mode-btn:hover { border-color: var(--gold-bright); background: var(--surface-3); }
        .mode-btn.active { border-color: var(--gold-bright); background: var(--gold-bright); color: var(--deep-navy); font-weight: 600; }

        .player-form { display:grid; gap: var(--space-md); }
        .player-row { display:grid; grid-template-columns: 1fr 0.8fr 60px; gap: var(--space-sm); align-items:end; }

        .stat-inputs { display:grid; grid-template-columns: repeat(4,1fr); gap: var(--space-sm); }
        .stat-group { text-align:center; }
        .stat-label { display:block; font-size:10px; color:var(--text-muted); margin-bottom:var(--space-xs); text-transform:uppercase; letter-spacing:.05em; }
        .stat-input { width:100%; padding: var(--space-xs); text-align:center; background:var(--surface-2); border:1px solid var(--border-subtle); border-radius: var(--radius-sm); color:var(--text); font-weight:500; font-size:12px; }

        .team-roster { margin-bottom: var(--space-lg); }
        .team-header { display:flex; align-items:center; justify-content:space-between; margin-bottom: var(--space-sm); padding: var(--space-sm); background: var(--surface-2); border-radius: var(--radius-sm); }
        .team-name { font-weight: 600; color: var(--gold-bright); font-size: 13px; }
        .team-count { background: var(--surface-3); color: var(--text-bright); padding:2px 6px; border-radius: var(--radius-sm); font-size:10px; font-weight:500; }

        .player-list { display:grid; gap: var(--space-sm); }
        .player-item { display:flex; align-items:center; gap: var(--space-sm); padding: var(--space-sm); background: var(--surface-2); border:1px solid var(--border-subtle); border-radius: var(--radius-sm); transition: var(--transition-fast); }
        .player-item:hover { background: var(--surface-3); border-color: var(--border-medium); }
        .player-avatar { width:28px; height:28px; border-radius:50%; background: var(--surface-3); border:1px solid var(--gold-bright); object-fit:cover; flex-shrink:0; }
        .player-info { flex:1; min-width:0; }
        .player-name { font-weight:500; color:var(--text-bright); margin-bottom:2px; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .player-stats { font-size:10px; color:var(--text-muted); font-family: var(--font-mono); }

        .status-grid { display:grid; grid-template-columns: repeat(2,1fr); gap: var(--space-sm); margin-bottom: var(--space-md); }
        .status-item { text-align:center; padding: var(--space-sm); background: var(--surface-2); border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); }
        .status-label { display:block; font-size:10px; color:var(--text-muted); margin-bottom: var(--space-xs); text-transform:uppercase; letter-spacing:.05em; }
        .status-value { font-size:14px; font-weight:600; color:var(--text-bright); }
        .status-waiting .status-value { color: var(--warning); }
        .status-active .status-value { color: var(--success); }
        .status-ended .status-value { color: var(--danger); }

        .log-container { height: 280px; background:var(--surface-2); border:1px solid var(--border-subtle); border-radius: var(--radius-sm); overflow-y:auto; padding: var(--space-sm); margin-bottom: var(--space-sm); }
        .log-entry { margin-bottom: var(--space-sm); padding: var(--space-xs) var(--space-sm); border-left: 2px solid var(--border-subtle); font-size:11px; }
        .log-timestamp { font-size:9px; color:var(--text-muted); font-family: var(--font-mono); }
        .log-message { color: var(--text); margin-top:2px; }
        .log-action { border-left-color: var(--info); }
        .log-damage { border-left-color: var(--danger); }
        .log-heal { border-left-color: var(--success); }
        .log-system { border-left-color: var(--warning); }

        .link-section { margin-top: var(--space-md); }
        .link-item { display:flex; align-items:center; gap: var(--space-sm); margin-bottom: var(--space-sm); }
        .link-url { flex:1; padding: var(--space-xs) var(--space-sm); background: var(--surface-3); border:1px solid var(--border-subtle); border-radius: var(--radius-sm); color:var(--text); font-family: var(--font-mono); font-size:10px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .copy-btn { padding: var(--space-xs) var(--space-sm); background: var(--surface-2); border:1px solid var(--border-medium); border-radius: var(--radius-sm); color:var(--text); cursor:pointer; transition: var(--transition-fast); font-size:10px; font-weight:500; }
        .copy-btn:hover { background: var(--gold-bright); color: var(--deep-navy); }

        .turn-info { text-align:center; margin-bottom: var(--space-md); padding: var(--space-md); background: var(--surface-2); border:1px solid var(--border-subtle); border-radius: var(--radius-sm); }

        .empty-state { text-align:center; color:var(--text-muted); padding: var(--space-md); font-size:11px; font-style: italic; }

        @keyframes twinkle { 0%,100%{opacity:1; transform:scale(1);} 50%{opacity:.6; transform:scale(1.1);} }

        @media (max-width:1200px){
            .admin-layout { grid-template-columns:1fr; gap: var(--space-md); }
        }
        @media (max-width:768px){
            .container { padding: var(--space-md); }
            .logo { font-size:28px; }
            .mode-selection { grid-template-columns: repeat(2,1fr); }
            .player-row { grid-template-columns: 1fr; gap: var(--space-sm); }
            .stat-inputs { grid-template-columns: repeat(2,1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="logo">PYXIS</h1>
            <p class="subtitle">Battle Management System</p>
        </header>

        <div class="admin-layout">
            <!-- Left: Battle Control -->
            <div class="control-column">
                <div class="card">
                    <h2 class="card-title">전투 설정</h2>
                    <div class="form-group">
                        <label class="form-label">모드 선택</label>
                        <div class="mode-selection">
                            <div class="mode-btn active" data-mode="1v1">1v1</div>
                            <div class="mode-btn" data-mode="2v2">2v2</div>
                            <div class="mode-btn" data-mode="3v3">3v3</div>
                            <div class="mode-btn" data-mode="4v4">4v4</div>
                        </div>
                    </div>

                    <button class="btn btn-primary" id="createBattleBtn" style="width:100%;margin-bottom:var(--space-md)">전투 생성</button>

                    <div class="status-grid">
                        <div class="status-item status-waiting">
                            <span class="status-label">상태</span>
                            <div class="status-value" id="battleStatus">대기</div>
                        </div>
                        <div class="status-item">
                            <span class="status-label">ID</span>
                            <div class="status-value" id="battleId">-</div>
                        </div>
                    </div>

                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--space-sm);margin-top:var(--space-md);">
                        <button class="btn btn-success" id="startBattleBtn" disabled>시작</button>
                        <button class="btn btn-danger" id="stopBattleBtn" disabled>종료</button>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">접속 링크</h2>
                    <button class="btn btn-primary" id="generateLinksBtn" disabled style="width:100%;margin-bottom:var(--space-md)">링크 생성</button>

                    <div class="link-section" id="linkSection" style="display:none;">
                        <div class="form-group">
                            <label class="form-label">관리자</label>
                            <div class="link-item">
                                <input class="link-url" id="adminLink" readonly>
                                <button class="copy-btn" data-copy="#adminLink">복사</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">관전자</label>
                            <div class="link-item">
                                <input class="link-url" id="spectatorLink" readonly>
                                <button class="copy-btn" data-copy="#spectatorLink">복사</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Center: Player Management -->
            <div class="participants-column">
                <!-- Player Addition -->
                <div class="card">
                    <h2 class="card-title">플레이어 추가</h2>

                    <div class="player-form">
                        <div class="player-row">
                            <div class="form-group" style="margin-bottom:0;">
                                <input type="text" class="form-input" id="playerName" placeholder="플레이어 이름" maxlength="20">
                            </div>
                            <div class="form-group" style="margin-bottom:0;">
                                <select class="form-select" id="playerTeam">
                                    <option value="A">불사조 기사단</option>
                                    <option value="B">죽음을 먹는 자들</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" id="addPlayerBtn">추가</button>
                        </div>

                        <!-- 아바타 URL & 미리보기 (요청: 플레이어 추가 카드 안으로 이동) -->
                        <div class="form-group" style="margin-top:-4px;">
                            <label class="form-label">아바타 URL (선택)</label>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <input type="url" class="form-input" id="avatarUrl" placeholder="https://...">
                                <img id="avatarPreview" alt="avatar" style="width:44px;height:44px;border-radius:6px;object-fit:cover;border:1px solid var(--border-medium)">
                            </div>
                        </div>

                        <!-- (요청) 총 12포인트 문구 제거, 기본값 0, 라벨 변경 -->
                        <div class="form-group">
                            <label class="form-label">스탯 입력 (각 0~5 / 전송 시 0은 1로 보정)</label>
                            <div class="stat-inputs">
                                <div class="stat-group">
                                    <label class="stat-label">공격</label>
                                    <input type="number" class="stat-input" id="attackStat" min="0" max="5" value="0">
                                </div>
                                <div class="stat-group">
                                    <label class="stat-label">방어</label>
                                    <input type="number" class="stat-input" id="defenseStat" min="0" max="5" value="0">
                                </div>
                                <div class="stat-group">
                                    <label class="stat-label">민첩</label>
                                    <input type="number" class="stat-input" id="agilityStat" min="0" max="5" value="0">
                                </div>
                                <div class="stat-group">
                                    <label class="stat-label">행운</label>
                                    <input type="number" class="stat-input" id="luckStat" min="0" max="5" value="0">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">시작 아이템</label>
                            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:var(--space-sm);">
                                <div class="stat-group">
                                    <label class="stat-label">디터니</label>
                                    <input type="number" class="stat-input" id="detinyCount" min="0" max="9" value="0">
                                </div>
                                <div class="stat-group">
                                    <label class="stat-label">공격보정</label>
                                    <input type="number" class="stat-input" id="attackBoostCount" min="0" max="9" value="0">
                                </div>
                                <div class="stat-group">
                                    <label class="stat-label">방어보정</label>
                                    <input type="number" class="stat-input" id="defenseBoostCount" min="0" max="9" value="0">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Team Roster -->
                <div class="card">
                    <h2 class="card-title">팀 구성</h2>
                    
                    <!-- Team A -->
                    <div class="team-roster">
                        <div class="team-header">
                            <span class="team-name">불사조 기사단</span>
                            <span class="team-count" id="teamACount">0명</span>
                        </div>
                        <div class="player-list" id="teamAList">
                            <div class="empty-state">팀원을 추가해주세요</div>
                        </div>
                    </div>

                    <!-- Team B -->
                    <div class="team-roster">
                        <div class="team-header">
                            <span class="team-name">죽음을 먹는 자들</span>
                            <span class="team-count" id="teamBCount">0명</span>
                        </div>
                        <div class="player-list" id="teamBList">
                            <div class="empty-state">팀원을 추가해주세요</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Monitoring -->
            <div class="interaction-column">
                <div class="card">
                    <h2 class="card-title">진행 상황</h2>
                    <div class="turn-info">
                        <div class="current-turn" id="currentTurn">턴 대기중</div>
                        <div class="turn-timer" id="turnTimer">00:00</div>
                    </div>

                    <div class="status-grid">
                        <div class="status-item">
                            <span class="status-label">연결</span>
                            <div class="status-value" id="connectionCount">0</div>
                        </div>
                        <div class="status-item">
                            <span class="status-label">턴</span>
                            <div class="status-value" id="turnCount">0</div>
                        </div>
                    </div>
                </div>

                <!-- Battle Log -->
                <div class="card">
                    <h2 class="card-title">전투 로그</h2>
                    <div class="log-container" id="battleLog">
                        <div class="empty-state">전투 로그가 여기에 표시됩니다</div>
                    </div>
                    <div class="chat-input-group">
                        <input type="text" class="form-input chat-input" id="chatMessage" placeholder="관리자 메시지...">
                        <button class="btn" id="sendChatBtn">전송</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Socket.IO 로더 (로컬 → CDN 폴백) -->
    <script>
        (function ensureSocketIO(){
            if (window.io) return;
            function add(src, onload, onerror){
                var s=document.createElement('script'); s.src=src; s.async=true; s.onload=onload; s.onerror=onerror; document.head.appendChild(s);
            }
            add('/socket.io/socket.io.js', function(){}, function(){
                add('https://cdn.socket.io/4.7.5/socket.io.min.js', function(){}, function(){
                    console.warn('Socket.IO client load failed');
                });
            });
        })();
    </script>

    <script>
        // ===== 관리자 페이지 로직 (디자인 유지, 기능 보강) =====
        const $  = (sel, root=document) => root.querySelector(sel);
        const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

        // 상태
        let socket = null;
        let currentMode = '1v1';
        let currentBattleId = null;
        let adminOtp = null;
        let spectatorOtp = null;

        // 엘리먼트
        const el = {
            // 전투 설정
            modeBtns: $$('.mode-btn'),
            createBattleBtn: $('#createBattleBtn'),
            startBattleBtn: $('#startBattleBtn'),
            stopBattleBtn: $('#stopBattleBtn'),
            battleStatus: $('#battleStatus'),
            battleId: $('#battleId'),
            // 링크
            generateLinksBtn: $('#generateLinksBtn'),
            linkSection: $('#linkSection'),
            adminLink: $('#adminLink'),
            spectatorLink: $('#spectatorLink'),
            copyBtns: $$('.copy-btn'),
            // 플레이어 추가
            addPlayerBtn: $('#addPlayerBtn'),
            playerName: $('#playerName'),
            playerTeam: $('#playerTeam'),
            avatarUrl: $('#avatarUrl'),
            avatarPreview: $('#avatarPreview'),
            statAtk: $('#attackStat'),
            statDef: $('#defenseStat'),
            statAgi: $('#agilityStat'),
            statLuk: $('#luckStat'),
            itemDet: $('#detinyCount'),
            itemAtk: $('#attackBoostCount'),
            itemDef: $('#defenseBoostCount'),
            // 팀
            teamAList: $('#teamAList'),
            teamBList: $('#teamBList'),
            teamACount: $('#teamACount'),
            teamBCount: $('#teamBCount'),
            // 로그
            log: $('#battleLog'),
            // misc
            currentTurn: $('#currentTurn'),
            turnTimer: $('#turnTimer'),
            connectionCount: $('#connectionCount'),
            turnCount: $('#turnCount'),
            // admin chat
            adminChatInput: $('#chatMessage'),
            adminChatSend: $('#sendChatBtn')
        };

        // 아바타 프리뷰
        function updateAvatarPreview(){
            const url = (el.avatarUrl.value || '').trim();
            el.avatarPreview.src = url || 'https://api.dicebear.com/7.x/avataaars/svg?seed=PYXIS';
        }
        el.avatarUrl.addEventListener('input', updateAvatarPreview);
        updateAvatarPreview();

        // 로그 유틸
        function addLog(message, type='system'){
            const t = new Date();
            const hh = String(t.getHours()).padStart(2,'0');
            const mm = String(t.getMinutes()).padStart(2,'0');
            const ts = `${hh}:${mm}`;
            const row = document.createElement('div');
            row.className = `log-entry log-${type}`;
            row.innerHTML = `<span class="log-timestamp">${ts}</span> <span class="log-message">${escapeHtml(message)}</span>`;
            el.log.appendChild(row);
            el.log.scrollTop = el.log.scrollHeight;
        }
        function escapeHtml(s){ const d=document.createElement('div'); d.textContent = String(s ?? ''); return d.innerHTML; }

        // 소켓 연결
        function connect(){
            // eslint-disable-next-line no-undef
            socket = io({transports:['websocket','polling']});

            socket.on('connect', ()=> addLog('서버에 연결됨','system'));
            socket.on('disconnect', ()=> addLog('서버 연결 끊김','system'));

            // 브로드캐스트 대응 (폭넓게)
            socket.on('battle_state', (snap)=> renderFromSnapshot(snap));
            socket.on('battle:event', (payload)=> {
                if(payload?.type==='player_added' && payload?.player){
                    addLog(`플레이어 추가: ${payload.player.name}`,'action');
                }
            });

            // 혹시 다른 이름으로 나갈 수 있어 보강
            socket.on('broadcast:battle_state', renderFromSnapshot);
            socket.on('broadcast:battle_event', (evt)=>{
                if(evt?.event==='player_added' && evt?.player){
                    addLog(`플레이어 추가: ${evt.player.name}`,'action');
                }
            });
        }

        // 전투 스냅샷 반영
        function renderFromSnapshot(snap){
            if(!snap) return;
            // 상태
            if(snap.id){ currentBattleId = snap.id; el.battleId.textContent = currentBattleId; }
            if(snap.status){
                el.battleStatus.textContent = (snap.status==='waiting'?'대기':(snap.status==='ongoing'?'진행중':'종료'));
                el.startBattleBtn.disabled = (snap.status!=='waiting');
                el.stopBattleBtn.disabled  = (snap.status!=='ongoing');
            }
            el.turnCount.textContent = String(snap.currentTurn ?? 0);
            // 팀
            renderRosters(snap.teams?.A||[], snap.teams?.B||[]);
        }

        // 팀 렌더링
        function renderRosters(teamA, teamB){
            function fill(host, arr){
                host.innerHTML = '';
                if(!arr.length){
                    host.innerHTML = '<div class="empty-state">팀원을 추가해주세요</div>';
                    return;
                }
                for(const p of arr){
                    const hpTxt = (typeof p.hp==='number' && typeof p.maxHp==='number') ? `${p.hp}/${p.maxHp}` : (p.hp ?? '-');
                    const stats = p.stats ? `ATK ${p.stats.attack} / DEF ${p.stats.defense} / AGI ${p.stats.agility} / LUK ${p.stats.luck}` : '';
                    const img = p.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(p.name||'player')}`;
                    const item = document.createElement('div');
                    item.className = 'player-item';
                    item.innerHTML = `
                        <img class="player-avatar" src="${img}" alt="">
                        <div class="player-info">
                            <div class="player-name">${escapeHtml(p.name||'플레이어')}</div>
                            <div class="player-stats">HP ${hpTxt} · ${stats}</div>
                        </div>
                    `;
                    host.appendChild(item);
                }
            }
            fill(el.teamAList, teamA);
            fill(el.teamBList, teamB);
            el.teamACount.textContent = `${teamA.length}명`;
            el.teamBCount.textContent = `${teamB.length}명`;
        }

        // 모드 선택
        el.modeBtns.forEach(btn=>{
            btn.addEventListener('click', ()=>{
                el.modeBtns.forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
                currentMode = btn.dataset.mode || '1v1';
            });
        });

        // 전투 생성
        el.createBattleBtn.addEventListener('click', ()=>{
            const battleId = `B_${Date.now().toString(36)}`;
            socket.emit('battle:create', { battleId, mode: currentMode, players: [] }, (res)=>{
                if(!res?.ok){ addLog(`전투 생성 실패: ${res?.error||'unknown'}`, 'system'); return; }
                currentBattleId = battleId;
                adminOtp = res.adminOtp; spectatorOtp = res.spectatorOtp;
                el.battleId.textContent = currentBattleId;
                el.battleStatus.textContent = '대기';
                el.startBattleBtn.disabled = false;
                el.generateLinksBtn.disabled = false;

                addLog(`전투 생성됨 (ID: ${currentBattleId})`, 'system');
            });
        });

        // 링크 생성
        el.generateLinksBtn.addEventListener('click', ()=>{
            if(!currentBattleId){ return; }
            const base = location.origin;
            const adminUrl = `${base}/admin.html?battle=${encodeURIComponent(currentBattleId)}&otp=${encodeURIComponent(adminOtp||'')}`;
            const specUrl  = `${base}/spectator.html?battle=${encodeURIComponent(currentBattleId)}&otp=${encodeURIComponent(spectatorOtp||'')}`;
            el.adminLink.value = adminUrl;
            el.spectatorLink.value = specUrl;
            el.linkSection.style.display = '';
            addLog('접속 링크가 생성되었습니다.','system');
        });

        // 복사
        el.copyBtns.forEach(b=>{
            b.addEventListener('click', ()=>{
                const target = b.getAttribute('data-copy');
                const input = document.querySelector(target);
                if(input){ input.select(); input.setSelectionRange(0,99999); document.execCommand('copy'); addLog('클립보드로 복사됨.','system'); }
            });
        });

        // 전투 시작/종료
        el.startBattleBtn.addEventListener('click', ()=>{
            if(!currentBattleId) return;
            socket.emit('battle:start', { battleId: currentBattleId }, (res)=>{
                if(!res?.ok){ addLog(`전투 시작 실패: ${res?.error||'unknown'}`, 'system'); return; }
                addLog('전투가 시작되었습니다.','system');
                el.battleStatus.textContent = '진행중';
                el.startBattleBtn.disabled = true;
                el.stopBattleBtn.disabled = false;
            });
        });

        el.stopBattleBtn.addEventListener('click', ()=>{
            if(!currentBattleId) return;
            socket.emit('battle:end', { battleId: currentBattleId, reason:'admin_ended' }, (res)=>{
                if(!res?.ok){ addLog(`전투 종료 실패: ${res?.error||'unknown'}`, 'system'); return; }
                addLog('전투가 종료되었습니다.','system');
                el.battleStatus.textContent = '종료';
                el.stopBattleBtn.disabled = true;
            });
        });

        // 관리자 채팅(로그에만 남김 – 필요 시 서버 이벤트 연결 가능)
        el.adminChatSend.addEventListener('click', ()=>{
            const msg = (el.adminChatInput.value||'').trim();
            if(!msg) return;
            addLog(`[관리자] ${msg}`,'action');
            el.adminChatInput.value='';
        });

        // 플레이어 추가
        el.addPlayerBtn.addEventListener('click', ()=>{
            if(!currentBattleId){ addLog('전투를 먼저 생성하세요.','system'); return; }
            const name = (el.playerName.value||'').trim();
            if(!name){ addLog('플레이어 이름을 입력하세요.','system'); return; }
            const team = el.playerTeam.value === 'B' ? 'B' : 'A';

            // UI는 0 허용, 서버는 1~5 → 전송 전 보정
            const atk0 = parseInt(el.statAtk.value,10)||0;
            const def0 = parseInt(el.statDef.value,10)||0;
            const agi0 = parseInt(el.statAgi.value,10)||0;
            const luk0 = parseInt(el.statLuk.value,10)||0;

            const stats = {
                attack: Math.min(5, Math.max(1, atk0)),
                defense: Math.min(5, Math.max(1, def0)),
                agility: Math.min(5, Math.max(1, agi0)),
                luck: Math.min(5, Math.max(1, luk0))
            };

            const items = {
                dittany: parseInt(el.itemDet.value,10)||0,
                attackBoost: parseInt(el.itemAtk.value,10)||0,
                defenseBoost: parseInt(el.itemDef.value,10)||0
            };

            const avatar = (el.avatarUrl.value||'').trim() || null;

            const player = { name, team, stats, hp:100, maxHp:100, items, avatar };

            socket.emit('battle:player:add', { battleId: currentBattleId, player }, (res)=>{
                if(!res?.ok){ addLog(`플레이어 추가 실패: ${res?.error||'unknown'}`, 'system'); return; }
                addLog(`플레이어 추가: ${name} (${team==='A'?'불사조 기사단':'죽음을 먹는 자들'})`,'action');

                // 즉시 스냅샷으로 싱크 (브로드캐스트 의존 + 즉시 반영)
                socket.emit('battle:snapshot', { battleId: currentBattleId }, (snapRes)=>{
                    if(snapRes?.ok) renderFromSnapshot(snapRes.snapshot);
                });

                // 입력 초기화(이름만 비움. 스탯/아이템은 유지해도 됨)
                el.playerName.value = '';
            });
        });

        // 최초 URL 파라미터로 전투 로드(있으면)
        function initFromUrl(){
            const qs = new URLSearchParams(location.search);
            const battle = qs.get('battle');
            if(!battle) return;
            currentBattleId = battle;
            el.battleId.textContent = battle;

            // 스냅샷 로드
            socket.emit('battle:snapshot', { battleId: battle }, (res)=>{
                if(res?.ok){ renderFromSnapshot(res.snapshot); addLog(`전투 로드: ${battle}`,'system'); }
                else { addLog(`전투 로드 실패: ${res?.error||'unknown'}`,'system'); }
            });

            // 링크 생성 버튼 활성화 (OTP는 서버에서 별도 제공 시 업데이트)
            el.generateLinksBtn.disabled = false;
        }

        // 시작
        document.addEventListener('DOMContentLoaded', ()=>{
            connect();
            initFromUrl();
        });
    </script>
</body>
</html>
