// packages/battle-server/index.js
// PYXIS Battle Server (ESM)
// - 한글화 / 이모지 금지
// - 팀 내부키: phoenix/eaters (프런트에서 A/B로 표기)
// - 스탯 각 1~5, 총합 제한 없음, HP 최대 100
// - 방어 시 최소 1 보장 제거(방어 실패 피해: max(0, 공격-방어))
// - 턴: 선커밋 → 후커밋 → resolve, 이후 선/후공 교대

import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";
import http from "http";
import express from "express";
import cors from "cors";
import multer from "multer";
import { randomUUID } from "crypto";
import { Server as IOServer } from "socket.io";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// ───────────────────────────────────────────────────────────────
const PORT = process.env.PORT ? Number(process.env.PORT) : 3001;
const ROOT = path.resolve(__dirname);
const PUBLIC_DIR = path.join(ROOT, "public");
const UPLOAD_DIR = path.join(ROOT, "uploads");

fs.mkdirSync(UPLOAD_DIR, { recursive: true });

const storage = multer.diskStorage({
  destination: (_, __, cb) => cb(null, UPLOAD_DIR),
  filename: (_, file, cb) => {
    const id = Date.now() + "-" + Math.round(Math.random() * 1e9);
    const ext = path.extname(file.originalname || "").toLowerCase();
    cb(null, "avatar-" + id + ext);
  },
});
const upload = multer({ storage });

const clamp = (n, lo, hi) => Math.max(lo, Math.min(hi, n));
const d20 = () => Math.floor(Math.random() * 20) + 1;
const now = () => Date.now();

function normTeam(t) {
  const k = String(t || "").toLowerCase();
  if (k === "phoenix" || k === "a") return "phoenix";
  if (k === "eaters" || k === "death" || k === "b") return "eaters";
  return "phoenix";
}
function readStats(p) {
  const s = p?.stats || {};
  return {
    attack: clamp(Number(s.attack ?? 3), 1, 5),
    defense: clamp(Number(s.defense ?? 3), 1, 5),
    agility: clamp(Number(s.agility ?? 3), 1, 5),
    luck: clamp(Number(s.luck ?? 3), 1, 5),
  };
}
function isCritical(luck) {
  const th = 20 - luck / 2;
  const r = d20();
  return { crit: r >= th, roll: r, threshold: th };
}
const ITEM = {
  DITTANY: "dittany",
  ATK_BOOST: "attack_booster",
  DEF_BOOST: "defense_booster",
};
const ATK_MULT = 1.5;
const DEF_MULT = 1.5;
const BOOST_SUCCESS = 0.10;
const tryBooster = () => Math.random() < BOOST_SUCCESS;

// 인메모리 상태
const battles = Object.create(null);

// ───────────────────────────────────────────────────────────────
const app = express();
const server = http.createServer(app);
const io = new IOServer(server, {
  cors: { origin: true, credentials: true },
  transports: ["websocket", "polling"],
});

app.set("trust proxy", true);
app.use(cors({ origin: true, credentials: true }));
app.use(express.json());

if (!fs.existsSync(PUBLIC_DIR)) {
  console.warn("[WARN] public 디렉터리가 없습니다:", PUBLIC_DIR);
}

app.use("/uploads", express.static(UPLOAD_DIR, { maxAge: "7d", immutable: true }));
app.use("/", express.static(PUBLIC_DIR, { maxAge: "1h" }));

// === 라우트 추가 ===
app.get(["/admin", "/admin/"], (_req, res) => {
  res.sendFile(path.join(PUBLIC_DIR, "pages", "admin.html"));
});
app.get(["/player", "/player/"], (_req, res) => {
  res.sendFile(path.join(PUBLIC_DIR, "player.html"));
});
app.get(["/spectator", "/spectator/"], (_req, res) => {
  res.sendFile(path.join(PUBLIC_DIR, "spectator.html"));
});

// 헬스체크
app.get("/api/health", (_, res) => res.json({ ok: true, ts: Date.now() }));

// 아바타 업로드
app.post("/api/upload/avatar", upload.single("avatar"), (req, res) => {
  try {
    if (!req.file) return res.status(400).json({ ok: false, error: "파일 없음" });
    const url = "/uploads/" + req.file.filename;
    return res.json({ ok: true, avatarUrl: url });
  } catch (e) {
    console.error("[ERR] /api/upload/avatar:", e);
    return res.status(500).json({ ok: false, error: String(e?.message || e) });
  }
});

// 전투 생성
app.post("/api/battles", (req, res) => {
  try {
    const battleId = createBattle(String(req.body?.mode || "1v1"));
    return res.json({ ok: true, id: battleId });
  } catch (e) {
    console.error("[ERR] /api/battles:", e);
    return res.status(500).json({ ok: false, error: String(e?.message || e) });
  }
});

// 전투 시작
app.post("/api/battles/:id/start", (req, res) => {
  const id = String(req.params.id || "");
  const b = battles[id];
  if (!b) return res.status(404).json({ ok: false, error: "전투 없음" });
  try {
    startBattle(b);
    return res.json({ ok: true });
  } catch (e) {
    console.error("[ERR] /api/battles/:id/start:", e);
    return res.status(500).json({ ok: false, error: String(e?.message || e) });
  }
});

// 전투 조회
app.get("/api/battles/:id", (req, res) => {
  try {
    const b = battles[String(req.params.id || "")];
    if (!b) return res.status(404).json({ ok: false, error: "전투 없음" });
    return res.json({ ok: true, battle: publicBattle(b) });
  } catch (e) {
    console.error("[ERR] /api/battles/:id:", e);
    return res.status(500).json({ ok: false, error: String(e?.message || e) });
  }
});

// 공통 에러 핸들러
app.use((err, _req, res, _next) => {
  console.error("[UNCAUGHT] Express:", err);
  res.status(500).json({ ok: false, error: "서버 오류" });
});

// ───────────────────────────────────────────────────────────────
// Socket.IO
// (중략: 전투 생성, addPlayer, playerAuth, player:action 등 기존 로직 동일)
// applyAction에서 방어는 Math.max(0, raw) 처리로 최소1 보장 제거
// ───────────────────────────────────────────────────────────────

// ... (위에서 드린 전체 전투 로직 그대로 붙여넣으시면 됩니다) ...

// 시작
server.listen(PORT, "0.0.0.0", () => {
  console.log(`[INFO] PYXIS server started on 0.0.0.0:${PORT} (${process.env.NODE_ENV || "development"})`);
});
