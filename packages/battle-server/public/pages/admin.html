<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>PYXIS 관리자</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=Cinzel:wght@700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0f1a; --surface:#121820; --fg:#e9e4d7; --muted:#cdbfa5;
  --gold:#d4ba8d; --line:rgba(220,199,162,.22);
  --radius:12px; --shadow:0 8px 20px rgba(0,0,0,.35);
}
html,body{margin:0;height:100%;background:var(--bg);color:var(--fg)}
body{font-family:Inter,ui-sans-serif,system-ui}
.wrap{max-width:1200px;margin:0 auto;padding:16px;display:flex;flex-direction:column;gap:12px}
.top{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--line);border-radius:var(--radius);padding:10px 12px;background:linear-gradient(180deg,rgba(212,186,141,.12),transparent)}
h1{font-family:'Playfair Display',serif;font-size:18px;margin:0}
.meta{font-size:12px;color:var(--muted)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.col{background:var(--surface);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);display:flex;flex-direction:column;min-height:0}
.col-header{padding:10px 12px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;background:linear-gradient(180deg,rgba(212,186,141,.08),transparent)}
.col-header h2{font-size:14px;margin:0}
.section{padding:10px;display:flex;flex-direction:column;gap:10px}
.table{width:100%;border-collapse:collapse;font-size:13px}
.table th,.table td{border-bottom:1px solid var(--line);padding:6px 8px;text-align:left}
.controls{display:flex;gap:6px}
.btn{border:1px solid var(--line);background:#131b25;color:var(--fg);padding:8px 10px;border-radius:10px;cursor:pointer;font-size:13px}
.btn:hover{border-color:var(--gold)}
.inp{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#0f1620;color:var(--fg);font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h1>PYXIS 관리자</h1>
    <div class="meta">전투 <b id="bid">-</b> · 상태 <b id="status">-</b> · 라운드 <b id="round">1</b> · 페이즈팀 <b id="phaseTeam">A</b></div>
  </div>

  <div class="grid">
    <div class="col">
      <div class="col-header"><h2>전투 제어</h2></div>
      <div class="section">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <div>
            <label>관리자 토큰</label>
            <input id="adminToken" class="inp" placeholder="관리자 토큰">
          </div>
          <div>
            <label>전투 ID</label>
            <input id="battle" class="inp" placeholder="전투 ID">
          </div>
        </div>
        <div class="controls">
          <button class="btn" id="auth">접속</button>
          <button class="btn" id="start">시작</button>
          <button class="btn" id="pause">일시정지</button>
          <button class="btn" id="resume">재개</button>
          <button class="btn" id="end">종료</button>
        </div>
      </div>

      <div class="col-header"><h2>OTP</h2></div>
      <div class="section" style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div><label>플레이어 OTP</label><input id="otpPlayer" class="inp" placeholder="플레이어 OTP"></div>
        <div><label>관전자 OTP</label><input id="otpSpectator" class="inp" placeholder="관전자 OTP"></div>
      </div>
      <div class="section">
        <div class="meta">플레이어/관전자에게 해당 OTP를 전달하세요.</div>
      </div>
    </div>

    <div class="col">
      <div class="col-header"><h2>참가자</h2></div>
      <div class="section">
        <table class="table" id="tbl">
          <thead><tr><th>이름</th><th>팀</th><th>HP</th><th>준비</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="col-header"><h2>로그</h2></div>
      <div class="section" id="log" style="max-height:240px;overflow:auto"></div>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
let ioSock=null, battleId='', adminName='관리자';
const $=s=>document.querySelector(s), el=(t,c)=>{const n=document.createElement(t); if(c) n.className=c; return n;}

function render(state){
  if(!state) return;
  $('#bid').textContent = state.id || '-';
  $('#status').textContent = state.status || '-';
  $('#round').textContent = state.round || 1;
  $('#phaseTeam').textContent = state.phaseTeam || 'A';
  const tb = document.querySelector('#tbl tbody'); tb.innerHTML='';
  const A = (state.teams?.A?.players)||[];
  const B = (state.teams?.B?.players)||[];
  [...A, ...B].forEach(p=>{
    const tr = el('tr');
    tr.innerHTML = `<td>${p.name}</td><td>${p.team||'-'}</td><td>${p.hp}</td><td>${p.ready?'예':'아니오'}</td>`;
    tb.append(tr);
  });
  if (state.lastEvent) {
    const r = el('div'); r.textContent = state.lastEvent;
    const L = $('#log'); L.append(r); L.scrollTop = L.scrollHeight;
  }
}

function connect(){
  ioSock = io({ transports:['websocket'] });
  ioSock.on('connect', ()=>{
    battleId = $('#battle').value.trim();
    ioSock.emit('adminAuth', { battleId, token: $('#adminToken').value.trim(), name: adminName });
  });
  ioSock.on('authSuccess', ()=>{});
  ioSock.on('authError', e=> alert(e?.message||'인증 실패'));
  ioSock.on('battleUpdate', render);

  // 버튼
  $('#start').addEventListener('click', ()=> ioSock?.emit('adminStart',{ battleId }) );
  $('#pause').addEventListener('click', ()=> ioSock?.emit('adminPause',{ battleId }) );
  $('#resume').addEventListener('click', ()=> ioSock?.emit('adminResume',{ battleId }) );
  $('#end').addEventListener('click', ()=> ioSock?.emit('adminEnd',{ battleId }) );
}

document.getElementById('auth').addEventListener('click', ()=>{
  if(!$('#adminToken').value.trim() || !$('#battle').value.trim()){
    alert('전투 ID와 관리자 토큰을 입력하세요'); return;
  }
  connect();
});
</script>
</body>
</html>
