<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>PYXIS Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=Cinzel:wght@700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
  :root{
    --gold-1:#DCC7A2; --gold-2:#D4BA8D;
    --navy-1:#00080D; --navy-2:#001E35;
    --ink:#EEE6D6; --ink-dim:#BEB49A;
    --border-subtle:rgba(220,199,162,.16);
    --border-bright:rgba(220,199,162,.36);
    --panel-2:rgba(0,30,53,.45); --panel-3:rgba(0,35,65,.60);
    --r-sm:10px; --r-md:14px; --r-lg:18px;
    --shadow-soft:0 10px 24px rgba(0,0,0,.35);
    --shadow-lift:0 14px 32px rgba(0,0,0,.45);
    --glow-gold:0 0 22px rgba(220,199,162,.25);
    --blur:blur(10px);
    --t-fast:.18s; --t-slow:14s;
    --danger:#F06A6A; --ok:#46c37b;
  }
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family: Inter, system-ui, "Noto Sans KR", sans-serif;
    background:
      radial-gradient(1200px 900px at 50% -220px, rgba(220,199,162,.10), transparent 60%),
      linear-gradient(180deg, #02060A 0%, #020812 30%, #030B18 60%, #030C1E 100%);
  }
  .header{
    position:relative; overflow:hidden; padding:48px 20px 32px;
    border-bottom:1px solid var(--border-subtle);
    background:linear-gradient(120deg, rgba(220,199,162,.07), rgba(0,30,53,.25)); isolation:isolate;
  }
  .header::before{
    content:""; position:absolute; inset:-60% -20% auto -20%; height:140%;
    background:conic-gradient(from 0deg, rgba(220,199,162,.18), rgba(0,30,53,0) 42%, rgba(220,199,162,.18) 70%, rgba(0,30,53,0));
    filter:blur(26px); animation:spin var(--t-slow) linear infinite; z-index:-1;
  }
  @keyframes spin{to{transform:rotate(360deg)}}
  .brand{display:flex; align-items:flex-end; gap:12px;}
  .brand-title{
    font-family: Cinzel, serif; font-weight:800; letter-spacing:.12em; font-size:28px;
    background:linear-gradient(90deg, var(--gold-1), var(--gold-2));
    -webkit-background-clip:text; background-clip:text; color:transparent;
    position:relative; padding-right:28px;
  }
  .brand-title::before,.brand-title::after{
    position:absolute; color:var(--gold-1); opacity:.65; font-family:"Times New Roman", serif; line-height:1;
    animation:twinkle 2.2s ease-in-out infinite;
  }
  .brand-title::before{content:"✦"; right:12px; top:-6px; animation-delay:.2s;}
  .brand-title::after{content:"✧"; right:-2px; top:-2px; animation-delay:1.2s;}
  @keyframes twinkle{0%,100%{opacity:.15;transform:scale(.8)}50%{opacity:1;transform:scale(1)}}
  .brand-sub{font-family:Playfair Display, serif; font-size:14px; letter-spacing:.18em; color:var(--ink-dim); transform:translateY(2px);}

  .container{max-width:1220px; margin:0 auto; padding:20px;}
  .grid{display:grid; gap:20px; grid-template-columns:1.2fr 1.2fr 1fr;}
  @media(max-width:1080px){.grid{grid-template-columns:1fr}}

  .card{
    background:linear-gradient(180deg, var(--panel-2), var(--panel-3));
    border:1px solid var(--border-subtle); border-top-color:rgba(220,199,162,.35);
    border-radius:var(--r-md); padding:18px; box-shadow:var(--shadow-soft);
    backdrop-filter:var(--blur); -webkit-backdrop-filter:var(--blur);
    transition:transform var(--t-fast) ease;
  }
  .card:hover{transform:translateY(-2px)}
  .title{display:flex; align-items:center; justify-content:space-between; color:var(--gold-1); font-family:Playfair Display, serif; letter-spacing:.06em; font-size:18px; margin:0 0 12px;}
  .pill{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border-bright); color:var(--ink-dim);
    background:linear-gradient(180deg, rgba(0,30,53,.55), rgba(0,30,53,.8));}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

  /* Inputs (다크 셀렉트 포함) */
  .label{font-size:12px; color:var(--ink-dim); margin:2px 2px 4px}
  .input,.select,.file,textarea{
    width:100%; min-width:0; padding:10px 12px; border-radius:10px;
    border:1px solid var(--border-subtle);
    background:linear-gradient(180deg, rgba(0,30,53,.4), rgba(0,30,53,.7));
    color:var(--ink); outline:none; appearance:none;
  }
  .input::placeholder{color:rgba(238,230,214,.55)}
  .input:focus,.select:focus,.file:focus,textarea:focus{border-color:var(--gold-1); box-shadow:0 0 0 3px rgba(220,199,162,.18)}
  .select{
    background-color:rgba(0,30,53,.7);
    background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' fill='%23DCC7A2' viewBox='0 0 24 24'><path d='M7 10l5 5 5-5z'/></svg>");
    background-repeat:no-repeat; background-position:right 10px center; background-size:18px;
    padding-right:36px; cursor:pointer;
  }
  select option{
    background:#071320; color:#EEE6D6;
  }
  .btn{
    appearance:none; border:1px solid var(--border-bright);
    background:linear-gradient(135deg, rgba(0,30,53,.55), rgba(0,30,53,.75)) padding-box,
               linear-gradient(135deg, var(--gold-1), var(--gold-2)) border-box;
    color:var(--gold-1); border-radius:10px; padding:10px 14px; font-weight:600; letter-spacing:.04em;
    position:relative; overflow:hidden; transition:transform .18s ease, box-shadow .18s ease; box-shadow:var(--shadow-soft);
  }
  .btn:hover{transform:translateY(-2px); box-shadow:var(--shadow-lift), var(--glow-gold)}
  .btn:active{transform:translateY(0)}
  .btn[disabled]{opacity:.55; cursor:not-allowed}

  .btn.shimmer::after{content:""; position:absolute; inset:0;
    background:linear-gradient(110deg, transparent 0%, rgba(255,255,255,.18) 45%, transparent 55%);
    transform:translateX(-100%); transition:transform .7s ease;}
  .btn.shimmer:hover::after{transform:translateX(100%)}

  .muted{color:var(--ink-dim); font-size:12px}
  .copy-grid{display:grid; gap:8px; grid-template-columns:1fr auto}
  .teams{display:grid; gap:12px; grid-template-columns:1fr 1fr}
  @media(max-width:720px){.teams{grid-template-columns:1fr}}
  .team{background:linear-gradient(180deg, rgba(0,30,53,.35), rgba(0,30,53,.6)); border:1px solid var(--border-subtle); border-radius:10px; padding:10px}
  .team-head{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; color:var(--gold-1); font-weight:700; letter-spacing:.05em}
  .players{display:grid; gap:8px}
  .player{display:grid; grid-template-columns:48px 1fr auto; gap:10px; align-items:center; background:linear-gradient(180deg, rgba(0,30,53,.35), rgba(0,30,53,.55)); border:1px solid var(--border-subtle); border-radius:10px; padding:8px}
  .avatar{width:48px; height:48px; border-radius:8px; object-fit:cover; border:1px solid var(--border-bright); background:rgba(0,0,0,.2)}
  .p-name{font-weight:700; letter-spacing:.02em}
  .p-meta{font-size:12px; color:var(--ink-dim)}
  .log{height:360px; overflow:auto; border:1px solid var(--border-subtle); border-radius:10px; padding:10px; background:linear-gradient(180deg, rgba(0,30,53,.35), rgba(0,30,53,.65))}
  .log-entry{font-size:13px; color:var(--ink); opacity:.92; border-bottom:1px dashed rgba(220,199,162,.12); padding:6px 2px}
  .log-entry .ts{color:var(--ink-dim); font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; margin-right:8px}
  .log::-webkit-scrollbar{width:10px}
  .log::-webkit-scrollbar-thumb{background:linear-gradient(180deg, var(--gold-2), var(--gold-1)); border-radius:8px}
  .log::-webkit-scrollbar-track{background:rgba(0,0,0,.2)}

  .error{color:var(--danger); font-size:12px}
  .ok{color:var(--ok); font-size:12px}
  .otp-list{display:grid; gap:6px; margin-top:6px}
  .otp-row{display:grid; grid-template-columns:1fr auto; gap:8px}
  </style>
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="brand">
        <div class="brand-title">PYXIS</div>
        <div class="brand-sub">BATTLE ADMIN CONSOLE</div>
      </div>
      <div class="row" style="margin-top:16px">
        <button id="btnCreate" class="btn shimmer">전투 생성</button>
        <button id="btnStart" class="btn">시작</button>
        <button id="btnPause" class="btn">일시정지</button>
        <button id="btnEnd" class="btn">종료</button>
        <span class="pill" id="statusPill">대기</span>
        <span class="pill" id="idPill">ID: -</span>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="grid">

      <!-- A: Battle / Links / OTP -->
      <section class="card">
        <h2 class="title">전투 설정 <span class="pill">모드</span></h2>
        <div class="row" style="margin-bottom:10px">
          <label class="label" for="mode">전투 모드</label>
          <select id="mode" class="select" style="max-width:200px">
            <option value="1v1">1v1</option>
            <option value="2v2" selected>2v2</option>
            <option value="3v3">3v3</option>
            <option value="4v4">4v4</option>
          </select>
          <button id="btnApplyMode" class="btn">모드 적용</button>
        </div>

        <h3 class="title" style="margin-top:6px">링크 생성 <span class="pill">복사</span></h3>
        <div class="copy-grid">
          <input id="adminLink" class="input" placeholder="관리자 URL" readonly>
          <button class="btn shimmer" data-copy="#adminLink">복사</button>
        </div>
        <div class="copy-grid" style="margin-top:8px">
          <input id="playerLink" class="input" placeholder="전투참가자 URL (비밀번호 치환 필요)" readonly>
          <button class="btn shimmer" data-copy="#playerLink">복사</button>
        </div>
        <div class="copy-grid" style="margin-top:8px">
          <input id="spectatorLink" class="input" placeholder="관전자 URL (비밀번호 포함)" readonly>
          <button class="btn shimmer" data-copy="#spectatorLink">복사</button>
        </div>
        <p class="muted" style="margin-top:4px">player URL의 <code>{playerOtp}</code> 부분은 발급된 비밀번호로 치환하세요.</p>

        <h3 class="title" style="margin-top:14px">비밀번호 발급 <span class="pill">전투참가자/관전자</span></h3>
        <div class="row">
          <label class="label" for="otpRole">역할</label>
          <select id="otpRole" class="select" style="max-width:200px">
            <option value="player">전투참가자</option>
            <option value="spectator">관전자</option>
          </select>
          <label class="label" for="otpCount">수량</label>
          <input id="otpCount" class="input" type="number" min="1" max="100" value="1" style="max-width:120px">
          <button id="btnIssueOtp" class="btn">발급</button>
        </div>
        <div id="otpMsg" class="muted" style="margin-top:6px"></div>
        <div id="otpList" class="otp-list"></div>
      </section>

      <!-- B: Player management -->
      <section class="card">
        <h2 class="title">참가자 관리 <span class="pill">추가 / 목록</span></h2>
        <div class="row">
          <label class="label" for="pName">전투참가자 이름</label>
          <input id="pName" class="input" placeholder="전투참가자 이름" maxlength="20">
          <label class="label" for="pTeam">팀</label>
          <select id="pTeam" class="select" style="max-width:200px">
            <option value="A">불사조 기사단</option>
            <option value="B">죽음을 먹는 자들</option>
          </select>
          <button id="btnAdd" class="btn shimmer">추가</button>
        </div>

        <div class="row" style="margin-top:4px"><span class="label">아바타</span></div>
        <div class="row">
          <input id="pAvatarUrl" class="input" placeholder="https://example.com/image.png">
        </div>
        <div class="row">
          <input id="pAvatarFile" class="file" type="file" accept="image/*">
          <button id="btnUploadAvatar" class="btn">업로드</button>
          <span id="uploadMsg" class="muted"></span>
        </div>
        <div class="row"><img id="avatarPreview" class="avatar" alt="preview" style="width:48px;height:48px;border-radius:8px;border:1px solid var(--border-bright);object-fit:cover"></div>

        <div class="row" style="margin-top:6px"><span class="label">스탯 (0~5, 전송 시 0은 서버에서 1로 보정)</span></div>
        <div class="row">
          <label class="label" for="sAtk" style="min-width:60px">공격</label>
          <input id="sAtk" class="input" type="number" min="0" max="5" value="0" placeholder="공격" style="max-width:100px">
          <label class="label" for="sDef" style="min-width:60px">방어</label>
          <input id="sDef" class="input" type="number" min="0" max="5" value="0" placeholder="방어" style="max-width:100px">
          <label class="label" for="sAgi" style="min-width:60px">민첩</label>
          <input id="sAgi" class="input" type="number" min="0" max="5" value="0" placeholder="민첩" style="max-width:100px">
          <label class="label" for="sLuk" style="min-width:60px">행운</label>
          <input id="sLuk" class="input" type="number" min="0" max="5" value="0" placeholder="행운" style="max-width:100px">
        </div>

        <div class="row" style="margin-top:6px"><span class="label">아이템 (0~9)</span></div>
        <div class="row">
          <label class="label" for="iDet" style="min-width:88px">디터니</label>
          <input id="iDet"  class="input" type="number" min="0" max="9" value="0" placeholder="디터니" style="max-width:100px">
          <label class="label" for="iAtkB" style="min-width:88px">공격 보정기</label>
          <input id="iAtkB" class="input" type="number" min="0" max="9" value="0" placeholder="공격 보정기" style="max-width:110px">
          <label class="label" for="iDefB" style="min-width:88px">방어 보정기</label>
          <input id="iDefB" class="input" type="number" min="0" max="9" value="0" placeholder="방어 보정기" style="max-width:110px">
        </div>

        <div class="teams" style="margin-top:14px">
          <div class="team">
            <div class="team-head"><div>불사조 기사단</div><div id="teamACount" class="muted">0명</div></div>
            <div id="teamA" class="players"><div class="muted">팀원을 추가해주세요</div></div>
          </div>
          <div class="team">
            <div class="team-head"><div>죽음을 먹는 자들</div><div id="teamBCount" class="muted">0명</div></div>
            <div id="teamB" class="players"><div class="muted">팀원을 추가해주세요</div></div>
          </div>
        </div>
      </section>

      <!-- C: Status / Log / Chat -->
      <section class="card">
        <h2 class="title">진행 상황 <span class="pill" id="turnPill">턴: -</span></h2>
        <div class="row"><div id="statusBoard" class="input" style="height:44px; display:flex; align-items:center">상태 정보가 여기에 표시됩니다</div></div>
        <label class="label" style="margin-top:6px">실시간 로그</label>
        <div id="log" class="log"></div>
        <div class="row" style="margin-top:10px">
          <input id="chatInput" class="input" placeholder="운영자 채팅 입력">
          <button id="btnChat" class="btn">전송</button>
        </div>
      </section>

    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
  (function(){
    "use strict";
    const $  = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));

    let battleId = null;
    let adminToken = null;
    let socket = null;

    // 버튼
    $("#btnCreate").addEventListener("click", createBattle);
    $("#btnStart").addEventListener("click", ()=>postAdmin("/start"));
    $("#btnPause").addEventListener("click", ()=>postAdmin("/pause"));
    $("#btnEnd").addEventListener("click",   ()=>postAdmin("/end"));
    $("#btnApplyMode").addEventListener("click", refreshState);
    $("#btnAdd").addEventListener("click", addPlayer);
    $("#btnChat").addEventListener("click", sendChat);
    $("#btnUploadAvatar").addEventListener("click", uploadAvatar);
    $("#btnIssueOtp").addEventListener("click", issueOtp);

    // 복사
    $$("[data-copy]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const sel = btn.getAttribute("data-copy");
        const inp = document.querySelector(sel);
        if(!inp) return;
        inp.select?.();
        navigator.clipboard.writeText(inp.value || "");
        btn.classList.add("shimmer"); setTimeout(()=>btn.classList.remove("shimmer"), 700);
      });
    });

    async function createBattle(){
      try{
        toggleBtn("#btnCreate", true, "생성 중…");
        const mode = $("#mode").value;
        const r = await fetch("/api/battles", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ mode }) });
        const d = await r.json();
        if(!r.ok){ alert("전투 생성 실패"); return; }
        battleId = d.id; adminToken = d.token;
        $("#idPill").textContent = "ID: " + battleId;
        $("#statusPill").textContent = d.battle?.status || "대기";
        connectSocket();
        await generateLinks();
        await refreshState();
        addLogLine("system", "전투가 생성되었습니다.");
      }catch(e){
        alert("전투 생성 실패: " + (e?.message||e));
      }finally{
        toggleBtn("#btnCreate", false, "전투 생성");
      }
    }

    function connectSocket(){
      if(socket) socket.disconnect();
      socket = io();
      socket.on("connect", ()=>{
        if(!battleId || !adminToken) return;
        socket.emit("adminAuth", { battleId, token: adminToken });
        socket.emit("admin:requestState", { battleId });
      });
      socket.on("authSuccess", ({ battle })=>{ if(battle) renderAll(battle); });
      socket.on("battleUpdate", (battle)=> renderAll(battle));
      socket.on("chatMessage", ({ sender, message })=> addLogLine("chat", sender + ": " + String(message||"").slice(0,500)));
      socket.on("authError", (e)=> addLogLine("system", "인증 실패: " + (e?.error||"unknown")));
    }

    async function refreshState(){
      if(!battleId) return;
      try{
        const r = await fetch(`/api/battles/${encodeURIComponent(battleId)}`);
        if(!r.ok) return;
        renderAll(await r.json());
      }catch(_){}
    }

    async function postAdmin(suffix){
      if(!battleId) return;
      try{
        toggleBtn("#btnStart", true);
        toggleBtn("#btnPause", true);
        toggleBtn("#btnEnd", true);
        const r = await fetch(`/api/admin/battles/${encodeURIComponent(battleId)}${suffix}`, { method:"POST" });
        if(r.ok){
          const d = await r.json().catch(()=>({}));
          if(d?.battle) renderAll(d.battle); else await refreshState();
        }else{
          alert("요청 실패");
        }
      }catch(e){
        alert("요청 실패: " + (e?.message||e));
      }finally{
        toggleBtn("#btnStart", false, "시작");
        toggleBtn("#btnPause", false, "일시정지");
        toggleBtn("#btnEnd", false, "종료");
      }
    }

    async function generateLinks(){
      if(!battleId) return;
      try{
        const r = await fetch(`/api/admin/battles/${encodeURIComponent(battleId)}/links`, { method:"POST" });
        const d = await r.json();
        $("#adminLink").value = d.admin || "";
        $("#playerLink").value = d.player || "";
        $("#spectatorLink").value = d.spectator || "";
      }catch(e){
        addLogLine("system", "링크 생성 실패: " + (e?.message||e));
      }
    }

    async function issueOtp(){
      if(!battleId){ alert("전투를 먼저 생성하세요."); return; }
      const role = $("#otpRole").value; // "player" | "spectator"
      let count = Number($("#otpCount").value || 1);
      if(role === "spectator") count = 1; // 서버도 1개만 발급하지만 안전장치
      $("#otpMsg").textContent = "";
      toggleBtn("#btnIssueOtp", true, "발급 중…");
      $("#otpList").innerHTML = "";
      try{
        const r = await fetch(`/api/admin/battles/${encodeURIComponent(battleId)}/otp`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ role, count })
        });
        const d = await r.json();
        if(!r.ok || d?.ok === false){
          $("#otpMsg").innerHTML = `<span class="error">발급 실패: ${(d?.error||"서버 오류")}</span>`;
          return;
        }
        const otps = d.otps || [];
        if(!otps.length){
          $("#otpMsg").innerHTML = `<span class="error">발급 결과가 비어 있습니다.</span>`;
          return;
        }
        $("#otpMsg").innerHTML = `<span class="${role==='player'?'ok':'ok'}">발급 성공: ${role==='player'?otps.length:1}건</span>`;
        const list = $("#otpList");
        otps.forEach(code=>{
          const row = document.createElement("div");
          row.className = "otp-row";
          const inp = document.createElement("input");
          inp.className = "input";
          inp.readOnly = true;
          inp.value = code;
          const btn = document.createElement("button");
          btn.className = "btn";
          btn.textContent = "복사";
          btn.addEventListener("click", ()=>{
            inp.select?.();
            navigator.clipboard.writeText(code);
            btn.classList.add("shimmer"); setTimeout(()=>btn.classList.remove("shimmer"), 700);
          });
          row.appendChild(inp); row.appendChild(btn);
          list.appendChild(row);
        });
      }catch(e){
        $("#otpMsg").innerHTML = `<span class="error">발급 실패: ${(e?.message||e)}</span>`;
      }finally{
        toggleBtn("#btnIssueOtp", false, "발급");
      }
    }

    async function addPlayer(){
      if(!battleId) return;
      const name = $("#pName").value.trim();
      if(!name){ alert("전투참가자 이름을 입력하세요."); return; }
      const team = $("#pTeam").value;

      const stats = {
        atk: clamp($("#sAtk").value, 0, 5),
        def: clamp($("#sDef").value, 0, 5),
        agi: clamp($("#sAgi").value, 0, 5),
        luk: clamp($("#sLuk").value, 0, 5),
      };

      const items = [];
      const det = Number($("#iDet").value||0);
      const ab  = Number($("#iAtkB").value||0);
      const db  = Number($("#iDefB").value||0);
      for(let i=0;i<det;i++) items.push("heal10");
      for(let i=0;i<ab;i++)  items.push("atkBoost");
      for(let i=0;i<db;i++)  items.push("defBoost");

      const avatar = $("#pAvatarUrl").value.trim();

      try{
        toggleBtn("#btnAdd", true, "추가 중…");
        const r = await fetch(`/api/battles/${encodeURIComponent(battleId)}/players`, {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ name, team, stats, items, avatar })
        });
        if(!r.ok){
          const e = await r.json().catch(()=>({}));
          alert("추가 실패: " + (e?.error||"server"));
          return;
        }
        await refreshState();
        $("#pName").value = "";
      }catch(e){
        alert("추가 실패: " + (e?.message||e));
      }finally{
        toggleBtn("#btnAdd", false, "추가");
      }
    }

    async function uploadAvatar(){
      if(!battleId){ alert("전투를 먼저 생성하세요."); return; }
      const f = $("#pAvatarFile").files?.[0];
      if(!f){ $("#uploadMsg").textContent = "이미지 파일을 선택하세요."; return; }
      const fd = new FormData();
      fd.append("avatar", f);
      try{
        toggleBtn("#btnUploadAvatar", true, "업로드 중…");
        const r = await fetch(`/api/battles/${encodeURIComponent(battleId)}/avatar`, { method:"POST", body: fd });
        if(!r.ok){ $("#uploadMsg").textContent = "업로드 실패"; return; }
        const d = await r.json().catch(()=>({}));
        const url = d?.url || "";
        $("#pAvatarUrl").value = url;
        const pv = $("#avatarPreview"); if(pv && url) pv.src = url;
        $("#uploadMsg").textContent = url ? "업로드 성공" : "업로드 완료";
      }catch(e){
        $("#uploadMsg").textContent = "업로드 에러: " + (e?.message||e);
      }finally{
        toggleBtn("#btnUploadAvatar", false, "업로드");
      }
    }

    function sendChat(){
      if(!socket || !battleId) return;
      const msg = $("#chatInput").value; if(!msg) return;
      socket.emit("chatMessage", { role:"admin", message: msg, battleId });
      $("#chatInput").value = "";
    }

    function renderAll(b){
      $("#statusPill").textContent = b.status || "대기";
      $("#idPill").textContent = "ID: " + (b.id || "-");
      $("#turnPill").textContent = "턴: " + (b.turn?.current ? 1 : "-");

      const log = $("#log"); log.innerHTML = "";
      (b.log || []).slice(-200).reverse().forEach(line=>{
        const el = document.createElement("div");
        el.className = "log-entry";
        const ts = new Date(line.t || Date.now()).toLocaleTimeString();
        el.innerHTML = `<span class="ts">[${ts}]</span>${escapeHtml(line.message||"")}`;
        log.appendChild(el);
      });

      const a = (b.players||[]).filter(p=>p.team==="phoenix");
      const e = (b.players||[]).filter(p=>p.team==="eaters");
      renderTeam("#teamA", "#teamACount", a);
      renderTeam("#teamB", "#teamBCount", e);
    }

    function renderTeam(listSel, countSel, arr){
      const list = $(listSel), count = $(countSel);
      list.innerHTML = "";
      if(!arr.length){
        const d=document.createElement("div"); d.className="muted"; d.textContent="팀원을 추가해주세요"; list.appendChild(d);
      }else{
        arr.forEach(p=>{
          const item=document.createElement("div"); item.className="player";
          const img=document.createElement("img"); img.className="avatar"; img.src=p.avatar||""; img.alt=p.name||"avatar";
          const meta=document.createElement("div");
          const name=document.createElement("div"); name.className="p-name"; name.textContent=p.name||"";
          const sub=document.createElement("div"); sub.className="p-meta";
          sub.textContent=`ATK ${p.stats?.atk ?? "-"}  DEF ${p.stats?.def ?? "-"}  AGI ${p.stats?.agi ?? "-"}  LUK ${p.stats?.luk ?? "-"}`;
          meta.appendChild(name); meta.appendChild(sub);
          const right=document.createElement("div"); right.className="p-meta"; right.textContent = p.team === "phoenix" ? "A" : "B";
          item.appendChild(img); item.appendChild(meta); item.appendChild(right);
          list.appendChild(item);
        });
      }
      if(count) count.textContent = (arr.length||0) + "명";
    }

    function clamp(v, min, max){
      const n = Number(v||0);
      if(Number.isNaN(n)) return min;
      return Math.max(min, Math.min(max, n));
    }

    function toggleBtn(sel, on, text){
      const b = $(sel); if(!b) return;
      b.disabled = !!on;
      if(typeof text === "string") b.textContent = text;
    }

    function addLogLine(_type, text){
      const log = $("#log");
      const el = document.createElement("div");
      el.className = "log-entry";
      const ts = new Date().toLocaleTimeString();
      el.innerHTML = `<span class="ts">[${ts}]</span>${escapeHtml(text||"")}`;
      log.prepend(el);
    }

    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }

    // 페이지에 battle, token 쿼리로 들어온 경우 자동 연결
    (function autoFromQuery(){
      const qs = new URLSearchParams(location.search);
      const b = qs.get("battle");
      const t = qs.get("token");
      if(b && t){
        battleId = b; adminToken = t;
        $("#idPill").textContent = "ID: " + battleId;
        connectSocket();
        refreshState();
        generateLinks();
      }
    })();

  })();
  </script>
</body>
</html>
