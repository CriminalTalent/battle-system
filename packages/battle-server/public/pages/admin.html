<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>PYXIS Admin – All-in-One</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts: Playfair Display(헤드라인), Cinzel(브랜딩), Inter(본문) -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600;700;800&family=Cinzel:wght@600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
  /* =========================================================
     PYXIS Admin (Design-included, no functional change)
     - Colors per spec:
       Gold1 #DCC7A2 / Navy1 #00080D
       Gold2 #D4BA8D / Navy2 #001E35
     - Glassmorphism cards, twinkle stars, rotating gradient header,
       shimmer buttons, hover lift, responsive grid, custom scrollbar.
     ========================================================= */

  :root{
    /* Core palette */
    --gold-1:#DCC7A2;  /* primary gold */
    --gold-2:#D4BA8D;  /* secondary gold */
    --navy-1:#00080D;  /* primary navy */
    --navy-2:#001E35;  /* secondary navy */

    /* Surfaces */
    --panel-1:rgba(0,24,53,0.30);
    --panel-2:rgba(0,30,53,0.45);
    --panel-3:rgba(0,35,65,0.60);

    /* Ink */
    --ink:#EEE6D6;
    --ink-dim:#BEB49A;

    /* Borders / lines */
    --border-subtle:rgba(220,199,162,0.16);
    --border-bright:rgba(220,199,162,0.36);

    /* State colors */
    --success:#3a8e5a;
    --warning:#e0a13a;
    --danger:#b14b4b;

    /* Spaces & radii */
    --space-2:8px;
    --space-3:12px;
    --space-4:16px;
    --space-5:20px;
    --space-6:24px;

    --r-sm:10px;
    --r-md:14px;
    --r-lg:18px;

    /* Shadows & blur */
    --shadow-soft:0 10px 24px rgba(0,0,0,.35);
    --shadow-lift:0 14px 32px rgba(0,0,0,.45);
    --glow-gold:0 0 22px rgba(220,199,162,.25);
    --blur:blur(10px);

    /* Animation */
    --dur-fast:.18s;
    --dur-med:.35s;
    --dur-slow:14s;
  }

  /* Page background with subtle vignette */
  html,body{height:100%}
  body{
    margin:0;
    font-family: Inter, system-ui, -apple-system, "Noto Sans KR", sans-serif;
    color:var(--ink);
    background:
      radial-gradient(1200px 900px at 50% -220px, rgba(220,199,162,.10), transparent 60%),
      linear-gradient(180deg, #02060A 0%, #020812 30%, #030B18 60%, #030C1E 100%);
  }

  /* Rotating gradient header */
  .app-header{
    position:relative;
    overflow:hidden;
    padding:48px 20px 32px;
    border-bottom:1px solid var(--border-subtle);
    background:linear-gradient(120deg, rgba(220,199,162,.07), rgba(0,30,53,.25));
    isolation:isolate;
  }
  .app-header::before{
    /* rotating soft gradient disc */
    content:"";
    position:absolute; inset:-60% -20% auto -20%;
    height:140%;
    background:conic-gradient(from 0deg, rgba(220,199,162,.18), rgba(0,30,53,0) 42%, rgba(220,199,162,.18) 70%, rgba(0,30,53,0));
    filter:blur(26px);
    animation:spin var(--dur-slow) linear infinite;
    z-index:-1;
  }
  @keyframes spin { to { transform:rotate(360deg);} }

  .brand{
    display:flex; align-items:flex-end; gap:14px;
  }
  .brand-mark{
    font-family: Cinzel, serif;
    letter-spacing:.12em;
    font-weight:800;
    font-size:28px;
    color:var(--gold-1);
    background:linear-gradient(90deg, var(--gold-1) 0%, var(--gold-2) 60%, var(--gold-1) 100%);
    -webkit-background-clip:text; background-clip:text; color:transparent;
  }
  .brand-sub{
    font-family: Playfair Display, serif;
    font-size:14px;
    letter-spacing:.18em;
    color:var(--ink-dim);
    transform:translateY(2px);
  }

  /* Twinkle stars around title */
  .twinkle{
    position:relative;
    display:inline-block;
    padding-right:28px;
  }
  .twinkle::before,
  .twinkle::after{
    position:absolute; color:var(--gold-1); opacity:.65;
    animation:twinkle 2.2s ease-in-out infinite;
    font-family: "Times New Roman", serif;
    line-height:1;
  }
  .twinkle::before{ content:"✦"; right:12px; top:-6px; animation-delay:.2s;}
  .twinkle::after { content:"✧"; right:-2px; top:-2px; animation-delay:1.2s;}
  @keyframes twinkle{
    0%,100%{ opacity:.15; transform:scale(.8) translateY(0); }
    50%{ opacity:1; transform:scale(1) translateY(-2px); }
  }

  /* Header quick tools */
  .top-tools{
    margin-top:16px;
    display:flex; flex-wrap:wrap; gap:10px;
  }

  /* Shimmer button */
  .btn{
    appearance:none; border:1px solid var(--border-bright);
    background:linear-gradient(135deg, rgba(0,30,53,.55), rgba(0,30,53,.75)) padding-box,
               linear-gradient(135deg, var(--gold-1), var(--gold-2)) border-box;
    color:var(--gold-1);
    border-radius:var(--r-sm);
    padding:10px 14px;
    font-weight:600; letter-spacing:.04em;
    position:relative; overflow:hidden;
    transition:transform var(--dur-fast) ease, box-shadow var(--dur-fast) ease;
    box-shadow:var(--shadow-soft);
  }
  .btn:hover{ transform:translateY(-2px); box-shadow:var(--shadow-lift), var(--glow-gold);}
  .btn:active{ transform:translateY(0); box-shadow:var(--shadow-soft);}
  .btn.shimmer::after{
    content:""; position:absolute; inset:0;
    background:linear-gradient(110deg, transparent 0%, rgba(255,255,255,.18) 45%, transparent 55%);
    transform:translateX(-100%);
    transition:transform .7s ease;
  }
  .btn.shimmer:hover::after{ transform:translateX(100%); }

  /* Layout */
  .page{ max-width:1200px; margin:0 auto; padding:20px; }
  .grid{
    display:grid; gap:20px; margin-top:22px;
    grid-template-columns: 1.2fr 1.2fr 1fr;
  }
  @media (max-width:1080px){
    .grid{ grid-template-columns: 1fr; }
  }

  /* Card (glass) */
  .card{
    background:linear-gradient(180deg, var(--panel-2), var(--panel-3));
    border:1px solid var(--border-subtle);
    border-top-color:rgba(220,199,162,.35);
    border-radius:var(--r-md);
    box-shadow:var(--shadow-soft);
    backdrop-filter:var(--blur);
    -webkit-backdrop-filter:var(--blur);
    padding:18px;
    position:relative; overflow:hidden;
  }
  .card:hover{ transform:translateY(-2px); transition:transform var(--dur-fast) ease; }
  .card-title{
    display:flex; align-items:center; justify-content:space-between;
    font-family: Playfair Display, serif; letter-spacing:.06em;
    font-size:18px; color:var(--gold-1); margin:0 0 12px;
  }
  .pill{
    font-size:12px; padding:4px 8px; border-radius:999px;
    border:1px solid var(--border-bright); color:var(--ink-dim);
    background:linear-gradient(180deg, rgba(0,30,53,.55), rgba(0,30,53,.8));
  }

  /* Forms */
  .row{ display:flex; gap:10px; flex-wrap:wrap; }
  .input, .select, .file{
    width:100%; min-width:0;
    padding:10px 12px; border-radius:var(--r-sm);
    border:1px solid var(--border-subtle);
    background:linear-gradient(180deg, rgba(0,30,53,.4), rgba(0,30,53,.7));
    color:var(--ink);
    outline:none;
    transition:box-shadow var(--dur-fast) ease, border-color var(--dur-fast) ease;
  }
  .input::placeholder{ color:rgba(238,230,214,.55); }
  .input:focus, .select:focus, .file:focus{
    border-color:var(--gold-1);
    box-shadow:0 0 0 3px rgba(220,199,162,.18);
  }
  label{ font-size:12px; color:var(--ink-dim); display:block; margin:6px 0 6px; }

  .stat-grid{
    display:grid; gap:10px; grid-template-columns:repeat(4,1fr);
  }
  @media (max-width:560px){
    .stat-grid{ grid-template-columns:repeat(2,1fr); }
  }
  .stat{
    display:grid; gap:6px;
  }

  /* Team roster */
  .teams{
    display:grid; gap:12px; grid-template-columns:1fr 1fr;
  }
  @media (max-width:720px){
    .teams{ grid-template-columns:1fr; }
  }
  .team{
    background:linear-gradient(180deg, rgba(0,30,53,.35), rgba(0,30,53,.6));
    border:1px solid var(--border-subtle);
    border-radius:var(--r-sm);
    padding:10px;
  }
  .team-head{
    display:flex; justify-content:space-between; align-items:center;
    margin-bottom:8px; color:var(--gold-1); font-weight:700; letter-spacing:.05em;
  }
  .players{
    display:grid; gap:8px;
  }
  .player{
    display:grid; grid-template-columns:48px 1fr auto; gap:10px; align-items:center;
    background:linear-gradient(180deg, rgba(0,30,53,.35), rgba(0,30,53,.55));
    border:1px solid var(--border-subtle);
    border-radius:10px; padding:8px;
  }
  .avatar{
    width:48px; height:48px; border-radius:8px; object-fit:cover;
    border:1px solid var(--border-bright);
    background:rgba(0,0,0,.2);
  }
  .p-name{ font-weight:700; letter-spacing:.02em; }
  .p-meta{ font-size:12px; color:var(--ink-dim); }

  /* Log & chat */
  .log{
    height:360px; overflow:auto; border:1px solid var(--border-subtle);
    border-radius:var(--r-sm); padding:10px;
    background:linear-gradient(180deg, rgba(0,30,53,.35), rgba(0,30,53,.65));
  }
  .log-entry{
    font-size:13px; color:var(--ink); opacity:.92;
    border-bottom:1px dashed rgba(220,199,162,.12);
    padding:6px 2px;
  }
  .log-entry .ts{ color:var(--ink-dim); font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; margin-right:8px; }
  .chat-row{ display:flex; gap:8px; margin-top:10px; }
  .chat-input{ flex:1; }

  /* Scrollbar */
  .log::-webkit-scrollbar{ width:10px; }
  .log::-webkit-scrollbar-thumb{ background:linear-gradient(180deg, var(--gold-2), var(--gold-1)); border-radius:8px; }
  .log::-webkit-scrollbar-track{ background:rgba(0,0,0,.2); }

  /* Subtle helper */
  .muted{ color:var(--ink-dim); font-size:12px; }
  .copy-field{
    display:grid; gap:8px;
    grid-template-columns:1fr auto;
  }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="app-header">
    <div class="page">
      <div class="brand">
        <div class="brand-mark twinkle">PYXIS</div>
        <div class="brand-sub">BATTLE ADMIN CONSOLE</div>
      </div>
      <div class="top-tools">
        <button class="btn shimmer" id="btnCreateBattle">전투 생성</button>
        <button class="btn" id="btnStart">시작</button>
        <button class="btn" id="btnPause">일시정지</button>
        <button class="btn" id="btnEnd">종료</button>
        <span class="pill" id="battleStatus">대기</span>
        <span class="pill" id="battleIdPill">ID: -</span>
      </div>
    </div>
  </header>

  <div class="page">
    <div class="grid">

      <!-- Column A: Battle / Links -->
      <section class="card">
        <h2 class="card-title">
          전투 설정
          <span class="pill">모드</span>
        </h2>

        <!-- Mode -->
        <div class="row" style="margin-bottom:10px;">
          <select id="battleMode" class="select">
            <option value="1v1">1v1</option>
            <option value="2v2" selected>2v2</option>
            <option value="3v3">3v3</option>
            <option value="4v4">4v4</option>
          </select>
          <button class="btn" id="btnApplyMode">모드 적용</button>
        </div>

        <!-- Links -->
        <h3 class="card-title" style="margin-top:6px;">
          링크 생성
          <span class="pill">복사 지원</span>
        </h3>
        <div class="copy-field">
          <input id="adminLink" class="input" placeholder="관리자 URL" readonly>
          <button class="btn shimmer" data-copy="#adminLink">복사</button>
        </div>
        <div class="copy-field" style="margin-top:8px;">
          <input id="playerLink" class="input" placeholder="플레이어 URL" readonly>
          <button class="btn shimmer" data-copy="#playerLink">복사</button>
        </div>
        <div class="copy-field" style="margin-top:8px;">
          <input id="spectatorLink" class="input" placeholder="관전자 URL" readonly>
          <button class="btn shimmer" data-copy="#spectatorLink">복사</button>
        </div>
        <p class="muted" style="margin-top:8px">생성된 링크에는 자동으로 battle, otp 파라미터가 포함된다.</p>
      </section>

      <!-- Column B: Player Management -->
      <section class="card">
        <h2 class="card-title">
          참여자 관리
          <span class="pill">추가 / 로스터</span>
        </h2>

        <!-- Add player -->
        <div class="row">
          <input id="pName" class="input" placeholder="플레이어 이름" maxlength="20">
          <select id="pTeam" class="select">
            <option value="A">불사조 기사단</option>
            <option value="B">죽음을 먹는 자들</option>
          </select>
          <button class="btn shimmer" id="btnAddPlayer">추가</button>
        </div>

        <!-- Avatar URL + File upload -->
        <label>캐릭터 반신</label>
        <div class="row">
          <input id="pAvatarUrl" class="input" placeholder="https://example.com/image.png">
        </div>
        <div class="row">
          <input id="pAvatarFile" class="file" type="file" accept="image/*">
          <button class="btn" id="btnUploadAvatar">업로드</button>
          <span id="uploadMsg" class="muted"></span>
        </div>
        <div class="row">
          <img id="avatarPreview" class="avatar" alt="preview">
        </div>

        <!-- Stats -->
        <label style="margin-top:6px;">스탯 (0~5, 전송 시 0은 서버에서 1로 보정)</label>
        <div class="stat-grid">
          <div class="stat">
            <span class="muted">공격</span>
            <input id="sAtk" class="input" type="number" min="0" max="5" value="0">
          </div>
          <div class="stat">
            <span class="muted">방어</span>
            <input id="sDef" class="input" type="number" min="0" max="5" value="0">
          </div>
          <div class="stat">
            <span class="muted">민첩</span>
            <input id="sAgi" class="input" type="number" min="0" max="5" value="0">
          </div>
          <div class="stat">
            <span class="muted">행운</span>
            <input id="sLuc" class="input" type="number" min="0" max="5" value="0">
          </div>
        </div>

        <!-- Items -->
        <label style="margin-top:6px;">아이템 (0~9)</label>
        <div class="stat-grid">
          <div class="stat">
            <span class="muted">디터니</span>
            <input id="iDet" class="input" type="number" min="0" max="9" value="0">
          </div>
          <div class="stat">
            <span class="muted">공격 보정기</span>
            <input id="iAtkB" class="input" type="number" min="0" max="9" value="0">
          </div>
          <div class="stat">
            <span class="muted">방어 보정기</span>
            <input id="iDefB" class="input" type="number" min="0" max="9" value="0">
          </div>
        </div>

        <!-- Teams -->
        <div class="teams" style="margin-top:14px;">
          <div class="team">
            <div class="team-head">
              <div>불사조 기사단</div>
              <div id="teamACount" class="muted">0명</div>
            </div>
            <div id="teamAList" class="players">
              <div class="muted">팀원을 추가해주세요</div>
            </div>
          </div>
          <div class="team">
            <div class="team-head">
              <div>죽음을 먹는 자들</div>
              <div id="teamBCount" class="muted">0명</div>
            </div>
            <div id="teamBList" class="players">
              <div class="muted">팀원을 추가해주세요</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Column C: Status / Log / Chat -->
      <section class="card">
        <h2 class="card-title">
          진행 상황
          <span class="pill" id="turnPill">턴: -</span>
        </h2>
        <div class="row">
          <div class="input" id="statusBoard" style="height:44px; display:flex; align-items:center;">
            상태 정보가 여기에 표시됩니다
          </div>
        </div>
        <label style="margin-top:6px;">실시간 로그</label>
        <div id="log" class="log"></div>

        <div class="chat-row">
          <input id="chatInput" class="input chat-input" placeholder="운영자 채팅 입력">
          <button class="btn" id="btnChatSend">전송</button>
        </div>
      </section>

    </div>
  </div>

  <script>
  (function(){
    "use strict";

    const $  = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    /* ------------------------------
       Minimal glue only:
       - 업로드 API 호출
       - 복사 버튼
       - 필수 필드의 id/구조는 기존 admin.js가 그대로 사용할 수 있게 유지
       ------------------------------ */

    // Battle state holders (admin.js가 이미 있으면 그대로 사용)
    let currentBattleId = null;
    let currentAdminOtp = null;
    let currentSpectatorOtp = null;

    // Upload avatar for current battle
    async function uploadAvatar(){
      const file = $("#pAvatarFile")?.files?.[0];
      if(!file){ msg("이미지 파일을 선택하세요"); return; }
      if(!currentBattleId){
        // admin.js에서 battle 생성 시 아래 pill에 셋팅해주기만 하면 된다
        msg("전투 ID가 없습니다. 먼저 전투를 생성하세요.");
        return;
      }
      const fd = new FormData();
      fd.append("avatar", file);
      const res = await fetch(`/api/battles/${encodeURIComponent(currentBattleId)}/avatar`, {
        method:"POST", body:fd
      });
      if(!res.ok){
        msg("업로드 실패: " + res.status + " " + res.statusText);
        return;
      }
      const data = await res.json().catch(()=>({}));
      const url = data && (data.url || data.path);
      if(url){
        $("#pAvatarUrl").value = url;
        const pv = $("#avatarPreview");
        if(pv){ pv.src = url; }
        msg("업로드 성공");
      }else{
        msg("업로드 완료(경로 수신 실패)");
      }
    }

    function msg(t){ const m=$("#uploadMsg"); if(m){ m.textContent=t; } }

    // Copy buttons
    function bindCopyButtons(){
      $$("button[data-copy]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const sel = btn.getAttribute("data-copy");
          const inp = document.querySelector(sel);
          if(!inp) return;
          inp.select?.();
          navigator.clipboard.writeText(inp.value || "").then(()=>{
            btn.classList.add("shimmer");
            setTimeout(()=>btn.classList.remove("shimmer"), 700);
          });
        });
      });
    }

    // Hooks admin.js (외부 스크립트가 값을 세팅할 수 있게 전역 노출)
    window.__pyxisAdmin__ = {
      setBattleInfo: ({ id, status, turn, adminLink, playerLink, spectatorLink, adminOtp, spectatorOtp })=>{
        currentBattleId = id || currentBattleId;
        currentAdminOtp = adminOtp || currentAdminOtp;
        currentSpectatorOtp = spectatorOtp || currentSpectatorOtp;

        if($("#battleIdPill")) $("#battleIdPill").textContent = "ID: " + (id || "-");
        if($("#battleStatus")) $("#battleStatus").textContent = status || "대기";
        if($("#turnPill")) $("#turnPill").textContent = "턴: " + (turn == null ? "-" : turn);

        if($("#adminLink")) $("#adminLink").value = adminLink || "";
        if($("#playerLink")) $("#playerLink").value = playerLink || "";
        if($("#spectatorLink")) $("#spectatorLink").value = spectatorLink || "";
      },
      addLog: (text)=>{
        const el = document.createElement("div");
        el.className = "log-entry";
        const ts = new Date().toLocaleTimeString();
        el.innerHTML = `<span class="ts">[${ts}]</span>${text}`;
        $("#log")?.prepend(el);
      },
      setTeams: ({ teamA, teamB })=>{
        renderTeam("#teamAList","#teamACount", teamA || []);
        renderTeam("#teamBList","#teamBCount", teamB || []);
      }
    };

    function renderTeam(listSel,countSel,arr){
      const list = $(listSel), count = $(countSel);
      if(!list) return;
      list.innerHTML = "";
      if(!arr.length){
        const d=document.createElement("div");
        d.className="muted"; d.textContent="팀원을 추가해주세요";
        list.appendChild(d);
      }else{
        arr.forEach(p=>{
          const item=document.createElement("div");
          item.className="player";
          const img=document.createElement("img");
          img.className="avatar";
          img.src=p.avatar || "";
          img.alt=p.name || "avatar";
          const meta=document.createElement("div");
          const name=document.createElement("div");
          name.className="p-name"; name.textContent=p.name || "";
          const sub=document.createElement("div");
          sub.className="p-meta";
          sub.textContent=`ATK ${p.stats?.attack ?? "-"}  DEF ${p.stats?.defense ?? "-"}  AGI ${p.stats?.agility ?? "-"}  LUC ${p.stats?.luck ?? "-"}`;
          meta.appendChild(name); meta.appendChild(sub);
          const right=document.createElement("div");
          right.className="p-meta";
          right.textContent = (p.team === "A" ? "A" : "B");
          item.appendChild(img); item.appendChild(meta); item.appendChild(right);
          list.appendChild(item);
        });
      }
      if(count) count.textContent = (arr.length||0) + "명";
    }

    // Bind UI
    document.addEventListener("DOMContentLoaded", ()=>{
      $("#btnUploadAvatar")?.addEventListener("click", uploadAvatar);
      bindCopyButtons();

      // 초기 표시
      window.__pyxisAdmin__?.setBattleInfo?.({ id:null, status:"대기", turn:null });
    });
  })();
  </script>
</body>
</html>
