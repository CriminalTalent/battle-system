<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PYXIS 전투 관리자</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand: {
              bg: '#0b0f15',
              panel: '#0f141c',
              stroke: 'rgba(220,199,162,0.20)',
              gold: '#dcc7a2'
            }
          },
          boxShadow: {
            panel: '0 12px 28px rgba(0,0,0,.35), inset 0 0 24px rgba(212,186,141,.08)'
          }
        }
      }
    }
  </script>

  <style>
    html,body{height:100%}
    body{
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(212,186,141,.08), transparent 60%),
        radial-gradient(1000px 600px at 90% 0%, rgba(36,58,99,.25), transparent 60%),
        linear-gradient(#0a0e14,#0b0f15);
    }
    .glass{
      @apply bg-brand-panel/70 backdrop-blur rounded-2xl border;
      border-color: rgba(220,199,162,.18);
      box-shadow: 0 10px 26px rgba(0,0,0,.35), inset 0 0 18px rgba(212,186,141,.06);
    }
    .title{
      @apply tracking-wide;
      letter-spacing:.08em
    }
    .pill{ @apply text-xs px-2 py-0.5 rounded-full border; border-color: rgba(220,199,162,.28); color: #dcc7a2;}
    .btn{ @apply inline-flex items-center justify-center px-3 py-2 rounded-xl border text-sm transition;
      border-color: rgba(220,199,162,.28); color:#e6e0d4;
      background: linear-gradient(180deg, rgba(212,186,141,.10), rgba(212,186,141,.05));
    }
    .btn:hover{ background: linear-gradient(180deg, rgba(212,186,141,.16), rgba(212,186,141,.08));}
    .btn-primary{ background: linear-gradient(180deg, rgba(220,199,162,.35), rgba(220,199,162,.18)); color:#0e131a; border-color: rgba(220,199,162,.55);}
    .btn-danger{ background: linear-gradient(180deg, rgba(244,72,72,.28), rgba(244,72,72,.16)); border-color: rgba(244,72,72,.38); color:#fff;}
    .input, select, textarea{
      @apply w-full rounded-xl border bg-brand-panel text-zinc-200 text-sm px-3 py-2 outline-none;
      border-color: rgba(220,199,162,.22);
    }
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .logbox{ @apply rounded-xl border p-3 bg-black/60 text-zinc-200 mono text-xs overflow-auto; border-color: rgba(220,199,162,.18); }
    .sep{ height:1px; background: linear-gradient(90deg, transparent, rgba(220,199,162,.25), transparent);}
    .card-h{ @apply px-5 py-3 border-b; border-color: rgba(220,199,162,.20);}
    .card-t{ @apply font-semibold text-[15px] text-zinc-100;}
    .toast{ position:fixed; right:16px; bottom:16px; opacity:0; transform: translateY(8px); transition:.25s; }
    .toast.show{ opacity:1; transform: translateY(0); }
  </style>
</head>
<body class="text-zinc-100">

  <!-- Header -->
  <header class="sticky top-0 z-30 border-b border-[rgba(220,199,162,.22)] bg-[#0c1118]/70 backdrop-blur">
    <div class="max-w-7xl mx-auto px-5 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-xl" style="background:linear-gradient(180deg,#2c3650,#1a2130)"></div>
        <div>
          <div class="title font-semibold text-[18px]" style="color:#dcc7a2">PYXIS 전투 관리자</div>
          <div class="text-[11px] text-zinc-400">브로드캐스트/참가자/로그 제어</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span class="pill">Env: <span id="envName" class="ml-1">unknown</span></span>
        <span class="pill">Server: <span id="serverAddr" class="ml-1 mono">—</span></span>
        <a class="btn" href="/api/health" target="_blank">API Health</a>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-5 py-6 grid grid-cols-1 lg:grid-cols-3 gap-5">
    <!-- Left: Battle Controls -->
    <section class="flex flex-col gap-5">
      <div class="glass">
        <div class="card-h flex items-center justify-between">
          <h2 class="card-t">배틀 제어</h2>
          <span class="pill">상태: <span id="battleStatus" class="ml-1">—</span></span>
        </div>
        <div class="p-5 space-y-4">
          <div>
            <label class="text-xs text-zinc-400">현재 배틀 코드</label>
            <div class="mt-1 flex gap-2">
              <input id="battleId" class="input mono" placeholder="예: 276BCN34"/>
              <button id="createBattle" class="btn-primary">새 배틀</button>
              <button id="setBattleId" class="btn">적용</button>
            </div>
            <p class="text-[11px] text-zinc-500 mt-1">기존 코드 입력 또는 새로 생성</p>
          </div>

          <div class="grid grid-cols-3 gap-2">
            <select id="selMode" class="input">
              <option value="1v1">1v1</option>
              <option value="2v2">2v2</option>
              <option value="ffa">FFA</option>
            </select>
            <button id="btnBattleEnd" class="btn-danger">배틀 종료</button>
            <button id="btnBattleReset" class="btn">라운드 리셋</button>
            <button id="btnApplyMode" class="btn col-span-1">모드 적용</button>
            <button id="btnRefreshBattle" class="btn col-span-2">상태 새로고침</button>
          </div>
        </div>
      </div>

      <div class="glass">
        <div class="card-h flex items-center justify-between">
          <h2 class="card-t">바로가기 / 공유 링크</h2>
          <span class="pill">Public</span>
        </div>
        <div class="p-5 space-y-3">
          <div>
            <label class="text-xs text-zinc-400">베이스 URL</label>
            <input id="baseUrl" class="input mono mt-1" value="http://0.0.0.0:3001"/>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <button id="genLinks" class="btn">링크 생성(서버)</button>
            <button id="copyAllLinks" class="btn" data-copy="#linksBundle">링크 묶음 복사</button>
          </div>
          <div class="grid sm:grid-cols-2 gap-2">
            <input id="adminLink" class="input mono" placeholder="Admin 링크"/>
            <input id="p1Link" class="input mono" placeholder="Player1 링크"/>
            <input id="p2Link" class="input mono" placeholder="Player2 링크"/>
            <input id="spectatorLink" class="input mono" placeholder="Spectator 링크"/>
          </div>
          <textarea id="linksBundle" class="input mono h-24" readonly></textarea>
        </div>
      </div>

      <div class="glass">
        <div class="card-h">
          <h2 class="card-t">OTP 발급</h2>
        </div>
        <div class="p-5 space-y-3">
          <div class="text-xs text-zinc-400">Rate limit: 10 / 15m</div>
          <div class="grid grid-cols-3 gap-2">
            <button id="genPlayerOtp" class="btn">Player OTP</button>
            <button id="genSpectatorOtp" class="btn">Spectator OTP</button>
            <button id="btnRevokeExpired" class="btn-danger">만료 정리</button>
            <input id="playerOtp" class="input mono col-span-2" placeholder="플레이어 OTP"/>
            <input id="spectatorOtp" class="input mono col-span-3" placeholder="관전자 OTP"/>
          </div>

          <div class="sep my-2"></div>
          <div class="flex items-center justify-between">
            <div class="font-medium text-sm">최근 생성 내역</div>
            <button id="btnRefreshOTPs" class="btn">새로고침</button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="text-zinc-400">
                <tr>
                  <th class="text-left px-2 py-1">타입</th>
                  <th class="text-left px-2 py-1">OTP</th>
                  <th class="text-left px-2 py-1">남은 TTL</th>
                  <th class="text-left px-2 py-1">Max / Used</th>
                  <th class="px-2 py-1"></th>
                </tr>
              </thead>
              <tbody id="otpListBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Middle: Participants & Avatar -->
    <section class="flex flex-col gap-5">
      <div class="glass">
        <div class="card-h flex items-center justify-between">
          <h2 class="card-t">참가자 관리</h2>
          <span class="pill">최대 8명</span>
        </div>
        <div class="p-5 space-y-3">
          <div class="grid grid-cols-3 gap-2">
            <input id="playerName" class="input col-span-2" placeholder="닉네임"/>
            <select id="playerTeam" class="input">
              <option value="phoenix">불사조 기사단</option>
              <option value="eaters">죽음을 먹는 자들</option>
            </select>
            <button id="btnAddPlayer" class="btn-primary">플레이어 추가</button>
            <button id="btnClearPlayers" class="btn">전체 제거</button>
            <button id="btnRefreshPlayers" class="btn">목록 새로고침</button>
          </div>

          <div class="overflow-x-auto mt-2">
            <table class="w-full text-sm">
              <thead class="text-zinc-400">
                <tr><th class="text-left px-2 py-1">#</th><th class="text-left px-2 py-1">닉네임</th><th class="text-left px-2 py-1">팀</th><th class="text-left px-2 py-1">상태</th><th class="px-2 py-1"></th></tr>
              </thead>
              <tbody id="playersBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="glass">
        <div class="card-h flex items-center justify-between">
          <h2 class="card-t">아바타 업로드</h2>
          <span class="pill">multipart/form-data</span>
        </div>
        <div class="p-5 space-y-3">
          <p class="text-sm text-zinc-400">
            서버에 <span class="mono">multer</span> 설치 및 <span class="mono">POST /api/battles/:id/avatar</span> 라우트가 필요합니다.
          </p>
          <div class="grid grid-cols-3 gap-2 items-end">
            <input id="avatarFile" type="file" class="block w-full text-sm col-span-2" accept="image/*"/>
            <button id="btnUploadAvatar" class="btn">업로드</button>
          </div>
          <div id="avatarUploadResult" class="text-sm"></div>
        </div>
      </div>

      <div class="glass">
        <div class="card-h">
          <h2 class="card-t">전투 로그</h2>
        </div>
        <div class="p-5">
          <div id="battleLog" class="logbox h-48"></div>
        </div>
      </div>
    </section>

    <!-- Right: Server Monitor & Admin Chat -->
    <section class="flex flex-col gap-5">
      <div class="glass">
        <div class="card-h flex items-center justify-between">
          <h2 class="card-t">서버 모니터</h2>
          <span id="healthPill" class="pill">Health: ?</span>
        </div>
        <div class="p-5 grid grid-cols-2 gap-3 text-sm">
          <div><div class="text-xs text-zinc-400">서버 주소</div><div id="monServer" class="mono mt-0.5">—</div></div>
          <div><div class="text-xs text-zinc-400">환경</div><div id="monEnv" class="mt-0.5">—</div></div>
          <div><div class="text-xs text-zinc-400">포트</div><div id="monPort" class="mono mt-0.5">—</div></div>
          <div><div class="text-xs text-zinc-400">Uptime</div><div id="monUptime" class="mt-0.5">—</div></div>
          <div class="col-span-2 flex gap-2">
            <button id="btnPing" class="btn">헬스체크</button>
            <button id="btnOpenMetrics" class="btn">로그 보기</button>
          </div>
        </div>
      </div>

      <!-- Admin Chat only (no cheer tab) -->
      <div class="glass">
        <div class="card-h flex items-center justify-between">
          <h2 class="card-t">운영자 채팅</h2>
          <span class="pill">socket.io</span>
        </div>
        <div class="p-5 space-y-3">
          <div class="flex items-center gap-2">
            <label class="text-xs text-zinc-400">이름</label>
            <input id="adminChatName" class="input w-44" value="관리자"/>
            <button id="adminChatConnect" class="btn">연결</button>
          </div>
          <div id="adminChatBox" class="logbox h-56"></div>
          <div class="flex gap-2">
            <input id="adminChatInput" class="input flex-1" placeholder="메시지 입력…"/>
            <button id="adminChatSend" class="btn-primary w-24">전송</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="sticky bottom-0 border-t border-[rgba(220,199,162,.22)] bg-[#0c1118]/70 backdrop-blur">
    <div class="max-w-7xl mx-auto px-5 py-2 text-[11px] text-zinc-400 flex items-center justify-between">
      <div>© PYXIS Battle System</div>
      <div class="space-x-2">
        <span class="border rounded px-1.5 py-0.5">F5</span><span>갱신</span>
        <span class="border rounded px-1.5 py-0.5">⌘/Ctrl + C</span><span>복사</span>
      </div>
    </div>
  </footer>

  <!-- Toast -->
  <div id="toast" class="toast btn-primary px-3 py-2 rounded-xl mono text-sm">완료</div>

  <!-- Socket.IO (lazy fallback loader) -->
  <script>
    (function ensureSocket(){
      if (window.io) return;
      var s=document.createElement('script');
      s.src='/socket.io/socket.io.js';
      s.onerror=function(){
        var cd=document.createElement('script');
        cd.src='https://cdn.socket.io/4.7.5/socket.io.min.js';
        document.head.appendChild(cd);
      };
      document.head.appendChild(s);
    })();
  </script>

  <!-- Admin Logic (links/otp/players/health etc.) -->
  <script src="/assets/js/pages/admin.js"></script>

  <!-- Bridge: wire Admin UI (same ids as admin.js expects) + Admin chat -->
  <script>
    // ===== Helper bindings used by existing admin.js =====
    const $ = (s)=>document.querySelector(s);
    // Update link bundle whenever any single link input changes
    function refreshLinksBundle(){
      const lines = [
        'Admin: ' + ($('#adminLink')?.value||''),
        'Player: ' + ($('#p1Link')?.value||''),
        'Player: ' + ($('#p2Link')?.value||''),
        'Spectator: ' + ($('#spectatorLink')?.value||''),
      ].join('\\n');
      $('#linksBundle').value = lines;
    }
    ['#adminLink','#p1Link','#p2Link','#spectatorLink'].forEach(id=>{
      document.addEventListener('input', (e)=>{ if(e.target && e.target.matches(id)) refreshLinksBundle();});
    });

    // Health quick-set (compat with earlier admin.js)
    (function initHeader(){
      $('#serverAddr').textContent = location.host;
    })();

    // ===== Admin Chat (no cheer tab) =====
    (function adminChat(){
      const box = $('#adminChatBox');
      const input = $('#adminChatInput');
      const nameEl = $('#adminChatName');
      const btnSend = $('#adminChatSend');
      const btnConn = $('#adminChatConnect');
      let socket=null, authed=false;

      function line(sender,msg){
        const t=new Date();
        const hh=String(t.getHours()).padStart(2,'0');
        const mm=String(t.getMinutes()).padStart(2,'0');
        const ss=String(t.getSeconds()).padStart(2,'0');
        const div=document.createElement('div');
        div.innerHTML = '<span class="text-zinc-500 mr-2">['+hh+':'+mm+':'+ss+']</span><span>'+escapeHtml(sender)+': '+escapeHtml(msg)+'</span>';
        box.appendChild(div); box.scrollTop = box.scrollHeight;
      }
      function escapeHtml(v){ const d=document.createElement('div'); d.textContent=String(v??''); return d.innerHTML; }

      function connect(){
        if (socket?.connected) return;
        // eslint-disable-next-line no-undef
        socket = io({transports:['websocket','polling']});
        socket.on('connect',()=>{
          line('시스템','실시간 연결됨');
          const qs = new URLSearchParams(location.search);
          const battleId = qs.get('battle') || '';
          socket.emit('adminAuth', { role:'admin', battleId });
        });
        socket.on('disconnect',()=> line('시스템','연결 해제됨'));
        socket.on('authSuccess',()=>{ authed=true; line('시스템','관리자 인증 완료'); });
        socket.on('authError',()=>{ authed=false; line('시스템','관리자 인증 실패'); });
        socket.on('chatMessage',(m)=> line(m?.sender||'채널', m?.message||''));
        socket.on('log',(l)=>{ if(l) line('로그', typeof l==='string'?l:(l.message||'')); });
      }

      function send(){
        const msg=(input.value||'').trim(); if(!msg) return;
        if(socket?.connected){
          socket.emit('chatMessage', { role:'admin', message:msg });
        }
        line(nameEl.value||'관리자', msg);
        input.value='';
      }

      btnConn?.addEventListener('click', connect);
      btnSend?.addEventListener('click', send);
      input?.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }});
    })();
  </script>
</body>
</html>
