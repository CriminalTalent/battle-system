<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>PYXIS | 전투 관리석</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Playfair+Display:wght@500;600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
  <style>
    /* ─────────────────────────────────────────────────────────
       PYXIS Admin – Elegant Navy & Gold UI (Design + wiring)
       - No emojis
       - App logic: client-side wiring only (server API/evt 호환)
       - Full code (no skips)
       - XSS 방지(escape), 팀 키 통일(eaters), 아이템 키 통일
       - 채팅 Enter 전송, 복사, 반응형/글래스/쉐도우
       ───────────────────────────────────────────────────────── */

    :root{
      /* Core palette */
      --gold-1:#DCC7A2; /* primary gold */
      --gold-2:#D4BA8D; /* secondary gold */
      --navy-1:#00080D; /* primary navy (bg) */
      --navy-2:#001E35; /* secondary navy (surfaces) */

      /* Neutrals */
      --ink:#EAE5D6;
      --ink-dim:#BEB7A3;
      --border-subtle:rgba(220,199,162,.24);
      --border-strong:rgba(220,199,162,.5);

      /* Glass & shadow */
      --glass:rgba(0,8,13,.55);
      --glass-2:rgba(0,30,53,.38);
      --glass-soft:rgba(220,199,162,.06);
      --shadow:0 10px 30px rgba(0,0,0,.45);

      /* Radii & spacing */
      --r-lg:16px;
      --r-md:12px;
      --r-sm:10px;
      --space-xxl:40px;
      --space-xl:28px;
      --space-lg:20px;
      --space-md:14px;
      --space-sm:10px;
      --space-xs:6px;

      /* Motion */
      --ease: cubic-bezier(.2,.8,.2,1);
      --dur-1:.25s;
      --dur-2:.6s;

      /* State colors */
      --state-wait:#6b7280;
      --state-live:#3a8e5a;
      --state-end:#b14b4b;

      /* Gradients */
      --grad-gold:linear-gradient(135deg,var(--gold-1),var(--gold-2));
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
      color:var(--ink);
      background:var(--navy-1);
      overflow-y:auto;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Rotating halo */
    .rotor{
      position:fixed; inset:-30vmax;
      background:
        radial-gradient(60vmax 60vmax at 30% 20%, rgba(212,186,141,.08), transparent 60%),
        conic-gradient(from 0deg, rgba(212,186,141,.18), rgba(220,199,162,.06), rgba(0,0,0,0) 70%);
      filter: blur(40px) saturate(120%);
      animation: spin 28s linear infinite;
      z-index:0; pointer-events:none;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    header.site{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(0,8,13,.85), rgba(0,8,13,.55) 55%, rgba(0,8,13,0));
      border-bottom:1px solid var(--border-subtle);
    }
    .site-inner{
      max-width:1200px; margin:0 auto; padding: clamp(14px,2vw,18px) 16px;
      display:flex; align-items:center; gap:18px;
    }
    .brand{ display:flex; align-items:baseline; gap:12px; }
    .brand-logo{
      font-family:"Cinzel", serif;
      letter-spacing:.06em;
      font-weight:700;
      font-size: clamp(20px, 3.2vw, 28px);
      line-height:1;
      background:var(--grad-gold);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow: 0 0 24px rgba(212,186,141,.25);
    }
    .brand-sub{
      font-family:"Playfair Display", serif;
      font-weight:600;
      font-size: clamp(12px, 1.6vw, 14px);
      color:var(--ink-dim);
      letter-spacing:.14em;
      text-transform:uppercase;
    }
    .twinkle{
      position:relative; flex:1; height:2px; overflow:visible;
    }
    .twinkle::before, .twinkle::after{
      content:"✦";
      position:absolute; top:-8px;
      font-family:"Playfair Display", serif;
      color:var(--gold-1);
      opacity:.7; filter:drop-shadow(0 0 8px rgba(220,199,162,.45));
      animation: twinkle 2.6s var(--ease) infinite alternate;
    }
    .twinkle::before{ left:20%; animation-delay:.2s; opacity:.5 }
    .twinkle::after{ right:18%; animation-delay:1.2s }
    @keyframes twinkle {
      0% { transform: translateY(0) scale(1); opacity:.4 }
      100%{ transform: translateY(-6px) scale(1.12); opacity:.9 }
    }

    .wrap{ position:relative; z-index:1; }
    .container{
      max-width:1200px; margin:0 auto; padding: 20px 16px 60px;
      display:grid; gap:20px;
      grid-template-columns: 1.1fr .9fr;
    }
    @media (max-width: 1100px){
      .container{ grid-template-columns:1fr }
    }

    .card{
      background:
        linear-gradient(180deg, rgba(0,12,20,.55), rgba(0,20,36,.45)),
        linear-gradient(0deg, var(--glass), var(--glass));
      border:1px solid var(--border-subtle);
      border-top:1px solid rgba(220,199,162,.25);
      border-radius:var(--r-lg);
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      padding:16px;
      transition: transform var(--dur-1) var(--ease), box-shadow var(--dur-1) var(--ease), border-color var(--dur-1) var(--ease);
    }
    .card:hover{ transform: translateY(-3px); border-color:var(--border-strong) }

    .card-title{
      display:flex; align-items:center; justify-content:space-between;
      font-family:"Playfair Display", serif;
      font-size: clamp(16px, 1.9vw, 18px);
      letter-spacing:.02em;
      margin:4px 0 12px;
      padding-bottom:10px;
      border-bottom:1px dashed var(--border-subtle);
      color:var(--ink);
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      font-size:12px; letter-spacing:.08em; text-transform:uppercase;
      padding:6px 10px; border-radius:999px; border:1px solid var(--border-subtle);
      background:linear-gradient(180deg, rgba(220,199,162,.08), rgba(220,199,162,.02));
      color:var(--ink);
    }
    .pill.wait{ color:var(--state-wait) }
    .pill.live{ color:var(--state-live) }
    .pill.end { color:var(--state-end)  }

    .btn{
      appearance:none; border:none; cursor:pointer; user-select:none;
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:10px 14px; border-radius:12px; font-weight:600; font-size:14px;
      color:#0c1217; background:var(--grad-gold);
      box-shadow: 0 8px 18px rgba(212,186,141,.2), inset 0 1px 0 rgba(255,255,255,.15);
      position:relative; overflow:hidden; transition: transform var(--dur-1) var(--ease), box-shadow var(--dur-1) var(--ease);
    }
    .btn:hover{ transform: translateY(-2px) }
    .btn:active{ transform: translateY(0) scale(.98) }
    .btn.shimmer::after{
      content:""; position:absolute; inset:0;
      background: linear-gradient(100deg, transparent 20%, rgba(255,255,255,.25) 50%, transparent 80%);
      transform: translateX(-100%);
      animation: shimmer 2.2s linear infinite;
      pointer-events:none;
    }
    .btn.ghost{
      color:var(--ink);
      background:linear-gradient(180deg, rgba(220,199,162,.06), rgba(220,199,162,.02));
      border:1px solid var(--border-subtle);
      box-shadow:none;
    }
    .btn.block{ width:100% }
    .btn-row{ display:flex; flex-wrap:wrap; gap:10px }

    .field{ display:grid; gap:6px }
    .label{ font-size:12px; letter-spacing:.06em; color:var(--ink-dim) }
    .input, select, textarea{
      width:100%; color:var(--ink); background:
        linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.15));
      border:1px solid var(--border-subtle); border-radius:12px;
      padding:10px 12px; outline:none;
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      transition: border-color var(--dur-1) var(--ease), box-shadow var(--dur-1) var(--ease);
    }
    .input::placeholder{ color:rgba(234,229,214,.5) }
    .input:focus, select:focus, textarea:focus{
      border-color: var(--gold-1);
      box-shadow: 0 0 0 3px rgba(220,199,162,.16);
    }

    .grid-2{ display:grid; gap:14px; grid-template-columns: 1fr 1fr }
    @media (max-width:720px){ .grid-2{ grid-template-columns:1fr } }

    .section{ display:grid; gap:14px }
    .muted{ color:var(--ink-dim); font-size:13px }

    .link-row{ display:grid; gap:10px }
    .copy-row{ display:grid; gap:10px; grid-template-columns: 1fr auto }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

    .teams{ display:grid; gap:14px; grid-template-columns: 1fr 1fr; }
    @media (max-width: 980px){ .teams{ grid-template-columns:1fr } }
    .team{
      border:1px solid var(--border-subtle); border-radius:var(--r-md);
      padding:12px; background:linear-gradient(180deg, rgba(0,30,53,.28), rgba(0,20,36,.14));
    }
    .team h4{
      margin:0 0 10px; font-family:"Playfair Display", serif; letter-spacing:.04em;
      color:var(--gold-1); font-weight:600; font-size:16px;
    }
    .player-row{
      display:grid; grid-template-columns: 1fr auto; align-items:center;
      padding:10px 0; border-top:1px dashed rgba(220,199,162,.14);
    }
    .player-row:first-of-type{ border-top:none; padding-top:0 }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; border:1px solid var(--border-subtle);
      background:linear-gradient(180deg, rgba(220,199,162,.08), rgba(220,199,162,.02));
      font-size:12px; color:var(--ink);
    }
    .stat{ color:var(--ink-dim); font-size:12px; letter-spacing:.04em }

    .log, .chat{
      height: 340px; overflow:auto; border:1px solid var(--border-subtle);
      border-radius:12px; background:linear-gradient(180deg, rgba(0,12,20,.35), rgba(0,20,36,.18));
      padding:12px;
    }
    .log-item, .chat-item{ padding:8px 6px; border-bottom:1px dashed rgba(220,199,162,.14) }
    .log-item:last-child, .chat-item:last-child{ border-bottom:none }
    .time{ color:var(--ink-dim); font-size:12px; margin-right:8px }
    .type{ color:var(--gold-2); font-size:12px; margin-right:8px }
    .msg{ color:var(--ink) }
    .chat-input{ display:grid; grid-template-columns:1fr auto; gap:10px; margin-top:10px }

    .toast{
      position: fixed; top:16px; right:16px; z-index:30;
      transform: translateX(120%); transition: transform .28s var(--ease);
      background: linear-gradient(180deg, rgba(220,199,162,.1), rgba(220,199,162,.04));
      border:1px solid var(--border-strong); color:var(--ink);
      padding:10px 12px; border-radius:12px; box-shadow: var(--shadow);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      font-size:14px;
    }
    .toast.show{ transform: translateX(0) }

    .foot{ height: 60px }

    /* Connection dot */
    .conn{
      display:inline-flex; align-items:center; gap:8px; margin-left:auto;
      font-size:12px; color:var(--ink-dim);
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background:#8a8f98; box-shadow:0 0 0 2px rgba(255,255,255,.06) inset;
    }
    .dot.ok{ background:#3a8e5a }
    .dot.bad{ background:#b14b4b }
  </style>
</head>
<body>
  <div class="rotor" aria-hidden="true"></div>

  <header class="site">
    <div class="site-inner">
      <div class="brand">
        <div class="brand-logo">PYXIS</div>
        <div class="brand-sub">Battle Administration</div>
      </div>
      <div class="twinkle" aria-hidden="true"></div>
      <div class="pill wait" id="battleStatePill">대기</div>
      <div class="conn" id="connBox" title="Socket status">
        <span class="dot" id="connDot"></span> <span id="connText">연결 중</span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="container">
      <!-- Left column -->
      <section class="section">
        <!-- Battle create / control -->
        <div class="card" id="battleCreateCard">
          <div class="card-title">
            <span>전투 생성</span>
            <span class="muted">모드 선택 후 생성</span>
          </div>
          <div class="grid-2">
            <div class="field">
              <label class="label" for="battleMode">전투 모드</label>
              <select id="battleMode" class="input">
                <option value="1v1">1v1</option>
                <option value="2v2" selected>2v2</option>
                <option value="3v3">3v3</option>
                <option value="4v4">4v4</option>
              </select>
            </div>
            <div class="field">
              <label class="label">전투 ID</label>
              <input id="battleId" class="input mono" type="text" placeholder="생성 시 자동 표시" readonly>
            </div>
          </div>
          <div class="btn-row" style="margin-top:12px">
            <button id="createBattleBtn" class="btn shimmer">전투 생성</button>
            <button id="startBattleBtn" class="btn ghost">전투 시작</button>
            <button id="endBattleBtn" class="btn ghost">전투 종료</button>
            <button id="restartBattleBtn" class="btn ghost">전투 재시작</button>
          </div>
        </div>

        <!-- Link generator -->
        <div class="card" id="linkCard">
          <div class="card-title">
            <span>링크 생성 및 복사</span>
            <span class="muted">역할별 OTP 자동 포함</span>
          </div>
          <div class="section link-row">
            <div class="copy-row">
              <input id="adminLink" class="input mono" type="text" placeholder="관리자 링크" readonly>
              <button class="btn shimmer" data-copy-target="#adminLink">복사</button>
            </div>
            <div class="copy-row">
              <input id="playerLink" class="input mono" type="text" placeholder="플레이어 링크" readonly>
              <button class="btn shimmer" data-copy-target="#playerLink">복사</button>
            </div>
            <div class="copy-row">
              <input id="spectatorLink" class="input mono" type="text" placeholder="관전자 링크" readonly>
              <button class="btn shimmer" data-copy-target="#spectatorLink">복사</button>
            </div>
            <div class="btn-row">
              <button id="generateLinksBtn" class="btn ghost">링크 생성</button>
            </div>
          </div>
        </div>

        <!-- Roster & add player -->
        <div class="card" id="rosterCard">
          <div class="card-title">
            <span>참여자 관리</span>
            <span class="muted">이름/팀/스탯/아이템/체력 입력 후 등록</span>
          </div>

          <div class="grid-2">
            <div class="section">
              <div class="field">
                <label class="label" for="playerName">플레이어 이름</label>
                <input id="playerName" class="input" type="text" placeholder="예: 플레이어">
              </div>
              <div class="field">
                <label class="label" for="playerTeam">팀 선택</label>
                <!-- 값 통일: phoenix / eaters -->
                <select id="playerTeam" class="input">
                  <option value="phoenix">불사조 기사단</option>
                  <option value="eaters">죽음을 먹는 자들</option>
                </select>
              </div>
              <div class="grid-2">
                <div class="field">
                  <label class="label" for="statAtk">공격</label>
                  <input id="statAtk" class="input" type="number" min="1" max="5" value="3">
                </div>
                <div class="field">
                  <label class="label" for="statDef">방어</label>
                  <input id="statDef" class="input" type="number" min="1" max="5" value="3">
                </div>
                <div class="field">
                  <label class="label" for="statAgi">민첩</label>
                  <input id="statAgi" class="input" type="number" min="1" max="5" value="3">
                </div>
                <div class="field">
                  <label class="label" for="statLuk">행운</label>
                  <input id="statLuk" class="input" type="number" min="1" max="5" value="3">
                </div>
              </div>
              <!-- HP 입력 -->
              <div class="field">
                <label class="label" for="playerHp">체력(HP)</label>
                <input id="playerHp" class="input" type="number" min="1" max="1000" value="100" placeholder="기본 100">
              </div>
              <div class="field">
                <label class="label" for="itemSelect">아이템</label>
                <!-- 키 통일: dittany / attackBoost / defenseBoost -->
                <select id="itemSelect" class="input">
                  <option value="">선택 없음</option>
                  <option value="attackBoost">공격 보정기</option>
                  <option value="defenseBoost">방어 보정기</option>
                  <option value="dittany">디터니</option>
                </select>
              </div>
              <div class="btn-row">
                <button id="addPlayerBtn" class="btn shimmer">플레이어 추가</button>
              </div>
            </div>

            <div class="section">
              <div class="teams">
                <div class="team">
                  <h4>불사조 기사단</h4>
                  <div id="teamPhoenix" class="team-list"></div>
                </div>
                <div class="team">
                  <h4>죽음을 먹는 자들</h4>
                  <div id="teamDeathEaters" class="team-list"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Right column -->
      <section class="section">
        <div class="card">
          <div class="card-title">
            <span>실시간 로그</span>
            <span class="muted">중요 이벤트 타임라인</span>
          </div>
          <div id="battleLog" class="log" aria-live="polite"></div>
        </div>

        <div class="card">
          <div class="card-title">
            <span>채팅</span>
            <span class="muted">관리자 공지 가능</span>
          </div>
          <div id="chatMessages" class="chat" aria-live="polite"></div>
          <div class="chat-input">
            <input id="chatInput" class="input" type="text" placeholder="메시지를 입력하세요">
            <button id="chatSendBtn" class="btn shimmer">전송</button>
          </div>
        </div>
      </section>
    </div>

    <div class="foot"></div>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite">복사되었습니다</div>

  <script>
    // ===== Utilities
    const $ = (sel,ctx=document)=>ctx.querySelector(sel);
    const $$ = (sel,ctx=document)=>Array.from(ctx.querySelectorAll(sel));
    const params = new URLSearchParams(location.search);
    let currentBattleId = params.get('battle') || '';
    let adminToken = params.get('token') || '';

    function clamp(v,min,max){ v = Number(v); if(Number.isNaN(v)) return min; return Math.max(min, Math.min(max, v)); }

    function escapeHtml(s){
      const d = document.createElement('div');
      d.textContent = String(s ?? '');
      return d.innerHTML;
    }

    async function fetchJSON(url, opts={}){
      const res = await fetch(url, {
        headers: { 'Content-Type':'application/json' },
        ...opts
      });
      const text = await res.text();
      let data = {};
      try { data = text ? JSON.parse(text) : {}; } catch(e){ throw new Error('Invalid JSON from '+url); }
      if(!res.ok) throw new Error(data?.error || ('HTTP '+res.status));
      return data;
    }

    // ===== Connection status UI
    const connDot = $("#connDot");
    const connText = $("#connText");
    function setConn(ok, msg){
      connDot.classList.remove('ok','bad');
      if(ok){ connDot.classList.add('ok'); connText.textContent = msg || '연결 완료'; }
      else   { connDot.classList.add('bad'); connText.textContent = msg || '연결 끊김'; }
    }

    // ===== Toast
    const toast = $("#toast");
    let toastTimer = null;
    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> toast.classList.remove("show"), 1600);
    }

    // ===== Battle state pill
    const battleStatePill = $("#battleStatePill");
    function updateBattleState(state, label){
      battleStatePill.classList.remove("wait","live","end");
      const map = { wait:"대기", live:"진행", end:"종료" };
      battleStatePill.classList.add(state in map ? state : "wait");
      battleStatePill.textContent = label || map[state] || map.wait;
    }
    // 외부에서 접근 가능하도록
    window.updateBattleStatePill = (state) => updateBattleState(state);

    // ===== Log & Chat appenders (escape)
    function appendLog(type, message){
      const box = $("#battleLog");
      const item = document.createElement("div");
      item.className = "log-item";
      const t = new Date();
      const time = String(t.getHours()).padStart(2,"0")+":"+String(t.getMinutes()).padStart(2,"0")+":"+String(t.getSeconds()).padStart(2,"0");
      item.innerHTML = `<span class="time">${time}</span><span class="type">${escapeHtml(type)}</span><span class="msg">${escapeHtml(message)}</span>`;
      box.appendChild(item);
      box.scrollTop = box.scrollHeight;
    }
    function appendChat(sender, message){
      const box = $("#chatMessages");
      const item = document.createElement("div");
      item.className = "chat-item";
      const t = new Date();
      const time = String(t.getHours()).padStart(2,"0")+":"+String(t.getMinutes()).padStart(2,"0")+":"+String(t.getSeconds()).padStart(2,"0");
      item.innerHTML = `<span class="time">${time}</span><span class="type">${escapeHtml(sender)}</span><span class="msg">${escapeHtml(message)}</span>`;
      box.appendChild(item);
      box.scrollTop = box.scrollHeight;
    }

    // ===== Team key helper (server 호환: phoenix/A/team1, eaters/B/death/team2)
    function teamKey(t){
      if(!t) return '';
      const s = String(t).toLowerCase();
      if (['phoenix','a','team1'].includes(s)) return 'phoenix';
      if (['eaters','b','death','team2'].includes(s)) return 'eaters';
      return s;
    }

    // ===== Roster rendering
    function renderRoster(state){
      const phoenixHost = $("#teamPhoenix");
      const eatersHost  = $("#teamDeathEaters");
      phoenixHost.innerHTML = '';
      eatersHost.innerHTML  = '';

      const players = state?.players || [];
      players.forEach(p=>{
        const row = document.createElement("div");
        row.className = "player-row";
        const hpText = (typeof p.hp === 'number' && typeof p.maxHp === 'number')
          ? ` / HP ${p.hp}/${p.maxHp}`
          : (typeof p.hp === 'number' ? ` / HP ${p.hp}` : '');
        const name = escapeHtml(p.name ?? '플레이어');
        const atk = p.stats?.atk ?? p.atk ?? "-";
        const def = p.stats?.def ?? p.def ?? "-";
        const agi = p.stats?.agi ?? p.agi ?? "-";
        const luk = p.stats?.luk ?? p.luk ?? "-";
        row.innerHTML = `
          <div>
            <span class="badge">${name}</span>
            <span class="stat">공격 ${escapeHtml(atk)} / 방어 ${escapeHtml(def)} / 민첩 ${escapeHtml(agi)} / 행운 ${escapeHtml(luk)}${hpText}</span>
          </div>
          <div class="btn-row">
            <button class="btn ghost" data-action="kick" data-id="${escapeHtml(p.id||'')}" data-name="${name}">제거</button>
          </div>
        `;
        if(teamKey(p.team) === 'phoenix') phoenixHost.appendChild(row);
        else eatersHost.appendChild(row);
      });
    }

    // 플레이어 행 내 버튼(제거 등) 위임
    document.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-action="kick"]');
      if(!btn) return;
      const id = btn.getAttribute('data-id');
      const name = btn.getAttribute('data-name') || '';
      if(!id || !currentBattleId) return;
      if(!confirm(`플레이어 "${name}"을(를) 제거하시겠습니까?`)) return;
      try{
        await fetchJSON(`/api/battles/${encodeURIComponent(currentBattleId)}/players/${encodeURIComponent(id)}`, { method:'DELETE' });
        appendLog('system', `플레이어 제거: ${name}`);
        showToast('플레이어 제거됨');
      }catch(err){
        appendLog('error', '플레이어 제거 실패: ' + err.message);
        showToast('플레이어 제거 실패');
      }
    });

    // ===== Copy buttons
    $$("#linkCard [data-copy-target]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const target = $(btn.getAttribute("data-copy-target"));
        if(!target) return;
        try{
          await navigator.clipboard.writeText(target.value||target.textContent||"");
          showToast("복사되었습니다");
        }catch(e){
          showToast("복사 실패");
        }
      });
    });

    // ===== Socket wiring
    let socket = null;
    let authed = false;

    function connectSocket(){
      socket = io({ transports:['websocket','polling'] });

      socket.on('connect', ()=>{
        setConn(true, '연결 완료');
        if(currentBattleId && adminToken){
          // 관리자 인증 (서버 가이드: adminAuth, authSuccess/authError)
          socket.emit('adminAuth', { battleId: currentBattleId, token: adminToken });
        }
      });

      socket.on('disconnect', ()=>{
        setConn(false, '연결 끊김');
        authed = false;
      });

      socket.on('authSuccess', (payload)=>{
        authed = true;
        showToast('관리자 인증 성공');
        appendLog('system', '관리자 인증 성공');
        if(payload?.battle){
          currentBattleId = payload.battle?.id || currentBattleId;
          $('#battleId').value = currentBattleId || '';
          const st = (payload.battle?.status || payload.battle?.state || 'wait').toLowerCase();
          updateBattleState(/live|running|in_progress/.test(st) ? 'live' : /end|ended|finished/.test(st) ? 'end' : 'wait');
          renderRoster(payload.battle);
        }
      });

      socket.on('authError', ()=>{
        authed = false;
        showToast('관리자 인증 실패');
        appendLog('error', '관리자 인증 실패');
      });

      // 실시간 상태 브로드캐스트
      socket.on('battleUpdate', (state)=>{
        try{
          if(state?.id) currentBattleId = state.id;
          $('#battleId').value = currentBattleId || '';
          const st = (state?.status || state?.state || 'wait').toLowerCase();
          updateBattleState(/live|running|in_progress/.test(st) ? 'live' : /end|ended|finished/.test(st) ? 'end' : 'wait');
          renderRoster(state);
          if(state?.log && Array.isArray(state.log)){
            const last = state.log.slice(-5);
            last.forEach(l=> appendLog(l.type||'event', l.message||''));
          }
        }catch(e){
          appendLog('error','상태 렌더링 오류');
        }
      });

      socket.on('chatMessage', (msg)=>{
        const sender = msg?.sender || msg?.role || '채널';
        const text = msg?.message || '';
        appendChat(sender, text);
      });
    }

    connectSocket();

    // ===== Controls
    const elBattleId = $('#battleId');
    const elMode = $('#battleMode');

    $('#createBattleBtn').addEventListener('click', async ()=>{
      try{
        const mode = elMode.value || '2v2';
        const r = await fetchJSON('/api/battles', { method:'POST', body: JSON.stringify({ mode }) });
        if(r?.id || r?.battleId){
          currentBattleId = r.id || r.battleId;
          elBattleId.value = currentBattleId;
          const q = new URLSearchParams(location.search);
          q.set('battle', currentBattleId);
          history.replaceState(null, '', location.pathname+'?'+q.toString());
          appendLog('system', `전투 생성: ${currentBattleId}`);
          showToast('전투 생성 완료');
        } else {
          throw new Error('생성 결과에 ID 없음');
        }
      } catch(e){
        appendLog('error', '전투 생성 실패: ' + e.message);
        showToast('전투 생성 실패');
      }
    });

    $('#startBattleBtn').addEventListener('click', async ()=>{
      if(!currentBattleId){ showToast('전투 ID가 없습니다'); return; }
      try{
        await fetchJSON(`/api/admin/battles/${encodeURIComponent(currentBattleId)}/start`, { method:'POST', body: JSON.stringify({}) });
        updateBattleState('live');
        appendLog('system','전투 시작 명령 전송');
        showToast('전투 시작');
      }catch(e){
        appendLog('error','전투 시작 실패: '+e.message);
        showToast('전투 시작 실패');
      }
    });

    $('#endBattleBtn').addEventListener('click', async ()=>{
      if(!currentBattleId){ showToast('전투 ID가 없습니다'); return; }
      try{
        await fetchJSON(`/api/admin/battles/${encodeURIComponent(currentBattleId)}/end`, { method:'POST', body: JSON.stringify({}) });
        updateBattleState('end');
        appendLog('system','전투 종료 명령 전송');
        showToast('전투 종료');
      }catch(e){
        appendLog('error','전투 종료 실패: '+e.message);
        showToast('전투 종료 실패');
      }
    });

    $('#restartBattleBtn').addEventListener('click', async ()=>{
      if(!currentBattleId){ showToast('전투 ID가 없습니다'); return; }
      try{
        await fetchJSON(`/api/admin/battles/${encodeURIComponent(currentBattleId)}/start`, { method:'POST', body: JSON.stringify({ restart:true }) });
        updateBattleState('live');
        appendLog('system','전투 재시작 명령 전송');
        showToast('전투 재시작');
      }catch(e){
        appendLog('error','전투 재시작 실패: '+e.message);
        showToast('전투 재시작 실패');
      }
    });

    $('#generateLinksBtn').addEventListener('click', async ()=>{
      if(!currentBattleId){ showToast('전투 ID가 없습니다'); return; }
      try{
        const r = await fetchJSON(`/api/admin/battles/${encodeURIComponent(currentBattleId)}/links`, { method:'POST', body: JSON.stringify({}) });
        $('#adminLink').value     = r?.admin     || r?.links?.admin     || '';
        $('#playerLink').value    = r?.player    || r?.links?.player    || '';
        $('#spectatorLink').value = r?.spectator || r?.links?.spectator || '';
        appendLog('system','링크 생성 완료');
        showToast('링크 생성 완료');
      }catch(e){
        appendLog('error','링크 생성 실패: '+e.message);
        showToast('링크 생성 실패');
      }
    });

    $('#addPlayerBtn').addEventListener('click', async ()=>{
      if(!currentBattleId){ showToast('전투 ID가 없습니다'); return; }
      const name = ($('#playerName').value||'').trim();
      const team = $('#playerTeam').value; // phoenix / eaters
      if(!name){ showToast('이름을 입력하세요'); return; }
      const atk = clamp($('#statAtk').value,1,5);
      const def = clamp($('#statDef').value,1,5);
      const agi = clamp($('#statAgi').value,1,5);
      const luk = clamp($('#statLuk').value,1,5);
      const hp  = clamp($('#playerHp').value,1,1000);
      const itemKey = $('#itemSelect').value || '';
      const itemsArray = itemKey ? [itemKey] : [];

      try{
        const r = await fetchJSON(`/api/battles/${encodeURIComponent(currentBattleId)}/players`, {
          method:'POST',
          body: JSON.stringify({
            name,
            team,
            // 서버가 stats 내부 필드명에 atk/def/agi/luk를 사용하는 경우를 고려
            stats: { atk, def, agi, luk },
            hp,
            items: itemsArray
          })
        });
        appendLog('system', `플레이어 추가: ${name} (${team}) / HP ${hp}${itemKey ? ' / 아이템 '+itemKey : ''}`);
        showToast('플레이어 추가 완료');
        // 필드 리셋
        $('#playerName').value = '';
        $('#playerTeam').value = 'phoenix';
        $('#statAtk').value = 3;
        $('#statDef').value = 3;
        $('#statAgi').value = 3;
        $('#statLuk').value = 3;
        $('#playerHp').value = 100;
        $('#itemSelect').value = '';
        // 서버가 battleUpdate로 최신 상태를 다시 푸시할 것으로 기대
      }catch(e){
        appendLog('error','플레이어 추가 실패: '+e.message);
        showToast('플레이어 추가 실패');
      }
    });

    // 채팅
    function sendAdminChat(){
      const v = $('#chatInput').value.trim();
      if(!v) return;
      if(socket && authed){
        socket.emit('chatMessage', { role:'admin', message:v, battleId: currentBattleId });
      }
      appendChat('관리자', v);
      $('#chatInput').value = '';
    }
    $('#chatSendBtn').addEventListener('click', sendAdminChat);
    $('#chatInput').addEventListener('keydown',(e)=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        sendAdminChat();
      }
    });

    // 전역 Enter로 폼 submit 되는 것 방지(채팅 제외)
    document.addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){
        const t = e.target;
        if(t && t.id === 'chatInput') return; // 채팅은 허용
        if(["INPUT","SELECT","TEXTAREA"].includes((t?.tagName)||'')){
          e.preventDefault();
        }
      }
    });

    // URL 파라미터에 battle/token이 있는 경우 자동 인증 시도
    (function boot(){
      if(currentBattleId){ $('#battleId').value = currentBattleId; }
    })();
  </script>
</body>
</html>
