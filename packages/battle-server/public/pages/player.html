<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PYXIS - 전투 참여</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    /* ===== Base / Reset ===== */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #000 50%, #0a0a0a 100%);
      color: #f8f6f0;
      font-size: 14px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
    }

    /* ===== Theme Variables (Black tone) ===== */
    :root {
      --black-0: #000000;
      --black-1: #0a0a0a;
      --black-2: #121212;
      --black-3: #1a1a1a;
      --black-4: #232323;
      --panel-1: rgba(26,26,26,.92);
      --panel-2: rgba(18,18,18,.92);

      --gold: #d4b77e;
      --gold-dark: #c5a266;
      --gold-bright: #e6d3aa;

      --text: #faf9f6;
      --text-dim: #e0d5c4;
      --text-muted: #b8a898;

      --border-subtle: rgba(212,183,126,.10);
      --border-1: rgba(212,183,126,.22);
      --border-2: rgba(212,183,126,.36);

      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --info: #3498db;

      --shadow-soft: 0 4px 12px rgba(0,0,0,.25);
      --shadow-medium: 0 8px 24px rgba(0,0,0,.35);
      --shadow-glow: 0 0 20px rgba(212,183,126,.25);

      --radius: 14px;
      --radius-small: 8px;
      --radius-large: 18px;

      --transition-fast: .18s cubic-bezier(.4,0,.2,1);
      --transition-normal: .28s cubic-bezier(.4,0,.2,1);
    }

    /* ===== Container & Layout ===== */
    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px 14px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ===== Header ===== */
    .header {
      text-align: center;
      padding: 20px 0 16px;
      margin-bottom: 12px;
      position: relative;
    }
    .brand {
      font-family: 'Cinzel', serif;
      font-size: 28px;
      font-weight: 700;
      letter-spacing: 0.06em;
      background: linear-gradient(135deg, var(--gold), #fff, var(--gold-bright));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .subtitle {
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-muted);
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    /* ===== Main Grid (L:280 / C:flex / R:320) ===== */
    .player-layout {
      display: grid;
      grid-template-columns: 280px 1fr 360px;
      gap: 18px;
      flex: 1;
      align-items: start;
    }

    /* ===== Card Base ===== */
    .card {
      background: var(--panel-1);
      border: 1.5px solid var(--border-1);
      border-radius: var(--radius);
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow-soft);
      transition: var(--transition-normal);
      position: relative;
      overflow: hidden;
    }
    .card:hover {
      border-color: var(--gold);
      box-shadow: var(--shadow-medium), var(--shadow-glow);
      transform: translateY(-1px);
    }
    .card-header { padding: 14px 16px; border-bottom: 1px solid var(--border-1); }
    .card-title { font-size: 15px; font-weight: 600; color: var(--text); }
    .card-body { padding: 14px 16px 16px; }

    /* ===== Left column ===== */
    .player-info-column { display: flex; flex-direction: column; gap: 14px; }

    .my-player-card { text-align: center; }
    .my-avatar {
      width: 64px; height: 64px; border-radius: 50%;
      border: 2px solid var(--gold); object-fit: cover; margin: 0 auto 10px;
      box-shadow: 0 0 15px rgba(212,183,126,.35);
      background: #111;
    }
    .my-name { font-size: 16px; font-weight: 700; margin-bottom: 2px; }
    .my-team {
      font-size: 11px; color: var(--gold); font-weight: 700; text-transform: uppercase; letter-spacing:.05em;
      padding: 2px 8px; background: rgba(212,183,126,.08); border-radius: 6px; display: inline-block; margin-bottom: 10px;
    }

    .my-stats { display: grid; grid-template-columns: repeat(2,1fr); gap: 8px; margin-bottom: 10px; }
    .stat-item {
      text-align: center; padding: 8px; background: var(--panel-2);
      border: 1px solid var(--border-subtle); border-radius: 8px;
    }
    .stat-label { display:block; font-size: 10px; color: var(--text-muted); margin-bottom: 2px; text-transform: uppercase; letter-spacing:.05em;}
    .stat-value { font-size: 14px; font-weight: 700; color: var(--gold); }

    .hp-display { display:flex; justify-content:space-between; margin:6px 0 6px;}
    .hp-label { font-size: 12px; font-weight: 600;}
    .hp-value { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--success); font-weight: 600; }
    .hp-bar { height: 6px; background: #0e0e0e; border:1px solid var(--border-subtle); border-radius: 3px; overflow: hidden;}
    .hp-fill { height:100%; background: linear-gradient(90deg, var(--gold-dark), var(--gold-bright)); transition: width .5s ease; }

    /* Actions */
    .action-grid { display:grid; grid-template-columns: repeat(2,1fr); gap: 10px; }
    .action-btn {
      padding: 10px 12px;
      background: var(--panel-2);
      border: 1.8px solid var(--gold); /* 금색 통일 */
      border-radius: 10px;
      color: var(--text);
      font-size: 13px; font-weight: 700;
      cursor: pointer; transition: var(--transition-normal);
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      min-height: 42px;
    }
    .action-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-medium), 0 0 16px rgba(212,183,126,.28); color: var(--gold-bright); }
    .action-key { font-size: 10px; opacity: .8; background: rgba(212,183,126,.16); padding: 2px 6px; border-radius: 4px; font-family:'JetBrains Mono', monospace; }

    /* Target select */
    .target-wrap { margin-top: 10px; display:flex; gap:8px; align-items:center; }
    .target-wrap label { font-size: 12px; color: var(--text-muted); }
    .target-select {
      flex:1; padding:8px 10px; background: var(--panel-2); color: var(--text);
      border: 1px solid var(--border-1); border-radius: 8px;
    }

    /* Items */
    .items-section {
      padding: 10px; background: var(--panel-2); border: 1px solid var(--border-subtle); border-radius: 10px;
    }
    .items-title { font-size: 12px; font-weight: 700; text-align:center; margin-bottom: 6px; }
    .items-grid { display:grid; grid-template-columns: repeat(3,1fr); gap:6px; }
    .item-slot {
      text-align:center; padding:8px; background:#0f0f0f; border:1px solid var(--border-1); border-radius:8px; cursor:pointer;
      transition: var(--transition-fast);
    }
    .item-slot:hover { transform: translateY(-1px); border-color: var(--gold); }
    .item-name { font-size:10px; color: var(--text-dim); margin-bottom: 2px;}
    .item-count { font-size:11px; font-weight:700; color: var(--gold); }

    /* Teammates and Enemies */
    .teammates-list, .enemy-list { display:flex; flex-direction:column; gap:8px; }
    .teammate-item, .enemy-item {
      display:flex; align-items:center; gap:8px; padding:8px; background: var(--panel-2);
      border:1px solid var(--border-subtle); border-radius:8px; transition: var(--transition-fast);
    }
    .enemy-item { cursor: pointer; }
    .enemy-item:hover { border-color: var(--gold); }
    .teammate-avatar, .enemy-avatar {
      width:28px; height:28px; border-radius:50%; object-fit:cover; background:#111; border:1px solid var(--gold);
    }
    .teammate-info, .enemy-info { flex:1; min-width:0; }
    .name { font-size:12px; font-weight:600; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .hpmeta { font-size:10px; color:var(--text-muted); font-family:'JetBrains Mono', monospace; }
    .badge { font-size:10px; padding:2px 6px; border-radius: 999px; border:1px solid var(--border-1); }
    .alive { color: var(--success); }
    .down { color: var(--danger); }

    /* ===== Center column ===== */
    .center-column { display:flex; flex-direction:column; gap:14px; }
    .turn-info {
      text-align:center; padding:18px; background: var(--panel-1);
      border:1px solid var(--border-2); border-radius: var(--radius);
      position:relative; overflow:hidden;
    }
    .turn-phase { font-size:18px; font-weight:800; color: var(--gold); margin-bottom:6px; }
    .current-player { font-size:13px; color: var(--text-dim); margin-bottom:4px; }
    .turn-timer { font-size:12px; color: var(--text-muted); font-family:'JetBrains Mono', monospace; }

    .current-actor {
      display:flex; flex-direction:column; align-items:center; gap:10px;
      padding:20px 16px; background: var(--panel-1);
      border:1px solid var(--border-1); border-radius: var(--radius);
    }
    .actor-avatar { width:110px; height:110px; border-radius:50%; border:2px solid var(--gold); background:#111; object-fit:cover; }
    .actor-name { font-weight:800; }

    /* Chat wide in center */
    .chat-card .card-body { display:flex; flex-direction:column; gap:10px; }
    .chat-messages {
      height: 260px; overflow-y:auto; padding:8px; background: var(--panel-2);
      border:1px solid var(--border-subtle); border-radius:10px;
      scrollbar-width: thin; scrollbar-color: var(--gold) #111;
    }
    .chat-messages::-webkit-scrollbar { width:6px; }
    .chat-messages::-webkit-scrollbar-thumb { background: var(--gold); border-radius:3px; }
    .chat-message { margin-bottom:8px; font-size:12px; }
    .chat-author { font-weight:700; color: var(--gold); margin-right:6px; }
    .chat-text { color: var(--text-dim); }
    .chat-input-area { display:flex; gap:8px; }
    .chat-input {
      flex:1; padding:10px; background:#0f0f0f; color:var(--text);
      border:1px solid var(--border-1); border-radius:8px;
    }
    .chat-send {
      padding: 10px 14px; background: linear-gradient(145deg, var(--gold), var(--gold-dark));
      color:#111; border:none; border-radius:8px; font-weight:800; cursor:pointer; transition: var(--transition-fast);
    }
    .chat-send:hover { transform: translateY(-1px); box-shadow: var(--shadow-glow); }

    /* ===== Right column ===== */
    .enemy-column { display:flex; flex-direction:column; gap:14px; }
    .team-title { font-size:12px; color:var(--text-muted); margin-left:2px; margin-top:-4px; }

    /* Battle log (moved under enemies) */
    .battle-log {
      height: 220px; overflow-y:auto; background: var(--panel-2); border:1px solid var(--border-subtle); border-radius:10px; padding:8px;
      scrollbar-width: thin; scrollbar-color: var(--gold) #111;
    }
    .battle-log::-webkit-scrollbar { width:6px; }
    .log-entry { padding:8px; margin-bottom:6px; border-radius:8px; font-size:12px; line-height:1.4; position:relative; }
    .log-system { background: rgba(52,152,219,.1); border-left:3px solid var(--info); color:#dbe9ff; }
    .log-action { background: rgba(243,156,18,.1); border-left:3px solid var(--warning); }
    .log-damage { background: rgba(231,76,60,.1); border-left:3px solid var(--danger); }
    .log-heal { background: rgba(39,174,96,.1); border-left:3px solid var(--success); }
    .log-timestamp { font-size:10px; color: var(--text-muted); float:right; }

    /* Toast */
    .toast {
      position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%) translateY(16px);
      background: #111; color:#fff; border:1px solid var(--gold); border-radius:10px;
      padding:8px 12px; opacity:0; pointer-events:none; transition: .28s ease;
      box-shadow: var(--shadow-glow);
      z-index: 50;
    }
    .toast.show { opacity:1; transform: translateX(-50%) translateY(0); }

    /* ===== Responsive ===== */
    @media (max-width: 1200px) {
      .player-layout { grid-template-columns: 1fr; }
      .enemy-column, .player-info-column, .center-column { order: initial; }
      .chat-messages { height: 260px; }
    }
    @media (max-width: 640px) {
      .brand { font-size: 24px; }
      .action-grid { grid-template-columns: 1fr; }
      .chat-messages { height: 220px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <h1 class="brand">Pyxis</h1>
      <p class="subtitle">Battle Arena System</p>
    </header>

    <!-- Main Layout -->
    <main class="player-layout">
      <!-- Left: My info / actions / items / allies -->
      <section class="player-info-column">
        <!-- 내 정보 -->
        <div class="card my-player-card">
          <div class="card-header"><h2 class="card-title">내 정보</h2></div>
          <div class="card-body">
            <img id="myAvatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=player" alt="아바타" class="my-avatar">
            <div class="my-name" id="playerName">플레이어</div>
            <div class="my-team" id="playerTeam">불사조 기사단</div>
            <div class="my-stats">
              <div class="stat-item"><span class="stat-label">공격</span><span class="stat-value" id="statAttack">-</span></div>
              <div class="stat-item"><span class="stat-label">방어</span><span class="stat-value" id="statDefense">-</span></div>
              <div class="stat-item"><span class="stat-label">민첩</span><span class="stat-value" id="statAgility">-</span></div>
              <div class="stat-item"><span class="stat-label">행운</span><span class="stat-value" id="statLuck">-</span></div>
            </div>
            <div class="hp-display">
              <span class="hp-label">체력</span>
              <span class="hp-value" id="playerHp">-/-</span>
            </div>
            <div class="hp-bar"><div class="hp-fill" id="playerHpBar" style="width:0%"></div></div>
          </div>
        </div>

        <!-- 행동 + 대상 선택 -->
        <div class="card">
          <div class="card-header"><h2 class="card-title">행동 선택</h2></div>
          <div class="card-body">
            <div class="action-grid">
              <button id="btnAttack" class="action-btn"><span class="label">공격</span><span class="action-key">Q</span></button>
              <button id="btnDefend" class="action-btn"><span class="label">방어</span><span class="action-key">W</span></button>
              <button id="btnDodge"  class="action-btn"><span class="label">회피</span><span class="action-key">E</span></button>
              <button id="btnPass"   class="action-btn"><span class="label">패스</span><span class="action-key">R</span></button>
            </div>
            <div class="target-wrap">
              <label for="targetSelect">대상</label>
              <select id="targetSelect" class="target-select">
                <option value="">적군 선택</option>
              </select>
            </div>
          </div>
        </div>

        <!-- 아이템 -->
        <div class="items-section">
          <div class="items-title">보유 아이템</div>
          <div class="items-grid" id="itemsGrid">
            <!-- 동적 채움 -->
          </div>
        </div>

        <!-- 아군 팀원 -->
        <div class="card">
          <div class="card-header"><h2 class="card-title">아군 팀원</h2></div>
          <div class="card-body">
            <div class="teammates-list" id="teammatesList">
              <div style="color:var(--text-muted); font-size:12px;">대기중</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Center: Turn + Current Actor + Chat (wide) -->
      <section class="center-column">
        <!-- 턴 정보 -->
        <div class="turn-info">
          <div class="turn-phase" id="turnPhase">대기중</div>
          <div class="current-player" id="currentPlayer">-</div>
          <div class="turn-timer" id="turnTimer">--:--</div>
        </div>

        <!-- 현재 전투자 -->
        <div class="current-actor">
          <img id="currentActorAvatar" class="actor-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=unknown" alt="현재 전투자">
          <div class="actor-name" id="currentActorName">현재 전투자</div>
        </div>

        <!-- 팀 채팅 (넓게) -->
        <div class="card chat-card">
          <div class="card-header"><h2 class="card-title">팀 채팅</h2></div>
          <div class="card-body">
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-area">
              <input type="text" class="chat-input" id="chatInput" placeholder="메시지를 입력하세요..." maxlength="200">
              <button class="chat-send" id="chatSend">전송</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Right: Enemies + BattleLog (log moved under enemies) -->
      <section class="enemy-column">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">적군 팀원</h2>
            <div class="team-title">죽음을 먹는 자</div>
          </div>
          <div class="card-body">
            <div class="enemy-list" id="enemyList">
              <div style="color:var(--text-muted); font-size:12px;">대기중</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><h2 class="card-title">전투 로그</h2></div>
          <div class="card-body">
            <div class="battle-log" id="battleLog">
              <div style="color:var(--text-muted); font-size:12px;">전투 로그가 여기에 표시됩니다</div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Socket.IO loader (local -> CDN fallback) -->
  <script>
    (function ensureSocketIO(){
      if (window.io) return;
      function add(src, onload, onerror){
        var s=document.createElement('script'); s.src=src; s.async=true; s.onload=onload; s.onerror=onerror; document.head.appendChild(s);
      }
      add('/socket.io/socket.io.js', function(){}, function(){
        add('https://cdn.socket.io/4.7.5/socket.io.min.js', function(){}, function(){
          console.warn('Socket.IO client load failed');
        });
      });
    })();
  </script>

  <!-- Player Logic (연동) -->
  <script>
    (function(){
      const $  = (sel, root=document) => root.querySelector(sel);
      const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
      function text(el, v){ if(el) el.textContent = String(v == null ? '' : v); }
      function escapeHTML(v){ const d=document.createElement('div'); d.textContent=String(v ?? ''); return d.innerHTML; }
      function toast(msg){
        const el = $('#toast'); if(!el) return;
        el.textContent = msg; el.classList.add('show');
        clearTimeout(el._t); el._t=setTimeout(()=>el.classList.remove('show'), 1600);
      }
      function teamKey(t){
        const s = String(t||'').toLowerCase();
        if(['phoenix','a','team1'].includes(s)) return 'phoenix';
        if(['eaters','b','team2','death','deatheaters'].includes(s)) return 'eaters';
        return 'phoenix';
      }
      function teamLabel(key){ return key==='phoenix' ? '불사조 기사단' : '죽음을 먹는 자'; }
      function dicebear(seed){ return `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(seed||'user')}`; }
      function nowHHMM(){
        const t=new Date(); const h=String(t.getHours()).padStart(2,'0'); const m=String(t.getMinutes()).padStart(2,'0'); return `${h}:${m}`;
      }

      class PlayerApp {
        constructor(){
          const url = new URL(location.href);
          this.battleId = url.searchParams.get('battle') || '';
          this.token    = url.searchParams.get('token')  || '';
          this.name     = url.searchParams.get('name')   || '';

          this.socket = null;
          this.connected=false; this.authed=false;
          this.me=null; this.players=[]; this.turnFor=null;
          this.turnEndsAt=null; this._timer=null;

          // Elements
          this.el = {
            myAvatar:     $('#myAvatar'),
            myName:       $('#playerName'),
            myTeam:       $('#playerTeam'),
            statAtk:      $('#statAttack'),
            statDef:      $('#statDefense'),
            statAgi:      $('#statAgility'),
            statLuk:      $('#statLuck'),
            hpText:       $('#playerHp'),
            hpBar:        $('#playerHpBar'),

            targetSelect: $('#targetSelect'),
            itemsGrid:    $('#itemsGrid'),
            allies:       $('#teammatesList'),
            enemies:      $('#enemyList'),

            btnAttack:    $('#btnAttack'),
            btnDefend:    $('#btnDefend'),
            btnDodge:     $('#btnDodge'),
            btnPass:      $('#btnPass'),

            chatBox:      $('#chatMessages'),
            chatInput:    $('#chatInput'),
            chatSend:     $('#chatSend'),

            turnPhase:    $('#turnPhase'),
            currentPlayer:$('#currentPlayer'),
            turnTimer:    $('#turnTimer'),

            actAvatar:    $('#currentActorAvatar'),
            actName:      $('#currentActorName'),

            logBox:       $('#battleLog'),
          };

          this.bind();
          this.connect();
        }

        bind(){
          // Chat
          this.el.chatSend?.addEventListener('click', ()=>this.sendChat());
          this.el.chatInput?.addEventListener('keydown', (e)=>{
            if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); this.sendChat(); }
          });

          // Actions
          this.el.btnAttack?.addEventListener('click', ()=>this.act('attack'));
          this.el.btnDefend?.addEventListener('click', ()=>this.act('defend'));
          this.el.btnDodge ?.addEventListener('click', ()=>this.act('dodge'));
          this.el.btnPass  ?.addEventListener('click', ()=>this.act('pass'));

          // Keyboard shortcuts (ignore when typing)
          document.addEventListener('keydown', (e)=>{
            const tag=(e.target && e.target.tagName || '').toUpperCase();
            if(tag==='INPUT' || tag==='TEXTAREA' || e.metaKey || e.ctrlKey || e.altKey) return;
            const k=e.key.toLowerCase();
            if(k==='q') this.el.btnAttack?.click();
            else if(k==='w') this.el.btnDefend?.click();
            else if(k==='e') this.el.btnDodge?.click();
            else if(k==='r') this.el.btnPass?.click();
          });
        }

        /* ============ Networking ============ */
        connect(){
          if(!this.battleId || !this.token) toast('전투 ID 또는 토큰이 없습니다');
          // eslint-disable-next-line no-undef
          this.socket = io({transports:['websocket','polling']});

          this.socket.on('connect', ()=>{
            this.connected=true;
            if(this.battleId && this.token){
              this.socket.emit('playerAuth', {battleId:this.battleId, token:this.token, name:this.name || undefined});
            }
          });

          this.socket.on('disconnect', ()=>{
            this.connected=false; this.authed=false;
            toast('연결이 끊어졌습니다');
          });

          this.socket.on('authSuccess', (state)=>{
            this.authed=true;
            this.applyState(state);
            toast('인증 완료');
          });

          this.socket.on('authError', ()=>{
            this.authed=false;
            toast('인증 실패');
          });

          // State updates
          this.socket.on('battleUpdate', (state)=> this.applyState(state));

          // Chat relay
          this.socket.on('chatMessage', (msg)=>{
            const sender = msg?.sender || msg?.role || '채널';
            const text   = msg?.message || '';
            this.appendChat(sender, text);
          });

          // Direct log line
          this.socket.on('log', (line)=>{
            if(line) this.appendLog('system', line);
          });
        }

        /* ============ State ============ */
        applyState(state){
          if(!state) return;

          // Players
          if(Array.isArray(state.players)){
            this.players = state.players.slice();
            // who am i
            this.me = this.resolveMe(state);
            this.renderMe();
            this.renderTeams();
            this.populateTargets();
            this.renderItems();
          }

          // Turn
          this.updateTurn(state);

          // Log (append last few)
          if(Array.isArray(state.log)){
            state.log.slice(-10).forEach(entry=>{
              const msg = typeof entry === 'string' ? entry : (entry.message || entry.text || '');
              if(msg) this.appendLog('action', msg);
            });
          }
        }

        resolveMe(state){
          if(state.self && (state.self.id || state.self.name)) return state.self;
          const byToken = this.players.find(p => p.token === this.token);
          if(byToken) return byToken;
          if(this.name){
            const nm = this.name.toLowerCase();
            const byName = this.players.find(p => (p.name||'').toLowerCase() === nm);
            if(byName) return byName;
          }
          return null;
        }

        renderMe(){
          const m = this.me || {};
          const tk = teamKey(m.team);
          text(this.el.myName, m.name || (this.name || '플레이어'));
          text(this.el.myTeam, teamLabel(tk));
          this.el.myAvatar?.setAttribute('src', typeof m.avatar==='string' && m.avatar ? m.avatar : dicebear(m.name||'me'));

          const a = m.stats?.atk ?? m.atk ?? '-';
          const d = m.stats?.def ?? m.def ?? '-';
          const g = m.stats?.agi ?? m.agi ?? '-';
          const l = m.stats?.luk ?? m.luk ?? '-';
          text(this.el.statAtk, a); text(this.el.statDef, d); text(this.el.statAgi, g); text(this.el.statLuk, l);

          const hp = typeof m.hp === 'number' ? m.hp : (m.stats?.hp ?? null);
          const mx = typeof m.maxHp === 'number' ? m.maxHp : (m.stats?.maxHp ?? 100);
          const cur = (typeof hp==='number') ? hp : mx;
          text(this.el.hpText, `${cur}/${mx}`);
          if(this.el.hpBar) this.el.hpBar.style.width = Math.max(0, Math.min(100, (cur/mx)*100)) + '%';
        }

        renderTeams(){
          const myKey = teamKey(this.me?.team);
          const allies = this.players.filter(p => teamKey(p.team) === myKey);
          const enemies= this.players.filter(p => teamKey(p.team) !== myKey);

          // Allies
          const A = this.el.allies; A.innerHTML='';
          if(allies.length===0){
            A.innerHTML = `<div style="color:var(--text-muted); font-size:12px;">대기중</div>`;
          } else {
            allies.forEach(p=>{
              const hp  = (typeof p.hp==='number') ? p.hp : (p.stats?.hp ?? '-');
              const mx  = (typeof p.maxHp==='number') ? p.maxHp : (p.stats?.maxHp ?? 100);
              const st  = (p.alive===false || p.status==='down') ? 'down' : 'alive';
              const row = document.createElement('div');
              row.className='teammate-item';
              row.innerHTML=`
                <img class="teammate-avatar" src="${escapeHTML(typeof p.avatar==='string'&&p.avatar?p.avatar:dicebear(p.name||'ally'))}" alt="">
                <div class="teammate-info">
                  <div class="name">${escapeHTML(p.name||'팀원')}</div>
                  <div class="hpmeta">HP ${hp ?? '?'} / ${mx ?? '?'}</div>
                </div>
                <span class="badge ${st}">${st==='down'?'이탈':'생존'}</span>
              `;
              A.appendChild(row);
            });
          }

          // Enemies (click to select target)
          const E = this.el.enemies; E.innerHTML='';
          if(enemies.length===0){
            E.innerHTML = `<div style="color:var(--text-muted); font-size:12px;">대기중</div>`;
          } else {
            enemies.forEach(p=>{
              const hp  = (typeof p.hp==='number') ? p.hp : (p.stats?.hp ?? '-');
              const mx  = (typeof p.maxHp==='number') ? p.maxHp : (p.stats?.maxHp ?? 100);
              const st  = (p.alive===false || p.status==='down') ? 'down' : 'alive';
              const row = document.createElement('div');
              row.className='enemy-item';
              row.setAttribute('data-id', p.id ?? p._id ?? '');
              row.innerHTML=`
                <img class="enemy-avatar" src="${escapeHTML(typeof p.avatar==='string'&&p.avatar?p.avatar:dicebear(p.name||'enemy'))}" alt="">
                <div class="enemy-info">
                  <div class="name">${escapeHTML(p.name||'적군')}</div>
                  <div class="hpmeta">HP ${hp ?? '?'} / ${mx ?? '?'}</div>
                </div>
                <span class="badge ${st}">${st==='down'?'이탈':'생존'}</span>
              `;
              row.addEventListener('click', ()=>{
                const sel = this.el.targetSelect;
                const id  = p.id ?? p._id ?? '';
                if(sel && id){
                  sel.value = id;
                  toast(`${p.name||'대상'} 선택됨`);
                }
              });
              E.appendChild(row);
            });
          }
        }

        populateTargets(){
          const myKey = teamKey(this.me?.team);
          const enemies= this.players.filter(p => teamKey(p.team) !== myKey && (p.alive!==false && p.status!=='down'));
          const sel = this.el.targetSelect; sel.innerHTML = `<option value="">적군 선택</option>`;
          enemies.forEach(p=>{
            const id = p.id ?? p._id ?? '';
            const opt=document.createElement('option');
            opt.value=id; opt.textContent = p.name || ('적군 '+(id?String(id).slice(-4):''));
            sel.appendChild(opt);
          });
        }

        renderItems(){
          const grid = this.el.itemsGrid; grid.innerHTML='';
          const m=this.me||{};
          // 서버가 배열/맵/숫자 등의 다양한 형태일 수 있으므로 안전하게 추출
          const raw = m.items || m.inventory || {};
          const items = this.normalizeItems(raw);
          const defList = [
            {key:'detiny', label:'디터니'},
            {key:'atkBoost', label:'공격증강'},
            {key:'defBoost', label:'방어증강'},
          ];
          defList.forEach(it=>{
            const cnt = items[it.key] ?? 0;
            const div = document.createElement('div');
            div.className='item-slot';
            div.innerHTML=`<div class="item-name">${it.label}</div><div class="item-count">×${cnt}</div>`;
            div.addEventListener('click', ()=>{
              if(cnt<=0) return toast('해당 아이템이 없습니다');
              // 간단히 액션만 보냄. 필요시 서버에서 소모 처리
              this.socket?.emit('player:action', { battleId:this.battleId, playerId:this.me?.id, action:'useItem', item:it.key }, (res)=>{
                toast(res?.success?'아이템 사용 요청 전송':'아이템 사용 실패');
              });
            });
            grid.appendChild(div);
          });
        }

        normalizeItems(raw){
          if(Array.isArray(raw)){
            const out={}; raw.forEach(x=>{ if(x&&x.key) out[x.key]=(x.count||x.qty||1); }); return out;
          } else if (typeof raw==='object' && raw) {
            const out={}; Object.keys(raw).forEach(k=> out[k]=Number(raw[k])||0 ); return out;
          }
          return {};
        }

        updateTurn(state){
          const t = state.turn || {};
          // current: id or name
          this.turnFor = t.current || null;
          // timer
          if(t.endsAt) this.turnEndsAt = Number(t.endsAt);
          else if(typeof t.remainingMs==='number') this.turnEndsAt = Date.now() + t.remainingMs;
          else this.turnEndsAt = null;

          // label
          let phase = '진행중';
          if(state.phase==='finished') phase='전투 종료';
          else if(state.phase==='waiting') phase='대기중';
          text(this.el.turnPhase, phase);

          // current actor
          const actor = this.findByIdOrName(this.turnFor) || null;
          text(this.el.currentPlayer, actor ? `${actor.name||'-'}의 차례` : '-');
          text(this.el.actName, actor ? (actor.name||'-') : '현재 전투자');
          this.el.actAvatar?.setAttribute('src', actor?.avatar || dicebear(actor?.name||'turn'));

          // enable/disable buttons
          const isMine = actor && this.me && (this.idMatch(actor, this.me));
          const enable = !!isMine && this.authed;
          [this.el.btnAttack,this.el.btnDefend,this.el.btnDodge,this.el.btnPass].forEach(b=>{ if(b) b.disabled = !enable; });

          // timer tick
          if(this._timer) clearInterval(this._timer);
          if(this.turnEndsAt){
            this.tickTimer();
            this._timer = setInterval(()=>this.tickTimer(), 500);
          } else {
            text(this.el.turnTimer, '--:--');
          }
        }

        tickTimer(){
          const left = Math.max(0, this.turnEndsAt - Date.now());
          const sec = Math.ceil(left/1000);
          const mm = String(Math.floor(sec/60)).padStart(2,'0');
          const ss = String(sec%60).padStart(2,'0');
          text(this.el.turnTimer, `${mm}:${ss}`);
          if(left<=0 && this._timer){ clearInterval(this._timer); this._timer=null; }
        }

        findByIdOrName(idOrName){
          if(!idOrName) return null;
          let t = this.players.find(p => (p.id===idOrName || p._id===idOrName));
          if(t) return t;
          const nm = String(idOrName).toLowerCase();
          return this.players.find(p => (p.name||'').toLowerCase()===nm) || null;
        }
        idMatch(a,b){ return !!(a && b && (a.id && b.id && a.id===b.id) || (a.name && b.name && a.name===b.name)); }

        /* ============ Chat / Log ============ */
        sendChat(){
          const v = (this.el.chatInput?.value || '').trim(); if(!v) return;
          if(this.socket?.connected && this.authed){
            this.socket.emit('chatMessage', { role:'player', message:v, battleId:this.battleId });
          }
          this.appendChat(this.me?.name || '나', v);
          this.el.chatInput.value='';
        }
        appendChat(sender, msg){
          const box = this.el.chatBox; if(!box) return;
          const row = document.createElement('div');
          row.className='chat-message';
          row.innerHTML = `<span class="chat-author">${escapeHTML(sender)}:</span> <span class="chat-text">${escapeHTML(msg)}</span>`;
          box.appendChild(row); box.scrollTop = box.scrollHeight;
        }
        appendLog(kind, message){
          const box = this.el.logBox; if(!box) return;
          const row = document.createElement('div');
          row.className = 'log-entry ' + (kind==='system'?'log-system':kind==='heal'?'log-heal':kind==='damage'?'log-damage':'log-action');
          row.innerHTML = `<span class="log-timestamp">${nowHHMM()}</span> ${escapeHTML(message)}`;
          box.appendChild(row); box.scrollTop = box.scrollHeight;
        }

        /* ============ Actions ============ */
        act(kind){
          if(!this.authed || !this.socket?.connected) return toast('행동 불가 상태입니다');
          if(!this.me?.id) return toast('플레이어 정보가 없습니다');

          let payload = { battleId:this.battleId, playerId:this.me.id, action:kind };

          // target for attack (optional)
          if(kind==='attack'){
            const sel = this.el.targetSelect;
            let targetId = sel?.value || '';
            if(!targetId){
              // 자동 선택: 살아있는 적 1순위
              const myKey = teamKey(this.me?.team);
              const firstAlive = this.players.find(p=>teamKey(p.team)!==myKey && p.alive!==false && p.status!=='down');
              if(firstAlive) targetId = firstAlive.id || firstAlive._id || '';
            }
            if(!targetId){ toast('공격 대상을 선택하세요'); return; }
            payload.targetId = targetId;
          }

          this.socket.emit('player:action', payload, (res)=>{
            toast(res?.success ? '행동 전송 완료' : '행동 전송 실패');
          });
        }
      }

      // Launch
      document.addEventListener('DOMContentLoaded', ()=> new PlayerApp());
    })();
  </script>
</body>
</html>
