<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PYXIS Battle System - 전투 참가자</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/pyxis-theme.css">
  <link rel="stylesheet" href="/assets/css/player.css">
  <style>
    /* 플레이어 페이지 완전 수정 - 3단 레이아웃 복구 */
    .player-main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      align-items: start;
    }

    @media (max-width: 1200px) {
      .player-main-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
    }

    /* 왼쪽 패널 - 내 정보 */
    .my-info-section {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .my-panel {
      background: var(--glass-2);
      backdrop-filter: var(--blur-light);
      border: 1px solid var(--border-light);
      border-radius: var(--radius);
      padding: 20px;
      text-align: center;
    }

    .avatar-container {
      margin-bottom: 16px;
    }

    .avatar-img {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--gold);
      background: var(--navy-surface);
      box-shadow: var(--shadow-glow);
    }

    .player-name {
      font-family: var(--serif);
      font-size: 24px;
      font-weight: 600;
      color: var(--gold-bright);
      margin: 12px 0 8px 0;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .team-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .team-phoenix {
      background: linear-gradient(135deg, #ff6b35, #f7931e);
      color: white;
    }

    .team-death {
      background: linear-gradient(135deg, #2c3e50, #34495e);
      color: white;
    }

    /* 스탯 표시 */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 16px 0;
    }

    .stat-item {
      background: var(--glass-1);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-small);
      padding: 12px;
      text-align: center;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--gold-bright);
      font-family: var(--serif);
    }

    /* HP 바 */
    .hp-container {
      margin: 16px 0;
    }

    .hp-label {
      font-size: 14px;
      color: var(--text-accent);
      margin-bottom: 8px;
      text-align: center;
    }

    .hp-bar-bg {
      background: var(--navy-surface);
      border: 1px solid var(--border-light);
      border-radius: 10px;
      height: 20px;
      overflow: hidden;
      position: relative;
    }

    .hp-bar {
      background: linear-gradient(90deg, var(--success), #27ae60);
      height: 100%;
      transition: width 0.3s var(--ease-smooth);
      box-shadow: inset 0 2px 4px rgba(255,255,255,0.1);
    }

    .hp-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 12px;
      font-weight: 600;
      color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }

    /* 아이템 표시 */
    .items-container {
      margin-top: 16px;
    }

    .items-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 12px;
    }

    .item-slot {
      background: var(--glass-1);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-small);
      padding: 8px;
      text-align: center;
    }

    .item-name {
      font-size: 10px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .item-count {
      font-size: 16px;
      font-weight: 600;
      color: var(--gold-bright);
    }

    /* 중앙 패널 - 전투 현황 */
    .battle-status-section {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .turn-indicator {
      background: var(--glass-2);
      backdrop-filter: var(--blur-light);
      border: 1px solid var(--border-light);
      border-radius: var(--radius);
      padding: 20px;
      text-align: center;
    }

    .current-turn-avatar {
      margin-bottom: 16px;
    }

    .current-turn-img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--gold);
      box-shadow: var(--shadow-glow);
    }

    .current-turn-name {
      font-family: var(--serif);
      font-size: 18px;
      font-weight: 600;
      color: var(--gold-bright);
      margin-top: 12px;
    }

    .turn-timer {
      font-size: 14px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    /* 전투 로그 */
    .battle-log-container {
      background: var(--glass-2);
      backdrop-filter: var(--blur-light);
      border: 1px solid var(--border-light);
      border-radius: var(--radius);
      padding: 16px;
      height: 300px;
      overflow-y: auto;
    }

    .battle-log {
      font-size: 13px;
      line-height: 1.6;
    }

    .log-entry {
      margin-bottom: 8px;
      padding: 8px 12px;
      border-radius: var(--radius-small);
      background: var(--glass-1);
    }

    .log-entry.system {
      color: var(--text-accent);
      border-left: 3px solid var(--gold);
    }

    .log-entry.battle {
      color: var(--text);
      border-left: 3px solid var(--info);
    }

    .log-entry.chat {
      color: #96ffc8;
      border-left: 3px solid var(--success);
      background: var(--success-light);
    }

    /* 오른쪽 패널 - 액션 및 채팅 */
    .action-section {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* 액션 버튼들 */
    .action-panel {
      background: var(--glass-2);
      backdrop-filter: var(--blur-light);
      border: 1px solid var(--border-light);
      border-radius: var(--radius);
      padding: 20px;
    }

    .action-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 16px;
    }

    .action-btn {
      background: linear-gradient(135deg, var(--gold), var(--gold-bright));
      color: var(--deep-navy);
      border: none;
      border-radius: var(--radius-small);
      padding: 12px 16px;
      font-family: var(--serif);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: var(--shadow-soft);
    }

    .action-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, var(--gold-bright), var(--gold-shimmer));
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .action-btn:disabled {
      background: var(--glass-1);
      color: var(--text-muted);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .ready-btn {
      width: 100%;
      background: linear-gradient(135deg, var(--success), #27ae60);
      color: white;
      margin-bottom: 16px;
    }

    .ready-btn.ready {
      background: linear-gradient(135deg, var(--warning), #f39c12);
    }

    /* 채팅 패널 */
    .chat-panel {
      background: var(--glass-2);
      backdrop-filter: var(--blur-light);
      border: 1px solid var(--border-light);
      border-radius: var(--radius);
      padding: 16px;
      height: 300px;
      display: flex;
      flex-direction: column;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 12px;
      font-size: 13px;
      line-height: 1.6;
    }

    .chat-message {
      margin-bottom: 8px;
      padding: 8px 12px;
      border-radius: var(--radius-small);
      background: var(--glass-1);
    }

    .chat-input-container {
      display: flex;
      gap: 8px;
    }

    .chat-input {
      flex: 1;
      background: var(--glass-1);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-small);
      padding: 8px 12px;
      color: var(--text);
      font-size: 14px;
    }

    .chat-input:focus {
      outline: none;
      border-color: var(--gold);
      box-shadow: 0 0 0 2px rgba(212, 183, 126, 0.2);
    }

    .chat-send-btn {
      background: linear-gradient(135deg, var(--gold), var(--gold-bright));
      color: var(--deep-navy);
      border: none;
      border-radius: var(--radius-small);
      padding: 8px 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .chat-send-btn:hover {
      background: linear-gradient(135deg, var(--gold-bright), var(--gold-shimmer));
    }

    /* 팀원 정보 */
    .team-info {
      background: var(--glass-2);
      backdrop-filter: var(--blur-light);
      border: 1px solid var(--border-light);
      border-radius: var(--radius);
      padding: 16px;
      margin-top: 16px;
    }

    .teammate-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 12px;
    }

    .teammate-item {
      background: var(--glass-1);
      border-radius: var(--radius-small);
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .teammate-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--gold);
    }

    .teammate-info {
      flex: 1;
    }

    .teammate-name {
      font-weight: 600;
      color: var(--gold-bright);
      margin-bottom: 4px;
    }

    .teammate-hp {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* 로딩 및 상태 */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(10, 15, 26, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .loading-content {
      text-align: center;
      color: var(--text);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--glass-2);
      border-top: 3px solid var(--gold);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- 헤더 -->
  <header class="header">
    <div class="container">
      <h1 class="title">
        <span class="title-main">PYXIS</span>
        <span class="title-sub">전투 시스템</span>
      </h1>
    </div>
  </header>

  <!-- 인증 뷰 -->
  <section id="authView" class="container">
    <div class="auth-card">
      <h2 class="section-title">전투 참가자 인증</h2>
      <div class="form-group">
        <label>
          <span class="label">전투 ID</span>
          <input id="battleId" type="text" placeholder="전투 ID" />
        </label>
      </div>
      <div class="form-group">
        <label>
          <span class="label">참가자 이름</span>
          <input id="playerName" type="text" placeholder="참가자 이름" />
        </label>
      </div>
      <div class="form-group">
        <label>
          <span class="label">비밀번호</span>
          <input id="authToken" type="password" placeholder="참가자 비밀번호" />
        </label>
      </div>
      <div class="actions">
        <button id="btnAuth" class="btn">접속</button>
      </div>
      <p class="hint">URL의 파라미터를 인식하여 자동 접속합니다.</p>
    </div>
  </section>

  <!-- 메인 뷰 -->
  <main id="mainView" class="container hidden">
    <div class="player-main-grid">
      <!-- 왼쪽: 내 정보 -->
      <section class="my-info-section">
        <div class="my-panel">
          <div class="avatar-container">
            <img id="myAvatar" class="avatar-img" src="/assets/images/default-avatar.png" alt="내 아바타" />
            <div id="myName" class="player-name">플레이어</div>
            <div id="myTeam" class="team-badge team-phoenix">불사조 기사단</div>
          </div>
          
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-label">공격</div>
              <div class="stat-value" id="statATK">3</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">방어</div>
              <div class="stat-value" id="statDEF">3</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">민첩</div>
              <div class="stat-value" id="statAGI">3</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">행운</div>
              <div class="stat-value" id="statLUK">3</div>
            </div>
          </div>

          <div class="hp-container">
            <div class="hp-label">체력</div>
            <div class="hp-bar-bg">
              <div id="myHpBar" class="hp-bar" style="width: 100%"></div>
              <div id="myHpText" class="hp-text">100 / 100</div>
            </div>
          </div>

          <div class="items-container">
            <div class="stat-label">보유 아이템</div>
            <div class="items-grid">
              <div class="item-slot">
                <div class="item-name">디터니</div>
                <div class="item-count" id="itemDittany">1</div>
              </div>
              <div class="item-slot">
                <div class="item-name">공격 보정기</div>
                <div class="item-count" id="itemAttack">1</div>
              </div>
              <div class="item-slot">
                <div class="item-name">방어 보정기</div>
                <div class="item-count" id="itemDefense">1</div>
              </div>
            </div>
          </div>
        </div>

        <!-- 팀원 정보 -->
        <div class="team-info">
          <h3 class="title">팀원 정보</h3>
          <div id="teammateList" class="teammate-list">
            <!-- 팀원들이 동적으로 추가됨 -->
          </div>
        </div>
      </section>

      <!-- 중앙: 전투 현황 -->
      <section class="battle-status-section">
        <div class="turn-indicator">
          <div class="current-turn-avatar">
            <img id="turnAvatar" class="current-turn-img" src="/assets/images/default-avatar.png" alt="현재 턴" />
            <div id="turnName" class="current-turn-name">대기 중</div>
            <div id="turnTimer" class="turn-timer">턴 시간: --</div>
          </div>
        </div>

        <div class="battle-log-container">
          <h3 class="title">전투 로그</h3>
          <div id="battleLog" class="battle-log">
            <div class="log-entry system">전투 시작을 기다리는 중...</div>
          </div>
        </div>
      </section>

      <!-- 오른쪽: 액션 및 채팅 -->
      <section class="action-section">
        <div class="action-panel">
          <h3 class="title">액션</h3>
          <button id="btnReady" class="action-btn ready-btn">준비완료</button>
          
          <div class="action-grid">
            <button id="btnAttack" class="action-btn" disabled>공격</button>
            <button id="btnDefend" class="action-btn" disabled>방어</button>
            <button id="btnDodge" class="action-btn" disabled>회피</button>
            <button id="btnPass" class="action-btn" disabled>패스</button>
            <button id="btnItemDittany" class="action-btn" disabled>디터니</button>
            <button id="btnItemAttack" class="action-btn" disabled>공격 보정기</button>
            <button id="btnItemDefense" class="action-btn" disabled>방어 보정기</button>
          </div>
        </div>

        <div class="chat-panel">
          <h3 class="title">채팅</h3>
          <div id="chatMessages" class="chat-messages">
            <div class="chat-message">
              <strong>시스템:</strong> 채팅을 시작하세요!
            </div>
          </div>
          <div class="chat-input-container">
            <input id="chatInput" class="chat-input" type="text" placeholder="메시지 입력..." maxlength="200">
            <button id="btnChat" class="chat-send-btn">전송</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- 로딩 오버레이 -->
  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-content">
      <div class="spinner"></div>
      <p>접속 중...</p>
    </div>
  </div>

  <!-- 스크립트 -->
  <script src="https://pyxisbattlesystem.monster/socket.io/socket.io.js"></script>
  <script>
    // 전역 설정
    window.PYXIS_SERVER_URL = "https://pyxisbattlesystem.monster";
    
    // 플레이어 관리 클래스
    class PyxisPlayer {
      constructor() {
        this.socket = null;
        this.playerData = null;
        this.battleData = null;
        this.isConnected = false;
        this.isReady = false;
        this.myTurn = false;
        
        this.initElements();
        this.initEventListeners();
        this.checkAutoAuth();
      }

      initElements() {
        // 뷰 요소들
        this.authView = document.getElementById('authView');
        this.mainView = document.getElementById('mainView');
        this.loadingOverlay = document.getElementById('loadingOverlay');

        // 인증 입력
        this.battleIdInput = document.getElementById('battleId');
        this.playerNameInput = document.getElementById('playerName');
        this.authTokenInput = document.getElementById('authToken');
        this.btnAuth = document.getElementById('btnAuth');

        // 플레이어 정보
        this.myAvatar = document.getElementById('myAvatar');
        this.myName = document.getElementById('myName');
        this.myTeam = document.getElementById('myTeam');
        this.statATK = document.getElementById('statATK');
        this.statDEF = document.getElementById('statDEF');
        this.statAGI = document.getElementById('statAGI');
        this.statLUK = document.getElementById('statLUK');
        this.myHpBar = document.getElementById('myHpBar');
        this.myHpText = document.getElementById('myHpText');
        this.itemDittany = document.getElementById('itemDittany');
        this.itemAttack = document.getElementById('itemAttack');
        this.itemDefense = document.getElementById('itemDefense');

        // 턴 정보
        this.turnAvatar = document.getElementById('turnAvatar');
        this.turnName = document.getElementById('turnName');
        this.turnTimer = document.getElementById('turnTimer');

        // 로그와 채팅
        this.battleLog = document.getElementById('battleLog');
        this.chatMessages = document.getElementById('chatMessages');
        this.chatInput = document.getElementById('chatInput');
        this.btnChat = document.getElementById('btnChat');

        // 액션 버튼들
        this.btnReady = document.getElementById('btnReady');
        this.btnAttack = document.getElementById('btnAttack');
        this.btnDefend = document.getElementById('btnDefend');
        this.btnDodge = document.getElementById('btnDodge');
        this.btnPass = document.getElementById('btnPass');
        this.btnItemDittany = document.getElementById('btnItemDittany');
        this.btnItemAttack = document.getElementById('btnItemAttack');
        this.btnItemDefense = document.getElementById('btnItemDefense');

        // 팀원 목록
        this.teammateList = document.getElementById('teammateList');
      }

      initEventListeners() {
        // 인증 버튼
        this.btnAuth?.addEventListener('click', () => this.authenticate());
        this.authTokenInput?.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') this.authenticate();
        });

        // 채팅
        this.btnChat?.addEventListener('click', () => this.sendChat());
        this.chatInput?.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') this.sendChat();
        });

        // 액션 버튼들
        this.btnReady?.addEventListener('click', () => this.toggleReady());
        this.btnAttack?.addEventListener('click', () => this.performAction('attack'));
        this.btnDefend?.addEventListener('click', () => this.performAction('defend'));
        this.btnDodge?.addEventListener('click', () => this.performAction('dodge'));
        this.btnPass?.addEventListener('click', () => this.performAction('pass'));
        this.btnItemDittany?.addEventListener('click', () => this.performAction('item', 'dittany'));
        this.btnItemAttack?.addEventListener('click', () => this.performAction('item', 'attack_booster'));
        this.btnItemDefense?.addEventListener('click', () => this.performAction('item', 'defense_booster'));
      }

      checkAutoAuth() {
        const params = new URLSearchParams(window.location.search);
        const battleId = params.get('battle');
        const playerName = params.get('name');
        const token = params.get('token');

        if (battleId && playerName && token) {
          this.battleIdInput.value = battleId;
          this.playerNameInput.value = playerName;
          this.authTokenInput.value = token;
          setTimeout(() => this.authenticate(), 500);
        }
      }

      showLoading(show = true) {
        if (show) {
          this.loadingOverlay.classList.remove('hidden');
        } else {
          this.loadingOverlay.classList.add('hidden');
        }
      }

      showMain() {
        this.authView.classList.add('hidden');
        this.mainView.classList.remove('hidden');
      }

      authenticate() {
        const battleId = this.battleIdInput.value.trim();
        const playerName = this.playerNameInput.value.trim();
        const token = this.authTokenInput.value.trim();

        if (!battleId || !playerName || !token) {
          alert('모든 필드를 입력해주세요.');
          return;
        }

        this.showLoading(true);
        this.connectSocket(battleId, playerName, token);
      }

      connectSocket(battleId, playerName, token) {
        if (this.socket) {
          this.socket.disconnect();
        }

        this.socket = io(window.PYXIS_SERVER_URL);

        this.socket.on('connect', () => {
          console.log('소켓 연결됨');
          this.socket.emit('player:auth', { battleId, playerName, token });
        });

        this.socket.on('auth:success', (data) => {
          console.log('인증 성공:', data);
          this.playerData = data.player;
          this.battleData = data.battle;
          this.isConnected = true;
          this.showLoading(false);
          this.showMain();
          this.updatePlayerInfo();
          this.updateBattleStatus();
        });

        this.socket.on('auth:error', (error) => {
          console.error('인증 실패:', error);
          this.showLoading(false);
          alert(`인증 실패: ${error.message}`);
        });

        this.socket.on('battle:update', (data) => {
          console.log('전투 업데이트:', data);
          this.battleData = data;
          this.updateBattleStatus();
        });

        this.socket.on('player:update', (data) => {
          console.log('플레이어 업데이트:', data);
          if (data.playerId === this.playerData?.id) {
            this.playerData = { ...this.playerData, ...data.updates };
            this.updatePlayerInfo();
          }
          this.updateTeammates();
        });

        this.socket.on('battle:log', (entry) => {
          this.addLogEntry(entry);
        });

        this.socket.on('chat:message', (data) => {
          this.addChatMessage(data);
        });

        this.socket.on('turn:start', (data) => {
          console.log('턴 시작:', data);
          this.myTurn = data.playerId === this.playerData?.id;
          this.updateActionButtons();
          this.updateTurnDisplay(data);
        });

        this.socket.on('turn:end', () => {
          this.myTurn = false;
          this.updateActionButtons();
        });

        this.socket.on('disconnect', () => {
          console.log('소켓 연결 끊어짐');
          this.isConnected = false;
          this.addLogEntry({ type: 'system', message: '연결이 끊어졌습니다. 재연결 중...' });
        });

        this.socket.on('connect_error', (error) => {
          console.error('연결 오류:', error);
          this.showLoading(false);
          alert('서버 연결에 실패했습니다.');
        });
      }

      updatePlayerInfo() {
        if (!this.playerData) return;

        // 기본 정보
        this.myName.textContent = this.playerData.name || '플레이어';
        
        // 팀 배지
        this.myTeam.textContent = this.playerData.team === 'phoenix' ? '불사조 기사단' : '죽음을 먹는 자들';
        this.myTeam.className = `team-badge team-${this.playerData.team}`;

        // 아바타
        if (this.playerData.avatar) {
          this.myAvatar.src = this.playerData.avatar;
        }

        // 스탯
        if (this.playerData.stats) {
          this.statATK.textContent = this.playerData.stats.attack || 3;
          this.statDEF.textContent = this.playerData.stats.defense || 3;
          this.statAGI.textContent = this.playerData.stats.agility || 3;
          this.statLUK.textContent = this.playerData.stats.luck || 3;
        }

        // HP
        const currentHp = this.playerData.hp || 100;
        const maxHp = this.playerData.maxHp || 100;
        const hpPercent = (currentHp / maxHp) * 100;
        
        this.myHpBar.style.width = `${hpPercent}%`;
        this.myHpText.textContent = `${currentHp} / ${maxHp}`;

        // 아이템
        if (this.playerData.items) {
          this.itemDittany.textContent = this.playerData.items.dittany || 0;
          this.itemAttack.textContent = this.playerData.items.attack_booster || 0;
          this.itemDefense.textContent = this.playerData.items.defense_booster || 0;
        }

        // 준비 상태
        if (this.playerData.isReady) {
          this.btnReady.textContent = '준비완료';
          this.btnReady.classList.add('ready');
        } else {
          this.btnReady.textContent = '준비하기';
          this.btnReady.classList.remove('ready');
        }
      }

      updateBattleStatus() {
        if (!this.battleData) return;

        // 턴 정보 업데이트는 turn:start 이벤트에서 처리
        this.updateTeammates();
        this.updateActionButtons();
      }

      updateTeammates() {
        if (!this.battleData || !this.playerData) return;

        const teammates = this.battleData.players?.filter(p => 
          p.team === this.playerData.team && p.id !== this.playerData.id
        ) || [];

        this.teammateList.innerHTML = '';

        teammates.forEach(teammate => {
          const div = document.createElement('div');
          div.className = 'teammate-item';
          
          const currentHp = teammate.hp || 0;
          const maxHp = teammate.maxHp || 100;
          const hpPercent = Math.max(0, (currentHp / maxHp) * 100);

          div.innerHTML = `
            <img class="teammate-avatar" src="${teammate.avatar || '/assets/images/default-avatar.png'}" alt="${teammate.name}" />
            <div class="teammate-info">
              <div class="teammate-name">${teammate.name}</div>
              <div class="teammate-hp">HP: ${currentHp}/${maxHp} (${hpPercent.toFixed(0)}%)</div>
            </div>
          `;

          this.teammateList.appendChild(div);
        });

        if (teammates.length === 0) {
          this.teammateList.innerHTML = '<div class="teammate-item">팀원이 없습니다</div>';
        }
      }

      updateTurnDisplay(turnData) {
        if (!turnData) return;

        const currentPlayer = this.battleData?.players?.find(p => p.id === turnData.playerId);
        
        if (currentPlayer) {
          this.turnName.textContent = currentPlayer.name;
          this.turnAvatar.src = currentPlayer.avatar || '/assets/images/default-avatar.png';
        } else {
          this.turnName.textContent = '대기 중';
          this.turnAvatar.src = '/assets/images/default-avatar.png';
        }

        // 턴 타이머 (간단한 예시)
        if (turnData.timeLeft) {
          this.turnTimer.textContent = `남은 시간: ${Math.ceil(turnData.timeLeft / 1000)}초`;
        } else {
          this.turnTimer.textContent = '턴 시간: --';
        }
      }

      updateActionButtons() {
        const canAct = this.myTurn && this.battleData?.status === 'active' && this.playerData?.isAlive;
        
        // 기본 액션들
        this.btnAttack.disabled = !canAct;
        this.btnDefend.disabled = !canAct;
        this.btnDodge.disabled = !canAct;
        this.btnPass.disabled = !canAct;

        // 아이템들 (보유 수량도 확인)
        this.btnItemDittany.disabled = !canAct || (this.playerData?.items?.dittany || 0) <= 0;
        this.btnItemAttack.disabled = !canAct || (this.playerData?.items?.attack_booster || 0) <= 0;
        this.btnItemDefense.disabled = !canAct || (this.playerData?.items?.defense_booster || 0) <= 0;

        // 준비 버튼은 전투 시작 전에만 활성화
        this.btnReady.disabled = this.battleData?.status === 'active';
      }

      toggleReady() {
        if (!this.socket || !this.isConnected) return;

        this.socket.emit('player:ready', { ready: !this.isReady });
        this.isReady = !this.isReady;
        
        if (this.isReady) {
          this.btnReady.textContent = '준비완료';
          this.btnReady.classList.add('ready');
        } else {
          this.btnReady.textContent = '준비하기';
          this.btnReady.classList.remove('ready');
        }
      }

      performAction(type, itemType = null) {
        if (!this.socket || !this.isConnected || !this.myTurn) return;

        const action = { type };
        if (itemType) {
          action.itemType = itemType;
        }

        // 타겟이 필요한 액션들 (공격, 회복 아이템)
        if (type === 'attack' || (type === 'item' && itemType === 'dittany')) {
          this.selectTarget(action);
        } else {
          this.socket.emit('player:action', action);
        }
      }

      selectTarget(action) {
        // 간단한 타겟 선택 (실제로는 UI로 선택)
        const targets = this.battleData?.players?.filter(p => {
          if (action.type === 'attack') {
            return p.team !== this.playerData.team && p.isAlive;
          } else if (action.type === 'item') {
            return p.team === this.playerData.team && p.isAlive;
          }
          return false;
        }) || [];

        if (targets.length === 0) {
          alert('유효한 대상이 없습니다.');
          return;
        }

        // 첫 번째 대상을 자동 선택 (실제로는 사용자가 선택)
        action.targetId = targets[0].id;
        this.socket.emit('player:action', action);
      }

      sendChat() {
        const message = this.chatInput.value.trim();
        if (!message || !this.socket || !this.isConnected) return;

        this.socket.emit('player:chat', { message });
        this.chatInput.value = '';
      }

      addLogEntry(entry) {
        const div = document.createElement('div');
        div.className = `log-entry ${entry.type || 'system'}`;
        div.textContent = entry.message || '';
        
        this.battleLog.appendChild(div);
        this.battleLog.scrollTop = this.battleLog.scrollHeight;

        // 로그가 너무 많으면 오래된 것 제거
        if (this.battleLog.children.length > 100) {
          this.battleLog.removeChild(this.battleLog.firstChild);
        }
      }

      addChatMessage(data) {
        const div = document.createElement('div');
        div.className = 'chat-message';
        
        const sender = data.senderName || '익명';
        const message = data.message || '';
        const timestamp = new Date().toLocaleTimeString();
        
        div.innerHTML = `<strong>${sender}</strong> [${timestamp}]: ${message}`;
        
        this.chatMessages.appendChild(div);
        this.chatMessages.scrollTop = this.chatMessages.scrollHeight;

        // 채팅이 너무 많으면 오래된 것 제거
        if (this.chatMessages.children.length > 50) {
          this.chatMessages.removeChild(this.chatMessages.firstChild);
        }
      }
    }

    // 페이지 로드 시 플레이어 인스턴스 생성
    document.addEventListener('DOMContentLoaded', () => {
      window.pyxisPlayer = new PyxisPlayer();
    });
  </script>
</body>
</html>
