<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>PYXIS 플레이어</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=Cinzel:wght@700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0f1a; --surface:#121820; --fg:#e9e4d7; --muted:#cdbfa5;
  --gold:#d4ba8d; --gold2:#c9a97a; --line:rgba(220,199,162,.22);
  --radius:12px; --shadow:0 8px 20px rgba(0,0,0,.35);
}
html,body{margin:0;height:100%;background:var(--bg);color:var(--fg)}
body{font-family:Inter,ui-sans-serif,system-ui}
.wrap{max-width:1200px;margin:0 auto;padding:16px;display:flex;flex-direction:column;gap:12px}
.top{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--line);border-radius:var(--radius);padding:10px 12px;background:linear-gradient(180deg,rgba(212,186,141,.12),transparent)}
h1{font-family:'Playfair Display',serif;font-size:18px;margin:0}
.meta{font-size:12px;color:var(--muted)}

.grid{display:grid;grid-template-columns:1.2fr 1fr;gap:12px;min-height:70vh}
.col{background:var(--surface);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);display:flex;flex-direction:column;min-height:0}

.col-header{padding:10px 12px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;background:linear-gradient(180deg,rgba(212,186,141,.08),transparent)}
.col-header h2{font-size:14px;margin:0}

.section{padding:10px;display:flex;flex-direction:column;gap:10px}

.roster{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.card{background:#0f1620;border:1px solid var(--line);border-radius:10px;padding:8px}
.card h3{margin:0 0 4px 0;font-size:13px}
.stat{font-size:12px;color:var(--muted)}
.hp{height:6px;border-radius:999px;background:#2a3340;overflow:hidden;border:1px solid rgba(255,255,255,.06)}
.hp>i{display:block;height:100%;background:linear-gradient(90deg,#2d5a27,#3e7a39);width:100%}

.actions{display:grid;grid-template-columns:repeat(5,1fr);gap:6px}
.btn{border:1px solid var(--line);background:#131b25;color:var(--fg);padding:8px 10px;border-radius:10px;cursor:pointer;font-size:13px}
.btn:hover{border-color:var(--gold)}
.btn-wide{grid-column:span 2}

.log{flex:1;overflow:auto;padding:10px;display:flex;flex-direction:column;gap:6px}
.log .row{font-family:ui-monospace,monospace;font-size:12px;background:#0e1520;border:1px solid var(--line);border-radius:8px;padding:6px 8px}

.footer{display:flex;gap:8px;padding:8px;border-top:1px dashed var(--line);align-items:center;justify-content:flex-end}
.toggle{display:flex;gap:6px;align-items:center}

.modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(4px)}
.card-lg{width:min(520px,92vw);background:var(--surface);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow)}
.card-head{padding:12px 14px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,rgba(212,186,141,.1),transparent)}
.card-body{padding:14px;display:flex;flex-direction:column;gap:10px}
.row{display:grid;grid-template-columns:100px 1fr;gap:8px;align-items:center}
.inp{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#0f1620;color:var(--fg);font-size:13px}
.hidden{display:none}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h1>PYXIS 플레이어</h1>
    <div class="meta">라운드 <b id="round">1</b> · 현재 페이즈 팀 <b id="phaseTeam">A</b></div>
  </div>

  <div class="grid">
    <div class="col">
      <div class="col-header"><h2>행동</h2></div>
      <div class="section">
        <div class="actions">
          <button class="btn" data-act="attack">공격</button>
          <button class="btn" data-act="defend">방어</button>
          <button class="btn" data-act="dodge">회피</button>
          <button class="btn" data-act="item" data-item="attack_boost">공격 보정기</button>
          <button class="btn" data-act="item" data-item="defense_boost">방어 보정기</button>
          <button class="btn btn-wide" data-act="item" data-item="dittany">디터니(HP+10)</button>
          <button class="btn" data-act="pass">패스</button>
        </div>
        <div class="footer">
          <label class="toggle"><input type="checkbox" id="readyChk"> 준비 완료</label>
          <button class="btn" id="sendReady">상태 전송</button>
        </div>
      </div>
      <div class="col-header"><h2>전투 로그</h2></div>
      <div class="log" id="log"></div>
    </div>

    <div class="col">
      <div class="col-header"><h2>팀 상태</h2></div>
      <div class="section">
        <div class="roster" id="roster"></div>
      </div>
    </div>
  </div>
</div>

<!-- 로그인 -->
<div class="modal" id="login">
  <div class="card-lg">
    <div class="card-head"><h2>입장</h2></div>
    <div class="card-body">
      <div class="row"><label>이름</label><input id="name" class="inp" placeholder="플레이어 이름"></div>
      <div class="row"><label>팀</label>
        <select id="team" class="inp"><option value="A">A팀</option><option value="B">B팀</option></select>
      </div>
      <div class="row"><label>OTP</label><input id="otp" class="inp" placeholder="플레이어 OTP"></div>
      <div class="row"><label>전투 ID</label><input id="battle" class="inp" placeholder="관리자 화면 전투 ID"></div>
      <div style="display:flex;justify-content:flex-end"><button class="btn" id="enter">입장</button></div>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
let ioSock=null, battleId='', playerId='', myTeam='A', myName='';
const $=s=>document.querySelector(s), el=(t,c)=>{const n=document.createElement(t); if(c) n.className=c; return n;}

function render(state){
  if(!state) return;
  $('#round').textContent = state.round || 1;
  $('#phaseTeam').textContent = state.phaseTeam || 'A';

  const roster = $('#roster'); roster.innerHTML='';
  const makeCard = (p)=> {
    const c = el('div','card');
    c.innerHTML = `
      <h3>${p.name}</h3>
      <div class="stat">HP ${p.hp}/100</div>
      <div class="hp"><i style="width:${(p.hp/100)*100}%"></i></div>
    `;
    return c;
  };
  // 내 팀과 상대 팀 모두 보이도록
  const A = (state.teams?.A?.players)||[];
  const B = (state.teams?.B?.players)||[];
  [...A, ...B].forEach(p => roster.append(makeCard(p)));

  // 로그
  const log = $('#log');
  if (state.lastEvent) {
    const row = el('div','row'); row.textContent = state.lastEvent; log.append(row);
    log.scrollTop = log.scrollHeight;
  }
}

function connect(){
  ioSock = io({ transports:['websocket'] });

  ioSock.on('connect', ()=>{
    ioSock.emit('playerAuth', { battleId, token: $('#otp').value.trim(), name: myName, team: myTeam });
  });

  ioSock.on('authSuccess', (p)=>{
    $('#login').classList.add('hidden');
  });
  ioSock.on('authError', (e)=> alert(e?.message||'인증 실패'));

  ioSock.on('battleUpdate', render);

  ioSock.on('actionSuccess', ()=>{} );
  ioSock.on('actionError', (e)=> alert(e?.message||'실패') );
}

$('#enter').addEventListener('click', ()=>{
  myName = $('#name').value.trim();
  myTeam = $('#team').value;
  battleId = $('#battle').value.trim();
  if(!myName || !$('#otp').value.trim() || !battleId){ alert('모두 입력하세요'); return; }
  connect();
});

/* 준비 전송 */
$('#sendReady').addEventListener('click', ()=>{
  const ready = $('#readyChk').checked;
  ioSock?.emit('playerReady', { battleId, playerId, ready });
});

/* 액션 버튼 */
document.querySelectorAll('.actions .btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const act = btn.getAttribute('data-act');
    const item = btn.getAttribute('data-item');
    const payload = { battleId, actorId: playerId, type: act };
    if (act === 'item') payload.itemType = item;
    ioSock?.emit('playerAction', payload);
  });
});

/* 서버에서 authSuccess 이후 내 playerId를 알려주는 경우에 대비(옵션) */
ioSock?.on?.('authSuccess', (p)=>{ if(p?.playerId) playerId = p.playerId; });
</script>
</body>
</html>
