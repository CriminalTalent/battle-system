<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PYXIS 전투 참가자</title>
  <style>
    :root{
      /* 네이비-골드 고정 테마 */
      --gold-1:#DCC7A2; --gold-2:#D4BA8D;
      --bg-0:#0f1216; --bg-1:#141922; --bg-2:#1b2230;
      --text:#e5e7eb; --muted:#9aa4b2; --border:#262b36;
      --btn-bg:#0b0d10; --btn-border:#D4BA8D; --btn-text:#DCC7A2;
    }
    body{margin:0; background:var(--bg-0); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Arial, Apple SD Gothic Neo, "맑은 고딕", sans-serif;}
    .wrap{max-width:1200px; margin:20px auto; padding:0 12px;}
    .cols{display:grid; grid-template-columns: 300px 1fr 340px; gap:14px;}
    @media (max-width: 1080px){ .cols{grid-template-columns: 1fr;} }

    .card{
      background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));
      border:1px solid var(--border); border-radius:14px; padding:14px;
      box-shadow:0 8px 20px rgba(0,0,0,.2); backdrop-filter: blur(6px);
    }
    .label{font-size:12px; color:var(--muted); margin-bottom:6px;}
    .row{display:flex; gap:8px; flex-wrap:wrap;}
    .grid{display:grid; gap:8px;}
    .g-2{grid-template-columns: repeat(2, 1fr);}

    .hpbar{height:12px; border-radius:6px; background:#3b2f1a; overflow:hidden; border:1px solid #6b5a3a}
    .hpbar > i{display:block; height:100%; width:0%;
      background: linear-gradient(90deg, #8c6b2e, #DCC7A2);}

    .btn{
      display:inline-flex; align-items:center; justify-content:center; height:36px; padding:0 10px;
      border-radius:10px; border:1px solid var(--btn-border); background:var(--btn-bg); color:var(--btn-text);
      font-weight:600; cursor:pointer; transition:transform .12s ease, box-shadow .12s ease;
      user-select:none; font-size:14px;
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 6px 16px rgba(220,199,162,.12);}
    .btn:disabled{opacity:.5; cursor:not-allowed;}

    .turnbox{display:flex; flex-direction:column; align-items:center; gap:10px;}

    .avatar{width:100%; aspect-ratio:4/3; background:#0c0f14; border:1px solid var(--border); border-radius:16px;
      display:flex; align-items:center; justify-content:center; overflow:hidden; margin-bottom:10px;}
    .avatar img{width:100%; height:100%; object-fit:contain;}

    .queue-title{
      text-align:center; font-weight:700;
      background:linear-gradient(90deg,#DCC7A2,#f5e6c9,#DCC7A2);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      background-size:200% 100%; animation: shimmer 3s linear infinite;
      margin-bottom:4px;
    }
    @keyframes shimmer { 0%{background-position:0% 0} 100%{background-position:200% 0} }
    .queue{display:flex; gap:10px; overflow:auto; padding:4px 2px; width:100%; justify-content:center; flex-wrap:wrap;}
    .qitem{width:54px; height:40px; border:1px solid var(--border); border-radius:8px; background:#0c0f14;
      display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative;}
    .qitem img{width:100%; height:100%; object-fit:contain;}
    .qitem .name{position:absolute; inset:auto 2px 2px 2px; font-size:10px; color:#c9ced7; text-align:center; background:rgba(0,0,0,.35); border-radius:4px;}
    .qitem.active{border-color:#D4BA8D; box-shadow:0 0 0 2px rgba(212,186,141,.25) inset;}

    .imgbox{width:100%; max-width:620px; aspect-ratio:4/3; background:#0c0f14; border:1px solid var(--border); border-radius:16px;
      display:flex; align-items:center; justify-content:center; overflow:hidden;}
    .imgbox img{width:100%; height:100%; object-fit:contain;}

    .log{height:170px; overflow:auto; background:var(--bg-1); border:1px solid var(--border); border-radius:10px; padding:8px; font-size:14px;}
    .chat{height:220px; overflow:auto; background:var(--bg-1); border:1px solid var(--border); border-radius:10px; padding:8px; font-size:14px;}
    .chatbox{display:flex; gap:6px; margin-top:6px;}
    .chatbox input{flex:1; height:36px; border-radius:10px; border:1px solid var(--border); background:var(--bg-2); color:var(--text); padding:0 10px; font-size:14px;}

    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center; z-index:50;}
    .sheet{background:var(--bg-1); border:1px solid var(--border); border-radius:12px; padding:16px; width:min(92vw, 560px);}
    .list{display:grid; gap:8px; margin-top:8px;}
    .target{display:flex; justify-content:space-between; align-items:center; border:1px solid var(--border); border-radius:10px; padding:8px;}
    .hidden{display:none !important;}

    .toast{position:fixed; top:16px; right:16px; background:rgba(255,255,255,.06); border:1px solid var(--border); border-radius:10px; padding:10px 12px; color:var(--text); box-shadow:0 10px 24px rgba(0,0,0,.22); z-index:1000; transform:translateX(320px); transition:transform .22s; font-size:12px}
    .toast.show{transform:translateX(0)}
  </style>
</head>
<body>
  <!-- 결과 배너(옵션) -->
  <div id="pyxis-result-banner" style="display:none"></div>

  <!-- 로그인(자동/수동 겸용) -->
  <div id="authOverlay" class="overlay">
    <div class="sheet">
      <div style="font-weight:700; margin-bottom:6px">플레이어 접속</div>
      <div id="authForm">
        <div class="grid g-2">
          <div>
            <div class="label">전투 ID</div>
            <input id="authBattle" placeholder="b_xxxxxxxx"/>
          </div>
          <div>
            <div class="label">팀</div>
            <select id="authTeam" style="width:100%; height:36px; border-radius:10px; border:1px solid var(--border); background:var(--bg-2); color:var(--text); padding:0 10px">
              <option value="A">A팀</option>
              <option value="B">B팀</option>
            </select>
          </div>
        </div>
        <div class="grid g-2" style="margin-top:8px">
          <div>
            <div class="label">이름</div>
            <input id="authName" placeholder="플레이어 이름"/>
          </div>
          <div>
            <div class="label">플레이어 OTP</div>
            <input id="authToken" placeholder="플레이어 OTP"/>
          </div>
        </div>
        <div class="row" style="justify-content:flex-end; margin-top:10px">
          <button id="btnAuth" class="btn">접속</button>
        </div>
        <div class="label" style="margin-top:8px">URL의 <code>?battle=...&name=...&team=A&token=...</code> 파라미터가 있으면 자동 접속합니다.</div>
      </div>
      <div id="authPending" class="hidden">
        <div>자동 로그인 준비 중</div>
        <div style="color:#9aa4b2; font-size:12px; margin-top:6px">연결 완료 후 본 화면으로 전환됩니다.</div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="cols">
      <!-- 좌: 내 카드 + 아군/상대 목록 + 준비 버튼 -->
      <div class="card">
        <div class="avatar"><img id="meAvatar" alt=""></div>

        <div class="label">내 정보</div>
        <div id="meName" style="font-weight:700; margin-bottom:6px;">-</div>
        <div class="grid g-2">
          <div><div class="label">팀</div><div id="meTeam">-</div></div>
          <div><div class="label">HP</div><div id="meHp">-</div></div>
        </div>
        <div class="hpbar" style="margin-top:6px"><i id="meHpBar"></i></div>
        <div class="grid g-2" style="margin-top:10px">
          <div><div class="label">공격</div><div id="sAtk">-</div></div>
          <div><div class="label">방어</div><div id="sDef">-</div></div>
          <div><div class="label">행운</div><div id="sLuk">-</div></div>
          <div><div class="label">민첩</div><div id="sAgi">-</div></div>
        </div>

        <div class="label" style="margin-top:12px">아군</div>
        <div id="allyList" class="list"></div>

        <div class="label" style="margin-top:12px">상대</div>
        <div id="enemyList" class="list"></div>

        <div class="row" style="margin-top:12px; justify-content:flex-end">
          <button id="btnReady" class="btn">준비 완료</button>
        </div>
      </div>

      <!-- 중앙: 턴 정보/순서 큐/이미지/액션 -->
      <div class="card">
        <div class="turnbox" style="width:100%">
          <div id="turnTeam" style="font-weight:700;">-</div>

          <div class="queue-title">순서</div>
          <div id="queue" class="queue"></div>

          <div class="imgbox"><img id="turnImg" alt=""></div>

          <div id="turnTimer" class="label">-</div>

          <div class="row">
            <button id="btnAttack" class="btn" disabled>공격</button>
            <button id="btnDefend" class="btn" disabled>방어</button>
            <button id="btnDodge"  class="btn" disabled>회피</button>
            <button id="btnItem"   class="btn" disabled>아이템</button>
            <button id="btnPass"   class="btn" disabled>패스</button>
          </div>
        </div>
      </div>

      <!-- 우: 채팅/로그 -->
      <div class="card">
        <div class="label">채팅</div>
        <div id="chat" class="chat"></div>
        <div class="chatbox">
          <input id="chatMsg" placeholder="메시지 입력"/>
          <button id="btnSend" class="btn">보내기</button>
        </div>

        <div class="label" style="margin-top:12px">전투 로그</div>
        <div id="log" class="log"></div>
      </div>
    </div>
  </div>

  <!-- 타깃 선택 -->
  <div id="targetOverlay" class="overlay hidden">
    <div class="sheet">
      <div id="targetTitle" style="font-weight:700">대상 선택</div>
      <div id="targetList" class="list"></div>
      <div class="row" style="margin-top:10px; justify-content:flex-end">
        <button id="btnCancelTarget" class="btn">취소</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ===== 상태 =====
    let sock=null, battleId='', playerId='', myTeam='A', myName='', otp='';
    let lastState=null;

    const $=s=>document.querySelector(s);
    const el=(t,c)=>{const n=document.createElement(t); if(c) n.className=c; return n;}
    const toast=(msg)=>{const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000);}

    // ===== 팀키 호환 (phoenix/eaters/A/B) =====
    const toLetter = (team)=> {
      if(!team) return '';
      const s=String(team).toLowerCase();
      if (s==='phoenix' || s==='a') return 'A';
      if (s==='eaters'  || s==='death' || s==='b') return 'B';
      return '';
    };
    const letterToKey = (letter)=> letter==='A' ? 'phoenix' : 'eaters';

    // ===== 렌더링 =====
    function render(state){
      if(!state) return;
      lastState = state;

      // 내 카드
      const me = findMe(state);
      if (me){
        $('#meName').textContent = me.name || '-';
        $('#meTeam').textContent = toLetter(me.team) || '-';
        $('#meHp').textContent   = `${me.hp ?? 0}/${me.maxHp ?? 100}`;
        $('#sAtk').textContent = me.stats?.attack ?? me.stats?.공격 ?? '-';
        $('#sDef').textContent = me.stats?.defense ?? me.stats?.방어 ?? '-';
        $('#sLuk').textContent = me.stats?.luck ?? me.stats?.행운 ?? '-';
        $('#sAgi').textContent = me.stats?.agility ?? me.stats?.민첩 ?? '-';
        const maxHp = (me.maxHp ?? 100); const ratio = Math.max(0, Math.min(100, (me.hp||0)/maxHp*100));
        $('#meHpBar').style.width = ratio + '%';
      }

      // 아군/상대 목록(HP바 + 스탯 모두 노출)
      const allyList  = $('#allyList');  allyList.innerHTML  = '';
      const enemyList = $('#enemyList'); enemyList.innerHTML = '';
      const [A,B] = getTeams(state);
      const myLetter = toLetter(me?.team)||'A';
      const allies  = (myLetter==='A'? A : B);
      const enemies = (myLetter==='A'? B : A);

      const makeRow = (p)=>{
        const atk = p.stats?.attack ?? p.stats?.공격 ?? '-';
        const def = p.stats?.defense ?? p.stats?.방어 ?? '-';
        const agi = p.stats?.agility ?? p.stats?.민첩 ?? '-';
        const luk = p.stats?.luck ?? p.stats?.행운 ?? '-';
        const maxHp = (p.maxHp ?? 100);
        const hpPct = Math.max(0, Math.min(100, (p.hp||0)/maxHp*100));
        const row = el('div','target');
        row.innerHTML = `
          <div style="display:flex; gap:10px; align-items:center">
            <div style="width:28px;height:28px;border:1px solid var(--border);border-radius:6px;background:#0c0f14;overflow:hidden"></div>
            <div>
              <div style="font-weight:700">${escapeHtml(p.name)}</div>
              <div class="label">팀 ${toLetter(p.team)} · HP ${p.hp}/${maxHp}</div>
              <div class="label">공격 ${atk} · 방어 ${def} · 민첩 ${agi} · 행운 ${luk}</div>
            </div>
          </div>
          <div class="hpbar" style="width:140px"><i style="width:${hpPct}%"></i></div>
        `;
        return row;
      };

      allies.forEach(p=> allyList.appendChild(makeRow(p)));
      enemies.forEach(p=> enemyList.appendChild(makeRow(p)));

      // 순서/페이즈 힌트
      const phaseLetter =
        (state.phaseTeam) ? toLetter(state.phaseTeam) :
        (state.turn && state.turn.order ? (state.turn.order[state.turn.phaseIndex||0]||'A') : 'A');
      $('#turnTeam').textContent = `현재 페이즈 팀: ${phaseLetter}`;

      // 액션 버튼 활성화: 내 팀 페이즈+생존+배틀 active
      const active = (state.status==='active');
      const myAlive = me && (me.hp || 0) > 0;
      const myTurn = (phaseLetter === toLetter(me?.team));
      const enable = active && myAlive && myTurn;

      setEnabled('#btnAttack', enable);
      setEnabled('#btnDefend', enable);
      setEnabled('#btnDodge',  enable);
      setEnabled('#btnItem',   enable);
      setEnabled('#btnPass',   enable);

      // 순서 큐(살아있는 현재팀)
      renderQueue(state, phaseLetter);
      // 마지막 단일 이벤트만 제공하는 서버와의 호환
      if (state.lastEvent) appendLog(state.lastEvent);
    }

    function renderQueue(state, phaseLetter){
      const box = $('#queue'); box.innerHTML='';
      const [A,B] = getTeams(state);
      const cur = (phaseLetter==='A') ? A : B;
      const alive = cur.filter(p=>(p.hp||0)>0);
      alive.forEach(p=>{
        const q = el('div','qitem');
        q.innerHTML = `<img src="${p.avatar||''}" alt=""><div class="name">${escapeHtml(p.name)}</div>`;
        box.appendChild(q);
      });
    }

    function setEnabled(sel, on){ const b=$(sel); if(!b) return; b.disabled = !on; }

    function findMe(state){
      const [A,B] = getTeams(state);
      const all = [...A,...B];
      return all.find(p=>p.id===playerId) || all.find(p=>p.name===myName && toLetter(p.team)===myTeam);
    }

    function getTeams(state){
      // payload가 teams.A/B 또는 players[team=phoenix/eaters] 모두 호환
      if (state.teams) {
        return [ (state.teams.A?.players)||[], (state.teams.B?.players)||[] ];
      }
      const arr = state.players || [];
      return [ arr.filter(p=>toLetter(p.team)==='A'), arr.filter(p=>toLetter(p.team)==='B') ];
    }

    function appendLog(msg){
      const L = $('#log');
      const row = el('div');
      row.textContent = String(msg||'');
      L.append(row);
      L.scrollTop = L.scrollHeight;
    }

    function appendChat(sender, text){
      const C = $('#chat');
      const row = el('div');
      row.textContent = `${sender}: ${text}`;
      C.append(row);
      C.scrollTop = C.scrollHeight;
    }

    // ===== 연결/인증 =====
    function connect(){
      if(sock) try{ sock.disconnect(); }catch(_){}
      sock = io({ transports:['websocket'], path:'/socket.io' });

      sock.on('connect', ()=>{
        // 신/구 인증 이벤트 모두 수용
        sock.emit('playerAuth', { battleId, token: otp, name: myName, team: myTeam });
      });

      // 신/구 성공 이벤트 모두 수용
      sock.on('authSuccess', (p)=>{
        playerId = p?.playerId || p?.id || playerId;
        $('#authOverlay').classList.add('hidden');
        toast('접속 완료');
      });
      sock.on('auth:success', (p)=>{
        playerId = p?.player?.id || p?.playerId || playerId;
        $('#authOverlay').classList.add('hidden');
        toast('접속 완료');
      });

      // 상태 갱신(신/구 채널)
      sock.on('battleUpdate', render);
      sock.on('battle:update', render);

      // 액션 응답
      sock.on('actionSuccess', ()=>{});
      sock.on('actionError', (e)=> alert(e?.message||'행동 실패') );

      // 채팅(신/구 채널)
      sock.on('chatMessage', (m)=> appendChat(m?.name || m?.senderName || '익명', m?.message || '') );
      sock.on('battle:chat', ({name:from,message})=> appendChat(from||'익명', message||'') );
      sock.on('cheerMessage', (m)=> appendLog(`[응원] ${m?.name || '관전자'}: ${m?.message || ''}`) );
      sock.on('battle:log', (m)=> appendLog(m?.message||'') );
    }

    // ===== 준비/액션 =====
    $('#btnReady').addEventListener('click', ()=>{
      // 신/구 이벤트 동시 전송
      sock?.emit('playerReady', { battleId, playerId, ready: true });
      sock?.emit('player:ready', { battleId, playerId });
      toast('준비 완료 전송');
    });

    $('#btnAttack').addEventListener('click', ()=>{
      const me = findMe(lastState); if(!me) return;
      const enemyList = getEnemyAlive(me);
      openTarget(enemyList, (targetId)=>{
        // 신/구 이벤트 동시 전송
        sock?.emit('playerAction', { battleId, actorId: playerId, type:'attack', targetId });
        sock?.emit('player:action', { battleId, playerId, action:{ type:'attack', targetId }});
      });
    });
    $('#btnDefend').addEventListener('click', ()=>{
      sock?.emit('playerAction', { battleId, actorId: playerId, type:'defend' });
      sock?.emit('player:action', { battleId, playerId, action:{ type:'defend' }});
    });
    $('#btnDodge').addEventListener('click', ()=>{
      sock?.emit('playerAction', { battleId, actorId: playerId, type:'dodge' });
      sock?.emit('player:action', { battleId, playerId, action:{ type:'dodge' }});
    });
    $('#btnItem').addEventListener('click', ()=> openTargetItem());
    $('#btnPass').addEventListener('click', ()=>{
      sock?.emit('playerAction', { battleId, actorId: playerId, type:'pass' });
      sock?.emit('player:action', { battleId, playerId, action:{ type:'pass' }});
    });

    // ===== 채팅: 버튼 + Enter 전송(신/구 채널 동시) =====
    $('#btnSend').addEventListener('click', sendChat);
    $('#chatMsg').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendChat(); } });
    function sendChat(){
      const text = $('#chatMsg').value.trim();
      if(!text) return;
      sock?.emit('chatMessage', { battleId, message: text });
      sock?.emit('chat:send', { battleId, name: myName || '전투 참가자', message: text, role: 'player' });
      $('#chatMsg').value = '';
    }

    // ===== 타깃 선택 오버레이 =====
    function getEnemyAlive(me){
      const [A,B] = getTeams(lastState||{});
      const mine = toLetter(me.team);
      const enemy = mine==='A' ? B : A;
      return enemy.filter(x=> (x.hp||0) > 0);
    }
    function openTarget(list, onPick){
      const ov = $('#targetOverlay'), root = $('#targetList');
      $('#targetTitle').textContent = '공격 대상 선택';
      root.innerHTML = '';
      if(!list || list.length===0){
        const div = el('div'); div.textContent='대상이 없습니다';
        root.appendChild(div);
      } else {
        list.forEach(p=>{
          const maxHp = (p.maxHp ?? 100);
          const hpPct = Math.max(0,Math.min(100,(p.hp||0)/maxHp*100));
          const row = el('div','target');
          row.innerHTML = `
            <div>
              <div style="font-weight:700">${escapeHtml(p.name)}</div>
              <div class="label">HP ${p.hp}/${maxHp}</div>
            </div>
            <div class="hpbar" style="width:160px"><i style="width:${hpPct}%"></i></div>
          `;
          row.addEventListener('click', ()=>{ closeTarget(); onPick && onPick(p.id); });
          root.appendChild(row);
        });
      }
      ov.classList.remove('hidden');
    }
    function openTargetItem(){
      const ov = $('#targetOverlay'), root = $('#targetList');
      $('#targetTitle').textContent = '아이템 사용';
      root.innerHTML='';
      const mkBtn=(label, handler)=>{
        const row=el('div','target');
        row.innerHTML = `<div>${label}</div><button class="btn">사용</button>`;
        row.querySelector('.btn').addEventListener('click', handler);
        return row;
      };
      // 서버 룰: 공격 보정기 / 방어 보정기 / 디터니
      root.appendChild(mkBtn('공격 보정기', ()=>{ closeTarget();
        sock?.emit('playerAction',{ battleId, actorId:playerId, type:'item', itemType:'attack_booster' });
        sock?.emit('player:action',{ battleId, playerId, action:{ type:'item', itemType:'attack_booster' }});
      }));
      root.appendChild(mkBtn('방어 보정기', ()=>{ closeTarget();
        sock?.emit('playerAction',{ battleId, actorId:playerId, type:'item', itemType:'defense_booster' });
        sock?.emit('player:action',{ battleId, playerId, action:{ type:'item', itemType:'defense_booster' }});
      }));
      root.appendChild(mkBtn('디터니', ()=>{ closeTarget();
        sock?.emit('playerAction',{ battleId, actorId:playerId, type:'item', itemType:'dittany' });
        sock?.emit('player:action',{ battleId, playerId, action:{ type:'item', itemType:'dittany', targetId: playerId }});
      }));
      ov.classList.remove('hidden');
    }
    $('#btnCancelTarget').addEventListener('click', closeTarget);
    function closeTarget(){ $('#targetOverlay').classList.add('hidden'); }

    // ===== 유틸 =====
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m])); }

    // ===== 로그인 처리(자동/수동) =====
    function tryAutoAuth(){
      const q = new URLSearchParams(location.search);
      const b = q.get('battle'), n = q.get('name'), t = q.get('token') || q.get('password'), tm = (q.get('team')||'A').toUpperCase();
      if (b && n && t){
        $('#authForm').classList.add('hidden');
        $('#authPending').classList.remove('hidden');
        battleId=b; myName=n; otp=t; myTeam = (tm==='B'?'B':'A');
        connect();
      }
    }
    $('#btnAuth').addEventListener('click', ()=>{
      battleId = $('#authBattle').value.trim();
      myTeam   = ($('#authTeam').value || 'A').toUpperCase()==='B'?'B':'A';
      myName   = $('#authName').value.trim();
      otp      = $('#authToken').value.trim();
      if(!battleId || !myName || !otp){ toast('모두 입력하세요'); return; }
      connect();
    });
    tryAutoAuth();
  </script>
</body>
</html>
