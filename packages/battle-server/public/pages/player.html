<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PYXIS - 전투 참여</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* ===== Base ===== */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root{
      --bg:#0a0d12;
      --panel:#11161d;
      --panel-2:#0f141b;
      --text:#f8f6f0;
      --dim:#cfc6b4;
      --gold:#d4b77e;
      --gold-2:#e6d3aa;
      --danger:#e74c3c; --success:#27ae60; --info:#3498db;
      --muted:#97a0ad;
      --radius:12px;
      --r-sm:8px;
      --border:2px solid rgba(212,183,126,.55);
      --border-sub:1px solid rgba(212,183,126,.28);
      --shadow:0 10px 28px rgba(0,0,0,.35);
      --fast:.18s cubic-bezier(.4,0,.2,1);
    }
    body{
      background:
        radial-gradient(900px 600px at 50% -120px, rgba(212,183,126,.10), transparent 60%),
        linear-gradient(180deg, #05080d 0%, #070b12 50%, #080c13 100%);
      color:var(--text); font-family:Inter, system-ui, -apple-system, sans-serif; min-height:100vh;
    }
    .container{ max-width:1200px; margin:0 auto; padding:24px; }
    .grid{ display:grid; grid-template-columns: 320px 1fr 360px; gap:16px; align-items:stretch }
    @media (max-width: 1024px){ .grid{ grid-template-columns:1fr; } }

    /* Panels */
    .panel{ background:linear-gradient(180deg, rgba(15,20,27,.75), rgba(15,20,27,.55)); border:var(--border); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden }
    .panel .head{ display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:var(--border-sub); background:linear-gradient(180deg, rgba(212,183,126,.08), rgba(212,183,126,.02)); }
    .panel .head h3{ font-family:Cinzel, serif; letter-spacing:.5px; font-weight:700; font-size:15px }
    .panel .body{ padding:14px; }

    /* Auth Modal */
    .modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.55); backdrop-filter: blur(4px); }
    .modal-card{ width:min(560px, calc(100% - 32px)); background:var(--panel); border:var(--border); border-radius:16px; box-shadow:var(--shadow); overflow:hidden }
    .modal-head{ padding:16px 18px; border-bottom:var(--border-sub); background:linear-gradient(180deg, rgba(212,183,126,.10), rgba(212,183,126,.02)); font-family:Cinzel, serif; font-weight:700 }
    .modal-body{ padding:18px; display:grid; gap:12px }
    .row{ display:grid; grid-template-columns: 140px 1fr; gap:10px; align-items:center }
    .row label{ color:var(--dim); font-size:13px }
    input[type="text"]{ width:100%; padding:10px 12px; background:#0c1016; border:1px solid rgba(212,183,126,.35); border-radius:8px; color:var(--text); outline:none }
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; min-height:38px; padding:0 14px; border-radius:10px; border:1px solid rgba(212,183,126,.45); background:linear-gradient(180deg, rgba(212,183,126,.15), rgba(212,183,126,.04)); color:var(--text); cursor:pointer; transition:transform var(--fast), filter var(--fast) }
    .btn:active{ transform:translateY(1px) }
    .btn-primary{ background:linear-gradient(180deg, rgba(212,183,126,.35), rgba(212,183,126,.12)); }
    .hint{ color:var(--muted); font-size:12px }

    /* Player card */
    .stat{ display:flex; gap:6px; align-items:center; font-size:12px; color:var(--dim) }
    .stat b{ color:var(--text); font-weight:600 }
    .hpbar{ height:8px; background:#0b0f15; border:1px solid rgba(212,183,126,.35); border-radius:999px; overflow:hidden }
    .hpbar > i{ display:block; height:100%; width:40%; background:linear-gradient(90deg, #27ae60, #e6d3aa) }

    /* Roster */
    .list{ display:flex; flex-direction:column; gap:10px }
    .item{ padding:12px; border:1px solid rgba(212,183,126,.25); border-radius:10px; background:linear-gradient(180deg, rgba(17,22,29,.75), rgba(17,22,29,.55)); }
    .item .name{ font-weight:700 }

    /* Actions */
    .actions{ display:grid; grid-template-columns: repeat(5,1fr); gap:8px }
    .actions .btn{ min-height:42px }

    /* Log/Chat */
    .scroll{ height:320px; overflow:auto; border:1px solid rgba(212,183,126,.25); border-radius:8px; padding:10px; background:#0c1016 }
    .logline{ font-size:12px; color:var(--dim); padding:3px 0 }
    .logline .tag{ color:var(--gold-2); }

    .hidden{ display:none !important; }
  </style>
</head>
<body>
  <div id="authModal" class="modal">
    <div class="modal-card">
      <div class="modal-head">전투 참여</div>
      <div class="modal-body">
        <div class="row">
          <label>Battle ID</label>
          <input type="text" id="authBattleId" placeholder="예: XXWJMALS" />
        </div>
        <div class="row">
          <label>OTP</label>
          <input type="text" id="authOtp" placeholder="관리자가 발급한 OTP" />
        </div>
        <div class="row">
          <label>이름</label>
          <input type="text" id="authName" placeholder="예: 카시엘" />
        </div>
        <div style="display:flex; gap:8px; align-items:center">
          <button id="btnAuth" class="btn btn-primary">입장</button>
          <span id="authMsg" class="hint"></span>
        </div>
      </div>
    </div>
  </div>

  <div class="container" id="mainUI" style="display:none">
    <div class="grid">
      <!-- Left: Me -->
      <div class="panel">
        <div class="head"><h3>나</h3></div>
        <div class="body">
          <div class="stat"><span>이름</span><b id="playerName">-</b></div>
          <div class="stat"><span>팀</span><b id="playerTeam">-</b></div>
          <div class="stat"><span>HP</span><b id="playerHp">-</b></div>
          <div class="hpbar"><i id="hpFill" style="width:0%"></i></div>
        </div>
      </div>

      <!-- Middle: Battle area -->
      <div class="panel">
        <div class="head"><h3>전투</h3><div class="hint" id="turnStatus">대기중</div></div>
        <div class="body">
          <div class="actions">
            <button id="btnAttack" class="btn">공격</button>
            <button id="btnDefend" class="btn">방어</button>
            <button id="btnDodge"  class="btn">회피</button>
            <button id="btnItem"   class="btn">아이템</button>
            <button id="btnPass"   class="btn">패스</button>
          </div>
          <div style="height:12px"></div>
          <div class="scroll" id="battleLog"></div>
        </div>
      </div>

      <!-- Right: Roster -->
      <div class="panel">
        <div class="head"><h3>로스터</h3></div>
        <div class="body">
          <div id="roster" class="list"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    let socket;
    let me = null;
    let players = [];
    let myTeamKey = null;
    let battleId = (new URL(location.href)).searchParams.get("battle") || "";

    // UI refs
    const authModal = document.getElementById("authModal");
    const mainUI   = document.getElementById("mainUI");
    const authMsg  = document.getElementById("authMsg");
    const otpEl    = document.getElementById("authOtp");
    const nameEl   = document.getElementById("authName");
    const battleEl = document.getElementById("authBattleId");
    const btnAuth  = document.getElementById("btnAuth");

    const playerNameEl = document.getElementById("playerName");
    const playerTeamEl = document.getElementById("playerTeam");
    const playerHpEl   = document.getElementById("playerHp");
    const hpFill       = document.getElementById("hpFill");
    const rosterEl     = document.getElementById("roster");
    const turnStatus   = document.getElementById("turnStatus");
    const logEl        = document.getElementById("battleLog");

    // 액션 버튼
    const btnAttack = document.getElementById("btnAttack");
    const btnDefend = document.getElementById("btnDefend");
    const btnDodge  = document.getElementById("btnDodge");
    const btnItem   = document.getElementById("btnItem");
    const btnPass   = document.getElementById("btnPass");

    function addLog(text, tag){
      const line = document.createElement("div");
      line.className = "logline";
      line.innerHTML = (tag ? `<span class="tag">[${tag}]</span> ` : "") + text;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function renderRoster(){
      rosterEl.innerHTML = "";
      players.forEach(p=>{
        const li = document.createElement("div");
        li.className = "item";
        li.innerHTML = `
          <div class="name">${p.name || p.id || "-"}</div>
          <div class="stat"><span>팀</span><b>${p.team||"-"}</b></div>
          <div class="stat"><span>HP</span><b>${(p.hp!=null?p.hp:"-")}</b></div>
        `;
        rosterEl.appendChild(li);
      });
    }

    function renderMe(){
      if(!me){ playerNameEl.textContent="-"; playerTeamEl.textContent="-"; playerHpEl.textContent="-"; hpFill.style.width="0%"; return; }
      playerNameEl.textContent = me.name || me.id || "-";
      playerTeamEl.textContent = me.team || "-";
      playerHpEl.textContent   = (me.hp!=null ? me.hp : "-");
      const hp = Math.max(0, Math.min(100, (me.hp || 0)));
      hpFill.style.width = hp + "%";
    }

    function renderAll(battle){
      if(Array.isArray(battle?.players)) players = battle.players;
      if(me){
        const fresh = players.find(p=>(p.id===me.id)||(p.name===me.name));
        if(fresh) me = fresh;
      }
      renderRoster();
      renderMe();
    }

    function setTurn(current, currentName){
      if(currentName){ turnStatus.textContent = `현재 턴: ${currentName}`; }
      else if(current){ turnStatus.textContent = `현재 턴 진행중`; }
      else{ turnStatus.textContent = `대기중`; }
    }

    function connect(){
      if(socket) socket.disconnect();
      socket = io();

      // 인증 버튼
      btnAuth.addEventListener("click", ()=>{
        battleId = (battleEl.value || "").trim();
        const otp  = (otpEl.value || "").trim();
        const name = (nameEl.value || "").trim();
        if(!battleId || !otp || !name){ authMsg.textContent="battle/OTP/이름을 입력하세요."; return; }

        // 구버전 서버 호환
        socket.emit("player:auth", { battleId, otp, name });
        // 신버전 서버 호환 (통합 join)
        socket.emit("joinBattle", { battleId, role: "player", otp, playerId: name });
      });

      // 인증 성공 (구버전)
      socket.on("auth:success", ({ player, roster, battle, firstTurnName })=>{
        me = player;
        players = roster || [];
        myTeamKey = me.team; // 'phoenix' | 'eaters' or 'A'/'B'
        renderAll(battle);
        renderRoster();
        setTurn(battle?.turn?.current, battle?.turn?.currentName || firstTurnName);
        authModal.style.display = "none";
        mainUI.style.display = "block";
        addLog("전투 참여 인증 완료.", "system");
      });

      // 인증 성공 (신버전 joinBattle → joinSuccess)
      socket.on("joinSuccess", ({ state, role, playerId })=>{
        try{
          if(role !== "player") return;
          const battle = state || {};
          players = battle.players || [];
          me = players.find(p=>p.id === playerId || p.name === playerId) || null;
          myTeamKey = (me?.team === "A") ? "phoenix" : (me?.team === "B" ? "eaters" : me?.team);
          renderAll(battle);
          renderRoster();
          setTurn(battle?.turn?.current, battle?.turn?.currentName);
          authModal.style.display = "none";
          mainUI.style.display = "block";
          addLog("전투 참여 인증 완료.", "system");
        }catch(e){
          authMsg.textContent = "인증 처리 중 오류";
        }
      });

      // 인증 실패
      socket.on("auth:fail", (d)=>{ authMsg.textContent = d?.reason || "인증 실패"; });

      // 전투 상태 갱신
      socket.on("battle:update", (battle)=>{
        if(!battle) return;
        renderAll(battle);
      });

      // 로그
      socket.on("battle:log", (msg)=>{ addLog(msg?.text || String(msg), msg?.tag); });

      // 내 HP 갱신
      socket.on("player:update", (p)=>{
        if(!me) return;
        if(p?.id===me.id || p?.name===me.name){ me = p; renderMe(); }
      });

      // 턴 변경
      socket.on("turn:update", ({ current, currentName })=>{
        setTurn(current, currentName);
      });

      // 연결
      socket.on("connect", ()=> addLog("서버 연결됨", "system"));
      socket.on("disconnect", ()=> addLog("서버 연결 해제", "system"));
    }

    // 액션 (기존 이벤트명 유지)
    btnAttack.addEventListener("click", ()=>{ socket.emit("action:attack"); });
    btnDefend.addEventListener("click", ()=>{ socket.emit("action:defend"); });
    btnDodge .addEventListener("click", ()=>{ socket.emit("action:dodge"); });
    btnItem  .addEventListener("click", ()=>{ socket.emit("action:item");  });
    btnPass  .addEventListener("click", ()=>{ socket.emit("action:pass");  });

    // 초기값 세팅
    if(battleId) document.getElementById("authBattleId").value = battleId;
    connect();
  </script>
</body>
</html>
