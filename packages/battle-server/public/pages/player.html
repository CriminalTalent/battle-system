<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PYXIS - 전투 참여</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* ===== Base ===== */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root{
      --bg:#0a0d12;
      --panel:#11161d;
      --panel-2:#0f141b;
      --text:#f8f6f0;
      --dim:#cfc6b4;
      --gold:#d4b77e;
      --gold-2:#e6d3aa;
      --danger:#e74c3c;
      --success:#27ae60;
      --info:#3498db;
      --muted:#97a0ad;
      --radius:12px;
      --r-sm:8px;
      --border:2px solid rgba(212,183,126,.55);
      --border-sub:1px solid rgba(212,183,126,.28);
      --shadow:0 10px 28px rgba(0,0,0,.35);
      --fast:.18s cubic-bezier(.4,0,.2,1);
    }
    body{
      background:
        radial-gradient(900px 600px at 50% -120px, rgba(212,183,126,.10), transparent 60%),
        linear-gradient(180deg, #05080d 0%, #070b12 50%, #080c13 100%);
      color:var(--text); font-family:Inter, system-ui, -apple-system, sans-serif; min-height:100vh;
    }
    .container{max-width:1600px; margin:0 auto; padding:16px;}
    .header{text-align:center; margin-bottom:12px;}
    .brand{font-family:'Cinzel', serif; font-size:32px; letter-spacing:.08em;
      background:linear-gradient(135deg,var(--gold),#fff,var(--gold-2)); -webkit-background-clip:text; color:transparent;}
    .sub{color:var(--muted); font-size:12px; letter-spacing:.18em; margin-top:4px;}

    /* ===== Grid (3-column) ===== */
    .player-layout{display:grid; grid-template-columns:320px 1fr 360px; gap:16px;}
    @media (max-width: 1200px){ .player-layout{ grid-template-columns:1fr; } }

    /* ===== Card ===== */
    .card{
      background:linear-gradient(180deg, var(--panel), var(--panel-2));
      border:var(--border); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow);
    }
    .card-header{font-weight:700; color:var(--gold); margin-bottom:10px; letter-spacing:.04em; font-family:'Cinzel', serif;}

    /* ===== Avatar (3:4, Vertical) ===== */
    .avatar-rect{ aspect-ratio: 3 / 4; width:100%; background:#1b222c; border:var(--border); border-radius:10px; object-fit:cover; }
    .avatar-rect.sm{ width:48px; height:64px; }
    .avatar-rect.md{ width:90px; height:120px; }
    .avatar-rect.lg{ width:180px; height:240px; }

    /* ===== Left: My panel ===== */
    .my-panel .grid{ display:grid; grid-template-columns:100px 1fr; gap:10px; align-items:center; }
    .my-name{font-weight:800; font-size:16px;}
    .my-team{font-size:12px; color:var(--gold); margin-top:2px;}
    .hp-wrap{ margin-top:6px; }
    .hp-label{ font-size:12px; color:var(--dim); }
    .hp-bar{ height:10px; background:#1a222c; border:var(--border-sub); border-radius:6px; overflow:hidden; margin-top:4px;}
    .hp-fill{ height:100%; background:linear-gradient(90deg, var(--gold), var(--gold-2)); width:0%; transition:width var(--fast); }

    .stat-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-top:8px; }
    .stat-item{ background:#141b23; border:var(--border-sub); border-radius:8px; padding:8px; text-align:center; }
    .stat-name{ font-size:11px; color:var(--dim); letter-spacing:.06em; }
    .stat-val{ font-weight:800; margin-top:2px; }

    .ready-row{ display:flex; gap:8px; margin-top:10px; }
    .btn{
      appearance:none; cursor:pointer; font-weight:800; letter-spacing:.04em;
      background:linear-gradient(145deg, rgba(212,183,126,.1), rgba(212,183,126,.22)) padding-box,
                 linear-gradient(145deg, var(--gold), var(--gold-2)) border-box;
      border:var(--border); color:var(--text); border-radius:10px; padding:10px 14px; transition:transform var(--fast), box-shadow var(--fast);
    }
    .btn:hover{ transform:translateY(-2px); box-shadow:0 10px 24px rgba(212,183,126,.22); }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

    .action-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:8px; }
    .action-btn{ background:#0f151c; color:var(--text); border:var(--border); border-radius:10px; padding:12px; font-weight:800; cursor:pointer; }
    .action-btn:hover{ background:#17202b; color:var(--gold); }
    .action-btn[disabled]{ opacity:.5; cursor:not-allowed; }

    .items-grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px; }
    .item{ background:#141b23; border:var(--border-sub); border-radius:8px; padding:8px; text-align:center; cursor:pointer; }
    .item:hover{ outline:2px solid var(--gold); }

    .mate{ display:flex; align-items:center; gap:8px; background:#141b23; border:var(--border-sub); border-radius:10px; padding:8px; margin-bottom:6px; }
    .mate .meta{ line-height:1.2; }
    .mate .hp{ font-size:12px; color:var(--success); }
    .dead .hp{ color:var(--danger); opacity:.8; }

    /* ===== Center ===== */
    .center-col{ display:flex; flex-direction:column; align-items:center; gap:12px; }
    .turn-box{ text-align:center; border:var(--border); border-radius:12px; padding:10px 14px; background:#121822; }
    .turn-flag{ font-size:12px; color:var(--dim); }
    .turn-name{ font-weight:900; color:var(--gold); margin-top:2px; }
    .chat{
      width:100%; display:flex; flex-direction:column; height:320px;
      border:var(--border); border-radius:12px; overflow:hidden; background:#0f151c;
    }
    .chat-messages{ flex:1; overflow-y:auto; padding:10px; font-size:13px; }
    .chat-input-row{ display:flex; gap:8px; border-top:var(--border-sub); padding:8px; background:#121822; }
    .chat-input{ flex:1; background:#0f151c; color:var(--text); border:var(--border-sub); border-radius:8px; padding:8px; }
    .chat-send{ background:linear-gradient(145deg, var(--gold), var(--gold-2)); border:none; border-radius:8px; padding:8px 12px; font-weight:900; color:#000; cursor:pointer; }

    /* ===== Right ===== */
    .log{ height:280px; overflow-y:auto; border:var(--border); border-radius:12px; padding:10px; background:#0f151c; }
    .log-entry{ font-size:12px; margin-bottom:6px; }
    .log-system{ color:var(--info); }
    .log-action{ color:#ffd27a; }
    .log-damage{ color:var(--danger); }
    .log-heal{ color:var(--success); }

    /* ===== Auth Modal ===== */
    .auth-modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.75); z-index:9999; }
    .auth-box{ width:92%; max-width:420px; background:#0f151c; border:var(--border); border-radius:16px; padding:20px; }
    .auth-box h2{ font-family:'Cinzel',serif; color:var(--gold); text-align:center; margin-bottom:12px; }
    .fg{ margin-bottom:10px; }
    label{ display:block; font-size:12px; color:var(--dim); margin-bottom:6px; }
    .inp{ width:100%; padding:10px; background:#0c1218; border:var(--border-sub); border-radius:10px; color:var(--text); }
    .auth-btn{ width:100%; padding:12px; background:linear-gradient(145deg, var(--gold), var(--gold-2)); color:#000; border:none; border-radius:12px; font-weight:900; cursor:pointer; }
    .auth-msg{ color:var(--danger); font-size:12px; margin-top:6px; min-height:16px; }

    /* ===== Utility ===== */
    .muted{ color:var(--dim); font-size:12px; }
    .sep{ height:1px; background:rgba(212,183,126,.22); margin:10px 0; border-radius:999px; }
  </style>
</head>
<body>
  <!-- 인증 모달 -->
  <div id="authModal" class="auth-modal">
    <div class="auth-box">
      <h2>전투 참여 인증</h2>
      <div class="fg">
        <label for="otp">OTP</label>
        <input id="otp" class="inp" placeholder="관리자에게 받은 비밀번호" />
      </div>
      <div class="fg">
        <label for="pname">이름</label>
        <input id="pname" class="inp" placeholder="캐릭터 이름" />
      </div>
      <button id="btnAuth" class="auth-btn">입장하기</button>
      <div id="authMsg" class="auth-msg"></div>
    </div>
  </div>

  <div class="container" id="mainUI" style="display:none;">
    <header class="header">
      <div class="brand">PYXIS</div>
      <div class="sub">BATTLE ARENA</div>
    </header>

    <main class="player-layout">
      <!-- LEFT -->
      <section>
        <div class="card my-panel">
          <div class="card-header">내 정보</div>
          <div class="grid">
            <img id="myAvatar" class="avatar-rect md" alt="me" src="https://api.dicebear.com/7.x/adventurer/svg?seed=me" />
            <div>
              <div id="myName" class="my-name">-</div>
              <div id="myTeam" class="my-team">-</div>
              <div class="hp-wrap">
                <div class="hp-label">HP <span id="myHpText">-</span></div>
                <div class="hp-bar"><div id="myHpBar" class="hp-fill"></div></div>
              </div>
            </div>
          </div>

          <div class="stat-grid">
            <div class="stat-item"><div class="stat-name">공격</div><div id="sAtk" class="stat-val">-</div></div>
            <div class="stat-item"><div class="stat-name">방어</div><div id="sDef" class="stat-val">-</div></div>
            <div class="stat-item"><div class="stat-name">민첩</div><div id="sAgi" class="stat-val">-</div></div>
            <div class="stat-item"><div class="stat-name">행운</div><div id="sLuk" class="stat-val">-</div></div>
          </div>

          <div class="ready-row">
            <button id="btnReady" class="btn">준비 완료</button>
            <span id="readyStateText" class="muted">준비 상태: 대기</span>
          </div>
        </div>

        <div class="card">
          <div class="card-header">행동 선택</div>
          <div class="action-grid">
            <button class="action-btn" data-action="attack" disabled>공격</button>
            <button class="action-btn" data-action="defend" disabled>방어</button>
            <button class="action-btn" data-action="dodge"  disabled>회피</button>
            <button class="action-btn" data-action="pass"   disabled>패스</button>
          </div>
          <div class="muted" style="margin-top:8px">※ 자신의 턴에만 활성화됩니다.</div>
        </div>

        <div class="card">
          <div class="card-header">보유 아이템</div>
          <div id="itemsGrid" class="items-grid"></div>
        </div>

        <div class="card">
          <div class="card-header" id="allyHeader">나의 팀원</div>
          <div id="allyList"></div>
        </div>
      </section>

      <!-- CENTER -->
      <section class="center-col">
        <div class="turn-box">
          <div class="turn-flag" id="turnFlag">대기 중</div>
          <div class="turn-name" id="turnName">-</div>
        </div>
        <img id="battleAvatar" class="avatar-rect lg" alt="현재 전투자" src="https://api.dicebear.com/7.x/adventurer/svg?seed=default" />

        <div class="chat">
          <div id="chatMessages" class="chat-messages"></div>
          <div class="chat-input-row">
            <input id="chatInput" class="chat-input" placeholder="팀/전장에 메시지 보내기" />
            <button id="chatSend" class="chat-send">전송</button>
          </div>
        </div>
      </section>

      <!-- RIGHT -->
      <section>
        <div class="card">
          <div class="card-header" id="enemyHeader">적군 팀원</div>
          <div id="enemyList"></div>
        </div>

        <div class="card">
          <div class="card-header">전투 로그</div>
          <div id="battleLog" class="log"></div>
        </div>
      </section>
    </main>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
  (function(){
    "use strict";
    const $ = (s)=>document.querySelector(s);

    const authModal = $("#authModal");
    const mainUI    = $("#mainUI");
    const otpEl     = $("#otp");
    const nameEl    = $("#pname");
    const authMsg   = $("#authMsg");
    const btnAuth   = $("#btnAuth");

    const battleId  = new URLSearchParams(location.search).get("battle");

    // State
    let socket;
    let me = null;            // 내 플레이어 객체
    let players = [];         // 전체 플레이어
    let myTeamKey = null;     // 'phoenix' | 'eaters'
    let turnPlayerId = null;  // 현재 턴의 플레이어 ID
    let everyoneReady = false;

    // ===== Socket =====
    function connect(){
      if(socket) socket.disconnect();
      socket = io();

      // 플레이어 인증 요청
      btnAuth.addEventListener("click", ()=>{
        const otp  = (otpEl.value || "").trim();
        const name = (nameEl.value || "").trim();
        if(!battleId || !otp || !name){ authMsg.textContent="battle/OTP/이름을 입력하세요."; return; }
        socket.emit("player:auth", { battleId, otp, name });
      });

      // 인증 성공
      socket.on("auth:success", ({ player, roster, battle, firstTurnName })=>{
        me = player;
        players = roster || [];
        myTeamKey = me.team; // 서버는 'phoenix' | 'eaters' 로 전달한다고 가정
        renderAll(battle);
        renderRoster();
        setTurn(battle?.turn?.current, battle?.turn?.currentName || firstTurnName);
        authModal.style.display = "none";
        mainUI.style.display = "block";
        addLog("관전에… 아니, 전투 참여 인증 완료.", "system");
      });

      // 인증 실패
      socket.on("auth:fail", (d)=>{ authMsg.textContent = d?.reason || "인증 실패"; });

      // 전투 상태 갱신(로스터/HP/진행)
      socket.on("battle:update", (battle)=>{
        if(!battle) return;
        players = battle.players || players;
        renderAll(battle);
        renderRoster();
      });

      // 턴 변경
      socket.on("turn:update", ({ playerId, playerName })=>{
        setTurn(playerId, playerName);
      });

      // 준비 현황
      socket.on("ready:update", ({ allReady, who })=>{
        everyoneReady = !!allReady;
        $("#readyStateText").textContent = allReady ? "준비 상태: 전체 준비!" : `준비 상태: ${who?.length||0}명 준비`;
      });

      // 전투 시작
      socket.on("battle:started", ({ currentPlayerId, currentPlayerName })=>{
        setTurn(currentPlayerId, currentPlayerName);
        addLog(`전투 시작! 선공: ${currentPlayerName}`, "system");
      });

      // 액션/결과 로그만 로그창에
      socket.on("log:add", ({ type="action", msg })=>{
        addLog(msg, type);
      });

      // 채팅은 채팅창에만
      socket.on("chat:msg", ({ name, msg })=>{
        addChat(name, msg);
      });
    }

    // ===== UI Render =====
    function renderAll(battle){
      if(!me) return;

      // 내 정보
      $("#myName").textContent = me.name || "-";
      $("#myTeam").textContent = (myTeamKey === "phoenix") ? "불사조 기사단" : "죽음을 먹는 자들";

      const hp = clampNum(me.hp ?? 100, 0, me.maxHp ?? 100);
      const maxHp = me.maxHp ?? 100;
      $("#myHpText").textContent = `${hp}/${maxHp}`;
      $("#myHpBar").style.width = `${(hp / maxHp) * 100}%`;
      $("#myAvatar").src = me.avatar || "https://api.dicebear.com/7.x/adventurer/svg?seed=me";

      // 스탯
      $("#sAtk").textContent = me.stats?.atk ?? me.stats?.STR ?? "-";
      $("#sDef").textContent = me.stats?.def ?? me.stats?.DEF ?? "-";
      $("#sAgi").textContent = me.stats?.agi ?? me.stats?.DEX ?? "-";
      $("#sLuk").textContent = me.stats?.luk ?? me.stats?.LUK ?? "-";

      // 아이템
      const items = Array.isArray(me.items) ? me.items : [];
      const itemsGrid = $("#itemsGrid");
      itemsGrid.innerHTML = "";
      items.forEach((it, idx)=>{
        const n = (typeof it === "string") ? it : (it.name || `item${idx}`);
        const c = (typeof it === "object" && it.count != null) ? it.count : 1;
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `<div style="font-weight:800">${mapItem(n)}</div><div class="muted">x${c}</div>`;
        el.addEventListener("click", ()=>useItem(n));
        itemsGrid.appendChild(el);
      });

      // 팀 헤더(시점 반전)
      $("#allyHeader").textContent = (myTeamKey === "phoenix") ? "불사조 기사단" : "죽음을 먹는 자들";
      $("#enemyHeader").textContent = (myTeamKey === "phoenix") ? "죽음을 먹는 자들" : "불사조 기사단";

      // 행동 버튼 활성화 여부 갱신
      updateActionButtons();
    }

    function renderRoster(){
      const ally = players.filter(p => p.team === myTeamKey);
      const enemy = players.filter(p => p.team !== myTeamKey);

      renderTeamList("#allyList", ally, true);
      renderTeamList("#enemyList", enemy, false);

      // 중앙 전투자 아바타 업데이트
      const cur = players.find(p => p.id === turnPlayerId);
      $("#battleAvatar").src = cur?.avatar || "https://api.dicebear.com/7.x/adventurer/svg?seed=default";
    }

    function renderTeamList(sel, list, isAlly){
      const root = $(sel);
      root.innerHTML = "";
      if(!list.length){
        root.innerHTML = `<div class="muted">팀원이 없습니다.</div>`;
        return;
      }
      list.forEach(p=>{
        const row = document.createElement("div");
        row.className = "mate" + ((p.hp <= 0 || p.status === "dead") ? " dead" : "");
        row.innerHTML = `
          <img class="avatar-rect sm" src="${p.avatar || "https://api.dicebear.com/7.x/adventurer/svg?seed=user"}" alt="">
          <div class="meta">
            <div style="font-weight:700">${p.name}${(turnPlayerId===p.id) ? ' <span style="color:var(--gold)">●</span>' : ''}</div>
            <div class="hp">${Math.max(0, p.hp ?? 0)}/${p.maxHp ?? 100} HP</div>
          </div>
        `;
        root.appendChild(row);
      });
    }

    function setTurn(playerId, playerName){
      turnPlayerId = playerId || null;
      $("#turnFlag").textContent = turnPlayerId ? "현재 턴" : "대기 중";
      $("#turnName").textContent = playerName || nameById(turnPlayerId) || "-";

      // 현재 전투자 아바타
      const cur = players.find(p => p.id === turnPlayerId);
      $("#battleAvatar").src = cur?.avatar || "https://api.dicebear.com/7.x/adventurer/svg?seed=default";

      updateActionButtons();
      renderRoster();
    }

    function updateActionButtons(){
      const myTurn = (me && turnPlayerId && me.id === turnPlayerId && (me.hp ?? 1) > 0);
      document.querySelectorAll(".action-btn").forEach(btn=>{
        btn.disabled = !myTurn;
      });
    }

    // ===== Actions =====
    $("#btnReady").addEventListener("click", ()=>{
      if(!socket || !me) return;
      socket.emit("player:ready", { battleId, playerId: me.id });
      $("#readyStateText").textContent = "준비 상태: 전송됨…";
      $("#btnReady").disabled = true;
      setTimeout(()=>{ $("#btnReady").textContent = "준비 완료"; }, 200);
    });

    document.querySelectorAll(".action-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        if(!socket || !me) return;
        const type = btn.getAttribute("data-action");
        // 공격은 대상 지정 필요 → 가장 체력 높은 적 자동 선택(클라이언트 보조)
        let targetId = null;
        if(type === "attack"){
          const enemy = players.filter(p=>p.team !== myTeamKey && (p.hp??1) > 0);
          enemy.sort((a,b)=> (b.hp??0) - (a.hp??0));
          targetId = enemy[0]?.id || null;
        }
        socket.emit("player:action", { battleId, playerId: me.id, action: { type, target: targetId } });
      });
    });

    function useItem(name){
      if(!socket || !me) return;
      // 기본: 자신에게 사용(디터니 등). 필요시 대상 선택 후 타겟 지정
      socket.emit("player:action", { battleId, playerId: me.id, action: { type: "item", itemType: normalizeItemKey(name), target: me.id } });
    }

    // ===== Chat =====
    $("#chatSend").addEventListener("click", sendChat);
    $("#chatInput").addEventListener("keypress", (e)=>{ if(e.key === "Enter") sendChat(); });
    function sendChat(){
      const input = $("#chatInput");
      const msg = (input.value||"").trim();
      if(!msg || !socket || !me) return;
      socket.emit("chat:send", { battleId, name: me.name, msg });
      input.value = "";
    }

    // ===== Helpers =====
    function addLog(text, type="action"){
      const log = $("#battleLog");
      const div = document.createElement("div");
      div.className = `log-entry log-${type}`;
      div.textContent = text;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    }

    function addChat(author, text){
      const box = $("#chatMessages");
      const div = document.createElement("div");
      div.innerHTML = `<span style="color:var(--gold); font-weight:800; margin-right:6px">${escapeHtml(author)}:</span>${escapeHtml(text)}`;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    function nameById(id){
      return players.find(p=>p.id===id)?.name || null;
    }
    function clampNum(n, min, max){
      const v = Number(n||0); if(Number.isNaN(v)) return min; return Math.max(min, Math.min(max, v));
    }
    function mapItem(k){
      const key = normalizeItemKey(k);
      return ({
        dittany:"디터니",
        heal10:"디터니",
        atkboost:"공격 보정기",
        attackboost:"공격 보정기",
        defboost:"방어 보정기",
        defenseboost:"방어 보정기",
      }[key] || k);
    }
    function normalizeItemKey(k){
      return String(k||"").toLowerCase().replace(/[^a-z]/g,"");
    }
    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    }

    // kick off
    connect();
  })();
  </script>
</body>
</html>
