<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PYXIS 전투 아레나 (플레이어)</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind 확장 -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            pyxis: {
              50:'#f4f3ef',100:'#ebe7d7',200:'#d9ccaa',300:'#c7b27e',
              400:'#b79956',500:'#9e7f3a',600:'#7f652d',700:'#645026',
              800:'#4a3c1c',900:'#332a14'
            }
          },
          boxShadow: { soft: '0 2px 18px rgba(0,0,0,.25)' }
        }
      }
    }
  </script>

  <style>
    html, body { height: 100%; }
    body { background: radial-gradient(90rem 60rem at 50% -20%, #1b1d22, #0f1115) fixed; }
    .glass { background: rgba(18,20,25,.6); backdrop-filter: blur(6px); }
    .card { @apply glass rounded-2xl border border-zinc-800 shadow-soft; }
    .card-header { @apply px-5 py-3 border-b border-zinc-800 flex items-center justify-between; }
    .card-title { @apply text-zinc-100 font-semibold tracking-wide; }
    .card-body { @apply p-5; }
    .pill { @apply inline-flex items-center gap-2 rounded-full border border-zinc-700 px-2.5 py-0.5 text-[11px] text-zinc-300; }
    .btn { @apply inline-flex items-center justify-center gap-2 rounded-xl px-3 py-2 text-sm font-medium border border-zinc-700 text-zinc-200 hover:bg-zinc-800 transition; }
    .btn-gold { @apply border-pyxis-600 bg-pyxis-700 text-white hover:bg-pyxis-600; }
    .btn-danger { @apply border-red-700 bg-red-700 text-white hover:bg-red-600; }
    .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; }
    .bar { height: 6px; border-radius: 9999px; background: #3a3b41; overflow: hidden; }
    .bar > i { display: block; height: 100%; background: linear-gradient(90deg,#e6c487,#caa65e 60%,#7f652d); }
    .stat { @apply text-xs text-zinc-300; }
    .disabled { opacity:.5; pointer-events:none; }
    .logline.ok { color:#22c55e; }
    .logline.err { color:#ef4444; }
  </style>
</head>
<body class="dark text-zinc-200">

  <!-- 헤더 -->
  <header class="sticky top-0 z-30 border-b border-zinc-800 glass">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-pyxis-600 to-pyxis-800 border border-zinc-800"></div>
        <div>
          <div class="text-2xl font-bold tracking-widest text-pyxis-200 drop-shadow">PYXIS 전투 아레나</div>
          <div class="text-xs text-zinc-400">Player Client</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnConnect" class="btn btn-gold">동기화</button>
        <span class="pill">단계: <span id="badgePhase" class="font-semibold ml-1">-</span></span>
        <span class="pill">현재 팀: <span id="badgeTurnTeam" class="font-semibold ml-1">-</span></span>
        <span class="pill">승자: <span id="badgeWinner" class="font-semibold ml-1">미정</span></span>
      </div>
    </div>
  </header>

  <!-- 상단 인포 바 -->
  <section class="max-w-7xl mx-auto px-4 mt-4 grid grid-cols-1 lg:grid-cols-4 gap-3">
    <div class="card"><div class="card-body">
      <div class="text-xs text-zinc-400">단계</div>
      <div class="text-lg font-semibold" id="topPhase">-</div>
    </div></div>
    <div class="card"><div class="card-body">
      <div class="text-xs text-zinc-400">현재 팀</div>
      <div class="text-lg font-semibold" id="topTurnTeam">-</div>
    </div></div>
    <div class="card"><div class="card-body">
      <div class="text-xs text-zinc-400">팀 타이머</div>
      <div class="text-lg font-semibold" id="topTimer">-</div>
    </div></div>
    <div class="card"><div class="card-body">
      <div class="text-xs text-zinc-400">승자</div>
      <div class="text-lg font-semibold" id="topWinner">미정</div>
    </div></div>
  </section>

  <main class="max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-5">
    <!-- 좌: 내 팀 패널 -->
    <section class="flex flex-col gap-5">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title" id="leftTeamTitle">불사조 기사단</h2>
          <span class="pill">내 캐릭터</span>
        </div>
        <div class="card-body">
          <div class="flex items-start gap-4">
            <div class="w-14 h-14 rounded-full border border-zinc-700 bg-zinc-900"></div>
            <div class="flex-1">
              <div class="font-semibold" id="selfName">-</div>
              <div class="text-xs text-zinc-400" id="selfState">-</div>
              <div class="mt-2 bar"><i id="selfHP" style="width:0%"></i></div>
              <div class="mt-2 text-xs text-zinc-400">아이템: <span id="selfItems" class="mono">-</span></div>
              <div class="grid grid-cols-4 gap-2 mt-3">
                <div class="stat">공격 <b id="selfAtk">-</b></div>
                <div class="stat">방어 <b id="selfDef">-</b></div>
                <div class="stat">민첩 <b id="selfAgi">-</b></div>
                <div class="stat">행운 <b id="selfLuk">-</b></div>
              </div>
            </div>
            <div class="text-right text-pyxis-200 font-semibold" id="selfPct">0%</div>
          </div>
        </div>
      </div>

      <!-- 행동 패널 -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">전투 행동</h2>
          <span class="pill mono">코드: <span id="battleCode">-</span></span>
        </div>
        <div class="card-body">
          <div class="grid sm:grid-cols-4 gap-2">
            <button id="actAttack" class="btn">공격</button>
            <button id="actDefend" class="btn">방어</button>
            <button id="actHeal" class="btn">회복</button>
            <button id="actPass" class="btn">패스</button>
          </div>

          <div class="mt-4 grid sm:grid-cols-2 gap-3">
            <div>
              <div class="text-xs text-zinc-400 mb-1">대상 선택</div>
              <select id="targetSelect" class="w-full rounded-xl border border-zinc-700 bg-zinc-900 px-3 py-2 text-sm"></select>
              <div class="text-xs text-zinc-500 mt-1">대상은 같은 팀/상대 팀 모두 표시됩니다.</div>
            </div>

            <div>
              <div class="text-xs text-zinc-400 mb-1">아이템 사용</div>
              <div class="flex gap-2">
                <select id="itemSelect" class="flex-1 rounded-xl border border-zinc-700 bg-zinc-900 px-3 py-2 text-sm"></select>
                <button id="actItem" class="btn">사용</button>
              </div>
            </div>
          </div>

          <p id="turnHint" class="mt-4 text-xs"></p>
        </div>
      </div>
    </section>

    <!-- 중: 전투 모니터 + 채팅 -->
    <section class="flex flex-col gap-5">
      <!-- 전투 모니터 -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">전투 상태</h2>
          <span class="pill" id="turnPill">대기</span>
        </div>
        <div class="card-body">
          <div class="grid sm:grid-cols-3 gap-3">
            <div>
              <div class="text-xs text-zinc-400">단계</div>
              <div class="font-semibold" id="phaseText">-</div>
            </div>
            <div>
              <div class="text-xs text-zinc-400">턴 시간</div>
              <div class="font-semibold" id="turnTime">-</div>
            </div>
            <div>
              <div class="text-xs text-zinc-400">경과 시간</div>
              <div class="font-semibold" id="elapsedTime">-</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 채팅(간단) -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">실시간 채팅</h2>
          <span class="pill">플레이어 채널</span>
        </div>
        <div class="card-body">
          <div id="chatArea" class="bg-black/70 border border-zinc-800 rounded-xl h-64 overflow-auto p-3 mono text-xs">
            <div class="text-center text-[11px] text-zinc-500 mt-6">메시지가 없습니다</div>
          </div>
          <div class="flex gap-2 mt-3">
            <input id="chatInput" class="flex-1 rounded-xl border border-zinc-700 bg-zinc-900 px-3 py-2 text-sm outline-none" placeholder="메시지 입력..." />
            <button id="btnSendChat" class="btn btn-gold">전송</button>
            <button id="btnChatRefresh" class="btn">새로고침</button>
          </div>
        </div>
      </div>
    </section>

    <!-- 우: 상대 팀 대표 패널 -->
    <section class="flex flex-col gap-5">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title" id="rightTeamTitle">죽음을 먹는 자들</h2>
          <span class="pill">대표 플레이어</span>
        </div>
        <div class="card-body">
          <div class="flex items-start gap-4">
            <div class="w-14 h-14 rounded-full border border-zinc-700 bg-zinc-900"></div>
            <div class="flex-1">
              <div class="font-semibold" id="oppName">-</div>
              <div class="text-xs text-zinc-400" id="oppState">-</div>
              <div class="mt-2 bar"><i id="oppHP" style="width:0%"></i></div>
              <div class="mt-2 text-xs text-zinc-400">아이템: <span id="oppItems" class="mono">-</span></div>
              <div class="grid grid-cols-4 gap-2 mt-3">
                <div class="stat">공격 <b id="oppAtk">-</b></div>
                <div class="stat">방어 <b id="oppDef">-</b></div>
                <div class="stat">민첩 <b id="oppAgi">-</b></div>
                <div class="stat">행운 <b id="oppLuk">-</b></div>
              </div>
            </div>
            <div class="text-right text-pyxis-200 font-semibold" id="oppPct">0%</div>
          </div>
        </div>
      </div>

      <!-- 로그 -->
      <div class="card">
        <div class="card-header"><h2 class="card-title">전투 로그</h2></div>
        <div class="card-body">
          <div id="playLog" class="bg-black/70 border border-zinc-800 rounded-xl h-48 overflow-auto p-3 mono text-xs"></div>
          <div class="flex items-center gap-2 mt-3">
            <button id="btnClearLog" class="btn">지우기</button>
            <span class="text-xs text-zinc-500">표시만 지웁니다.</span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- 푸터 -->
  <footer class="border-t border-zinc-800 glass">
    <div class="max-w-7xl mx-auto px-4 py-3 text-xs text-zinc-400 flex items-center justify-between">
      <div>© PYXIS Battle System</div>
      <div class="space-x-3">
        <span class="border border-zinc-700 rounded px-1.5 py-0.5">?battle=CODE&player=NAME</span><span>URL 파라미터로 연결</span>
      </div>
    </div>
  </footer>

  <!-- 스크립트 -->
  <script>
    // ===== API =====
    const ENDPOINTS = {
      battle:   (id) => `/api/battles/${id}`,
      action:   (id) => `/api/battles/${id}/action`,
      chatSend: (id) => `/api/battles/${id}/chat`,
      chatList: (id) => `/api/battles/${id}/chat?limit=50`
    };

    // ===== 상태 =====
    const $ = (s) => document.querySelector(s);
    const logBox = $('#playLog');
    const chatArea = $('#chatArea');
    let BATTLE_ID = null;
    let PLAYER_NAME = null;
    let SELF = null;         // 내 플레이어 객체
    let PLAYERS = [];        // 전체 플레이어
    let REFRESH_TIMER = null;

    function addLog(msg, cls='') {
      const el = document.createElement('div');
      el.className = 'logline ' + cls;
      el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logBox.appendChild(el);
      logBox.scrollTop = logBox.scrollHeight;
    }

    async function jfetch(url, opt={}) {
      const res = await fetch(url, {
        headers: { 'Content-Type':'application/json', ...(opt.headers||{}) },
        ...opt
      });
      let body = null;
      try { body = await res.json(); } catch {}
      if (!res.ok) throw new Error(`${res.status} ${body?.message || res.statusText}`);
      return body ?? {};
    }

    // ===== 도우미 =====
    const pct = (n,d)=> d? Math.max(0,Math.min(100,Math.round((n/d)*100))):0;
    const setBar = (el,v)=> el.style.width = `${v}%`;
    function itemToText(it){
      if (!it) return '-';
      if (Array.isArray(it) && it.length) {
        return it.map(x=>{
          const n=x?.name ?? x?.id ?? '아이템';
          const c=x?.count ?? 1;
          return `${n}${c>1?`:${c}`:''}`;
        }).join(', ');
      }
      if (typeof it==='string') return it;
      if (typeof it==='object') return Object.entries(it).map(([k,v])=>`${k}:${v}`).join(', ') || '-';
      return '-';
    }

    function fillPanel(prefix, p) {
      const name = p?.name ?? '-';
      const hp = p?.hp ?? p?.HP ?? 0;
      const max = p?.maxHp ?? p?.maxHP ?? 100;
      const alive = (p?.alive !== false);
      const state = p?.state ?? (alive ? '대기' : '사망');
      const percent = pct(hp, max);

      $('#'+prefix+'Name').textContent  = name;
      $('#'+prefix+'State').textContent = `${hp}/${max} HP · ${alive ? '생존' : '사망'} · ${state}`;
      setBar($('#'+prefix+'HP'), percent);
      $('#'+prefix+'Pct').textContent = `${percent}%`;
      $('#'+prefix+'Atk').textContent = p?.atk ?? p?.attack ?? '-';
      $('#'+prefix+'Def').textContent = p?.def ?? p?.defense ?? '-';
      $('#'+prefix+'Agi').textContent = p?.agi ?? p?.agility ?? '-';
      $('#'+prefix+'Luk').textContent = p?.luk ?? p?.luck ?? '-';
      $('#'+prefix+'Items').textContent = itemToText(p?.items);
    }

    function rebuildTargets() {
      const sel = $('#targetSelect');
      sel.innerHTML = '';
      PLAYERS.forEach(pl=>{
        const opt = document.createElement('option');
        opt.value = pl.id ?? pl._id ?? pl.name;
        const hp = (pl.hp ?? pl.HP ?? 0);
        const max = (pl.maxHp ?? pl.maxHP ?? 100);
        opt.textContent = `${pl.name ?? '플레이어'} (${hp}/${max})`;
        sel.appendChild(opt);
      });
    }

    function rebuildItems() {
      const sel = $('#itemSelect');
      sel.innerHTML = '';
      const items = SELF?.items;
      if (!items) return;
      if (Array.isArray(items)) {
        items.forEach(it=>{
          const opt=document.createElement('option');
          opt.value = it?.id ?? it?.name;
          const cnt = it?.count ?? 1;
          opt.textContent = `${it?.name ?? it?.id ?? '아이템'}${cnt>1?` x${cnt}`:''}`;
          sel.appendChild(opt);
        });
      } else if (typeof items==='object') {
        Object.entries(items).forEach(([k,v])=>{
          const opt=document.createElement('option');
          opt.value=k; opt.textContent = `${k}${v>1?` x${v}`:''}`;
          sel.appendChild(opt);
        });
      }
    }

    // ===== 렌더 =====
    function renderBattle(data){
      const phase = data?.phase ?? '-';
      const turnTeam = data?.turnTeam ?? '-';
      const winner = data?.winner ?? '미정';

      $('#badgePhase').textContent = phase;
      $('#badgeTurnTeam').textContent = turnTeam;
      $('#badgeWinner').textContent = winner;
      $('#topPhase').textContent = phase;
      $('#topTurnTeam').textContent = (turnTeam && turnTeam !== '-') ? `${turnTeam} 턴` : '-';
      $('#topTimer').textContent = (data?.teamTimerSec!=null) ? `${data.teamTimerSec}s` : '-';
      $('#topWinner').textContent = winner;
      $('#phaseText').textContent = phase;
      $('#turnTime').textContent = (data?.turnTimeSec!=null) ? `${data.turnTimeSec}s` : '-';
      $('#elapsedTime').textContent = data?.elapsed ?? '-';

      // 팀명 라벨
      $('#leftTeamTitle').textContent  = '불사조 기사단';
      $('#rightTeamTitle').textContent = '죽음을 먹는 자들';

      // 플레이어 목록
      PLAYERS = Array.isArray(data?.players) ? data.players : [];
      // 내 캐릭터 찾기
      SELF = PLAYERS.find(p => (p.name||'').toLowerCase() === (PLAYER_NAME||'').toLowerCase())
          || PLAYERS.find(p => p.team === 'phoenix')
          || PLAYERS[0];

      // 상대 대표
      const OPP = PLAYERS.find(p => SELF && p.team !== SELF.team) || PLAYERS.find((p,i)=> i===1);

      if (SELF) fillPanel('self', SELF);
      if (OPP)  fillPanel('opp',  OPP);

      rebuildTargets();
      rebuildItems();

      // 내 턴 여부 (팀 단위)
      const myTurn = SELF && data?.turnTeam && SELF.team === data.turnTeam;
      $('#turnPill').textContent = myTurn ? '내 팀 턴' : '대기';
      const controls = ['#actAttack','#actDefend','#actHeal','#actPass','#actItem'].map(s=>$(s));
      controls.forEach(b=> b.classList.toggle('disabled', !myTurn));
      $('#turnHint').textContent = myTurn ? '당신의 팀 차례입니다. 행동을 선택하세요.' : '상대 팀 차례입니다. 잠시 기다려 주세요.';
    }

    // ===== 네트워크 =====
    async function loadOnce(){
      if (!BATTLE_ID) return;
      try {
        const data = await jfetch(ENDPOINTS.battle(BATTLE_ID));
        renderBattle(data);
      } catch (e) {
        addLog('상태 갱신 실패: ' + e.message, 'err');
      }
    }
    function startAuto(ms=2500){
      if (REFRESH_TIMER) clearInterval(REFRESH_TIMER);
      REFRESH_TIMER = setInterval(loadOnce, ms);
    }

    async function postAction(payload){
      if (!BATTLE_ID || !SELF) return;
      try {
        await jfetch(ENDPOINTS.action(BATTLE_ID), {
          method:'POST',
          body: JSON.stringify({ actor: SELF.id ?? SELF._id ?? SELF.name, ...payload })
        });
        addLog(`행동 전송: ${payload.type}`, 'ok');
        loadOnce();
      } catch(e){
        addLog(`행동 실패: ${e.message}`, 'err');
      }
    }

    // ===== 이벤트 바인딩 =====
    $('#actAttack').addEventListener('click', ()=> {
      const target = $('#targetSelect').value || null;
      postAction({ type:'attack', target });
    });
    $('#actDefend').addEventListener('click', ()=> postAction({ type:'defend' }));
    $('#actHeal').addEventListener('click',   ()=> postAction({ type:'heal' }));
    $('#actPass').addEventListener('click',   ()=> postAction({ type:'pass' }));
    $('#actItem').addEventListener('click',   ()=> {
      const target = $('#targetSelect').value || null;
      const item   = $('#itemSelect').value || null;
      if (!item) return addLog('사용할 아이템이 없습니다','err');
      postAction({ type:'item', item, target });
    });

    // 채팅
    async function refreshChat(){
      if (!BATTLE_ID) return;
      try {
        const rows = await jfetch(ENDPOINTS.chatList(BATTLE_ID));
        const list = Array.isArray(rows) ? rows : (rows?.items || []);
        chatArea.innerHTML = '';
        list.forEach(r=>{
          const div = document.createElement('div');
          const t = new Date(r.time || r.ts || Date.now()).toLocaleTimeString();
          div.textContent = `[${t}] ${(r.user||r.name||'익명')}: ${r.text||r.msg||''}`;
          chatArea.appendChild(div);
        });
        chatArea.scrollTop = chatArea.scrollHeight;
      } catch {}
    }
    $('#btnSendChat').addEventListener('click', async ()=>{
      const v = $('#chatInput').value.trim();
      if (!v) return;
      $('#chatInput').value = '';
      try {
        await jfetch(ENDPOINTS.chatSend(BATTLE_ID), {
          method:'POST',
          body: JSON.stringify({ user: PLAYER_NAME || (SELF?.name) || '플레이어', text: v })
        });
        refreshChat();
      } catch {
        // 서버 미지원 시 로컬 로그만
        const div = document.createElement('div');
        div.textContent = `[${new Date().toLocaleTimeString()}] 나: ${v}`;
        chatArea.appendChild(div);
        chatArea.scrollTop = chatArea.scrollHeight;
      }
    });
    $('#btnChatRefresh').addEventListener('click', refreshChat);

    // 공용
    $('#btnClearLog').addEventListener('click', ()=> { logBox.innerHTML=''; });
    $('#btnConnect').addEventListener('click', ()=> { loadOnce(); startAuto(2500); refreshChat(); });

    (function init(){
      const q = new URLSearchParams(location.search);
      BATTLE_ID   = q.get('battle') || '';
      PLAYER_NAME = q.get('player') || '';
      $('#battleCode').textContent = BATTLE_ID || '-';

      if (BATTLE_ID) {
        addLog(`배틀 코드 인식: ${BATTLE_ID}`,'ok');
        if (PLAYER_NAME) addLog(`플레이어: ${PLAYER_NAME}`,'ok');
        loadOnce();
        startAuto(2500);
        refreshChat();
      } else {
        addLog('URL에 ?battle=코드&player=이름 을 지정하세요.');
      }
    })();
  </script>
</body>
</html>
