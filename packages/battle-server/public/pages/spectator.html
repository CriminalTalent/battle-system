<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>PYXIS 관전자</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="/socket.io/socket.io.js"></script>
  <link href="/assets/pyxis-theme.css" rel="stylesheet" />
</head>
<body>
  <main class="container">
    <section id="auth" class="panel">
      <h2>관전자 접속</h2>
      <div>
        <label>전투 ID</label>
        <input id="battleId" type="text" placeholder="예: b_xxxxxx" />
      </div>
      <div>
        <label>관전자 OTP</label>
        <input id="otp" type="text" placeholder="관리자 발급 OTP" />
      </div>
      <div>
        <label>표시 이름</label>
        <input id="displayName" type="text" placeholder="선택 사항" />
      </div>
      <button id="btnJoin">접속</button>
      <div id="authMsg" class="hint"></div>
    </section>

    <section id="roster" class="panel" style="display:none;">
      <h2>플레이어</h2>
      <ul id="playerList"></ul>
    </section>

    <section id="logs" class="panel" style="display:none;">
      <h2>실시간 로그</h2>
      <div id="logBox" class="logbox"></div>
    </section>

    <!-- 관전자는 송신 금지: UI만 제거/미표기 -->
  </main>

  <script>
  (function(){
    'use strict';
    const $ = id => document.getElementById(id);

    const battleIdEl = $('battleId');
    const otpEl = $('otp');
    const nameEl = $('displayName');
    const btnJoin = $('btnJoin');
    const authMsg = $('authMsg');

    const rosterSec = $('roster');
    const playerList = $('playerList');
    const logsSec = $('logs');
    const logBox = $('logBox');

    let socket = null;
    let state = { battleId:null, otp:null, name:null };

    function appendLog(entry) {
      const line = document.createElement('div');
      const dt = new Date(entry.ts || Date.now());
      line.textContent = `[${dt.toLocaleTimeString()}] ${entry.text}`;
      logBox.appendChild(line);
      logBox.scrollTop = logBox.scrollHeight;
    }

    function renderRoster(players) {
      playerList.innerHTML = '';
      players.forEach(p => {
        const li = document.createElement('li');
        li.textContent = `${p.team} | ${p.name} | HP ${p.hp}`;
        playerList.appendChild(li);
      });
    }

    btnJoin.addEventListener('click', async () => {
      const battleId = battleIdEl.value.trim();
      const otp = otpEl.value.trim();
      const displayName = nameEl.value.trim();

      if (!battleId || !otp) {
        authMsg.textContent = '전투 ID와 OTP를 입력하세요.';
        return;
      }

      try {
        // 사전 검증 (선택)
        const r = await fetch('/api/auth', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ battleId, otp, role: 'spectator' })
        }).then(r=>r.json());
        if (!r.ok) {
          authMsg.textContent = '인증 실패: ' + (r.error||'');
          return;
        }

        state.battleId = battleId;
        state.otp = otp;
        state.name = displayName || '';

        socket = io();
        socket.on('connect', () => {
          socket.emit('session:init', { role:'spectator', battleId, otp, name: state.name });
        });

        socket.on('log:bootstrap', (logs) => {
          logsSec.style.display = '';
          rosterSec.style.display = '';
          logBox.innerHTML = '';
          (logs || []).forEach(appendLog);
          authMsg.textContent = '연결 성공';
        });

        socket.on('log:append', appendLog);
        socket.on('roster:update', (payload) => renderRoster(payload.players || []));

        // 관전자는 채팅 송신 불가 (UI 없음)
      } catch(e) {
        authMsg.textContent = '연결 오류';
      }
    });
  })();
  </script>
</body>
</html>
