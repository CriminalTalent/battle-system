<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PYXIS - 전투 관전</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --gold:#d4b77e; --gold-dark:#c9a96e; --gold-ink:#f0e7cd;
      --text:#f8f6f0; --text-dim:#b8a898;
      --success:#27ae60; --danger:#e74c3c; --info:#3498db;
      --radius:12px;
      --bg:#0b0b0f; --panel:#111217; --panel-2:#171922; --stroke:#2a2d39;
    }
    body{font-family:Inter,system-ui,sans-serif;background:linear-gradient(135deg,#050509,#0b0b0f 50%,#050509);color:var(--text);min-height:100vh;display:flex;flex-direction:column}
    .hidden{display:none!important}

    /* 로그인 모달 */
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.7);z-index:10}
    .modal-card{background:var(--panel);border:1px solid var(--stroke);border-radius:var(--radius);padding:24px;width:92%;max-width:440px}
    .modal-card h2{font-family:Cinzel,serif;color:var(--gold);text-align:center;margin-bottom:14px}
    .form-group{margin-bottom:12px}
    .label{font-size:12px;color:var(--text-dim);margin-bottom:6px;display:block}
    .input{width:100%;padding:11px 12px;border:1px solid var(--stroke);border-radius:10px;background:#1b1d27;color:var(--text)}
    .input:focus{outline:none;border-color:var(--gold)}
    .login-btn{width:100%;padding:12px;border:none;border-radius:10px;background:linear-gradient(135deg,var(--gold),var(--gold-dark));color:#000;font-weight:800;cursor:pointer}

    /* 3단 레이아웃 */
    .spectator-layout{display:grid;grid-template-columns:320px 1fr 320px;gap:16px;flex:1;padding:16px}
    .card{background:var(--panel);border:1px solid var(--stroke);border-radius:var(--radius);padding:14px}
    .card h3{font-family:Cinzel,serif;color:var(--gold);margin-bottom:10px;font-size:16px}

    /* 팀 리스트 */
    .player-list{display:flex;flex-direction:column;gap:8px}
    .player-item{display:flex;align-items:center;justify-content:space-between;background:var(--panel-2);border:1px solid var(--stroke);border-radius:10px;padding:8px}
    .who{display:flex;align-items:center;gap:8px}
    .avatar{width:32px;height:40px;object-fit:cover;border:1px solid var(--stroke);border-radius:6px;background:#222}
    .name{font-weight:700}
    .hp{font-size:12px;color:var(--success)}
    .dead{color:var(--danger)!important}

    /* 응원 */
    .cheer-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .cheer-btn{padding:8px;border:1px solid var(--gold);background:#151722;border-radius:10px;color:var(--gold);font-weight:700;cursor:pointer}
    .cheer-btn:hover{filter:brightness(1.1)}

    /* 중앙 전장 */
    .battlefield{display:flex;flex-direction:column;gap:14px;align-items:center;background:var(--panel);border:1px solid var(--stroke);border-radius:var(--radius);padding:16px}
    .active{display:flex;align-items:center;gap:12px}
    .active-avatar{width:120px;height:160px;object-fit:cover;border:2px solid var(--gold);border-radius:8px;background:#222}
    .turn-box{display:flex;flex-direction:column;gap:6px}
    .turn-name{font-weight:800;color:var(--gold-ink)}
    .turn-timer{font-family:ui-monospace,Menlo,Consolas,monospace;font-weight:800}
    .timer-bar{width:280px;height:10px;background:#262938;border:1px solid var(--stroke);border-radius:999px;overflow:hidden}
    .timer-fill{height:100%;background:linear-gradient(90deg,var(--gold-dark),var(--gold));width:0%}

    /* 채팅/로그 */
    .pane{display:flex;flex-direction:column;gap:8px;height:320px}
    .list{flex:1;overflow:auto;border:1px solid var(--stroke);border-radius:10px;background:#0f1118;padding:10px}
    .msg b{color:var(--gold)}
    .log .entry{margin-bottom:6px;font-size:12px}
    .log .system{color:var(--info)}
    .log .damage{color:var(--danger)}
    .log .heal{color:var(--success)}
    .log .cheer{color:var(--gold)}
  </style>
</head>
<body>
  <!-- 로그인 -->
  <div id="loginModal" class="modal">
    <div class="modal-card">
      <h2>관전자 입장</h2>
      <form id="loginForm">
        <div class="form-group">
          <label class="label" for="battleId">전투 ID</label>
          <input id="battleId" class="input" required />
        </div>
        <div class="form-group">
          <label class="label" for="otp">비밀번호</label>
          <input id="otp" class="input" required />
        </div>
        <div class="form-group">
          <label class="label" for="spectatorName">이름</label>
          <input id="spectatorName" class="input" required />
        </div>
        <button class="login-btn" type="submit">입장</button>
      </form>
    </div>
  </div>

  <!-- 메인 -->
  <div id="layout" class="spectator-layout hidden">
    <!-- 좌: 죽먹자 -->
    <div>
      <div class="card">
        <h3>죽음을 먹는 자들</h3>
        <div id="enemyList" class="player-list"></div>
      </div>
      <div class="card">
        <h3>응원</h3>
        <div class="cheer-grid" id="cheerGrid"></div>
      </div>
    </div>

    <!-- 중앙 -->
    <div>
      <div class="battlefield">
        <div class="active">
          <img id="activeAvatar" class="active-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=default" />
          <div class="turn-box">
            <div class="turn-name">현재 턴: <span id="turnName">-</span></div>
            <div class="turn-timer">남은 시간: <span id="timerText">05:00</span></div>
            <div class="timer-bar"><div id="timerFill" class="timer-fill"></div></div>
          </div>
        </div>
        <div class="pane">
          <div class="list" id="chat"></div>
        </div>
      </div>
    </div>

    <!-- 우: 불사조 -->
    <div>
      <div class="card">
        <h3>불사조 기사단</h3>
        <div id="allyList" class="player-list"></div>
      </div>
      <div class="card">
        <h3>전투 로그</h3>
        <div id="log" class="list log"></div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let spectatorName = "";
    let currentBattle = null;

    // 고정 응원 문구
    const CHEERS = ["멋지다!","이겨라!","살아서 돌아와!","화이팅!","죽으면 나한테 죽어!","힘내요!"];

    // 엘리먼트
    const $ = (s)=>document.querySelector(s);
    const loginModal = $("#loginModal");
    const layout = $("#layout");
    const chatEl = $("#chat");
    const logEl = $("#log");
    const enemyList = $("#enemyList");
    const allyList = $("#allyList");
    const activeAvatar = $("#activeAvatar");
    const turnName = $("#turnName");
    const timerText = $("#timerText");
    const timerFill = $("#timerFill");

    // 로그인
    $("#loginForm").addEventListener("submit", (e)=>{
      e.preventDefault();
      const battleId = $("#battleId").value.trim();
      const otp = $("#otp").value.trim();
      spectatorName = $("#spectatorName").value.trim();
      if(!battleId || !otp || !spectatorName) return;
      socket.emit("spectator:join", { battleId, otp, name: spectatorName });
    });

    socket.on("spectator:join_ok", ({ battle })=>{
      loginModal.classList.add("hidden");
      layout.classList.remove("hidden");
      currentBattle = battle;
      renderBattle(battle);
      addLog("관전 시작!", "system");
    });

    socket.on("spectator:join_fail", (d)=>{
      alert(d?.reason || "입장 실패");
    });

    // 응원 버튼 구성
    (function buildCheers(){
      const grid = document.getElementById("cheerGrid");
      CHEERS.forEach(text=>{
        const btn = document.createElement("button");
        btn.className = "cheer-btn";
        btn.textContent = text;
        btn.addEventListener("click", ()=>{
          socket.emit("spectator:cheer", { name: spectatorName, msg: text });
        });
        grid.appendChild(btn);
      });
    })();

    // 공통 수신
    socket.on("battle:update", (b)=>{ currentBattle = b; renderBattle(b); });
    socket.on("battleUpdate", (b)=>{ currentBattle = b; renderBattle(b); }); // 구버전 호환
    socket.on("battle:chat", ({ name, msg })=> addChat(name, msg));
    socket.on("battle:log", ({ type, msg })=> addLog(msg, type || "system"));

    // 턴 틱(1초마다)
    socket.on("turn:tick", ({ remaining })=>{
      // 남은 시간 표시/프로그레스
      const ms = Math.max(0, Number(remaining||0));
      timerText.textContent = mmss(ms);
      if(currentBattle?.turn?.deadline && currentBattle?.turn?.lastChange){
        const total = 5 * 60 * 1000;
        const pct = Math.max(0, Math.min(100, ((total - ms) / total) * 100));
        timerFill.style.width = pct.toFixed(1) + "%";
      }
    });

    function renderBattle(b){
      // 팀 렌더
      const phoenix = b.players.filter(p=>p.team==="phoenix");
      const eaters  = b.players.filter(p=>p.team==="eaters");
      renderTeam(allyList, phoenix, "phoenix");
      renderTeam(enemyList, eaters, "eaters");

      // 현재 턴/아바타
      const cur = b.players.find(p=>p.id===b.turn?.current);
      turnName.textContent = cur?.name || "-";
      activeAvatar.src = cur?.avatar || "https://api.dicebear.com/7.x/avataaars/svg?seed=default";

      // 초기 타이머 텍스트
      if(b.turn?.deadline){
        const remain = Math.max(0, b.turn.deadline - Date.now());
        timerText.textContent = mmss(remain);
        const pct = Math.max(0, Math.min(100, ((5*60*1000 - remain) / (5*60*1000)) * 100));
        timerFill.style.width = pct.toFixed(1) + "%";
      }else{
        timerText.textContent = "00:00";
        timerFill.style.width = "0%";
      }
    }

    function renderTeam(container, list){
      container.innerHTML = "";
      list.forEach(p=>{
        const row = document.createElement("div");
        row.className = "player-item";
        const who = document.createElement("div");
        who.className = "who";
        who.innerHTML = `<img class="avatar" src="${p.avatar||""}"/><div class="name">${p.name}</div>`;
        const hp = document.createElement("div");
        hp.className = "hp";
        hp.textContent = `${p.hp}/${p.maxHp}`;
        if(!p.alive || p.hp<=0) hp.classList.add("dead");
        row.appendChild(who); row.appendChild(hp);
        container.appendChild(row);
      });
    }

    function addChat(author, text){
      const div = document.createElement("div");
      div.className = "msg";
      div.innerHTML = `<b>${escapeHtml(author)}:</b> ${escapeHtml(text)}`;
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function addLog(text, type="system"){
      const div = document.createElement("div");
      div.className = "entry " + (type || "system");
      div.textContent = text;
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function mmss(ms){
      const s = Math.floor(ms/1000);
      const m = Math.floor(s/60).toString().padStart(2,"0");
      const ss = (s%60).toString().padStart(2,"0");
      return `${m}:${ss}`;
    }
    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    }
  </script>
</body>
</html>
