<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PYXIS - 전투 관전</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --gold:#d4b77e; --gold-dark:#c9a96e; --gold-bright:#e6d3aa;
      --ink:#f8f6f0; --ink-dim:#cfc6b6;
      --bg:#0a0a0a; --panel:#111;
      --success:#27ae60; --danger:#e74c3c; --info:#49a0ff;
      --radius:12px;
    }
    body{font-family:Inter,system-ui,"Noto Sans KR",sans-serif;background:linear-gradient(135deg,#000,#111 55%,#000);color:var(--ink);min-height:100vh}
    .container{max-width:1600px;margin:0 auto;padding:16px}
    .header{text-align:center;margin-bottom:12px}
    .brand{font-family:Cinzel,serif;font-weight:700;font-size:32px;letter-spacing:.06em;background:linear-gradient(135deg,var(--gold),#fff,var(--gold-bright));-webkit-background-clip:text;background-clip:text;color:transparent}
    .pills{display:flex;gap:8px;justify-content:center;margin-top:6px}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;border-radius:999px;border:1px solid var(--gold);color:var(--gold);background:#111;font-size:12px}

    /* 3단 레이아웃: 좌 죽먹자(+응원), 중 아바타+채팅, 우 불기사(+로그) */
    .grid{display:grid;grid-template-columns:320px 1fr 320px;gap:16px}
    @media(max-width:1100px){.grid{grid-template-columns:1fr}}
    .card{background:var(--panel);border:2px solid var(--gold);border-radius:var(--radius);padding:14px}
    .card-header{color:var(--gold);font-weight:700;margin-bottom:8px;font-family:Cinzel,serif;letter-spacing:.04em}

    /* 팀 리스트 */
    .player-list{display:flex;flex-direction:column;gap:8px}
    .player-item{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:8px;background:#1a1a1a;border:1px solid var(--gold);border-radius:10px}
    .player-left{display:flex;gap:8px;align-items:center}
    .avatar{width:28px;height:28px;border:1px solid var(--gold);border-radius:6px;object-fit:cover;background:#222}
    .name{font-weight:800}
    .meta{font-size:12px;color:var(--ink-dim)}
    .status{font-size:11px;font-weight:700}
    .alive{color:var(--success)} .dead{color:var(--danger)}

    /* 응원 */
    .cheers{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
    .cheer-btn{padding:10px;border:2px solid var(--gold);border-radius:10px;background:#121212;color:var(--gold);font-weight:700;cursor:pointer}
    .cheer-btn:hover{background:#1c1c1c}

    /* 중앙: 턴/아바타/채팅 */
    .turn-box{text-align:center;border:2px solid var(--gold);border-radius:12px;padding:10px;background:#111}
    .active-avatar{width:170px;height:170px;border:3px solid var(--gold);border-radius:10px;object-fit:cover;background:#222;margin:10px auto}
    .chat{display:flex;flex-direction:column;height:360px;border:2px solid var(--gold);border-radius:12px;overflow:hidden}
    .chat-messages{flex:1;overflow:auto;padding:10px}
    .chat-message{margin-bottom:8px}
    .chat-author{color:var(--gold);font-weight:800;margin-right:6px}
    .chat-badge{font-size:11px;color:#000;background:linear-gradient(135deg,var(--gold),var(--gold-dark));padding:2px 6px;border-radius:999px;margin-left:6px}
    .chat-footer{padding:8px;background:#101010;border-top:1px solid var(--gold);text-align:center;color:var(--ink-dim);font-size:12px}
    .hint{font-size:12px;color:var(--ink-dim);text-align:center;margin-top:6px}

    /* 로그 */
    .log{height:300px;overflow:auto;border:1px solid var(--gold);border-radius:10px;background:#0f0f0f;padding:8px}
    .log-entry{font-size:12px;margin-bottom:6px}
    .log-system{color:var(--info)}
    .log-damage{color:var(--danger)}
    .log-heal{color:var(--success)}
    .log-cheer{color:var(--gold)}

    /* 모달 */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:9999}
    .modal-card{width:90%;max-width:420px;background:#111;border:2px solid var(--gold);border-radius:14px;padding:18px}
    .modal-card h2{font-family:Cinzel,serif;color:var(--gold);text-align:center;margin-bottom:8px}
    .form-group{margin:10px 0}
    .label{font-size:13px;color:var(--ink-dim);margin-bottom:6px;display:block}
    .field{width:100%;padding:10px;border:1px solid var(--gold);border-radius:10px;background:#181818;color:var(--ink)}
    .btn{appearance:none;cursor:pointer;font-weight:700;border-radius:10px;padding:10px 12px;color:#000;background:linear-gradient(145deg,var(--gold),var(--gold-dark));border:2px solid var(--gold);width:100%;margin-top:6px}
    .error{font-size:12px;color:var(--danger);margin-top:6px;min-height:16px}

    .hidden{display:none !important}
  </style>
</head>
<body>
  <!-- 로그인 모달 -->
  <div id="loginModal" class="modal">
    <div class="modal-card">
      <h2>관전자 입장</h2>
      <div class="form-group">
        <label class="label" for="otp">관리자 OTP</label>
        <input id="otp" class="field" placeholder="발급받은 비밀번호를 입력" />
      </div>
      <div class="form-group">
        <label class="label" for="nick">이름</label>
        <input id="nick" class="field" placeholder="표시할 이름을 입력" />
      </div>
      <button id="btnJoin" class="btn">입장</button>
      <div id="authMsg" class="error"></div>
      <div class="meta" style="text-align:center;margin-top:6px">URL의 <code>?battle=ID</code> 파라미터가 필요합니다.</div>
    </div>
  </div>

  <div id="app" class="container hidden">
    <header class="header">
      <h1 class="brand">PYXIS</h1>
      <div class="pills">
        <span class="pill">전투 ID: <span id="pillBattle">-</span></span>
        <span class="pill">상태: <span id="pillStatus">-</span></span>
        <span class="pill">현재 턴: <span id="pillTurn">-</span></span>
      </div>
    </header>

    <main class="grid">
      <!-- 좌: 죽먹자 + 응원 -->
      <section>
        <div class="card">
          <div class="card-header">죽음을 먹는 자들</div>
          <div id="deathList" class="player-list"></div>
        </div>
        <div class="card">
          <div class="card-header">응원</div>
          <div class="cheers" id="cheerButtons">
            <button class="cheer-btn" data-msg="멋지다!">멋지다!</button>
            <button class="cheer-btn" data-msg="이겨라!">이겨라!</button>
            <button class="cheer-btn" data-msg="살아서 돌아와!">살아서 돌아와!</button>
            <button class="cheer-btn" data-msg="화이팅!">화이팅!</button>
            <button class="cheer-btn" data-msg="죽으면 나한테 죽어!">죽으면 나한테 죽어!</button>
            <button class="cheer-btn" data-msg="힘내요!">힘내요!</button>
          </div>
          <div class="hint">관전자는 채팅 입력이 불가하며, 응원만 보낼 수 있어요.</div>
        </div>
      </section>

      <!-- 중: 현재 턴 아바타 + 채팅(응원 포함) -->
      <section>
        <div class="turn-box">
          <div style="font-weight:800">현재 턴</div>
          <div id="turnName" class="meta">-</div>
        </div>
        <img id="activeAvatar" class="active-avatar" alt="현재 전투자">
        <div class="chat" style="margin-top:10px">
          <div id="chatBox" class="chat-messages"></div>
          <div class="chat-footer">채팅은 전투자 전용입니다. (응원은 좌측 버튼 이용)</div>
        </div>
      </section>

      <!-- 우: 불기사 + 전투 로그 -->
      <section>
        <div class="card">
          <div class="card-header">불사조 기사단</div>
          <div id="phoenixList" class="player-list"></div>
        </div>
        <div class="card">
          <div class="card-header">전투 로그</div>
          <div id="logBox" class="log"></div>
        </div>
      </section>
    </main>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    (function(){
      const $ = s=>document.querySelector(s);
      const $$ = s=>Array.from(document.querySelectorAll(s));
      const socket = io();

      const qs = new URLSearchParams(location.search);
      const battleId = qs.get("battle");

      // Modal refs
      const loginModal = $("#loginModal");
      const btnJoin = $("#btnJoin");
      const otpEl = $("#otp");
      const nickEl = $("#nick");
      const authMsg = $("#authMsg");

      // App refs
      const app = $("#app");
      const pillBattle = $("#pillBattle");
      const pillStatus = $("#pillStatus");
      const pillTurn = $("#pillTurn");

      const deathList = $("#deathList");
      const phoenixList = $("#phoenixList");
      const logBox = $("#logBox");
      const chatBox = $("#chatBox");
      const activeAvatar = $("#activeAvatar");
      const turnName = $("#turnName");

      let spectatorName = "";
      let roster = [];
      let currentTurnPlayerId = null;

      // ---- Join as spectator ----
      btnJoin.addEventListener("click", ()=>{
        const otp = (otpEl.value||"").trim();
        const name = (nickEl.value||"").trim();
        if(!battleId){ authMsg.textContent = "URL에 ?battle=전투ID 가 필요합니다."; return; }
        if(!otp || !name){ authMsg.textContent = "비밀번호와 이름을 모두 입력하세요."; return; }
        spectatorName = name;
        socket.emit("spectator:join", { battleId, otp, name });
      });

      socket.on("spectator:join_ok", ({ battle })=>{
        pillBattle.textContent = battle?.id || battleId || "-";
        pillStatus.textContent = battle?.status || "-";
        loginModal.classList.add("hidden");
        app.classList.remove("hidden");
        appendLog("관전을 시작했습니다.", "system");
      });

      socket.on("spectator:join_fail", ({ reason })=>{
        authMsg.textContent = reason || "입장 실패";
      });

      // ---- Cheer buttons ----
      $("#cheerButtons").addEventListener("click", (e)=>{
        const btn = e.target.closest(".cheer-btn");
        if(!btn) return;
        const msg = btn.dataset.msg;
        socket.emit("spectator:cheer", { battleId, name: spectatorName, msg });
        // 낙관적 표시(서버가 cheer:msg 브로드캐스트 권장)
        appendChat(spectatorName, msg, true);
      });

      // ---- Battle state ----
      socket.on("battleUpdate", (b)=>{
        pillStatus.textContent = b.status || "-";
        roster = Array.isArray(b.players) ? b.players : roster;
        // 팀 분류 (서버 team 키: 'phoenix' | 'eaters' 로 가정)
        const phoenix = roster.filter(p=>p.team === "phoenix");
        const eaters  = roster.filter(p=>p.team === "eaters");
        renderTeam(phoenixList, phoenix);
        renderTeam(deathList,  eaters);

        // 턴
        currentTurnPlayerId = b?.turn?.current || currentTurnPlayerId;
        updateTurnFromId(currentTurnPlayerId);

        // 로그(채팅 제외)
        renderLogs((b.log || []).slice(-200));
      });

      // 턴 단독 이벤트도 수신
      socket.on("turn:update", ({ playerId, name })=>{
        currentTurnPlayerId = playerId || currentTurnPlayerId;
        turnName.textContent = name || "-";
        pillTurn.textContent = name || "-";
        const p = (roster||[]).find(x=>x.id===playerId);
        if(p) activeAvatar.src = p.avatar || activeAvatar.src;
      });

      // ---- Chat / Cheer display (채팅창 전용) ----
      // 전투자 채팅(두 네임스페이스 모두 대응)
      socket.on("chat:msg", ({ name, msg })=> appendChat(name, msg, false));
      socket.on("battle:chat", ({ name, msg })=> appendChat(name, msg, false));
      // 관전자 응원(서버에서 별도 이벤트 제공 시)
      socket.on("cheer:msg", ({ name, msg })=> appendChat(name, msg, true));

      // ---- Logs (로그창 전용) ----
      socket.on("battle:log", ({ msg, type })=> appendLog(msg, type || "system"));

      /* ---- Render helpers ---- */
      function renderTeam(container, players){
        container.innerHTML = "";
        if(!players || !players.length){
          const d = document.createElement("div");
          d.className = "meta";
          d.textContent = "플레이어 없음";
          container.appendChild(d);
          return;
        }
        players.forEach(p=>{
          const row = document.createElement("div");
          row.className = "player-item";
          const left = document.createElement("div");
          left.className = "player-left";
          const img = document.createElement("img");
          img.className = "avatar";
          img.src = p.avatar || "https://api.dicebear.com/7.x/avataaars/svg?seed=pyxis";
          const nm = document.createElement("div");
          nm.innerHTML = `<div class="name">${escapeHtml(p.name)}</div><div class="meta">ATK ${p.stats?.atk ?? "-"} • DEF ${p.stats?.def ?? "-"} • AGI ${p.stats?.agi ?? "-"} • LUK ${p.stats?.luk ?? "-"}</div>`;
          left.appendChild(img); left.appendChild(nm);

          const st = document.createElement("div");
          const dead = (p.hp<=0 || p.status==="dead");
          st.className = "status " + (dead ? "dead" : "alive");
          st.textContent = dead ? "DEAD" : `HP ${p.hp ?? 100}/${p.maxHp ?? 100}`;

          row.appendChild(left); row.appendChild(st);
          container.appendChild(row);
        });
      }

      function updateTurnFromId(pid){
        const p = (roster || []).find(x=>x.id===pid);
        const name = p?.name || "-";
        turnName.textContent = name;
        pillTurn.textContent = name;
        if(p) activeAvatar.src = p.avatar || activeAvatar.src;
      }

      function renderLogs(lines){
        logBox.innerHTML = "";
        lines.forEach(l=>{
          if(l.type === "chat") return; // 채팅은 로그에서 분리
          appendLog(l.message || "", l.type || "system");
        });
        logBox.scrollTop = logBox.scrollHeight;
      }

      function appendLog(text, type="system"){
        const d = document.createElement("div");
        d.className = "log-entry log-" + type;
        d.textContent = text;
        logBox.appendChild(d);
        logBox.scrollTop = logBox.scrollHeight;
      }

      function appendChat(name, msg, isCheer){
        const line = document.createElement("div");
        line.className = "chat-message";
        const safeName = escapeHtml(name);
        const safeMsg  = escapeHtml(msg);
        line.innerHTML = `<span class="chat-author">${safeName}:</span><span>${safeMsg}</span>${isCheer ? '<span class="chat-badge">응원</span>' : ''}`;
        chatBox.appendChild(line);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function escapeHtml(s){
        return String(s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
      }

      // 초기 안내
      if(!battleId){
        authMsg.textContent = "URL에 ?battle=전투ID 가 필요합니다.";
      }
    })();
  </script>
</body>
</html>
