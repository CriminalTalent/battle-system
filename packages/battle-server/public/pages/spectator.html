<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PYXIS - 전투 관전</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: linear-gradient(135deg, #000 0%, #111 50%, #000 100%);
      color: #f8f6f0;
      font-size: 14px;
      min-height: 100vh;
      display: flex; flex-direction: column;
    }
    :root {
      --gold: #d4b77e;
      --gold-dark: #c9a96e;
      --text-dim: #b8a898;
      --success: #27ae60;
      --danger: #e74c3c;
      --warning: #f39c12;
      --info: #3498db;
      --radius: 12px;
    }
    .hidden { display: none !important; }

    /* ===== 모달 로그인 ===== */
    .modal { position: fixed; inset: 0; display: flex; justify-content: center; align-items: center; background: rgba(0,0,0,.7); z-index: 2000; }
    .modal-card { background: #111; padding: 32px; border-radius: var(--radius); border: 2px solid var(--gold); width: 90%; max-width: 420px; }
    .modal-card h2 { font-family: 'Cinzel', serif; font-size: 22px; margin-bottom: 16px; text-align: center; color: var(--gold); }
    .form-group { margin-bottom: 16px; }
    .form-label { font-size: 13px; margin-bottom: 6px; display: block; color: var(--text-dim); }
    .form-input { width: 100%; padding: 10px; background: #222; border: 1px solid #555; border-radius: var(--radius); color: #fff; }
    .form-input:focus { outline: none; border-color: var(--gold); }
    .login-btn { width: 100%; padding: 12px; background: linear-gradient(135deg, var(--gold), var(--gold-dark)); border: none; border-radius: var(--radius); font-weight: 700; cursor: pointer; color: #000; }
    .err { margin-top: 8px; font-size: 12px; color: var(--danger); min-height: 16px; }

    /* ===== 메인 3단 레이아웃 ===== */
    .spectator-layout { display: grid; grid-template-columns: 320px 1fr 320px; gap: 16px; flex: 1; padding: 16px; }
    .card { background: #111; border: 2px solid #333; border-radius: var(--radius); padding: 16px; }
    .card h3 { margin-bottom: 12px; color: var(--gold); font-family: 'Cinzel', serif; font-size: 16px; }

    /* ===== 팀 리스트 ===== */
    .player-list { display: flex; flex-direction: column; gap: 8px; }
    .player-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #222; border-radius: var(--radius); border: 1px solid #444; }
    .player-left { display:flex; align-items:center; gap:8px; }
    .player-avatar { width:28px; height:28px; object-fit:cover; border:1px solid #666; border-radius:6px; background:#000; }
    .player-name { font-weight: 600; }
    .player-hp { font-size: 12px; font-weight: 600; color: var(--success); }
    .status-dead { color: var(--danger); }

    /* ===== 응원 버튼 ===== */
    .cheer-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .cheer-btn { padding: 8px; background: #222; border: 1px solid var(--gold); border-radius: var(--radius); cursor: pointer; color: var(--gold); font-size: 12px; font-weight: 600; }
    .cheer-btn:hover { background:#1a1a1a; }

    /* ===== 중앙 ===== */
    .battlefield { display: flex; flex-direction: column; align-items: center; gap: 16px; padding: 16px; border: 2px solid #333; border-radius: var(--radius); background: #111; }
    .active-avatar { width: 140px; height: 140px; background: #222; border: 3px solid var(--gold); border-radius: 10px; object-fit: cover; }
    .turn-label { font-size: 13px; color: var(--text-dim); }

    .chat-box { flex: 1; width: 100%; display: flex; flex-direction: column; border: 1px solid #444; border-radius: var(--radius); overflow: hidden; }
    .chat-messages { flex: 1; padding: 8px; overflow-y: auto; font-size: 13px; }
    .chat-line { margin-bottom:6px; }
    .chat-author { color: var(--gold); font-weight: 700; margin-right: 6px; }

    /* ===== 전투 로그 ===== */
    .battle-log { height: 300px; overflow-y: auto; font-size: 12px; }
    .log-entry { margin-bottom: 6px; }
    .log-system { color: var(--info); }
    .log-damage { color: var(--danger); }
    .log-heal { color: var(--success); }
    .log-cheer { color: var(--gold); }

    /* ===== 토스트 ===== */
    .toast { position:fixed; bottom:14px; left:50%; transform:translateX(-50%); background:#1a1a1a; border:1px solid var(--gold); padding:8px 12px; border-radius:8px; color:#fff; display:none; z-index:3000; }
    .toast.show { display:block; }
  </style>
</head>
<body>
  <!-- 로그인 모달 -->
  <div id="loginModal" class="modal">
    <div class="modal-card">
      <h2>관전자 입장</h2>
      <form id="loginForm">
        <div class="form-group">
          <label class="form-label" for="battleId">전투 ID</label>
          <input type="text" id="battleId" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label" for="otp">관전자 비밀번호</label>
          <input type="text" id="otp" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label" for="spectatorName">이름</label>
          <input type="text" id="spectatorName" class="form-input" maxlength="30" required>
        </div>
        <button type="submit" class="login-btn">입장</button>
        <div id="loginErr" class="err"></div>
      </form>
    </div>
  </div>

  <!-- 메인 레이아웃 -->
  <div id="spectatorLayout" class="spectator-layout hidden">
    <!-- 좌측: 적군 -->
    <div>
      <div class="card">
        <h3>죽음을 먹는 자들</h3>
        <div class="player-list" id="enemyList"></div>
      </div>
      <div class="card">
        <h3>응원</h3>
        <div class="cheer-buttons">
          <button class="cheer-btn" data-msg="멋지다!">멋지다!</button>
          <button class="cheer-btn" data-msg="이겨라!">이겨라!</button>
          <button class="cheer-btn" data-msg="살아서 돌아와!">살아서 돌아와!</button>
          <button class="cheer-btn" data-msg="화이팅!">화이팅!</button>
          <button class="cheer-btn" data-msg="죽으면 나한테 죽어!">죽으면 나한테 죽어!</button>
          <button class="cheer-btn" data-msg="힘내요!">힘내요!</button>
        </div>
      </div>
    </div>

    <!-- 중앙 -->
    <div>
      <div class="card battlefield">
        <div class="turn-label" id="turnLabel">전투 대기 중</div>
        <img id="activeAvatar" class="active-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=default" alt="현재 전투자">
        <div class="chat-box">
          <div id="chatMessages" class="chat-messages"></div>
        </div>
      </div>
    </div>

    <!-- 우측: 아군 -->
    <div>
      <div class="card">
        <h3>불사조 기사단</h3>
        <div class="player-list" id="allyList"></div>
      </div>
      <div class="card">
        <h3>전투 로그</h3>
        <div id="battleLog" class="battle-log"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    (function(){
      "use strict";
      const socket = io();

      // Elements
      const loginModal = document.getElementById("loginModal");
      const spectatorLayout = document.getElementById("spectatorLayout");
      const loginForm = document.getElementById("loginForm");
      const loginErr = document.getElementById("loginErr");
      const enemyList = document.getElementById("enemyList");
      const allyList = document.getElementById("allyList");
      const chatMessages = document.getElementById("chatMessages");
      const battleLog = document.getElementById("battleLog");
      const activeAvatar = document.getElementById("activeAvatar");
      const turnLabel = document.getElementById("turnLabel");
      const toastEl = document.getElementById("toast");

      // URL 프리필
      const qs = new URLSearchParams(location.search);
      const inputBattle = document.getElementById("battleId");
      const inputOtp = document.getElementById("otp");
      const inputName = document.getElementById("spectatorName");
      inputBattle.value = qs.get("battle") || "";
      inputOtp.value = qs.get("token") || "";
      inputName.value = qs.get("name") || "";

      // State
      let battleId = "";
      let spectatorName = "";
      let pollTimer = null;
      let lastLogCount = 0;

      // Auth submit
      loginForm.addEventListener("submit", async (e)=>{
        e.preventDefault();
        loginErr.textContent = "";
        const otp = (inputOtp.value||"").trim();
        const b = (inputBattle.value||"").trim();
        const nm = (inputName.value||"").trim();
        if(!otp || !b || !nm){ loginErr.textContent = "모든 입력을 채워주세요."; return; }

        // OTP 검증
        const v = await fetch(`/api/otp/${encodeURIComponent(otp)}`).then(r=>r.json()).catch(()=>({valid:false,error:"network"}));
        if(!v.valid){ loginErr.textContent = "OTP가 유효하지 않거나 사용되었습니다."; return; }
        if(v.role !== "spectator"){ loginErr.textContent = "관전자 OTP가 아닙니다."; return; }
        if(v.data?.battleId !== b){ loginErr.textContent = "OTP의 전투 ID가 일치하지 않습니다."; return; }

        battleId = b;
        spectatorName = nm;

        // UI 전환
        loginModal.classList.add("hidden");
        spectatorLayout.classList.remove("hidden");
        addLog("관전 시작!", "system");

        // 폴링 시작
        startPolling();

        // (선택) 소켓으로도 수신되는 채팅이 있으면 표시
        socket.on("chatMessage", ({sender, message})=>{
          // 관전자 클라이언트는 룸 미조인일 수 있어 안 올 수도 있음. 와도 표시.
          addChat(sender, message);
        });

        showToast("입장 완료");
      });

      function startPolling(){
        stopPolling();
        pollTimer = setInterval(async ()=>{
          const b = await loadBattle();
          if(!b.id) return;
          renderBattle(b);
        }, 1500);
      }
      function stopPolling(){
        if(pollTimer){ clearInterval(pollTimer); pollTimer = null; }
      }
      async function loadBattle(){
        const r = await fetch(`/api/battles/${encodeURIComponent(battleId)}`);
        return r.ok ? r.json() : {};
      }

      function renderBattle(b){
        // 팀 분류 (서버 키: 'phoenix'/'eaters')
        const allies = (b.players||[]).filter(p => p.team === "phoenix");
        const enemies= (b.players||[]).filter(p => p.team === "eaters");
        renderTeam(allyList, allies);
        renderTeam(enemyList, enemies);

        // 턴/아바타
        const st = b.status || "waiting";
        turnLabel.textContent = st === "live" ? "전투 진행 중" : (st === "ended" ? "전투 종료" : "전투 대기 중");
        const cur = (b.players||[]).find(p => p.id === b.turn?.current);
        activeAvatar.src = (cur?.avatar || "https://api.dicebear.com/7.x/avataaars/svg?seed=default");

        // 로그 -> 채팅/로그창 모두 반영
        renderLogs(b.log || []);
      }

      function renderTeam(container, list){
        container.innerHTML = "";
        if(!list.length){
          const empty = document.createElement("div");
          empty.className = "player-item";
          empty.style.justifyContent = "center";
          empty.textContent = "플레이어 없음";
          container.appendChild(empty);
          return;
        }
        list.forEach(p=>{
          const row = document.createElement("div");
          row.className = "player-item";
          row.innerHTML = `
            <div class="player-left">
              <img class="player-avatar" src="${esc(p.avatar||'')}" alt="">
              <div class="player-name">${esc(p.name||'-')}</div>
            </div>
            <div class="player-hp ${p.hp<=0?'status-dead':''}">${p.hp<=0?'사망':`${p.hp}/${p.maxHp||100}`}</div>
          `;
          container.appendChild(row);
        });
      }

      function renderLogs(logs){
        // 리셋 감지
        if(logs.length < lastLogCount){
          battleLog.innerHTML = "";
          chatMessages.innerHTML = "";
          lastLogCount = 0;
        }
        for(let i=lastLogCount;i<logs.length;i++){
          const line = logs[i];
          const ts = new Date(line.t||Date.now()).toLocaleTimeString();
          const txt = `[${ts}] ${line.message||''}`;
          // 전투 로그
          const le = document.createElement("div");
          le.className = "log-entry";
          le.textContent = txt;
          battleLog.appendChild(le);
          // 채팅 로그(두 종류: server chatMessage, 우리가 cheer로 보낸 메시지 모두 'chat' 타입으로 저장됨)
          if(String(line.type||"").toLowerCase() === "chat"){
            // message 예: "관리자: ...", "플레이어: ..." 혹은 우리가 보낸 "[응원] 이름: 문구"
            addChat("로그", line.message||"");
          }
        }
        lastLogCount = logs.length;
        battleLog.scrollTop = battleLog.scrollHeight;
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // 응원 버튼 -> 서버 chatMessage 재사용
      document.querySelectorAll(".cheer-btn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          if(!battleId) return;
          const msg = btn.dataset.msg;
          const payload = { role: "spectator", message: `[응원] ${spectatorName}: ${msg}`, battleId };
          socket.emit("chatMessage", payload);
          // 내 화면엔 즉시 표시
          addChat(spectatorName, msg);
        });
      });

      // UI helpers
      function addChat(author, text){
        const line = document.createElement("div");
        line.className = "chat-line";
        line.innerHTML = `<span class="chat-author">${esc(author)}:</span><span>${esc(text)}</span>`;
        chatMessages.appendChild(line);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      function addLog(text, type="system"){
        const div = document.createElement("div");
        div.className = "log-entry log-" + type;
        div.textContent = text;
        battleLog.appendChild(div);
        battleLog.scrollTop = battleLog.scrollHeight;
      }
      function esc(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
      function showToast(msg){ toastEl.textContent = msg; toastEl.classList.add("show"); setTimeout(()=>toastEl.classList.remove("show"), 1600); }
    })();
  </script>
</body>
</html>
