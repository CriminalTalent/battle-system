<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PYXIS - 전투 관전</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --gold:#d4b77e; --gold-dark:#c9a96e; --gold-bright:#e6d3aa;
      --ink:#f8f6f0; --dim:#b8a898;
      --success:#2ecc71; --danger:#e74c3c; --info:#3498db;
      --radius:12px;
    }
    body{
      font-family:'Inter',system-ui,sans-serif;
      background:
        radial-gradient(900px 700px at 50% -140px, rgba(212,183,126,.12), transparent 60%),
        linear-gradient(180deg,#000 0%,#090d14 50%,#0b111a 100%);
      color:var(--ink); min-height:100vh; display:flex; flex-direction:column;
    }
    .hidden{display:none!important}

    /* 헤더 */
    .header{padding:16px 16px 0; text-align:center}
    .brand{font-family:'Cinzel',serif;font-size:28px;
      background:linear-gradient(135deg,var(--gold),#fff,var(--gold-bright));
      -webkit-background-clip:text;color:transparent}
    .sub{font-size:12px;color:var(--dim)}

    /* 레이아웃 */
    .layout{flex:1;display:grid;grid-template-columns:320px 1fr 320px;gap:16px;padding:16px}
    @media(max-width:1100px){.layout{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,#111,#0f141b);border:1px solid rgba(212,183,126,.28);border-radius:var(--radius);padding:14px}
    .card h3{font-family:'Cinzel',serif;color:var(--gold);font-size:16px;margin-bottom:10px}

    /* 팀 리스트 */
    .list{display:flex;flex-direction:column;gap:8px}
    .unit{display:flex;align-items:center;gap:8px;background:#161616;border:1px solid rgba(212,183,126,.25);border-radius:10px;padding:8px}
    .unit img{width:40px;height:54px;object-fit:cover;border:1px solid var(--gold);border-radius:8px;background:#222}
    .nm{font-weight:700}
    .hp{font-size:12px;color:var(--success)}
    .dead .hp{color:var(--danger)}

    /* 응원 */
    .cheers{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .cheer{padding:10px;background:#141414;border:1px solid rgba(212,183,126,.45);border-radius:10px;color:var(--gold);font-weight:700;cursor:pointer}
    .cheer:hover{background:#1b1b1b}

    /* 중앙 */
    .center{display:flex;flex-direction:column;gap:14px;align-items:center}
    .turnbox{padding:10px;border:1px solid rgba(212,183,126,.4);border-radius:10px;min-width:280px;text-align:center;background:#111}
    .turn-title{font-weight:800;color:var(--gold)}
    .turn-name{margin-top:4px}
    .avatar{width:180px;height:240px;border:2px solid var(--gold);border-radius:12px;background:#222;object-fit:cover}

    /* 채팅(보기 전용) */
    .chat{display:flex;flex-direction:column;border:1px solid rgba(212,183,126,.35);border-radius:10px;overflow:hidden;background:#0f0f0f;width:100%;max-width:720px}
    .chat-messages{height:280px;overflow-y:auto;padding:10px}
    .line{margin-bottom:8px;font-size:13px}
    .author{color:var(--gold);font-weight:700;margin-right:6px}
    .sys{color:var(--dim)}
    .cheer-tag{color:var(--gold)}

    /* 로그 */
    .log{height:320px;overflow-y:auto;padding:8px;border:1px solid rgba(212,183,126,.35);border-radius:10px;background:#0f0f0f}
    .log-line{margin-bottom:6px;font-size:12px}
    .log-system{color:var(--info)}
    .log-damage{color:var(--danger)}
    .log-heal{color:var(--success)}
    .log-cheer{color:var(--gold)}

    /* 로그인 모달 */
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.78);z-index:20}
    .modal-card{background:#101317;border:1px solid rgba(212,183,126,.45);border-radius:12px;padding:18px;width:92%;max-width:440px}
    .modal-card h2{font-family:'Cinzel',serif;color:var(--gold);text-align:center;margin-bottom:10px}
    .row{display:flex;gap:8px}
    .field{width:100%;padding:10px;border:1px solid rgba(212,183,126,.35);border-radius:8px;background:#0b0b0b;color:var(--ink)}
    .btn{padding:12px;border:1px solid rgba(212,183,126,.45);border-radius:10px;background:#121212;color:var(--ink);font-weight:800;cursor:pointer}
    .btn:hover{background:#1b1b1b;color:var(--gold)}
    #authMsg{margin-top:6px;font-size:12px;color:var(--danger);min-height:16px}
  </style>
</head>
<body>
  <!-- 로그인 -->
  <div id="loginModal" class="modal">
    <div class="modal-card">
      <h2>관전자 입장</h2>
      <div class="row" style="margin-bottom:6px">
        <input id="inpBattle" class="field" placeholder="전투 ID (쿼리에 있으면 자동)">
      </div>
      <div class="row">
        <input id="inpOtp" class="field" placeholder="비밀번호">
      </div>
      <div class="row" style="margin-top:6px">
        <input id="inpName" class="field" placeholder="관전자 이름">
      </div>
      <button id="btnJoin" class="btn" style="width:100%;margin-top:8px">입장</button>
      <div id="authMsg"></div>
    </div>
  </div>

  <header class="header">
    <div class="brand">PYXIS</div>
    <div id="topInfo" class="sub">관전 대기…</div>
  </header>

  <main id="mainUI" class="layout hidden">
    <!-- 좌: 죽먹 + 응원 -->
    <section>
      <div class="card">
        <h3>죽음을 먹는 자들</h3>
        <div id="enemyList" class="list"></div>
      </div>
      <div class="card" style="margin-top:12px">
        <h3>응원</h3>
        <div class="cheers" id="cheerButtons">
          <button class="cheer" data-msg="멋지다!">멋지다!</button>
          <button class="cheer" data-msg="이겨라!">이겨라!</button>
          <button class="cheer" data-msg="살아서 돌아와!">살아서 돌아와!</button>
          <button class="cheer" data-msg="화이팅!">화이팅!</button>
          <button class="cheer" data-msg="죽으면 나한테 죽어!">죽으면 나한테 죽어!</button>
          <button class="cheer" data-msg="힘내요!">힘내요!</button>
        </div>
      </div>
    </section>

    <!-- 가운데: 현재 턴 / 아바타 / 채팅(보기) -->
    <section class="center">
      <div class="turnbox">
        <div class="turn-title">현재 턴</div>
        <div id="turnName" class="turn-name">대기 중…</div>
      </div>
      <img id="activeAvatar" class="avatar" alt="현재 전투자" src="https://api.dicebear.com/7.x/adventurer/svg?seed=battle">
      <div class="chat">
        <div id="chatMessages" class="chat-messages"></div>
      </div>
    </section>

    <!-- 우: 불사조 + 전투 로그 -->
    <section>
      <div class="card">
        <h3>불사조 기사단</h3>
        <div id="allyList" class="list"></div>
      </div>
      <div class="card" style="margin-top:12px">
        <h3>전투 로그</h3>
        <div id="battleLog" class="log"></div>
      </div>
    </section>
  </main>

  <script src="/socket.io/socket.io.js"></script>
  <script>
  (function(){
    const socket = io();
    // 상태
    let battleId = new URLSearchParams(location.search).get("battle") || "";
    let spectatorName = "";
    const roster = new Map(); // id -> player

    // DOM helper
    const $ = (s)=>document.querySelector(s);

    // 프리필
    $("#inpBattle").value = battleId;

    // 입장
    $("#btnJoin").addEventListener("click", ()=>{
      const bid = ($("#inpBattle").value || "").trim() || battleId;
      const otp = ($("#inpOtp").value || "").trim();
      const name = ($("#inpName").value || "").trim();
      if(!bid || !otp || !name){ $("#authMsg").textContent = "전투ID / 비밀번호 / 이름을 모두 입력해 주세요."; return; }
      battleId = bid; spectatorName = name;
      socket.emit("spectator:join", { battleId, otp, name: spectatorName });
    });

    socket.on("spectator:join_ok", (payload={})=>{
      $("#loginModal").classList.add("hidden");
      $("#mainUI").classList.remove("hidden");
      $("#topInfo").textContent = `관전 중: ${battleId} — ${spectatorName}`;
      addLog("관전 시작!", "log-system");

      // 스냅샷 옵션 반영
      if(payload.battle){
        renderFromBattle(payload.battle);
      }
    });

    socket.on("auth:fail", (d)=>{ $("#authMsg").textContent = d?.reason || "인증 실패"; });

    // ===== 서버 브로드캐스트 수신 =====
    socket.on("battleUpdate", (b)=>{ renderFromBattle(b); });

    // 채팅(서버가 어떤 채널로 쏘든 대응)
    socket.on("battle:chat", ({name,msg})=> addChat(name, msg));
    socket.on("chat:msg",     ({name,msg})=> addChat(name, msg));

    // 로그(서버가 어떤 채널로 쏘든 대응)
    socket.on("battle:log", ({ msg, type })=> addLog(msg, mapLogType(type)));
    socket.on("log:add",    ({ msg, type })=> addLog(msg, mapLogType(type)));

    // 응원 버튼
    $("#cheerButtons").addEventListener("click", (e)=>{
      const btn = e.target.closest(".cheer");
      if(!btn) return;
      const text = btn.dataset.msg || btn.textContent || "";
      if(!text) return;
      socket.emit("spectator:cheer", { battleId, name: spectatorName, msg: text });
      // 관전자 화면에도 즉시 반영(낙관적 업데이트)
      addChat(spectatorName, `[응원] ${text}`, true);
      addLog(`${spectatorName} 응원: ${text}`, "log-cheer");
    });

    /* ===== 렌더링 ===== */
    function renderFromBattle(b){
      if(!b) return;

      // 로스터 동기
      roster.clear();
      (b.players||[]).forEach(p => roster.set(p.id, p));

      // 팀 고정 배치: 좌=죽먹, 우=불사조
      const eaters = (b.players||[]).filter(p => normTeam(p.team)==="eaters");
      const phoenix= (b.players||[]).filter(p => normTeam(p.team)==="phoenix");
      renderList("#enemyList", eaters);
      renderList("#allyList", phoenix);

      // 현재 턴 이름/아바타
      const turnId = b?.turn?.current;
      if(turnId && roster.has(turnId)){
        const cur = roster.get(turnId);
        $("#turnName").textContent = cur.name || "-";
        if(cur.avatar) $("#activeAvatar").src = cur.avatar;
      } else {
        $("#turnName").textContent = (b.status==="live") ? "대기 중…" : "전투 대기";
      }

      // 로그가 동기되어 온다면(선택)
      if (Array.isArray(b.log)) {
        $("#battleLog").innerHTML = "";
        b.log.slice(-300).forEach(line=>{
          addLog(line.message || String(line||""), mapLogType(line.type), true);
        });
      }
    }

    function renderList(sel, arr){
      const box = $(sel); box.innerHTML = "";
      if(!arr.length){ box.innerHTML = `<div class="line sys">없음</div>`; return; }
      arr.forEach(p=>{
        const d = document.createElement("div");
        d.className = "unit" + ((p.status==="dead" || p.hp<=0) ? " dead" : "");
        d.innerHTML = `
          <img src="${p.avatar || "https://api.dicebear.com/7.x/adventurer/svg?seed=pyxis"}" alt="">
          <div style="flex:1">
            <div class="nm">${esc(p.name||"-")}</div>
            <div class="hp">${Math.max(0, p.hp ?? 0)}/${Math.max(1, p.maxHp ?? 100)} HP</div>
          </div>`;
        box.appendChild(d);
      });
    }

    /* ===== UI 유틸 ===== */
    function addChat(author, text, local=false){
      const box = $("#chatMessages");
      const line = document.createElement("div");
      line.className = "line";
      // 응원 문구면 태그 붙여 강조
      const isCheer = /^\[응원\]/.test(text);
      line.innerHTML = `<span class="author">${esc(author)}:</span><span class="${isCheer?'cheer-tag':''}">${esc(text)}</span>`;
      box.appendChild(line);
      box.scrollTop = box.scrollHeight;
    }

    function addLog(text, cls="log-system", skipScroll=false){
      const box = $("#battleLog");
      const ln = document.createElement("div");
      ln.className = `log-line ${cls}`;
      ln.textContent = text;
      box.appendChild(ln);
      if(!skipScroll) box.scrollTop = box.scrollHeight;
    }

    function mapLogType(t){
      if(!t) return "log-system";
      if(t==="action"||t==="damage") return "log-damage";
      if(t==="heal") return "log-heal";
      if(t==="cheer") return "log-cheer";
      return "log-system";
    }

    function normTeam(t){
      const s = String(t||"").toLowerCase();
      if(["a","phoenix","team1"].includes(s)) return "phoenix";
      return "eaters";
    }
    function esc(s){ return String(s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])); }
  })();
  </script>
</body>
</html>
