<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>PYXIS 관전자</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=Cinzel:wght@700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Core theme (네이비-골드, 변경 금지) */
      --bg:#0b1117; --panel:#121a23; --panel-2:#0f1620; --fg:#e9e4d7;
      --muted:#cdbfa5; --brand:#dcc7a2; --line:rgba(220,199,162,.22);
      --accent:#2f81f7; --danger:#c73e1d; --ok:#2d5a27;
      --gold:#d4ba8d; --gold-2:#c9a97a; --gold-3:#b89662;
      --radius:14px; --radius-sm:10px; --shadow:0 10px 28px rgba(0,0,0,.35);
    }
    html,body{background:var(--bg);color:var(--fg);margin:0;height:100%}
    body{font-family:Inter,ui-sans-serif,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Helvetica,Arial}
    h1,h2,h3{font-family:'Playfair Display',serif;margin:0}
    .wrap{max-width:1400px;margin:0 auto;padding:20px;display:flex;flex-direction:column;gap:16px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      background:linear-gradient(180deg,rgba(212,186,141,.1),transparent);
      border:1px solid var(--line); border-radius:var(--radius); padding:12px 14px;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .brand .mark{
      width:28px;height:28px;border-radius:50%;
      background:conic-gradient(from 0deg,var(--gold),var(--gold-2),var(--gold-3),var(--gold));
      box-shadow:0 0 0 1px rgba(255,255,255,.06) inset, 0 0 18px rgba(212,186,141,.25);
    }
    .brand h1{font-size:20px;letter-spacing:.5px}
    .who{font-size:14px;color:var(--muted)}
    .who strong{color:var(--fg);font-weight:600}

    /* 3-column board */
    .board{display:grid;grid-template-columns: 1.2fr 1fr 1fr; gap:16px; min-height:72vh}
    .col{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);display:flex;flex-direction:column;min-height:0}
    .col-header{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;background:linear-gradient(180deg,rgba(212,186,141,.06),transparent)}
    .col-header h2{font-size:16px}
    .tag{font-size:12px;color:#0e1014;background:linear-gradient(180deg,var(--gold),var(--gold-2));
      padding:4px 8px;border-radius:999px;border:1px solid rgba(0,0,0,.25)}
    .section{padding:12px 14px;display:flex;flex-direction:column;gap:10px}

    /* Team panels */
    .teams{display:grid;grid-template-columns:1fr;gap:12px}
    .team-card{background:var(--panel-2);border:1px solid var(--line);border-radius:var(--radius-sm);padding:10px}
    .team-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .team-name{font-family:'Cinzel',serif;font-size:15px;letter-spacing:.3px}
    .roster{display:flex;flex-direction:column;gap:8px;max-height:38vh;overflow:auto}
    .p{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
    .p-name{font-weight:600}
    .p-meta{font-size:12px;color:var(--muted)}
    .hpbar{height:8px;background:#2a3340;border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.06)}
    .hpbar > i{display:block;height:100%;background:linear-gradient(90deg,#2d5a27,#3e7a39);width:100%}
    .statline{display:flex;gap:10px;font-size:12px;color:var(--muted)}
    .statline b{color:var(--fg);font-weight:600}

    /* Log (center) */
    .log{flex:1;overflow:auto;padding:12px 14px;display:flex;flex-direction:column;gap:10px}
    .log-line{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px;color:var(--fg);background:#0e1520;border:1px solid var(--line);border-radius:10px;padding:8px 10px}
    .log-muted{color:var(--muted)}

    /* Chat (right) - read only */
    .chat{display:flex;flex-direction:column;min-height:0}
    .chat-feed{flex:1;padding:12px 14px;overflow:auto;display:flex;flex-direction:column;gap:10px}
    .msg{background:#0e1520;border:1px solid var(--line);border-radius:10px;padding:8px 10px}
    .msg .meta{font-size:12px;color:var(--muted);margin-bottom:4px}
    .msg .body{font-size:14px;color:var(--fg)}
    .chat-note{padding:10px 12px;border-top:1px dashed var(--line);font-size:12px;color:var(--muted);background:rgba(212,186,141,.04)}

    /* Cheer actions bottom-left */
    .cheer{margin-top:auto;border-top:1px dashed var(--line);padding:10px 12px;background:rgba(212,186,141,.04);display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .btn{
      appearance:none;border:1px solid var(--line);background:linear-gradient(180deg,#1a222e,#131b25);
      color:var(--fg);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:600
    }
    .btn:hover{border-color:var(--gold)}
    .btn:active{transform:translateY(1px)}
    .btn-ghost{background:transparent}
    .helper{font-size:12px;color:var(--muted);padding:8px 12px}

    /* Login modal */
    .modal{
      position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(4px)
    }
    .card{width:min(520px,92vw);background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .card-head{padding:14px 16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,rgba(212,186,141,.08),transparent)}
    .card-body{padding:16px;display:flex;flex-direction:column;gap:12px}
    .row{display:grid;grid-template-columns:120px 1fr;gap:10px;align-items:center}
    .inp{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background:#0f1620;color:var(--fg);outline:none
    }
    .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:6px}
    .hidden{display:none}
    .copyable{cursor:pointer}
    .copyable:hover{color:var(--gold)}
    @media (max-width:1120px){
      .board{grid-template-columns:1fr;min-height:auto}
      .cheer{position:static}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="mark" aria-hidden="true"></div>
        <h1>PYXIS 관전석</h1>
      </div>
      <div class="who">관전자: <strong id="viewerName">-</strong> · 전투 ID: <span id="battleId" class="copyable" title="클릭하여 복사">-</span></div>
    </div>

    <div class="board">
      <!-- LEFT: Teams + Cheer -->
      <div class="col">
        <div class="col-header">
          <h2>A팀 – 불사조 기사단</h2>
          <span class="tag">Team A</span>
        </div>
        <div class="section teams" id="teamA">
          <!-- team A roster renders here -->
        </div>
        <div class="cheer">
          <button class="btn" data-cheer="멋지다!">멋지다!</button>
          <button class="btn" data-cheer="이겨라!">이겨라!</button>
          <button class="btn" data-cheer="살아서 돌아와!">살아서 돌아와!</button>
          <button class="btn" data-cheer="화이팅!">화이팅!</button>
          <button class="btn" data-cheer="죽으면 나한테 죽어!">죽으면 나한테 죽어!</button>
          <button class="btn" data-cheer="힘내요!">힘내요!</button>
        </div>
        <div class="helper">응원 메시지는 모든 참가자/관전자에게 실시간 표시됩니다.</div>
      </div>

      <!-- CENTER: Battle Log -->
      <div class="col">
        <div class="col-header">
          <h2>전투 로그</h2>
          <span class="tag">Live</span>
        </div>
        <div class="log" id="logFeed">
          <div class="log-line log-muted">전투 로그가 여기에 표시됩니다.</div>
        </div>
      </div>

      <!-- RIGHT: Chat (read only) + Team B -->
      <div class="col chat">
        <div class="col-header">
          <h2>B팀 – 죽음을 먹는 자들</h2>
          <span class="tag">Team B</span>
        </div>
        <div class="section teams" id="teamB" style="border-bottom:1px dashed var(--line);padding-bottom:6px;margin-bottom:6px">
          <!-- team B roster renders here -->
        </div>

        <div class="col-header" style="border-top:1px dashed var(--line);border-bottom:1px solid var(--line)">
          <h2>채팅</h2>
          <span class="tag">읽기 전용</span>
        </div>
        <div class="chat-feed" id="chatFeed">
          <div class="msg">
            <div class="meta">안내</div>
            <div class="body">관전자는 채팅 입력이 제한됩니다. 응원 버튼을 이용해 주세요.</div>
          </div>
        </div>
        <div class="chat-note">관리자/플레이어의 채팅이 실시간 표시됩니다.</div>
      </div>
    </div>
  </div>

  <!-- Login modal -->
  <div class="modal" id="loginModal">
    <div class="card">
      <div class="card-head"><h2>관전자 입장</h2></div>
      <div class="card-body">
        <div class="row">
          <label for="name">관전자 이름</label>
          <input id="name" class="inp" placeholder="예: 카시엘">
        </div>
        <div class="row">
          <label for="otp">관전자 OTP</label>
          <input id="otp" class="inp" placeholder="관리자에게 받은 OTP">
        </div>
        <div class="row">
          <label for="battle">전투 ID</label>
          <input id="battle" class="inp" placeholder="관리자 화면의 전투 ID">
        </div>
        <div class="actions">
          <button id="enterBtn" class="btn">입장</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // --- State ---
    let socket = null;
    let SPECTATOR_NAME = '';
    let BATTLE_ID = '';
    let OTP = '';

    // Helpers
    const $ = sel => document.querySelector(sel);
    const el = (tag, cls) => { const n = document.createElement(tag); if(cls) n.className = cls; return n; }
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
    const copy = (text) => navigator.clipboard?.writeText(text).catch(()=>{});

    // Copy battle id on click
    $('#battleId').addEventListener('click', () => {
      const text = $('#battleId').textContent.trim();
      if (text && text !== '-') copy(text);
    });

    // Renderers
    function renderTeams(state){
      // expected shape: { teams: { A:{name:'불사조 기사단', players:[{name,hp,maxHp,stats:{공,방,민,운}}]}, B:{...} } }
      const A = state?.teams?.A || { name:'불사조 기사단', players:[] };
      const B = state?.teams?.B || { name:'죽음을 먹는 자들', players:[] };

      // Update headers (safety)
      document.querySelectorAll('.col-header h2')[0].textContent = `A팀 – ${A.name || '불사조 기사단'}`;
      document.querySelectorAll('.col-header h2')[2].textContent = `B팀 – ${B.name || '죽음을 먹는 자들'}`;

      const teamA = $('#teamA'); teamA.innerHTML = '';
      const teamB = $('#teamB'); teamB.innerHTML = '';

      function playerCard(p){
        const card = el('div','team-card');
        const head = el('div','team-head');
        const nm = el('div','team-name'); nm.textContent = p.name || '이름없음';
        const meta = el('div','p-meta'); meta.textContent = `HP ${clamp(p.hp ?? 100,0,p.maxHp ?? 100)}/${p.maxHp ?? 100}`;
        head.append(nm, meta);

        const rosterLine = el('div','p');
        const pname = el('div','p-name'); pname.textContent = p.name || '플레이어';
        const hpbar = el('div','hpbar'); const fill = el('i');
        const maxHp = p.maxHp ?? 100; const hp = clamp(p.hp ?? maxHp, 0, maxHp);
        fill.style.width = `${(hp/maxHp)*100}%`;
        hpbar.append(fill);
        rosterLine.append(pname, hpbar);

        const st = el('div','statline');
        const s = p.stats||{};
        st.innerHTML = `<span>공 <b>${s.공격 ?? s.공 ?? '-'}</b></span>
                        <span>방 <b>${s.방어 ?? s.방 ?? '-'}</b></span>
                        <span>민 <b>${s.민첩 ?? s.민 ?? '-'}</b></span>
                        <span>운 <b>${s.행운 ?? s.운 ?? '-'}</b></span>`;

        card.append(head, rosterLine, st);
        return card;
      }

      (A.players||[]).forEach(p=> teamA.append(playerCard(p)));
      (B.players||[]).forEach(p=> teamB.append(playerCard(p)));
    }

    function addLog(line, muted=false){
      const row = el('div','log-line' + (muted?' log-muted':''));
      row.textContent = line;
      const feed = $('#logFeed');
      const atBottom = Math.abs(feed.scrollHeight - feed.scrollTop - feed.clientHeight) < 12;
      feed.append(row);
      if(atBottom) feed.scrollTop = feed.scrollHeight;
    }

    function addChat({name, role, message, ts}){
      const msg = el('div','msg');
      const meta = el('div','meta');
      meta.textContent = `${role || '알림'} · ${name || '-'}`;
      const body = el('div','body');
      body.textContent = message || '';
      msg.append(meta, body);
      const feed = $('#chatFeed');
      const atBottom = Math.abs(feed.scrollHeight - feed.scrollTop - feed.clientHeight) < 12;
      feed.append(msg);
      if(atBottom) feed.scrollTop = feed.scrollHeight;
    }

    // Socket wiring
    function connect(){
      socket = io({ transports:['websocket'], upgrade:false });

      socket.on('connect', () => {
        // spectator auth
        socket.emit('spectatorAuth', { battleId:BATTLE_ID, token:OTP, name:SPECTATOR_NAME });
      });

      socket.on('authSuccess', (payload) => {
        // Update topbar
        $('#viewerName').textContent = SPECTATOR_NAME;
        $('#battleId').textContent = BATTLE_ID;
        // Hide modal
        $('#loginModal').classList.add('hidden');
        addLog('관전자 인증 성공. 전투 상황을 불러오는 중…', true);
      });

      socket.on('authError', (err) => {
        addLog(`인증 실패: ${err?.message || '잘못된 OTP 또는 전투 ID'}`, true);
        alert('인증에 실패했습니다. 정보를 확인해 주세요.');
      });

      // Live updates
      socket.on('battleUpdate', (state) => {
        renderTeams(state);
        if (state?.lastEvent) addLog(state.lastEvent);
      });

      // Chat feed (read-only)
      socket.on('chatMessage', (msg) => {
        // expected: { name, role, message, ts }
        addChat(msg);
      });

      // Cheer notifications may also be broadcast
      socket.on('cheerMessage', (msg) => {
        // Show in log
        const n = msg?.name || '관전자';
        const m = msg?.message || '';
        addLog(`[응원] ${n}: ${m}`);
      });

      // Generic notices
      socket.on('connect_error', () => addLog('서버와 연결할 수 없습니다.', true));
      socket.on('disconnect', () => addLog('연결이 종료되었습니다.', true));
    }

    // Login
    $('#enterBtn').addEventListener('click', () => {
      const name = $('#name').value.trim();
      const otp = $('#otp').value.trim();
      const battle = $('#battle').value.trim();
      if(!name || !otp || !battle){
        alert('이름, OTP, 전투 ID를 모두 입력해 주세요.');
        return;
      }
      SPECTATOR_NAME = name;
      OTP = otp;
      BATTLE_ID = battle;
      connect();
    });

    // Enter key on inputs
    ['#name','#otp','#battle'].forEach(id=>{
      $(id).addEventListener('keydown', e=>{
        if(e.key === 'Enter') $('#enterBtn').click();
      });
    });

    // Cheer buttons
    document.querySelectorAll('.cheer .btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const msg = btn.getAttribute('data-cheer');
        if(!socket || !socket.connected){
          addLog('연결되지 않았습니다. 잠시 후 다시 시도하세요.', true);
          return;
        }
        socket.emit('cheerMessage', { battleId:BATTLE_ID, name:SPECTATOR_NAME, message:msg });
        addLog(`[응원 전송] ${SPECTATOR_NAME}: ${msg}`, true);
      });
    });

    // URL params autofill (optional convenience)
    (function bootFromQuery(){
      const q = new URLSearchParams(location.search);
      const b = q.get('battle'); const t = q.get('token'); const n = q.get('name');
      if(b) $('#battle').value = b;
      if(t) $('#otp').value = t;
      if(n) $('#name').value = n;
    })();
  </script>
</body>
</html>
