<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PYXIS - 전투 관전</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;800&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg:#0a0d12; --panel:#11161d; --panel-2:#0f141b;
      --text:#f8f6f0; --dim:#cfc6b4; --muted:#97a0ad;
      --gold:#d4b77e; --gold-2:#e6d3aa;
      --danger:#e74c3c; --success:#27ae60; --info:#3498db;
      --radius:12px; --r-sm:8px;
      --border:2px solid rgba(212,183,126,.55);
      --border-sub:1px solid rgba(212,183,126,.25);
    }
    body{background:radial-gradient(1200px 900px at 50% -220px, rgba(212,183,126,.10), transparent 60%),linear-gradient(180deg,#000,#0a0a0a 30%,#121212 60%,#1a1a1a 100%); color:var(--text); font-family:Inter, system-ui, "Noto Sans KR", sans-serif}

    .container{max-width:1200px; margin:0 auto; padding:20px}
    .header{padding:18px 16px; border-bottom:var(--border-sub); display:flex; align-items:end; gap:10px}
    .brand{font-family:Cinzel,serif; letter-spacing:.12em; font-size:22px; background:linear-gradient(90deg,#DCC7A2,#D4BA8D); -webkit-background-clip:text; background-clip:text; color:transparent; position:relative; padding-right:36px}
    .brand::before{content:"✦"; position:absolute; right:14px; top:-4px; font-size:18px; color:#DCC7A2; text-shadow:0 0 10px rgba(220,199,162,.45); animation:twinkle 2.2s ease-in-out infinite}
    .brand::after{content:"✧"; position:absolute; right:-2px; top:10px; font-size:14px; color:#D4BA8D; text-shadow:0 0 10px rgba(220,199,162,.38); animation:twinkle 2.2s ease-in-out 1.1s infinite}
    .sub{color:var(--muted); letter-spacing:.18em; font-size:12px; transform:translateY(2px)}
    @keyframes twinkle{0%,100%{opacity:.35; transform:scale(.85)} 50%{opacity:1; transform:scale(1.2)}}

    .grid{display:grid; gap:20px; grid-template-columns:1fr 1fr}
    @media(max-width:1080px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg, rgba(18,18,18,.45), rgba(26,26,26,.60)); border:var(--border-sub); border-top-color:rgba(220,199,162,.35); border-radius:12px; padding:16px}
    .player-list{display:grid; gap:8px}
    .player{display:grid; grid-template-columns:48px 1fr auto; gap:10px; align-items:center; background:#111923; border:var(--border-sub); border-radius:10px; padding:8px}
    .avatar{width:48px; height:48px; border-radius:8px; object-fit:cover; border:1px solid rgba(220,199,162,.36); background:rgba(0,0,0,.2)}
    .p-name{font-weight:800}
    .p-meta{font-size:12px; color:var(--muted)}
    .turnbox{display:flex; align-items:center; gap:8px}
    .turn-flag{font-size:12px; color:var(--muted)}
    .log{height:300px; overflow-y:auto; border:var(--border); border-radius:12px; padding:10px; background:#0f151c}
    .log-entry{font-size:12px; margin-bottom:6px}
    .log-system{color:var(--info)}
    .log-action{color:#ffd27a}
    .log-damage{color:var(--danger)}
    .log-heal{color:var(--success)}
    .log-cheer{color:var(--gold)}

    /* 로그인 모달 */
    .modal{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.55); z-index:20}
    .auth-box{width:min(420px,92vw); background:linear-gradient(180deg, rgba(18,18,18,.45), rgba(26,26,26,.60)); border:var(--border); border-radius:12px; padding:18px; box-shadow:0 10px 24px rgba(0,0,0,.35)}
    .auth-box h2{font-family:Cinzel,serif; letter-spacing:.06em; margin-bottom:12px; color:var(--gold)}
    .fg{margin-bottom:10px}
    .fg label{display:block; font-size:12px; color:var(--dim); margin-bottom:6px}
    .inp{width:100%; padding:10px 12px; border-radius:10px; border:var(--border-sub); background:#0f141b; color:var(--text); outline:none}
    .inp::placeholder{color:rgba(238,230,214,.55)}
    .inp:focus{border-color:var(--gold); box-shadow:0 0 0 3px rgba(212,183,126,.18)}
    .auth-btn{width:100%; background:linear-gradient(135deg, rgba(18,18,18,.55), rgba(26,26,26,.75)) padding-box, linear-gradient(135deg, var(--gold), var(--gold-2)) border-box; color:var(--gold); border:1px solid rgba(220,199,162,.36); border-radius:10px; padding:10px 14px; font-weight:900; cursor:pointer}
    .auth-msg{color:var(--danger); font-size:12px; margin-top:6px; min-height:16px}
    .hidden{display:none!important}
  </style>
</head>
<body>
  <!-- 로그인 모달 -->
  <div id="loginModal" class="modal">
    <div class="auth-box">
      <h2>관전자 입장</h2>
      <div class="fg">
        <label for="otp">OTP</label>
        <input id="otp" class="inp" placeholder="관리자에게 받은 비밀번호" />
      </div>
      <div class="fg">
        <label for="sname">표시 이름</label>
        <input id="sname" class="inp" placeholder="표시 이름" />
      </div>
      <button id="btnJoin" class="auth-btn" type="button">입장하기</button>
      <div id="authMsg" class="auth-msg"></div>
    </div>
  </div>

  <div class="container" id="mainUI" class="hidden" style="display:none;">
    <header class="header">
      <div class="brand">PYXIS</div>
      <div class="sub">BATTLE SPECTATOR</div>
    </header>

    <main class="grid">
      <!-- LEFT: 죽음을 먹는 자들 + 채팅 -->
      <section>
        <div class="card">
          <h3>죽음을 먹는 자들</h3>
          <div id="deathList" class="player-list"></div>
        </div>
        <div class="card" style="margin-top:12px">
          <h3>관전자 채팅</h3>
          <div id="chatMessages" class="log"></div>
          <div class="chat-note">관전자는 채팅 입력이 불가합니다. 아래 응원 버튼으로 응원을 보내면 채팅창에 이름과 함께 표시됩니다.</div>
          <div id="cheerBox" style="display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:8px"></div>
        </div>
      </section>

      <!-- RIGHT: 불사조 + 전투 로그 -->
      <section>
        <div class="card">
          <h3>불사조 기사단</h3>
          <div id="phoenixList" class="player-list"></div>
        </div>
        <div class="card" style="margin-top:12px">
          <h3>전투 로그</h3>
          <div id="battleLog" class="log"></div>
        </div>
        <div class="card" style="margin-top:12px">
          <h3>현재 턴</h3>
          <div class="turnbox">
            <img id="activeAvatar" class="avatar" alt="active">
            <div>
              <div id="turnFlag" class="turn-flag">대기 중</div>
              <div id="turnName" class="p-name">-</div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
  (function(){
    "use strict";

    const qs = new URLSearchParams(location.search);
    const battleId = qs.get("battle") || "";

    let socket = null;
    let spectatorName = "";
    let players = [];
    let turnPlayerId = null;
    let pendingJoin = null; // { otp, name }

    function $(s){ return document.querySelector(s); }
    function text(el,v){ if(el) el.textContent = String(v==null?"":v); }

    document.addEventListener("DOMContentLoaded", init);

    function init(){
      const loginModal = $("#loginModal");
      const otpEl      = $("#otp");
      const nameEl     = $("#sname");
      const btnJoin    = $("#btnJoin");
      const authMsg    = $("#authMsg");
      const mainUI     = $("#mainUI");

      const deathList    = $("#deathList");
      const phoenixList  = $("#phoenixList");
      const activeAvatar = $("#activeAvatar");
      const turnFlag     = $("#turnFlag");
      const turnName     = $("#turnName");
      const chatMessages = $("#chatMessages");
      const battleLog    = $("#battleLog");
      const cheerBox     = $("#cheerBox");

      // 버튼/Enter
      if(btnJoin){
        btnJoin.addEventListener("click", tryJoin);
      }
      [otpEl, nameEl].forEach(inp=>{
        if(!inp) return;
        inp.addEventListener("keydown",(e)=>{ if(e.key==="Enter") tryJoin(); });
      });

      // 소켓 준비
      ensureSocket().then(connect).catch(()=>{
        text(authMsg, "소켓 연결에 실패했습니다. 잠시 후 다시 시도하세요.");
      });

      // 고정 응원 버튼 생성 (요청하신 6개 고정)
      buildCheerButtons();

      function tryJoin(){
        const otp = (otpEl?.value||"").trim();
        spectatorName = (nameEl?.value||"").trim();
        if(!battleId || !otp || !spectatorName){
          text(authMsg, "battle ID/비밀번호/이름을 모두 입력하세요.");
          return;
        }
        if(!socket || !socket.connected){
          pendingJoin = { otp, name:spectatorName };
          text(authMsg, "연결 중입니다…");
          return;
        }
        socket.emit("spectator:join", { battleId, otp, name: spectatorName });
      }

      function connect(){
        if(socket) socket.disconnect();
        socket = io();

        socket.on("connect", ()=>{
          if(pendingJoin){
            const {otp, name} = pendingJoin;
            pendingJoin = null;
            spectatorName = name;
            socket.emit("spectator:join", { battleId, otp, name });
          }
        });

        // 입장 결과
        socket.on("spectator:join_ok", ({ roster, battle, currentPlayerName })=>{
          players = roster || [];
          renderRoster();
          setTurn(battle?.turn?.current, battle?.turn?.currentName || currentPlayerName);
          if(loginModal) loginModal.classList.add("hidden");
          if(mainUI)     mainUI.style.display = "";
          addLog("관전 시작!", "system");
          text(authMsg, "");
        });

        socket.on("spectator:join_fail", (d)=>{
          text(authMsg, d?.reason || "인증 실패");
        });

        // 실시간 업데이트
        socket.on("battle:update", (battle)=>{
          players = battle?.players || players;
          renderRoster();
        });
        socket.on("turn:update", ({ playerId, playerName })=>{
          setTurn(playerId, playerName);
        });

        // 로그/채팅
        socket.on("log:add", ({ type="action", msg })=>{
          addLog(msg, type);
        });
        socket.on("chat:msg", ({ name, msg })=>{
          addChat(name, msg);
        });

        // 응원(채팅으로만 표시)
        socket.on("spectator:cheer", ({ from, msg })=>{
          addChat(from || "관전자", msg || "응원!");
        });
      }

      // ===== 렌더링 =====
      function renderRoster(){
        const a = players.filter(p=>p.team==="eaters");
        const b = players.filter(p=>p.team==="phoenix");

        paintList(deathList, a);
        paintList(phoenixList, b);
      }
      function paintList(root, arr){
        if(!root){return;}
        root.innerHTML = "";
        if(!arr.length){
          const d=document.createElement("div"); d.className="p-meta"; d.textContent="플레이어 없음"; root.appendChild(d); return;
        }
        arr.forEach(p=>{
          const row = document.createElement("div"); row.className="player";
          const img = document.createElement("img"); img.className="avatar"; img.src=p.avatar||"https://api.dicebear.com/7.x/adventurer/svg?seed=default";
          const meta= document.createElement("div");
          const nm  = document.createElement("div"); nm.className="p-name"; nm.textContent=p.name||"-";
          const sb  = document.createElement("div"); sb.className="p-meta"; sb.textContent=`HP ${p.hp ?? 100}/${p.maxHp ?? 100}  ATK ${p.stats?.atk ?? "-"} DEF ${p.stats?.def ?? "-"} AGI ${p.stats?.agi ?? "-"} LUK ${p.stats?.luk ?? "-"}`;
          meta.appendChild(nm); meta.appendChild(sb);
          const side= document.createElement("div"); side.className="p-meta"; side.textContent=(p.team==="phoenix"?"A":"B");
          row.appendChild(img); row.appendChild(meta); row.appendChild(side);
          root.appendChild(row);
        });
      }
      function setTurn(playerId, playerName){
        turnPlayerId = playerId || null;
        text(turnFlag, turnPlayerId ? "현재 턴" : "대기 중");
        text(turnName, playerName || nameById(turnPlayerId) || "-");
        const cur = players.find(p=>p.id === turnPlayerId);
        if(activeAvatar) activeAvatar.src = cur?.avatar || "https://api.dicebear.com/7.x/adventurer/svg?seed=default";
      }

      // ===== 응원 =====
      // 요청하신 문구 6개를 고정 배열로 사용 (순서 그대로)
      const FIXED_CHEERS = ["응원 메시지는 멋지다!", "이겨라!", "살아서 돌아와!", "화이팅!", "죽으면 나한테 죽어!", "힘내요!"];
      function buildCheerButtons(){
        if(!cheerBox) return;
        cheerBox.innerHTML = "";
        FIXED_CHEERS.forEach(msg=>{
          const b = document.createElement("button");
          b.type="button";
          b.className="auth-btn";
          b.style.padding="8px 10px";
          b.textContent = msg;
          b.addEventListener("click", ()=> {
            if(!socket || !socket.connected || !spectatorName) return;
            socket.emit("spectator:cheer", { battleId, msg, from: spectatorName });
          });
          cheerBox.appendChild(b);
        });
      }

      // ===== UI helpers =====
      function addChat(author, text){
        const div = document.createElement("div");
        div.innerHTML = `<span style="color:var(--gold);font-weight:800;margin-right:6px">${escapeHtml(author)}:</span>${escapeHtml(text)}`;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      function addLog(text, type="action"){
        const div = document.createElement("div");
        div.className = `log-entry log-${type}`;
        div.textContent = text;
        battleLog.appendChild(div);
        battleLog.scrollTop = battleLog.scrollHeight;
      }
      function nameById(id){
        return players.find(p=>p.id===id)?.name || null;
      }
    }

    // 소켓 로더
    function ensureSocket(){
      return new Promise((res, rej)=>{
        if(window.io) return res();
        const s = document.createElement("script");
        s.src = "/socket.io/socket.io.js";
        s.onload=()=>res();
        s.onerror=()=>{
          const c=document.createElement("script");
          c.src="https://cdn.socket.io/4.7.5/socket.io.min.js";
          c.onload=()=>res();
          c.onerror=()=>rej(new Error("socket.io load failed"));
          document.head.appendChild(c);
        };
        document.head.appendChild(s);
      });
    }
    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    }
  })();
  </script>
</body>
</html>
