<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PYXIS - 전투 관전</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg:#0a0d12; --panel:#11161d; --panel-2:#0f141b;
      --text:#f8f6f0; --dim:#cfc6b4; --muted:#97a0ad;
      --gold:#d4b77e; --gold-2:#e6d3aa;
      --danger:#e74c3c; --success:#27ae60; --info:#3498db;
      --radius:12px; --r-sm:8px;
      --border:2px solid rgba(212,183,126,.55);
      --border-sub:1px solid rgba(212,183,126,.28);
      --shadow:0 10px 28px rgba(0,0,0,.35);
      --fast:.18s cubic-bezier(.4,0,.2,1);
    }
    body{
      background:
        radial-gradient(900px 600px at 50% -120px, rgba(212,183,126,.10), transparent 60%),
        linear-gradient(180deg, #05080d 0%, #070b12 50%, #080c13 100%);
      color:var(--text); font-family:Inter, system-ui, -apple-system, sans-serif; min-height:100vh;
    }
    .container{max-width:1600px;margin:0 auto;padding:16px}
    .header{text-align:center;margin-bottom:10px}
    .brand{font-family:'Cinzel',serif;font-size:32px;letter-spacing:.08em;
      background:linear-gradient(135deg,var(--gold),#fff,var(--gold-2));-webkit-background-clip:text;color:transparent}
    .sub{color:var(--muted);font-size:12px;letter-spacing:.18em;margin-top:4px}

    /* 3단 레이아웃: 좌(죽먹) / 중앙 / 우(불사조) */
    .layout{display:grid;grid-template-columns:340px 1fr 340px;gap:16px}
    @media(max-width:1200px){.layout{grid-template-columns:1fr}}

    .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:var(--border);
      border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
    .card h3{color:var(--gold);font-family:'Cinzel',serif;font-size:16px;margin-bottom:10px}

    /* 3:4 아바타 */
    .avatar-rect{aspect-ratio:3/4;width:100%;background:#1b222c;border:var(--border);border-radius:10px;object-fit:cover}
    .avatar-rect.sm{width:48px;height:64px}
    .avatar-rect.lg{width:180px;height:240px}

    /* 팀 리스트 */
    .player-list{display:flex;flex-direction:column;gap:8px}
    .player-item{display:flex;gap:8px;align-items:center;background:#141b23;border:var(--border-sub);
      border-radius:10px;padding:8px}
    .p-meta{line-height:1.2}
    .p-name{font-weight:800}
    .p-hp{font-size:12px;color:var(--success)}
    .dead .p-hp{color:var(--danger);opacity:.85}

    /* 응원 버튼 */
    .cheer-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .cheer-btn{
      background:#0f151c;color:var(--gold);border:var(--border);border-radius:10px;
      padding:10px;font-weight:800;cursor:pointer;transition:transform var(--fast), box-shadow var(--fast)
    }
    .cheer-btn:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(212,183,126,.22)}

    /* 중앙: 턴 정보 + 아바타 + 채팅(읽기전용) */
    .center{display:flex;flex-direction:column;align-items:center;gap:12px}
    .turn-box{text-align:center;border:var(--border);border-radius:12px;padding:10px 14px;background:#121822}
    .turn-flag{font-size:12px;color:var(--dim)}
    .turn-name{font-weight:900;color:var(--gold);margin-top:2px}
    .chat{
      width:100%;display:flex;flex-direction:column;height:340px;border:var(--border);
      border-radius:12px;overflow:hidden;background:#0f151c
    }
    .chat-messages{flex:1;overflow-y:auto;padding:10px;font-size:13px}
    .chat-note{padding:8px;border-top:var(--border-sub);background:#121822;color:var(--muted);font-size:12px}

    /* 로그 */
    .log{height:300px;overflow-y:auto;border:var(--border);border-radius:12px;padding:10px;background:#0f151c}
    .log-entry{font-size:12px;margin-bottom:6px}
    .log-system{color:var(--info)}
    .log-action{color:#ffd27a}
    .log-damage{color:var(--danger)}
    .log-heal{color:var(--success)}
    .log-cheer{color:var(--gold)}

    /* 로그인 모달 */
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.75);z-index:9999}
    .auth-box{width:92%;max-width:420px;background:#0f151c;border:var(--border);border-radius:16px;padding:20px}
    .auth-box h2{font-family:'Cinzel',serif;color:var(--gold);text-align:center;margin-bottom:12px}
    .fg{margin-bottom:10px}
    label{display:block;font-size:12px;color:var(--dim);margin-bottom:6px}
    .inp{width:100%;padding:10px;background:#0c1218;border:var(--border-sub);border-radius:10px;color:var(--text)}
    .auth-btn{width:100%;padding:12px;background:linear-gradient(145deg,var(--gold),var(--gold-2));color:#000;border:none;border-radius:12px;font-weight:900;cursor:pointer}
    .auth-msg{color:var(--danger);font-size:12px;margin-top:6px;min-height:16px}

    .hidden{display:none!important}
  </style>
</head>
<body>
  <!-- 로그인 모달 -->
  <div id="loginModal" class="modal">
    <div class="auth-box">
      <h2>관전자 입장</h2>
      <div class="fg">
        <label for="otp">OTP</label>
        <input id="otp" class="inp" placeholder="관리자에게 받은 비밀번호" />
      </div>
      <div class="fg">
        <label for="sname">표시 이름</label>
        <input id="sname" class="inp" placeholder="표시 이름" />
      </div>
      <button id="btnJoin" class="auth-btn">입장하기</button>
      <div id="authMsg" class="auth-msg"></div>
    </div>
  </div>

  <div class="container">
    <header class="header">
      <div class="brand">PYXIS</div>
      <div class="sub">BATTLE ARENA - SPECTATOR</div>
    </header>

    <main id="mainUI" class="layout hidden">
      <!-- LEFT: 죽음을 먹는 자 + 응원 -->
      <section>
        <div class="card">
          <h3>죽음을 먹는 자들</h3>
          <div id="deathList" class="player-list"></div>
        </div>
        <div class="card" style="margin-top:12px">
          <h3>응원</h3>
          <div class="cheer-grid">
            <button class="cheer-btn" data-msg="멋지다!">멋지다!</button>
            <button class="cheer-btn" data-msg="이겨라!">이겨라!</button>
            <button class="cheer-btn" data-msg="살아서 돌아와!">살아서 돌아와!</button>
            <button class="cheer-btn" data-msg="화이팅!">화이팅!</button>
            <button class="cheer-btn" data-msg="죽으면 나한테 죽어!">죽으면 나한테 죽어!</button>
            <button class="cheer-btn" data-msg="힘내요!">힘내요!</button>
          </div>
        </div>
      </section>

      <!-- CENTER: 현재 턴 아바타 + 채팅 표시 -->
      <section class="center">
        <div class="turn-box">
          <div id="turnFlag" class="turn-flag">대기 중</div>
          <div id="turnName" class="turn-name">-</div>
        </div>
        <img id="activeAvatar" class="avatar-rect lg" alt="현재 전투자" src="https://api.dicebear.com/7.x/adventurer/svg?seed=default" />
        <div class="chat">
          <div id="chatMessages" class="chat-messages"></div>
          <div class="chat-note">관전자는 채팅 입력이 불가합니다. 아래 응원 버튼으로 응원을 보내면 채팅창에 이름과 함께 표시됩니다.</div>
        </div>
      </section>

      <!-- RIGHT: 불사조 + 전투 로그 -->
      <section>
        <div class="card">
          <h3>불사조 기사단</h3>
          <div id="phoenixList" class="player-list"></div>
        </div>
        <div class="card" style="margin-top:12px">
          <h3>전투 로그</h3>
          <div id="battleLog" class="log"></div>
        </div>
      </section>
    </main>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
  (function(){
    "use strict";
    const $  = (s)=>document.querySelector(s);

    const socket = io();
    const battleId = new URLSearchParams(location.search).get("battle");

    // Auth elements
    const loginModal = $("#loginModal");
    const otpEl = $("#otp");
    const nameEl = $("#sname");
    const btnJoin = $("#btnJoin");
    const authMsg = $("#authMsg");
    const mainUI  = $("#mainUI");

    // UI elements
    const deathList   = $("#deathList");
    const phoenixList = $("#phoenixList");
    const activeAvatar= $("#activeAvatar");
    const turnFlag    = $("#turnFlag");
    const turnName    = $("#turnName");
    const chatMessages= $("#chatMessages");
    const battleLog   = $("#battleLog");

    let spectatorName = "";
    let players = [];
    let turnPlayerId = null;

    // ---- Join as spectator ----
    btnJoin.addEventListener("click", ()=>{
      const otp = (otpEl.value||"").trim();
      spectatorName = (nameEl.value||"").trim();
      if(!battleId || !otp || !spectatorName){
        authMsg.textContent = "battle ID/비밀번호/이름을 모두 입력하세요.";
        return;
      }
      socket.emit("spectator:join", { battleId, otp, name: spectatorName });
    });

    socket.on("spectator:join_ok", ({ roster, battle, currentPlayerName })=>{
      players = roster || [];
      renderRoster();
      setTurn(battle?.turn?.current, battle?.turn?.currentName || currentPlayerName);
      loginModal.classList.add("hidden");
      mainUI.classList.remove("hidden");
      addLog("관전 시작!", "system");
    });

    socket.on("spectator:join_fail", (d)=>{
      authMsg.textContent = d?.reason || "인증 실패";
    });

    // ---- Live updates ----
    socket.on("battle:update", (battle)=>{
      players = battle?.players || players;
      renderRoster();
    });

    socket.on("turn:update", ({ playerId, playerName })=>{
      setTurn(playerId, playerName);
    });

    // Logs only in log box
    socket.on("log:add", ({ type="action", msg })=>{
      addLog(msg, type);
    });

    // Chat (players' chat + cheers) in chat box
    socket.on("battle:chat", ({ name, msg })=>{
      addChat(name, msg);
    });

    // ---- Cheer buttons ----
    document.querySelectorAll(".cheer-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        if(!spectatorName) return;
        const msg = btn.getAttribute("data-msg");
        socket.emit("spectator:cheer", { battleId, name: spectatorName, msg });
        // 로컬도 즉시 표시(서버 브로드캐스트와 중복되면 아래 줄 제거)
        // addChat(spectatorName, msg);
      });
    });

    // ---- Renderers ----
    function renderRoster(){
      const phoenix = players.filter(p=>p.team === "phoenix");
      const death   = players.filter(p=>p.team === "eaters");

      renderTeamList(phoenixList, phoenix);
      renderTeamList(deathList,   death);

      // 중앙 현재 플레이어 아바타
      const cur = players.find(p=>p.id === turnPlayerId);
      activeAvatar.src = cur?.avatar || "https://api.dicebear.com/7.x/adventurer/svg?seed=default";
    }

    function renderTeamList(rootEl, list){
      rootEl.innerHTML = "";
      if(!list.length){
        rootEl.innerHTML = `<div class="muted">전투 참여자 없음</div>`;
        return;
      }
      list.forEach(p=>{
        const row = document.createElement("div");
        row.className = "player-item" + ((p.hp <= 0 || p.status === "dead") ? " dead" : "");
        row.innerHTML = `
          <img class="avatar-rect sm" src="${p.avatar || "https://api.dicebear.com/7.x/adventurer/svg?seed=user"}" alt="">
          <div class="p-meta">
            <div class="p-name">${escapeHtml(p.name)}${(p.id===turnPlayerId)?' <span style="color:var(--gold)">●</span>':''}</div>
            <div class="p-hp">${Math.max(0, p.hp ?? 0)}/${p.maxHp ?? 100} HP</div>
          </div>
        `;
        rootEl.appendChild(row);
      });
    }

    function setTurn(playerId, playerName){
      turnPlayerId = playerId || null;
      turnFlag.textContent = turnPlayerId ? "현재 턴" : "대기 중";
      turnName.textContent = playerName || nameById(turnPlayerId) || "-";
      const cur = players.find(p=>p.id === turnPlayerId);
      activeAvatar.src = cur?.avatar || "https://api.dicebear.com/7.x/adventurer/svg?seed=default";
    }

    // ---- UI helpers ----
    function addChat(author, text){
      const div = document.createElement("div");
      div.innerHTML = `<span style="color:var(--gold);font-weight:800;margin-right:6px">${escapeHtml(author)}:</span>${escapeHtml(text)}`;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addLog(text, type="action"){
      const div = document.createElement("div");
      div.className = `log-entry log-${type}`;
      div.textContent = text;
      battleLog.appendChild(div);
      battleLog.scrollTop = battleLog.scrollHeight;
    }

    function nameById(id){
      return players.find(p=>p.id===id)?.name || null;
    }
    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    }
  })();
  </script>
</body>
</html>
