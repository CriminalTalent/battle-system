/* packages/battle-server/public/assets/js/core/pages/spectator.js
   디자인 미변경. 관전 접속만 담당.
   URL 쿼리: ?battle=...&otp=...
*/
(function(){
  'use strict';
  const params = new URLSearchParams(location.search);
  const battle = params.get('battle');
  const otp = params.get('otp');
  const name = localStorage.getItem('spectator_name') || '';

  const $ = sel => document.querySelector(sel);
  const elLog = $('#watchLog');
  const elView = $('#watchView');

  let socket = null;

  function append(line) {
    if (!elLog) return;
    elLog.value += line + '\n';
    elLog.scrollTop = elLog.scrollHeight;
  }

  function render(s) {
    if (!elView) return;
    const aHp = s.players.filter(p => p.team === 'phoenix').reduce((k, p)=>k+p.hp,0);
    const dHp = s.players.filter(p => p.team === 'death').reduce((k, p)=>k+p.hp,0);
    elView.textContent = `phoenix HP=${aHp} / death HP=${dHp} | turn=${s.order?.team || '-'}`;
  }

  function connect() {
    // eslint-disable-next-line no-undef
    const s = io();
    socket = s;
    s.on('connect', () => {
      s.emit('auth', { role: 'spectator', battle, otp, name }, (resp) => {
        if (resp?.ok) render(resp.state);
        else append(`[error] ${resp?.error || 'auth'}`);
      });
    });
    s.on('state', render);
    s.on('chat', c => append(`[chat] ${c.name}: ${c.msg}`));
  }

  $('#saveSpectatorName')?.addEventListener('click', () => {
    const v = $('#spectatorName')?.value?.trim() || '';
    localStorage.setItem('spectator_name', v);
  });

  connect();
})();
