<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PYXIS - 전투 관전</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: linear-gradient(135deg, #000 0%, #111 50%, #000 100%);
      color: #f8f6f0;
      font-size: 14px;
      min-height: 100vh;
      display: flex; flex-direction: column;
    }
    :root {
      --gold: #d4b77e;
      --gold-dark: #c9a96e;
      --text-dim: #b8a898;
      --success: #27ae60;
      --danger: #e74c3c;
      --warning: #f39c12;
      --info: #3498db;
      --radius: 12px;
    }
    .hidden { display: none !important; }

    /* ===== 모달 로그인 ===== */
    .modal {
      position: fixed; inset: 0;
      display: flex; justify-content: center; align-items: center;
      background: rgba(0,0,0,.7);
      z-index: 2000;
    }
    .modal-card {
      background: #111;
      padding: 32px;
      border-radius: var(--radius);
      border: 2px solid var(--gold);
      width: 90%; max-width: 420px;
    }
    .modal-card h2 {
      font-family: 'Cinzel', serif;
      font-size: 22px;
      margin-bottom: 16px;
      text-align: center;
      color: var(--gold);
    }
    .form-group { margin-bottom: 16px; }
    .form-label { font-size: 13px; margin-bottom: 6px; display: block; color: var(--text-dim); }
    .form-input {
      width: 100%; padding: 10px;
      background: #222;
      border: 1px solid #555;
      border-radius: var(--radius);
      color: #fff;
    }
    .form-input:focus { outline: none; border-color: var(--gold); }
    .login-btn {
      width: 100%; padding: 12px;
      background: linear-gradient(135deg, var(--gold), var(--gold-dark));
      border: none; border-radius: var(--radius);
      font-weight: 700; cursor: pointer;
      color: #000;
    }

    /* ===== 메인 3단 레이아웃 ===== */
    .spectator-layout {
      display: grid;
      grid-template-columns: 320px 1fr 320px;
      gap: 16px;
      flex: 1; padding: 16px;
    }
    .card {
      background: #111;
      border: 2px solid #333;
      border-radius: var(--radius);
      padding: 16px;
    }
    .card h3 { margin-bottom: 12px; color: var(--gold); font-family: 'Cinzel', serif; font-size: 16px; }

    /* ===== 팀 리스트 ===== */
    .player-list { display: flex; flex-direction: column; gap: 8px; }
    .player-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px; background: #222; border-radius: var(--radius);
      border: 1px solid #444;
    }
    .player-name { font-weight: 600; }
    .player-team { font-size: 11px; color: var(--gold); }
    .player-hp { font-size: 12px; font-weight: 600; color: var(--success); }
    .status-dead { color: var(--danger); }

    /* ===== 응원 버튼 ===== */
    .cheer-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .cheer-btn {
      padding: 8px; background: #222; border: 1px solid var(--gold);
      border-radius: var(--radius); cursor: pointer;
      color: var(--gold); font-size: 12px; font-weight: 600;
    }

    /* ===== 중앙 ===== */
    .battlefield {
      display: flex; flex-direction: column; align-items: center; gap: 16px;
      padding: 16px; border: 2px solid #333; border-radius: var(--radius);
      background: #111;
    }
    .active-avatar {
      width: 120px; height: 120px; background: #222;
      border: 3px solid var(--gold); border-radius: 8px;
    }
    .chat-box {
      flex: 1; width: 100%; display: flex; flex-direction: column;
      border: 1px solid #444; border-radius: var(--radius);
      overflow: hidden;
    }
    .chat-messages {
      flex: 1; padding: 8px; overflow-y: auto; font-size: 13px;
    }

    /* ===== 전투 로그 ===== */
    .battle-log {
      height: 300px; overflow-y: auto; font-size: 12px;
    }
    .log-entry { margin-bottom: 6px; }
    .log-system { color: var(--info); }
    .log-damage { color: var(--danger); }
    .log-heal { color: var(--success); }
    .log-cheer { color: var(--gold); }
  </style>
</head>
<body>
  <!-- 로그인 모달 -->
  <div id="loginModal" class="modal">
    <div class="modal-card">
      <h2>관전자 입장</h2>
      <form id="loginForm">
        <div class="form-group">
          <label class="form-label" for="battleId">전투 ID</label>
          <input type="text" id="battleId" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label" for="otp">OTP</label>
          <input type="text" id="otp" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label" for="spectatorName">이름</label>
          <input type="text" id="spectatorName" class="form-input" required>
        </div>
        <button type="submit" class="login-btn">입장</button>
      </form>
    </div>
  </div>

  <!-- 메인 레이아웃 -->
  <div id="spectatorLayout" class="spectator-layout hidden">
    <!-- 좌측: 적군 -->
    <div>
      <div class="card">
        <h3>죽음을 먹는 자들</h3>
        <div class="player-list" id="enemyList"></div>
      </div>
      <div class="card">
        <h3>응원</h3>
        <div class="cheer-buttons">
          <button class="cheer-btn" data-msg="멋지다!">멋지다!</button>
          <button class="cheer-btn" data-msg="이겨라!">이겨라!</button>
          <button class="cheer-btn" data-msg="살아서 돌아와!">살아서 돌아와!</button>
          <button class="cheer-btn" data-msg="화이팅!">화이팅!</button>
          <button class="cheer-btn" data-msg="죽으면 나한테 죽어!">죽으면 나한테 죽어!</button>
          <button class="cheer-btn" data-msg="힘내요!">힘내요!</button>
        </div>
      </div>
    </div>

    <!-- 중앙 -->
    <div>
      <div class="battlefield">
        <img id="activeAvatar" class="active-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=default" alt="현재 전투자">
        <div class="chat-box">
          <div id="chatMessages" class="chat-messages"></div>
        </div>
      </div>
    </div>

    <!-- 우측: 아군 -->
    <div>
      <div class="card">
        <h3>불사조 기사단</h3>
        <div class="player-list" id="allyList"></div>
      </div>
      <div class="card">
        <h3>전투 로그</h3>
        <div id="battleLog" class="battle-log"></div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let spectatorName = "";

    const loginModal = document.getElementById("loginModal");
    const spectatorLayout = document.getElementById("spectatorLayout");
    const loginForm = document.getElementById("loginForm");

    const chatMessages = document.getElementById("chatMessages");
    const battleLog = document.getElementById("battleLog");

    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const battleId = document.getElementById("battleId").value;
      const otp = document.getElementById("otp").value;
      spectatorName = document.getElementById("spectatorName").value;
      socket.emit("spectator:join", { battleId, otp, name: spectatorName });
    });

    socket.on("spectator:join_ok", () => {
      loginModal.classList.add("hidden");
      spectatorLayout.classList.remove("hidden");
      addLog("관전 시작!", "system");
    });

    function addChat(author, text) {
      const div = document.createElement("div");
      div.innerHTML = `<b style="color:var(--gold)">${author}:</b> ${text}`;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addLog(text, type="system") {
      const div = document.createElement("div");
      div.className = "log-entry log-" + type;
      div.textContent = text;
      battleLog.appendChild(div);
      battleLog.scrollTop = battleLog.scrollHeight;
    }

    // 응원 버튼 이벤트
    document.querySelectorAll(".cheer-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const msg = btn.dataset.msg;
        socket.emit("spectator:cheer", { name: spectatorName, msg });
      });
    });

    // 서버에서 오는 메시지 표시
    socket.on("battle:chat", ({ name, msg }) => addChat(name, msg));
    socket.on("battle:log", ({ msg, type }) => addLog(msg, type));
  </script>
</body>
</html>
