<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PYXIS - 전투 참가자</title>
  <script src="/socket.io/socket.io.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --black:#0b0b0d; --black-2:#101216; --panel:rgba(255,255,255,.04); --panel2:rgba(255,255,255,.08);
      --border:rgba(255,255,255,.14); --text:#f7f8fa; --muted:#aeb3be; --gold:#dcc7a2; --gold2:#e6d2a8;
      --success:#27ae60; --danger:#e74c3c; --info:#3498db; --radius:14px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{min-height:100%;background:var(--black);color:var(--text);font-family:'Cinzel',serif;line-height:1.6}
    .header{position:sticky;top:0;z-index:10;background:var(--panel2);border-bottom:1px solid var(--border)}
    .header-inner{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;padding:12px 14px}
    .logo{color:var(--gold2);font-weight:800}
    .status{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:12px}
    .dot{width:8px;height:8px;border-radius:50%;background:#666}.dot.on{background:var(--success)}
    .main{max-width:1400px;margin:0 auto;padding:16px;display:grid;grid-template-columns:320px 1fr 360px;gap:16px;align-items:start}
    @media (max-width:1200px){.main{grid-template-columns:1fr}}
    .card{background:var(--panel2);border:1px solid var(--border);border-radius:var(--radius);padding:12px}
    .title{color:var(--gold2);font-weight:800;border-bottom:1px solid var(--border);padding-bottom:8px;margin-bottom:10px;text-align:center}
    .grid{display:grid;gap:8px}.g2{grid-template-columns:1fr 1fr}.g4{grid-template-columns:repeat(4,1fr)}
    .input,.select,button{font-family:'Cinzel',serif}
    .input,.select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#0e0f13;color:var(--text);font-size:13px}
    /* 드롭다운 화이트테마 제거 */
    .select{appearance:none;-webkit-appearance:none;-moz-appearance:none;background-color:#0e0f13;color:var(--text)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;min-height:38px;padding:8px 14px;border-radius:10px;border:1px solid var(--border);background:linear-gradient(180deg,var(--gold),var(--gold2));color:#111;font-weight:800;cursor:pointer}
    .btn.soft{background:var(--panel);color:var(--text)}
    .hpbar{height:8px;border-radius:6px;background:#1a1d24;border:1px solid var(--border);overflow:hidden}
    .hpbar>span{display:block;height:100%;background:#2ecc71}
    .my{display:grid;gap:10px}
    .big-portrait{width:100%;aspect-ratio:3/4;border-radius:16px;border:1px solid var(--border);background:#0f1014 center/cover no-repeat}
    .logs{height:260px;overflow:auto;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px;font-size:12px}
    .logline{padding:4px 0;border-bottom:1px dashed rgba(255,255,255,.08)}
    .logline:last-child{border-bottom:none}
    .ts{color:var(--muted);font-size:10px;margin-right:6px}

    /* ---- 로그인 모달(최상단) ---- */
    #authOverlay{position:fixed;inset:0;z-index:9999;display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,.78)}
    .auth-card{width:min(520px,92vw);background:#101216;border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 24px 60px rgba(0,0,0,.6)}
    .auth-card h2{color:var(--gold2);text-align:center;margin-bottom:10px}
    .auth-card .hint{color:var(--muted);font-size:12px;text-align:center;margin:-4px 0 10px}
    .auth-actions{display:flex;gap:8px;margin-top:10px}
    .err{color:var(--danger);font-size:12px;margin-top:6px;min-height:16px}

    /* ---- 타깃 오버레이(전투 중) 기본 비활성화 + z-index 낮춤 ---- */
    #targetOverlay{position:fixed;inset:0;display:none;z-index:5000;background:rgba(0,0,0,.65)}
    .target-card{width:min(820px,95vw);margin:40px auto;background:#0f1014;border:1px solid var(--border);border-radius:16px;padding:16px}
    .target-title{color:var(--gold2);font-weight:800;margin-bottom:8px;text-align:center}

    /* 소형 요소 */
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:#0e0f13;font-size:11px;color:var(--muted)}
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <div class="logo">PYXIS · 전투 참가자</div>
      <div class="status"><span id="connText">연결 대기</span><span id="connDot" class="dot"></span></div>
    </div>
  </header>

  <main class="main">
    <!-- 좌: 내 카드 -->
    <section class="card my">
      <div class="title">내 정보</div>
      <div style="display:flex;gap:10px;align-items:center">
        <div id="meAvatar" style="width:54px;height:54px;border-radius:8px;background:#0f1014 center/cover no-repeat;border:1px solid var(--border)"></div>
        <div style="min-width:0">
          <div id="meName" style="font-weight:800">-</div>
          <div id="meTeam" class="pill">-팀</div>
        </div>
      </div>
      <div>
        <div class="hpbar" title="HP"><span id="meHpBar" style="width:100%"></span></div>
        <div id="meHp" style="font-size:12px;color:var(--muted);margin-top:4px">HP 100/100</div>
      </div>
      <div class="g4">
        <div><div class="pill">공격</div><div id="sAtk">-</div></div>
        <div><div class="pill">방어</div><div id="sDef">-</div></div>
        <div><div class="pill">민첩</div><div id="sAgi">-</div></div>
        <div><div class="pill">행운</div><div id="sLuk">-</div></div>
      </div>
      <div>
        <div class="pill">아이템</div>
        <div id="myItems" style="font-size:12px;color:var(--muted);margin-top:4px">-</div>
      </div>
      <button id="btnReady" class="btn">준비 완료</button>
    </section>

    <!-- 중: 큰 초상화/턴 -->
    <section class="card">
      <div class="title">현재 턴</div>
      <div id="turnPortrait" class="big-portrait"></div>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
        <div class="pill">선공팀 <strong id="firstTeam" style="margin-left:6px">-</strong></div>
        <div class="pill">현재팀 <strong id="turnTeam" style="margin-left:6px">-</strong></div>
        <div class="pill">라운드 <strong id="roundNo" style="margin-left:6px">-</strong></div>
        <div class="pill">팀 제한시간 <strong id="teamTimer" style="margin-left:6px">-</strong></div>
      </div>
      <!-- 액션 -->
      <div class="card" style="margin-top:12px">
        <div class="title" style="margin-bottom:6px">행동</div>
        <div class="g2">
          <button id="btnAttack" class="btn soft">공격</button>
          <button id="btnDefend" class="btn soft">방어</button>
          <button id="btnDodge"  class="btn soft">회피</button>
          <button id="btnPass"   class="btn soft">패스</button>
        </div>
        <div class="g2" style="margin-top:8px">
          <button id="btnItemHeal" class="btn soft">디터니 사용</button>
          <button id="btnItemAtk"  class="btn soft">공격 보정기</button>
          <button id="btnItemDef"  class="btn soft">방어 보정기</button>
        </div>
        <div id="actionHint" class="pill" style="margin-top:10px;text-align:center">전투 시작 대기 중입니다.</div>
      </div>
    </section>

    <!-- 우: 팀 구성 / 로그 -->
    <section class="card">
      <div class="title">팀 구성</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <div class="pill" style="margin-bottom:6px">A팀</div>
          <div id="listA" style="display:grid;gap:8px"></div>
        </div>
        <div>
          <div class="pill" style="margin-bottom:6px">B팀</div>
          <div id="listB" style="display:grid;gap:8px"></div>
        </div>
      </div>

      <div class="title" style="margin-top:12px">실시간 로그</div>
      <div id="logs" class="logs"></div>

      <div class="title" style="margin-top:12px">채팅</div>
      <div style="display:flex;gap:8px">
        <input id="chatMsg" class="input" placeholder="채팅 입력 (Enter 전송)"/>
        <button id="btnSend" class="btn">전송</button>
      </div>
    </section>
  </main>

  <!-- 로그인 오버레이 -->
  <div id="authOverlay">
    <div class="auth-card">
      <h2>전투 참가 인증</h2>
      <div class="hint">이름과 비밀번호(OTP)를 입력하세요.</div>
      <div class="grid g2">
        <input id="authName" class="input" placeholder="이름(필수)"/>
        <select id="authTeam" class="select">
          <option value="A">A팀</option>
          <option value="B">B팀</option>
        </select>
      </div>
      <div style="margin-top:8px"><input id="authPwd" class="input" placeholder="비밀번호(OTP, 필수)"/></div>
      <div class="auth-actions">
        <button id="authBtn" class="btn" style="flex:1">입장</button>
        <button id="authCancel" class="btn soft" style="flex:1">취소</button>
      </div>
      <div id="authErr" class="err"></div>
    </div>
  </div>

  <!-- 타깃 선택 오버레이(기본 숨김) -->
  <div id="targetOverlay">
    <div class="target-card">
      <div class="target-title">대상 선택</div>
      <div id="targetList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px"></div>
      <div style="text-align:center;margin-top:10px"><button id="btnCloseTarget" class="btn soft">닫기</button></div>
    </div>
  </div>

  <script>
    const $=q=>document.querySelector(q), esc=s=>String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const ts=()=>new Date().toLocaleTimeString('ko-KR',{hour12:false});
    function addLog(msg){ const el=document.createElement('div'); el.className='logline'; el.innerHTML=`<span class="ts">${ts()}</span>${esc(msg)}`; const box=$('#logs'); box.appendChild(el); box.scrollTop=box.scrollHeight; while(box.children.length>400) box.removeChild(box.firstChild); }

    // 기본 상태
    let socket=null, battleId=null, me=null, battle=null;

    // 연결
    function connect(){
      socket = window.io({ path:'/socket.io', transports:['websocket','polling'] });
      socket.on('connect', ()=>{ $('#connText').textContent='연결됨'; $('#connDot').classList.add('on'); addLog('서버에 연결되었습니다.'); });
      socket.on('disconnect', ()=>{ $('#connText').textContent='연결 끊김'; $('#connDot').classList.remove('on'); addLog('서버 연결이 끊어졌습니다.'); });

      // 스냅샷
      const onUpdate = (b)=>{ battle=b; renderBattle(); };
      socket.on('battleUpdate', onUpdate); socket.on('battle:update', onUpdate);

      // 채팅
      socket.on('chatMessage', (m)=> addLog(`채팅 ${m?.name||'익명'}: ${m?.message||''}`));
      socket.on('battle:chat', (m)=> addLog(`채팅 ${m?.name||m?.senderName||'익명'}: ${m?.message||''}`));

      // 인증 결과
      socket.on('authSuccess', (r)=> onAuthSuccess(r));
      socket.on('auth:success', (r)=> onAuthSuccess(r));
      socket.on('authError', (e)=> showAuthError(e?.message||'인증 실패'));
    }

    // 인증 플로우
    function showAuth(err){
      // 타깃 오버레이가 가리는 문제 방지: 무조건 숨김
      const tgt=$('#targetOverlay'); if(tgt) tgt.style.display='none';
      $('#authOverlay').style.display='flex';
      if(err) showAuthError(err);
    }
    function hideAuth(){ $('#authOverlay').style.display='none'; $('#authErr').textContent=''; }
    function showAuthError(m){ $('#authErr').textContent=m||''; addLog(`인증 오류: ${m}`); }

    function tryAutoAuthFromURL(){
      const p=new URLSearchParams(location.search);
      battleId = p.get('battle') || p.get('id') || null;
      const name = (p.get('name')||'').trim();
      const team = (p.get('team')||'A').toUpperCase()==='B'?'B':'A';
      const token = p.get('password')||p.get('otp')||p.get('token')||'';
      if(!battleId){ showAuth('전투 ID가 없습니다. 잘못된 링크입니다.'); return; }
      // 이름이 없으면 자동 진행 금지(요청사항)
      if(name && token){
        $('#authName').value=name; $('#authTeam').value=team; $('#authPwd').value=token;
        doAuth(name, token, team);
      }else{
        $('#authName').value=name; $('#authTeam').value=team; $('#authOverlay').style.display='flex';
      }
    }

    function doAuth(name, token, team){
      $('#authErr').textContent='';
      if(!name.trim()){ showAuthError('이름을 입력하세요.'); return; }
      if(!token.trim()){ showAuthError('비밀번호(OTP)를 입력하세요.'); return; }
      addLog(`인증 시도: ${name} (${team}팀)`);
      socket.emit('playerAuth', { battleId, playerName:name, name, token, password:token, otp:token, team }, (res)=>{
        if(!res?.ok){ showAuthError(res?.message || '인증 실패'); return; }
        onAuthSuccess(res);
      });
    }

    function onAuthSuccess(res){
      hideAuth();
      addLog('인증 성공. 전투에 참가했습니다.');
      me = res.playerData || res.player || null;
      battle = res.battle || battle;
      renderMe();
      renderBattle();
    }

    // 렌더링
    function renderMe(){
      if(!me) return;
      $('#meName').textContent = me.name||'-';
      $('#meTeam').textContent = (me.team||'A')+'팀';
      $('#meAvatar').style.backgroundImage = me.avatar?`url('${me.avatar}')`:'';
      const hp = `${me.hp||100}/${me.maxHp||100}`; $('#meHp').textContent = 'HP '+hp;
      $('#meHpBar').style.width = Math.max(0, Math.min(100, (me.hp||100)/(me.maxHp||100)*100))+'%';
      $('#sAtk').textContent = me.stats?.attack ?? '-';
      $('#sDef').textContent = me.stats?.defense ?? '-';
      $('#sAgi').textContent = me.stats?.agility ?? '-';
      $('#sLuk').textContent = me.stats?.luck ?? '-';
      $('#myItems').textContent = `디터니 ${me.items?.dittany||0} · 공격보정기 ${me.items?.attack_boost||0} · 방어보정기 ${me.items?.defense_boost||0}`;
    }

    function renderBattle(){
      if(!battle) return;
      // 큰 초상화 / 턴 표기
      const cur = (battle.currentTurn?.currentCharacter) || (battle.players||[])[0] || null;
      $('#turnPortrait').style.backgroundImage = cur?.avatar?`url('${cur.avatar}')`:'';
      $('#firstTeam').textContent = battle.firstTeam || '-';
      $('#turnTeam').textContent  = battle.currentTurn?.currentTeam || '-';
      $('#roundNo').textContent   = battle.currentTurn?.round || 1;
      $('#teamTimer').textContent = battle.timeLeft!=null ? (battle.timeLeft+'s') : '-';

      // 팀 목록
      const A=(battle.players||[]).filter(p=>p.team==='A');
      const B=(battle.players||[]).filter(p=>p.team==='B');
      const mk=(p)=> {
        const c=document.createElement('div');
        c.style.cssText='display:flex;gap:8px;align-items:center;border:1px solid var(--border);border-radius:10px;padding:8px;background:#0e0f13';
        c.innerHTML = `<div style="width:28px;height:28px;border-radius:6px;background:#0f1014 center/cover no-repeat;border:1px solid var(--border);background-image:${p.avatar?`url('${esc(p.avatar)}')`:'none'}"></div>
          <div style="min-width:0;flex:1">
            <div style="font-weight:800">${esc(p.name)}</div>
            <div class="hpbar" style="margin-top:2px"><span style="width:${Math.max(0,Math.min(100,(p.hp||0)/(p.maxHp||100)*100))}%"></span></div>
            <div style="font-size:11px;color:var(--muted);margin-top:2px">공${p.stats?.attack} 방${p.stats?.defense} 민${p.stats?.agility} 행${p.stats?.luck}</div>
          </div>`;
        return c;
      };
      const La=$('#listA'), Lb=$('#listB'); La.innerHTML=''; Lb.innerHTML='';
      A.forEach(p=>La.appendChild(mk(p))); B.forEach(p=>Lb.appendChild(mk(p)));
    }

    // 액션(샘플 송신 훅만 연결 — 서버 측 액션 처리 로직에 맞춰 교체 가능)
    function enableActions(){
      const needTurn=()=> (battle?.currentTurn?.currentTeam===me?.team);
      const send=(payload)=>{ if(!battle||!me) return; if(!needTurn()) { addLog('아직 우리 팀의 순서가 아닙니다.'); return; }
        socket.emit('playerAction', { battleId, playerId: me.id, ...payload });
        socket.emit('player:action', { battleId, playerId: me.id, ...payload });
        addLog(`행동 전송: ${JSON.stringify(payload)}`);
      };
      $('#btnAttack').onclick = ()=>{ openTargetList('attack',(id)=> send({ type:'attack', targetId:id })); };
      $('#btnDefend').onclick = ()=> send({ type:'defend' });
      $('#btnDodge').onclick  = ()=> send({ type:'dodge'  });
      $('#btnPass').onclick   = ()=> send({ type:'pass'   });
      $('#btnItemHeal').onclick = ()=> openTargetList('item_dittany',(id)=> send({ type:'item', itemType:'dittany', targetId:id }));
      $('#btnItemAtk').onclick  = ()=> send({ type:'item', itemType:'attack_boost' });
      $('#btnItemDef').onclick  = ()=> send({ type:'item', itemType:'defense_boost' });
      $('#btnReady').onclick    = ()=> { if(!battle||!me) return; socket.emit('playerReady',{ battleId, playerId:me.id, ready:true }); socket.emit('player:ready',{ battleId, playerId:me.id, ready:true }); addLog('준비 완료 전송'); $('#btnReady').disabled=true; };
    }

    // 타깃 선택
    function openTargetList(mode, onPick){
      if(!battle) return;
      const list=(mode==='item_dittany' ? (battle.players||[]).filter(p=>p.team===me.team && p.hp>0) : (battle.players||[]).filter(p=>p.team!==me.team && p.hp>0));
      const box=$('#targetList'); box.innerHTML='';
      list.forEach(p=>{
        const el=document.createElement('button'); el.className='btn soft'; el.textContent=p.name; el.style.margin='4px';
        el.onclick=()=>{ $('#targetOverlay').style.display='none'; onPick && onPick(p.id); };
        box.appendChild(el);
      });
      $('#targetOverlay').style.display='block';
    }

    // 채팅
    function bindChat(){
      const send=()=>{ const msg=$('#chatMsg').value.trim(); if(!msg||!battleId) return;
        socket.emit('chatMessage',{ battleId, name: me?.name || '전투참가자', message: msg });
        socket.emit('battle:chat',{ battleId, name: me?.name || '전투참가자', senderName: me?.name || '전투참가자', message: msg });
        $('#chatMsg').value=''; addLog(`채팅 나: ${msg}`);
      };
      $('#btnSend').onclick=send;
      $('#chatMsg').addEventListener('keydown',e=>{ if(e.key==='Enter') send(); });
    }

    // 초기화
    (function init(){
      // 로그인 오버레이가 항상 최상단이 되도록 타깃 오버레이 강제 비활성화
      const tgt=$('#targetOverlay'); if(tgt){ tgt.style.display='none'; tgt.style.zIndex='5000'; }
      $('#btnCloseTarget').onclick=()=> $('#targetOverlay').style.display='none';

      connect();
      bindChat();
      enableActions();

      // URL 자동 인증(이름/OTP 둘 다 있어야만 진행)
      tryAutoAuthFromURL();

      // 수동 인증 버튼
      $('#authBtn').onclick=()=> doAuth($('#authName').value, $('#authPwd').value, $('#authTeam').value);
      $('#authCancel').onclick=()=> showAuth(); // 그대로 유지
    })();
  </script>
</body>
</html>
