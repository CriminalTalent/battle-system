<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>PYXIS - 전투 참가자</title>
  
  <!-- CSS Links -->
  <link rel="stylesheet" href="/assets/css/pyxis-theme.css"/>
  
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet"/>
  
  <style>
    /* === 기존 CSS 유지 (변경 없음) === */
    /* ... (위에서 준 CSS 그대로 유지) ... */
  </style>
</head>
<body>
  <header class="header">
    <h1 class="title">PYXIS</h1>
  </header>

  <div class="player-container">
    <div class="player-grid">
      <!-- 좌측: 내 정보 -->
      <div>
        <div class="card">
          <h2 class="section-title">내 정보</h2>
          <div class="my-info">
            <img id="myAvatar" class="my-avatar" alt="내 캐릭터" 
                 src="/uploads/avatars/default.svg"
                 onerror="this.src='/uploads/avatars/default.svg'"/>
            <div id="myName" class="my-name">로딩중...</div>
            <div id="myTeam" class="my-team">팀: -</div>
            
            <div class="hp-bar">
              <div id="myHpFill" class="hp-fill" style="width: 100%"></div>
              <div id="myHpText" class="hp-text">100 / 100</div>
            </div>
            
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-label">공격</div>
                <div id="myAttack" class="stat-value">-</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">방어</div>
                <div id="myDefense" class="stat-value">-</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">민첩</div>
                <div id="myAgility" class="stat-value">-</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">행운</div>
                <div id="myLuck" class="stat-value">-</div>
              </div>
            </div>
            
            <div class="items-grid">
              <div class="item-count">
                <div class="item-label">디터니</div>
                <div id="myDittany" class="item-value">0</div>
              </div>
              <div class="item-count">
                <div class="item-label">공격 보정기</div>
                <div id="myAttackBooster" class="item-value">0</div>
              </div>
              <div class="item-count">
                <div class="item-label">방어 보정기</div>
                <div id="myDefenseBooster" class="item-value">0</div>
              </div>
            </div>
            
            <button id="readyBtn" class="ready-btn">준비 완료</button>
          </div>
        </div>
        
        <!-- 내 팀 -->
        <div class="card">
          <h2 class="section-title">내 팀</h2>
          <div id="myTeamMembers"></div>
        </div>
      </div>

      <!-- 중앙: 전투 영역 -->
      <div>
        <div class="card battle-area">
          <div class="turn-info">
            <div id="currentTurn" class="current-turn">대기 중</div>
            <div id="turnTimer" class="turn-timer">00:00</div>
            <div id="turnDescription" class="turn-description">전투가 시작되길 기다리고 있습니다</div>
          </div>
          
          <img id="currentPlayerPortrait" class="current-player-portrait" alt="현재 플레이어"
               src="/uploads/avatars/default.svg"
               onerror="this.src='/uploads/avatars/default.svg'"/>
          
          <div class="action-buttons">
            <button id="attackBtn" class="action-btn" disabled>공격</button>
            <button id="defendBtn" class="action-btn" disabled>방어</button>
            <button id="dodgeBtn" class="action-btn" disabled>회피</button>
            <button id="itemBtn" class="action-btn" disabled>아이템</button>
            <button id="passBtn" class="action-btn" disabled>패스</button>
          </div>
        </div>
        
        <!-- 상대팀 -->
        <div class="card">
          <h2 class="section-title">상대팀</h2>
          <div id="enemyTeamMembers"></div>
        </div>
      </div>

      <!-- 우측: 로그 & 채팅 -->
      <div>
        <div class="card">
          <h2 class="section-title">전투 로그</h2>
          <div id="battleLog" class="battle-log"></div>
        </div>
        
        <div class="card">
          <h2 class="section-title">채팅</h2>
          <div id="chatMessages" class="chat-messages"></div>
          <div class="chat-input-area">
            <input id="chatInput" class="chat-input" type="text" placeholder="메시지 입력..." maxlength="200"/>
            <button id="chatSendBtn" class="chat-send-btn">전송</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 대상 선택 오버레이 -->
  <div id="targetOverlay" class="overlay" style="display: none;">
    <div class="target-selection">
      <h2 id="targetTitle">대상 선택</h2>
      <div id="targetGrid" class="target-grid"></div>
      <button id="cancelBtn" class="cancel-btn">취소</button>
    </div>
  </div>

  <!-- Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>
  
  <script>
    // === JS 로직 ===
    // (대부분 기존과 동일, 아이템 처리 부분만 단일화)

    function updateMyInfo() {
      if (!playerData) return;
      
      document.getElementById('myName').textContent = playerData.name;
      document.getElementById('myTeam').textContent = `팀: ${playerData.team}`;
      if (playerData.avatar) document.getElementById('myAvatar').src = playerData.avatar;
      
      // HP
      const hpPercentage = (playerData.hp / playerData.maxHp) * 100;
      document.getElementById('myHpFill').style.width = hpPercentage + '%';
      document.getElementById('myHpText').textContent = `${playerData.hp} / ${playerData.maxHp}`;
      
      // 스탯
      document.getElementById('myAttack').textContent = playerData.stats.attack || 1;
      document.getElementById('myDefense').textContent = playerData.stats.defense || 1;
      document.getElementById('myAgility').textContent = playerData.stats.agility || 1;
      document.getElementById('myLuck').textContent = playerData.stats.luck || 1;
      
      // 아이템 (표준 키만)
      document.getElementById('myDittany').textContent = playerData.items.dittany || 0;
      document.getElementById('myAttackBooster').textContent = playerData.items.attackBooster || 0;
      document.getElementById('myDefenseBooster').textContent = playerData.items.defenseBooster || 0;
    }

    function showItemSelection() {
      if (!playerData || !playerData.items) return;
      const items = [];
      
      if ((playerData.items.dittany || 0) > 0)
        items.push({ key: 'dittany', name: '디터니', needsTarget: true, allies: true });
      if ((playerData.items.attackBooster || 0) > 0)
        items.push({ key: 'attackBooster', name: '공격 보정기 (성공률 90%)', needsTarget: true, allies: false });
      if ((playerData.items.defenseBooster || 0) > 0)
        items.push({ key: 'defenseBooster', name: '방어 보정기 (성공률 90%)', needsTarget: true, allies: true });
      
      if (items.length === 0) {
        alert('사용할 수 있는 아이템이 없습니다.');
        return;
      }
      
      const itemNames = items.map((i, idx) => `${idx+1}. ${i.name} (${playerData.items[i.key]})`).join('\n');
      const selected = prompt(`사용할 아이템을 선택하세요:\n${itemNames}`);
      if (!selected) return;
      
      const index = parseInt(selected) - 1;
      if (index >= 0 && index < items.length) {
        const selectedItem = items[index];
        currentAction = { type: 'item', item: selectedItem.key };
        const targets = selectedItem.allies ? getAllyPlayers() : getEnemyPlayers();
        showTargetSelection(`${selectedItem.name} 대상 선택`, targets, selectedItem.allies);
      }
    }
  </script>
</body>
</html>
