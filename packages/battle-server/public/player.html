<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PYXIS 전투 참가자</title>
  <style>
    :root{
      /* 네이비-골드 고정 테마 */
      --gold-1:#DCC7A2; --gold-2:#D4BA8D;
      --bg-0:#0f1216; --bg-1:#141922; --bg-2:#1b2230;
      --text:#e5e7eb; --muted:#9aa4b2; --border:#262b36;
      --btn-bg:#0b0d10; --btn-border:#D4BA8D; --btn-text:#DCC7A2;
    }
    body{margin:0; background:var(--bg-0); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Arial, Apple SD Gothic Neo, "맑은 고딕", sans-serif;}
    .wrap{max-width:1200px; margin:20px auto; padding:0 12px;}
    .cols{display:grid; grid-template-columns: 300px 1fr 340px; gap:14px;}
    @media (max-width: 1080px){ .cols{grid-template-columns: 1fr;} }

    .card{
      background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));
      border:1px solid var(--border); border-radius:14px; padding:14px;
      box-shadow:0 8px 20px rgba(0,0,0,.2); backdrop-filter: blur(6px);
    }
    .label{font-size:12px; color:var(--muted); margin-bottom:6px;}
    .row{display:flex; gap:8px; flex-wrap:wrap;}
    .grid{display:grid; gap:8px;}
    .g-2{grid-template-columns: repeat(2, 1fr);}

    .hpbar{height:12px; border-radius:6px; background:#3b2f1a; overflow:hidden; border:1px solid #6b5a3a}
    .hpbar > i{display:block; height:100%; width:0%;
      background: linear-gradient(90deg, #8c6b2e, #DCC7A2);}

    .btn{
      display:inline-flex; align-items:center; justify-content:center; height:36px; padding:0 10px;
      border-radius:10px; border:1px solid var(--btn-border); background:var(--btn-bg); color:var(--btn-text);
      font-weight:600; cursor:pointer; transition:transform .12s ease, box-shadow .12s ease;
      user-select:none; font-size:14px;
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 6px 16px rgba(220,199,162,.12);}
    .btn:disabled{opacity:.5; cursor:not-allowed;}

    .turnbox{display:flex; flex-direction:column; align-items:center; gap:10px;}

    .avatar{width:100%; aspect-ratio:4/3; background:#0c0f14; border:1px solid var(--border); border-radius:16px;
      display:flex; align-items:center; justify-content:center; overflow:hidden; margin-bottom:10px;}
    .avatar img{width:100%; height:100%; object-fit:contain;}

    .queue-title{
      text-align:center; font-weight:700;
      background:linear-gradient(90deg,#DCC7A2,#f5e6c9,#DCC7A2);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      background-size:200% 100%; animation: shimmer 3s linear infinite;
      margin-bottom:4px;
    }
    @keyframes shimmer { 0%{background-position:0% 0} 100%{background-position:200% 0} }
    .queue{display:flex; gap:10px; overflow:auto; padding:4px 2px; width:100%; justify-content:center; flex-wrap:wrap;}
    .qitem{width:54px; height:40px; border:1px solid var(--border); border-radius:8px; background:#0c0f14;
      display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative;}
    .qitem img{width:100%; height:100%; object-fit:contain;}
    .qitem .name{position:absolute; inset:auto 2px 2px 2px; font-size:10px; color:#c9ced7; text-align:center; background:rgba(0,0,0,.35); border-radius:4px;}
    .qitem.active{border-color:#D4BA8D; box-shadow:0 0 0 2px rgba(212,186,141,.25) inset;}

    .imgbox{width:100%; max-width:620px; aspect-ratio:4/3; background:#0c0f14; border:1px solid var(--border); border-radius:16px;
      display:flex; align-items:center; justify-content:center; overflow:hidden;}
    .imgbox img{width:100%; height:100%; object-fit:contain;}

    .log{height:170px; overflow:auto; background:var(--bg-1); border:1px solid var(--border); border-radius:10px; padding:8px; font-size:14px;}
    .chat{height:220px; overflow:auto; background:var(--bg-1); border:1px solid var(--border); border-radius:10px; padding:8px; font-size:14px;}
    .chatbox{display:flex; gap:6px; margin-top:6px;}
    .chatbox input{flex:1; height:36px; border-radius:10px; border:1px solid var(--border); background:var(--bg-2); color:var(--text); padding:0 10px; font-size:14px;}

    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center; z-index:50;}
    .sheet{background:var(--bg-1); border:1px solid var(--border); border-radius:12px; padding:16px; width:min(92vw, 560px);}
    .list{display:grid; gap:8px; margin-top:8px;}
    .target{display:flex; justify-content:space-between; align-items:center; border:1px solid var(--border); border-radius:10px; padding:8px;}
    .hidden{display:none !important;}

    .toast{position:fixed; top:16px; right:16px; background:rgba(255,255,255,.06); border:1px solid var(--border); border-radius:10px; padding:10px 12px; color:var(--text); box-shadow:0 10px 24px rgba(0,0,0,.22); z-index:1000; transform:translateX(320px); transition:transform .22s; font-size:12px}
    .toast.show{transform:translateX(0)}
  </style>
</head>
<body>
  <!-- 결과 배너(옵션) -->
  <div id="pyxis-result-banner" style="display:none"></div>

  <!-- 로그인(자동/수동 겸용) -->
  <div id="authOverlay" class="overlay">
    <div class="sheet">
      <div style="font-weight:700; margin-bottom:6px">전투 참가자 접속</div>
      <div id="authForm">
        <div class="grid g-2">
          <div>
            <div class="label">전투 ID</div>
            <input id="authBattle" placeholder="b_xxxxxxxx"/>
          </div>
          <div>
            <div class="label">팀</div>
            <select id="authTeam" style="width:100%; height:36px; border-radius:10px; border:1px solid var(--border); background:var(--bg-2); color:var(--text); padding:0 10px">
              <option value="A">A팀</option>
              <option value="B">B팀</option>
            </select>
          </div>
        </div>
        <div class="grid g-2" style="margin-top:8px">
          <div>
            <div class="label">이름</div>
            <input id="authName" placeholder="전투 참가자 이름"/>
          </div>
          <div>
            <div class="label">비밀번호</div>
            <input id="authToken" placeholder="비밀번호"/>
          </div>
        </div>
        <div class="row" style="justify-content:flex-end; margin-top:10px">
          <button id="btnAuth" class="btn">접속</button>
        </div>
        <div class="label" style="margin-top:8px">
          URL에 <code>?battle=...&name=...&team=A&token=...</code> 또는
          <code>?password=...</code> 파라미터가 있으면 자동 접속합니다.
        </div>
      </div>
      <div id="authPending" class="hidden">
        <div>자동 로그인 준비 중</div>
        <div style="color:#9aa4b2; font-size:12px; margin-top:6px">연결 완료 후 본 화면으로 전환됩니다.</div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="cols">
      <!-- 좌: 내 카드 + 아군/상대 목록 + 준비 버튼 -->
      <div class="card">
        <div class="avatar"><img id="meAvatar" alt=""></div>

        <div class="label">내 정보</div>
        <div id="meName" style="font-weight:700; margin-bottom:6px;">-</div>
        <div class="grid g-2">
          <div><div class="label">팀</div><div id="meTeam">-</div></div>
          <div><div class="label">HP</div><div id="meHp">-</div></div>
        </div>
        <div class="hpbar" style="margin-top:6px"><i id="meHpBar"></i></div>
        <div class="grid g-2" style="margin-top:10px">
          <div><div class="label">공격</div><div id="sAtk">-</div></div>
          <div><div class="label">방어</div><div id="sDef">-</div></div>
          <div><div class="label">행운</div><div id="sLuk">-</div></div>
          <div><div class="label">민첩</div><div id="sAgi">-</div></div>
        </div>

        <div class="label" style="margin-top:12px">아군</div>
        <div id="allyList" class="list"></div>

        <div class="label" style="margin-top:12px">상대</div>
        <div id="enemyList" class="list"></div>

        <div class="row" style="margin-top:12px; justify-content:flex-end">
          <button id="btnReady" class="btn">준비 완료</button>
        </div>
      </div>

      <!-- 중앙: 턴 정보/순서 큐/이미지/액션 -->
      <div class="card">
        <div class="turnbox" style="width:100%">
          <div id="turnTeam" style="font-weight:700;">현재 순서팀: -</div>

          <div class="queue-title">순서</div>
          <div id="queue" class="queue"></div>

          <div class="imgbox"><img id="turnImg" alt=""></div>

          <div id="turnTimer" class="label">-</div>

          <div class="row">
            <button id="btnAttack" class="btn" disabled>공격</button>
            <button id="btnDefend" class="btn" disabled>방어</button>
            <button id="btnDodge"  class="btn" disabled>회피</button>
            <button id="btnItem"   class="btn" disabled>아이템</button>
            <button id="btnPass"   class="btn" disabled>패스</button>
          </div>
        </div>
      </div>

      <!-- 우: 채팅/로그 -->
      <div class="card">
        <div class="label">채팅</div>
        <div id="chat" class="chat"></div>
        <div class="chatbox">
          <input id="chatMsg" placeholder="메시지 입력"/>
          <button id="btnSend" class="btn">보내기</button>
        </div>

        <div class="label" style="margin-top:12px">전투 로그</div>
        <div id="log" class="log"></div>
      </div>
    </div>
  </div>

  <!-- 타깃 선택 -->
  <div id="targetOverlay" class="overlay hidden">
    <div class="sheet">
      <div id="targetTitle" style="font-weight:700">대상 선택</div>
      <div id="targetList" class="list"></div>
      <div class="row" style="margin-top:10px; justify-content:flex-end">
        <button id="btnCancelTarget" class="btn">취소</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- 소켓 & 룰/이펙트/알림(룰 적용을 위해 공통 룰 모듈 로드) -->
  <script src="/socket.io/socket.io.js"></script>
  <script src="/assets/js/common-battle-rules.js"></script>
  <script src="/assets/js/effects.js"></script>
  <script src="/assets/js/notifications.js"></script>

  <!-- 전투 참가자 전용 스크립트(인라인: 통짜코드) -->
  <script>
  // ===== player.js (inline) =====
  const $  = (q,root=document)=>root.querySelector(q);
  const $$ = (q,root=document)=>[...root.querySelectorAll(q)];
  const el = (t,c)=>{ const n=document.createElement(t); if(c) n.className=c; return n; };
  const escapeHtml = (s)=> String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m]));

  // URL 파라미터
  const params   = new URLSearchParams(location.search);
  let battleId   = params.get('battle') || '';
  let myName     = params.get('name')   || '';
  let otp        = params.get('token')  || params.get('password') || '';
  let myTeamAB   = (params.get('team') || 'A').toUpperCase()==='B' ? 'B' : 'A';

  // 전역 상태
  let socket=null, me=null, lastSnap=null;
  let teamTimerHandle=null;
  const committedSet = new Set();
  let iCommittedThisPhase=false;
  let prevPhase='', prevTeamKey='';

  // UI refs
  const authOverlay = $('#authOverlay');
  const toastEl     = $('#toast');

  const meAvatar = $('#meAvatar');
  const meNameEl = $('#meName');
  const meTeamEl = $('#meTeam');
  const meHpEl   = $('#meHp');
  const meHpBar  = $('#meHpBar');

  const sAtk = $('#sAtk'), sDef = $('#sDef'), sLuk = $('#sLuk'), sAgi = $('#sAgi');

  const allyList  = $('#allyList') || $('#teamList');
  const enemyList = $('#enemyList');

  const btnReady  = $('#btnReady');

  const turnTeam  = $('#turnTeam');
  const queueEl   = $('#queue');
  const turnImg   = $('#turnImg');
  const turnTimer = $('#turnTimer');

  const btnAttack = $('#btnAttack');
  const btnDefend = $('#btnDefend');
  const btnDodge  = $('#btnDodge');
  const btnItem   = $('#btnItem');
  const btnPass   = $('#btnPass');

  const chatBox   = $('#chat');
  const chatMsg   = $('#chatMsg');
  const btnSend   = $('#btnSend');

  const logBox    = $('#log');

  const targetOverlay  = $('#targetOverlay');
  const targetTitle    = $('#targetTitle');
  const targetList     = $('#targetList');
  const btnCancelTarget= $('#btnCancelTarget');

  // 유틸
  function toast(msg){
    if(!toastEl) return;
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(()=>toastEl.classList.remove('show'), 1600);
  }
  function teamKey(t){ return (String(t).toLowerCase()==='eaters') ? 'eaters' : 'phoenix'; }
  function toAB(t){
    const s = String(t||'').toLowerCase();
    if(s==='phoenix' || s==='a') return 'A';
    if(s==='eaters'  || s==='b' || s==='death') return 'B';
    return '';
  }
  function setEnabled(node, on){ if(node) node.disabled = !on; }

  // 소켓 연결/인증
  function connect(){
    if(socket){ try{ socket.disconnect(); }catch(_){} }
    socket = io(window.location.origin, {
      path:'/socket.io', transports:['websocket','polling'], withCredentials:true, timeout:20000
    });

    // 알림 초기화(룰은 서버와 동일, 알림은 내 턴/상태 전이에 반응)
    window.PyxisNotify?.init({ socket, enabled:true, volume:0.6 });

    socket.on('connect', ()=>{
      socket.emit('playerAuth', { battleId, name: myName, token: otp, team: myTeamAB });
    });

    socket.on('authSuccess', (p)=>{
      me = p?.player || { id: p?.playerId, name: myName, team: myTeamAB };
      window.__PYXIS_PLAYER_ID = me?.id || null; // 알림용
      authOverlay?.classList.add('hidden');
      toast('접속 완료');
    });
    socket.on('auth:success', ({ battle, player })=>{
      me = player || me;
      window.__PYXIS_PLAYER_ID = me?.id || null;
      authOverlay?.classList.add('hidden');
      toast('접속 완료');
      if(battle) renderAll(battle);
    });

    socket.on('authError', ({error})=>{
      authOverlay?.classList.remove('hidden');
      authOverlay.querySelector('.sheet').innerHTML =
        `<div>인증 실패</div><div style="color:#9aa4b2; font-size:12px; margin-top:6px">${error||'오류'}</div>`;
    });

    // 상태 갱신
    socket.on('battleUpdate', renderAll);
    socket.on('battle:update', (snap)=>{
      if(prevPhase!==snap.phase || prevTeamKey!==snap.currentTeam){
        committedSet.clear();
        iCommittedThisPhase=false;
        prevPhase=snap.phase;
        prevTeamKey=snap.currentTeam;
      }
      lastSnap=snap;

      const newerMe = (snap.players||[]).find(p=>p.id===me?.id);
      if(newerMe) me=newerMe;

      renderAll(snap);

      if(snap.status==='ended'){
        const winAB = (snap.winnerTeam==='eaters') ? 'B' : 'A';
        window.PyxisEffects?.showResultBanner(`${winAB}팀 승리`, 'win', 2000);
      }
    });

    // 액션 응답
    socket.on('actionSuccess', ({ battleId:bid, playerId, message })=>{
      if(!lastSnap || !me || bid!==lastSnap.id) return;
      committedSet.add(playerId);
      advanceQueueHighlight();
      if(message) appendLog(message);
    });
    socket.on('actionError', ({ battleId:bid, playerId, error })=>{
      if(!lastSnap || !me || bid!==lastSnap.id) return;
      if(playerId===me.id){
        iCommittedThisPhase=false;
        updateActionButtons();
        appendLog(`액션 오류: ${error||'오류'}`);
      }
    });

    // 채팅
    socket.on('chatMessage', (m)=> appendChat(m?.name || m?.senderName || '전투 참가자', m?.message || '') );
    socket.on('battle:chat', ({name:from,message})=> appendChat(from||'전투 참가자', message||'') );

    // 로그
    socket.on('cheerMessage', (m)=> appendLog(`[응원] ${m?.name || '관전자'}: ${m?.message || ''}`) );
    socket.on('battle:log', (m)=> appendLog(m?.message||'') );
  }

  // 렌더
  function renderAll(state){
    if(!state) return;
    lastSnap = state;

    const my = findMe(state);
    if(my){
      meAvatar && (meAvatar.src = my.avatar || '');
      meNameEl.textContent = my.name || '-';
      meTeamEl.textContent = toAB(my.team) || '-';
      const maxHp = my.maxHp ?? (window.PYXIS_RULES?.RULES?.MAX_HP || 100);
      meHpEl.textContent = `${my.hp ?? 0}/${maxHp}`;
      meHpBar.style.width = `${Math.max(0, Math.min(100, ((my.hp||0)/maxHp)*100))}%`;

      // 스탯 표기(1~5 룰 범위 내)
      const clamp = (n)=> Math.max(1, Math.min(5, Number(n||0)));
      sAtk.textContent = clamp(my.stats?.attack  ?? my.stats?.공격);
      sDef.textContent = clamp(my.stats?.defense ?? my.stats?.방어);
      sAgi.textContent = clamp(my.stats?.agility ?? my.stats?.민첩);
      sLuk.textContent = clamp(my.stats?.luck    ?? my.stats?.행운);
    }

    // 아군/상대
    if(allyList) allyList.innerHTML='';
    if(enemyList) enemyList.innerHTML='';

    const [A,B] = getTeams(state);
    const myAB = toAB(my?.team) || myTeamAB;
    const allies  = (myAB==='A') ? A : B;
    const enemies = (myAB==='A') ? B : A;

    const makeRow = (p)=>{
      const clamp = (n)=> Math.max(1, Math.min(5, Number(n||0)));
      const atk = clamp(p.stats?.attack  ?? p.stats?.공격);
      const def = clamp(p.stats?.defense ?? p.stats?.방어);
      const agi = clamp(p.stats?.agility ?? p.stats?.민첩);
      const luk = clamp(p.stats?.luck    ?? p.stats?.행운);
      const maxHp = p.maxHp ?? (window.PYXIS_RULES?.RULES?.MAX_HP || 100);
      const hpPct = Math.max(0, Math.min(100, ((p.hp||0)/maxHp)*100));
      const row = el('div','target');
      row.innerHTML = `
        <div style="display:flex; gap:10px; align-items:center">
          <div style="width:28px;height:28px;border:1px solid var(--border);border-radius:6px;background:#0c0f14;overflow:hidden">
            ${p.avatar ? `<img src="${p.avatar}" alt="" style="width:100%;height:100%;object-fit:cover">` : ''}
          </div>
          <div>
            <div style="font-weight:700">${escapeHtml(p.name)}</div>
            <div class="label">팀 ${toAB(p.team)} · HP ${p.hp}/${maxHp}</div>
            <div class="label">공 ${atk} · 방 ${def} · 민 ${agi} · 운 ${luk}</div>
          </div>
        </div>
        <div class="hpbar" style="width:140px"><i style="width:${hpPct}%"></i></div>
      `;
      return row;
    };

    allies.forEach(p=> allyList && allyList.appendChild(makeRow(p)));
    enemies.forEach(p=> enemyList && enemyList.appendChild(makeRow(p)));

    // 현재 순서팀
    const phaseAB =
      state.phaseTeam ? toAB(state.phaseTeam) :
      (state.turn && state.turn.order ? (state.turn.order[state.turn.phaseIndex||0]||'A') : 'A');
    turnTeam.textContent = `현재 순서팀: ${phaseAB}`;

    // 버튼 활성화
    const active  = (state.status==='active');
    const alive   = my && (my.hp||0)>0;
    const myTurn  = (phaseAB === toAB(my?.team));
    const enable  = active && alive && myTurn && !iCommittedThisPhase;

    [btnAttack,btnDefend,btnDodge,btnItem,btnPass].forEach(b=> setEnabled(b, enable));

    // 순서 큐
    renderQueue(state, phaseAB);

    // 팀 제한 타이머(5분)
    setupTeamTimer(state.turnStartTime);

    // 마지막 이벤트 텍스트
    if(state.lastEvent) appendLog(state.lastEvent);

    // 준비 버튼 상태
    if(btnReady){
      if(state.status==='waiting'){
        btnReady.disabled = !!my?.ready;
        btnReady.textContent = my?.ready ? '준비 완료됨' : '준비 완료';
      }else{
        btnReady.disabled = true;
      }
    }
  }

  function renderQueue(state, phaseAB){
    queueEl.innerHTML='';
    const [A,B] = getTeams(state);
    const cur = (phaseAB==='A') ? A : B;
    const alive = cur.filter(p=>(p.hp||0)>0);
    alive.forEach(p=>{
      const q = el('div','qitem');
      q.dataset.pid = p.id;
      q.innerHTML = `<img src="${p.avatar||''}" alt=""><div class="name">${escapeHtml(p.name)}</div>`;
      queueEl.appendChild(q);
    });
    advanceQueueHighlight();
    updateMainImageByQueue();
  }
  function advanceQueueHighlight(){
    const items = $$('.qitem', queueEl);
    let firstActive=false;
    items.forEach(el=>{
      const pid = el.dataset.pid;
      const done = committedSet.has(pid);
      if(done){ el.classList.remove('active'); return; }
      if(!firstActive){ el.classList.add('active'); firstActive=true; }
      else{ el.classList.remove('active'); }
    });
  }
  function updateMainImageByQueue(){
    const first = $('.qitem.active', queueEl) || $('.qitem', queueEl);
    const img = first?.querySelector('img')?.getAttribute('src') || '';
    if(turnImg) turnImg.src = img;
  }

  function setupTeamTimer(turnStartTime){
    if(teamTimerHandle) clearInterval(teamTimerHandle);
    const limitMs = 5*60*1000;
    const tick = ()=>{
      const remain = Math.max(0, limitMs - (Date.now() - (turnStartTime||0)));
      const m = Math.floor(remain/60000);
      const s = Math.floor((remain%60000)/1000);
      turnTimer.textContent = `팀 제한 시간 ${String(m)}:${String(s).padStart(2,'0')}`;
    };
    tick();
    teamTimerHandle = setInterval(tick, 500);
  }

  // 준비/액션
  btnReady?.addEventListener('click', ()=>{
    if(!battleId || !me || btnReady.disabled) return;
    socket?.emit('playerReady', { battleId, playerId: me.id, ready:true });
    socket?.emit('player:ready', { battleId, playerId: me.id });
    btnReady.disabled = true;
    btnReady.textContent = '준비 완료됨';
    toast('준비 완료 전송');
  });

  btnAttack?.addEventListener('click', ()=>{
    if(!canAct()) return;
    const enemies = getEnemiesAlive();
    openTargetPicker('attack', enemies);
  });
  btnDefend?.addEventListener('click', ()=>{
    if(!canAct()) return;
    // 룰 일치: 방어 성공 시 0 대미지(서버 계산). 여기선 액션만 커밋.
    commitAction({ type:'defend' });
  });
  btnDodge ?.addEventListener('click', ()=>{
    if(!canAct()) return;
    // 룰 일치: 회피 실패 시 최소 1 대미지(서버 계산). 여기선 액션만 커밋.
    commitAction({ type:'dodge' });
  });
  btnItem  ?.addEventListener('click', ()=>{
    if(!canAct()) return;
    openItemPicker();
  });
  btnPass  ?.addEventListener('click', ()=>{
    if(!canAct()) return;
    commitAction({ type:'pass' });
  });

  function canAct(){
    if(!lastSnap || !me) return false;
    const phaseAB =
      lastSnap.phaseTeam ? toAB(lastSnap.phaseTeam) :
      (lastSnap.turn && lastSnap.turn.order ? (lastSnap.turn.order[lastSnap.turn.phaseIndex||0]||'A') : 'A');
    const myTurn = (phaseAB === toAB(me.team));
    return lastSnap.status==='active' && (me.hp||0)>0 && myTurn && !iCommittedThisPhase;
  }

  function commitAction(action){
    if(!battleId || !me) return;
    iCommittedThisPhase=true;
    updateActionButtons();
    if(action.type==='attack'){
      socket?.emit('playerAction', { battleId, actorId: me.id, type:'attack', targetId: action.targetId });
      socket?.emit('player:action', { battleId, playerId: me.id, action:{ type:'attack', targetId: action.targetId }});
    }else if(action.type==='item'){
      const payload = { battleId, actorId: me.id, type:'item', itemType: action.itemType, targetId: action.targetId };
      socket?.emit('playerAction', payload);
      socket?.emit('player:action', { battleId, playerId: me.id, action:{ type:'item', itemType: action.itemType, targetId: action.targetId }});
    }else{
      socket?.emit('playerAction', { battleId, actorId: me.id, type: action.type });
      socket?.emit('player:action', { battleId, playerId: me.id, action:{ type: action.type }});
    }
    committedSet.add(me.id);
    advanceQueueHighlight();
  }

  function updateActionButtons(){
    const on = canAct();
    [btnAttack,btnDefend,btnDodge,btnItem,btnPass].forEach(b=> setEnabled(b, on));
  }

  // 타깃/아이템 선택
  btnCancelTarget?.addEventListener('click', ()=> hideTargetPicker());

  function openTargetPicker(kind, list){
    targetList.innerHTML='';
    targetTitle.textContent = (kind==='attack') ? '공격 대상 선택' : '대상 선택';
    if(!list || list.length===0){
      const d=el('div'); d.textContent='대상이 없습니다';
      targetList.appendChild(d);
    }else{
      list.forEach(p=>{
        const maxHp = p.maxHp ?? (window.PYXIS_RULES?.RULES?.MAX_HP || 100);
        const hpPct = Math.max(0, Math.min(100, ((p.hp||0)/maxHp)*100));
        const row = el('div','target');
        row.innerHTML = `
          <div>
            <div style="font-weight:700">${escapeHtml(p.name)}</div>
            <div class="label">HP ${p.hp}/${maxHp}</div>
          </div>
          <div class="hpbar" style="width:160px"><i style="width:${hpPct}%"></i></div>
        `;
        row.addEventListener('click', ()=>{
          hideTargetPicker();
          if(kind==='attack') commitAction({ type:'attack', targetId: p.id });
          else commitAction({ type:'item', itemType:'dittany', targetId: p.id }); // 디터니: +10HP(서버 룰)
        });
        targetList.appendChild(row);
      });
    }
    targetOverlay.classList.remove('hidden');
  }
  function hideTargetPicker(){ targetOverlay.classList.add('hidden'); targetList.innerHTML=''; }

  function openItemPicker(){
    targetList.innerHTML='';
    targetTitle.textContent = '아이템 사용';
    const mkBtn=(label, handler)=>{
      const row=el('div','target');
      row.innerHTML = `<div>${label}</div><button class="btn">사용</button>`;
      row.querySelector('.btn').addEventListener('click', handler);
      return row;
    };
    // 공격 보정기(해당 턴 ×1.5, 성공확률 10% — 서버 룰)
    targetList.appendChild(mkBtn('공격 보정기', ()=>{ hideTargetPicker(); commitAction({ type:'item', itemType:'attack_booster' }); }));
    // 방어 보정기(해당 턴 ×1.5, 성공확률 10% — 서버 룰)
    targetList.appendChild(mkBtn('방어 보정기', ()=>{ hideTargetPicker(); commitAction({ type:'item', itemType:'defense_booster' }); }));
    // 디터니(HP10 회복, 대상 선택 — 서버 룰)
    const allies = getAlliesAlive();
    targetList.appendChild(mkBtn('디터니 (대상 선택)', ()=>{ openTargetPicker('dittany', allies); }));
    targetOverlay.classList.remove('hidden');
  }

  // 팀/플레이어 조회
  function getTeams(state){
    if(state?.teams) return [ (state.teams.A?.players)||[], (state.teams.B?.players)||[] ];
    const arr = state?.players || [];
    return [ arr.filter(p=>toAB(p.team)==='A'), arr.filter(p=>toAB(p.team)==='B') ];
  }
  function findMe(state){
    const [A,B] = getTeams(state||lastSnap||{});
    const all = [...A,...B];
    return all.find(p=>p.id===me?.id) || all.find(p=>p.name===myName && toAB(p.team)===myTeamAB) || me;
  }

  // 로그/채팅
  function appendLog(msg){
    const d=document.createElement('div');
    d.textContent = normalizeLog(String(msg||''));
    logBox.appendChild(d);
    logBox.scrollTop = logBox.scrollHeight;
  }
  function normalizeLog(s){
    return s.replace(/\bphoenix\b/gi,'A팀').replace(/\beaters\b/gi,'B팀');
  }
  function appendChat(sender, text){
    const row = document.createElement('div');
    row.textContent = `${sender}: ${text}`;
    chatBox.appendChild(row);
    chatBox.scrollTop = chatBox.scrollHeight;
  }
  btnSend?.addEventListener('click', sendChat);
  chatMsg?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendChat(); } });
  function sendChat(){
    const text = chatMsg.value.trim(); if(!text) return;
    const nm = me?.name || myName || '전투 참가자';
    appendChat(nm, text);
    socket?.emit('chatMessage', { battleId, message: text });
    socket?.emit('chat:send', { battleId, name: nm, message: text, role:'player' });
    chatMsg.value='';
  }

  // 수동 로그인 버튼
  $('#btnAuth')?.addEventListener('click', ()=>{
    const b = $('#authBattle').value.trim();
    const n = $('#authName').value.trim();
    const t = $('#authToken').value.trim();
    const tm = ($('#authTeam').value || 'A').toUpperCase()==='B' ? 'B':'A';
    if(!b || !n || !t){ toast('모두 입력하세요'); return; }
    battleId=b; myName=n; otp=t; myTeamAB=tm;
    connect();
  });

  // URL 자동 접속
  (function tryAutoAuth(){
    if(battleId && myName && otp){
      $('#authForm')?.classList.add('hidden');
      $('#authPending')?.classList.remove('hidden');
      connect();
    }
  })();

  </script>
</body>
</html>
