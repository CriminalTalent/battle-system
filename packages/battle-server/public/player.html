<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PYXIS - 플레이어</title>
  <script src="/socket.io/socket.io.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --deep-navy:#0A0F1A;--dark-blue:#0C1221;--mid-blue:#1E2A47;--light-blue:#3D5A80;
      --gold:#DCC7A2;--gold-bright:#E6D2A8;--gold-shimmer:#F0E6C8;
      --text:#F8F9FA;--text-accent:#E9ECEF;--text-muted:#ADB5BD;
      --glass-1:rgba(30,42,71,.3);--glass-2:rgba(30,42,71,.5);
      --border:rgba(61,90,128,.4);--border-light:rgba(61,90,128,.6);
      --blur-light:blur(10px);--transition-fast:.2s ease-out;--radius:12px;
      --shadow-soft:0 4px 6px rgba(0,0,0,.1);--shadow-medium:0 8px 15px rgba(0,0,0,.2);
      --serif:'Cinzel',serif;--success:#27AE60;--danger:#E74C3C;--info:#3498DB;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{font-family:var(--serif);background:linear-gradient(135deg,var(--deep-navy) 0%,var(--dark-blue) 100%);color:var(--text);min-height:100vh}
    .wrap{max-width:960px;margin:0 auto;padding:20px}
    .card{background:var(--glass-2);backdrop-filter:var(--blur-light);border:1px solid var(--border);border-radius:var(--radius);padding:16px 18px;box-shadow:var(--shadow-soft)}
    .title{font-size:20px;font-weight:800;color:var(--gold-bright);margin:6px 0 16px;text-transform:uppercase;letter-spacing:1px}
    .row{display:grid;gap:10px}
    .row2{grid-template-columns:1fr 1fr}
    .row3{grid-template-columns:1fr 1fr 1fr}
    .field label{display:block;font-size:12px;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
    .field input{width:100%;padding:10px 12px;background:var(--glass-1);border:1px solid var(--border);border-radius:10px;color:var(--text)}
    .field input:focus{outline:none;border-color:var(--gold)}
    .btn{padding:10px 14px;border:none;border-radius:10px;background:linear-gradient(135deg,var(--gold),var(--gold-bright));color:#0A0F1A;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .status{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text-muted);margin-bottom:14px}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--danger)}
    .dot.on{background:var(--success)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
    .panel{background:var(--glass-2);border:1px solid var(--border);border-radius:10px;padding:12px}
    .panel h3{font-size:14px;color:var(--gold-bright);margin-bottom:8px}
    .list{height:220px;overflow:auto;background:var(--glass-1);border:1px solid var(--border);border-radius:10px;padding:10px}
    .log{font-size:12px;color:var(--text-accent);margin-bottom:6px}
    .chat-messages{height:180px;overflow:auto;background:var(--glass-1);border:1px solid var(--border);border-radius:10px;padding:10px;margin-bottom:8px}
    .chat-entry{font-size:12px;line-height:1.4;margin-bottom:6px}
    .chat-entry .name{color:var(--gold)}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:var(--glass-1);border:1px solid var(--border);font-size:11px;color:var(--text-accent)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="status">
    <span>연결 상태</span>
    <span id="connDot" class="dot"></span>
    <span id="connText">연결 끊김</span>
    <span id="battleMini" class="pill" style="display:none;"></span>
  </div>

  <div class="card" id="joinCard">
    <div class="title">전투 참가</div>
    <div class="row row3">
      <div class="field">
        <label>전투 ID (battle)</label>
        <input id="inpBattle" placeholder="battle_xxxxxxxx" />
      </div>
      <div class="field">
        <label>이름 (name)</label>
        <input id="inpName" placeholder="플레이어 이름" maxlength="20" />
      </div>
      <div class="field">
        <label>비밀번호/토큰 (token|password|otp)</label>
        <input id="inpToken" placeholder="초대 링크의 token" />
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btnJoin" class="btn">입장</button>
    </div>
    <div style="font-size:12px;color:var(--text-muted);margin-top:8px;">
      링크로 접속했다면 URL의 <code>?battle=...&token=...</code> 값을 자동으로 채웁니다.
    </div>
  </div>

  <div class="grid" id="playArea" style="display:none;">
    <div class="panel">
      <h3>내 정보</h3>
      <div id="meBox" style="font-size:14px;line-height:1.6;"></div>
      <div style="margin-top:6px;font-size:12px;color:var(--text-muted);">
        전투 상태: <span id="battleStatusTxt">-</span>
      </div>
    </div>
    <div class="panel">
      <h3>채팅</h3>
      <div id="chatMessages" class="chat-messages"></div>
      <div style="display:flex;gap:8px;">
        <input id="chatInput" placeholder="메시지 입력..." class="field-input" style="flex:1;padding:10px 12px;background:var(--glass-1);border:1px solid var(--border);border-radius:10px;color:var(--text)"/>
        <button id="btnSend" class="btn">전송</button>
      </div>
    </div>
    <div class="panel" style="grid-column:1 / -1;">
      <h3>알림</h3>
      <div id="logs" class="list"></div>
    </div>
  </div>
</div>

<script>
  const $ = (q) => document.querySelector(q);

  // UI refs
  const connDot = $('#connDot');
  const connText = $('#connText');
  const battleMini = $('#battleMini');

  const joinCard = $('#joinCard');
  const playArea = $('#playArea');

  const inpBattle = $('#inpBattle');
  const inpName = $('#inpName');
  const inpToken = $('#inpToken');
  const btnJoin = $('#btnJoin');

  const meBox = $('#meBox');
  const battleStatusTxt = $('#battleStatusTxt');

  const chatMessages = $('#chatMessages');
  const chatInput = $('#chatInput');
  const btnSend = $('#btnSend');

  const logs = $('#logs');

  // state
  let socket = null;
  let battleId = null;
  let me = null;

  function addLog(text) {
    const el = document.createElement('div');
    el.className = 'log';
    el.textContent = `[${new Date().toLocaleTimeString('ko-KR',{hour12:false,hour:'2-digit',minute:'2-digit'})}] ${text}`;
    logs.appendChild(el);
    logs.scrollTop = logs.scrollHeight;
    while (logs.children.length > 300) logs.removeChild(logs.firstChild);
  }

  function addChat(name, message) {
    const el = document.createElement('div');
    el.className = 'chat-entry';
    el.innerHTML = `<span class="name">${name ? String(name).replace(/[&<>"']/g,s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s])) : '익명'}</span>: ${String(message||'').replace(/[&<>"']/g,s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s]))}`;
    chatMessages.appendChild(el);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    while (chatMessages.children.length > 200) chatMessages.removeChild(chatMessages.firstChild);
  }

  function updateMeBox() {
    if (!me) { meBox.textContent = '-'; return; }
    const s = me.stats || {};
    meBox.innerHTML = `
      <div><b>${me.name}</b> (${me.team || 'A'}팀)</div>
      <div>HP: ${me.hp}/${me.maxHp || 100}</div>
      <div>공:${s.attack||0} 방:${s.defense||0} 민:${s.agility||0} 행:${s.luck||0}</div>
    `;
  }

  function onBattleUpdate(data) {
    if (!data) return;
    battleStatusTxt.textContent = data.status || '-';
    if (Array.isArray(data.players) && me) {
      const mine = data.players.find(p => p.id === me.id);
      if (mine) { me = { ...me, ...mine }; updateMeBox(); }
    }
  }

  function connectSocket() {
    socket = window.io ? window.io() : null;
    if (!socket) return;

    socket.on('connect', () => {
      connText.textContent = '연결됨';
      connDot.classList.add('on');
      addLog('서버에 연결되었습니다.');
      if (battleId) socket.emit('join', { battleId });
    });

    socket.on('disconnect', () => {
      connText.textContent = '연결 끊김';
      connDot.classList.remove('on');
      addLog('서버 연결이 끊어졌습니다.');
    });

    socket.on('battleUpdate', onBattleUpdate);
    socket.on('battle:update', onBattleUpdate);

    socket.on('chatMessage', (d) => addChat(d.name || '익명', d.message || ''));
    socket.on('battle:chat', (d) => addChat(d.name || d.senderName || '익명', d.message || ''));

    socket.on('battle:log', (entry) => {
      // 플레이어에게 필요한 시스템 알림만 간단히 출력
      if (!entry) return;
      if (entry.type === 'system' || entry.type === 'admin') addLog(entry.message || '알림');
    });
  }

  function tryAuth(battleIdParam, nameParam, tokenParam) {
    if (!socket || !socket.connected) {
      addLog('소켓이 아직 연결되지 않았습니다.');
      return;
    }
    if (!battleIdParam || !tokenParam) {
      addLog('전투 ID 또는 토큰이 없습니다.');
      return;
    }

    socket.emit('playerAuth', {
      battleId: battleIdParam,
      token: tokenParam,
      password: tokenParam,
      otp: tokenParam,
      playerName: nameParam || ''
    }, (res) => {
      if (!res || !res.ok) {
        addLog(`인증 실패: ${res?.message || res?.error || '인증 오류'}`);
        return;
      }
      addLog('인증 성공, 전투에 참가했습니다.');
      me = res.playerData;
      updateMeBox();
      joinCard.style.display = 'none';
      playArea.style.display = 'grid';
    });
  }

  btnJoin.addEventListener('click', () => {
    const b = inpBattle.value.trim();
    const n = inpName.value.trim();
    const t = inpToken.value.trim();
    if (!b || !t) { addLog('전투 ID와 토큰을 입력하세요.'); return; }
    battleId = b;
    battleMini.textContent = battleId;
    battleMini.style.display = 'inline-block';
    if (socket && socket.connected) socket.emit('join', { battleId });
    tryAuth(battleId, n, t);
  });

  btnSend.addEventListener('click', () => {
    const msg = chatInput.value.trim();
    if (!msg || !socket || !battleId) return;
    socket.emit('chatMessage', { battleId, name: (me && me.name) || '플레이어', message: msg });
    socket.emit('battle:chat', { battleId, name: (me && me.name) || '플레이어', senderName: (me && me.name) || '플레이어', message: msg });
    chatInput.value = '';
  });
  chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') btnSend.click(); });

  // URL 파라미터 자동 채움 & 자동 시도
  (function bootstrapFromQuery(){
    const q = new URLSearchParams(location.search);
    const b = q.get('battle') || '';
    const n = q.get('name') || '';
    const t = q.get('token') || q.get('password') || q.get('otp') || '';

    if (b) { inpBattle.value = b; battleId = b; battleMini.textContent = b; battleMini.style.display='inline-block'; }
    if (n) inpName.value = n;
    if (t) inpToken.value = t;

    connectSocket();

    // 파라미터가 충분하면 자동 인증 시도
    if (b && t) {
      // 소켓이 연결된 다음 시도하도록 약간 지연
      const tryLater = () => {
        if (socket && socket.connected) {
          socket.emit('join', { battleId });
          tryAuth(b, n, t);
        } else {
          setTimeout(tryLater, 120);
        }
      };
      tryLater();
    }
  })();
</script>
</body>
</html>
