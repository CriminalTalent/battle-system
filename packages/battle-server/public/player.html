<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PYXIS - 전투 참가자</title>
<style>
  :root{
    --deep:#000813; --gold:#DCC7A2; --gold2:#D4BA8D; --text:#fff; --muted:rgba(255,255,255,.75);
    --glass1:rgba(0,8,19,.7); --glass2:rgba(0,8,19,.5); --br:6px; --bd:rgba(220,199,162,.3);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:linear-gradient(135deg,var(--deep) 0%,#001122 100%);color:var(--text);font-family:'Cinzel',serif;min-height:100vh}
  header{padding:16px 12px;border-bottom:1px solid var(--bd);background:var(--glass1);backdrop-filter:blur(10px)}
  h1{color:var(--gold);letter-spacing:.12em;text-shadow:0 0 18px rgba(220,199,162,.45);font-size:1.8rem}
  .wrap{max-width:1300px;margin:0 auto;padding:18px}
  .grid{display:grid;grid-template-columns:1fr 1.2fr 1fr;gap:18px;align-items:start}
  .card{background:var(--glass1);border:1px solid var(--bd);border-radius:var(--br);padding:14px}
  .section-title{color:var(--gold);font-size:1.05rem;margin-bottom:10px}
  .me{display:flex;gap:14px;align-items:center}
  .me img{width:64px;height:64px;border-radius:50%;border:2px solid var(--gold);object-fit:cover}
  .pill{background:var(--gold);color:#111;border-radius:999px;padding:2px 10px;font-weight:700;font-size:.75rem}
  .hpbar{height:10px;border:1px solid var(--bd);border-radius:8px;background:#000b1a;overflow:hidden}
  .hpfill{height:100%;background:linear-gradient(90deg,#4ade80,#22c55e)}
  .stats{color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:.8rem}
  .teams{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .team-title{color:var(--gold);font-weight:700;margin-bottom:6px}
  .pcard{background:var(--glass2);border:1px solid var(--bd);border-radius:8px;padding:10px;margin-bottom:8px}
  .prow{display:flex;gap:10px;align-items:center}
  .prow img{width:40px;height:40px;border-radius:50%;border:2px solid var(--gold);object-fit:cover}
  .pname{color:var(--gold);font-weight:700;font-size:.9rem}
  .hptext{font-size:.72rem;color:var(--muted)}
  .center{display:grid;gap:10px;justify-items:center;text-align:center}
  .turn{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#111;border-radius:10px;padding:6px 10px;font-weight:900}
  .bigface{width:140px;height:140px;border-radius:50%;border:3px solid var(--gold);object-fit:cover;background:#000}
  .row{display:flex;gap:8px;align-items:center;justify-content:center}
  .btn{cursor:pointer;border:none;border-radius:8px;padding:10px 12px;font-weight:800}
  .btn.ready{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#111}
  .btn.disabled{background:#111;color:#777;pointer-events:none}
  .chat{display:grid;grid-template-columns:1fr auto;gap:8px}
  .chat input{background:#000b1a;color:#fff;border:1px solid var(--bd);border-radius:8px;padding:10px}
  .btn.send{background:transparent;border:1px solid var(--bd);color:var(--text)}
  .logs{max-height:260px;overflow:auto;background:var(--glass2);border:1px solid var(--bd);border-radius:8px;padding:10px}
  .log{font-size:.9rem;margin-bottom:6px}
  .log .t{color:#000;background:var(--gold);border-radius:4px;padding:0 4px;margin-right:6px;font-size:.8rem;font-weight:700}
  .log.rule{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#111;border-radius:6px;padding:6px 8px}
  @media (max-width:1100px){.grid{grid-template-columns:1fr}.center{order:-1}}
</style>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
<header><h1>PYXIS</h1></header>
<div class="wrap">
  <div class="grid">
    <!-- 좌: 내 정보 + 팀 요약 -->
    <div class="card">
      <div class="section-title">내 정보</div>
      <div class="me">
        <img id="meAvatar" src="/uploads/avatars/default.svg" alt="내 초상화" onerror="this.src='/uploads/avatars/default.svg'">
        <div>
          <div><span id="meName">-</span> <span class="pill" id="meTeam">-팀</span></div>
          <div class="hpbar"><div id="meHpFill" class="hpfill" style="width:0%"></div></div>
          <div class="row" style="justify-content:space-between">
            <span class="hptext" id="meHpText">0/0</span>
            <span class="stats" id="meStats">공- 방- 민- 행-</span>
          </div>
        </div>
      </div>
      <div style="margin:12px 0" class="row">
        <button id="btnReady" class="btn ready">준비 완료</button>
      </div>
      <div class="section-title" style="margin-top:10px">팀 요약</div>
      <div class="teams">
        <div>
          <div class="team-title">A</div>
          <div id="teamA"></div>
        </div>
        <div>
          <div class="team-title">B</div>
          <div id="teamB"></div>
        </div>
      </div>
    </div>

    <!-- 중앙: 현재 턴/카운트다운/큰 초상화 -->
    <div class="card center">
      <div class="turn"><span id="turnTeam">현재 턴: -팀</span> · <span id="turnRound">라운드 0</span> · <span id="turnTimer">--:--</span></div>
      <img id="turnAvatar" class="bigface" src="/uploads/avatars/default.svg" alt="현재 턴 초상화" onerror="this.src='/uploads/avatars/default.svg'">
    </div>

    <!-- 우: 채팅 & 로그 -->
    <div class="card">
      <div class="section-title">채팅</div>
      <div class="chat" style="margin-bottom:12px">
        <input id="chatInput" type="text" placeholder="메시지 입력...">
        <button id="btnSend" class="btn send">전송</button>
      </div>
      <div class="section-title">실시간 로그</div>
      <div id="logs" class="logs"></div>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
(function(){
  const socket = io({ path:'/socket.io' });

  // ===== URL 파라미터 =====
  const qs = new URL(location.href).searchParams;
  const battleId = qs.get('battle') || '';
  const token    = qs.get('token') || qs.get('password') || qs.get('otp') || '';
  const playerIdParam = qs.get('playerId') || '';
  const playerNameParam = qs.get('name') || '';

  // ===== 상태 =====
  let me = null;           // { id, name, team, avatar, ... }
  let readySent = false;
  let lastSnapshot = null;
  let timerTick = null;

  // ===== 유틸 =====
  const $ = (id)=>document.getElementById(id);
  const esc = (t)=>String(t||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const fmtT = ()=> new Date().toLocaleTimeString('ko-KR',{hour12:false,hour:'2-digit',minute:'2-digit'});
  const setImg = (el, url)=>{ el.src = url || '/uploads/avatars/default.svg'; };
  const pct = (a,b)=> b>0? Math.max(0,Math.min(100, Math.round(a*100/b))):0;
  const mmss = (s)=> {
    if (s==null) return '--:--';
    s = Math.max(0, s|0);
    const m = String(Math.floor(s/60)).padStart(2,'0');
    const x = String(s%60).padStart(2,'0');
    return `${m}:${x}`;
  };

  function addLog(msg, cls){
    const box = $('logs'); if(!box) return;
    const el = document.createElement('div');
    el.className = `log ${cls||''}`.trim();
    el.innerHTML = `<span class="t">${fmtT()}</span>${esc(msg)}`;
    box.appendChild(el); box.scrollTop = box.scrollHeight;
  }

  // ===== 팀 렌더(HP바 + 스탯) =====
  function renderTeams(players){
    const A = $('teamA'), B = $('teamB'); A.innerHTML=''; B.innerHTML='';
    (players||[]).forEach(p=>{
      const hpP = pct(p.hp||0, p.maxHp||100);
      const div = document.createElement('div');
      div.className = 'pcard';
      div.innerHTML = `
        <div class="prow">
          <img src="${esc(p.avatar||'/uploads/avatars/default.svg')}" onerror="this.src='/uploads/avatars/default.svg'" alt="${esc(p.name)}">
          <div style="flex:1">
            <div class="pname">${esc(p.name)}</div>
            <div class="hpbar" style="margin:3px 0 2px"><div class="hpfill" style="width:${hpP}%"></div></div>
            <div class="row" style="justify-content:space-between">
              <span class="hptext">${p.hp||0}/${p.maxHp||100}</span>
              <span class="stats">공:${p.stats?.attack||1} 방:${p.stats?.defense||1} 민:${p.stats?.agility||1} 행:${p.stats?.luck||1}</span>
            </div>
          </div>
        </div>`;
      (p.team==='A'?A:B).appendChild(div);
    });
  }

  // ===== 내 정보 렌더 =====
  function renderMe(players){
    if (!me) return;
    const p = (players||[]).find(x=>x.id===me.id) || me;
    me = {...me, ...p};

    $('meName').textContent = me.name || '-';
    $('meTeam').textContent = (me.team||'-') + '팀';
    setImg($('meAvatar'), me.avatar);
    const hpP = pct(me.hp||0, me.maxHp||100);
    $('meHpFill').style.width = hpP + '%';
    $('meHpText').textContent = `${me.hp||0}/${me.maxHp||100}`;
    $('meStats').textContent = `공:${me.stats?.attack||1} 방:${me.stats?.defense||1} 민:${me.stats?.agility||1} 행:${me.stats?.luck||1}`;
  }

  // ===== 현재 턴/타이머/큰 초상화 =====
  function renderTurn(b){
    const curTeam = b?.currentTurn?.currentTeam || '-';
    const round   = b?.currentTurn?.turnNumber || 0;
    $('turnTeam').textContent  = `현재 턴: ${curTeam}팀`;
    $('turnRound').textContent = `라운드 ${round}`;

    const cp = b?.currentTurn?.currentPlayer;
    setImg($('turnAvatar'), cp?.avatar);

    if (timerTick) { clearInterval(timerTick); timerTick=null; }
    let left = b?.currentTurn?.timeLeftSec;
    $('turnTimer').textContent = mmss(left);
    if (b?.status==='active' && typeof left==='number'){
      timerTick = setInterval(()=>{
        left = Math.max(0,(left|0)-1);
        $('turnTimer').textContent = mmss(left);
        if (left<=0) { clearInterval(timerTick); timerTick=null; }
      },1000);
    }
  }

  // ===== 소켓 수신 =====
  const onSnapshot = (snap)=>{
    lastSnapshot = snap;
    renderTeams(snap.players||[]);
    renderMe(snap.players||[]);
    renderTurn(snap);
  };
  socket.on('battleUpdate', onSnapshot);
  socket.on('battle:update', onSnapshot); // 호환

  const onLog = (p)=>{
    const msg = p?.message||''; const type=p?.type||'info';
    if (!msg) return;
    if (/·\s*attack\s*\(/i.test(msg)) return; // 상세 계산 로그 숨김
    addLog(msg, type==='battle'?'rule':'');
  };
  socket.on('battle:log', onLog);
  socket.on('battleLog', onLog);

  // ===== 참가자 인증 =====
  socket.on('authSuccess', onAuthSuccess);
  socket.on('auth:success', onAuthSuccess);
  socket.on('authError', ()=> addLog('인증 실패','error'));

  function onAuthSuccess(payload){
    // payload: { ok,true, playerId,name,team,avatar, battle }
    me = { id: payload.playerId, name: payload.name, team: payload.team, avatar: payload.avatar };
    addLog(`${me.name} 인증 완료`);
    if (payload?.battle) onSnapshot(payload.battle);
    socket.emit('join', { battleId }); // 방 재확인
  }

  // ===== 준비 완료 (단일 송신) =====
  $('btnReady').addEventListener('click', ()=>{
    if (!battleId || !me || readySent) return;
    readySent = true;
    $('btnReady').classList.add('disabled');
    socket.emit('player:ready', { battleId, playerId: me.id }, (r)=>{
      if (r?.ok) addLog('준비 완료 전송');
      else { readySent=false; $('btnReady').classList.remove('disabled'); addLog('준비 완료 실패','error'); }
    });
  });

  // ===== 채팅 송신 (내 이름으로, emit은 chatMessage 하나만) =====
  function sendChat(){
    if (!battleId || !me) return;
    const msg = $('chatInput').value.trim(); if (!msg) return;
    socket.emit('chatMessage', { battleId, name: me.name || '전투 참가자', message: msg });
    $('chatInput').value='';
  }
  $('btnSend').addEventListener('click', sendChat);
  $('chatInput').addEventListener('keydown', (e)=>{ if (e.key==='Enter') sendChat(); });

  // ===== 초기화 =====
  if (battleId){
    socket.emit('join', { battleId });
    socket.emit('playerAuth', { battleId, token, playerId: playerIdParam, playerName: playerNameParam }, (ack)=>{
      if (!ack?.ok) addLog('인증 확인 중...', '');
    });
  } else {
    addLog('전투 ID가 없습니다(?battle=...)', 'error');
  }
})();
</script>
</body>
</html>
