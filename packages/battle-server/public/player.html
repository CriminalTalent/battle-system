<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>PYXIS - 전투 참가자</title>
<script src="/socket.io/socket.io.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#0e0e0e; --bg2:#141414;
    --glass-1:rgba(0,0,0,.7); --glass-2:rgba(0,0,0,.5);
    --border:rgba(220,199,162,.3);
    --text:#F8F9FA; --muted:#A9AFB6;
    --gold:#DCC7A2; --gold2:#E6D2A8;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --shadow:0 10px 30px rgba(0,0,0,.45);
    --team-a-color:#8b5757; --team-b-color:#5d6b8d;
    --result-bg:#DCC7A2; --result-text:#000;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:linear-gradient(135deg,#000813,#001122);color:var(--text);font-family:system-ui,-apple-system,sans-serif;min-height:100vh;padding:8px}
  body.battle-ended{overflow:hidden}
  .container{max-width:1400px;margin:0 auto}
  .header{text-align:center;padding:16px;font-family:Cinzel,serif;color:var(--gold);font-size:24px;letter-spacing:.1em}
  .main-grid{display:grid;gap:12px;grid-template-columns:1fr;}
  @media (min-width:768px){.main-grid{grid-template-columns:1fr 2fr 1fr}}
  .team-container{background:var(--glass-1);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:var(--shadow);height:fit-content}
  .team-title{font-family:Cinzel,serif;color:var(--gold);font-weight:700;letter-spacing:.08em;margin-bottom:12px;font-size:16px;text-align:center}
  .center-section{display:flex;flex-direction:column;gap:12px}
  .card{background:var(--glass-1);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:var(--shadow)}
  .title{font-family:Cinzel,serif;color:var(--gold);font-weight:700;letter-spacing:.08em;margin-bottom:8px;font-size:14px}
  .player-card{background:var(--glass-2);border:1px solid var(--border);border-radius:8px;padding:8px;margin-bottom:8px;display:flex;align-items:center;gap:8px}
  .player-card.dead{opacity:.5}
  .player-avatar{width:32px;height:32px;border-radius:50%;object-fit:cover;border:1px solid var(--gold)}
  .player-info{flex:1;min-width:0}
  .player-name{font-size:12px;font-weight:600;color:var(--gold);margin-bottom:2px}
  .player-team{font-size:10px;color:var(--muted);margin-bottom:4px}
  .hp{height:6px;background:#0b0b0b;border:1px solid var(--border);border-radius:999px;overflow:hidden;margin-bottom:2px}
  .hp>span{display:block;height:100%;background:linear-gradient(90deg,#4ade80,#22c55e);transition:width .3s}
  .hp-text{font-size:10px;color:var(--muted);margin-bottom:2px}
  .stats{font-size:10px;color:var(--muted)}
  .items-info{font-size:9px;color:var(--text);margin-top:2px}
  .ready-status{font-size:9px;color:var(--gold);margin-top:2px}

  .battle-main{text-align:center}
  .current-player-info{background:var(--glass-2);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px}
  .current-avatar{width:100px;height:100px;border-radius:16px;object-fit:cover;border:4px solid var(--gold);margin-bottom:12px}
  .turn-info{font-size:16px;margin-bottom:8px;color:var(--text);font-weight:600}
  .timer-display{color:var(--gold);font-size:32px;margin-bottom:8px;font-weight:700}
  .timer-seconds{font-size:14px;color:var(--muted);margin-bottom:16px}
  
  .my-info-section{background:var(--glass-2);border:1px solid var(--border);border-radius:8px;padding:8px;margin-bottom:12px}
  .my-info-header{display:flex;align-items:center;gap:6px;margin-bottom:6px}
  .my-avatar{width:32px;height:32px;border-radius:50%;object-fit:cover;border:2px solid var(--gold)}
  .my-details{flex:1}
  .my-name{font-weight:600;color:var(--gold);font-size:12px}
  .my-team{font-size:10px;color:var(--muted)}
  .my-hp-bar{height:6px;background:#0b0b0b;border:1px solid var(--border);border-radius:999px;overflow:hidden;margin:2px 0}
  .my-hp-fill{height:100%;background:linear-gradient(90deg,#4ade80,#22c55e);transition:width .3s}
  .my-hp-text{font-size:9px;color:var(--muted);margin-bottom:2px}
  .my-stats{font-size:9px;color:var(--muted);margin-bottom:2px}
  .my-items{font-size:8px;color:var(--text);margin-bottom:6px}
  .ready-btn{background:#000;color:var(--gold);border:2px solid var(--gold);padding:6px 12px;border-radius:6px;font-weight:600;cursor:pointer;transition:all .2s;width:100%;font-size:10px}
  .ready-btn:hover:not(.done){background:var(--gold);color:#000}
  .ready-btn.done{background:var(--muted);border-color:var(--muted);color:#666;cursor:not-allowed}
  
  .actions{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin:16px 0}
  .act{background:var(--glass-2);color:var(--text);border:1px solid var(--border);padding:12px 6px;border-radius:8px;font-size:14px;cursor:pointer;transition:all .2s}
  .act:hover:not(:disabled){background:var(--gold2);color:#000}
  .act:disabled{opacity:.4;cursor:not-allowed}
  
  .logs-section{height:400px;overflow-y:auto;background:var(--glass-2);border:1px solid var(--border);padding:8px;border-radius:8px;margin-bottom:12px}
  .chat-section{height:400px;overflow-y:auto;background:var(--glass-2);border:1px solid var(--border);padding:8px;border-radius:8px;margin-bottom:8px}
  .log-item{margin-bottom:4px;font-size:11px;line-height:1.4;padding:2px 4px;border-radius:4px}
  .log-time{color:var(--gold);font-weight:600} /* 가독성 개선 */
  .chat-item{margin-bottom:4px;font-size:11px}
  .chat-name{color:var(--gold);font-weight:600}
  .input-group{display:flex;gap:4px}
  .chat-input{flex:1;background:var(--glass-2);border:1px solid var(--border);color:var(--text);padding:6px 8px;border-radius:6px;font-size:11px}
  .send-btn{background:var(--gold);color:#000;border:none;padding:6px 12px;border-radius:6px;font-size:11px;cursor:pointer;font-weight:600}

  .log-team-a{background-color:var(--team-a-color);color:var(--text)}
  .log-team-b{background-color:var(--team-b-color);color:var(--text)}
  .log-result{background-color:var(--result-bg);color:var(--result-text)}
  .log-notice{background-color:var(--glass-1);color:var(--gold)}
  .log-error{background-color:#000;color:var(--gold)}
  .log-system{background-color:transparent;color:var(--muted)}

  .game-over-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;z-index:9999;opacity:0;visibility:hidden;transition:all .3s}
  .game-over-overlay.show{opacity:1;visibility:visible}
  .game-over-content{text-align:center;background:var(--glass-1);border:2px solid var(--gold);border-radius:16px;padding:32px;max-width:400px;width:90%}
  .game-over-title{font-family:Cinzel,serif;font-size:28px;color:var(--gold);margin-bottom:16px}
  .winner-announcement{font-size:20px;margin-bottom:16px}
  .winner-team{color:var(--gold);font-weight:700;font-size:24px}
  .victory-message{color:var(--ok);font-size:18px;font-weight:600;margin-bottom:12px}
  .defeat-message{color:var(--bad);font-size:18px;font-weight:600;margin-bottom:12px}
  .game-over-message{color:var(--muted);font-size:14px}

  .action-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all .3s}
  .action-overlay.show{opacity:1;visibility:visible}
  .action-content{background:var(--glass-1);border:2px solid var(--gold);border-radius:12px;padding:20px;max-width:500px;width:90%}
  .action-title{font-family:Cinzel,serif;color:var(--gold);font-size:18px;margin-bottom:12px;text-align:center}
  .targets{display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:8px;margin:8px 0}
  .target{background:var(--glass-2);border:1px solid var(--border);padding:8px;border-radius:8px;text-align:center;cursor:pointer;transition:all .2s;font-size:10px}
  .target:hover:not(.disabled){background:var(--gold2);color:#000}
  .target.disabled{opacity:.4;cursor:not-allowed}
  .target img{width:32px;height:32px;border-radius:50%;margin-bottom:4px}
  .cancel-btn{background:var(--bad);color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;margin-top:12px;width:100%}

  @media (max-width:767px){
    .main-grid{grid-template-columns:1fr}
    .actions{grid-template-columns:repeat(3,1fr)}
    .targets{grid-template-columns:repeat(2,1fr)}
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">PYXIS 전투 시스템</div>
  
  <div class="main-grid">
    <!-- 좌측: A팀 + 채팅 -->
    <div>
      <div class="team-container" style="margin-bottom:12px">
        <div class="team-title">A팀</div>
        <div id="teamA"></div>
      </div>
      
      <div class="card">
        <div class="title">채팅</div>
        <div class="chat-section" id="chatPanel"></div>
        <div class="input-group">
          <input class="chat-input" id="chatInput" type="text" placeholder="메시지 입력..."/>
          <button class="send-btn" id="chatSend" type="button">전송</button>
        </div>
      </div>
    </div>

    <!-- 중앙: 내 정보 + 현재 전투 진행 -->
    <div class="center-section">
      <div class="card">
        <div class="my-info-section">
          <div class="my-info-header">
            <img id="myPortrait" class="my-avatar" alt="내 아바타"/>
            <div class="my-details">
              <div id="myName" class="my-name">전투 참가자</div>
              <div class="my-team"><span id="myTeam">?</span>팀</div>
            </div>
          </div>
          <div class="my-hp-bar"><div id="myHpBar" class="my-hp-fill" style="width:100%"></div></div>
          <div id="myHpText" class="my-hp-text">100/100</div>
          <div id="myStats" class="my-stats">공0 방0 민0 행0</div>
          <div id="myItems" class="my-items">아이템 없음</div>
          <button id="readyBtn" class="ready-btn" type="button">준비 완료</button>
        </div>
      </div>
      
      <!-- 현재 플레이어 정보 -->
      <div class="card battle-main">
        <div class="current-player-info">
          <img id="currentPortrait" class="current-avatar" alt="현재 플레이어"/>
          <div id="turnInfo" class="turn-info">대기 중...</div>
          <div id="timerDisplay" class="timer-display">5:00</div>
          <div id="timerSeconds" class="timer-seconds">300초</div>
        </div>
        
        <div class="actions">
          <button class="act" id="attackBtn" type="button" disabled>공격</button>
          <button class="act" id="defendBtn" type="button" disabled>방어</button>
          <button class="act" id="dodgeBtn"  type="button" disabled>회피</button>
          <button class="act" id="itemBtn"   type="button" disabled>아이템</button>
          <button class="act" id="passBtn"   type="button" disabled>패스</button>
        </div>
      </div>
    </div>

    <!-- 우측: B팀 + 실시간 로그 -->
    <div>
      <div class="team-container" style="margin-bottom:12px">
        <div class="team-title">B팀</div>
        <div id="teamB"></div>
      </div>
      
      <div class="card">
        <div class="title">실시간 로그</div>
        <div class="logs-section" id="logPanel"></div>
      </div>
    </div>
  </div>
</div>

<!-- 액션 선택 오버레이 -->
<div id="actionOverlay" class="action-overlay">
  <div class="action-content">
    <div class="action-title" id="actionTitle">대상 선택</div>
    <div class="targets" id="overlayTargets"></div>
    <button class="cancel-btn" id="cancelAction">취소</button>
  </div>
</div>

<!-- 게임 종료 오버레이 -->
<div id="gameOverOverlay" class="game-over-overlay">
  <div class="game-over-content">
    <div class="game-over-title">전투 종료</div>
    <div class="winner-announcement">
      <span id="winnerTeam" class="winner-team"></span> 승리!
    </div>
    <div id="personalResult" class="victory-message"></div>
    <div class="game-over-message">전투가 종료되었습니다.</div>
  </div>
</div>

<script>
(()=>{

  /* ---------- 안전한 아바타 data-URL 생성 (템플릿 문자열 충돌 방지) ---------- */
  function fallbackAvatar(size=32){
    const svg =
      `<svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}'>`+
      `<circle cx='${size/2}' cy='${size/2}' r='${size/2-2}' fill='%23DCC7A2' stroke='%23000' stroke-width='2'/>`+
      `<text x='${size/2}' y='${size*0.62}' text-anchor='middle' fill='%23000' font-size='${Math.floor(size*0.37)}'>?</text>`+
      `</svg>`;
    return "data:image/svg+xml," + encodeURIComponent(svg);
  }

  // URL 파라미터
  const qs = new URLSearchParams(location.search);
  const battleId = qs.get('battle');
  const token    = qs.get('token');
  const urlName  = qs.get('name');

  if(!battleId || !token){
    alert('올바르지 않은 URL입니다');
    return;
  }

  // 소켓 및 상태
  const socket = io({ path: '/socket.io' });
  const logPanel  = document.getElementById('logPanel');
  const chatPanel = document.getElementById('chatPanel');
  let myPlayer = null;
  let battleState = null;
  let hasActedThisTurn = false;
  let selectedAction = null;

  const $ = sel => document.getElementById(sel);
  const esc = s => s ? s.replace(/</g,'&lt;').replace(/>/g,'&gt;') : '';

  // 로그 색상 분류
  function getLogClass(message, type) {
    if (type === 'battle' || type === 'item') {
      if (message.includes('A1') || message.includes('A2') || message.includes('A3') || message.includes('A4') || 
          message.includes('A팀') || message.includes('=== A팀')) return 'log-team-a';
      if (message.includes('B1') || message.includes('B2') || message.includes('B3') || message.includes('B4') || 
          message.includes('B팀') || message.includes('=== B팀')) return 'log-team-b';
      if (message.includes('라운드 종료') || message.includes('승리') || message.includes('전투가') || 
          message.includes('결과') || message.includes('===')) return 'log-result';
    }
    if (type === 'notice') return 'log-notice';
    if (type === 'error') return 'log-error';
    return 'log-system';
  }

  // 내 정보 갱신
  function updateMyInfo(){ 
    if (!myPlayer) return;
    $('myName').textContent = myPlayer.name || '전투 참가자';
    $('myTeam').textContent = myPlayer.team || '?';
    $('myStats').textContent = `공${myPlayer.stats?.attack||0} 방${myPlayer.stats?.defense||0} 민${myPlayer.stats?.agility||0} 행${myPlayer.stats?.luck||0}`;
    const hpPct = Math.max(0,(myPlayer.hp/(myPlayer.maxHp||100))*100);
    $('myHpBar').style.width = hpPct + '%';
    $('myHpText').textContent = `${myPlayer.hp}/${myPlayer.maxHp||100}`;
    const items=[];
    if((myPlayer.items?.dittany||myPlayer.items?.ditany)>0) items.push(`디터니 ${myPlayer.items.dittany||myPlayer.items.ditany}`);
    if((myPlayer.items?.attackBooster||myPlayer.items?.attack_boost)>0) items.push(`공격보정 ${myPlayer.items.attackBooster||myPlayer.items.attack_boost}`);
    if((myPlayer.items?.defenseBooster||myPlayer.items?.defense_boost)>0) items.push(`방어보정 ${myPlayer.items.defenseBooster||myPlayer.items.defense_boost}`);
    $('myItems').textContent = items.length?items.join(', '):'아이템 없음';
    $('myPortrait').src = myPlayer.avatar || fallbackAvatar(32);
  }

  // 팀 목록 렌더링 (문자열 안전)
  function renderTeams(){
    if(!battleState?.players) return;
    const teamA = battleState.players.filter(p=>p.team==='A');
    const teamB = battleState.players.filter(p=>p.team==='B');

    function cardHtml(p){
      const hpPct = Math.max(0, p.hp/(p.maxHp||100)*100);
      const isAlive = p.hp>0;
      const readyStatus = p.ready?'준비완료':'대기중';
      const items=[];
      if((p.items?.dittany||p.items?.ditany)>0) items.push(`디터니 ${p.items.dittany||p.items.ditany}`);
      if((p.items?.attackBooster||p.items?.attack_boost)>0) items.push(`공격보정 ${p.items.attackBooster||p.items.attack_boost}`);
      if((p.items?.defenseBooster||p.items?.defense_boost)>0) items.push(`방어보정 ${p.items.defenseBooster||p.items.defense_boost}`);
      return (
        '<div class="player-card '+(isAlive?'':'dead')+'">'+
          '<img class="player-avatar" alt="'+esc(p.name)+'" src="'+(p.avatar||fallbackAvatar(32))+'"/>'+
          '<div class="player-info">'+
            '<div class="player-name">'+esc(p.name)+'</div>'+
            '<div class="hp"><span style="width:'+hpPct+'%"></span></div>'+
            '<div class="hp-text">HP '+p.hp+'/'+(p.maxHp||100)+'</div>'+
            '<div class="stats">공'+(p.stats?.attack||0)+' 방'+(p.stats?.defense||0)+' 민'+(p.stats?.agility||0)+' 행'+(p.stats?.luck||0)+'</div>'+
            '<div class="items-info">'+(items.length?items.join(', '):'아이템 없음')+'</div>'+
            '<div class="ready-status">'+readyStatus+'</div>'+
          '</div>'+
        '</div>'
      );
    }

    $('teamA').innerHTML = teamA.map(cardHtml).join('');
    $('teamB').innerHTML = teamB.map(cardHtml).join('');
  }

  // 전체 렌더
  function render(){
    if(!battleState) return;
    const t = battleState.currentTurn;
    const phaseText =
      battleState.phase==='A_select' ? 'A팀 선택 중' :
      battleState.phase==='B_select' ? 'B팀 선택 중' :
      battleState.phase==='resolve'  ? '라운드 해석 중' :
      battleState.phase==='inter'    ? '다음 라운드 대기' : '대기중';
    $('turnInfo').textContent = t?.currentPlayer ? `${phaseText} - ${t.currentPlayer.name} 차례` : phaseText;

    const timeLeft = t?.timeLeftSec||0;
    const mm = Math.floor(timeLeft/60);
    const ss = (timeLeft%60).toString().padStart(2,'0');
    $('timerDisplay').textContent = `${mm}:${ss}`;
    $('timerSeconds').textContent = `${timeLeft}초`;

    $('currentPortrait').src = (t?.currentPlayer?.avatar)||fallbackAvatar(100);

    const isMyTurn = myPlayer && t?.currentPlayer?.id===myPlayer.id;
    const canAct = isMyTurn && battleState.status==='active' && !hasActedThisTurn;
    ['attackBtn','defendBtn','dodgeBtn','itemBtn','passBtn'].forEach(id=>{$(id).disabled=!canAct;});

    renderTeams();
  }

  function disableActions(){ ['attackBtn','defendBtn','dodgeBtn','itemBtn','passBtn'].forEach(id=>$(id).disabled=true); }

  // 채팅 & 로그
  function addChat({name,message}){
    if(!name || !message) return;
    const div = document.createElement('div');
    div.className = 'chat-item';
    div.innerHTML = `<span class="chat-name">${esc(name)}</span>: ${esc(message)}`;
    chatPanel.appendChild(div);
    chatPanel.scrollTop = chatPanel.scrollHeight;
    while (chatPanel.children.length>100) chatPanel.removeChild(chatPanel.firstChild);
  }

  function addLog({ts,type,message}){
    if(!message) return;
    const time = new Date(ts).toLocaleTimeString('ko-KR',{hour12:false});
    const div = document.createElement('div');
    div.className = `log-item ${getLogClass(message,type)}`;
    div.innerHTML = `<span class="log-time">[${time}]</span> ${esc(message)}`;
    logPanel.appendChild(div);
    logPanel.scrollTop = logPanel.scrollHeight;
    while (logPanel.children.length>500) logPanel.removeChild(logPanel.firstChild);
  }

  // 액션 오버레이
  function showActionOverlay(actionType){
    selectedAction = actionType;
    const overlay = $('actionOverlay');
    const title   = $('actionTitle');
    const targetsDiv = $('overlayTargets');
    let html = '';

    if(actionType==='attack'){
      title.textContent='공격 대상 선택';
      const targets = battleState.players.filter(p=>p.team!==myPlayer.team && p.hp>0);
      html = targets.map(t =>
        `<div class="target" data-id="${t.id}">
          <img src="${t.avatar||fallbackAvatar(32)}" alt="${esc(t.name)}"/>
          <div>${esc(t.name)}</div><div>HP ${t.hp}</div>
        </div>`).join('');
      targetsDiv.innerHTML = html;
      Array.from(targetsDiv.children).forEach(el=>{
        el.onclick = ()=> selectTarget(el.getAttribute('data-id'));
      });
      overlay.classList.add('show');
      return;
    }
    if(actionType==='item'){
      showItemSelection(); return;
    }
    if(actionType==='defend' || actionType==='dodge' || actionType==='pass'){
      sendAction(actionType); return;
    }
  }

  function showItemSelection(){
    const title = $('actionTitle'); const targetsDiv=$('overlayTargets');
    title.textContent='아이템 선택';
    let html='';
    if((myPlayer.items?.dittany||myPlayer.items?.ditany)>0){
      html+=`<div class="target" data-item="dittany"><div>디터니</div><div>HP +10 (100%)</div></div>`;
    }
    if((myPlayer.items?.attackBooster||myPlayer.items?.attack_boost)>0){
      html+=`<div class="target" data-item="attackBooster"><div>공격 보정기</div><div>공격력 x2 (60%)</div></div>`;
    }
    if((myPlayer.items?.defenseBooster||myPlayer.items?.defense_boost)>0){
      html+=`<div class="target" data-item="defenseBooster"><div>방어 보정기</div><div>방어력 x2 (60%)</div></div>`;
    }
    if(!html) html = '<div class="target disabled">사용 가능한 아이템이 없습니다</div>';
    targetsDiv.innerHTML = html;
    Array.from(targetsDiv.querySelectorAll('[data-item]')).forEach(el=>{
      el.onclick = ()=> selectItem(el.getAttribute('data-item'));
    });
    $('actionOverlay').classList.add('show');
  }

  function selectItem(itemType){
    selectedAction = { type:'item', item:itemType };
    const title=$('actionTitle'); const targetsDiv=$('overlayTargets');
    let html='';
    if(itemType==='dittany' || itemType==='ditany'){
      title.textContent='치료 대상 선택';
      const targets = battleState.players.filter(p=>p.team===myPlayer.team && p.hp>0);
      html = targets.map(t =>
        `<div class="target" data-id="${t.id}">
          <img src="${t.avatar||fallbackAvatar(32)}" alt="${esc(t.name)}"/>
          <div>${esc(t.name)}</div><div>HP ${t.hp}</div>
        </div>`).join('');
      targetsDiv.innerHTML = html;
      Array.from(targetsDiv.children).forEach(el=>{
        el.onclick = ()=> selectTarget(el.getAttribute('data-id'));
      });
    } else if(itemType==='attackBooster'){
      title.textContent='공격 대상 선택 (보정기)';
      const targets = battleState.players.filter(p=>p.team!==myPlayer.team && p.hp>0);
      html = targets.map(t =>
        `<div class="target" data-id="${t.id}">
          <img src="${t.avatar||fallbackAvatar(32)}" alt="${esc(t.name)}"/>
          <div>${esc(t.name)}</div><div>HP ${t.hp}</div>
        </div>`).join('');
      targetsDiv.innerHTML = html;
      Array.from(targetsDiv.children).forEach(el=>{
        el.onclick = ()=> selectTarget(el.getAttribute('data-id'));
      });
    } else if(itemType==='defenseBooster'){
      title.textContent='방어 보정 대상 선택';
      const targets = battleState.players.filter(p=>p.team===myPlayer.team && p.hp>0);
      html = targets.map(t =>
        `<div class="target" data-id="${t.id}">
          <img src="${t.avatar||fallbackAvatar(32)}" alt="${esc(t.name)}"/>
          <div>${esc(t.name)}</div><div>HP ${t.hp}</div>
        </div>`).join('');
      targetsDiv.innerHTML = html;
      Array.from(targetsDiv.children).forEach(el=>{
        el.onclick = ()=> selectTarget(el.getAttribute('data-id'));
      });
    }
  }

  function selectTarget(targetId){
    if(selectedAction && typeof selectedAction==='object' && selectedAction.type==='item'){
      sendAction('item',{ item:selectedAction.item, targetId });
    } else {
      sendAction(selectedAction,{ targetId });
    }
    hideActionOverlay();
  }

  function hideActionOverlay(){ $('actionOverlay').classList.remove('show'); selectedAction=null; }

  function sendAction(actionType, params={}){
    if(!myPlayer) return;
    const action = { type: actionType, ...params };
    socket.emit('player:action', { battleId, playerId: myPlayer.id, action }, (res)=>{
      if(!res?.ok) alert('액션 실패: '+(res?.error||'알 수 없는 오류'));
    });
  }

  function sendChat(){
    const input = $('chatInput');
    const message = input.value.trim();
    if(!message) return;
    socket.emit('chatMessage', { battleId, name: myPlayer?.name || urlName || '전투 참가자', message });
    input.value='';
  }

  function setReady(){
    const btn=$('readyBtn');
    if(btn.classList.contains('done')) return;
    socket.emit('player:ready', { battleId, playerId: myPlayer?.id });
    socket.emit('chatMessage', { battleId, name: myPlayer?.name || urlName || '전투 참가자', message: '[준비 완료]' });
    btn.classList.add('done'); btn.textContent='준비 완료됨';
  }

  function setupEventListeners(){
    $('attackBtn').addEventListener('click', ()=>showActionOverlay('attack'));
    $('defendBtn').addEventListener('click', ()=>showActionOverlay('defend'));
    $('dodgeBtn').addEventListener('click', ()=>showActionOverlay('dodge'));
    $('itemBtn').addEventListener('click',   ()=>showActionOverlay('item'));
    $('passBtn').addEventListener('click',   ()=>showActionOverlay('pass'));
    $('cancelAction').addEventListener('click', hideActionOverlay);
    $('chatSend').addEventListener('click', sendChat);
    $('chatInput').addEventListener('keypress', e=>{ if(e.key==='Enter'){ e.preventDefault(); sendChat(); }});
    $('readyBtn').addEventListener('click', setReady);
  }

  function applyAuthedPlayer(p){
    if(!p) return;
    if(!p.name && urlName) p.name = urlName;
    myPlayer = p;
    updateMyInfo();
  }

  /* --------------------------- 소켓 이벤트 --------------------------- */
  socket.on('connect', ()=>{ socket.emit('join', { battleId }); });

  // 인증
  socket.emit('playerAuth', { battleId, token }, (res)=>{
    if(!res?.ok){ alert('인증 실패'); return; }
    applyAuthedPlayer(res.player);
  });
  socket.on('authSuccess', (d)=>applyAuthedPlayer(d.player));
  socket.on('auth:success', (d)=>applyAuthedPlayer(d.player));

  // 스냅샷/로그/채팅 (중복 리스너 제거해서 2번 찍히지 않음)
  socket.on('battleUpdate', snap => { battleState=snap; render(); });
  socket.on('battle:log', addLog);
  socket.on('chatMessage', addChat);

  // 액션 완료
  socket.on('actionSuccess', ()=>{ hasActedThisTurn=true; disableActions(); });
  socket.on('player:action:success', ()=>{ hasActedThisTurn=true; disableActions(); });

  // 게임 종료
  function showGameOverOverlay(winner){
    const overlay=$('gameOverOverlay'); const winnerTeam=$('winnerTeam'); const personalResult=$('personalResult');
    winnerTeam.textContent = winner+'팀';
    if(myPlayer && myPlayer.team===winner){ personalResult.textContent='승리했습니다!'; personalResult.className='victory-message'; }
    else { personalResult.textContent='패배했습니다...'; personalResult.className='defeat-message'; }
    overlay.classList.add('show'); document.body.classList.add('battle-ended');
  }
  socket.on('battle:ended', data=>showGameOverOverlay(data.winner));
  socket.on('battleEnded',  data=>showGameOverOverlay(data.winner));

  // 초기화
  setupEventListeners();

  // 페이지 종료 시 정리
  window.addEventListener('beforeunload', ()=>{ socket.disconnect(); });

})();
</script>
</body>
</html>
