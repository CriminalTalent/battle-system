<!-- packages/battle-server/public/spectator.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>PYXIS - 관전자</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --deep:#0b1117; --dark:#121925; --mid:#192233; --glass:rgba(25,34,51,.6);
      --gold:#dcc7a2; --gold2:#e6d5b7; --muted:#9aa4b2; --text:#e9edf3; --border:#283244;
      --ok:#27ae60; --warn:#f39c12; --danger:#e74c3c;
      --r:14px; --rs:10px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:linear-gradient(135deg,var(--deep),var(--dark));color:var(--text);font-family:Cinzel,serif}
    .wrap{max-width:1200px;height:100%;margin:0 auto;padding:10px;display:grid;grid-template-rows:auto 1fr auto;gap:8px}
    .hdr{display:flex;align-items:center;justify-content:center;background:var(--glass);backdrop-filter:blur(8px);border:1px solid var(--border);border-radius:var(--r);padding:8px}
    .hdr h1{margin:0;font-weight:700;letter-spacing:.06em;color:var(--gold2);font-size:20px}

    /* 플레이어 레이아웃과 동일한 큰 틀: 3열, 2행 */
    .grid{display:grid;grid-template-columns:260px 1fr 320px;grid-template-rows:1fr 220px;gap:10px;height:calc(100vh - 120px)}
    .card{background:rgba(25,34,51,.78);backdrop-filter:blur(8px);border:1px solid var(--border);border-radius:var(--r);padding:10px}
    .section-title{font-size:12px;color:var(--muted);margin:0 0 8px 0}

    /* 팀 리스트(좌측 상/하) */
    .team-list .row{display:flex;gap:10px;align-items:center;padding:8px;border-bottom:1px dashed #233044}
    .team-list .thumb{width:36px;height:36px;border-radius:8px;border:1px solid var(--border);background:#0f1623;overflow:hidden}
    .team-list .thumb img{width:100%;height:100%;object-fit:cover}
    .hpbar{position:relative;height:14px;background:#0d1420;border:1px solid var(--border);border-radius:8px;overflow:hidden}
    .hpbar i{display:block;height:100%;background:linear-gradient(90deg,#2ecc71,#27ae60);width:0%}
    .hpbar .hptxt{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:10px}
    .statline{font-size:11px;color:#cfd6df}

    /* 중앙 상단: 현재 턴 박스(둥근 사각형) */
    .turnbox{display:grid;grid-template-rows:auto 1fr auto;gap:10px;place-items:center}
    .turnimg{width:220px;height:220px;border-radius:24px;border:1px solid var(--gold);background:#0f1623;overflow:hidden}
    .turnimg img{width:100%;height:100%;object-fit:cover}
    .turnhp{width:80%;max-width:420px}
    .turnmeta{font-size:12px;color:var(--muted)}

    /* 중앙 하단: 로그 */
    .log{overflow:auto;height:100%;font-size:12px;line-height:1.45;border-radius:12px;background:rgba(13,20,32,.55);border:1px solid var(--border);padding:8px}
    .log .entry{padding:4px 2px;border-bottom:1px dashed #223047}
    .log .entry:last-child{border-bottom:none}

    /* 우측 상단: 응원 패널 */
    .cheer{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .btn{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#0b1117;border:1px solid var(--gold);border-radius:12px;padding:10px;font-weight:700;letter-spacing:.04em;cursor:pointer}
    .btn:disabled{opacity:.45;cursor:not-allowed}

    /* 인증 오버레이 */
    .overlay{position:fixed;inset:0;background:rgba(10,17,28,.6);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center}
    .sheet{width:360px;background:#111a28;border:1px solid var(--border);border-radius:14px;padding:16px}
    .sheet h3{margin:0 0 8px 0;font-size:16px;color:var(--gold2)}
    .sheet .field{margin:8px 0}
    .sheet label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
    .sheet input{width:100%;background:#0f1623;border:1px solid var(--border);border-radius:10px;color:var(--text);padding:10px}

    .hidden{display:none!important}
    @media (max-width:1100px){ .grid{grid-template-columns:1fr;grid-template-rows:auto auto auto auto} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hdr"><h1>PYXIS 관전자</h1></div>

    <div class="grid" id="layout" style="display:none;">
      <!-- 좌상: A팀 -->
      <div class="card">
        <h4 class="section-title">A팀</h4>
        <div id="teamA" class="team-list"></div>
      </div>

      <!-- 중앙상: 현재 턴 -->
      <div class="card turnbox">
        <div class="turnmeta"><span id="turnTeam">현재 순서팀: -</span></div>
        <div class="turnimg"><img id="turnImg" alt=""></div>
        <div class="hpbar turnhp"><i id="turnHpFill"></i><div class="hptxt" id="turnHpText">0/100</div></div>
      </div>

      <!-- 우상: 응원 -->
      <div class="card">
        <h4 class="section-title">응원하기</h4>
        <div class="cheer">
          <button class="btn cheer-btn" data-cheer="멋지다!">멋지다!</button>
          <button class="btn cheer-btn" data-cheer="이겨라!">이겨라!</button>
          <button class="btn cheer-btn" data-cheer="살아서 돌아와!">살아서 돌아와!</button>
          <button class="btn cheer-btn" data-cheer="화이팅!">화이팅!</button>
          <button class="btn cheer-btn" data-cheer="죽으면 나한테 죽어!">죽으면 나한테 죽어!</button>
          <button class="btn cheer-btn" data-cheer="힘내요!">힘내요!</button>
        </div>
      </div>

      <!-- 좌하: B팀 -->
      <div class="card">
        <h4 class="section-title">B팀</h4>
        <div id="teamB" class="team-list"></div>
      </div>

      <!-- 중하: 로그 -->
      <div class="card">
        <h4 class="section-title">실시간 로그</h4>
        <div id="log" class="log"></div>
      </div>

      <!-- 우하: (빈 슬롯 – 플레이어와 동일한 레이아웃 유지용) -->
      <div class="card" id="rightBottom" style="display:none"></div>
    </div>

    <div class="hdr" style="justify-content:flex-end">
      <div class="section-title" style="margin:0;font-size:12px;color:var(--muted)">상태: <span id="statusText">대기</span></div>
    </div>
  </div>

  <!-- 관전자 인증 오버레이 (이름 선택·비밀번호 필수) -->
  <div id="authOverlay" class="overlay">
    <div class="sheet">
      <h3>관전자 입장</h3>
      <div class="field">
        <label>이름(선택)</label>
        <input id="vName" type="text" placeholder="관전자">
      </div>
      <div class="field">
        <label>비밀번호</label>
        <input id="vOtp" type="text" placeholder="관리자 발급 비밀번호">
      </div>
      <button id="vEnter" class="btn" style="width:100%;margin-top:8px">입장</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ===== 전역 상태 =====
    let socket=null, battleId=null, snap=null, isAuthed=false;
    let spectatorName='관전자';

    // ===== DOM =====
    const layout     = document.getElementById('layout');
    const statusText = document.getElementById('statusText');
    const teamAEl    = document.getElementById('teamA');
    const teamBEl    = document.getElementById('teamB');
    const logEl      = document.getElementById('log');

    const turnTeam   = document.getElementById('turnTeam');
    const turnImg    = document.getElementById('turnImg');
    const turnHpFill = document.getElementById('turnHpFill');
    const turnHpText = document.getElementById('turnHpText');

    const authOverlay= document.getElementById('authOverlay');
    const vName      = document.getElementById('vName');
    const vOtp       = document.getElementById('vOtp');
    const vEnter     = document.getElementById('vEnter');

    // ===== 유틸 =====
    const esc = (s)=>String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m]));
    function addLog(msg){
      const d=document.createElement('div');
      d.className='entry';
      d.textContent=String(msg||'');
      logEl.appendChild(d);
      logEl.scrollTop=logEl.scrollHeight;
    }
    function toAB(t){ t=String(t||'').toUpperCase(); return t==='B'?'B':'A'; }

    // ===== 렌더링 =====
    function render(s){
      if(!s) return;
      snap=s;
      statusText.textContent = s.status || '대기';

      // 현재 턴
      const curTeam = s.currentTeam ? toAB(s.currentTeam) :
                      (s.currentTurn?.currentTeam ? toAB(s.currentTurn.currentTeam) : 'A');
      turnTeam.textContent = '현재 순서팀: ' + (curTeam||'-');
      const curList = (s.players||[]).filter(p=>toAB(p.team)===curTeam && (p.hp||0)>0);
      const actor = curList[0] || null;
      const tMax = actor?.maxHp ?? 100, tCur = actor?.hp ?? 0;
      const tPct = Math.max(0,Math.min(100,(tCur/Math.max(1,tMax))*100));
      turnImg.src = actor?.avatar || '';
      turnHpFill.style.width = tPct + '%';
      turnHpText.textContent = tCur + '/' + tMax;

      // 팀 리스트
      const A=(s.players||[]).filter(p=>toAB(p.team)==='A');
      const B=(s.players||[]).filter(p=>toAB(p.team)==='B');
      paintTeam(teamAEl, A);
      paintTeam(teamBEl, B);
    }

    function paintTeam(wrap, list){
      wrap.innerHTML='';
      if(!list || !list.length){
        const empty=document.createElement('div');
        empty.style.cssText='text-align:center;color:var(--muted);padding:24px 0;font-size:13px';
        empty.textContent='팀원이 없습니다';
        wrap.appendChild(empty);
        return;
      }
      list.forEach(p=>{
        const max=p.maxHp??100, cur=p.hp??0;
        const pct=Math.max(0,Math.min(100,(cur/Math.max(1,max))*100));
        const row=document.createElement('div');
        row.className='row';
        row.innerHTML=`
          <div class="thumb">${p.avatar?`<img src="${p.avatar}" alt="">`:''}</div>
          <div style="flex:1">
            <div style="font-weight:700">${esc(p.name||'전투 참가자')}</div>
            <div class="statline">팀 ${toAB(p.team)} · 공 ${p.stats?.attack??'-'} · 방 ${p.stats?.defense??'-'} · 민 ${p.stats?.agility??'-'} · 운 ${p.stats?.luck??'-'}</div>
            <div class="hpbar" style="margin-top:4px"><i style="width:${pct}%"></i><div class="hptxt">${cur}/${max}</div></div>
          </div>`;
        wrap.appendChild(row);
      });
    }

    // ===== 소켓 =====
    function bindSocket(){
      socket.on('battleUpdate', (s)=>render(s));
      socket.on('battle:update', (s)=>render(s));
      socket.on('battle:log', (m)=> addLog(m?.message||''));
      socket.on('chatMessage',  (m)=> addLog((m?.name||'전투 참가자')+': '+(m?.message||'')));
      socket.on('battle:chat',  (m)=> addLog((m?.name||'전투 참가자')+': '+(m?.message||'')));
      socket.on('cheerMessage', (m)=> addLog('[응원] '+(m?.name||'관전자')+': '+(m?.message||'')));
      socket.on('spectator:cheer', (m)=> addLog('[응원] '+(m?.name||'관전자')+': '+(m?.message||'')));
    }

    function connect(){
      if(socket){ try{socket.disconnect()}catch(_){} }
      socket = io({ path:'/socket.io', transports:['websocket','polling'] });

      socket.on('connect', ()=>{
        // 인증 성공 시 join으로 룸 구독
        if(battleId) socket.emit('join', { battleId });
      });

      bindSocket();
    }

    // ===== 인증 =====
    function startAuth(){
      const url = new URLSearchParams(location.search);
      battleId = url.get('battle') || url.get('id') || '';
      const autoOtp = url.get('otp') || url.get('token') || url.get('password') || url.get('pwd') || url.get('auth') || '';
      if(autoOtp && !vOtp.value) vOtp.value = autoOtp;

      if(!battleId){ addLog('전투 ID가 없습니다. 올바른 링크로 접속하세요.'); return; }

      vEnter.addEventListener('click', doAuth);
      vOtp.addEventListener('keydown', (e)=>{ if(e.key==='Enter') doAuth(); });
      vName.addEventListener('keydown', (e)=>{ if(e.key==='Enter') doAuth(); });

      function doAuth(){
        const token=(vOtp.value||'').trim();
        spectatorName=(vName.value||'관전자').trim() || '관전자';
        if(!token){ addLog('비밀번호를 입력하세요.'); return; }

        // 서버가 spectatorAuth를 제공하는 구현을 우선 사용
        socket.emit('spectatorAuth', { battleId, token, name: spectatorName });

        socket.once('authSuccess', (res)=>{
          isAuthed=true; authOverlay.classList.add('hidden'); layout.style.display='grid';
          addLog('관전 인증 성공');
          if(res?.battle) render(res.battle);
        });
        socket.once('auth:success', (res)=>{
          isAuthed=true; authOverlay.classList.add('hidden'); layout.style.display='grid';
          addLog('관전 인증 성공');
          if(res?.battle) render(res.battle);
        });
        socket.once('authError', (err)=>{
          addLog('인증 실패: ' + (err?.message || err?.error || '오류'));
        });
      }
    }

    // ===== 응원 버튼 =====
    document.addEventListener('click', (e)=>{
      if(!e.target.classList.contains('cheer-btn')) return;
      if(!socket || !battleId || !isAuthed){ addLog('먼저 인증을 완료하세요.'); return; }
      const msg=e.target.dataset.cheer;
      socket.emit('cheerMessage', { battleId, message: msg, name: spectatorName });
      socket.emit('spectator:cheer', { battleId, message: msg, name: spectatorName });
    });

    // ===== 초기화 =====
    (function init(){
      connect();
      startAuth();
    })();
  </script>
</body>
</html>
