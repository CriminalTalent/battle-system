<!-- packages/battle-server/public/player.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PYXIS - 전투 참가자</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root{
      --deep:#050a12;--deep2:#0a111c;--glass1:rgba(26,35,50,.3);--glass2:rgba(26,35,50,.5);
      --border:rgba(37,45,61,.6);--gold:#dcc7a2;--gold2:#e6d2a8;--txt:#f8f9fa;--muted:#8a93a3;
      --r:10px
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Cinzel',serif;background:linear-gradient(135deg,var(--deep),var(--deep2));color:var(--txt)}
    .header{position:sticky;top:0;z-index:5;background:rgba(0,0,0,.25);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.06)}
    .header .wrap{max-width:1200px;margin:0 auto;padding:10px 14px;text-align:center}
    .header h1{margin:0;color:var(--gold2);letter-spacing:1px}
    .header small{color:var(--muted)}
    .auth{height:calc(100vh - 56px);display:flex;align-items:center;justify-content:center;padding:16px}
    .card{width:100%;max-width:420px;background:var(--glass2);border:1px solid rgba(220,199,162,.35);border-radius:var(--r);padding:20px}
    .card h2{margin:0 0 12px;color:var(--gold2);font-size:18px}
    .fg{margin-bottom:10px}
    .fg label{display:block;font-size:11px;color:#d3d7df;margin-bottom:4px}
    input[type=text],input[type=password]{width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:var(--glass1);color:var(--txt)}
    .btn{display:inline-block;margin-top:8px;background:linear-gradient(135deg,var(--gold),var(--gold2));color:#0d1117;border:0;border-radius:8px;padding:10px 14px;font-weight:700;cursor:pointer}
    .hidden{display:none!important}
    .game{display:none;max-width:1200px;margin:16px auto;padding:8px;color:#ddd}
    .game.active{display:block}
    .log{font-size:12px;opacity:.75;margin-top:8px;white-space:pre-line}
  </style>
</head>
<body>
  <div class="header">
    <div class="wrap">
      <h1>PYXIS</h1>
      <small>전투 시스템</small>
    </div>
  </div>

  <!-- 인증 화면 -->
  <section id="authPage" class="auth">
    <div class="card">
      <h2>전투 참가자 인증</h2>
      <div class="fg">
        <label>초대 링크 붙여넣기 (선택)</label>
        <input type="text" id="inviteUrl" placeholder="관리자가 준 참가자 링크를 붙여넣으세요" />
      </div>

      <form id="authForm" autocomplete="off">
        <div class="fg">
          <label>전투 참가자명</label>
          <input type="text" id="playerName" placeholder="이름을 입력하세요" required autocomplete="username"/>
        </div>
        <div class="fg">
          <label>비밀번호</label>
          <input type="password" id="playerOtp" placeholder="비밀번호를 입력하세요" required autocomplete="current-password"/>
        </div>
        <button type="submit" class="btn">전투 참가</button>
      </form>

      <div class="log" id="localLog"></div>
    </div>
  </section>

  <!-- 게임 화면 (UI는 서버 이벤트 성공시 표시) -->
  <section id="gamePage" class="game">
    <h2>게임에 입장했습니다.</h2>
    <div>서버 스냅샷을 기다리는 중...</div>
  </section>

<script>
/* ================== 유틸 로그 ================== */
const logEl = document.getElementById('localLog');
const L = (...a)=>{ console.log('[LOG]', ...a); logEl.textContent = ([...a].map(v => typeof v==='object'? JSON.stringify(v):String(v)).join(' ')) + '\n' + (logEl.textContent||''); };

/* ================== 상태/DOM ================== */
const socket = io({ path: '/socket.io' }); // 서버 index.js와 동일
const state = {
  battleId: null, playerId: null, playerName: null, otp: null,
  authed: false, joined: false, authInFlight: false
};
const authPage = document.getElementById('authPage');
const gamePage = document.getElementById('gamePage');
const inviteUrlInput = document.getElementById('inviteUrl');
const playerNameInput = document.getElementById('playerName');
const playerOtpInput  = document.getElementById('playerOtp');

/* ================== 파라미터 파싱 ================== */
function readQueryAll() {
  const all = new URLSearchParams(location.search);
  if (location.hash.includes('?')) {
    for (const [k, v] of new URLSearchParams(location.hash.split('?')[1]).entries()) {
      if (!all.has(k)) all.set(k, v);
    }
  }
  const q = (k)=> all.get(k);
  return {
    battle: q('battle') || q('battleId') || q('b'),
    name:   q('name')   || q('player')   || q('user'),
    token:  q('token')  || q('otp')      || q('password') || q('pwd'),
    playerId: q('playerId') || q('pid')
  };
}
function applyParsedToInputs(p) {
  if (p.name)  playerNameInput.value = p.name;
  if (p.token) playerOtpInput.value  = p.token;
  if (p.battle) state.battleId = p.battle;
  if (p.playerId) state.playerId = p.playerId;
}

/* ================== 조인 → 인증 ================== */
function joinRoomIfNeeded(){
  if (!state.battleId) { L('전투 ID 없음 – 초대 링크가 필요합니다.'); return false; }
  if (state.joined) return true;

  L('전투방 조인 시도:', state.battleId);
  socket.emit('join', { battleId: state.battleId });
  // 서버는 join ack/이벤트를 따로 주지 않으므로 일단 조인 완료로 간주
  state.joined = true;
  return true;
}

function tryAuth(){
  if (state.authed || state.authInFlight) return;
  if (!joinRoomIfNeeded()) return;

  const name = playerNameInput.value.trim();
  const otp  = playerOtpInput.value.trim();
  if (!name || !otp) { L('이름/비밀번호 필요'); return; }

  state.playerName = name;
  state.otp = otp;
  state.authInFlight = true;

  const payload = {
    battleId: state.battleId,
    playerName: name,
    otp: otp,
    token: otp,
    password: otp,
    playerId: state.playerId || undefined
  };

  L('인증 시도(playerAuth)', payload);

  socket.emit('playerAuth', payload, (ack)=>{
    state.authInFlight = false;
    if (ack?.success || ack?.ok) {
      onAuthOK(ack);
    } else {
      onAuthFail(ack);
    }
  });
}

/* ================== 결과 핸들러 (서버 규격에 맞춤) ================== */
function onAuthOK(d){
  state.authed = true;
  L('인증 성공');
  authPage.classList.add('hidden');
  gamePage.classList.add('active');
}
function onAuthFail(d){
  const msg = d?.message || d?.error || '인증 실패';
  L('인증 실패:', msg);
  // 레이스 대비 소폭 재시도
  setTimeout(()=> tryAuth(), 400);
}

/* 서버가 내보내는 인증 이벤트들 */
socket.on('authSuccess', onAuthOK);
socket.on('auth:success', onAuthOK);
socket.on('authError', onAuthFail);

/* 배틀 스냅샷 수신 시 battleId 보강 */
socket.on('battleUpdate', (d)=>{ if (d?.id || d?.battleId) state.battleId = state.battleId || d.id || d.battleId; });
socket.on('battle:update', (d)=>{ if (d?.id || d?.battleId) state.battleId = state.battleId || d.id || d.battleId; });

/* ================== 폼/입력 ================== */
document.getElementById('authForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  tryAuth();
});

inviteUrlInput.addEventListener('change', ()=>{
  const raw = inviteUrlInput.value.trim();
  if (!raw) return;
  try{
    const u = new URL(raw, location.origin);
    const params = new URLSearchParams(u.search);
    const p = {
      battle: params.get('battle')||params.get('battleId'),
      name: params.get('name')||params.get('player'),
      token: params.get('token')||params.get('otp')||params.get('password'),
      playerId: params.get('playerId')
    };
    applyParsedToInputs(p);
    tryAuth();
  }catch{ L('잘못된 링크 형식'); }
});

/* ================== 연결 시 자동 시도 ================== */
socket.on('connect', ()=>{
  L('서버 연결');
  const parsed = readQueryAll();
  applyParsedToInputs(parsed);
  tryAuth();
});
socket.on('disconnect', ()=> L('서버 연결 끊김. 자동 재연결 대기.'));

window.addEventListener('DOMContentLoaded', ()=>{
  const p = readQueryAll();
  applyParsedToInputs(p);
  setTimeout(()=> tryAuth(), 200);
});
</script>
</body>
</html>
