<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>PYXIS - 전투 참가자</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="/socket.io/socket.io.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --black:#0a0a0a;
      --black-2:#111;
      --black-3:#161616;
      --gold:#DCC7A2;
      --gold-2:#E6D2A8;
      --muted:#A7A7A7;
      --border:rgba(255,255,255,0.08);
      --accent:#1f1f1f;
      --radius:12px;
      --shadow:0 8px 20px rgba(0,0,0,0.35);
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;padding:0;
      background:linear-gradient(135deg,var(--black),#000);
      color:#f5f5f5;
      font-family:'Cinzel',serif;
      min-height:100vh;
    }
    /* 공통 카드 */
    .card{
      background:linear-gradient(180deg,var(--black-2),var(--black-3));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .title{
      color:var(--gold);
      font-weight:800;
      letter-spacing:1px;
      margin-bottom:10px;
      border-bottom:1px solid var(--border);
      padding-bottom:8px;
    }
    /* 레이아웃: 좌(내카드+로그) / 중앙(턴 초상화) / 우(액션+채팅) */
    .wrap{
      max-width:1320px;margin:0 auto;padding:16px;
      display:grid;grid-template-columns: 300px 1fr 360px;gap:16px;
    }
    @media (max-width: 1100px){
      .wrap{ grid-template-columns: 1fr; }
    }

    /* 상단 상태바 */
    .topbar{
      max-width:1320px;margin:0 auto;padding:12px 16px 0 16px;
      display:flex;align-items:center;justify-content:space-between;
    }
    .brand{color:var(--gold-2);font-weight:800;letter-spacing:1px}
    .status{font-size:12px;color:#9e9e9e}
    .dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;background:#666;vertical-align:middle}
    .dot.on{background:#2ecc71}

    /* 좌측: 내 카드 + 로그 */
    .me{
      display:flex;flex-direction:column;gap:14px;
    }
    .row{
      display:grid;grid-template-columns: 80px 1fr;gap:12px;align-items:center;
    }
    .ava{
      width:76px;height:76px;border-radius:12px;object-fit:cover;border:1px solid var(--border);background:#222;
    }
    .name{font-weight:800}
    .pill{
      display:inline-block; padding:4px 8px; border:1px solid var(--border);
      background:#0f0f0f;border-radius:999px;font-size:11px;color:#ddd;margin-left:8px;
    }
    .hpbar{
      height:10px;border-radius:6px;background:#202020;border:1px solid var(--border);overflow:hidden;margin-top:6px;
    }
    .hpfill{height:100%;background:linear-gradient(90deg,#7dd36c,#3aa73b)}
    .stats{display:grid;grid-template-columns: repeat(2,1fr);gap:8px;margin-top:6px}
    .sItem{font-size:12px;color:#ddd}
    .sLabel{color:#9e9e9e;margin-right:6px}
    .items{display:grid;grid-template-columns: repeat(3,1fr);gap:8px;margin-top:8px}
    .iItem{font-size:12px;color:#ddd;border:1px solid var(--border);background:#0e0e0e;border-radius:10px;padding:6px 8px;text-align:center}
    .btnReady{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);
      background:linear-gradient(180deg,#232323,#1a1a1a);color:#f5f5f5;font-weight:800;cursor:pointer;
    }
    .btnReady:disabled{background:#000;color:#666;cursor:not-allowed}

    /* 실시간 로그 (내 정보 아래) */
    .logBox{
      border:1px solid var(--border);border-radius:10px;background:#0f0f0f;
      display:flex;flex-direction:column;overflow:hidden;min-height:220px;max-height:360px;
    }
    .logHead{padding:10px 12px;border-bottom:1px solid var(--border);color:var(--gold);font-weight:700;background:#0c0c0c}
    .logBody{padding:10px 12px;overflow:auto;flex:1;font-size:12px;line-height:1.5}
    .logRow{padding:4px 0;border-bottom:1px dashed rgba(255,255,255,0.06)}
    .logRow:last-child{border-bottom:none}
    .logRow .ts{color:#888;font-size:11px;margin-right:8px}
    .logRow.system{color:#8ab4f8}
    .logRow.admin{color:#f2a654}
    .logRow.chat{color:#c7e1ff}
    .logRow.cheer{color:#9ce29c}
    .logRow.action{color:#ffd18b}
    .logRow.round{color:#f7a7a7}

    /* 중앙: 현재 턴(초상화 큼직) + 팀 리스트 */
    .center{
      display:flex;flex-direction:column;gap:14px;
    }
    .turnCard{
      display:grid;grid-template-columns: 200px 1fr;gap:16px;align-items:center;
      border:1px solid var(--border);border-radius:12px;background:linear-gradient(180deg,#0f0f0f,#121212);
      padding:14px;
    }
    @media (max-width:700px){
      .turnCard{ grid-template-columns:1fr; }
    }
    .turnImg{
      width:100%;max-width:200px;aspect-ratio: 3/4;object-fit:cover;border-radius:14px;border:1px solid var(--border);background:#1a1a1a;margin:0 auto;
    }
    .turnMeta .who{font-size:18px;font-weight:800;color:#fff;margin-bottom:6px}
    .tag{display:inline-block;border:1px solid var(--border);background:#0b0b0b;border-radius:999px;padding:4px 8px;font-size:11px;color:#ddd;margin-right:6px}
    .timer{font-size:12px;color:#ccc;margin-top:6px}
    .teamsRow{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .teamCard{border:1px solid var(--border);border-radius:10px;background:#0e0e0e;padding:10px}
    .teamTitle{color:var(--gold-2);font-size:13px;letter-spacing:1px;margin-bottom:6px;text-transform:uppercase}
    .list{border:1px solid var(--border);border-radius:10px;background:#0b0b0b;max-height:220px;overflow:auto}
    .item{display:flex;gap:10px;align-items:center;padding:8px 10px;border-bottom:1px solid var(--border);font-size:12px}
    .item:last-child{border-bottom:none}
    .avaS{width:28px;height:28px;border-radius:8px;border:1px solid var(--border);object-fit:cover;background:#222}
    .nm{font-weight:700}
    .hp{color:#bbb;font-size:11px}

    /* 우측: 액션 + 채팅 */
    .right{
      display:flex;flex-direction:column;gap:14px;
    }
    .actionCard .title{margin-bottom:6px}
    .btnRow{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .btn{
      background:linear-gradient(180deg,#222,#1a1a1a);
      border:1px solid var(--border);border-radius:10px;color:#f5f5f5;padding:10px 12px;font-weight:800;cursor:pointer;
    }
    .btn:hover{background:#232323}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .note{font-size:12px;color:#a7a7a7;margin-top:6px}

    /* 채팅 */
    .chatBox{border:1px solid var(--border);border-radius:10px;background:#0f0f0f;display:flex;flex-direction:column;overflow:hidden;min-height:220px}
    .chatHead{padding:10px 12px;border-bottom:1px solid var(--border);color:var(--gold);font-weight:700;background:#0c0c0c}
    .chatBody{padding:10px 12px;overflow:auto;flex:1;font-size:12px;line-height:1.5}
    .chatMsg{margin-bottom:6px}
    .chatMsg .nm{color:var(--gold-2);font-weight:700;margin-right:6px}
    .chatSend{display:flex;gap:8px;border-top:1px solid var(--border);padding:8px;background:#0c0c0c}
    .inp, select{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0a0a0a;color:#f5f5f5;font-family:'Cinzel',serif;
      appearance:none; /* 드롭다운 하양 문제 해결 */
    }
    .sendBtn{
      padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:linear-gradient(180deg,#2b2b2b,#1e1e1e);color:#f5f5f5;font-weight:800;cursor:pointer;
    }

    /* 인증 오버레이 (URL 미제공 시) */
    .overlay{
      position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.75);z-index:50;
    }
    .ovCard{width:92%;max-width:520px;background:linear-gradient(180deg,#0e0e0e,#121212);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:18px}
    .ovTitle{color:var(--gold);font-weight:800;margin-bottom:12px}
    .field{margin-bottom:12px}
    .label{display:block;color:#cfcfcf;font-size:12px;margin-bottom:6px}
    .ovActions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    .btnPrimary{background:linear-gradient(180deg,#2b2b2b,#1e1e1e);border:1px solid var(--border);color:#f5f5f5;padding:10px 14px;border-radius:10px;font-weight:800;cursor:pointer;}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">PYXIS 전투 참가자</div>
    <div class="status"><span id="connDot" class="dot"></span><span id="connText">연결 대기</span></div>
  </div>

  <!-- URL 미제공 시 인증 -->
  <div class="overlay" id="overlay" style="display:none;">
    <div class="ovCard">
      <div class="ovTitle">전투 참가자 인증</div>
      <div class="field">
        <label class="label">전투 ID</label>
        <input class="inp" id="ovBattle" placeholder="예: battle_xxxxxx"/>
      </div>
      <div class="field">
        <label class="label">이름</label>
        <input class="inp" id="ovName" placeholder="표시될 이름"/>
      </div>
      <div class="field">
        <label class="label">비밀번호(OTP/Token)</label>
        <input class="inp" id="ovToken" placeholder="관리자가 발급한 비밀번호"/>
      </div>
      <div class="field">
        <label class="label">팀</label>
        <select id="ovTeam" class="inp">
          <option value="A">A팀</option>
          <option value="B">B팀</option>
        </select>
      </div>
      <div class="ovActions">
        <button class="btnPrimary" id="btnJoin">참가</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- 좌: 내 카드 + 실시간 로그 -->
    <div class="me">
      <div class="card">
        <div class="title">내 정보</div>
        <div class="row">
          <img id="meAvatar" class="ava" src="" alt="내 이미지">
          <div>
            <div class="name"><span id="meName">-</span> <span id="meTeam" class="pill">-팀</span></div>
            <div id="meHpText" class="hptext">HP 100/100</div>
            <div class="hpbar"><div id="meHpBar" class="hpfill" style="width:100%"></div></div>
          </div>
        </div>
        <div class="stats">
          <div class="sItem"><span class="sLabel">공격</span><span id="sAtk">-</span></div>
          <div class="sItem"><span class="sLabel">방어</span><span id="sDef">-</span></div>
          <div class="sItem"><span class="sLabel">민첩</span><span id="sAgi">-</span></div>
          <div class="sItem"><span class="sLabel">행운</span><span id="sLuk">-</span></div>
        </div>
        <div class="items">
          <div class="iItem">디터니 x <span id="itDit">0</span></div>
          <div class="iItem">공격 보정기 x <span id="itAtkB">0</span></div>
          <div class="iItem">방어 보정기 x <span id="itDefB">0</span></div>
        </div>
        <button id="btnReady" class="btnReady">준비 완료</button>
      </div>

      <div class="logBox card">
        <div class="logHead">실시간 로그</div>
        <div id="logBody" class="logBody"></div>
      </div>
    </div>

    <!-- 중앙: 현재 턴(초상화) + 팀 리스트 -->
    <div class="center">
      <div class="turnCard card">
        <img id="turnImg" class="turnImg" src="" alt="현재 턴 초상화">
        <div class="turnMeta">
          <div class="who" id="turnWho">-</div>
          <div>
            <span class="tag" id="turnTeamTag">-팀 차례</span>
            <span class="tag" id="turnRound">라운드 -</span>
          </div>
          <div class="timer" id="turnTimer">남은 시간: -</div>
        </div>
      </div>

      <div class="teamsRow">
        <div class="teamCard">
          <div class="teamTitle">A팀</div>
          <div id="listA" class="list"></div>
        </div>
        <div class="teamCard">
          <div class="teamTitle">B팀</div>
          <div id="listB" class="list"></div>
        </div>
      </div>
    </div>

    <!-- 우: 액션 + 채팅 -->
    <div class="right">
      <div class="actionCard card">
        <div class="title">행동</div>
        <div class="btnRow" style="margin-bottom:8px;">
          <button id="btnAttack" class="btn" disabled>공격</button>
          <button id="btnDefend" class="btn" disabled>방어</button>
        </div>
        <div class="btnRow" style="margin-bottom:8px;">
          <button id="btnDodge" class="btn" disabled>회피</button>
          <button id="btnPass" class="btn" disabled>패스</button>
        </div>
        <div class="btnRow">
          <button id="btnItemDittany" class="btn" disabled>디터니</button>
          <button id="btnItemAtkBoost" class="btn" disabled>공격 보정기</button>
        </div>
        <div class="btnRow" style="margin-top:8px;">
          <button id="btnItemDefBoost" class="btn" disabled style="grid-column: span 2;">방어 보정기</button>
        </div>
        <div class="note">※ 내 팀 차례 + 아직 행동 전일 때만 버튼 활성화됩니다.</div>
      </div>

      <div class="chatBox card">
        <div class="chatHead">채팅</div>
        <div id="chatBody" class="chatBody"></div>
        <div class="chatSend">
          <input id="chatMsg" class="inp" placeholder="메시지 입력(Enter 전송)"/>
          <button id="btnSend" class="sendBtn">전송</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ---------- DOM ---------- */
    const $ = (q)=> document.querySelector(q);
    const connDot=$('#connDot'), connText=$('#connText');

    // 내 카드
    const meAvatar=$('#meAvatar'), meName=$('#meName'), meTeam=$('#meTeam'),
          meHpText=$('#meHpText'), meHpBar=$('#meHpBar'),
          sAtk=$('#sAtk'), sDef=$('#sDef'), sAgi=$('#sAgi'), sLuk=$('#sLuk'),
          itDit=$('#itDit'), itAtkB=$('#itAtkB'), itDefB=$('#itDefB'),
          btnReady=$('#btnReady');

    // 로그/채팅
    const logBody=$('#logBody');
    const chatBody=$('#chatBody');
    const chatMsg=$('#chatMsg'), btnSend=$('#btnSend');

    // 중앙(턴)
    const turnImg=$('#turnImg'), turnWho=$('#turnWho'),
          turnTeamTag=$('#turnTeamTag'), turnRound=$('#turnRound'),
          turnTimer=$('#turnTimer');

    // 팀 리스트
    const listA=$('#listA'), listB=$('#listB');

    // 행동 버튼
    const btnAttack=$('#btnAttack'), btnDefend=$('#btnDefend'),
          btnDodge=$('#btnDodge'), btnPass=$('#btnPass'),
          btnItemDittany=$('#btnItemDittany'), btnItemAtkBoost=$('#btnItemAtkBoost'),
          btnItemDefBoost=$('#btnItemDefBoost');

    // 인증 오버레이
    const overlay=$('#overlay'), ovBattle=$('#ovBattle'), ovName=$('#ovName'),
          ovToken=$('#ovToken'), ovTeam=$('#ovTeam'), btnJoin=$('#btnJoin');

    /* ---------- 상태 ---------- */
    let socket=null;
    let battleId=null, myName=null, myTeam='A', token=null;
    let snapshot=null;
    let me=null; // 내 player object
    let myReady=false;
    let myActed=false; // 이번 페이즈에서 행동했는지
    let timerId=null, timeLeftSec=null;

    /* ---------- 유틸 ---------- */
    function setConn(on){
      if(on){ connDot.classList.add('on'); connText.textContent='연결됨'; }
      else { connDot.classList.remove('on'); connText.textContent='연결 끊김'; }
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function addLog({type='system', message='', ts=Date.now()}){
      const row=document.createElement('div');
      row.className=`logRow ${type}`;
      const time=new Date(ts).toLocaleTimeString('ko-KR',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
      row.innerHTML=`<span class="ts">${time}</span>${escapeHtml(message)}`;
      logBody.appendChild(row);
      logBody.scrollTop=logBody.scrollHeight;
      while(logBody.children.length>500) logBody.removeChild(logBody.firstChild);
    }
    function addChat({name='익명', message=''}){
      const el=document.createElement('div');
      el.className='chatMsg';
      el.innerHTML=`<span class="nm">${escapeHtml(name)}</span><span>${escapeHtml(message)}</span>`;
      chatBody.appendChild(el);
      chatBody.scrollTop=chatBody.scrollHeight;
      while(chatBody.children.length>400) chatBody.removeChild(chatBody.firstChild);
    }
    function d20(){ return Math.floor(Math.random()*20)+1; }

    /* ---------- 초기(URL 파라미터) ---------- */
    (function seedFromURL(){
      const u=new URL(window.location.href);
      const b=u.searchParams.get('battle');
      const n=u.searchParams.get('name');
      const t=u.searchParams.get('token')||u.searchParams.get('otp')||u.searchParams.get('password');
      const tm=u.searchParams.get('team');
      if(b) battleId=b;
      if(n) myName=n;
      if(t) token=t;
      if(tm==='B') myTeam='B';
      if(!battleId||!myName||!token){ overlay.style.display='flex'; }
    })();

    /* ---------- 렌더 ---------- */
    function renderMe(){
      if(!me) return;
      meAvatar.src=me.avatar||'';
      meName.textContent=me.name||'-';
      meTeam.textContent=(me.team||'A')+'팀';
      const hp=me.hp??100, mh=me.maxHp??100;
      meHpText.textContent=`HP ${hp}/${mh}`;
      meHpBar.style.width=Math.max(0,Math.min(100,Math.round(100*hp/mh)))+'%';
      sAtk.textContent=me.stats?.attack ?? '-';
      sDef.textContent=me.stats?.defense ?? '-';
      sAgi.textContent=me.stats?.agility ?? '-';
      sLuk.textContent=me.stats?.luck ?? '-';
      itDit.textContent=me.items?.dittany ?? 0;
      itAtkB.textContent=me.items?.attack_boost ?? 0;
      itDefB.textContent=me.items?.defense_boost ?? 0;
      btnReady.disabled=!!me.ready;
      if(btnReady.disabled){ btnReady.style.background='#000'; btnReady.style.color='#666'; }
    }
    function renderTeams(){
      const players=snapshot?.players||[];
      const A=players.filter(p=>(p.team||'A')==='A');
      const B=players.filter(p=>(p.team||'A')==='B');
      const make = (p)=>{
        const el=document.createElement('div');
        el.className='item';
        el.innerHTML=`
          <img class="avaS" src="${escapeHtml(p.avatar||'')}" alt="${escapeHtml(p.name||'전투 참가자')}">
          <div>
            <div class="nm">${escapeHtml(p.name||'전투 참가자')}</div>
            <div class="hp">HP ${p.hp ?? 100}/${p.maxHp ?? 100} · 공${p.stats?.attack ?? '-'} 방${p.stats?.defense ?? '-'} 민${p.stats?.agility ?? '-'} 행${p.stats?.luck ?? '-'}</div>
          </div>`;
        return el;
      };
      listA.innerHTML = A.length? '' : '<div class="item">A팀 없음</div>';
      A.forEach(p=> listA.appendChild(make(p)));
      listB.innerHTML = B.length? '' : '<div class="item">B팀 없음</div>';
      B.forEach(p=> listB.appendChild(make(p)));
    }
    function renderTurn(){
      const cur = snapshot?.turn?.current || null; // 서버가 current를 내려주는 경우 (없으면 추정)
      const currentTeam = snapshot?.currentTeam || snapshot?.turn?.currentTeam || snapshot?.turn?.order?.[snapshot?.turn?.phaseIndex || 0] || '-';
      const round = snapshot?.turn?.round || 1;
      turnTeamTag.textContent = `${currentTeam}팀 차례`;
      turnRound.textContent = `라운드 ${round}`;

      let actor = null;
      if(cur) actor = snapshot.players?.find(p=>p.id===cur.playerId) || null;
      // 없으면 내 팀/상대 팀에서 아직 행동 안한 첫 사람을 힌트로 추정
      if(!actor){
        const team = currentTeam || 'A';
        const teamList = (snapshot.players||[]).filter(p=> (p.team||'A')===team && (p.hp??1)>0);
        actor = teamList[0] || null;
      }
      if(actor){
        turnImg.src = actor.avatar || '';
        turnWho.textContent = `${actor.name || '전투 참가자'}`;
      }else{
        turnImg.src = '';
        turnWho.textContent = '-';
      }

      // 타이머(서버가 timeLeft 내려주면 사용)
      const sec = snapshot?.timeLeft ?? null;
      if (sec!=null){ startTimer(sec); }
      updateActionButtons();
    }
    function startTimer(sec){
      timeLeftSec = sec;
      if(timerId) clearInterval(timerId);
      timerId = setInterval(()=>{
        if(timeLeftSec==null) { clearInterval(timerId); timerId=null; return; }
        const m = Math.floor(timeLeftSec/60), s=timeLeftSec%60;
        turnTimer.textContent = `남은 시간: ${m}:${String(s).padStart(2,'0')}`;
        timeLeftSec = Math.max(0, timeLeftSec-1);
      }, 1000);
    }

    function updateActionButtons(){
      // 내 팀 차례 + 아직 행동 전 + 내가 생존
      const currentTeam = snapshot?.currentTeam || snapshot?.turn?.currentTeam || snapshot?.turn?.order?.[snapshot?.turn?.phaseIndex || 0] || '-';
      const canAct = (snapshot?.status==='active') && me && (me.hp??1)>0 && (currentTeam === (me.team||'A')) && !myActed;
      btnAttack.disabled = !canAct;
      btnDefend.disabled = !canAct;
      btnDodge.disabled = !canAct;
      btnPass.disabled = !canAct;

      btnItemDittany.disabled = !canAct || (me?.items?.dittany ?? 0) <= 0;
      btnItemAtkBoost.disabled = !canAct || (me?.items?.attack_boost ?? 0) <= 0;
      btnItemDefBoost.disabled = !canAct || (me?.items?.defense_boost ?? 0) <= 0;
    }

    /* ---------- 룰 계산(클라 낙관적) ---------- */
    function computeAttack(attacker, defender, opts={}){
      const rolls = { attackD20: d20(), defendD20: d20() };
      const atkScore = (attacker.stats?.attack||0) + rolls.attackD20;
      const dodgeScore = (defender.stats?.agility||0) + rolls.defendD20;

      // 회피
      if (dodgeScore >= atkScore){
        return { type:'attack', result:'evaded', rolls, damage:0, crit:false, defendMode:false };
      }

      // 치명타( D20 >= 20 - 행운/2 )
      const critRoll = d20();
      const crit = critRoll >= (20 - (attacker.stats?.luck||0)/2);

      // 방어 태세(상대가 방어중이라고 가정하는 경우 서버가 확인/적용)
      const defendMode = !!opts.defenderDefend;

      let dmgBase = (attacker.stats?.attack||0) + d20() - (defender.stats?.defense||0);
      if (defendMode){
        const extraDef = d20();
        dmgBase = (attacker.stats?.attack||0) + d20() - ((defender.stats?.defense||0) + extraDef);
        if (dmgBase < 0) dmgBase = 0; // 방어 성공시 최소 0
      }else{
        if (dmgBase < 1) dmgBase = 1; // 최소 1
      }

      let damage = dmgBase;
      // 공격 보정기(옵션 적용)
      if (opts.attackBoostApplied) damage = damage * 2;
      if (crit) damage = damage * 2;

      damage = Math.floor(Math.max(0, damage));
      return { type:'attack', result:'hit', rolls:{...rolls, critRoll}, damage, crit, defendMode };
    }
    function computeDefend(){
      // 다음 피격시 방어력 +D20 대응 → 서버가 상태로 관리하므로 여기선 의도만 보냄
      return { type:'defend' };
    }
    function computeDodge(){
      // 내 턴 소모, 다음 상대 공격 회피 판정(민첩+D20) → 서버 판단
      return { type:'dodge' };
    }
    function computePass(){
      return { type:'pass' };
    }
    function computeItem(itemType, target){
      if (itemType==='dittany'){
        return { type:'item', itemType, heal:10, success:true, targetId: target?.id || me?.id };
      }
      if (itemType==='attack_boost'){
        const success = Math.random()<0.10;
        return { type:'item', itemType, success };
      }
      if (itemType==='defense_boost'){
        const success = Math.random()<0.10;
        return { type:'item', itemType, success };
      }
      return { type:'item', itemType, success:false };
    }

    /* ---------- 소켓 ---------- */
    function bindSocket(){
      socket = window.io('/', { path:'/socket.io' });
      socket.on('connect', ()=> setConn(true));
      socket.on('disconnect', ()=> setConn(false));

      // 스냅샷
      const onSnap=(snap)=>{
        snapshot = snap || snapshot;
        // 내 객체 갱신
        if(snapshot?.players){
          me = snapshot.players.find(p=> p.name===myName) || me;
        }
        renderMe();
        renderTeams();
        renderTurn();
      };
      socket.on('battleUpdate', onSnap);
      socket.on('battle:update', onSnap);

      // 로그
      const onLog=(entry)=> addLog(entry);
      socket.on('battleLog', onLog);
      socket.on('battle:log', onLog);

      // 채팅/응원
      socket.on('chatMessage', ({name, message})=> addChat({name: name||'익명', message: message||''}));
      socket.on('cheerMessage', ({name, message})=> addChat({name: name||'관전자', message: message||''}));
      socket.on('spectator:cheer', ({name, message})=> addChat({name: name||'관전자', message: message||''}));

      // 인증 결과
      socket.on('authSuccess', (res)=>{
        addLog({type:'system', message:`인증 성공: ${res?.playerData?.name || myName}`});
        overlay.style.display='none';
        // 서버 snapshot 즉시 반영
        if(res?.battle) onSnap(res.battle);
      });
      socket.on('authError', (err)=>{
        addLog({type:'system', message:`인증 실패: ${err?.message || err?.error || '오류'}`});
        overlay.style.display='flex';
      });
    }

    function joinRoom(){
      if(!socket || !battleId) return;
      socket.emit('join', { battleId });
    }

    function authPlayer(){
      // 서버 구현체에 따라 password/token/otp 중 하나를 받음
      socket.emit('playerAuth', {
        battleId, password: token, token, otp: token, playerName: myName
      }, (res)=>{
        if(!res?.ok){
          addLog({type:'system', message:`인증 실패: ${res?.message || res?.error || '오류'}`});
          overlay.style.display='flex';
          return;
        }
        // 낙관 로그
        addLog({type:'system', message:`전투 참가: ${myName} (${myTeam}팀)`});
        joinRoom();
      });
    }

    /* ---------- 이벤트 바인딩 ---------- */
    // 오버레이 참가
    btnJoin.addEventListener('click', ()=>{
      const b=(ovBattle.value||'').trim();
      const n=(ovName.value||'').trim();
      const t=(ovToken.value||'').trim();
      const tm=(ovTeam.value||'A');
      if(!b||!n||!t){ alert('전투ID/이름/비밀번호를 모두 입력하세요.'); return; }
      battleId=b; myName=n; token=t; myTeam=tm;
      if(!socket) bindSocket();
      authPlayer();
    });

    // URL로 이미 제공된 경우 자동 연결
    if(battleId && myName && token){
      overlay.style.display='none';
      if(!socket) bindSocket();
      // 약간의 지연 후 인증
      setTimeout(()=> authPlayer(), 50);
    }

    // 준비 완료
    btnReady.addEventListener('click', ()=>{
      btnReady.disabled=true; btnReady.style.background='#000'; btnReady.style.color='#666';
      addLog({type:'system', message:`준비 완료: ${myName}`});
      socket.emit('playerReady', { battleId, playerId: me?.id, ready:true });
      socket.emit('player:ready', { battleId, playerId: me?.id, ready:true });
    });

    // 채팅
    function sendChat(){
      const msg=(chatMsg.value||'').trim(); if(!msg) return;
      socket.emit('chatMessage', { battleId, name: myName, message: msg, role:'player' });
      socket.emit('battle:chat', { battleId, name: myName, message: msg, senderName: myName });
      chatMsg.value='';
      // 낙관 표시
      addChat({name: myName, message: msg});
      addLog({type:'chat', message:`${myName}: ${msg}`});
    }
    btnSend.addEventListener('click', sendChat);
    chatMsg.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendChat(); });

    // 대상 선택 헬퍼(간단히: 현재 상대팀 생존자 중 첫 명 선택)
    function pickTargetEnemy(){
      const myT = me?.team||'A';
      const enemies = (snapshot?.players||[]).filter(p=> (p.team||'A')!==myT && (p.hp??1)>0);
      return enemies[0] || null;
    }

    // 행동 송신(+낙관 로그)
    function sendAction(payload, logText){
      if(!socket) return;
      // 낙관 로그
      addLog({type:'action', message: logText});
      myActed=true;
      updateActionButtons();

      // 호환 이벤트 동시 송신
      socket.emit('playerAction', { battleId, playerId: me?.id, ...payload });
      socket.emit('player:action', { battleId, playerId: me?.id, ...payload });
    }

    // 공격
    btnAttack.addEventListener('click', ()=>{
      const target = pickTargetEnemy();
      if(!target){ addLog({type:'system', message:'공격 대상이 없습니다.'}); return; }
      // 공격 보정기 자동 소모 여부는 서버가 확정하지만, 낙관 계산 옵션으로 표시
      const attackBoost = (me?.items?.attack_boost||0) > 0 ? false : false; // 자동 사용 안함(명시 버튼으로)
      const result = computeAttack(me, target, { attackBoostApplied: attackBoost, defenderDefend:false });
      sendAction({ type:'attack', targetId: target.id, clientCalc: result }, `공격 시도 → 대상: ${target.name}, 예상 피해: ${result.damage}${result.crit?' (치명타)':''}`);
    });

    // 방어
    btnDefend.addEventListener('click', ()=>{
      const result = computeDefend();
      sendAction(result, `방어 태세`);
    });

    // 회피
    btnDodge.addEventListener('click', ()=>{
      const result = computeDodge();
      sendAction(result, `회피 선택`);
    });

    // 패스
    btnPass.addEventListener('click', ()=>{
      const result = computePass();
      sendAction(result, `패스`);
    });

    // 아이템
    btnItemDittany.addEventListener('click', ()=>{
      // 아군 중 임의 타깃(기본: 나 자신)
      const target = me; // 기본 자힐
      const result = computeItem('dittany', target);
      sendAction(result, `아이템 사용: 디터니 → ${target?.name||'나'} (+10)`);
    });
    btnItemAtkBoost.addEventListener('click', ()=>{
      const result = computeItem('attack_boost');
      sendAction(result, `아이템 사용: 공격 보정기 ${result.success?'성공(2배 피해 적용)':'실패(소모됨)'}`);
    });
    btnItemDefBoost.addEventListener('click', ()=>{
      const result = computeItem('defense_boost');
      sendAction(result, `아이템 사용: 방어 보정기 ${result.success?'성공(이번 피격 2배 방어)':'실패(소모됨)'}`);
    });

  </script>
</body>
</html>
