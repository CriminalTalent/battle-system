<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>PYXIS - 전투 참가자</title>
<script src="/socket.io/socket.io.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#0e0e0e; --bg2:#141414;
    --glass-1:rgba(255,255,255,.06); --glass-2:rgba(255,255,255,.10);
    --border:rgba(255,255,255,.14);
    --text:#F8F9FA; --muted:#A9AFB6;
    --gold:#DCC7A2; --gold2:#E6D2A8;
    --radius:14px;
    --shadow:0 8px 24px rgba(0,0,0,.35);
    --serif:"Cinzel",serif;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{min-height:100vh;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--text);font-family:var(--serif)}
  .wrap{max-width:1400px;margin:0 auto;padding:18px;display:grid;grid-template-columns:1fr 520px 1fr;gap:14px;align-items:start;}
  @media (max-width:1200px){.wrap{grid-template-columns:1fr;gap:12px}}
  .card{background:var(--glass-2);border:1px solid var(--border);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
  .title{font-weight:700;color:var(--gold2);border-bottom:1px solid var(--border);padding-bottom:10px;margin-bottom:10px}
  .badge{display:inline-block;border:1px solid var(--border);padding:4px 8px;border-radius:10px;background:var(--glass-1);font-size:12px}
  .bar{height:10px;background:rgba(255,255,255,.10);border:1px solid var(--border);border-radius:999px;overflow:hidden}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,#b58d52,#e6d2a8)}
  .btn{display:inline-block;padding:10px 12px;border-radius:10px;border:2px solid var(--gold);color:var(--gold);background:transparent;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .me{display:flex;gap:12px;align-items:center}
  #meAvatar{width:64px;height:64px;border-radius:12px;border:1px solid var(--border);object-fit:cover;background:#0b0b0b}
  .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
  .kv{display:flex;justify-content:space-between;border:1px solid var(--border);border-radius:10px;padding:8px}
  .k{color:#c7af7b}.v{color:#e6d2a8}
  .mini{display:flex;gap:10px;align-items:center;border:1px solid var(--border);border-radius:10px;padding:8px}
  .mini img{width:38px;height:38px;border-radius:8px;object-fit:cover;background:#0b0b0b;border:1px solid var(--border)}
  .mini .box{flex:1}
  .mini .nm{font-size:12px}
  .mini .hp{height:8px;border-radius:6px;background:rgba(255,255,255,.12);border:1px solid var(--border);overflow:hidden;margin-top:4px}
  .mini .hp span{display:block;height:100%;background:linear-gradient(90deg,#b58d52,#e6d2a8)}
  .portrait{width:100%;aspect-ratio:1/1;border-radius:14px;border:1px solid var(--border);object-fit:cover;background:#0b0b0b;margin-bottom:10px}
  .meta{display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
  .pill{font-size:12px;border:1px solid var(--border);background:var(--glass-1);padding:6px 10px;border-radius:999px}
  .actions{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
  .act{padding:12px;border-radius:10px;border:2px solid transparent;background:var(--glass-1);cursor:pointer;text-align:center;color:#ddd}
  .act.enabled{border-color:#c7af7b;color:#e6d2a8;font-weight:700}
  .act:disabled{opacity:.45;cursor:not-allowed}
  .log{height:220px;overflow:auto;background:var(--glass-1);border:1px solid var(--border);border-radius:10px;padding:10px}
  .entry{font-size:12px;margin-bottom:6px}
  .entry .t{color:#000;margin-right:6px;font-size:10px}
  .entry.rule{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#111;border-radius:8px;padding:8px}
  .chatView{height:160px;overflow:auto;background:var(--glass-1);border:1px solid var(--border);border-radius:10px;padding:10px}
  .chatRow{display:flex;gap:8px;margin-top:8px}
  .chatRow input{flex:1;background:#0d0d0d;border:1px solid var(--border);border-radius:10px;padding:10px;color:#eee}
  .chatRow button{min-width:80px}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center}
  .ov-card{width:min(520px,92vw);background:#111;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:14px}
  .ov-title{font-weight:700;color:var(--gold2);border-bottom:1px solid var(--border);padding-bottom:10px;margin-bottom:10px}
  .ov-actions{display:flex;gap:8px;margin-top:10px}
  .ov-t{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .ov-mini{display:flex;gap:8px;align-items:center;border:1px solid var(--border);border-radius:10px;padding:8px}
  .ov-mini img{width:36px;height:36px;border-radius:8px;border:1px solid var(--border);object-fit:cover;background:#0b0b0b}
  .ov-mini .nm{font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <section class="card">
    <div class="title">전투 참가자(나)</div>
    <div class="me">
      <img id="meAvatar" alt="내 초상화">
      <div>
        <div id="meName" style="font-weight:700">-</div>
        <div class="badge" id="meTeam">-</div>
        <div class="bar"><span id="meHpBar" style="width:100%"></span></div>
        <div class="badge" id="meHpText">HP 100/100</div>
      </div>
    </div>
    <div class="stats" style="margin-top:12px">
      <div class="kv"><div class="k">공격</div><div id="sAtk" class="v">-</div></div>
      <div class="kv"><div class="k">방어</div><div id="sDef" class="v">-</div></div>
      <div class="kv"><div class="k">민첩</div><div id="sAgi" class="v">-</div></div>
      <div class="kv"><div class="k">행운</div><div id="sLuck" class="v">-</div></div>
    </div>
    <div style="margin-top:10px"><button id="btnReady" class="btn">준비 완료</button></div>
    <div class="title" style="border:none;margin:14px 0 8px;color:#e6d2a8">내 팀</div>
    <div id="allyList"></div>
  </section>

  <section class="card">
    <img id="turnPortrait" class="portrait" alt="현재 차례 초상화"/>
    <div class="meta">
      <div class="pill">라운드 <span id="round">1</span></div>
      <div class="pill"><span id="turnTeam">-팀</span> 차례</div>
      <div class="pill">남은 시간 <span id="turnTimer">--:--</span></div>
    </div>
    <div class="actions">
      <button id="btnAttack" class="act" disabled>공격</button>
      <button id="btnDefend" class="act" disabled>방어</button>
      <button id="btnDodge"  class="act" disabled>회피</button>
      <button id="btnItem"   class="act" disabled>아이템</button>
      <button id="btnPass"   class="act" disabled>패스</button>
    </div>
  </section>

  <section class="card">
    <div class="title">상대 팀</div>
    <div id="enemyList"></div>

    <div class="title" style="margin-top:12px">실시간 로그</div>
    <div id="log" class="log"></div>

    <div class="title" style="margin-top:12px">채팅</div>
    <div id="chatView" class="chatView"></div>
    <div class="chatRow">
      <input id="chatMsg" type="text" maxlength="140" placeholder="메시지 입력"/>
      <button id="btnSend" class="btn">전송</button>
    </div>
  </section>
</div>

<div id="overlay" class="overlay" role="dialog" aria-modal="true">
  <div class="ov-card">
    <div class="ov-title">공격 대상 선택</div>
    <div id="targetList" class="ov-t"></div>
    <div class="ov-actions">
      <button id="btnCancelTarget" class="btn" style="flex:1;background:#222;color:#ddd;border-color:#444">취소</button>
    </div>
  </div>
</div>

<script>
  // 유틸
  function $(s,r=document){ return r.querySelector(s); }
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[c])); }
  function fmt(ts){ const d=new Date(ts||Date.now()); return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }
  function setImg(img,url){ img.src=url||'/uploads/avatars/default.svg'; img.onerror=()=>{ img.onerror=null; img.src='/uploads/avatars/default.svg'; }; }

  // DOM
  const meAvatar=$('#meAvatar'), meNameEl=$('#meName'), meTeamEl=$('#meTeam'), meHpBar=$('#meHpBar'), meHpText=$('#meHpText');
  const sAtk=$('#sAtk'), sDef=$('#sDef'), sAgi=$('#sAgi'), sLuck=$('#sLuck');
  const roundEl=$('#round'), turnTeamEl=$('#turnTeam'), turnTimerEl=$('#turnTimer'), turnPortrait=$('#turnPortrait');
  const btnReady=$('#btnReady');
  const btnAttack=$('#btnAttack'), btnDefend=$('#btnDefend'), btnDodge=$('#btnDodge'), btnItem=$('#btnItem'), btnPass=$('#btnPass');
  const allyList=$('#allyList'), enemyList=$('#enemyList'), logEl=$('#log'), chatView=$('#chatView'), chatMsg=$('#chatMsg'), btnSend=$('#btnSend');
  const overlay=$('#overlay'), targetList=$('#targetList'), btnCancelTarget=$('#btnCancelTarget');

  function addLog(msg, cls=''){
    if(!msg) return;
    const div=document.createElement('div');
    div.className='entry'+(cls?(' '+cls):'');
    div.innerHTML=`<span class="t">${fmt(Date.now())}</span>${escapeHtml(msg)}`;
    logEl.appendChild(div); logEl.scrollTop=logEl.scrollHeight;
  }

  // 상태
  let socket=null, battleId='', me=null, myTeam='A', snapshot=null;
  let _timerStartAt=0, _timerBaseSec=null, _timerHandle=null;
  let __lastLogKey=null;

  function renderMe(){
    if(!me) return;
    myTeam = me.team || myTeam;
    meNameEl.textContent = me.name || '-';
    meTeamEl.textContent = myTeam + '팀';
    const ratio = Math.max(0, Math.min(100, Math.round((me.hp||0)/(me.maxHp||100)*100)));
    meHpBar.style.width = ratio+'%';
    meHpText.textContent = `HP ${me.hp||0}/${me.maxHp||100}`;
    const st = me.stats||{};
    sAtk.textContent = ('attack' in st ? st.attack : '-');
    sDef.textContent = ('defense' in st ? st.defense : '-');
    sAgi.textContent = ('agility' in st ? st.agility : '-');
    sLuck.textContent = ('luck'    in st ? st.luck    : '-');
    setImg(meAvatar, me.avatar);
  }

  function rowFor(p){
    const row=document.createElement('div'); row.className='mini';
    const img=document.createElement('img'); setImg(img,p.avatar);
    const box=document.createElement('div'); box.className='box';
    const hpRatio = Math.max(0, Math.min(100, Math.round((p.hp||0)/(p.maxHp||100)*100)));
    const st=p.stats||{};
    box.innerHTML=`<div class="nm">${escapeHtml(p.name||'-')}</div>
                   <div class="hp"><span style="width:${hpRatio}%"></span></div>
                   <div style="font-size:11px;color:var(--muted);margin-top:2px">공 ${('attack'in st?st.attack:'-')} / 방 ${('defense'in st?st.defense:'-')} / 민 ${('agility'in st?st.agility:'-')} / 행 ${('luck'in st?st.luck:'-')}</div>`;
    row.appendChild(img); row.appendChild(box);
    return row;
  }

  function renderTeams(){
    if(!snapshot) return;
    const my=[], opp=[];
    (snapshot.players||[]).forEach(p=> (p.team===myTeam?my:opp).push(rowFor(p)) );
    allyList.innerHTML=''; enemyList.innerHTML='';
    my.forEach(n=>allyList.appendChild(n));
    opp.forEach(n=>enemyList.appendChild(n));
  }

  function renderTimer(){
    if(_timerBaseSec==null){ turnTimerEl.textContent='--:--'; return; }
    const passed=Math.floor((Date.now()-_timerStartAt)/1000);
    const left=Math.max(0,_timerBaseSec-passed);
    const m=String(Math.floor(left/60)).padStart(2,'0');
    const s=String(left%60).padStart(2,'0');
    turnTimerEl.textContent = `${m}:${s}`;
  }

  function onUpdate(b){
    snapshot = b;
    if(me && snapshot){
      const m = (snapshot.players||[]).find(x=>x.id===me.id);
      if(m) me = m;
    }
    renderMe(); renderTeams();

    roundEl.textContent = b.currentTurn?.turnNumber ?? '-';
    turnTeamEl.textContent = (b.currentTurn?.currentTeam||'-')+'팀';

    // 현재 턴 초상화: 서버 값 → 없으면 현재 팀 첫 생존자 폴백
    let ava = b.currentTurn?.currentPlayer?.avatar || null;
    if(!ava){
      const team = b.currentTurn?.currentTeam || null;
      const cp = (snapshot?.players||[]).find(p=>team && p.team===team && p.hp>0);
      ava = cp?.avatar || null;
    }
    setImg(turnPortrait, ava);

    // 타이머: 항상 재시작
    _timerBaseSec = (typeof b.currentTurn?.timeLeftSec==='number') ? b.currentTurn.timeLeftSec : null;
    _timerStartAt = Date.now();
    if(_timerHandle){ clearInterval(_timerHandle); _timerHandle=null; }
    _timerHandle = setInterval(renderTimer, 1000);
    renderTimer();

    // 버튼: 팀 차례 기준
    const enabled = (b.currentTurn?.currentTeam===me?.team);
    [btnAttack,btnDefend,btnDodge,btnItem,btnPass].forEach(el=>{ el.disabled=!enabled; el.classList.toggle('enabled',enabled); });
  }

  function onLog(entry){
    const msg = entry?.message || '';
    // 디버그 패턴 숨김 (예: "444 · attack (...)" )
    if (/·\s*attack\s*\(/i.test(msg)) return;
    const key = String(entry?.ts||'')+':'+msg; if (__lastLogKey===key) return; __lastLogKey=key;
    const cls = (entry?.type==='battle') ? 'rule' : '';
    addLog(msg, cls);
  }

  // 연결/인증
  function bindSocket(){
    const q = new URLSearchParams(location.search);
    battleId = q.get('battle') || '';
    const myName = q.get('name') || '';
    const token  = q.get('password') || q.get('token') || q.get('otp') || '';
    const playerId = q.get('playerId') || q.get('pid') || '';

    socket = io({ path:'/socket.io' });

    socket.on('connect', ()=>{
      if(!battleId){ addLog('battle 파라미터가 없습니다.','err'); return; }
      socket.emit('join', { battleId });
      socket.emit('playerAuth', { battleId, token, password:token, otp:token, playerId, playerName: myName }, (res)=>{
        if(!res?.ok){ addLog('인증 실패','err'); return; }
        me = { id: res.playerId, name: res.name, team: res.team, avatar: res.avatar, hp:100, maxHp:100, stats:{} };
        if(res.battle){ snapshot = res.battle; const m=(snapshot.players||[]).find(x=>x.id===me.id); if(m) me=m; }
        renderMe(); renderTeams();
      });
    });

    // 스냅샷/로그 (호환 수신)
    socket.on('battleUpdate', onUpdate);
    socket.on('battle:update', onUpdate); // 구호환 수신만
    socket.on('battle:log', onLog);
    socket.on('battleLog', onLog);       // 구호환 수신만

    // 준비 완료
    btnReady.addEventListener('click', ()=>{
      if(!me?.id) return;
      btnReady.disabled = true;
      socket.emit('player:ready', { battleId, playerId: me.id }, (r)=>{ if(!r?.ok){ btnReady.disabled=false; addLog('준비 실패','err'); } });
    });

    // 채팅 (이름은 캐릭터명)
    btnSend.addEventListener('click', ()=>{
      const m = String(chatMsg.value||'').trim(); if(!m) return;
      socket.emit('chatMessage', { battleId, name:(me?.name||'전투 참가자'), message:m });
      chatMsg.value='';
    });
    chatMsg.addEventListener('keydown', (e)=>{ if(e.key==='Enter') btnSend.click(); });
  }

  document.addEventListener('DOMContentLoaded', bindSocket);
</script>
</body>
</html>
