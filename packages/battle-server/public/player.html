<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PYXIS - 전투 참가자</title>
  <style>
    :root{
      --deep-navy:#000813;
      --gold:#DCC7A2;
      --gold-bright:#D4BA8D;
      --glass-1:rgba(0,8,19,.7);
      --glass-2:rgba(0,8,19,.5);
      --border:rgba(220,199,162,.28);
      --text:#fff;
      --text-muted:rgba(255,255,255,.75);
      --radius:8px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Cinzel', serif;
      background:linear-gradient(135deg, var(--deep-navy) 0%, #001122 100%);
      color:var(--text);
      min-height:100vh;
    }
    header{
      padding:18px 16px; text-align:center;
      background:var(--glass-1); border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:5; backdrop-filter:blur(10px);
    }
    .title{ color:var(--gold); font-weight:700; font-size:2rem; letter-spacing:.12em; text-shadow:0 0 14px rgba(220,199,162,.4) }

    .wrap{
      max-width:1280px; margin:0 auto; padding:18px 16px 40px;
      display:grid; gap:18px; grid-template-columns: 1fr 1.2fr 1fr;
      align-items:start;
    }
    @media (max-width: 1080px){
      .wrap{ grid-template-columns: 1fr; }
    }

    /* 좌측: 내 정보 + 팀 요약 */
    .card{ background:var(--glass-1); border:1px solid var(--border); border-radius:var(--radius); padding:14px; backdrop-filter:blur(8px) }
    .lead{ color:var(--gold); font-weight:700; margin-bottom:8px }
    .me{
      display:grid; gap:12px;
    }
    .me-row{ display:flex; gap:12px; align-items:center }
    .me-avatar{
      width:70px; height:70px; border-radius:50%; border:3px solid var(--gold);
      object-fit:cover; background:#08111f;
    }
    .hpbar{ position:relative; height:8px; border-radius:10px; background:#0f1b2b; border:1px solid var(--border); overflow:hidden }
    .hpfill{ position:absolute; left:0; top:0; height:100%; background:linear-gradient(90deg,#4ade80 0%,#22c55e 100%); transition:width .25s ease }
    .hptext{ font-size:.8rem; color:var(--text-muted) }
    .stats{ font-size:.8rem; color:var(--text-muted); font-family:'JetBrains Mono', monospace }

    .teambox{ display:grid; gap:10px }
    .pcard{ background:var(--glass-2); border:1px solid var(--border); border-radius:10px; padding:10px; display:grid; gap:8px }
    .prow{ display:flex; align-items:center; gap:10px }
    .pavatar{ width:44px; height:44px; border-radius:50%; border:2px solid var(--gold); object-fit:cover; background:#08111f }
    .pname{ color:var(--gold); font-weight:700; font-size:.95rem }

    /* 중앙: 현재 턴 + 액션 */
    .status{
      display:grid; gap:12px;
      background:var(--glass-1); border:1px solid var(--border); border-radius:var(--radius);
      padding:14px;
    }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .pill{ display:inline-block; padding:2px 10px; border-radius:14px; background:var(--gold); color:var(--deep-navy); font-size:.8rem; font-weight:700 }
    .big{
      display:grid; grid-template-columns: 110px 1fr 130px; gap:12px; align-items:center;
    }
    .big-avatar{ width:110px; height:110px; border-radius:50%; border:3px solid var(--gold); object-fit:cover; background:#08111f }
    .muted{ color:var(--text-muted); font-size:.9rem }
    .timer{ text-align:right; color:var(--gold); font-family:'JetBrains Mono', monospace; font-weight:700 }

    .actions{ display:grid; gap:10px; grid-template-columns: repeat(5, minmax(0,1fr)) }
    .btn{ border:none; cursor:pointer; border-radius:8px; padding:10px 12px; font-weight:700; background:linear-gradient(135deg, var(--gold) 0%, var(--gold-bright) 100%); color:#0b0f14 }
    .btn.ghost{ background:transparent; border:1px solid var(--gold); color:var(--gold) }
    .btn.danger{ background:#3b0c0c; border:1px solid #8a5; color:#DCC7A2 }
    .btn:disabled{ opacity:.55; cursor:not-allowed }

    /* 우측: 로그/채팅 */
    .panel{ background:var(--glass-1); border:1px solid var(--border); border-radius:var(--radius); padding:14px }
    .logs, .chat{ max-height:260px; overflow:auto; display:grid; gap:6px }
    .log-entry, .chat-entry{ font-size:.9rem; line-height:1.45; color:var(--text); background:rgba(255,255,255,.02); border:1px solid rgba(220,199,162,.12); border-radius:8px; padding:6px 8px }
    .log-entry.rule{ background:var(--gold); color:#000; font-weight:700 }
    .tmark{ font-family:'JetBrains Mono', monospace; color:#000; background:var(--gold); border-radius:6px; padding:0 6px; margin-right:6px }

    .chat-send{ display:flex; gap:8px; margin-top:8px }
    .input{
      flex:1; padding:10px 12px; border-radius:8px; background:#0b1420; color:var(--text); border:1px solid var(--border); outline:none;
    }

    /* 선택 오버레이 */
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; align-items:center; justify-content:center; z-index:20 }
    .ovcard{ width:min(680px,96vw); background:var(--glass-1); border:1px solid var(--border); border-radius:12px; padding:16px; display:grid; gap:12px; backdrop-filter:blur(10px) }
    .ovgrid{ display:grid; gap:10px; grid-template-columns: repeat(2, minmax(0,1fr)) }
    .sel{ display:flex; gap:10px; align-items:center; padding:10px; border:1px solid var(--border); border-radius:10px; background:var(--glass-2); cursor:pointer }
    .sel:hover{ border-color:var(--gold) }
    .savatar{ width:48px; height:48px; border-radius:50%; border:2px solid var(--gold); object-fit:cover; background:#08111f }
    .center-right{ display:flex; gap:10px; justify-content:flex-end }
  </style>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet"/>
</head>
<body>
  <header><div class="title">PYXIS</div></header>

  <div class="wrap">
    <!-- 좌: 내 정보 + 팀 요약 -->
    <section class="card">
      <div class="lead">내 정보</div>
      <div class="me">
        <div class="me-row">
          <img id="meAvatar" class="me-avatar" src="/uploads/avatars/default.svg" onerror="this.src='/uploads/avatars/default.svg'" alt="내 초상화"/>
          <div>
            <div id="meName" class="lead" style="margin:0">-</div>
            <div id="meTeam" class="muted">-팀</div>
          </div>
        </div>
        <div>
          <div class="hpbar"><div id="meHpFill" class="hpfill" style="width:0%"></div></div>
          <div id="meHpText" class="hptext">0/0</div>
        </div>
        <div id="meStats" class="stats">공:- 방:- 민:- 행:-</div>
        <div>
          <button id="btnReady" class="btn" style="width:100%">준비 완료</button>
        </div>
      </div>

      <div style="height:14px"></div>

      <div class="lead">A팀</div>
      <div id="teamA" class="teambox"></div>

      <div style="height:14px"></div>

      <div class="lead">B팀</div>
      <div id="teamB" class="teambox"></div>
    </section>

    <!-- 중앙: 현재 턴 + 액션 -->
    <section class="status">
      <div class="big">
        <img id="curAvatar" class="big-avatar" src="/uploads/avatars/default.svg" onerror="this.src='/uploads/avatars/default.svg'" alt="현재 턴"/>
        <div>
          <div class="row"><span id="curTeamPill" class="pill">-팀</span><span id="curName" class="lead">현재 턴: -</span></div>
          <div id="roundInfo" class="muted">라운드 -</div>
        </div>
        <div class="timer">
          <div>남은 시간</div>
          <div id="timeLeft">--:--</div>
        </div>
      </div>

      <div class="lead">행동 선택</div>
      <div class="actions">
        <button id="actAttack" class="btn">공격</button>
        <button id="actDefend" class="btn ghost">방어</button>
        <button id="actDodge"  class="btn ghost">회피</button>
        <button id="actItem"   class="btn ghost">아이템</button>
        <button id="actPass"   class="btn danger">패스</button>
      </div>
      <div class="muted">내 팀 차례가 아니거나 내 선택을 마치면 버튼이 비활성화됩니다.</div>
    </section>

    <!-- 우: 로그 / 채팅 -->
    <section class="panel">
      <div class="lead" style="margin-bottom:8px">실시간 로그</div>
      <div id="logs" class="logs"></div>
    </section>

    <section class="panel">
      <div class="lead" style="margin-bottom:8px">채팅</div>
      <div id="chat" class="chat"></div>
      <div class="chat-send">
        <input id="chatInput" class="input" type="text" placeholder="메시지 입력..." />
        <button id="chatSend" class="btn">전송</button>
      </div>
    </section>
  </div>

  <!-- 타깃/아이템 선택 오버레이 -->
  <div id="overlay" class="overlay">
    <div class="ovcard">
      <div class="lead" id="ovTitle">대상 선택</div>
      <div id="ovGrid" class="ovgrid"></div>
      <div class="center-right">
        <button id="ovCancel" class="btn ghost">취소</button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
  (function(){
    // ---------------------------
    // 초기 상태/전역
    // ---------------------------
    const qs = new URL(location.href).searchParams;
    const socket = io({ path: "/socket.io" });

    const battleId = qs.get("battle") || "";
    const token    = qs.get("token") || qs.get("password") || qs.get("otp") || "";
    const qPid     = qs.get("playerId") || "";
    const qName    = qs.get("name") || "";
    const qTeam    = qs.get("team") || "";

    let my = { id:null, name:qName||"", team:qTeam||"", avatar:null };
    let actedThisTurn = false;
    let lastTurnNumber = null;
    let timeLeft = null, tick = null;

    const seenLogs = new Set();
    const seenChat = new Set();
    const SEEN_MAX = 200;
    function seenAdd(set,key){ set.add(key); if(set.size>SEEN_MAX){ const it=set.values(); set.delete(it.next().value);} }

    // ---------------------------
    // 유틸
    // ---------------------------
    function escapeHtml(t){ return String(t ?? "").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function fmtClock(s){ if(s==null||isNaN(s)) return "--:--"; const m=Math.floor(s/60), ss=s%60; return String(m).padStart(2,"0")+":"+String(ss).padStart(2,"0"); }
    function setDisabled(sel, v){ document.querySelectorAll(sel).forEach(b=> b.disabled = !!v); }

    function hpRatio(hp,maxHp){ const m=Number(maxHp||100), h=Math.max(0,Number(hp||0)); return Math.max(0,Math.min(100,Math.round((h/m)*100))); }

    function setMeUI(p){
      const max=Number(p.maxHp||100), hp=Number(p.hp||0);
      document.getElementById('meAvatar').src = p.avatar || "/uploads/avatars/default.svg";
      document.getElementById('meName').textContent = p.name || "-";
      document.getElementById('meTeam').textContent = (p.team? p.team+"팀" : "-팀");
      document.getElementById('meHpFill').style.width = hpRatio(hp,max)+"%";
      document.getElementById('meHpText').textContent = hp+"/"+max;
      document.getElementById('meStats').textContent = `공:${p.stats?.attack??1} 방:${p.stats?.defense??1} 민:${p.stats?.agility??1} 행:${p.stats?.luck??1}`;
    }

    function renderTeams(players){
      const A = players.filter(p=>p.team==="A");
      const B = players.filter(p=>p.team==="B");
      const elA = document.getElementById('teamA');
      const elB = document.getElementById('teamB');
      elA.innerHTML=""; elB.innerHTML="";

      function card(p){
        const max=Number(p.maxHp||100), hp=Number(p.hp||0);
        const div=document.createElement('div');
        div.className="pcard";
        div.innerHTML = `
          <div class="prow">
            <img class="pavatar" src="${escapeHtml(p.avatar||"/uploads/avatars/default.svg")}" onerror="this.src='/uploads/avatars/default.svg'" alt="${escapeHtml(p.name)}"/>
            <div>
              <div class="pname">${escapeHtml(p.name)}</div>
              <div class="hpbar"><div class="hpfill" style="width:${hpRatio(hp,max)}%"></div></div>
              <div class="hptext">${hp}/${max}</div>
            </div>
          </div>
          <div class="stats">공:${p.stats?.attack??1} 방:${p.stats?.defense??1} 민:${p.stats?.agility??1} 행:${p.stats?.luck??1}</div>
        `;
        return div;
      }
      A.forEach(p=>elA.appendChild(card(p)));
      B.forEach(p=>elB.appendChild(card(p)));
    }

    function renderStatus(snap){
      const ct = snap?.currentTurn || {};
      const curTeam = ct.currentTeam || "-";
      const turnNo  = snap?.currentTurn?.turnNumber || 0;
      const curP    = ct.currentPlayer || null;

      document.getElementById('curTeamPill').textContent = (curTeam ? curTeam+"팀" : "-팀");
      document.getElementById('curName').textContent = "현재 턴: " + (curP?.id ? (snap.players.find(x=>x.id===curP.id)?.name || "-") : "-");
      document.getElementById('roundInfo').textContent  = "라운드 " + (turnNo || "-");

      document.getElementById('curAvatar').src = (curP?.avatar || "/uploads/avatars/default.svg");

      // 타이머
      timeLeft = (ct.timeLeftSec ?? null);
      document.getElementById('timeLeft').textContent = fmtClock(timeLeft);
      if (tick) clearInterval(tick);
      tick = setInterval(()=>{
        if (timeLeft==null) return;
        timeLeft = Math.max(0, timeLeft-1);
        document.getElementById('timeLeft').textContent = fmtClock(timeLeft);
      }, 1000);

      // 행동 가능/불가
      const canAct = (my.team && curTeam===my.team && !actedThisTurn);
      setDisabled(".actions .btn", !canAct);

      // 턴 바뀌면 내 acted 리셋
      if (lastTurnNumber===null || lastTurnNumber !== turnNo){
        lastTurnNumber = turnNo;
        actedThisTurn = false;
        setDisabled(".actions .btn", !(my.team && curTeam===my.team));
      }
    }

    function addLog(entry){
      if(!entry?.message) return;
      const key=`${entry.ts}|${entry.message}`;
      if(seenLogs.has(key)) return; seenAdd(seenLogs,key);
      const row=document.createElement('div');
      row.className="log-entry"+(entry.type==="battle"?" rule":"");
      const t=new Date(entry.ts||Date.now()).toLocaleTimeString();
      row.innerHTML=`<span class="tmark">${escapeHtml(t)}</span>${escapeHtml(entry.message)}`;
      const box=document.getElementById('logs'); box.appendChild(row); box.scrollTop=box.scrollHeight;
    }
    function addChat(payload){
      const name = payload?.name || payload?.playerName || "익명";
      const msg  = payload?.message || payload?.text || "";
      if(!msg) return;
      const key=`${name}|${msg}|${Math.floor(Date.now()/1500)}`;
      if(seenChat.has(key)) return; seenAdd(seenChat,key);
      const row=document.createElement('div');
      row.className="chat-entry"; row.textContent=`[${name}] ${msg}`;
      const box=document.getElementById('chat'); box.appendChild(row); box.scrollTop=box.scrollHeight;
    }

    // ---------------------------
    // 오버레이(타깃/아이템)
    // ---------------------------
    const overlay = document.getElementById('overlay');
    const ovTitle = document.getElementById('ovTitle');
    const ovGrid  = document.getElementById('ovGrid');
    document.getElementById('ovCancel').addEventListener('click', ()=> overlay.style.display='none');

    function openTargetOverlay(title, list, onPick){
      ovTitle.textContent = title;
      ovGrid.innerHTML = "";
      list.forEach(p=>{
        const el=document.createElement('div');
        el.className="sel";
        el.innerHTML = `
          <img class="savatar" src="${escapeHtml(p.avatar||"/uploads/avatars/default.svg")}" onerror="this.src='/uploads/avatars/default.svg'">
          <div>
            <div class="pname" style="font-size:.95rem">${escapeHtml(p.name)}</div>
            <div class="stats">공:${p.stats?.attack??1} 방:${p.stats?.defense??1} 민:${p.stats?.agility??1} 행:${p.stats?.luck??1}</div>
          </div>
        `;
        el.addEventListener('click', ()=>{ overlay.style.display='none'; onPick && onPick(p); });
        ovGrid.appendChild(el);
      });
      overlay.style.display = "flex";
    }

    // ---------------------------
    // 소켓: 수신
    // ---------------------------
    socket.on("battleUpdate", (snap)=>{ renderStatus(snap); renderTeams(snap.players||[]); if(my.id){ const me=snap.players.find(p=>p.id===my.id); if(me) setMeUI(me); }});
    socket.on("battle:update", (snap)=>{ renderStatus(snap); renderTeams(snap.players||[]); if(my.id){ const me=snap.players.find(p=>p.id===my.id); if(me) setMeUI(me); }});

    socket.on("battle:log", addLog);
    socket.on("battleLog",  addLog);

    socket.on("chatMessage", addChat);
    socket.on("battle:chat", addChat);

    // 액션 성공(호환)
    socket.on("actionSuccess", (_)=>{ /* 필요 시 토스트 */ });
    socket.on("player:action:success", (_)=>{ /* 호환 */ });

    // 인증 성공/실패(호환)
    function onAuthSuccess(payload){
      // payload: { ok, playerId, name, team, avatar, battle }
      my.id   = payload?.playerId || my.id;
      my.name = payload?.name || my.name;
      my.team = payload?.team || my.team;
      my.avatar = payload?.avatar || my.avatar;
      if (payload?.battle) {
        renderTeams(payload.battle.players||[]);
        if (my.id){
          const me = (payload.battle.players||[]).find(p=>p.id===my.id);
          if (me) setMeUI(me);
        }
      }
      // 내 이름/팀 반영
      if (my.avatar) document.getElementById('meAvatar').src = my.avatar;
      document.getElementById('meName').textContent = my.name || "-";
      document.getElementById('meTeam').textContent = (my.team? my.team+"팀" : "-팀");
      // 방 합류(보장)
      if (battleId) socket.emit("join", { battleId });
      addLog({ ts:Date.now(), type:"system", message:`${my.name} 인증 성공` });
    }
    function onAuthError(_){ addLog({ ts:Date.now(), type:"error", message:"인증 실패" }); }

    socket.on("authSuccess", onAuthSuccess);
    socket.on("auth:success", onAuthSuccess);
    socket.on("authError", onAuthError);

    // ---------------------------
    // 소켓: 송신 helpers
    // ---------------------------
    function joinRoom(){ if(battleId) socket.emit("join", { battleId }); }
    function sendReady(){
      if (!battleId || !my.id) return;
      // 중복 방지: 버튼 즉시 비활성화
      const btn=document.getElementById('btnReady');
      btn.disabled = true; btn.classList.add('ghost');
      socket.emit("player:ready", { battleId, playerId: my.id }, (r)=>{ if(!(r?.ok)){ btn.disabled=false; btn.classList.remove('ghost'); }});
    }
    function sendAction(action){
      if (!battleId || !my.id) return;
      socket.emit("player:action", { battleId, playerId: my.id, action }, (r)=>{
        if (r?.ok){ actedThisTurn = true; setDisabled(".actions .btn", true); }
      });
    }

    // ---------------------------
    // 버튼 바인딩
    // ---------------------------
    document.getElementById('btnReady').addEventListener('click', sendReady);

    // 공격
    document.getElementById('actAttack').addEventListener('click', ()=>{
      // 최신 스냅샷에서 적 팀 대상 구성(렌더 함수에서 마지막 players를 재조회)
      const snapPlayers = (window.__lastPlayers || []);
      const enemies = snapPlayers.filter(p=>p.team && my.team && p.team!==my.team && p.hp>0);
      if (enemies.length===0) return;
      openTargetOverlay("공격 대상 선택", enemies, (t)=> sendAction({ type:"attack", targetId: t.id }));
    });

    // 방어
    document.getElementById('actDefend').addEventListener('click', ()=> sendAction({ type:"defend" }));

    // 회피
    document.getElementById('actDodge').addEventListener('click',  ()=> sendAction({ type:"dodge"  }));

    // 아이템
    document.getElementById('actItem').addEventListener('click', ()=>{
      // 간단 아이템 선택 → 디터니는 아군 대상 선택 UI
      const box=document.createElement('div');
      box.style.display='grid'; box.style.gap='10px';
      box.innerHTML=`
        <button id="itDittany" class="btn">디터니(+10)</button>
        <button id="itAtkB"   class="btn ghost">공격 보정기</button>
        <button id="itDefB"   class="btn ghost">방어 보정기</button>
      `;
      const grid=document.getElementById('ovGrid'); grid.innerHTML=""; grid.appendChild(box);
      ovTitle.textContent="아이템 선택"; overlay.style.display="flex";

      function close(){ overlay.style.display='none'; }

      box.querySelector('#itDittany').addEventListener('click', ()=>{
        // 같은 팀 대상 선택
        const allies = (window.__lastPlayers||[]).filter(p=>p.team===my.team && p.hp>0);
        openTargetOverlay("디터니 대상 선택(같은 팀)", allies, (t)=> sendAction({ type:"item", item:"dittany", metaTargetId: t.id }));
      });
      box.querySelector('#itAtkB').addEventListener('click', ()=>{ close(); sendAction({ type:"item", item:"attackBooster" }); });
      box.querySelector('#itDefB').addEventListener('click', ()=>{ close(); sendAction({ type:"item", item:"defenseBooster" }); });
    });

    // 패스
    document.getElementById('actPass').addEventListener('click', ()=> sendAction({ type:"pass" }));

    // 채팅
    function sendChat(){
      const inp=document.getElementById('chatInput');
      const msg=inp.value.trim(); if(!msg || !battleId) return;
      const name=my.name || "전투 참가자";
      socket.emit("chatMessage", { battleId, name, message: msg });
      inp.value="";
    }
    document.getElementById('chatSend').addEventListener('click', sendChat);
    document.getElementById('chatInput').addEventListener('keydown', (e)=>{ if(e.key==="Enter") sendChat(); });

    // ---------------------------
    // 스냅샷 캐시(타깃 팝업용)
    // ---------------------------
    // battleUpdate 받을 때마다 저장
    const cachePlayers = (players)=>{ window.__lastPlayers = players; };

    socket.on("battleUpdate", (snap)=> cachePlayers(snap.players||[]));
    socket.on("battle:update", (snap)=> cachePlayers(snap.players||[]));

    // ---------------------------
    // 인증 & 초기화
    // ---------------------------
    function doAuth(){
      // 서버는 token/password/otp / playerId / playerName 호환
      socket.emit("playerAuth", {
        battleId,
        token,
        password: token,
        otp: token,
        playerId: qPid || undefined,
        playerName: qName || undefined
      }, (ack)=>{
        if (ack?.ok){
          // onAuthSuccess에서도 처리되지만, 혹시 콜백만 오는 서버 대비
          onAuthSuccess(ack);
        }
      });
    }

    if (battleId) {
      joinRoom();
      doAuth();
    } else {
      addLog({ ts:Date.now(), type:"error", message:"battle 파라미터가 없습니다 (?battle=...)" });
    }

    // 이미지 폴백 보장
    document.getElementById('meAvatar').onerror = function(){ this.src="/uploads/avatars/default.svg"; };
    document.getElementById('curAvatar').onerror = function(){ this.src="/uploads/avatars/default.svg"; };
  })();
  </script>
</body>
</html>
