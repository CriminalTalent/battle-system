<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>PYXIS - 전투 참가자</title>
<script src="/socket.io/socket.io.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#0e0e0e; --bg2:#141414;
    --glass-1:rgba(0,0,0,.7); --glass-2:rgba(0,0,0,.5);
    --border:rgba(220,199,162,.3);
    --text:#F8F9FA; --muted:#A9AFB6;
    --gold:#DCC7A2; --gold2:#E6D2A8;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --shadow:0 10px 30px rgba(0,0,0,.45);
    /* 팀별 컬러 정의 - 채도 낮은 색상 */
    --team-a-color: #8b5757; /* 채도 낮은 빨간색 */
    --team-b-color: #5d6b8d; /* 채도 낮은 파란색 */
    --result-bg: #DCC7A2;    /* 금색 배경 */
    --result-text: #000;     /* 검은 글자 */
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:linear-gradient(135deg,#000813,#001122);color:var(--text);font-family:system-ui,-apple-system,sans-serif;min-height:100vh;padding:8px}
  .container{max-width:1400px;margin:0 auto}
  .header{text-align:center;padding:16px;font-family:Cinzel,serif;color:var(--gold);font-size:24px;letter-spacing:.1em}
  .main-grid{display:grid;gap:12px;grid-template-columns:1fr;}
  @media (min-width: 768px){ .main-grid{ grid-template-columns:1fr 2fr 1fr; } }
  .card{background:var(--glass-1);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:var(--shadow)}
  .title{font-family:Cinzel,serif;color:var(--gold);font-weight:700;letter-spacing:.08em;margin-bottom:8px;font-size:14px}
  .player-card{ background:var(--glass-2); border:1px solid var(--border); border-radius:8px; padding:8px; margin-bottom:8px; }
  .row{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
  .hp{height:8px;background:#0b0b0b;border:1px solid var(--border);border-radius:999px;overflow:hidden;flex:1;min-width:60px}
  .hp>span{display:block;height:100%;background:linear-gradient(90deg,#4ade80,#22c55e);transition:width .3s}
  .stat{font-size:11px;color:#cbd5e1;white-space:nowrap}
  .pill{font-size:11px;border:1px solid var(--border);border-radius:8px;padding:2px 6px;background:var(--glass-2)}
  .muted{color:var(--muted);font-size:11px}
  .my-info-box{background:var(--glass-2);border-radius:8px;padding:8px;margin-bottom:8px}
  .my-portrait{width:32px;height:32px;border-radius:50%;object-fit:cover;border:1px solid var(--gold)}
  .center-portrait{width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid var(--gold);margin-bottom:8px}
  .ready-btn{width:100%;padding:6px;background:var(--glass-2);color:var(--gold);border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:11px}
  .ready-btn.done{background:var(--gold);color:#000;border-color:var(--gold)}
  .actions{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px}
  .act{padding:8px 6px;background:var(--glass-2);color:var(--text);border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:12px;transition:all .2s}
  .act:hover{background:var(--gold);color:#000;border-color:var(--gold)}
  .act:disabled{opacity:0.5;cursor:not-allowed;pointer-events:none}
  .items{display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;margin-bottom:8px}
  .item-btn{padding:6px 4px;background:var(--glass-2);color:var(--text);border:1px solid var(--border);border-radius:4px;cursor:pointer;font-size:10px}
  .item-btn:hover{background:var(--gold);color:#000;border-color:var(--gold)}
  .item-btn:disabled{opacity:0.3;cursor:not-allowed;pointer-events:none}
  .targets{display:grid;gap:4px;margin-top:8px}
  .target-btn{padding:4px 6px;background:var(--glass-2);color:var(--text);border:1px solid var(--border);border-radius:4px;cursor:pointer;font-size:10px}
  .target-btn:hover{background:var(--gold);color:#000;border-color:var(--gold)}
  .logs{max-height:340px;overflow:auto;display:grid;gap:4px;background:var(--glass-2);border-radius:8px;padding:8px}
  .log-item{font-size:11px;line-height:1.4;padding:4px 6px;border-radius:4px;border-left:3px solid transparent}
  .log-time{color:var(--muted);margin-right:4px}
  
  /* 팀별 로그 컬러링 */
  .log-team-a { 
    border-left-color: var(--team-a-color);
    background: rgba(139, 87, 87, 0.1);
    color: var(--team-a-color);
  }
  .log-team-b { 
    border-left-color: var(--team-b-color);
    background: rgba(93, 107, 141, 0.1);
    color: var(--team-b-color);
  }
  .log-result { 
    background: var(--result-bg);
    color: var(--result-text);
    font-weight: 700;
    border-left-color: var(--result-bg);
    box-shadow: 0 2px 8px rgba(220, 199, 162, 0.3);
  }
  .log-system { color: var(--text); }
  .log-notice { color: var(--gold); }
  .log-error { color: var(--bad); }

  .chats{max-height:200px;overflow:auto;display:grid;gap:4px;background:var(--glass-2);border-radius:8px;padding:8px;margin-bottom:8px}
  .chat-item{font-size:11px;line-height:1.4}
  .chat-name{font-weight:700;color:var(--gold)}
  .input-group{display:flex;gap:4px}
  .chat-input{flex:1;padding:6px;background:var(--bg1);color:var(--text);border:1px solid var(--border);border-radius:4px;font-size:11px}
  .send-btn{padding:6px 12px;background:var(--gold);color:#000;border:none;border-radius:4px;cursor:pointer;font-size:11px}

  /* 게임 종료 오버레이 */
  .game-over-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 8, 19, 0.95);
    backdrop-filter: blur(20px);
    z-index: 10000;
    display: none;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.5s ease-in-out;
  }
  
  .game-over-overlay.show {
    display: flex;
  }
  
  .game-over-content {
    background: var(--glass-1);
    border: 2px solid var(--gold);
    border-radius: 16px;
    padding: 40px;
    text-align: center;
    backdrop-filter: blur(15px);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
    max-width: 500px;
    width: 90%;
  }
  
  .game-over-title {
    font-family: 'Cinzel', serif;
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--gold);
    margin-bottom: 20px;
    text-shadow: 0 0 30px rgba(220, 199, 162, 0.8);
    letter-spacing: 0.1em;
  }
  
  .winner-announcement {
    font-size: 1.5rem;
    color: var(--text);
    margin-bottom: 20px;
    line-height: 1.4;
  }
  
  .winner-team {
    color: var(--gold);
    font-weight: 700;
    font-size: 2rem;
    text-shadow: 0 0 20px rgba(220, 199, 162, 0.6);
  }

  .victory-message, .defeat-message {
    font-size: 1.2rem;
    margin-bottom: 30px;
    font-weight: 600;
  }

  .victory-message {
    color: var(--ok);
    text-shadow: 0 0 15px rgba(34, 197, 94, 0.5);
  }

  .defeat-message {
    color: var(--bad);
    text-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
  }
  
  .game-over-message {
    font-size: 1rem;
    color: var(--muted);
    margin-bottom: 30px;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
  }

  /* 전투 종료 시 모든 액션 버튼 비활성화 */
  body.battle-ended .act,
  body.battle-ended .item-btn,
  body.battle-ended .target-btn,
  body.battle-ended .ready-btn {
    opacity: 0.3 !important;
    cursor: not-allowed !important;
    pointer-events: none !important;
  }

  body.battle-ended .chat-input,
  body.battle-ended .send-btn {
    opacity: 0.3 !important;
    pointer-events: none !important;
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">PYXIS</div>
  <div class="main-grid">
    <!-- 팀 정보 + 내 정보 -->
    <div>
      <div class="card"><div class="title">팀 현황</div><div id="teamSummary"></div></div>
      <div class="my-info-box">
        <div class="row" style="margin-bottom:4px">
          <img id="myPortrait" class="my-portrait" alt="" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%22440%22></svg>'">
          <div style="flex:1">
            <div style="font-size:12px;color:var(--gold);margin-bottom:1px" id="myName">대기중...</div>
            <div class="row" style="margin-bottom:2px">
              <span class="pill" style="font-size:9px;padding:2px 6px" id="myTeam">-</span>
              <span class="stat" style="font-size:9px" id="myStats">공1 방1 민1 행1</span>
            </div>
            <div class="row">
              <div class="hp" style="height:5px"><span id="myHpBar" style="width:100%"></span></div>
              <span class="muted" style="font-size:8px" id="myHpText">100/100</span>
            </div>
          </div>
        </div>
        <div style="margin-bottom:4px"><span class="pill" id="myItems" style="font-size:9px;padding:2px 6px">아이템 없음</span></div>
        <button id="readyBtn" class="ready-btn" type="button">준비 완료</button>
      </div>
    </div>

    <!-- 중앙 전투 -->
    <div>
      <div class="card" style="text-align:center">
        <div class="title">현재 턴</div>
        <img id="currentPortrait" class="center-portrait" alt="현재 플레이어">
        <div style="font-size:14px;margin-bottom:4px" id="turnInfo">대기 중...</div>
        <div style="color:var(--gold);font-size:20px;margin-bottom:6px" id="timerDisplay">5:00</div>
        <div class="muted" id="timerSeconds" style="font-size:12px;margin-bottom:12px">300초</div>
        <div class="actions">
          <button class="act" id="attackBtn" type="button" aria-disabled="true">공격</button>
          <button class="act" id="defendBtn" type="button" aria-disabled="true">방어</button>
          <button class="act" id="dodgeBtn"  type="button" aria-disabled="true">회피</button>
          <button class="act" id="itemBtn"   type="button" aria-disabled="true">아이템</button>
          <button class="act" id="passBtn"   type="button" aria-disabled="true">패스</button>
        </div>
        <div class="items" id="itemsGrid"></div>
        <div class="targets" id="targetsGrid" style="display:none"></div>
      </div>
    </div>

    <!-- 로그 + 채팅 -->
    <div>
      <div class="card">
        <div class="title">전투 로그</div>
        <div class="logs" id="logPanel"></div>
      </div>
      <div class="card">
        <div class="title">채팅</div>
        <div class="chats" id="chatPanel"></div>
        <div class="input-group">
          <input class="chat-input" id="chatInput" type="text" placeholder="메시지 입력..."/>
          <button class="send-btn" id="chatSend" type="button">전송</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 게임 종료 오버레이 -->
<div id="gameOverOverlay" class="game-over-overlay">
  <div class="game-over-content">
    <div class="game-over-title">전투 종료</div>
    <div class="winner-announcement">
      <span id="winnerTeam" class="winner-team"></span> 승리!
    </div>
    <div id="personalResult" class="victory-message"></div>
    <div class="game-over-message">전투가 종료되었습니다.</div>
  </div>
</div>

<script>
(()=>{
  const battleId=new URLSearchParams(location.search).get('battle'), token=new URLSearchParams(location.search).get('token'), urlName=new URLSearchParams(location.search).get('name');
  if(!battleId||!token){ alert('올바르지 않은 URL입니다'); return; }
  const socket=io(), logPanel=document.getElementById('logPanel'), chatPanel=document.getElementById('chatPanel');
  let myPlayer=null, battleState=null, hasActedThisTurn=false, timerInterval=null;

  // 게임 종료 처리 함수들
  function showGameOverOverlay(winner) {
    const overlay = document.getElementById('gameOverOverlay');
    const winnerTeam = document.getElementById('winnerTeam');
    const personalResult = document.getElementById('personalResult');
    
    winnerTeam.textContent = winner + '팀';
    
    // 내가 속한 팀인지 확인
    if (myPlayer && myPlayer.team === winner) {
      personalResult.textContent = '승리했습니다!';
      personalResult.className = 'victory-message';
    } else {
      personalResult.textContent = '패배했습니다...';
      personalResult.className = 'defeat-message';
    }
    
    overlay.classList.add('show');
    document.body.classList.add('battle-ended');
  }

  // 팀별 로그 분류 함수
  function getLogClass(message, type) {
    if (type === 'battle' || type === 'item') {
      // A팀 관련 로그 감지
      if (message.includes('A1') || message.includes('A2') || message.includes('A3') || message.includes('A4') || 
          message.includes('A팀') || message.includes('=== A팀')) {
        return 'log-team-a';
      }
      // B팀 관련 로그 감지
      if (message.includes('B1') || message.includes('B2') || message.includes('B3') || message.includes('B4') || 
          message.includes('B팀') || message.includes('=== B팀')) {
        return 'log-team-b';
      }
      // 결과 관련 로그 (라운드 종료, 승리 등)
      if (message.includes('라운드 종료') || message.includes('승리') || message.includes('전투가') || 
          message.includes('결과') || message.includes('===')) {
        return 'log-result';
      }
    }
    
    // 기타 타입별 분류
    if (type === 'notice') return 'log-notice';
    if (type === 'error') return 'log-error';
    return 'log-system';
  }

  function esc(s){return s.replace(/</g,'&lt;').replace(/>/g,'&gt;')}
  function updateMyInfo(){ if(!myPlayer) return; document.getElementById('myName').textContent=myPlayer.name||'?'; document.getElementById('myTeam').textContent=myPlayer.team||'?';
    document.getElementById('myStats').textContent=`공${myPlayer.stats?.attack||0} 방${myPlayer.stats?.defense||0} 민${myPlayer.stats?.agility||0} 행${myPlayer.stats?.luck||0}`;
    const hpPct=myPlayer.hp/(myPlayer.maxHp||100)*100; document.getElementById('myHpBar').style.width=hpPct+'%';
    document.getElementById('myHpText').textContent=`${myPlayer.hp}/${myPlayer.maxHp||100}`;
    const items=[]; if(myPlayer.items?.dittany>0) items.push(`디터니 ${myPlayer.items.dittany}`);
    if(myPlayer.items?.attackBooster>0) items.push(`공격보정 ${myPlayer.items.attackBooster}`); if(myPlayer.items?.defenseBooster>0) items.push(`방어보정 ${myPlayer.items.defenseBooster}`);
    document.getElementById('myItems').textContent=items.length?items.join(', '):'아이템 없음';
    if(myPlayer.avatar) document.getElementById('myPortrait').src=myPlayer.avatar; }
  function render(){ if(!battleState) return; const turnInfo=battleState.currentTurn;
    document.getElementById('turnInfo').textContent=turnInfo?.currentPlayer?`${turnInfo.currentPlayer.name} 차례`:'대기중...';
    const timeLeft=turnInfo?.timeLeftSec||0; const mm=Math.floor(timeLeft/60); const ss=timeLeft%60;
    document.getElementById('timerDisplay').textContent=`${mm}:${ss.toString().padStart(2,'0')}`;document.getElementById('timerSeconds').textContent=`${timeLeft}초`;
    if(turnInfo?.currentPlayer?.avatar) document.getElementById('currentPortrait').src=turnInfo.currentPlayer.avatar;
    const isMyTurn=myPlayer&&turnInfo?.currentPlayer?.id===myPlayer.id; const canAct=isMyTurn&&battleState.status==='active'&&!hasActedThisTurn;
    ['attackBtn','defendBtn','dodgeBtn','itemBtn','passBtn'].forEach(id=>{ const btn=document.getElementById(id); btn.disabled=!canAct; });
    renderTeamSummary(); }
  function renderTeamSummary(){ if(!battleState?.players) return; const teamA=battleState.players.filter(p=>p.team==='A'),teamB=battleState.players.filter(p=>p.team==='B');
    let html='<div style="margin-bottom:8px"><strong>A팀</strong></div>';
    teamA.forEach(p=>{ const hpPct=p.hp/(p.maxHp||100)*100;
      html+=`<div class="player-card"><div style="font-size:10px;font-weight:600">${esc(p.name)}</div><div class="row" style="margin-top:2px"><div class="hp" style="height:4px"><span style="width:${hpPct}%"></span></div><span style="font-size:8px;color:var(--muted)">HP ${p.hp}</span></div></div>`; });
    html+='<div style="margin:8px 0"><strong>B팀</strong></div>';
    teamB.forEach(p=>{ const hpPct=p.hp/(p.maxHp||100)*100;
      html+=`<div class="player-card"><div style="font-size:10px;font-weight:600">${esc(p.name)}</div><div class="row" style="margin-top:2px"><div class="hp" style="height:4px"><span style="width:${hpPct}%"></span></div><span style="font-size:8px;color:var(--muted)">HP ${p.hp}</span></div></div>`; });
    document.getElementById('teamSummary').innerHTML=html; }
  function disableActions(){ ['attackBtn','defendBtn','dodgeBtn','itemBtn','passBtn'].forEach(id=>document.getElementById(id).disabled=true); }
  function addChat({name,message}){ if(!name||!message) return; const div=document.createElement('div'); div.className='chat-item';
    div.innerHTML=`<span class="chat-name">${esc(name)}</span>: ${esc(message)}`; chatPanel.appendChild(div); chatPanel.scrollTop=chatPanel.scrollHeight; }
  function addLog({ts,type,message:txt}){ if(!txt) return; const time=new Date(ts).toLocaleTimeString('ko-KR',{hour12:false}); const div=document.createElement('div');
    
    // 팀별 로그 분류 적용
    const logClass = getLogClass(txt, type);
    div.className = `log-item ${logClass}`;
    
    div.innerHTML=`<span class="log-time">[${time}]</span> ${esc(txt)}`; 
    logPanel.appendChild(div); 
    logPanel.scrollTop=logPanel.scrollHeight; 
  }

  // 소켓 이벤트 리스너
  socket.on('connect', ()=>{ socket.emit('join', {battleId}); });
  function applyAuthedPlayer(p){ if(!p) return; if(!p.name && urlName) p.name=urlName; myPlayer=p; updateMyInfo(); }
  socket.emit('playerAuth', {battleId, token}, (res)=>{ if(!res?.ok){ alert('인증 실패'); return; } applyAuthedPlayer(res.player); });
  socket.on('authSuccess',(d)=>applyAuthedPlayer(d.player)); socket.on('auth:success',(d)=>applyAuthedPlayer(d.player));
  const onSnap=(snap)=>{ battleState=snap; render(); }; socket.on('battleUpdate', onSnap); socket.on('battle:update', onSnap);
  socket.on('battle:log', addLog); socket.on('battleLog', addLog); socket.on('importantLog', addLog);
  socket.on('chatMessage', addChat); socket.on('battle:chat', addChat);
  socket.on('actionSuccess', ()=>{ hasActedThisTurn=true; disableActions(); });
  socket.on('player:action:success', ()=>{ hasActedThisTurn=true; disableActions(); });

  // 게임 종료 이벤트 처리
  socket.on('battle:ended', (data) => {
    console.log('전투 종료:', data);
    showGameOverOverlay(data.winner);
  });

  socket.on('battleEnded', (data) => {
    console.log('전투 종료 (호환):', data);
    showGameOverOverlay(data.winner);
  });

  document.getElementById('readyBtn').onclick=()=>{ const btn=document.getElementById('readyBtn'); if(btn.classList.contains('done')) return;
    socket.emit('player:ready', {battleId, playerId: myPlayer?.id}, ()=>{ socket.emit('chatMessage', {battleId, name: myPlayer?.name||urlName||'전투 참가자', message: '[준비 완료]'}); });
    btn.classList.add('done'); btn.textContent='준비 완료됨';
  };
  window.addEventListener('beforeunload', ()=>{ if(timerInterval) clearInterval(timerInterval); });
  socket.emit('join', {battleId});
})();
</script>
</body>
</html>
