<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PYXIS - 전투 참가자</title>
  <script src="/socket.io/socket.io.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0C1221;--panel:rgba(30,42,71,.5);--text:#F8F9FA;--muted:#ADB5BD;--gold:#DCC7A2;--border:rgba(61,90,128,.5);--success:#27AE60;--danger:#E74C3C}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Cinzel',serif;background:linear-gradient(135deg,#0A0F1A,#0C1221);color:var(--text);min-height:100vh}
    .wrap{max-width:1200px;margin:0 auto;padding:16px;display:grid;grid-template-columns:320px 1fr 360px;gap:16px}
    @media (max-width:1100px){.wrap{grid-template-columns:1fr;}}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px}
    .title{font-weight:700;color:var(--gold);border-bottom:1px solid var(--border);padding-bottom:8px;margin-bottom:10px;text-align:center}
    .row{display:flex;gap:10px;align-items:center}
    .avatar{width:80px;height:80px;border-radius:12px;background:#1E2A47;border:2px solid var(--border);background-size:cover;background-position:center}
    .label{font-size:12px;color:var(--muted);text-transform:uppercase}
    .value{font-weight:700}
    .hpbar{height:10px;background:#1E2A47;border:1px solid var(--border);border-radius:6px;overflow:hidden}
    .hpbar>div{height:100%;background:#27AE60;width:100%}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .log{height:220px;overflow:auto;background:rgba(30,42,71,.4);border:1px solid var(--border);border-radius:8px;padding:8px;font-size:12px}
    .log .t{color:var(--muted);font-size:10px;margin-right:6px}
    .chat{height:120px;overflow:auto;background:rgba(30,42,71,.4);border:1px solid var(--border);border-radius:8px;padding:8px;font-size:12px}
    input,button{font-family:'Cinzel',serif}
    .btn{padding:8px 12px;border:none;border-radius:8px;background:linear-gradient(135deg,var(--gold),#F0E6C8);color:#0A0F1A;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .muted{color:var(--muted)}
    .err{color:var(--danger)}
    .ok{color:var(--success)}
  </style>
</head>
<body>
<div class="wrap">
  <!-- 좌: 내 카드 -->
  <div class="card">
    <div class="title">내 정보</div>
    <div class="row" style="margin-bottom:10px;">
      <div id="meAvatar" class="avatar"></div>
      <div>
        <div class="label">이름</div><div id="meName" class="value">-</div>
        <div class="label" style="margin-top:6px;">팀</div><div id="meTeam" class="value">-</div>
      </div>
    </div>
    <div class="label">체력</div>
    <div class="hpbar" style="margin:6px 0 10px;"><div id="meHpBar"></div></div>
    <div id="meHp" class="value">-</div>
    <div class="label" style="margin-top:10px;">스탯</div>
    <div class="grid" style="margin-top:6px;">
      <div><div class="label">공격</div><div id="sAtk" class="value">-</div></div>
      <div><div class="label">방어</div><div id="sDef" class="value">-</div></div>
      <div><div class="label">민첩</div><div id="sAgi" class="value">-</div></div>
      <div><div class="label">행운</div><div id="sLuk" class="value">-</div></div>
    </div>
    <div class="label" style="margin-top:10px;">아이템</div>
    <div id="myItems" class="value">-</div>

    <button id="btnReady" class="btn" style="margin-top:12px;" disabled>준비 완료</button>
    <div id="authMsg" class="muted" style="margin-top:8px;"></div>
  </div>

  <!-- 중간: 현재 턴 / 간단 로그 -->
  <div class="card">
    <div class="title">전장</div>
    <div class="row" style="gap:14px;">
      <div id="turnImg" class="avatar" style="width:100px;height:100px;"></div>
      <div>
        <div class="label">현재 차례</div><div id="turnName" class="value">-</div>
        <div class="label" style="margin-top:6px;">현재 팀</div><div id="turnTeam" class="value">-</div>
      </div>
    </div>
    <div class="label" style="margin-top:10px;">실시간 로그</div>
    <div id="log" class="log" style="margin-top:6px;"></div>

    <div class="label" style="margin-top:10px;">채팅</div>
    <div id="chat" class="chat" style="margin-top:6px;"></div>
    <div class="row" style="margin-top:6px;">
      <input id="chatMsg" style="flex:1;padding:8px;border-radius:8px;border:1px solid var(--border);background:rgba(30,42,71,.4);color:var(--text);" placeholder="메시지 입력">
      <button id="btnSend" class="btn">전송</button>
    </div>
  </div>

  <!-- 우: 상대팀 간단 목록 (요청 범위 내 정보만) -->
  <div class="card">
    <div class="title">상대팀</div>
    <div id="enemyList" style="display:grid;gap:8px;"></div>
  </div>
</div>

<script>
  const $ = (q)=>document.querySelector(q);
  const hpPct = (hp,max)=> Math.max(0, Math.min(100, Math.round((hp/max)*100)));

  const params = new URLSearchParams(location.search);
  const battleId = params.get('battle');
  const token = params.get('token') || params.get('otp') || params.get('password') || params.get('pwd') || params.get('auth');
  const playerNameParam = params.get('name') || '';
  const teamParam = params.get('team') || '';

  const meAvatar = $('#meAvatar'), meName = $('#meName'), meTeam = $('#meTeam'), meHp = $('#meHp'), meHpBar = $('#meHpBar');
  const sAtk = $('#sAtk'), sDef = $('#sDef'), sAgi = $('#sAgi'), sLuk = $('#sLuk');
  const myItems = $('#myItems'), btnReady = $('#btnReady'), authMsg = $('#authMsg');

  const turnImg = $('#turnImg'), turnName = $('#turnName'), turnTeam = $('#turnTeam');
  const logEl = $('#log'), chatEl = $('#chat'), chatMsg = $('#chatMsg'), btnSend = $('#btnSend');

  let socket = null; let me = null; let battle = null;

  const addLog = (msg, type='system')=>{
    const t = document.createElement('div');
    const ts = new Date().toLocaleTimeString('ko-KR',{hour12:false,hour:'2-digit',minute:'2-digit'});
    t.innerHTML = `<span class="t">${ts}</span>${msg}`;
    logEl.appendChild(t); logEl.scrollTop = logEl.scrollHeight;
    while (logEl.children.length > 200) logEl.removeChild(logEl.firstChild);
  };
  const addChat = (name, msg)=>{
    const t = document.createElement('div');
    t.textContent = `${name}: ${msg}`;
    chatEl.appendChild(t); chatEl.scrollTop = chatEl.scrollHeight;
    while (chatEl.children.length > 200) chatEl.removeChild(chatEl.firstChild);
  };

  function renderMe() {
    if (!me) return;
    meName.textContent = me.name; meTeam.textContent = me.team + '팀';
    meHp.textContent = `${me.hp}/${me.maxHp}`; meHpBar.style.width = hpPct(me.hp, me.maxHp) + '%';
    if (me.avatar) meAvatar.style.backgroundImage = `url(${me.avatar})`;
    sAtk.textContent = me.stats?.attack ?? '-';
    sDef.textContent = me.stats?.defense ?? '-';
    sAgi.textContent = me.stats?.agility ?? '-';
    sLuk.textContent = me.stats?.luck ?? '-';
    myItems.textContent = `디터니:${me.items?.dittany||0} / 공격 보정기:${me.items?.attack_boost||0} / 방어 보정기:${me.items?.defense_boost||0}`;
  }

  function renderEnemies() {
    if (!battle || !me) return;
    const enemyTeam = me.team === 'A' ? 'B' : 'A';
    const enemy = (battle.players||[]).filter(p=>p.team===enemyTeam);
    const root = $('#enemyList'); root.innerHTML='';
    enemy.forEach(p=>{
      const wrap = document.createElement('div');
      wrap.style.border='1px solid var(--border)'; wrap.style.borderRadius='8px'; wrap.style.padding='8px'; wrap.style.background='rgba(30,42,71,.3)';
      wrap.innerHTML = `
        <div style="display:flex;gap:8px;align-items:center;">
          <div style="width:40px;height:40px;border-radius:6px;background:#1E2A47;border:1px solid var(--border);background-size:cover;background-position:center;${p.avatar?`background-image:url(${p.avatar})`:''}"></div>
          <div style="flex:1;">
            <div style="font-weight:700">${p.name}</div>
            <div class="hpbar" style="margin-top:4px;"><div style="width:${hpPct(p.hp,p.maxHp)}%;background:#27AE60;height:100%"></div></div>
            <div class="muted" style="font-size:11px;margin-top:2px;">HP ${p.hp}/${p.maxHp}</div>
          </div>
        </div>
      `;
      root.appendChild(wrap);
    });
  }

  function onBattleUpdate(b) {
    battle = b;
    // 턴 표시(간단히 현재팀만)
    turnTeam.textContent = b.currentTurn?.currentTeam ? (b.currentTurn.currentTeam + '팀') : '-';
    // 현재 차례 캐릭터(서버가 상세 순서를 아직 안 주므로, 현재팀 첫 생존자 표기)
    const curTeam = b.currentTurn?.currentTeam || 'A';
    const cand = (b.players||[]).find(p=>p.team===curTeam);
    turnName.textContent = cand ? cand.name : '-';
    if (cand?.avatar) turnImg.style.backgroundImage = `url(${cand.avatar})`;

    if (me && b.players) {
      const fresh = b.players.find(p=>p.id === me.id);
      if (fresh) me = fresh;
      renderMe();
      renderEnemies();
    }
  }

  function init() {
    if (!battleId) { authMsg.innerHTML = '<span class="err">잘못된 접근: battle 파라미터가 없습니다.</span>'; return; }

    socket = window.io({ path: '/socket.io' });
    socket.on('connect', ()=> addLog('서버에 연결되었습니다.'));
    socket.on('battleUpdate', onBattleUpdate);
    socket.on('battle:update', onBattleUpdate);
    socket.on('battle:log', (d)=> addLog(d.message || '로그'));
    socket.on('chatMessage', (d)=> addChat(d.name || '익명', d.message || ''));

    // 플레이어 인증
    const payload = { battleId, token, playerName: playerNameParam };
    socket.emit('playerAuth', payload, (res)=>{
      if (!res || !res.ok) {
        authMsg.innerHTML = '<span class="err">인증 실패: 비밀번호가 올바르지 않습니다.</span>';
        return;
      }
      authMsg.innerHTML = '<span class="ok">인증 성공</span>';
      me = res.playerData; renderMe();
      socket.emit('join', { battleId });
    });

    // 채팅
    btnSend.addEventListener('click', ()=>{
      const msg = chatMsg.value.trim(); if (!msg) return;
      socket.emit('chatMessage', { battleId, name: me?.name || '전투 참가자', message: msg });
      chatMsg.value='';
    });
    chatMsg.addEventListener('keydown', (e)=>{ if (e.key==='Enter') btnSend.click(); });
  }
  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
