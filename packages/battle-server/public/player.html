<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>PYXIS - 전투 참가자</title>
<script src="/socket.io/socket.io.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#0e0e0e; --bg2:#141414;
    --glass-1:rgba(0,0,0,.7); --glass-2:rgba(0,0,0,.5);
    --border:rgba(220,199,162,.3);
    --text:#F8F9FA; --muted:#A9AFB6;
    --gold:#DCC7A2; --gold2:#E6D2A8;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --shadow:0 10px 30px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:linear-gradient(135deg,#000813,#001122);color:var(--text);font-family:system-ui,-apple-system,sans-serif;min-height:100vh;padding:8px}
  
  .container{max-width:1400px;margin:0 auto}
  .header{text-align:center;padding:16px;font-family:Cinzel,serif;color:var(--gold);font-size:24px;letter-spacing:.1em}
  
  .main-grid{
    display:grid;
    gap:12px;
    grid-template-columns:1fr;
  }
  @media (min-width: 768px) {
    .main-grid{ grid-template-columns:1fr 2fr 1fr; }
  }
  
  .card{background:var(--glass-1);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:var(--shadow)}
  .title{font-family:Cinzel,serif;color:var(--gold);font-weight:700;letter-spacing:.08em;margin-bottom:8px;font-size:14px}
  
  .player-card{ background:var(--glass-2); border:1px solid var(--border); border-radius:8px; padding:8px; margin-bottom:8px; }
  .row{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
  .hp{height:8px;background:#0b0b0b;border:1px solid var(--border);border-radius:999px;overflow:hidden;flex:1;min-width:60px}
  .hp>span{display:block;height:100%;background:linear-gradient(90deg,#4ade80,#22c55e);transition:width .3s}
  .stat{font-size:11px;color:#cbd5e1;white-space:nowrap}
  .pill{font-size:11px;border:1px solid var(--border);background:var(--glass-1);padding:4px 8px;border-radius:999px;white-space:nowrap}
  .muted{color:var(--muted);font-size:10px}
  img.por{width:40px;height:40px;object-fit:cover;border-radius:8px;background:#0b0b0b;border:1px solid var(--border)}
  
  .center-portrait{
    width:100%;max-width:250px;aspect-ratio:1/1;border-radius:12px;
    border:1px solid var(--border);object-fit:cover;background:#000;margin:0 auto 10px
  }

  .my-info-box{
    background:linear-gradient(135deg,rgba(220,199,162,.1),rgba(220,199,162,.05));
    border:2px solid var(--gold);
    border-radius:8px;
    padding:6px;
    margin-bottom:10px;
  }
  .my-portrait{ width:40px; height:40px; border-radius:6px; border:1px solid var(--gold); object-fit:cover; background:#0b0b0b; margin-right:6px; }
  
  .actions{
    display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-top:8px;
  }
  @media (min-width: 480px) { .actions{grid-template-columns:repeat(3,1fr)} }
  @media (min-width: 768px) { .actions{grid-template-columns:repeat(5,1fr)} }
  
  .act{
    padding:10px 8px; border-radius:8px; border:2px solid transparent;
    background:var(--glass-1); text-align:center; color:#999; font-size:12px;
    transition:all .2s; user-select:none;
  }
  .act.enabled{ color:var(--gold); border-color:var(--gold); background:rgba(220,199,162,.08); cursor:pointer; }
  .act.enabled:hover{ background:rgba(220,199,162,.15); transform:translateY(-1px) }
  .act.disabled, .act:disabled{ opacity:.35; cursor:not-allowed; }

  .ready-btn{
    width:100%; padding:6px; border-radius:4px; border:1px solid var(--gold);
    background:rgba(220,199,162,.1); color:var(--gold); font-size:11px; cursor:pointer;
    transition:all .2s; margin-top:4px;
  }
  .ready-btn:hover{background:rgba(220,199,162,.2)}
  .ready-btn.done{ background:#333; color:#666; border-color:#666; cursor:not-allowed; }
  
  .log-panel,.chat-panel{
    background:var(--glass-1); border:1px solid var(--border); border-radius:8px;
    padding:8px; height:300px; overflow-y:auto; font-size:11px; line-height:1.4; margin-top:8px;
  }
  @media (min-width: 768px) { .log-panel,.chat-panel{ height:400px; font-size:12px; } }
  
  .log-item{margin-bottom:4px;word-wrap:break-word}
  .log-time{color:#666;margin-right:4px}
  .log-type-battle{color:#DCC7A2}
  .log-type-error{color:#ef4444}
  .log-type-notice{color:#E6D2A8;font-weight:600}
  
  .chat-input{ width:100%; padding:8px; margin-top:8px; border:1px solid var(--border); background:var(--glass-1); color:var(--text); border-radius:8px; font-size:12px; }
  
  .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.85); display:flex; align-items:center; justify-content:center; z-index:1000; }
  .overlay-content{ background:var(--glass-1); border:2px solid var(--gold); border-radius:16px; padding:20px; max-width:90vw; max-height:70vh; overflow-y:auto; }
  .target-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(100px,1fr)); gap:12px; margin-top:12px; }
  .target-card{ background:var(--glass-2); border:2px solid var(--border); border-radius:10px; padding:10px; cursor:pointer; text-align:center; transition:all .2s; }
  .target-card:hover{ border-color:var(--gold); transform:scale(1.05) }
  .target-card img{width:60px;height:60px;border-radius:8px;margin-bottom:6px;background:#000}
  
  .end-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.95); display:flex; align-items:center; justify-content:center; z-index:2000; color:var(--gold); font-size:24px; font-family:Cinzel,serif; text-align:center; padding:20px; }
</style>
</head>
<body>

<div class="container">
  <div class="header">PYXIS 전투 시스템</div>
  
  <div class="main-grid">
    <!-- 좌측: A팀 + 로그 -->
    <div>
      <div class="card">
        <div class="title">A팀</div>
        <div id="teamA"></div>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="title">실시간 로그</div>
        <div class="log-panel" id="logPanel"></div>
      </div>
    </div>
    
    <!-- 중앙: 내 정보 + 전투 상태 + 액션 -->
    <div>
      <!-- 내 정보 -->
      <div class="my-info-box">
        <div class="row" style="margin-bottom:4px">
          <img id="myPortrait" class="my-portrait" alt="" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%22440%22></svg>'">
          <div style="flex:1">
            <div style="font-size:12px;color:var(--gold);margin-bottom:1px" id="myName">대기중...</div>
            <div class="row" style="margin-bottom:2px">
              <span class="pill" style="font-size:9px;padding:2px 6px" id="myTeam">-</span>
              <span class="stat" style="font-size:9px" id="myStats">공1 방1 민1 행1</span>
            </div>
            <div class="row">
              <div class="hp" style="height:5px"><span id="myHpBar" style="width:100%"></span></div>
              <span class="muted" style="font-size:8px" id="myHpText">100/100</span>
            </div>
          </div>
        </div>
        <div style="margin-bottom:4px">
          <span class="pill" id="myItems" style="font-size:9px;padding:2px 6px">아이템 없음</span>
        </div>
        <button id="readyBtn" class="ready-btn" type="button">준비 완료</button>
      </div>
      
      <!-- 전투 상태 -->
      <div class="card" style="text-align:center">
        <div class="title">현재 턴</div>
        <img id="currentPortrait" class="center-portrait" alt="현재 플레이어">
        <div style="font-size:14px;margin-bottom:4px" id="turnInfo">대기 중...</div>
        <div style="color:var(--gold);font-size:20px;margin-bottom:6px" id="timerDisplay">5:00</div>
        <div class="muted" id="timerSeconds" style="font-size:12px;margin-bottom:12px">300초</div>
        
        <!-- 액션 버튼 -->
        <div class="actions">
          <button class="act" id="attackBtn" type="button" aria-disabled="true">공격</button>
          <button class="act" id="defendBtn" type="button" aria-disabled="true">방어</button>
          <button class="act" id="dodgeBtn"  type="button" aria-disabled="true">회피</button>
          <button class="act" id="itemBtn"   type="button" aria-disabled="true">아이템</button>
          <button class="act" id="passBtn"   type="button" aria-disabled="true">패스</button>
        </div>
      </div>
    </div>
    
    <!-- 우측: B팀 + 채팅 -->
    <div>
      <div class="card">
        <div class="title">B팀</div>
        <div id="teamB"></div>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="title">채팅</div>
        <div class="chat-panel" id="chatPanel"></div>
        <div class="row" style="gap:6px">
          <input type="text" id="chatInput" class="chat-input" placeholder="메시지 입력 (Enter)...">
          <button id="chatSendBtn" class="ready-btn" style="width:auto;padding:8px 12px" type="button">전송</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 대상 선택 오버레이 -->
<div id="targetOverlay" class="overlay" style="display:none">
  <div class="overlay-content">
    <div class="title" id="overlayTitle">대상 선택</div>
    <div class="target-grid" id="targetGrid"></div>
    <button class="act enabled" style="width:100%;margin-top:16px" type="button" onclick="closeOverlay()">취소</button>
  </div>
</div>

<!-- 게임 종료 오버레이 -->
<div id="endOverlay" class="end-overlay" style="display:none">
  <div>게임이 종료되었습니다</div>
</div>

<script>
(function(){
  // ======= 기본 세팅 =======
  const socket   = io({path:'/socket.io'});
  const params   = new URLSearchParams(location.search);
  const battleId = params.get('battle');
  const token    = params.get('token');
  // URL에 name이 있는 경우, 서버가 비어줄 때만 폴백에 사용
  const urlName  = params.get('name');

  // 상태
  let myPlayer       = null;
  let battleState    = null;
  let selectedAction = null;
  let timerInterval  = null;
  let hasActedThisTurn = false;

  // 디듀프/동기화
  const seenLog  = new Set();
  const seenChat = new Set();
  let lastSnapKey = '';

  // 타이머 로컬 상태
  let lastTimeLeft = 0;
  let lastSyncAt   = 0;

  // 검은 화면(완전 블랙) SVG dataURL
  const BLACK_SVG_250 = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="250" height="250"><rect width="250" height="250" fill="%23000"/></svg>';
  const BLACK_SVG_40  = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40"><rect width="40" height="40" fill="%23000"/></svg>';

  // ======= 유틸 =======
  const esc=(s)=>String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  const dedupe=(set,key,limit=400)=>{ if(set.has(key)) return true; set.add(key); if(set.size>limit){ const f=set.values().next().value; set.delete(f);} return false; };

  function setCurrentPortrait(player){
    const img = document.getElementById('currentPortrait');
    if(player && player.avatar){
      img.src = player.avatar;
      img.onerror = ()=>{ img.src = BLACK_SVG_250; };
    }else{
      img.src = BLACK_SVG_250; // 현재 플레이어가 없거나 아바타 없음 → 검은 화면
    }
  }

  function updateMyInfo(){
    if(!myPlayer) return;
    document.getElementById('myName').textContent = myPlayer.name || '전투 참가자';
    document.getElementById('myTeam').textContent = (myPlayer.team||'-') + '팀';
    document.getElementById('myPortrait').src = myPlayer.avatar || BLACK_SVG_40;
    document.getElementById('myPortrait').onerror = (e)=>{ e.target.src = BLACK_SVG_40; };
    updateMyStats();
  }

  function updateMyStats(){
    if(!myPlayer) return;
    const hp    = myPlayer.hp ?? 0;
    const maxHp = myPlayer.maxHp ?? 100;
    document.getElementById('myHpBar').style.width = Math.max(0,Math.min(100,(hp/maxHp*100))) + '%';
    document.getElementById('myHpText').textContent = `${hp}/${maxHp}`;
    const s = myPlayer.stats || {};
    document.getElementById('myStats').textContent = `공${s.attack||1} 방${s.defense||1} 민${s.agility||1} 행${s.luck||1}`;
    const it = myPlayer.items || {};
    const items = [];
    if((it.dittany||it.ditany||0)>0) items.push(`디터니×${it.dittany||it.ditany}`);
    if((it.attackBooster||it.attack_boost||0)>0) items.push(`공격보정×${it.attackBooster||it.attack_boost}`);
    if((it.defenseBooster||it.defense_boost||0)>0) items.push(`방어보정×${it.defenseBooster||it.defense_boost}`);
    document.getElementById('myItems').textContent = items.length ? items.join(' ') : '아이템 없음';
  }

  function isMyTurnNow(){
    return (
      battleState &&
      myPlayer &&
      battleState.status === 'active' &&
      battleState.currentTurn?.currentTeam === myPlayer.team &&
      battleState.currentTurn?.currentPlayer?.id === myPlayer.id
    );
  }

  function setTimerDisplay(sec){
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    document.getElementById('timerDisplay').textContent = `${m}:${s.toString().padStart(2,'0')}`;
    document.getElementById('timerSeconds').textContent = `${sec}초`;
  }

  function renderTeam(team, container){
    const players = (battleState?.players||[]).filter(p=>p.team===team);
    container.innerHTML = players.map(p=>{
      const hp = p.hp ?? 0, maxHp = p.maxHp ?? 100;
      const hpPct = Math.max(0,Math.min(100,(hp/maxHp*100)));
      const s = p.stats || {};
      const av = p.avatar || '';
      return `
        <div class="player-card">
          <div class="row" style="margin-bottom:4px">
            <img class="por" src="${av}" onerror="this.src='${BLACK_SVG_40}'" alt="">
            <div style="flex:1">
              <div style="font-size:12px;margin-bottom:2px">${esc(p.name)}</div>
              <div class="row">
                <div class="hp"><span style="width:${hpPct}%"></span></div>
                <span class="muted">${hp}</span>
              </div>
            </div>
          </div>
          <div class="stat">공${s.attack||1} 방${s.defense||1} 민${s.agility||1} 행${s.luck||1}</div>
        </div>
      `;
    }).join('');
  }

  function updateActionButtons(){
    if(!battleState || !myPlayer) return;
    const myTurn   = isMyTurnNow();
    const isDead   = (myPlayer.hp||0) <= 0;
    const canAct   = (!isDead && myTurn && battleState.status === 'active' && !hasActedThisTurn);

    ['attackBtn','defendBtn','dodgeBtn','itemBtn','passBtn'].forEach(id=>{
      const btn = document.getElementById(id);
      if(canAct){
        btn.className = 'act enabled';
        btn.disabled = false;
        btn.setAttribute('aria-disabled','false');
      }else{
        btn.className = 'act disabled';
        btn.disabled = true;
        btn.setAttribute('aria-disabled','true');
      }
    });

    // 아이템이 없으면 버튼 자체를 비활성
    const it = myPlayer.items || {};
    const hasAnyItem = (it.dittany||it.ditany||0)>0 || (it.attackBooster||it.attack_boost||0)>0 || (it.defenseBooster||it.defense_boost||0)>0;
    if(!hasAnyItem){
      const itemBtn = document.getElementById('itemBtn');
      itemBtn.className = 'act disabled';
      itemBtn.disabled = true;
      itemBtn.setAttribute('aria-disabled','true');
    }
  }

  function disableActions(){
    ['attackBtn','defendBtn','dodgeBtn','itemBtn','passBtn'].forEach(id=>{
      const btn = document.getElementById(id);
      btn.className = 'act disabled';
      btn.disabled = true;
      btn.setAttribute('aria-disabled','true');
    });
  }

  // ======= 렌더 =======
  function render(force=false){
    if(!battleState || !myPlayer) return;

    // 중복 스냅 방지
    const currKey = JSON.stringify({
      s:battleState.status,
      t:battleState.currentTurn?.turnNumber,
      p:battleState.currentTurn?.currentPlayer?.id,
      tm:battleState.currentTurn?.timeLeftSec
    });
    if(!force && currKey===lastSnapKey) return;
    lastSnapKey = currKey;

    if(battleState.status === 'ended'){
      document.getElementById('endOverlay').style.display = 'flex';
      disableActions();
      return;
    }

    // 현재 플레이어 포트레이트/턴 텍스트
    const cur = battleState.currentTurn?.currentPlayer || null;
    setCurrentPortrait(cur);
    const turnNum = battleState.currentTurn?.turnNumber || 1;
    const team    = battleState.currentTurn?.currentTeam || '-';
    const playerName = cur?.name || '—';
    document.getElementById('turnInfo').textContent = `${turnNum}라운드 - ${team}팀 (${playerName})`;

    // 타이머
    const timeLeft = Math.max(0, battleState.currentTurn?.timeLeftSec || 0);
    lastTimeLeft = timeLeft;
    lastSyncAt   = Date.now();
    setTimerDisplay(timeLeft);
    if(timerInterval) clearInterval(timerInterval);
    if(battleState.status === 'active'){
      timerInterval = setInterval(()=>{
        const elapsed = Math.floor((Date.now() - lastSyncAt)/1000);
        const left = Math.max(0, lastTimeLeft - elapsed);
        setTimerDisplay(left);
        if(left === 0){ clearInterval(timerInterval); }
      }, 1000);
    }

    // 내 최신 상태 동기화
    const me = (battleState.players||[]).find(p=>p.id===myPlayer.id);
    if(me){
      const oldTurnKey = myPlayer && myPlayer.id + '|' + (battleState.currentTurn?.turnNumber||0);
      myPlayer = me;
      updateMyStats();
      // 턴이 넘어간 상황에서 내 행동 상태 리셋
      const newTurnKey = myPlayer.id + '|' + (battleState.currentTurn?.turnNumber||0);
      if(oldTurnKey !== newTurnKey){ hasActedThisTurn = false; }
    }

    // 팀 렌더
    renderTeam('A', document.getElementById('teamA'));
    renderTeam('B', document.getElementById('teamB'));

    // 버튼 활성화
    updateActionButtons();
  }

  // ======= 오버레이 =======
  window.closeOverlay = function(){
    document.getElementById('targetOverlay').style.display = 'none';
    window.targetCallback = null;
  };

  function showTargetOverlay(title, targets, callback){
    document.getElementById('overlayTitle').textContent = title;
    const grid = document.getElementById('targetGrid');
    grid.innerHTML = targets.map(t=>`
      <div class="target-card" data-id="${esc(t.id)}">
        <img src="${t.avatar||''}" onerror="this.src='${BLACK_SVG_40}'" alt="">
        <div style="font-size:12px">${esc(t.name)}</div>
        <div style="font-size:10px;color:var(--muted)">HP ${t.hp}</div>
      </div>
    `).join('');
    document.getElementById('targetOverlay').style.display = 'flex';
    window.targetCallback = callback;
  }

  document.getElementById('targetGrid').addEventListener('click', (e)=>{
    const card = e.target.closest('.target-card');
    if(!card || !window.targetCallback) return;
    const id = card.getAttribute('data-id');
    const list = (battleState?.players)||[];
    const target = list.find(p=>p.id===id);
    if(target){ window.targetCallback(target); }
    window.targetCallback = null;
    closeOverlay();
  });

  function getEnemyTargets(){
    if(!battleState || !myPlayer) return [];
    const enemyTeam = myPlayer.team === 'A' ? 'B' : 'A';
    return (battleState.players||[]).filter(p=>p.team===enemyTeam && p.hp>0);
  }
  function getTeamTargets(){
    if(!battleState || !myPlayer) return [];
    return (battleState.players||[]).filter(p=>p.team===myPlayer.team && p.hp>0);
  }

  // ======= 액션 =======
  function sendAction(action){
    if(!isMyTurnNow() || (myPlayer.hp||0)<=0) return;
    socket.emit('player:action', {battleId, playerId: myPlayer?.id, action}, (res)=>{
      if(res?.ok){
        hasActedThisTurn = true;
        disableActions();
        closeOverlay();
      }else{
        alert('행동 전송 실패: ' + (res?.error||'알 수 없는 오류'));
      }
    });
  }

  // 버튼 핸들러
  document.getElementById('attackBtn').onclick = ()=>{ 
    if(!isMyTurnNow()) return;
    showTargetOverlay('공격 대상 선택', getEnemyTargets(), (target)=> sendAction({type:'attack', targetId:target.id}));
  };
  document.getElementById('defendBtn').onclick = ()=>{ if(!isMyTurnNow()) return; sendAction({type:'defend'}); };
  document.getElementById('dodgeBtn').onclick  = ()=>{ if(!isMyTurnNow()) return; sendAction({type:'dodge'});  };
  document.getElementById('itemBtn').onclick   = ()=>{
    if(!isMyTurnNow()) return;
    const it = myPlayer.items||{};
    const list=[];
    if((it.dittany||it.ditany||0)>0) list.push({k:'dittany', name:'디터니', team:'ally'});
    if((it.attackBooster||it.attack_boost||0)>0) list.push({k:'attackBooster', name:'공격 보정기', team:'enemy'});
    if((it.defenseBooster||it.defense_boost||0)>0) list.push({k:'defenseBooster', name:'방어 보정기', team:'ally'});
    if(!list.length){ alert('사용 가능한 아이템이 없습니다'); return; }

    // 간단한 선택 UI
    document.getElementById('overlayTitle').textContent = '아이템 선택';
    const grid = document.getElementById('targetGrid');
    grid.innerHTML = list.map(it=>`<div class="target-card item-pick" data-k="${it.k}" style="padding:16px;font-weight:700">${it.name}</div>`).join('');
    document.getElementById('targetOverlay').style.display = 'flex';

    window.targetCallback = (picked)=>{
      // no-op; item pick uses separate handler below
    };

    grid.querySelectorAll('.item-pick').forEach(el=>{
      el.addEventListener('click', ()=>{
        const k = el.getAttribute('data-k');
        closeOverlay();
        if(k==='dittany'){
          showTargetOverlay('치유 대상 선택', getTeamTargets(), (t)=> sendAction({type:'item', item:'dittany', targetId:t.id}));
        }else if(k==='attackBooster'){
          showTargetOverlay('공격 보정 대상 선택', getEnemyTargets(), (t)=> sendAction({type:'item', item:'attackBooster', targetId:t.id}));
        }else if(k==='defenseBooster'){
          showTargetOverlay('방어 보정 대상 선택', getTeamTargets(), (t)=> sendAction({type:'item', item:'defenseBooster', targetId:t.id}));
        }
      }, {once:true});
    });
  };
  document.getElementById('passBtn').onclick   = ()=>{ if(!isMyTurnNow()) return; sendAction({type:'pass'}); };

  // ======= 채팅 =======
  function sendChat(){
    const input = document.getElementById('chatInput');
    const msg = input.value.trim();
    if(!msg) return;
    const sender = (myPlayer?.name) || urlName || '전투 참가자';
    socket.emit('chatMessage', { battleId, name: sender, message: msg });
    input.value = '';
  }
  document.getElementById('chatInput').addEventListener('keypress', (e)=>{ if(e.key==='Enter') sendChat(); });
  document.getElementById('chatSendBtn').addEventListener('click', sendChat);

  function addChat(msg){
    const ts = msg.timestamp || Date.now();
    const key = (msg.name||msg.senderName||'')+'|'+(msg.message||msg.content||'')+'|'+ts;
    if(dedupe(seenChat,key)) return;

    const name = msg.name || msg.senderName || '익명';
    const text = msg.message || msg.content || '';
    const panel = document.getElementById('chatPanel');
    const div = document.createElement('div');
    div.className = 'log-item';
    div.innerHTML = `<strong>${esc(name)}:</strong> ${esc(text)}`;
    panel.appendChild(div);
    panel.scrollTop = panel.scrollHeight;
  }

  // ======= 로그 =======
  function addLog(log){
    // 허용되는 포맷: {ts, type, message} 또는 {timestamp, level, text}
    const ts  = log.ts || log.timestamp || Date.now();
    const txt = log.message || log.text || '';
    const type = log.type || log.level || 'system';
    const key = ts + '|' + txt;
    if(dedupe(seenLog, key)) return;

    const panel = document.getElementById('logPanel');
    const time = new Date(ts).toLocaleTimeString('ko-KR',{hour12:false});
    const div = document.createElement('div');
    div.className = 'log-item';
    let typeClass = '';
    if(type === 'battle') typeClass = 'log-type-battle';
    if(type === 'error')  typeClass = 'log-type-error';
    if(type === 'notice') typeClass = 'log-type-notice';
    div.innerHTML = `<span class="log-time">[${time}]</span><span class="${typeClass}">${esc(txt)}</span>`;
    panel.appendChild(div);
    panel.scrollTop = panel.scrollHeight;
  }

  // ======= 소켓 이벤트 바인딩 =======
  socket.on('connect', ()=>{
    // 방 참여 (관성 조인)
    socket.emit('join', {battleId});
  });

  // 인증(플레이어) — 서버가 여러 이벤트명을 쓰는 경우 모두 지원
  function applyAuthedPlayer(p){
    if(!p) return;
    // 서버가 이름을 못 내려주는 경우 URL name으로 보완
    if(!p.name && urlName) p.name = urlName;
    myPlayer = p;
    updateMyInfo();
  }

  socket.emit('playerAuth', {battleId, token}, (res)=>{
    if(!res?.ok){ alert('인증 실패'); return; }
    applyAuthedPlayer(res.player);
  });
  socket.on('authSuccess',  (d)=> applyAuthedPlayer(d.player));
  socket.on('auth:success', (d)=> applyAuthedPlayer(d.player));

  // 스냅샷 — 양쪽 이벤트 모두 수신하되, render에서 키 비교로 1회만 반영
  const onSnap = (snap)=>{ battleState = snap; render(); };
  socket.on('battleUpdate', onSnap);
  socket.on('battle:update', onSnap);

  // 로그
  socket.on('battle:log', addLog);
  socket.on('battleLog',  addLog);
  socket.on('importantLog', addLog);

  // 채팅
  socket.on('chatMessage', addChat);
  socket.on('battle:chat', addChat);

  // 행동 성공(서버 이벤트 다양성 대응)
  socket.on('actionSuccess',           ()=>{ hasActedThisTurn = true; disableActions(); });
  socket.on('player:action:success',   ()=>{ hasActedThisTurn = true; disableActions(); });

  // 준비 완료
  document.getElementById('readyBtn').onclick = ()=>{
    const btn = document.getElementById('readyBtn');
    if(btn.classList.contains('done')) return;
    socket.emit('player:ready', {battleId, playerId: myPlayer?.id}, ()=>{
      socket.emit('chatMessage', {battleId, name: myPlayer?.name||urlName||'전투 참가자', message: '[준비 완료]'});
    });
    btn.classList.add('done');
    btn.textContent = '준비 완료됨';
  };

  // 종료 핸들러
  window.addEventListener('beforeunload', ()=>{ if(timerInterval) clearInterval(timerInterval); });

  // 초기 합류
  socket.emit('join', {battleId});
})();
</script>
</body>
</html>
