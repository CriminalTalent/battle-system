<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>PYXIS - 전투 참가자</title>
<script src="/socket.io/socket.io.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#0e0e0e; --bg2:#141414;
    --glass-1:rgba(255,255,255,.06); --glass-2:rgba(255,255,255,.10);
    --border:rgba(255,255,255,.14);
    --text:#F8F9FA; --muted:#A9AFB6;
    --gold:#DCC7A2; --gold2:#E6D2A8;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --shadow:0 10px 30px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(135deg,#000813,#001122);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
  .wrap{max-width:1280px;margin:0 auto;padding:16px;display:grid;grid-template-columns:320px 1fr 320px;gap:16px}
  .card{background:var(--glass-1);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
  .title{font-family:Cinzel,serif;color:var(--gold);font-weight:700;letter-spacing:.08em;margin-bottom:8px}
  .row{display:flex;align-items:center;gap:8px}
  .hp{height:8px;background:#0b0b0b;border:1px solid var(--border);border-radius:999px;overflow:hidden}
  .hp>span{display:block;height:100%;background:linear-gradient(90deg,#4ade80,#22c55e)}
  .stat{font-size:12px;color:#cbd5e1}
  .pill{font-size:12px;border:1px solid var(--border);background:var(--glass-1);padding:6px 10px;border-radius:999px}
  .muted{color:var(--muted);font-size:12px}
  img.por{width:46px;height:46px;object-fit:cover;border-radius:8px;background:#0b0b0b;border:1px solid var(--border)}

  .center .portrait{width:100%;aspect-ratio:1/1;border-radius:14px;border:1px solid var(--border);object-fit:cover;background:#0b0b0b;margin-bottom:10px}
  .meta{display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
  .actions{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
  .act{padding:12px;border-radius:10px;border:2px solid transparent;background:var(--glass-1);cursor:pointer;text-align:center;color:#ddd}
  .act.enabled{border-color:#c7af7b;color:#e6d2a8;font-weight:700}
  .act:disabled{opacity:.45;cursor:not-allowed}

  .log{height:220px;overflow:auto;background:var(--glass-1);border:1px solid var(--border);border-radius:10px;padding:10px}
  .entry{font-size:12px;margin-bottom:6px}
  .entry .t{color:#000;margin-right:6px;font-size:10px}
  .entry.rule{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#111;border-radius:8px;padding:6px}
  .entry.err{background:#000;border:1px solid #e6d2a8;color:#e6d2a8;border-radius:8px;padding:6px}
  .chatView{height:180px;overflow:auto;background:var(--glass-1);border:1px solid var(--border);border-radius:10px;padding:10px;margin-top:10px}
  .chatRow{display:flex;gap:8px;margin-top:8px}
  .chatRow input{flex:1;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0b0b0b;color:#fff}
  .chatRow button{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:linear-gradient(135deg,var(--gold),var(--gold2));font-weight:700;cursor:pointer}

  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:20}
  .ov-card{width:100%;max-width:460px;background:#0f0f0f;border:1px solid var(--border);border-radius:14px;padding:14px}
  .ov-title{font-weight:700;color:var(--gold2);margin-bottom:10px}
  .target{display:flex;gap:8px;align-items:center;background:var(--glass-2);border:1px solid var(--border);border-radius:10px;padding:8px;margin-bottom:8px;cursor:pointer}
  .target img{width:38px;height:38px;border-radius:8px;object-fit:cover;background:#0b0b0b;border:1px solid var(--border)}
  .ov-actions{display:flex;gap:8px;margin-top:8px}

  .me-highlight{border:2px solid var(--gold);box-shadow:0 0 10px rgba(220,199,162,.3)}
</style>
</head>
<body>
<div class="wrap">
  <section class="card">
    <div class="title">A팀</div>
    <div id="teamA"></div>
  </section>

  <section class="card center">
    <div class="title">현재 턴</div>
    <img id="curPor" class="portrait" alt="현재 턴 초상화" onerror="this.src='/uploads/avatars/default.png'">
    <div class="meta">
      <span id="turnInfo" class="pill">라운드 - / 팀 -</span>
      <span id="timer" class="pill">남은 시간 --:--</span>
      <span id="meInfo" class="pill" style="background:var(--gold);color:#000;font-weight:700">나: -</span>
    </div>
    <div id="orderRow" class="row" style="overflow:auto;padding-bottom:8px"></div>
    <div class="actions" style="margin-top:8px">
      <button id="btnAttack" class="act" disabled>공격</button>
      <button id="btnDefend" class="act" disabled>방어</button>
      <button id="btnDodge"  class="act" disabled>회피</button>
      <button id="btnItem"   class="act" disabled>아이템</button>
      <button id="btnPass"   class="act" disabled>패스</button>
    </div>
    <button id="btnReady" class="act enabled" style="margin-top:12px;width:100%;grid-column:1/-1">준비 완료</button>
  </section>

  <section class="card">
    <div class="title">B팀</div>
    <div id="teamB"></div>

    <div class="title" style="margin-top:12px">실시간 로그</div>
    <div id="log" class="log"></div>

    <div class="title" style="margin-top:12px">채팅</div>
    <div id="chatView" class="chatView"></div>
    <div class="chatRow">
      <input id="chatMsg" type="text" maxlength="140" placeholder="메시지 입력"/>
      <button id="btnSend">전송</button>
    </div>
  </section>
</div>

<div id="overlay" class="overlay" role="dialog" aria-modal="true">
  <div class="ov-card">
    <div id="ovTitle" class="ov-title">대상 선택</div>
    <div id="targetList"></div>
    <div class="ov-actions">
      <button id="btnCancelTarget" class="btn" style="flex:1;background:#222;color:#ddd;border:1px solid #333">취소</button>
    </div>
  </div>
</div>

<script>
  const $ = s => document.querySelector(s);
  const escapeHtml = (t)=>String(t).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const q = new URLSearchParams(location.search);
  const battleId = q.get('battle') || '';
  const myName   = q.get('name') || '';
  const token    = q.get('password') || q.get('token') || q.get('otp') || '';
  const myTeam   = q.get('team') || '';
  const playerIdParam = q.get('playerId') || '';
  const socket = io({ path: '/socket.io' });

  let me = null;
  let snapshot = null;
  let currentActionLock = null;

  const teamA = $("#teamA"), teamB = $("#teamB");
  const curPor = $("#curPor");
  const orderRow = $("#orderRow");
  const turnInfo = $("#turnInfo");
  const meInfo   = $("#meInfo");
  const timer    = $("#timer");
  const logView  = $("#log");
  const chatView = $("#chatView");
  const btnAttack=$("#btnAttack"), btnDefend=$("#btnDefend"), btnDodge=$("#btnDodge"), btnItem=$("#btnItem"), btnPass=$("#btnPass");
  const btnReady = $("#btnReady");

  const overlay = $("#overlay"), targetList = $("#targetList"), btnCancelTarget = $("#btnCancelTarget"), ovTitle = $("#ovTitle");
  let overlayMode = null;

  function addLog(message, type=''){
    const t = new Date().toLocaleTimeString('ko-KR',{hour12:false,hour:'2-digit',minute:'2-digit'});
    const d = document.createElement('div'); d.className='entry '+(type||'');
    d.innerHTML = `<span class="t">${t}</span>${escapeHtml(message)}`;
    logView.appendChild(d); logView.scrollTop = logView.scrollHeight;
    while(logView.children.length>400) logView.removeChild(logView.firstChild);
  }
  function addChat(name, message){
    const d=document.createElement('div'); d.className='entry';
    const t=new Date().toLocaleTimeString('ko-KR',{hour12:false,hour:'2-digit',minute:'2-digit'});
    d.innerHTML = `<span class="t">${t}</span><b>${escapeHtml(name)}:</b> ${escapeHtml(message)}`;
    chatView.appendChild(d); chatView.scrollTop = chatView.scrollHeight;
    while(chatView.children.length>400) chatView.removeChild(chatView.firstChild);
  }
  function setImg(img,url){ img.src = url||'/uploads/avatars/default.png'; img.onerror=()=>{img.onerror=null; img.src='/uploads/avatars/default.png';}; }

  function mmss(sec){ if(typeof sec!=="number"||sec<0) return "--:--"; const m=Math.floor(sec/60), s=sec%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }

  function renderTeams(players){
    const renderOne = (p)=>{
      const box = document.createElement('div'); box.className='row'; box.style.marginBottom='8px';
      if(me && p.id === me.id) box.classList.add('me-highlight');
      const img = document.createElement('img'); img.className='por'; setImg(img, p.avatar);
      const mid = document.createElement('div'); mid.style.flex='1';
      const name = document.createElement('div'); name.textContent = (me && p.id === me.id ? '▶ ' : '') + (p.name||'-');
      const hp = document.createElement('div'); hp.className='hp'; const fill = document.createElement('span');
      const maxHp = p.maxHp||100, curHp=p.hp||0; fill.style.width = Math.max(0, Math.min(100, Math.round(curHp/maxHp*100)))+'%';
      hp.appendChild(fill);
      const stat = document.createElement('div'); stat.className='stat';
      const s = p.stats||{}; stat.textContent = `공:${s.attack||1} 방:${s.defense||1} 민:${s.agility||1} 행:${s.luck||1}`;
      mid.appendChild(name); mid.appendChild(hp); mid.appendChild(stat);
      box.appendChild(img); box.appendChild(mid);
      return box;
    };
    teamA.innerHTML=''; teamB.innerHTML='';
    players.filter(p=>p.team==='A').forEach(p=> teamA.appendChild(renderOne(p)));
    players.filter(p=>p.team==='B').forEach(p=> teamB.appendChild(renderOne(p)));
  }

  function renderOrderRow(){
    orderRow.innerHTML='';
    if(!snapshot) return;
    const team = snapshot.currentTurn?.currentTeam;
    const list = (snapshot.players||[]).filter(p=>p.team===team && (p.hp??0)>0)
      .sort((a,b)=>{
        const ag=(b.stats?.agility||1)-(a.stats?.agility||1);
        if(ag!==0) return ag;
        return String(a.name||"").localeCompare(String(b.name||""),"ko-KR");
      });
    for(const p of list){
      const img = document.createElement('img'); img.className='por';
      setImg(img,p.avatar);
      if(snapshot.currentTurn?.currentPlayer?.id===p.id){
        img.style.outline='2px solid #c7af7b';
      }else{
        img.style.opacity='.65';
      }
      img.title = p.name;
      orderRow.appendChild(img);
    }
  }

  function updateCenter(){
    const ct = snapshot?.currentTurn || {};
    const cur = ct.currentPlayer?.id ? (snapshot.players||[]).find(p=>p.id===ct.currentPlayer.id) : null;
    setImg(curPor, cur?.avatar || null);
    turnInfo.textContent = `라운드 ${ct.turnNumber||0} / ${ct.currentTeam||'-'}팀`;
    timer.textContent = `남은 시간 ${mmss(ct.timeLeftSec)}`;
  }

  function enableActions(){
    const ct = snapshot?.currentTurn||{};
    const ok = (snapshot?.status==="active"
      && me?.team === ct.currentTeam
      && me?.id === ct.currentPlayer?.id
      && !currentActionLock);

    for(const b of [btnAttack,btnDefend,btnDodge,btnItem,btnPass]){
      b.disabled = !ok;
      b.classList.toggle('enabled', !!ok);
    }
  }

  function bindSocket(){
    socket.emit('join', { battleId });

    socket.on('battleUpdate', (data)=>{
      const prevTurn = snapshot?.currentTurn?.turnNumber || 0;
      const newTurn = data?.currentTurn?.turnNumber || 0;
      
      if(newTurn > prevTurn) {
        currentActionLock = false;
      }
      
      snapshot = data; 
      updateCenter(); 
      renderTeams(snapshot.players||[]); 
      renderOrderRow(); 
      enableActions();
    });

    const onLog = (e)=>{ if(e?.message) addLog(e.message, e.type==='battle'?'rule':''); };
    socket.on('battle:log', onLog);
    socket.on('battleLog', onLog);

    const onChat = (p)=>{ const msg = p?.message||p?.text||''; const name = p?.name || '익명'; if(msg) addChat(name,msg); };
    socket.on('chatMessage', onChat);
    socket.on('battle:chat', onChat);

    socket.emit('playerAuth', {
      battleId,
      token,
      playerId: playerIdParam,
      playerName: myName
    }, (res)=>{
      if(res?.ok){
        me = { id: res.playerId, name: res.name, team: res.team, avatar: res.avatar||null };
        meInfo.textContent = `나: ${me.name||'-'} (${me.team}팀)`;
        addLog('인증 성공');
        renderTeams(snapshot?.players || []);
      }else{
        addLog('인증 실패','err');
      }
    });
  }

  $("#btnSend").addEventListener('click', ()=>{
    const msg = $("#chatMsg").value.trim(); if(!msg) return;
    socket.emit('chatMessage', { battleId, name: (me?.name||myName||'전투 참가자'), message: msg });
    $("#chatMsg").value='';
  });
  $("#chatMsg").addEventListener('keydown', (e)=>{
    if(e.key==='Enter') $("#btnSend").click();
  });

  btnReady.addEventListener('click', ()=>{
    if(!me?.id) return;
    btnReady.disabled = true; btnReady.textContent='준비 완료됨'; btnReady.style.opacity='0.5';
    addLog('내 상태: 준비 완료','rule');
    socket.emit('player:ready', { battleId, playerId: me.id, ready:true });
  });

  function openOverlay(mode){
    overlayMode = mode;
    targetList.innerHTML='';
    if(mode==='attack'){
      ovTitle.textContent='공격 대상 선택';
      const enemies = (snapshot?.players||[]).filter(p=>p.team!==me.team && (p.hp??0)>0);
      addTargets(enemies, (t)=> sendAction('attack', t.id));
    }else if(mode==='dittany'){
      ovTitle.textContent='치유 대상 선택';
      const allies = (snapshot?.players||[]).filter(p=>p.team===me.team && (p.hp??0)>0);
      addTargets(allies, (t)=> sendAction('item', null, 'dittany', t.id));
    }
    overlay.style.display='flex';
  }
  function addTargets(list, onPick){
    if(list.length===0){
      const d=document.createElement('div'); d.className='entry err'; d.textContent='대상이 없습니다.'; targetList.appendChild(d);
    }else{
      list.forEach(p=>{
        const row=document.createElement('div'); row.className='target';
        const img=document.createElement('img'); setImg(img,p.avatar);
        const span=document.createElement('div'); span.textContent = p.name||'-';
        row.appendChild(img); row.appendChild(span);
        row.addEventListener('click', ()=>{ closeOverlay(); onPick(p); });
        targetList.appendChild(row);
      });
    }
  }
  function closeOverlay(){ overlay.style.display='none'; overlayMode=null; }
  btnCancelTarget.addEventListener('click', closeOverlay);

  function sendAction(type, targetId=null, item=null, healTargetId=null){
    if(!me?.id) return;
    currentActionLock = true; enableActions();
    const payload = { battleId, playerId: me.id, action: { type } };
    if(type==='attack' && targetId) payload.action.targetId = targetId;
    if(type==='item'){
      payload.action.item = item || 'dittany';
      if(item==='dittany') payload.action.targetId = healTargetId || me.id;
    }
    socket.emit('playerAction', payload, (res)=>{
      if(!res?.ok){
        addLog('행동 전송 실패: '+(res?.error||'오류'),'err');
        currentActionLock = false; enableActions();
      }else{
        addLog('행동 선택 완료');
      }
    });
  }

  btnAttack.addEventListener('click', ()=> openOverlay('attack'));
  btnDefend.addEventListener('click', ()=> sendAction('defend'));
  btnDodge .addEventListener('click', ()=> sendAction('dodge'));
  btnItem  .addEventListener('click', ()=> openOverlay('dittany'));
  btnPass  .addEventListener('click', ()=> sendAction('pass'));

  document.addEventListener('DOMContentLoaded', bindSocket);
</script>
</body>
</html>
