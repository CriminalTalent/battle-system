<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PYXIS - 전투 참가자</title>
  <script src="/socket.io/socket.io.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --deep:#0b1117; --deep2:#131b24;
      --glass1:rgba(26,36,47,.35); --glass2:rgba(26,36,47,.60); --glass3:rgba(26,36,47,.90);
      --border:#2a3441; --border2:#3a4451;
      --gold:#dcc7a2; --gold2:#e6d2a8;
      --txt:#e5e7eb; --muted:#9aa4b2;
      --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
      --r:14px; --shadow:0 10px 30px rgba(0,0,0,.28);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(135deg,var(--deep),var(--deep2));color:var(--txt);
      font-family:ui-sans-serif,system-ui,"Apple SD Gothic Neo","Noto Sans KR",sans-serif}
    .wrap{max-width:1240px;margin:0 auto;padding:12px 16px}
    .brand{font-family:Cinzel,serif;color:var(--gold2);font-weight:700;letter-spacing:.06em}
    .header{position:sticky;top:0;background:rgba(0,0,0,.28);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.06);z-index:50}
    .row{display:flex;justify-content:space-between;align-items:center}
    .conn{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:50%;background:#6b7280;border:1px solid rgba(255,255,255,.18)}
    .dot.ok{background:var(--ok);box-shadow:0 0 8px rgba(16,185,129,.35)}
    .muted{color:var(--muted)}
    .hidden{display:none!important}

    /* Auth card */
    .auth{min-height:calc(100vh - 56px);display:flex;align-items:center;justify-content:center}
    .card{width:100%;max-width:520px;background:var(--glass3);border:1px solid rgba(220,199,162,.35);
      border-radius:var(--r);box-shadow:var(--shadow);padding:18px}
    .card h2{margin:0 0 12px;color:var(--gold2)}
    .fg{margin-bottom:10px}
    .fg label{display:block;font-size:12px;color:#d3d7df;margin-bottom:6px}
    input[type=text],input[type=password]{width:100%;padding:11px 12px;border-radius:10px;border:1px solid var(--border);
      background:var(--glass1);color:var(--txt);outline:none}
    .btn{display:inline-block;background:linear-gradient(135deg,var(--gold),var(--gold2));color:#0b1117;border:0;border-radius:10px;
      padding:11px 14px;font-weight:700;cursor:pointer;letter-spacing:.02em}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .log{font-size:12px;opacity:.85;margin-top:8px;white-space:pre-line}

    /* GRID */
    .game{display:none}
    .game.active{display:block}
    .grid{display:grid;grid-template-columns:300px 1fr 380px;gap:14px}
    @media (max-width:1024px){ .grid{grid-template-columns:1fr} }

    .panel{background:var(--glass2);border:1px solid var(--border);border-radius:var(--r);padding:12px;min-height:140px}
    .ttl{color:var(--gold2);font-weight:700;margin-bottom:8px}

    /* 내 카드 */
    .me-card .top{display:flex;gap:10px;align-items:center}
    .avatar{width:70px;height:70px;border-radius:14px;background:#0f1720;border:1px solid var(--border2);
      background-size:cover;background-position:center}
    .hpbar{margin-top:6px}
    .bar{height:8px;background:#1f2937;border:1px solid #334155;border-radius:999px;overflow:hidden}
    .bar > i{display:block;height:100%;background:linear-gradient(90deg,#34d399,#22c55e);width:100%}

    /* 아군/적군 리스트 */
    .row-sm{display:flex;gap:8px;align-items:center;background:rgba(26,36,47,.5);border:1px solid var(--border2);
      border-radius:10px;padding:6px;margin-bottom:6px}
    .row-sm .p{width:36px;height:36px;border-radius:8px;background:#0f1720;border:1px solid var(--border2);
      background-size:cover;background-position:center}
    .hpbar-sm .bar{height:6px}

    /* 턴/행동 */
    .turn{display:flex;gap:12px;align-items:center}
    .portrait{width:90px;height:110px;border-radius:12px;border:1px solid var(--border2);background:#0f1720;
      background-size:cover;background-position:center}
    .queue{display:flex;gap:4px;flex-wrap:wrap;margin-top:6px}
    .q{width:26px;height:26px;border-radius:6px;border:1px solid var(--border2);background:#0f1720;
      opacity:.4;background-size:cover;background-position:center}
    .q.on{opacity:1;outline:2px solid var(--gold)}
    .actions{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-top:10px}

    /* 로그/채팅 */
    .logs{height:180px;overflow:auto;background:rgba(26,36,47,.5);border:1px solid var(--border2);border-radius:10px;padding:8px}
    .logrow{padding:6px 6px;border-bottom:1px dashed rgba(255,255,255,.08);font-size:13px;line-height:1.35}
    .logrow.round{background:rgba(220,199,162,.08);border-left:3px solid var(--gold2);font-weight:700}
    .logrow.act{border-left:3px solid #3b82f6}
    .logrow.res{border-left:3px solid #10b981;background:rgba(16,185,129,.08)}
    .logrow.sys{border-left:3px solid #f59e0b;background:rgba(245,158,11,.08)}
    .chatbox{margin-top:10px}
    .chatlist{height:120px;overflow:auto;background:rgba(26,36,47,.4);border:1px solid var(--border2);border-radius:10px;padding:8px}
    .chatrow{font-size:13px;margin-bottom:4px}
    .chatrow b{color:var(--gold2)}
    .chatinput{display:flex;gap:8px;margin-top:6px}
    .chatinput input{flex:1;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--glass1);color:var(--txt)}

    /* 오버레이 */
    .auth-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);display:none;z-index:100;align-items:center;justify-content:center}
    .auth-overlay.show{display:flex}
    .auth-box{background:var(--glass3);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:20px;min-width:260px;text-align:center}
    .spinner{width:50px;height:50px;border-radius:50%;border:5px solid rgba(220,199,162,.25);border-top-color:var(--gold2);animation:spin 1s linear infinite;margin:0 auto}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <header class="header">
    <div class="wrap row">
      <div class="brand">PYXIS</div>
      <div class="conn"><span id="connText">서버 연결</span><span id="connDot" class="dot"></span></div>
    </div>
  </header>

  <!-- 인증 -->
  <main id="authPage" class="auth">
    <div class="card">
      <h2>전투 참가자 인증</h2>
      <form id="authForm">
        <div class="fg"><label>전투 참가자명</label><input id="playerName" type="text"/></div>
        <div class="fg"><label>비밀번호</label><input id="playerOtp" type="password"/></div>
        <button class="btn" type="submit">전투 참가</button>
      </form>
      <div id="localLog" class="log"></div>
    </div>
  </main>

  <!-- 게임 -->
  <section id="gamePage" class="game">
    <div class="wrap grid">
      <!-- 좌: 내 정보 + 아군 -->
      <aside class="panel">
        <div class="ttl">내 정보</div>
        <div class="me-card">
          <div class="top">
            <div id="meAvatar" class="avatar"></div>
            <div>
              <div id="meName">이름</div>
              <div id="meTeam" class="muted">A팀</div>
              <div class="hpbar"><div class="bar"><i id="meHpBar"></i></div><div id="meHp" class="muted">100/100</div></div>
            </div>
          </div>
          <div class="stat-grid">
            <div>공격 <b id="sAtk">1</b></div>
            <div>방어 <b id="sDef">1</b></div>
            <div>민첩 <b id="sAgi">1</b></div>
            <div>행운 <b id="sLuk">1</b></div>
          </div>
          <div id="myItems" style="margin-top:8px">
            디터니 <b id="itDit">0</b> | 공격 보정기 <b id="itAtkB">0</b> | 방어 보정기 <b id="itDefB">0</b>
          </div>
        </div>
        <div class="ttl" style="margin-top:10px">아군</div>
        <div id="allyList"></div>
        <button id="btnReady" class="btn" style="margin-top:8px;width:100%">준비 완료</button>
      </aside>

      <!-- 중: 현재 차례 + 행동 -->
      <section class="panel">
        <div class="ttl">현재 차례</div>
        <div class="turn">
          <div id="turnImg" class="portrait"></div>
          <div style="flex:1">
            <div id="turnName">대기 중</div>
            <div class="hpbar-sm"><div class="bar"><i id="turnHpBar" style="width:0%"></i></div></div>
            <div id="queue" class="queue"></div>
          </div>
          <div id="turnTeam">-팀</div>
        </div>
        <div class="actions">
          <button id="btnAttack" class="btn">공격</button>
          <button id="btnDefend" class="btn">방어</button>
          <button id="btnDodge" class="btn">회피</button>
          <button id="btnItem" class="btn">아이템</button>
          <button id="btnPass" class="btn">패스</button>
        </div>
      </section>

      <!-- 우: 적군 + 로그 + 채팅 -->
      <aside class="panel">
        <div class="ttl">상대 팀</div>
        <div id="enemyList"></div>

        <div class="ttl" style="margin-top:10px">실시간 로그</div>
        <div id="logs" class="logs"></div>

        <div class="ttl" style="margin-top:10px">채팅</div>
        <div id="chatLogs" class="chatlist"></div>
        <div class="chatinput"><input id="chatMsg" placeholder="메시지 입력"/><button id="btnSend" class="btn">전송</button></div>
      </aside>
    </div>
  </section>

  <!-- 접속 오버레이 -->
  <div id="authOverlay" class="auth-overlay">
    <div class="auth-box">
      <div class="spinner"></div>
      <div class="txt">접속 중…<br/>서버와 인증을 확인하는 중</div>
    </div>
  </div>

  <script>
    const socket = io({ path: '/socket.io' });
    const authOverlay=document.getElementById('authOverlay');
    const authPage=document.getElementById('authPage');
    const gamePage=document.getElementById('gamePage');
    function showOverlay(){authOverlay.classList.add('show')}
    function hideOverlay(){authOverlay.classList.remove('show')}

    socket.on('connect',()=>{
      document.getElementById('connDot').classList.add('ok');
      showOverlay();
      const battleId=new URLSearchParams(location.search).get('battle');
      const otp=new URLSearchParams(location.search).get('otp')||new URLSearchParams(location.search).get('token')||new URLSearchParams(location.search).get('password');
      const name=new URLSearchParams(location.search).get('name');
      if(battleId&&otp&&name){
        socket.emit('join',{battleId});
        socket.emit('playerAuth',{battleId,password:otp,playerName:name});
      }
    });

    socket.on('authSuccess',onAuthOK);
    socket.on('auth:success',onAuthOK);
    socket.on('authError',()=>{hideOverlay();alert('인증 실패');});

    function onAuthOK(d){
      hideOverlay();
      authPage.classList.add('hidden');
      gamePage.classList.add('active');
    }

    // 로그/채팅
    socket.on('battle:log',(entry)=>{
      const el=document.createElement('div');
      el.className='logrow '+(entry.type||'');
      el.innerHTML='<span class="t">['+new Date(entry.ts).toLocaleTimeString()+']</span> '+entry.message;
      document.getElementById('logs').appendChild(el);
      document.getElementById('logs').scrollTop=99999;
    });
    socket.on('chatMessage',(msg)=>{
      const el=document.createElement('div');
      el.className='chatrow';
      el.innerHTML='<b>'+msg.name+':</b> '+msg.message;
      document.getElementById('chatLogs').appendChild(el);
      document.getElementById('chatLogs').scrollTop=99999;
    });
    document.getElementById('btnSend').onclick=()=>{
      const val=document.getElementById('chatMsg').value.trim();
      if(val){socket.emit('chatMessage',{message:val,name:'나'});document.getElementById('chatMsg').value=''}
    };
  </script>
</body>
</html>
