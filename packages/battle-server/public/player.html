<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>PYXIS - 전투 참가자</title>
<script src="/socket.io/socket.io.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#0e0e0e; --bg2:#141414;
    --glass-1:rgba(0,0,0,.7); --glass-2:rgba(0,0,0,.5);
    --border:rgba(220,199,162,.3);
    --text:#F8F9FA; --muted:#A9AFB6;
    --gold:#DCC7A2; --gold2:#E6D2A8;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --shadow:0 10px 30px rgba(0,0,0,.45);
    --team-a-color:#8b5757; --team-b-color:#5d6b8d;
    --result-bg:#DCC7A2; --result-text:#000;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:linear-gradient(135deg,#000813,#001122);color:var(--text);font-family:system-ui,-apple-system,sans-serif;min-height:100vh;padding:8px}
  body.battle-ended{overflow:hidden}
  .container{max-width:1400px;margin:0 auto}
  .header{text-align:center;padding:16px;font-family:Cinzel,serif;color:var(--gold);font-size:24px;letter-spacing:.1em}
  .main-grid{display:grid;gap:12px;grid-template-columns:1fr;}
  @media (min-width:768px){ .main-grid{ grid-template-columns:1fr 2fr 1fr; } }
  .team-container{background:var(--glass-1);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:var(--shadow);height:fit-content}
  .team-title{font-family:Cinzel,serif;color:var(--gold);font-weight:700;letter-spacing:.08em;margin-bottom:12px;font-size:16px;text-align:center}
  .center-section{display:flex;flex-direction:column;gap:12px}
  .card{background:var(--glass-1);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:var(--shadow)}
  .title{font-family:Cinzel,serif;color:var(--gold);font-weight:700;letter-spacing:.08em;margin-bottom:8px;font-size:14px}

  .player-card{background:var(--glass-2);border:1px solid var(--border);border-radius:8px;padding:8px;margin-bottom:8px;display:flex;align-items:center;gap:8px}
  .player-card.dead{opacity:.5}
  .player-avatar{width:32px;height:32px;border-radius:6px;object-fit:cover;border:1px solid var(--gold);background:#000}
  .player-info{flex:1;min-width:0}
  .player-name{font-size:12px;font-weight:600;color:var(--gold);margin-bottom:2px}
  .hp{height:6px;background:#0b0b0b;border:1px solid var(--border);border-radius:999px;overflow:hidden;margin-bottom:2px}
  .hp>span{display:block;height:100%;background:linear-gradient(90deg,#4ade80,#22c55e);transition:width .3s}
  .hp-text{font-size:10px;color:var(--muted);margin-bottom:2px}
  .stats{font-size:10px;color:var(--muted)}
  .items-info{font-size:9px;color:var(--text);margin-top:2px}
  .ready-status{font-size:9px;color:var(--gold);margin-top:2px}

  .battle-main{text-align:center}
  .current-player-info{background:var(--glass-2);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px}
  .current-avatar{
    width:100%; max-width:560px; height:320px; margin:0 auto 12px auto;
    display:block; object-fit:cover; border:4px solid var(--gold); border-radius:16px; background:#000;
  }
  .turn-info{font-size:16px;margin-bottom:8px;color:var(--text);font-weight:600}
  .timer-display{color:var(--gold);font-size:32px;margin-bottom:8px;font-weight:700}
  .timer-seconds{font-size:14px;color:var(--muted);margin-bottom:16px}

  .my-info-section{background:var(--glass-2);border:1px solid var(--border);border-radius:8px;padding:8px;margin-bottom:12px}
  .my-info-header{display:flex;align-items:center;gap:6px;margin-bottom:6px}
  .my-avatar{width:32px;height:32px;border-radius:6px;object-fit:cover;border:2px solid var(--gold);background:#000}
  .my-details{flex:1}
  .my-name{font-weight:600;color:var(--gold);font-size:12px}
  .my-team{font-size:10px;color:var(--muted)}
  .my-hp-bar{height:6px;background:#0b0b0b;border:1px solid var(--border);border-radius:999px;overflow:hidden;margin:2px 0}
  .my-hp-fill{height:100%;background:linear-gradient(90deg,#4ade80,#22c55e);transition:width .3s}
  .my-hp-text{font-size:9px;color:var(--muted);margin-bottom:2px}
  .my-stats{font-size:9px;color:var(--muted);margin-bottom:2px}
  .my-items{font-size:8px;color:var(--text);margin-bottom:6px}
  .ready-btn{background:transparent;color:var(--gold);border:2px solid var(--gold);padding:6px 12px;border-radius:6px;font-weight:600;cursor:pointer;transition:all .2s;width:100%;font-size:10px}
  .ready-btn:hover:not(.done){background:var(--gold);color:#000}
  .ready-btn.done{background:var(--muted);border-color:var(--muted);color:#666;cursor:not-allowed}

  .actions{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin:16px 0}
  .act{background:transparent;color:var(--gold);border:2px solid var(--gold);padding:12px 6px;border-radius:8px;font-size:14px;cursor:pointer;transition:all .2s;font-weight:700}
  .act:hover:not(:disabled){background:var(--gold);color:#000}
  .act:disabled{opacity:.4;cursor:not-allowed}

  /* 로그와 채팅 */
  .logs-section{height:400px;overflow-y:auto;background:var(--glass-2);border:1px solid var(--border);padding:8px;border-radius:8px;margin-bottom:12px}
  .chat-section{height:400px;overflow-y:auto;background:var(--glass-2);border:1px solid var(--border);padding:8px;border-radius:8px;margin-bottom:8px}
  .log-item{margin-bottom:4px;font-size:11px;line-height:1.4;padding:2px 4px;border-radius:4px}
  .log-time{color:var(--muted);font-weight:normal}
  .chat-item{margin-bottom:4px;font-size:11px}
  .chat-name{color:var(--gold);font-weight:600}

  /* 채팅 입력(예전 스타일 복구) */
  .input-group{display:flex;gap:6px;margin-top:6px}
  .chat-input{
    flex:1;background:var(--glass-1);border:1px solid var(--border);
    color:var(--text);padding:10px 12px;border-radius:8px;font-size:13px;
  }
  .chat-input::placeholder{color:var(--muted)}
  .send-btn{
    background:var(--gold);color:#000;border:none;padding:10px 16px;border-radius:8px;
    font-size:13px;cursor:pointer;font-weight:700;min-width:80px;
  }
  .send-btn:hover{background:var(--gold2)}

  /* 로그 분류 */
  .log-team-a{background-color:var(--team-a-color);color:var(--text)}
  .log-team-b{background-color:var(--team-b-color);color:var(--text)}
  .log-result{background-color:var(--result-bg);color:var(--result-text)}
  .log-notice{background-color:var(--glass-1);color:var(--gold)}
  .log-error{background-color:#000;color:var(--gold)}
  .log-system{background-color:transparent;color:var(--muted)}

  @media (max-width:767px){
    .main-grid{grid-template-columns:1fr}
    .actions{grid-template-columns:repeat(3,1fr)}
    .current-avatar{height:260px}
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">PYXIS 전투 시스템</div>

  <div class="main-grid">
    <!-- 좌측: A팀 + 채팅 -->
    <div>
      <div class="team-container" style="margin-bottom:12px">
        <div class="team-title">A팀</div>
        <div id="teamA"></div>
      </div>

      <div class="card">
        <div class="title">채팅</div>
        <div class="chat-section" id="chatPanel"></div>
        <div class="input-group">
          <input class="chat-input" id="chatInput" type="text" placeholder="메시지 입력..."/>
          <button class="send-btn" id="chatSend" type="button">전송</button>
        </div>
      </div>
    </div>

    <!-- 중앙: 내 정보 + 현재 전투 진행 -->
    <div class="center-section">
      <!-- 내 정보 -->
      <div class="card">
        <div class="my-info-section">
          <div class="my-info-header">
            <img id="myPortrait" class="my-avatar" alt="내 아바타" onerror="this.style.background='#000';this.removeAttribute('src')"/>
            <div class="my-details">
              <div id="myName" class="my-name">전투 참가자</div>
              <div class="my-team"><span id="myTeam">?</span>팀</div>
            </div>
          </div>
          <div class="my-hp-bar"><div id="myHpBar" class="my-hp-fill" style="width:100%"></div></div>
          <div id="myHpText" class="my-hp-text">100/100</div>
          <div id="myStats" class="my-stats">공0 방0 민0 행0</div>
          <div id="myItems" class="my-items">아이템 없음</div>
          <button id="readyBtn" class="ready-btn" type="button">준비 완료</button>
        </div>
      </div>

      <!-- 현재 턴 -->
      <div class="card battle-main">
        <div class="current-player-info">
          <img id="currentPortrait" class="current-avatar" alt="현재 플레이어" onerror="this.style.background='#000';this.removeAttribute('src')"/>
          <div id="turnInfo" class="turn-info">대기 중...</div>
          <div id="timerDisplay" class="timer-display">0:00</div>
          <div id="timerSeconds" class="timer-seconds">0초</div>
        </div>

        <div class="actions">
          <button class="act" id="attackBtn" type="button" disabled>공격</button>
          <button class="act" id="defendBtn" type="button" disabled>방어</button>
          <button class="act" id="dodgeBtn"  type="button" disabled>회피</button>
          <button class="act" id="itemBtn"   type="button" disabled>아이템</button>
          <button class="act" id="passBtn"   type="button" disabled>패스</button>
        </div>
      </div>
    </div>

    <!-- 우측: B팀 + 로그 -->
    <div>
      <div class="team-container" style="margin-bottom:12px">
        <div class="team-title">B팀</div>
        <div id="teamB"></div>
      </div>

      <div class="card">
        <div class="title">실시간 로그</div>
        <div class="logs-section" id="logPanel"></div>
      </div>
    </div>
  </div>
</div>

<!-- 액션 선택 오버레이 -->
<div id="actionOverlay" class="action-overlay" style="position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:1000">
  <div class="action-content" style="background:var(--glass-1);border:2px solid var(--gold);border-radius:12px;padding:20px;max-width:500px;width:90%">
    <div class="action-title" id="actionTitle" style="font-family:Cinzel,serif;color:var(--gold);font-size:18px;margin-bottom:12px;text-align:center">대상 선택</div>
    <div class="targets" id="overlayTargets" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:8px;margin:8px 0"></div>
    <button class="cancel-btn" id="cancelAction" style="background:var(--bad);color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;margin-top:12px;width:100%">취소</button>
  </div>
</div>

<script>
(()=> {
  const qs  = new URLSearchParams(location.search);
  const battleId = qs.get('battle');
  const token    = qs.get('token');
  const urlName  = qs.get('name');

  if (!battleId || !token) {
    alert('올바르지 않은 URL입니다');
    return;
  }

  const socket = io();

  const logPanel  = document.getElementById('logPanel');
  const chatPanel = document.getElementById('chatPanel');

  let myPlayerId = null;
  let myPlayer   = null;
  let battle     = null;

  // 턴 변경 감지용 (턴 번호 + 현재 팀)
  let lastTurnKey = null;
  let hasActedThisTurn = false;

  // 중복 방지
  const seenLogKeys = new Set();
  const seenChats   = new Set();

  const esc = s => s ? s.replace(/</g,'&lt;').replace(/>/g,'&gt;') : '';

  function classForLog(type, message) {
    if (type === 'teamA') return 'log-team-a';
    if (type === 'teamB') return 'log-team-b';
    if (type === 'result') return 'log-result';
    if (type === 'notice') return 'log-notice';
    if (type === 'error')  return 'log-error';
    if (type === 'system') return 'log-system';
    const m = message || '';
    if (/A팀|=== A팀| A\d/.test(m)) return 'log-team-a';
    if (/B팀|=== B팀| B\d/.test(m)) return 'log-team-b';
    if (/라운드 해석|승리|결과|===/.test(m)) return 'log-result';
    return 'log-system';
  }

  function addLog({ts, type, message}) {
    if (!message) return;
    const key = `${ts}|${type}|${message}`;
    if (seenLogKeys.has(key)) return;
    seenLogKeys.add(key);
    if (seenLogKeys.size > 1200) {
      const first = seenLogKeys.values().next().value;
      seenLogKeys.delete(first);
    }
    const time = new Date(ts || Date.now()).toLocaleTimeString('ko-KR',{hour12:false});
    const div  = document.createElement('div');
    div.className = `log-item ${classForLog(type,message)}`;
    div.innerHTML = `<span class="log-time">[${time}]</span> ${esc(message)}`;
    logPanel.appendChild(div);
    logPanel.scrollTop = logPanel.scrollHeight;
  }

  function addChat({name, message}) {
    if (!name || !message) return;
    const key = `${name}|${message}`;
    if (seenChats.has(key)) return;
    seenChats.add(key);
    if (seenChats.size > 200) {
      const first = seenChats.values().next().value;
      seenChats.delete(first);
    }
    const div = document.createElement('div');
    div.className = 'chat-item';
    div.innerHTML = `<span class="chat-name">${esc(name)}</span>: ${esc(message)}`;
    chatPanel.appendChild(div);
    chatPanel.scrollTop = chatPanel.scrollHeight;
  }

  function renderTeams() {
    if (!battle?.players) return;
    const teamA = battle.players.filter(p=>p.team==='A');
    const teamB = battle.players.filter(p=>p.team==='B');

    function renderTeam(players, id) {
      let html = '';
      players.forEach(p=>{
        const hpPct = Math.max(0, p.hp/(p.maxHp||100)*100);
        const items = [];
        if ((p.items?.dittany || p.items?.ditany) > 0) items.push(`디터니 ${p.items?.dittany || p.items?.ditany}`);
        if ((p.items?.attackBooster || p.items?.attack_boost) > 0) items.push(`공격보정 ${p.items?.attackBooster || p.items?.attack_boost}`);
        if ((p.items?.defenseBooster || p.items?.defense_boost) > 0) items.push(`방어보정 ${p.items?.defenseBooster || p.items?.defense_boost}`);
        const readyStatus = p.ready ? '준비완료' : '대기중';
        html += `
        <div class="player-card ${p.hp>0?'':'dead'}">
          <img src="${p.avatar||''}" class="player-avatar" alt="${esc(p.name)}"
               onerror="this.style.background='#000';this.removeAttribute('src')"/>
          <div class="player-info">
            <div class="player-name">${esc(p.name)}</div>
            <div class="hp"><span style="width:${hpPct}%"></span></div>
            <div class="hp-text">HP ${p.hp}/${p.maxHp||100}</div>
            <div class="stats">공${p.stats?.attack||0} 방${p.stats?.defense||0} 민${p.stats?.agility||0} 행${p.stats?.luck||0}</div>
            <div class="items-info">${items.length?items.join(', '):'아이템 없음'}</div>
            <div class="ready-status">${readyStatus}</div>
          </div>
        </div>`;
      });
      document.getElementById(id).innerHTML = html;
    }
    renderTeam(teamA, 'teamA');
    renderTeam(teamB, 'teamB');
  }

  function updateMyInfo() {
    if (!myPlayer) return;
    document.getElementById('myName').textContent = myPlayer.name || '전투 참가자';
    document.getElementById('myTeam').textContent = myPlayer.team || '?';
    const hpPct = Math.max(0, myPlayer.hp/(myPlayer.maxHp||100)*100);
    document.getElementById('myHpBar').style.width = hpPct + '%';
    document.getElementById('myHpText').textContent = `${myPlayer.hp}/${myPlayer.maxHp||100}`;
    document.getElementById('myStats').textContent = `공${myPlayer.stats?.attack||0} 방${myPlayer.stats?.defense||0} 민${myPlayer.stats?.agility||0} 행${myPlayer.stats?.luck||0}`;
    const items = [];
    if ((myPlayer.items?.dittany || myPlayer.items?.ditany) > 0) items.push(`디터니 ${myPlayer.items?.dittany || myPlayer.items?.ditany}`);
    if ((myPlayer.items?.attackBooster || myPlayer.items?.attack_boost) > 0) items.push(`공격보정 ${myPlayer.items?.attackBooster || myPlayer.items?.attack_boost}`);
    if ((myPlayer.items?.defenseBooster || myPlayer.items?.defense_boost) > 0) items.push(`방어보정 ${myPlayer.items?.defenseBooster || myPlayer.items?.defense_boost}`);
    document.getElementById('myItems').textContent = items.length?items.join(', '):'아이템 없음';
    if (myPlayer.avatar) document.getElementById('myPortrait').src = myPlayer.avatar;
  }

  function setActionsEnabled(enabled) {
    ['attackBtn','defendBtn','dodgeBtn','itemBtn','passBtn'].forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.disabled = !enabled;
    });
  }

  function renderCenter() {
    const turn = battle?.currentTurn || {};
    const current = turn.currentPlayer;

    // 현재 플레이어 이미지/텍스트
    const img = document.getElementById('currentPortrait');
    const info = document.getElementById('turnInfo');

    if (current && current.name) {
      info.textContent = `${current.name} 차례`;
      if (current.avatar) img.src = current.avatar;
      else { img.removeAttribute('src'); img.style.background='#000'; }
    } else {
      info.textContent = '대기 중...';
      img.removeAttribute('src'); img.style.background='#000';
    }

    const tl = turn.timeLeftSec||0;
    const mm = Math.floor(tl/60);
    const ss = String(tl%60).padStart(2,'0');
    document.getElementById('timerDisplay').textContent = `${mm}:${ss}`;
    document.getElementById('timerSeconds').textContent = `${tl}초`;

    // 내 객체 갱신
    myPlayer = (battle?.players||[]).find(p=>p.id===myPlayerId) || myPlayer;
    updateMyInfo();

    // 턴 변경 시 행동 리셋
    const turnKey = `${turn.turnNumber||0}|${turn.currentTeam||''}`;
    if (turnKey !== lastTurnKey) {
      lastTurnKey = turnKey;
      hasActedThisTurn = false;
    }

    // 버튼 활성 여부
    const isMyTurn = !!(myPlayer && current && current.id === myPlayer.id);
    const canAct = (battle?.status === 'active') && isMyTurn && !hasActedThisTurn && (myPlayer?.hp > 0);
    setActionsEnabled(canAct);
  }

  function renderAll() {
    renderCenter();
    renderTeams();
  }

  // 액션 오버레이
  const overlay = document.getElementById('actionOverlay');
  const overlayTitle = document.getElementById('actionTitle');
  const overlayTargets = document.getElementById('overlayTargets');
  let pendingAction = null;

  function openOverlay() { overlay.style.display='flex'; }
  function closeOverlay(){ overlay.style.display='none'; pendingAction=null; }

  function showActionOverlay(kind) {
    if (!battle || !myPlayer) return;
    pendingAction = kind;

    if (kind === 'defend' || kind === 'dodge' || kind === 'pass') {
      sendAction({ type: kind });
      return;
    }
    if (kind === 'item') {
      overlayTitle.textContent = '아이템 선택';
      const opts = [];
      if ((myPlayer.items?.dittany || myPlayer.items?.ditany) > 0) {
        opts.push(`<div class="target" onclick="selectItem('dittany')" style="background:var(--glass-2);border:1px solid var(--border);padding:8px;border-radius:8px;text-align:center;cursor:pointer">디터니</div>`);
      }
      if ((myPlayer.items?.attackBooster || myPlayer.items?.attack_boost) > 0) {
        opts.push(`<div class="target" onclick="selectItem('attackBooster')" style="background:var(--glass-2);border:1px solid var(--border);padding:8px;border-radius:8px;text-align:center;cursor:pointer">공격 보정기</div>`);
      }
      if ((myPlayer.items?.defenseBooster || myPlayer.items?.defense_boost) > 0) {
        opts.push(`<div class="target" onclick="selectItem('defenseBooster')" style="background:var(--glass-2);border:1px solid var(--border);padding:8px;border-radius:8px;text-align:center;cursor:pointer">방어 보정기</div>`);
      }
      overlayTargets.innerHTML = opts.length?opts.join(''):`<div class="target" style="opacity:.5;text-align:center">사용 가능한 아이템이 없습니다</div>`;
      openOverlay();
      return;
    }

    // 공격 대상
    overlayTitle.textContent = '공격 대상 선택';
    const enemies = (battle.players||[]).filter(p=>p.team!==myPlayer.team && p.hp>0);
    overlayTargets.innerHTML = enemies.map(t=>`
      <div class="target" onclick="selectTarget('${t.id}')" style="background:var(--glass-2);border:1px solid var(--border);padding:8px;border-radius:8px;text-align:center;cursor:pointer">
        <img src="${t.avatar||''}" style="width:40px;height:40px;border-radius:6px;object-fit:cover;background:#000" onerror="this.style.background='#000';this.removeAttribute('src')">
        <div style="margin-top:4px">${esc(t.name)}</div>
      </div>
    `).join('');
    openOverlay();
  }

  function selectItem(item) {
    pendingAction = { type:'item', item };
    // 타겟 요구
    const allies = (battle.players||[]).filter(p=>p.team===myPlayer.team && p.hp>0);
    overlayTitle.textContent = item==='attackBooster' ? '강화 공격 대상 선택' :
                               item==='defenseBooster' ? '방어 보정 대상 선택' : '치료 대상 선택';
    overlayTargets.innerHTML = allies.map(t=>`
      <div class="target" onclick="selectTarget('${t.id}')" style="background:var(--glass-2);border:1px solid var(--border);padding:8px;border-radius:8px;text-align:center;cursor:pointer">
        <img src="${t.avatar||''}" style="width:40px;height:40px;border-radius:6px;object-fit:cover;background:#000" onerror="this.style.background='#000';this.removeAttribute('src')">
        <div style="margin-top:4px">${esc(t.name)}</div>
      </div>
    `).join('');
  }

  function selectTarget(targetId) {
    if (!pendingAction) return;
    if (typeof pendingAction === 'string') {
      if (pendingAction === 'attack') {
        sendAction({ type:'attack', targetId });
      }
    } else if (pendingAction.type === 'item') {
      sendAction({ type:'item', item: pendingAction.item, targetId });
    }
    closeOverlay();
  }

  function sendAction(action) {
    if (!battle || !myPlayer) return;
    setActionsEnabled(false);
    socket.emit('player:action', { battleId, playerId: myPlayer.id, action }, (res)=>{
      if (!res?.ok) {
        alert('액션 실패: ' + (res?.error || '알 수 없는 오류'));
        // 실패 시 재활성화(여전히 내 턴이라면)
        renderCenter();
      }
    });
  }

  function setReady() {
    const btn = document.getElementById('readyBtn');
    if (btn.classList.contains('done')) return;
    socket.emit('player:ready', { battleId, playerId: myPlayerId }, ()=>{});
    socket.emit('chatMessage', { battleId, name: myPlayer?.name || urlName || '전투 참가자', message: '[준비 완료]' });
    btn.classList.add('done');
    btn.textContent = '준비 완료됨';
  }

  function sendChat() {
    const input = document.getElementById('chatInput');
    const msg = input.value.trim();
    if (!msg) return;
    socket.emit('chatMessage', { battleId, name: myPlayer?.name || urlName || '전투 참가자', message: msg }, ()=>{});
    input.value = '';
  }

  // 이벤트
  document.getElementById('attackBtn').addEventListener('click', ()=>showActionOverlay('attack'));
  document.getElementById('defendBtn').addEventListener('click', ()=>showActionOverlay('defend'));
  document.getElementById('dodgeBtn').addEventListener('click',  ()=>showActionOverlay('dodge'));
  document.getElementById('itemBtn').addEventListener('click',   ()=>showActionOverlay('item'));
  document.getElementById('passBtn').addEventListener('click',   ()=>showActionOverlay('pass'));
  document.getElementById('cancelAction').addEventListener('click', closeOverlay);

  document.getElementById('chatSend').addEventListener('click', sendChat);
  document.getElementById('chatInput').addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ e.preventDefault(); sendChat(); } });
  document.getElementById('readyBtn').addEventListener('click', setReady);

  // 전역 노출(오버레이 선택)
  window.selectTarget = selectTarget;
  window.selectItem   = selectItem;

  // 소켓
  socket.on('connect', ()=>{ socket.emit('join', { battleId }); });

  // 인증: 서버가 player 객체 전체를 안 보낼 수도 있어 id만 사용
  socket.emit('playerAuth', { battleId, token }, (res)=>{
    if (!res?.ok) { alert('인증 실패'); return; }
    myPlayerId = res.playerId || res.player?.id || null;
  });
  socket.on('authSuccess', (d)=>{ myPlayerId = d.playerId || d.player?.id || myPlayerId; });
  socket.on('auth:success', (d)=>{ myPlayerId = d.playerId || d.player?.id || myPlayerId; });

  const onSnap = (snap)=>{ battle = snap; renderAll(); };
  socket.on('battle:update', onSnap); // 중복 방지: 하나만
  socket.on('battle:log', addLog);
  socket.on('chatMessage', addChat);

  socket.on('actionSuccess', ()=>{ hasActedThisTurn = true; setActionsEnabled(false); });
  socket.on('player:action:success', ()=>{ hasActedThisTurn = true; setActionsEnabled(false); });
})();
</script>
</body>
</html>
