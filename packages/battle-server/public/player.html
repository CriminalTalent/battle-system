<!-- packages/battle-server/public/player.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PYXIS - 전투 참가자</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root {
      --deep-navy: #050a12;
      --darker-navy: #0a111c;
      --dark-navy: #0f1620;
      --mid-navy: #1a2332;
      --light-navy: #252d3d;
      --gold: #DCC7A2;
      --gold-bright: #E6D2A8;
      --gold-shimmer: #F0E6C8;
      --gold-subtle: rgba(220, 199, 162, 0.15);
      --text: #F8F9FA;
      --text-accent: #E9ECEF;
      --text-muted: #8A93A3;
      --glass-1: rgba(26, 35, 50, 0.3);
      --glass-2: rgba(26, 35, 50, 0.5);
      --glass-3: rgba(26, 35, 50, 0.7);
      --border: rgba(37, 45, 61, 0.6);
      --border-light: rgba(37, 45, 61, 0.8);
      --border-subtle: rgba(37, 45, 61, 0.3);
      --border-gold: rgba(220, 199, 162, 0.4);
      --serif: 'Cinzel', serif;
      --radius: 8px;
      --radius-small: 6px;
      --transition: 0.2s ease-out;
      --blur: blur(8px);
      --success: #27AE60;
      --warning: #F39C12;
      --danger: #E74C3C;
      --info: #3498DB;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100vh; font-family: var(--serif); background: linear-gradient(135deg, var(--deep-navy) 0%, var(--darker-navy) 100%); color: var(--text); overflow: hidden; }
    .header { background: var(--glass-3); backdrop-filter: var(--blur); border-bottom: 1px solid var(--border-light); padding: 8px 0; position: sticky; top: 0; z-index: 100; }
    .header-content { text-align: center; max-width: 1200px; margin: 0 auto; padding: 0 12px; }
    .title-main { font-size: 20px; font-weight: 800; color: var(--gold-bright); letter-spacing: 1px; margin: 0; }
    .title-sub { font-size: 10px; color: var(--text-muted); margin-top: -2px; }
    .auth-container { display: flex; align-items: center; justify-content: center; height: calc(100vh - 60px); padding: 20px; }
    .auth-card { background: var(--glass-2); backdrop-filter: var(--blur); border: 1px solid var(--border-gold); border-radius: var(--radius); padding: 24px; max-width: 380px; width: 100%; text-align: center; }
    .auth-title { font-size: 16px; font-weight: 600; color: var(--gold-bright); margin-bottom: 16px; }
    .form-group { margin-bottom: 12px; text-align: left; }
    .label { display: block; font-size: 11px; font-weight: 600; color: var(--text-accent); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
    input[type="text"], input[type="password"] {
      width: 100%; background: var(--glass-1); border: 1px solid var(--border); border-radius: var(--radius-small);
      padding: 8px 12px; color: var(--text); font-size: 12px; font-family: var(--serif); transition: all var(--transition);
    }
    input:focus { outline: none; border-color: var(--gold); box-shadow: 0 0 0 2px rgba(220, 199, 162, 0.2); }
    .btn { background: linear-gradient(135deg, var(--gold), var(--gold-bright)); color: var(--deep-navy); border: none; border-radius: var(--radius-small);
      padding: 8px 16px; font-family: var(--serif); font-size: 12px; font-weight: 600; cursor: pointer; transition: all var(--transition);
      text-transform: uppercase; letter-spacing: 0.5px; margin-top: 8px;
    }
    .btn:hover { background: linear-gradient(135deg, var(--gold-bright), var(--gold-shimmer)); transform: translateY(-1px); }
    .game-container { display: none; height: calc(100vh - 60px); max-width: 1200px; margin: 0 auto; padding: 8px; grid-template-columns: 200px 1fr 250px; grid-template-rows: 1fr 230px; gap: 8px; }
    .game-container.active { display: grid; }
    .team-panel, .action-panel, .player-info, .chat-panel, .turn-visual { background: var(--glass-2); backdrop-filter: var(--blur); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; }
    .hidden { display: none !important; }
    .show { display: block !important; }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <h1 class="title-main">PYXIS</h1>
      <div class="title-sub">전투 시스템</div>
    </div>
  </div>

  <!-- 인증 페이지 -->
  <div id="authPage" class="auth-container">
    <div class="auth-card">
      <div class="auth-title">전투 참가자 인증</div>
      <div class="form-group">
        <label class="label">초대 링크 붙여넣기 (선택)</label>
        <input type="text" id="inviteUrl" placeholder="관리자가 준 참가자 링크를 붙여넣으세요">
      </div>
      <form id="authForm">
        <div class="form-group">
          <label class="label">전투 참가자명</label>
          <input type="text" id="playerName" placeholder="이름을 입력하세요" required>
        </div>
        <div class="form-group">
          <label class="label">비밀번호</label>
          <input type="password" id="playerOtp" placeholder="비밀번호를 입력하세요" required>
        </div>
        <div class="actions">
          <button type="submit" class="btn">전투 참가</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 메인 게임 페이지 (축약 표시, 실제로는 기존 UI 계속 유지) -->
  <div id="gamePage" class="game-container">
    <div>게임 UI</div>
  </div>

  <script>
    const socket = io({ path: '/socket.io' });
    const state = { battleId: null, authenticated: false, playerData: null };

    const authPage = document.getElementById('authPage');
    const gamePage = document.getElementById('gamePage');
    const authForm = document.getElementById('authForm');
    const inviteUrlInput = document.getElementById('inviteUrl');
    const playerNameInput = document.getElementById('playerName');
    const playerOtpInput = document.getElementById('playerOtp');

    function addLogEntry(msg) { console.log("[LOG]", msg); }

    // === 초대 링크 파싱 + 자동 인증 ===
    function parseParamsFrom(urlLike) {
      try {
        const url = new URL(urlLike, window.location.origin);
        const params = new URLSearchParams(url.search);
        return {
          battle: params.get('battle') || params.get('battleId'),
          player: params.get('name') || params.get('player'),
          token: params.get('otp') || params.get('token') || params.get('password')
        };
      } catch { return {}; }
    }

    function autoAuthenticate() {
      const playerName = playerNameInput.value.trim();
      const otp = playerOtpInput.value.trim();
      const battleId = state.battleId;
      if (!battleId || !playerName || !otp) return;
      const payload = { battleId, playerName, otp, token: otp, password: otp };
      socket.emit('playerAuth', payload);
      socket.emit('auth:player', payload);
      addLogEntry("자동 인증 시도");
    }

    function checkAutoAuthFromLocation() {
      const p = new URLSearchParams(window.location.search);
      state.battleId = p.get('battle') || p.get('battleId');
      const player = p.get('name') || p.get('player');
      const token  = p.get('otp') || p.get('token') || p.get('password');
      if (player) playerNameInput.value = player;
      if (token)  playerOtpInput.value = token;
      if (state.battleId && player && token) autoAuthenticate();
    }

    inviteUrlInput.addEventListener('change', () => {
      const raw = inviteUrlInput.value.trim();
      if (!raw) return;
      const parsed = parseParamsFrom(raw);
      state.battleId = parsed.battle;
      if (parsed.player) playerNameInput.value = parsed.player;
      if (parsed.token)  playerOtpInput.value = parsed.token;
      if (parsed.battle && parsed.player && parsed.token) autoAuthenticate();
    });

    authForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const playerName = playerNameInput.value.trim();
      const otp = playerOtpInput.value.trim();
      if (!state.battleId || !playerName || !otp) return alert("필수값 누락");
      const payload = { battleId: state.battleId, playerName, otp, token: otp, password: otp };
      socket.emit('playerAuth', payload);
      socket.emit('auth:player', payload);
      addLogEntry("수동 인증 시도");
    });

    socket.on('connect', () => { addLogEntry("서버 연결"); checkAutoAuthFromLocation(); });
    socket.on('authResult', (d)=>{ if(d.success){ authPage.classList.add('hidden'); gamePage.classList.add('active'); addLogEntry("인증 성공"); } });
    socket.on('auth:result', (d)=>{ if(d.success){ authPage.classList.add('hidden'); gamePage.classList.add('active'); addLogEntry("인증 성공"); } });

    window.addEventListener('load', checkAutoAuthFromLocation);
  </script>
</body>
</html>
