<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>PYXIS - 전투 참가자</title>
<script src="/socket.io/socket.io.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#0e0e0e; --bg2:#141414;
    --glass-1:rgba(255,255,255,.06); --glass-2:rgba(255,255,255,.10);
    --border:rgba(255,255,255,.14);
    --text:#F8F9FA; --muted:#A9AFB6;
    --gold:#DCC7A2; --gold2:#E6D2A8;
    --radius:14px;
    --shadow:0 8px 24px rgba(0,0,0,.35);
    --serif:"Cinzel",serif;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{min-height:100vh;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--text);font-family:var(--serif)}
  /* 3열: 내정보/중앙/오른쪽(상대 + 로그/채팅) */
  .wrap{
    max-width:1400px;margin:0 auto;padding:18px;
    display:grid;grid-template-columns:1fr 520px 1fr;gap:14px;align-items:start;
  }
  @media (max-width:1200px){.wrap{grid-template-columns:1fr;gap:12px}}
  .card{background:var(--glass-2);border:1px solid var(--border);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
  .title{font-weight:700;color:var(--gold2);border-bottom:1px solid var(--border);padding-bottom:10px;margin-bottom:10px}
  .badge{display:inline-block;border:1px solid var(--border);padding:4px 8px;border-radius:10px;background:var(--glass-1);font-size:12px}
  .bar{height:10px;background:rgba(255,255,255,.10);border:1px solid var(--border);border-radius:999px;overflow:hidden}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,#b58d52,#e6d2a8)}
  .btn{display:inline-block;padding:10px 12px;border-radius:10px;border:2px solid var(--gold);color:var(--gold);background:transparent;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  /* 내 정보 */
  .me{display:flex;gap:12px;align-items:center}
  #meAvatar{width:64px;height:64px;border-radius:12px;border:1px solid var(--border);object-fit:cover;background:#0b0b0b}
  .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
  .kv{display:flex;justify-content:space-between;border:1px solid var(--border);border-radius:10px;padding:8px}
  .k{color:#c7af7b}
  .v{color:#e6d2a8}
  /* 팀 리스트 행 */
  .mini{display:flex;gap:10px;align-items:center;border:1px solid var(--border);border-radius:10px;padding:8px}
  .mini img{width:38px;height:38px;border-radius:8px;object-fit:cover;background:#0b0b0b;border:1px solid var(--border)}
  .mini .box{flex:1}
  .mini .nm{font-size:12px}
  .mini .hp{height:8px;border-radius:6px;background:rgba(255,255,255,.12);border:1px solid var(--border);overflow:hidden;margin-top:4px}
  .mini .hp span{display:block;height:100%;background:linear-gradient(90deg,#b58d52,#e6d2a8)}

  /* 가운데: 현재 턴 + 액션 */
  .portrait{width:100%;aspect-ratio:1/1;border-radius:14px;border:1px solid var(--border);object-fit:cover;background:#0b0b0b;margin-bottom:10px}
  .meta{display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
  .pill{font-size:12px;border:1px solid var(--border);background:var(--glass-1);padding:6px 10px;border-radius:999px}
  .actions{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
  .act{padding:12px;border-radius:10px;border:2px solid transparent;background:var(--glass-1);cursor:pointer;text-align:center;color:#ddd}
  .act.enabled{border-color:#c7af7b;color:#e6d2a8;font-weight:700}
  .act:disabled{opacity:.45;cursor:not-allowed}

  /* 오른쪽 아래: 로그 + 채팅 (위/아래) */
  .log{height:220px;overflow:auto;background:var(--glass-1);border:1px solid var(--border);border-radius:10px;padding:10px}
  .entry{font-size:12px;margin-bottom:6px}
  .entry .t{color:#A9AFB6;margin-right:6px;font-size:10px}
  .entry.rule{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#111;border-radius:8px;padding:8px}
  .chatView{height:160px;overflow:auto;background:var(--glass-1);border:1px solid var(--border);border-radius:10px;padding:10px}
  .chatRow{display:flex;gap:8px;margin-top:8px}
  .chatRow input{flex:1;background:#0d0d0d;border:1px solid var(--border);border-radius:10px;padding:10px;color:#eee}
  .chatRow button{min-width:80px}
  /* 오버레이 */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center}
  .ov-card{width:min(520px,92vw);background:#111;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:14px}
  .ov-title{font-weight:700;color:var(--gold2);border-bottom:1px solid var(--border);padding-bottom:10px;margin-bottom:10px}
  .ov-actions{display:flex;gap:8px;margin-top:10px}
  .ov-t{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .ov-mini{display:flex;gap:8px;align-items:center;border:1px solid var(--border);border-radius:10px;padding:8px}
  .ov-mini img{width:36px;height:36px;border-radius:8px;border:1px solid var(--border);object-fit:cover;background:#0b0b0b}
  .ov-mini .nm{font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <!-- 왼: 내 정보 + 내 팀 -->
  <section class="card">
    <div class="title">전투 참가자(나)</div>
    <div class="me">
      <img id="meAvatar" alt="내 초상화">
      <div>
        <div id="meName" style="font-weight:700">-</div>
        <div class="badge" id="meTeam">-</div>
        <div class="bar"><span id="meHpBar" style="width:100%"></span></div>
        <div class="badge" id="meHpText">HP 100/100</div>
      </div>
    </div>
    <div class="stats" style="margin-top:12px">
      <div class="kv"><div class="k">공격</div><div id="sAtk" class="v">-</div></div>
      <div class="kv"><div class="k">방어</div><div id="sDef" class="v">-</div></div>
      <div class="kv"><div class="k">민첩</div><div id="sAgi" class="v">-</div></div>
      <div class="kv"><div class="k">행운</div><div id="sLuck" class="v">-</div></div>
    </div>

    <div style="margin-top:10px">
      <button id="btnReady" class="btn">준비 완료</button>
    </div>

    <div class="title" style="border:none;margin:14px 0 8px;color:#e6d2a8">내 팀</div>
    <div id="allyList"></div>
  </section>

  <!-- 중: 현재 턴 + 액션 -->
  <section class="card">
    <img id="turnPortrait" class="portrait" alt="현재 차례 초상화"/>
    <div class="meta">
      <div class="pill">라운드 <span id="round">1</span></div>
      <div class="pill"><span id="turnTeam">-팀</span> 차례</div>
      <div class="pill">남은 시간 <span id="turnTimer">--:--</span></div>
    </div>
    <div class="actions">
      <button id="btnAttack" class="act" disabled>공격</button>
      <button id="btnDefend" class="act" disabled>방어</button>
      <button id="btnDodge"  class="act" disabled>회피</button>
      <button id="btnItem"   class="act" disabled>아이템</button>
      <button id="btnPass"   class="act" disabled>패스</button>
    </div>
  </section>

  <!-- 우: 상대 팀 + (아래) 로그/채팅 -->
  <section class="card">
    <div class="title">상대 팀</div>
    <div id="enemyList"></div>

    <div class="title" style="margin-top:12px">실시간 로그</div>
    <div id="log" class="log"></div>

    <div class="title" style="margin-top:12px">채팅</div>
    <div id="chatView" class="chatView"></div>
    <div class="chatRow">
      <input id="chatMsg" type="text" maxlength="140" placeholder="메시지 입력"/>
      <button id="btnSend" class="btn">전송</button>
    </div>
  </section>
</div>

<!-- 타깃 선택 오버레이 -->
<div id="overlay" class="overlay" role="dialog" aria-modal="true">
  <div class="ov-card">
    <div class="ov-title">공격 대상 선택</div>
    <div id="targetList" class="ov-t"></div>
    <div class="ov-actions">
      <button id="btnCancelTarget" class="btn" style="flex:1;background:#222;color:#ddd;border-color:#444">취소</button>
    </div>
  </div>
</div>

<script>
  // 유틸
  function $(sel,root=document){ return root.querySelector(sel); }
  function $all(sel,root=document){ return Array.from(root.querySelectorAll(sel)); }
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[c])); }
  function fmtTs(ts){ const d=new Date(ts||Date.now()); return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }
  function setImg(img,url){ img.src=url||'/uploads/avatars/default.svg'; img.onerror=()=>{ img.onerror=null; img.src='/uploads/avatars/default.svg'; }; }

  // 엘리먼트
  const meAvatar=$('#meAvatar'), meNameEl=$('#meName'), meTeamEl=$('#meTeam'), meHpBar=$('#meHpBar'), meHpText=$('#meHpText');
  const sAtk=$('#sAtk'), sDef=$('#sDef'), sAgi=$('#sAgi'), sLuck=$('#sLuck');
  const roundEl=$('#round'), turnTeamEl=$('#turnTeam'), turnTimerEl=$('#turnTimer'), turnPortrait=$('#turnPortrait');

  const btnReady=$('#btnReady');
  const btnAttack=$('#btnAttack'), btnDefend=$('#btnDefend'), btnDodge=$('#btnDodge'), btnItem=$('#btnItem'), btnPass=$('#btnPass');
  const allyList=$('#allyList'), enemyList=$('#enemyList');
  const logEl=$('#log'), chatView=$('#chatView'), chatMsg=$('#chatMsg'), btnSend=$('#btnSend');

  const overlay=$('#overlay'), targetList=$('#targetList'), btnCancelTarget=$('#btnCancelTarget');

  function addLog(msg, cls=''){
    const div=document.createElement('div');
    div.className='entry'+(cls?(' '+cls):'');
    div.innerHTML=`<span class="t">${fmtTs(Date.now())}</span>${escapeHtml(msg)}`;
    logEl.appendChild(div);
    logEl.scrollTop=logEl.scrollHeight;
  }

  // 상태
  let socket=null, battleId=null, me=null, myTeam='A', snapshot=null, currentPlayerId=null;

  function renderMe(){
    if(!me) return;
    myTeam = me.team || myTeam;
    meNameEl.textContent = me.name||'-';
    meTeamEl.textContent = myTeam + '팀';
    const ratio = Math.max(0, Math.min(100, Math.round((me.hp||0)/(me.maxHp||100)*100)));
    meHpBar.style.width = ratio+'%';
    meHpText.textContent = `HP ${me.hp||0}/${me.maxHp||100}`;
    sAtk.textContent=me.stats?.attack ?? '-';
    sDef.textContent=me.stats?.defense ?? '-';
    sAgi.textContent=me.stats?.agility ?? '-';
    sLuck.textContent=me.stats?.luck ?? '-';
    setImg(meAvatar, me.avatar);
  }

  function renderTeams(){
    if(!snapshot) return;
    const my=[], opp=[];
    (snapshot.players||[]).forEach(p=>{
      const row=document.createElement('div'); row.className='mini';
      const img=document.createElement('img'); setImg(img,p.avatar);
      const box=document.createElement('div'); box.className='box';
      const hpRatio = Math.max(0, Math.min(100, Math.round((p.hp||0)/(p.maxHp||100)*100)));
      box.innerHTML=`<div class="nm">${escapeHtml(p.name||'-')}</div>
                     <div class="hp"><span style="width:${hpRatio}%"></span></div>
                     <div style="font-size:11px;color:var(--muted);margin-top:2px">공 ${p.stats?.attack ?? '-'} / 방 ${p.stats?.defense ?? '-'} / 민 ${p.stats?.agility ?? '-'} / 행 ${p.stats?.luck ?? '-'}</div>`;
      row.appendChild(img); row.appendChild(box);
      (p.team===myTeam?my:opp).push(row);
    });
    allyList.innerHTML=''; enemyList.innerHTML='';
    my.forEach(n=>allyList.appendChild(n));
    opp.forEach(n=>enemyList.appendChild(n));
  }

  function updateActionButtons(){
    const CT = snapshot?.currentTurn;
    let enabled = false;
    if (CT?.currentPlayerId) {
      enabled = (CT.currentPlayerId===me?.id);
    } else if (CT?.currentTeam) {
      enabled = (CT.currentTeam===me?.team);
    }
    [btnAttack,btnDefend,btnDodge,btnItem,btnPass].forEach(b=>{
      b.disabled = !enabled;
      b.classList.toggle('enabled', enabled);
    });
  }

  function onBattleUpdate(b){
    snapshot = b;
    if (!me && b.players) {
      const m = b.players.find(x=>x.id===currentPlayerId) || null;
      if (m) me = m;
    }
    renderMe();
    renderTeams();
    roundEl.textContent = b.currentTurn?.turnNumber ?? '-';
    turnTeamEl.textContent = (b.currentTurn?.currentTeam||'-')+'팀';
    const curP = b.currentTurn?.currentPlayer || null;
    setImg(turnPortrait, curP?.avatar);
    updateActionButtons();
  }

  function onBattleLog(entry){
    const txt = entry?.message || '';
    const type = entry?.type || 'info';
    const isRule = type==='battle'; // 규칙 중계 강조
    addLog(txt, isRule?'rule':'');
  }

  function onChat(msg){
    const div=document.createElement('div');
    div.className='entry';
    div.innerHTML=`<span class="t">${fmtTs(Date.now())}</span>${escapeHtml(msg.name||'관람자')}: ${escapeHtml(msg.message||'')}`;
    chatView.appendChild(div);
    chatView.scrollTop=chatView.scrollHeight;
  }

  function bindSocket(){
    const urlParams=new URLSearchParams(location.search);
    battleId=urlParams.get('battle')||'';
    const token=urlParams.get('token')||'';
    const playerName=urlParams.get('name')||'';
    socket=io({ path:'/socket.io' });

    socket.on('connect', ()=>{
      if(battleId) socket.emit('join',{battleId});
      // 자동 로그인
      socket.emit('playerAuth',{ battleId, token, playerName });
    });

    // 인증 결과 (호환)
    socket.on('authSuccess', (p)=>{ currentPlayerId = p?.playerId; me={ id:p.playerId,name:p.name,team:p.team, hp:100,maxHp:100, stats:{} }; renderMe(); });
    socket.on('auth:success', (p)=>{ currentPlayerId = p?.playerId; me={ id:p.playerId,name:p.name,team:p.team, hp:100,maxHp:100, stats:{} }; renderMe(); });
    socket.on('authError', (e)=> addLog('인증 실패: '+(e?.error||'오류'),'err'));

    // 스냅샷(호환)
    socket.on('battleUpdate', onBattleUpdate);
    socket.on('battle:update', onBattleUpdate);

    // 로그(호환)
    socket.on('battle:log', onBattleLog);
    socket.on('battleLog', onBattleLog);

    // 채팅(호환 수신)
    socket.on('chatMessage', onChat);
    socket.on('battle:chat', onChat);

    // 준비 완료
    btnReady.addEventListener('click', ()=>{
      btnReady.disabled = true;
      btnReady.style.opacity = '.5';
      socket.emit('player:ready');
    });

    // 채팅 전송
    btnSend.addEventListener('click', ()=>{
      const m = String(chatMsg.value||'').trim();
      if(!m) return;
      socket.emit('chatMessage',{ name: me?.name||'전투 참가자', message:m });
      chatMsg.value='';
    });
    chatMsg.addEventListener('keydown', (e)=>{ if(e.key==='Enter') btnSend.click(); });

    // 액션
    function openTargetOverlay(){
      if(!snapshot) return;
      overlay.style.display='flex';
      targetList.innerHTML='';
      (snapshot.players||[]).filter(p=>p.team!==me?.team && p.hp>0).forEach(p=>{
        const r=document.createElement('div'); r.className='ov-mini';
        const img=document.createElement('img'); setImg(img,p.avatar);
        const box=document.createElement('div');
        const hpRatio = Math.max(0, Math.min(100, Math.round((p.hp||0)/(p.maxHp||100)*100)));
        box.innerHTML=`<div class="nm">${escapeHtml(p.name||'-')}</div>
                       <div class="bar" style="margin-top:4px"><span style="width:${hpRatio}%"></span></div>`;
        r.appendChild(img); r.appendChild(box);
        r.addEventListener('click', ()=>{ overlay.style.display='none'; sendAction('attack', p.id); });
        targetList.appendChild(r);
      });
    }
    btnCancelTarget.addEventListener('click', ()=> overlay.style.display='none');

    function sendAction(type, targetId=null){
      if(!battleId || !me?.id) return;
      socket.emit('player:action', { type, targetId });
    }
    btnAttack.addEventListener('click', ()=> openTargetOverlay());
    btnDefend.addEventListener('click', ()=> sendAction('defend'));
    btnDodge .addEventListener('click', ()=> sendAction('dodge'));
    btnItem  .addEventListener('click', ()=> sendAction('item'));
    btnPass  .addEventListener('click', ()=> sendAction('pass'));
  }

  document.addEventListener('DOMContentLoaded', bindSocket);
</script>
</body>
</html>
