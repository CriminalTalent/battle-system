<!-- packages/battle-server/public/player.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PYXIS - 전투 참가자</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root{
      --deep:#050a12;--deep2:#0a111c;--glass1:rgba(26,35,50,.3);--glass2:rgba(26,35,50,.5);
      --border:rgba(37,45,61,.6);--gold:#dcc7a2;--gold2:#e6d2a8;--txt:#f8f9fa;--muted:#8a93a3;
      --r:10px
    }
    *{box-sizing:border-box} html,body{height:100%;margin:0;font-family:'Cinzel',serif;background:linear-gradient(135deg,var(--deep),var(--deep2));color:var(--txt)}
    .header{position:sticky;top:0;z-index:5;background:rgba(0,0,0,.25);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.06)}
    .header .wrap{max-width:1200px;margin:0 auto;padding:10px 14px;text-align:center}
    .header h1{margin:0;color:var(--gold2);letter-spacing:1px}
    .header small{color:var(--muted)}
    .auth{height:calc(100vh - 56px);display:flex;align-items:center;justify-content:center;padding:16px}
    .card{width:100%;max-width:420px;background:var(--glass2);border:1px solid rgba(220,199,162,.35);border-radius:var(--r);padding:20px}
    .card h2{margin:0 0 12px;color:var(--gold2);font-size:18px}
    .fg{margin-bottom:10px}
    .fg label{display:block;font-size:11px;color:#d3d7df;margin-bottom:4px}
    input[type=text],input[type=password]{width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:var(--glass1);color:var(--txt)}
    .btn{display:inline-block;margin-top:8px;background:linear-gradient(135deg,var(--gold),var(--gold2));color:#0d1117;border:0;border-radius:8px;padding:10px 14px;font-weight:700;cursor:pointer}
    .hidden{display:none!important}
    .game{display:none;max-width:1200px;margin:16px auto;padding:8px;color:#ddd}
    .game.active{display:block}
    .log{font-size:12px;opacity:.75;margin-top:8px;white-space:pre-line}
  </style>
</head>
<body>
  <div class="header">
    <div class="wrap">
      <h1>PYXIS</h1>
      <small>전투 시스템</small>
    </div>
  </div>

  <!-- 인증 화면 -->
  <section id="authPage" class="auth">
    <div class="card">
      <h2>전투 참가자 인증</h2>
      <div class="fg">
        <label>초대 링크 붙여넣기 (선택)</label>
        <input type="text" id="inviteUrl" placeholder="관리자가 준 참가자 링크를 붙여넣으세요" />
      </div>

      <form id="authForm" autocomplete="off">
        <div class="fg">
          <label>전투 참가자명</label>
          <input type="text" id="playerName" placeholder="이름을 입력하세요" required autocomplete="username"/>
        </div>
        <div class="fg">
          <label>비밀번호</label>
          <input type="password" id="playerOtp" placeholder="비밀번호를 입력하세요" required autocomplete="current-password"/>
        </div>
        <button type="submit" class="btn">전투 참가</button>
      </form>

      <div class="log" id="localLog"></div>
    </div>
  </section>

  <!-- 게임 화면 (UI는 서버 이벤트 성공시 표시) -->
  <section id="gamePage" class="game">
    <h2>게임에 입장했습니다.</h2>
    <div>서버 스냅샷을 기다리는 중...</div>
  </section>

<script>
/* ================== 유틸 로그 ================== */
const logEl = document.getElementById('localLog');
const L = (...a)=>{ console.log('[LOG]', ...a); logEl.textContent = ([...a].map(v => typeof v==='object'? JSON.stringify(v):String(v)).join(' ')) + '\n' + (logEl.textContent||''); };

/* ================== 상태/DOM ================== */
const socket = io({ path: '/socket.io' }); // nginx 위치와 동일
const state = {
  battleId: null, playerId: null, playerName: null, otp: null,
  authed: false, joined: false
};
const authPage = document.getElementById('authPage');
const gamePage = document.getElementById('gamePage');
const inviteUrlInput = document.getElementById('inviteUrl');
const playerNameInput = document.getElementById('playerName');
const playerOtpInput = document.getElementById('playerOtp');

/* ================== 파라미터 파싱 ================== */
function readQueryAll() {
  // search + hash(?...) 모두 지원
  const all = new URLSearchParams(location.search);
  if (location.hash.includes('?')) {
    for (const [k, v] of new URLSearchParams(location.hash.split('?')[1]).entries()) {
      if (!all.has(k)) all.set(k, v);
    }
  }
  const q = (k)=> all.get(k);
  return {
    battle: q('battle') || q('battleId') || q('b'),
    name: q('name') || q('player') || q('user'),
    token: q('token') || q('otp') || q('password') || q('pwd'),
    playerId: q('playerId') || q('pid')
  };
}
function applyParsedToInputs(p) {
  if (p.name)  playerNameInput.value = p.name;
  if (p.token) playerOtpInput.value  = p.token;
  if (p.battle) state.battleId = p.battle;
  if (p.playerId) state.playerId = p.playerId;
}

/* ================== 조인 → 인증 순서 ================== */
function ensureJoinThenAuth() {
  if (!state.battleId) { L('전투 ID 없음 – 초대 링크가 필요합니다.'); return; }
  // 1) join 먼저
  if (!state.joined) {
    L('전투방 조인 시도:', state.battleId);
    socket.emit('join', { battleId: state.battleId });   // 서버가 사용하는 표준 이벤트
    // 일부 서버는 다른 별칭도 받으므로 함께 전송
    socket.emit('battle:join', { battleId: state.battleId });
  }
  // 2) 인증
  const name = playerNameInput.value.trim();
  const otp  = playerOtpInput.value.trim();
  if (!name || !otp) return;
  state.playerName = name;
  state.otp = otp;

  // 서버 구현별 키를 모두 채워 보냄
  const payload = {
    battleId: state.battleId,
    playerName: name,
    otp: otp,
    token: otp,
    password: otp,
    passcode: otp,
    playerId: state.playerId || undefined
  };
  L('자동/수동 인증 시도', payload);
  socket.emit('playerAuth', payload);
  socket.emit('auth:player', payload);
}

/* ================== 이벤트 바인딩 ================== */
socket.on('connect', () => {
  L('서버 연결');
  // URL에서 자동 세팅 후 즉시 시도
  const parsed = readQueryAll();
  applyParsedToInputs(parsed);
  ensureJoinThenAuth();
});

socket.on('disconnect', () => L('서버 연결 끊김. 자동 재연결 대기.'));

socket.on('joined', (d)=>{  // 서버가 이 이벤트명을 쓰는 경우
  if (d?.battleId === state.battleId) { state.joined = true; L('전투방 조인 완료'); ensureJoinThenAuth(); }
});
socket.on('battle:joined', (d)=>{ if (d?.battleId === state.battleId) { state.joined = true; L('전투방 조인 완료'); ensureJoinThenAuth(); }});
socket.on('joinOk', (d)=>{ if (d?.battleId === state.battleId) { state.joined = true; L('전투방 조인 완료'); }});
socket.on('joinResult', (d)=>{ if (d?.success) { state.joined = true; L('전투방 조인 완료'); ensureJoinThenAuth(); }});

/* ---- 인증 결과(양쪽 네임스페이스 모두 수신) ---- */
function onAuthOK(d){
  state.authed = true;
  L('인증 성공');
  authPage.classList.add('hidden');
  gamePage.classList.add('active');
}
function onAuthFail(d){
  const msg = d?.message || '인증 실패';
  L('인증 실패:', msg);
  // 실패 시에도 조인 누락 때문에 그럴 수 있으니 재시도
  setTimeout(ensureJoinThenAuth, 400);
}
socket.on('authResult', (d)=> d?.success ? onAuthOK(d) : onAuthFail(d));
socket.on('auth:result', (d)=> d?.success ? onAuthOK(d) : onAuthFail(d));
socket.on('authFailed', onAuthFail);
socket.on('auth:error', onAuthFail);

/* ---- 관리자가 주는 다양한 스냅샷 이벤트 호환 ---- */
socket.on('battleUpdate', (d)=>{ if (d?.id || d?.battleId) state.battleId = state.battleId || d.id || d.battleId; });
socket.on('battle:update', (d)=>{ if (d?.id || d?.battleId) state.battleId = state.battleId || d.id || d.battleId; });

/* ================== 폼/입력 핸들러 ================== */
document.getElementById('authForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  if (!state.battleId) { alert('전투 ID가 없습니다. 초대 링크로 접속하거나 붙여넣어 주세요.'); return; }
  ensureJoinThenAuth();
});

inviteUrlInput.addEventListener('change', ()=>{
  const raw = inviteUrlInput.value.trim();
  if (!raw) return;
  try{
    const u = new URL(raw, location.origin);
    const params = new URLSearchParams(u.search);
    const p = {
      battle: params.get('battle')||params.get('battleId'),
      name: params.get('name')||params.get('player'),
      token: params.get('token')||params.get('otp')||params.get('password'),
      playerId: params.get('playerId')
    };
    applyParsedToInputs(p);
    ensureJoinThenAuth();
  }catch{ L('잘못된 링크 형식'); }
});

/* ================== 최초 로드에서도 1회 보장 ================== */
window.addEventListener('DOMContentLoaded', ()=>{
  const p = readQueryAll();
  applyParsedToInputs(p);
  // 소켓이 아직 연결 전일 수 있으니 약간 늦춰 재시도
  setTimeout(()=> ensureJoinThenAuth(), 300);
});
</script>
</body>
</html>
