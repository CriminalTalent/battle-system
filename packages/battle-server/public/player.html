<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PYXIS - 전투 참가자</title>
  <script src="/socket.io/socket.io.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --deep-navy: #0A0F1A;
      --dark-blue: #0C1221;
      --mid-blue: #1E2A47;
      --light-blue: #3D5A80;
      --gold: #DCC7A2;
      --gold-bright: #E6D2A8;
      --gold-shimmer: #F0E6C8;
      --text: #F8F9FA;
      --text-accent: #E9ECEF;
      --text-muted: #ADB5BD;
      --glass-1: rgba(30, 42, 71, 0.3);
      --glass-2: rgba(30, 42, 71, 0.5);
      --border: rgba(61, 90, 128, 0.4);
      --border-light: rgba(61, 90, 128, 0.6);
      --blur-light: blur(10px);
      --transition-fast: 0.2s ease-out;
      --radius: 12px;
      --shadow-soft: 0 4px 6px rgba(0, 0, 0, 0.1);
      --shadow-medium: 0 8px 15px rgba(0, 0, 0, 0.2);
      --shadow-glow: 0 0 20px rgba(212, 183, 126, 0.2);
      --serif: 'Cinzel', serif;
      --success: #27AE60;
      --danger: #E74C3C;
      --warning: #F39C12;
      --info: #3498DB;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      font-family: var(--serif);
      background: linear-gradient(135deg, var(--deep-navy) 0%, var(--dark-blue) 100%);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* 헤더 */
    .header {
      background: var(--glass-2);
      backdrop-filter: var(--blur-light);
      border-bottom: 1px solid var(--border-light);
      padding: 16px 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-soft);
    }

    .header-inner {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .brand .logo {
      font-size: 28px;
      font-weight: 800;
      color: var(--gold-bright);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      letter-spacing: 2px;
    }

    .brand .subtitle {
      font-size: 12px;
      color: var(--text-muted);
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* 메인 컨테이너 */
    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      display: grid;
      grid-template-areas: 
        "my-info turn-area enemy-info"
        "my-info turn-area logs"
        "actions actions chat";
      grid-template-columns: 280px 1fr 280px;
      grid-template-rows: auto 1fr 120px;
      gap: 20px;
      min-height: calc(100vh - 100px);
    }

    @media (max-width: 1200px) {
      .main-container {
        grid-template-areas: 
          "my-info"
          "turn-area"
          "enemy-info" 
          "actions"
          "logs"
          "chat";
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto auto 200px 120px;
        gap: 16px;
      }
    }

    /* 카드 공통 */
    .card {
      background: var(--glass-2);
      backdrop-filter: var(--blur-light);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow-soft);
      transition: all var(--transition-fast);
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--gold-bright);
      margin-bottom: 16px;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
    }

    /* 내 정보 영역 */
    .my-info {
      grid-area: my-info;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .my-character {
      text-align: center;
    }

    .my-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--gold);
      background: var(--mid-blue);
      margin: 0 auto 12px;
      box-shadow: var(--shadow-glow);
      transition: all var(--transition-fast);
    }

    .my-name {
      font-size: 18px;
      font-weight: 700;
      color: var(--gold-bright);
      margin-bottom: 4px;
    }

    .my-team {
      font-size: 12px;
      padding: 4px 12px;
      border-radius: 20px;
      display: inline-block;
      font-weight: 600;
      text-transform: uppercase;
    }

    .team-a {
      background: linear-gradient(135deg, #ff6b35, #f7931e);
      color: white;
    }

    .team-b {
      background: linear-gradient(135deg, #8e44ad, #9b59b6);
      color: white;
    }

    .my-hp {
      margin: 16px 0;
    }

    .hp-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 4px;
      text-transform: uppercase;
    }

    .hp-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
    }

    .hp-bar {
      height: 12px;
      background: var(--mid-blue);
      border-radius: 6px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .hp-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success), #2ecc71);
      transition: width 0.5s ease;
      border-radius: 6px;
    }

    .my-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 16px;
    }

    .stat-box {
      background: var(--glass-1);
      padding: 8px;
      border-radius: var(--radius);
      text-align: center;
      border: 1px solid var(--border);
    }

    .stat-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 2px;
    }

    .stat-value {
      font-size: 16px;
      font-weight: 700;
      color: var(--gold-bright);
    }

    .my-items {
      margin-bottom: 16px;
    }

    .item-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
    }

    .item-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 8px;
      background: var(--glass-1);
      border-radius: 6px;
      border: 1px solid var(--border);
    }

    .item-name {
      color: var(--text-accent);
    }

    .item-count {
      color: var(--gold);
      font-weight: 600;
    }

    .ready-section {
      text-align: center;
    }

    .btn-ready {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, var(--success), #2ecc71);
      color: white;
      border: none;
      border-radius: var(--radius);
      font-family: var(--serif);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      text-transform: uppercase;
    }

    .btn-ready:hover:not(:disabled) {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      transform: translateY(-2px);
    }

    .btn-ready:disabled {
      background: var(--glass-1);
      color: var(--text-muted);
      cursor: not-allowed;
      transform: none;
    }

    /* 중앙 턴 영역 */
    .turn-area {
      grid-area: turn-area;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .versus-header {
      width: 100%;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 20px;
      align-items: center;
      margin-bottom: 30px;
      text-align: center;
    }

    .team-info {
      background: var(--glass-1);
      padding: 12px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .team-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--gold);
      margin-bottom: 4px;
      text-transform: uppercase;
    }

    .team-hp {
      font-size: 12px;
      color: var(--text-muted);
    }

    .vs-divider {
      font-size: 24px;
      font-weight: 800;
      color: var(--gold-bright);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .current-turn {
      text-align: center;
      margin-bottom: 20px;
    }

    .turn-indicator {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .current-avatar {
      width: 150px;
      height: 200px;
      border-radius: var(--radius);
      object-fit: cover;
      border: 3px solid var(--gold);
      background: var(--mid-blue);
      box-shadow: var(--shadow-glow);
      transition: all var(--transition-fast);
      margin: 0 auto 12px;
    }

    .current-player-name {
      font-size: 18px;
      font-weight: 700;
      color: var(--gold-bright);
      margin-bottom: 4px;
    }

    .current-team {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .turn-timer {
      font-size: 12px;
      color: var(--warning);
      font-weight: 600;
    }

    .queue-display {
      margin-top: 20px;
      text-align: center;
      width: 100%;
    }

    .queue-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .queue-list {
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .queue-item {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--border);
      background: var(--mid-blue);
      transition: all var(--transition-fast);
      cursor: pointer;
    }

    .queue-item.active {
      border-color: var(--gold);
      box-shadow: var(--shadow-glow);
      transform: scale(1.1);
    }

    .queue-item.completed {
      opacity: 0.5;
      border-color: var(--text-muted);
    }

    /* 상대팀 정보 */
    .enemy-info {
      grid-area: enemy-info;
    }

    .enemy-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 400px;
      overflow-y: auto;
    }

    .enemy-card {
      background: var(--glass-1);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      transition: all var(--transition-fast);
    }

    .enemy-card:hover {
      background: var(--glass-2);
      border-color: var(--border-light);
    }

    .enemy-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .enemy-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--border);
      background: var(--mid-blue);
    }

    .enemy-details h4 {
      font-size: 14px;
      color: var(--text-accent);
      margin-bottom: 2px;
    }

    .enemy-details .team {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .enemy-hp {
      margin-bottom: 8px;
    }

    .enemy-hp .hp-text {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .enemy-hp .hp-bar {
      height: 6px;
    }

    .enemy-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
    }

    .enemy-stat {
      background: var(--glass-1);
      padding: 4px;
      border-radius: 4px;
      text-align: center;
      font-size: 10px;
    }

    .enemy-stat .label {
      color: var(--text-muted);
      display: block;
      font-size: 8px;
      text-transform: uppercase;
    }

    .enemy-stat .value {
      color: var(--gold);
      font-weight: 600;
      font-size: 11px;
    }

    /* 로그 영역 */
    .logs {
      grid-area: logs;
    }

    .log-container {
      height: 250px;
      overflow-y: auto;
      background: var(--glass-1);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
    }

    .log-entry {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 12px;
      line-height: 1.4;
      opacity: 0;
      animation: fadeIn 0.3s ease-out forwards;
    }

    @keyframes fadeIn {
      to { opacity: 1; }
    }

    .log-time {
      color: var(--text-muted);
      font-size: 10px;
      flex-shrink: 0;
      width: 50px;
    }

    .log-content {
      color: var(--text-accent);
    }

    .log-entry.system .log-content {
      color: var(--info);
    }

    .log-entry.battle .log-content {
      color: var(--warning);
    }

    .log-entry.critical .log-content {
      color: var(--danger);
      font-weight: 600;
    }

    .log-entry.heal .log-content {
      color: var(--success);
    }

    /* 액션 버튼 영역 */
    .actions {
      grid-area: actions;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .action-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    .action-btn {
      padding: 12px 8px;
      border: none;
      border-radius: var(--radius);
      font-family: var(--serif);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: var(--shadow-soft);
    }

    .action-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .action-btn:disabled {
      background: var(--glass-1);
      color: var(--text-muted);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .action-btn.attack {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
    }

    .action-btn.defend {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
    }

    .action-btn.dodge {
      background: linear-gradient(135deg, #f39c12, #e67e22);
      color: white;
    }

    .action-btn.pass {
      background: linear-gradient(135deg, #95a5a6, #7f8c8d);
      color: white;
    }

    .item-actions {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .action-btn.item {
      background: linear-gradient(135deg, #9b59b6, #8e44ad);
      color: white;
      font-size: 10px;
      padding: 8px 4px;
    }

    /* 채팅 영역 */
    .chat {
      grid-area: chat;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .chat-messages {
      flex: 1;
      background: var(--glass-1);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      overflow-y: auto;
      min-height: 60px;
      max-height: 80px;
    }

    .chat-entry {
      font-size: 11px;
      line-height: 1.4;
      margin-bottom: 4px;
      color: var(--text-accent);
    }

    .chat-entry .name {
      color: var(--gold);
      font-weight: 600;
    }

    .chat-input-row {
      display: flex;
      gap: 8px;
    }

    .chat-input {
      flex: 1;
      padding: 8px 12px;
      background: var(--glass-1);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-family: var(--serif);
      font-size: 12px;
    }

    .chat-input:focus {
      outline: none;
      border-color: var(--gold);
      box-shadow: 0 0 0 2px rgba(220, 199, 162, 0.2);
    }

    .btn-send {
      padding: 8px 16px;
      background: linear-gradient(135deg, var(--gold), var(--gold-bright));
      color: var(--deep-navy);
      border: none;
      border-radius: var(--radius);
      font-family: var(--serif);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .btn-send:hover {
      background: linear-gradient(135deg, var(--gold-bright), var(--gold-shimmer));
      transform: translateY(-1px);
    }

    /* 타깃 선택 오버레이 */
    .target-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .target-modal {
      background: var(--glass-2);
      backdrop-filter: var(--blur-light);
      border: 1px solid var(--border-light);
      border-radius: var(--radius);
      padding: 24px;
      max-width: 400px;
      width: 90%;
    }

    .target-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--gold-bright);
      text-align: center;
      margin-bottom: 16px;
    }

    .target-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }

    .target-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--glass-1);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .target-item:hover {
      background: var(--glass-2);
      border-color: var(--border-light);
    }

    .target-item.selected {
      border-color: var(--gold);
      background: rgba(220, 199, 162, 0.1);
    }

    .target-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--border);
      background: var(--mid-blue);
    }

    .target-info h4 {
      color: var(--text-accent);
      font-size: 14px;
      margin-bottom: 2px;
    }

    .target-info .hp {
      color: var(--text-muted);
      font-size: 11px;
    }

    .target-actions {
      display: flex;
      justify-content: center;
      gap: 12px;
    }

    .btn-confirm, .btn-cancel {
      padding: 8px 16px;
      border: none;
      border-radius: var(--radius);
      font-family: var(--serif);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      text-transform: uppercase;
    }

    .btn-confirm {
      background: linear-gradient(135deg, var(--success), #2ecc71);
      color: white;
    }

    .btn-cancel {
      background: linear-gradient(135deg, var(--danger), #c0392b);
      color: white;
    }

    /* 인증 오버레이 */
    .auth-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .auth-modal {
      background: var(--glass-2);
      backdrop-filter: var(--blur-light);
      border: 1px solid var(--border-light);
      border-radius: var(--radius);
      padding: 32px;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }

    .auth-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--gold-bright);
      margin-bottom: 8px;
    }

    .auth-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 24px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .auth-input {
      padding: 12px 16px;
      background: var(--glass-1);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-family: var(--serif);
      font-size: 14px;
    }

    .auth-input:focus {
      outline: none;
      border-color: var(--gold);
      box-shadow: 0 0 0 2px rgba(220, 199, 162, 0.2);
    }

    .btn-auth {
      padding: 12px;
      background: linear-gradient(135deg, var(--gold), var(--gold-bright));
      color: var(--deep-navy);
      border: none;
      border-radius: var(--radius);
      font-family: var(--serif);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      text-transform: uppercase;
    }

    .btn-auth:hover {
      background: linear-gradient(135deg, var(--gold-bright), var(--gold-shimmer));
      transform: translateY(-2px);
    }

    .auth-error {
      color: var(--danger);
      font-size: 12px;
      margin-top: 8px;
    }

    /* 토스트 */
    .toast {
      position: fixed;
      top: 100px;
      right: 20px;
      background: var(--glass-2);
      backdrop-filter: var(--blur-light);
      border: 1px solid var(--border-light);
      border-radius: var(--radius);
      padding: 16px;
      color: var(--text);
      font-size: 14px;
      box-shadow: var(--shadow-medium);
      transform: translateX(400px);
      transition: transform 0.3s ease-out;
      z-index: 3000;
      max-width: 300px;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success {
      border-left: 4px solid var(--success);
    }

    .toast.error {
      border-left: 4px solid var(--danger);
    }

    .toast.info {
      border-left: 4px solid var(--info);
    }
  </style>
</head>
<body>
  <!-- 헤더 -->
  <header class="header">
    <div class="header-inner">
      <div class="brand">
        <div class="logo">PYXIS</div>
        <div class="subtitle">전투 참가자</div>
      </div>
      <div class="connection-status">
        <span id="connText">서버 연결</span>
        <div class="status-dot" id="connDot"></div>
      </div>
    </div>
  </header>

  <!-- 메인 컨테이너 -->
  <div class="main-container">
    <!-- 내 정보 (좌측) -->
    <div class="my-info card">
      <div class="card-title">전투 참가자 (나)</div>
      
      <div class="my-character">
        <img id="meAvatar" class="my-avatar" src="" alt="내 아바타">
        <div id="meName" class="my-name">전투 참가자</div>
        <div id="meTeam" class="my-team team-a">A팀</div>
      </div>

      <div class="my-hp">
        <div class="hp-label">체력</div>
        <div id="meHp" class="hp-value">100 / 100</div>
        <div class="hp-bar">
          <div id="meHpBar" class="hp-fill" style="width: 100%"></div>
        </div>
      </div>

      <div class="my-stats">
        <div class="stat-box">
          <div class="stat-label">공격</div>
          <div id="sAtk" class="stat-value">3</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">방어</div>
          <div id="sDef" class="stat-value">3</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">민첩</div>
          <div id="sAgi" class="stat-value">3</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">행운</div>
          <div id="sLuk" class="stat-value">2</div>
        </div>
      </div>

      <div class="my-items">
        <div class="card-title" style="margin-bottom: 8px; font-size: 12px;">아이템</div>
        <div id="myItems" class="item-list">
          <div class="item-row">
            <span class="item-name">디터니</span>
            <span class="item-count">1</span>
          </div>
          <div class="item-row">
            <span class="item-name">공격 보정기</span>
            <span class="item-count">0</span>
          </div>
          <div class="item-row">
            <span class="item-name">방어 보정기</span>
            <span class="item-count">0</span>
          </div>
        </div>
      </div>

      <div class="ready-section">
        <button id="btnReady" class="btn-ready">준비 완료</button>
      </div>
    </div>

    <!-- 중앙 턴 영역 -->
    <div class="turn-area card">
      <div class="versus-header">
        <div class="team-info">
          <div class="team-name">A팀 (불사조 기사단)</div>
          <div id="teamAHp" class="team-hp">체력 합계: 300 / 300</div>
        </div>
        <div class="vs-divider">VS</div>
        <div class="team-info">
          <div class="team-name">B팀 (죽음을 먹는 자들)</div>
          <div id="teamBHp" class="team-hp">체력 합계: 300 / 300</div>
        </div>
      </div>

      <div class="current-turn">
        <div id="turnTeam" class="turn-indicator">A팀 차례</div>
        <img id="turnImg" class="current-avatar" src="" alt="현재 플레이어">
        <div id="turnName" class="current-player-name">전투 참가자</div>
        <div id="turnTeamLabel" class="current-team">A팀</div>
        <div id="turnTimer" class="turn-timer">남은 시간: 5:00</div>
      </div>

      <div class="queue-display">
        <div class="queue-label">행동 순서</div>
        <div id="queue" class="queue-list">
          <!-- 대기열 아바타들이 동적으로 추가됨 -->
        </div>
      </div>
    </div>

    <!-- 상대팀 정보 (우측) -->
    <div class="enemy-info card">
      <div class="card-title">상대팀</div>
      <div id="enemyList" class="enemy-list">
        <!-- 상대팀 카드들이 동적으로 추가됨 -->
      </div>
    </div>

    <!-- 실시간 로그 -->
    <div class="logs card">
      <div class="card-title">실시간 로그</div>
      <div id="logBox" class="log-container">
        <!-- 로그 엔트리들이 동적으로 추가됨 -->
      </div>
    </div>

    <!-- 액션 버튼 영역 -->
    <div class="actions card">
      <div class="card-title">행동 선택</div>
      
      <div class="action-grid">
        <button id="btnAttack" class="action-btn attack" disabled>공격</button>
        <button id="btnDefend" class="action-btn defend" disabled>방어</button>
        <button id="btnDodge" class="action-btn dodge" disabled>회피</button>
        <button id="btnPass" class="action-btn pass" disabled>패스</button>
      </div>

      <div class="item-actions">
        <button id="btnDittany" class="action-btn item" disabled>디터니</button>
        <button id="btnAtkBoost" class="action-btn item" disabled>공격 보정기</button>
        <button id="btnDefBoost" class="action-btn item" disabled>방어 보정기</button>
      </div>
    </div>

    <!-- 채팅 영역 -->
    <div class="chat card">
      <div class="card-title">채팅</div>
      <div id="chatBox" class="chat-messages">
        <!-- 채팅 메시지들이 동적으로 추가됨 -->
      </div>
      <div class="chat-input-row">
        <input id="chatMsg" class="chat-input" type="text" placeholder="메시지를 입력하세요..." maxlength="100">
        <button id="btnSend" class="btn-send">전송</button>
      </div>
    </div>
  </div>

  <!-- 타깃 선택 오버레이 -->
  <div id="targetOverlay" class="target-overlay">
    <div class="target-modal">
      <div id="targetTitle" class="target-title">대상 선택</div>
      <div id="targetList" class="target-list">
        <!-- 타깃 목록이 동적으로 추가됨 -->
      </div>
      <div class="target-actions">
        <button id="btnConfirmTarget" class="btn-confirm">확인</button>
        <button id="btnCancelTarget" class="btn-cancel">취소</button>
      </div>
    </div>
  </div>

  <!-- 인증 오버레이 -->
  <div id="authOverlay" class="auth-overlay">
    <div class="auth-modal">
      <div class="auth-title">PYXIS</div>
      <div class="auth-subtitle">전투 참가자 인증</div>
      <div class="auth-form">
        <input id="authBattle" class="auth-input" type="text" placeholder="전투 ID" required>
        <input id="authName" class="auth-input" type="text" placeholder="전투 참가자 이름" maxlength="20" required>
        <input id="authPassword" class="auth-input" type="password" placeholder="비밀번호" required>
        <select id="authTeam" class="auth-input">
          <option value="A">A팀</option>
          <option value="B">B팀</option>
        </select>
        <button id="btnAuth" class="btn-auth">전투 참가</button>
        <div id="authError" class="auth-error" style="display: none;"></div>
      </div>
    </div>
  </div>

  <!-- 토스트 -->
  <div id="toast" class="toast">
    <!-- 토스트 메시지가 동적으로 표시됨 -->
  </div>

  <script>
    // DOM 헬퍼
    const $ = (q, root = document) => root.querySelector(q);
    const $ = (q, root = document) => [...root.querySelectorAll(q)];
    const escapeHtml = (s) => String(s).replace(/[&<>"']/g, m => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'}[m]));

    // URL 파라미터
    const params = new URLSearchParams(location.search);
    let battleId = params.get('battle') || '';
    let myName = params.get('name') || '';
    let otp = params.get('token') || params.get('password') || '';
    let myTeamAB = (params.get('team') || 'A').toUpperCase() === 'B' ? 'B' : 'A';

    // 전역 상태
    let socket = null;
    let me = null;
    let lastSnap = null;
    let teamTimerHandle = null;
    let selectedTarget = null;
    let currentAction = null;
    let isMyTurn = false;
    let iCommittedThisPhase = false;

    // UI 참조
    const authOverlay = $('#authOverlay');
    const toastEl = $('#toast');

    const meAvatar = $('#meAvatar');
    const meNameEl = $('#meName');
    const meTeamEl = $('#meTeam');
    const meHpEl = $('#meHp');
    const meHpBar = $('#meHpBar');

    const sAtk = $('#sAtk'), sDef = $('#sDef'), sLuk = $('#sLuk'), sAgi = $('#sAgi');
    const myItemsEl = $('#myItems');

    const enemyList = $('#enemyList');
    const btnReady = $('#btnReady');

    const turnTeam = $('#turnTeam');
    const queueEl = $('#queue');
    const turnImg = $('#turnImg');
    const turnName = $('#turnName');
    const turnTeamLabel = $('#turnTeamLabel');
    const turnTimer = $('#turnTimer');

    const btnAttack = $('#btnAttack');
    const btnDefend = $('#btnDefend');
    const btnDodge = $('#btnDodge');
    const btnPass = $('#btnPass');
    const btnDittany = $('#btnDittany');
    const btnAtkBoost = $('#btnAtkBoost');
    const btnDefBoost = $('#btnDefBoost');

    const chatBox = $('#chatBox');
    const chatMsg = $('#chatMsg');
    const btnSend = $('#btnSend');

    const logBox = $('#logBox');

    const targetOverlay = $('#targetOverlay');
    const targetTitle = $('#targetTitle');
    const targetList = $('#targetList');
    const btnConfirmTarget = $('#btnConfirmTarget');
    const btnCancelTarget = $('#btnCancelTarget');

    // 유틸리티 함수
    const toAB = (team) => {
      const s = String(team || '').toLowerCase();
      if (s === 'a' || s === 'phoenix' || s === 'team_a' || s === 'team-a') return 'A';
      if (s === 'b' || s === 'eaters' || s === 'death' || s === 'team_b' || s === 'team-b') return 'B';
      return 'A';
    };

    const formatTime = (seconds) => {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${String(secs).padStart(2, '0')}`;
    };

    const showToast = (message, type = 'info') => {
      toastEl.textContent = message;
      toastEl.className = `toast ${type} show`;
      setTimeout(() => toastEl.classList.remove('show'), 3000);
    };

    const addLog = (message, type = 'system') => {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      
      const time = document.createElement('div');
      time.className = 'log-time';
      time.textContent = new Date().toLocaleTimeString('ko-KR', { 
        hour12: false, 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      
      const content = document.createElement('div');
      content.className = 'log-content';
      content.textContent = message;
      
      entry.appendChild(time);
      entry.appendChild(content);
      logBox.appendChild(entry);
      logBox.scrollTop = logBox.scrollHeight;
      
      // 로그 제한
      while (logBox.children.length > 100) {
        logBox.removeChild(logBox.firstChild);
      }
    };

    const addChat = (name, message) => {
      const entry = document.createElement('div');
      entry.className = 'chat-entry';
      entry.innerHTML = `<span class="name">${escapeHtml(name)}</span>: ${escapeHtml(message)}`;
      chatBox.appendChild(entry);
      chatBox.scrollTop = chatBox.scrollHeight;
      
      // 채팅 제한
      while (chatBox.children.length > 50) {
        chatBox.removeChild(chatBox.firstChild);
      }
    };

    // 소켓 연결
    const connectSocket = () => {
      socket = window.io ? window.io() : null;
      if (!socket) {
        showToast('소켓 연결 실패', 'error');
        return;
      }

      socket.on('connect', () => {
        $('#connText').textContent = '연결됨';
        $('#connDot').style.background = 'var(--success)';
        addLog('서버에 연결되었습니다.', 'system');
      });

      socket.on('disconnect', () => {
        $('#connText').textContent = '연결 끊김';
        $('#connDot').style.background = 'var(--danger)';
        addLog('서버 연결이 끊어졌습니다.', 'system');
      });

      // 인증 응답
      socket.on('authSuccess', (data) => {
        me = data.player || data;
        if (me.id) window.__PYXIS_PLAYER_ID = me.id;
        
        authOverlay.style.display = 'none';
        showToast('전투에 참가했습니다.', 'success');
        addLog(`${me.name || '전투 참가자'}로 참가했습니다.`, 'system');
        
        // 전투 조인
        socket.emit('join', { battleId });
        
        updateMyInfo();
      });

      socket.on('auth:success', (data) => {
        socket.emit('authSuccess', data);
      });

      socket.on('authError', (error) => {
        $('#authError').textContent = error.message || '인증에 실패했습니다.';
        $('#authError').style.display = 'block';
        $('#btnAuth').disabled = false;
      });

      socket.on('auth:error', (error) => {
        socket.emit('authError', error);
      });

      // 전투 상태 업데이트
      socket.on('battleUpdate', onBattleUpdate);
      socket.on('battle:update', onBattleUpdate);

      // 로그 및 채팅
      socket.on('battle:log', (data) => {
        addLog(data.message || '로그', data.type || 'system');
      });

      socket.on('battleLog', (data) => {
        addLog(data.message || '로그', data.type || 'system');
      });

      socket.on('chatMessage', (data) => {
        addChat(data.name || '전투 참가자', data.message || '');
      });

      socket.on('battle:chat', (data) => {
        addChat(data.name || data.senderName || '전투 참가자', data.message || '');
      });

      // 액션 응답
      socket.on('actionSuccess', (data) => {
        showToast(data.message || '액션이 성공했습니다.', 'success');
        iCommittedThisPhase = true;
        updateActionButtons();
      });

      socket.on('action:success', (data) => {
        socket.emit('actionSuccess', data);
      });

      socket.on('actionError', (data) => {
        showToast(data.message || '액션에 실패했습니다.', 'error');
      });

      socket.on('action:error', (data) => {
        socket.emit('actionError', data);
      });
    };

    // 전투 상태 업데이트
    const onBattleUpdate = (snap) => {
      lastSnap = snap;
      
      if (!snap) return;
      
      // 내 정보 업데이트
      if (me && me.id) {
        const updated = snap.players?.find(p => p.id === me.id);
        if (updated) {
          me = updated;
          updateMyInfo();
        }
      }
      
      // 팀 정보 업데이트
      updateTeamInfo(snap);
      
      // 턴 정보 업데이트
      updateTurnInfo(snap);
      
      // 상대팀 업데이트
      updateEnemyList(snap);
      
      // 액션 버튼 상태 업데이트
      updateActionButtons();
    };

    // 내 정보 업데이트
    const updateMyInfo = () => {
      if (!me) return;
      
      meNameEl.textContent = me.name || '전투 참가자';
      meTeamEl.textContent = `${toAB(me.team)}팀`;
      meTeamEl.className = `my-team team-${toAB(me.team).toLowerCase()}`;
      
      if (me.avatar) {
        meAvatar.src = me.avatar;
        meAvatar.style.display = 'block';
      }
      
      const hp = Math.max(0, me.hp || 100);
      const maxHp = me.maxHp || 100;
      meHpEl.textContent = `${hp} / ${maxHp}`;
      meHpBar.style.width = `${maxHp ? (hp / maxHp) * 100 : 0}%`;
      
      if (me.stats) {
        sAtk.textContent = me.stats.attack || 3;
        sDef.textContent = me.stats.defense || 3;
        sAgi.textContent = me.stats.agility || 3;
        sLuk.textContent = me.stats.luck || 2;
      }
      
      if (me.items) {
        const items = myItemsEl.querySelectorAll('.item-row');
        if (items[0]) items[0].querySelector('.item-count').textContent = me.items.dittany || 0;
        if (items[1]) items[1].querySelector('.item-count').textContent = me.items.attack_boost || 0;
        if (items[2]) items[2].querySelector('.item-count').textContent = me.items.defense_boost || 0;
      }
    };

    // 팀 정보 업데이트
    const updateTeamInfo = (snap) => {
      if (!snap.players) return;
      
      const teamA = snap.players.filter(p => toAB(p.team) === 'A');
      const teamB = snap.players.filter(p => toAB(p.team) === 'B');
      
      const aHp = teamA.reduce((sum, p) => sum + Math.max(0, p.hp || 0), 0);
      const aMaxHp = teamA.reduce((sum, p) => sum + (p.maxHp || 100), 0);
      const bHp = teamB.reduce((sum, p) => sum + Math.max(0, p.hp || 0), 0);
      const bMaxHp = teamB.reduce((sum, p) => sum + (p.maxHp || 100), 0);
      
      $('#teamAHp').textContent = `체력 합계: ${aHp} / ${aMaxHp}`;
      $('#teamBHp').textContent = `체력 합계: ${bHp} / ${bMaxHp}`;
    };

    // 턴 정보 업데이트
    const updateTurnInfo = (snap) => {
      const turn = snap.turn || {};
      const currentTeam = turn.currentTeam || snap.currentTeam || 'A';
      const currentPlayer = snap.players?.find(p => p.id === (turn.currentPlayerId || snap.currentPlayerId));
      
      turnTeam.textContent = `${currentTeam}팀 차례`;
      
      if (currentPlayer) {
        turnName.textContent = currentPlayer.name || '전투 참가자';
        turnTeamLabel.textContent = `${toAB(currentPlayer.team)}팀`;
        
        if (currentPlayer.avatar) {
          turnImg.src = currentPlayer.avatar;
          turnImg.style.display = 'block';
        }
      }
      
      // 타이머 업데이트
      if (snap.status === 'active' && turn.timeLeft != null) {
        turnTimer.textContent = `남은 시간: ${formatTime(Math.max(0, Math.floor(turn.timeLeft / 1000)))}`;
        turnTimer.style.display = 'block';
      } else {
        turnTimer.style.display = 'none';
      }
      
      // 큐 업데이트
      updateQueue(snap);
      
      // 내 턴 여부 확인
      isMyTurn = me && currentPlayer && me.id === currentPlayer.id;
    };

    // 대기열 업데이트
    const updateQueue = (snap) => {
      if (!snap.players || !snap.turn) return;
      
      queueEl.innerHTML = '';
      
      const turn = snap.turn;
      const order = turn.order || ['A', 'B'];
      const phaseIndex = turn.phaseIndex || 0;
      const currentTeam = order[phaseIndex] || 'A';
      
      const teamPlayers = snap.players
        .filter(p => toAB(p.team) === currentTeam && (p.hp || 0) > 0)
        .sort((a, b) => (a.name || '').localeCompare(b.name || ''));
      
      teamPlayers.forEach((player, index) => {
        const item = document.createElement('img');
        item.className = 'queue-item';
        item.src = player.avatar || '';
        item.alt = player.name || '전투 참가자';
        item.title = player.name || '전투 참가자';
        
        if (player.id === (turn.currentPlayerId || snap.currentPlayerId)) {
          item.classList.add('active');
        }
        
        queueEl.appendChild(item);
      });
    };

    // 상대팀 목록 업데이트
    const updateEnemyList = (snap) => {
      if (!snap.players || !me) return;
      
      const myTeam = toAB(me.team);
      const enemies = snap.players.filter(p => toAB(p.team) !== myTeam);
      
      enemyList.innerHTML = '';
      
      enemies.forEach(enemy => {
        const card = document.createElement('div');
        card.className = 'enemy-card';
        
        const hp = Math.max(0, enemy.hp || 0);
        const maxHp = enemy.maxHp || 100;
        const hpPercent = maxHp ? (hp / maxHp) * 100 : 0;
        
        const stats = enemy.stats || {};
        
        card.innerHTML = `
          <div class="enemy-header">
            <img class="enemy-avatar" src="${enemy.avatar || ''}" alt="${enemy.name || '전투 참가자'}">
            <div class="enemy-details">
              <h4>${escapeHtml(enemy.name || '전투 참가자')}</h4>
              <div class="team">${teamNames[toAB(enemy.team)] || `${toAB(enemy.team)}팀`}</div>
            </div>
          </div>
          <div class="enemy-hp">
            <div class="hp-text">${hp} / ${maxHp}</div>
            <div class="hp-bar">
              <div class="hp-fill" style="width: ${hpPercent}%"></div>
            </div>
          </div>
          <div class="enemy-stats">
            <div class="enemy-stat">
              <span class="label">공격</span>
              <span class="value">${stats.attack || 3}</span>
            </div>
            <div class="enemy-stat">
              <span class="label">방어</span>
              <span class="value">${stats.defense || 3}</span>
            </div>
            <div class="enemy-stat">
              <span class="label">민첩</span>
              <span class="value">${stats.agility || 3}</span>
            </div>
            <div class="enemy-stat">
              <span class="label">행운</span>
              <span class="value">${stats.luck || 2}</span>
            </div>
          </div>
        `;
        
        enemyList.appendChild(card);
      });
    };

    // 액션 버튼 상태 업데이트
    const updateActionButtons = () => {
      const canAct = isMyTurn && !iCommittedThisPhase && lastSnap?.status === 'active';
      
      btnAttack.disabled = !canAct;
      btnDefend.disabled = !canAct;
      btnDodge.disabled = !canAct;
      btnPass.disabled = !canAct;
      
      if (me && me.items) {
        btnDittany.disabled = !canAct || (me.items.dittany || 0) <= 0;
        btnAtkBoost.disabled = !canAct || (me.items.attack_boost || 0) <= 0;
        btnDefBoost.disabled = !canAct || (me.items.defense_boost || 0) <= 0;
      }
    };

    // 대상 선택
    const selectTarget = (actionType) => {
      if (!me || !lastSnap) return;
      
      currentAction = actionType;
      let targets = [];
      
      if (actionType === 'attack') {
        // 공격: 살아있는 적군
        targets = lastSnap.players.filter(p => 
          toAB(p.team) !== toAB(me.team) && (p.hp || 0) > 0
        );
      } else if (actionType === 'dittany') {
        // 디터니: 살아있는 아군 (본인 포함)
        targets = lastSnap.players.filter(p => 
          toAB(p.team) === toAB(me.team) && (p.hp || 0) > 0
        );
      }
      
      if (targets.length === 0) {
        showToast('선택할 수 있는 대상이 없습니다.', 'error');
        return;
      }
      
      if (targets.length === 1) {
        // 대상이 하나면 바로 실행
        executeAction(actionType, targets[0].id);
        return;
      }
      
      // 대상 선택 UI 표시
      targetTitle.textContent = actionType === 'attack' ? '공격 대상 선택' : '회복 대상 선택';
      targetList.innerHTML = '';
      
      targets.forEach(target => {
        const item = document.createElement('div');
        item.className = 'target-item';
        item.dataset.targetId = target.id;
        
        const hp = Math.max(0, target.hp || 0);
        const maxHp = target.maxHp || 100;
        
        item.innerHTML = `
          <img class="target-avatar" src="${target.avatar || ''}" alt="${target.name || '전투 참가자'}">
          <div class="target-info">
            <h4>${escapeHtml(target.name || '전투 참가자')}</h4>
            <div class="hp">HP: ${hp} / ${maxHp}</div>
          </div>
        `;
        
        item.addEventListener('click', () => {
          targetList.querySelectorAll('.target-item').forEach(t => t.classList.remove('selected'));
          item.classList.add('selected');
          selectedTarget = target.id;
        });
        
        targetList.appendChild(item);
      });
      
      targetOverlay.style.display = 'flex';
    };

    // 액션 실행
    const executeAction = (actionType, targetId = null) => {
      if (!socket || !me || !battleId) return;
      
      let actionData = {
        battleId,
        playerId: me.id,
        action: { type: actionType }
      };
      
      if (targetId) {
        actionData.action.targetId = targetId;
      }
      
      if (actionType === 'dittany') {
        actionData.action.type = 'item';
        actionData.action.itemType = 'dittany';
      } else if (actionType === 'attack_boost') {
        actionData.action.type = 'item';
        actionData.action.itemType = 'attack_boost';
      } else if (actionType === 'defense_boost') {
        actionData.action.type = 'item';
        actionData.action.itemType = 'defense_boost';
      }
      
      socket.emit('playerAction', actionData);
      socket.emit('player:action', actionData);
      
      addLog(`${actionType} 액션을 실행했습니다.`, 'battle');
    };

    // 초기화
    const init = () => {
      // URL 파라미터로 자동 입력
      if (battleId) $('#authBattle').value = battleId;
      if (myName) $('#authName').value = myName;
      if (otp) $('#authPassword').value = otp
