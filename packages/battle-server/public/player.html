<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PYXIS 전투 참가자</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/pyxis-unified.css">
</head>
<body>
  <header class="header">
    <div class="header-content">
      <a href="/" class="logo">PYXIS</a>
      <div class="header-right">
        <span class="text-muted" id="playerInfo">전투 참가자</span>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="main-grid" style="grid-template-columns: 300px 1fr 300px; gap: 20px;">
      <!-- 좌: 내 정보 + 팀 -->
      <div style="display: grid; grid-template-rows: auto 1fr; gap: 16px;">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">내 정보</h3>
          </div>
          <div id="myInfo" class="player-card" style="border: 2px solid var(--gold-1);">
            <div class="pc-header">
              <img id="myAvatar" class="pc-avatar" alt="내 아바타"
                   onerror="this.style.background='#333';this.removeAttribute('src')">
              <div class="pc-info">
                <div id="myName" class="pc-name">대기 중...</div>
                <div id="myTeam" class="pc-ready">팀 정보 로딩 중</div>
              </div>
            </div>
            <div class="pc-hp">
              <div class="hp-bar">
                <div id="myHpFill" class="hp-fill" style="width: 100%"></div>
              </div>
              <div id="myHpText" class="hp-text">HP 100/100</div>
            </div>
            <div id="myStats" class="pc-stats">공격 1 | 방어 1 | 민첩 1 | 행운 1</div>
            <div id="myItems" class="pc-items">디터니 0 | 공격보정 0 | 방어보정 0</div>
            <div style="margin-top: 12px;">
              <button id="readyBtn" class="btn" style="width: 100%;">준비 완료</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">팀 정보</h3>
          </div>
          <div class="teams">
            <div class="team">
              <div class="team-title">내 팀</div>
              <div id="myTeamContainer" class="roster">
                <div class="empty-team">팀원 로딩 중...</div>
              </div>
            </div>
            <div class="team">
              <div class="team-title">상대 팀</div>
              <div id="enemyTeamContainer" class="roster">
                <div class="empty-team">상대팀 로딩 중...</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 중앙: 전투 제어 -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">전투 제어</h3>
        </div>

        <div style="text-align: center; margin-bottom: 24px;">
          <div id="battleStatus" class="status-pill waiting">전투 대기 중</div>
          <div id="turnInfo" style="margin-top: 12px; color: var(--ink-dim); font-size: 16px;">
            턴 정보를 기다리는 중...
          </div>
        </div>

        <div id="currentPlayerDisplay" style="text-align: center; margin-bottom: 24px; padding: 20px; background: var(--glass-2); border-radius: 12px;">
          <img id="currentPlayerAvatar"
               style="width: 120px; height: 120px; border-radius: 12px; background: #333; margin-bottom: 12px; border: 3px solid var(--gold-1);"
               onerror="this.style.background='#333';this.removeAttribute('src')">
          <div id="currentPlayerName" style="font-weight: 700; font-size: 20px; color: var(--gold-1); margin-bottom: 4px;">대기 중</div>
          <div id="currentPlayerTeam" style="color: var(--ink-dim); font-size: 16px;">-</div>
          <div id="currentPlayerAction" style="color: var(--ink); font-size: 14px; margin-top: 8px;">행동 대기 중</div>
        </div>

        <div style="background: var(--glass-2); border-radius: 8px; padding: 16px; margin-bottom: 24px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; text-align: center;">
            <div>
              <div style="color: var(--ink-dim); font-size: 12px; margin-bottom: 4px;">라운드</div>
              <div id="roundNumber" style="font-size: 24px; font-weight: 700; color: var(--gold-1);">-</div>
            </div>
            <div>
              <div style="color: var(--ink-dim); font-size: 12px; margin-bottom: 4px;">현재 턴</div>
              <div id="currentTeamTurn" style="font-size: 24px; font-weight: 700; color: var(--gold-1);">-</div>
            </div>
          </div>
          <div style="margin-top: 16px; text-align: center;">
            <div style="color: var(--ink-dim); font-size: 12px; margin-bottom: 4px;">남은 시간</div>
            <div id="turnTimer" style="font-size: 18px; font-weight: 600; color: var(--ink);">--:--</div>
          </div>
        </div>

        <div id="actionButtons" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
          <button id="attackBtn" class="btn" disabled>공격</button>
          <button id="defendBtn" class="btn" disabled>방어</button>
          <button id="dodgeBtn" class="btn" disabled>회피</button>
          <button id="itemBtn" class="btn" disabled>아이템</button>
          <button id="passBtn" class="btn" disabled style="grid-column: 1 / -1;">패스</button>
        </div>
      </div>

      <!-- 우: 로그 & 채팅 -->
      <div style="display: grid; grid-template-rows: 1fr auto; gap: 16px;">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">전투 로그</h3>
          </div>
          <div id="battleLog" class="timeline"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">채팅</h3>
          </div>
          <div class="chat-wrap">
            <div id="chatContainer" class="chat-messages"></div>
            <div class="chat-input">
              <input id="chatInput" type="text" class="form-input" placeholder="메시지 입력...">
              <button id="chatSend" class="btn">전송</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 액션 선택 오버레이 -->
  <div id="actionOverlay" class="action-overlay">
    <div class="action-content">
      <h3 id="actionTitle" class="action-title">행동 선택</h3>
      <div id="actionTargets" class="targets"></div>
      <button id="cancelAction" class="cancel-btn">취소</button>
    </div>
  </div>

  <!-- 아이템 선택 오버레이 -->
  <div id="itemOverlay" class="action-overlay">
    <div class="action-content">
      <h3 class="action-title">아이템 사용</h3>
      <div id="itemList" class="targets"></div>
      <button id="cancelItem" class="cancel-btn">취소</button>
    </div>
  </div>

  <!-- 게임 종료 오버레이 -->
  <div id="gameOverOverlay" class="game-over-overlay">
    <div class="game-over-content">
      <h2 class="game-over-title">전투 종료</h2>
      <div class="game-over-winner">
        <span id="winnerTeam">A팀</span> 승리!
      </div>
      <div id="gameOverMessage" style="margin: 16px 0; color: var(--ink-dim);">전투가 종료되었습니다</div>
    </div>
  </div>

  <!-- 이름 입력 오버레이 -->
  <div id="nameInputOverlay" class="name-input-overlay" style="display:none;">
    <div class="name-input-box">
      <h2>전투 참가</h2>
      <p style="color: var(--ink-dim); margin-bottom: 16px;">이름을 입력해주세요</p>
      <input id="nameInput" type="text" placeholder="참가자 이름" maxlength="20">
      <button id="joinBtn" class="btn">입장</button>
    </div>
  </div>

  <style>
    /* 액션/게임오버/이름오버레이 + 로그 스타일 (요청안 유지, 중복 정리) */
    .action-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all .3s}
    .action-overlay.show{opacity:1;visibility:visible}
    .action-content{background:var(--glass-2);border:2px solid var(--gold-1);border-radius:12px;padding:20px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto}
    .action-title{font-family:'Cinzel',serif;color:var(--gold-1);font-size:18px;margin-bottom:16px;text-align:center}
    .targets{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:12px;margin:16px 0}
    .target{background:var(--glass-1);border:1px solid var(--border);padding:12px;border-radius:8px;text-align:center;cursor:pointer;transition:all .2s;font-size:12px}
    .target:hover:not(.disabled){background:var(--gold-1);color:#111;transform:translateY(-2px)}
    .target.disabled{opacity:.4;cursor:not-allowed}
    .target img{width:48px;height:48px;border-radius:6px;margin-bottom:8px;background:#333;object-fit:cover}
    .target-name{font-weight:600;margin-bottom:4px}
    .target-info{color:var(--ink-dim);font-size:10px}
    .cancel-btn{background:#9b4444;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;margin-top:16px;width:100%;font-weight:600}
    .cancel-btn:hover{background:#b55555}

    .game-over-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;z-index:9999;opacity:0;visibility:hidden;transition:all .3s}
    .game-over-overlay.show{opacity:1;visibility:visible}
    .game-over-content{text-align:center;background:var(--glass-2);border:2px solid var(--gold-1);border-radius:16px;padding:32px;max-width:400px;width:90%}
    .game-over-title{font-family:'Cinzel',serif;color:var(--gold-1);font-size:24px;margin-bottom:16px}
    .game-over-winner{font-size:18px;font-weight:700;color:var(--ink);margin-bottom:16px}

    .name-input-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;z-index:10000}
    .name-input-box{background:var(--glass-2);border:2px solid var(--gold-1);border-radius:12px;padding:24px;text-align:center;max-width:400px;width:90%}
    .name-input-box h2{color:var(--gold-1);margin-bottom:16px;font-family:'Cinzel',serif}
    .name-input-box input{width:100%;padding:12px;margin:16px 0;background:var(--glass-1);border:1px solid var(--border);color:var(--ink);border-radius:6px;font-size:16px;text-align:center}
    .name-input-box input:focus{outline:none;border-color:var(--gold-1);box-shadow:0 0 0 2px rgba(220,199,162,.2)}

    .my-card{border-color:var(--gold-1)!important;box-shadow:0 0 10px rgba(220,199,162,.3)}

    .log-item{margin-bottom:4px;font-size:11px;line-height:1.4;padding:4px 8px;border-radius:4px;transition:all .2s}
    .log-time{color:#1A1A1A!important;font-weight:500;font-size:10px}
    .log-item.log-gold{background:#D4B871!important;color:#1A1A1A!important;font-weight:700!important;border:1px solid #C4A853;box-shadow:0 1px 3px rgba(212,184,113,.25)}
    .log-item.log-team-a{background:#B73E3E!important;color:#F5F5F5!important;font-weight:600!important;border:1px solid #A53535}
    .log-item.log-team-a .log-time{color:#1A1A1A!important;background:rgba(255,255,255,.15);padding:1px 4px;border-radius:3px}
    .log-item.log-team-b{background:#4A5D8A!important;color:#F5F5F5!important;font-weight:600!important;border:1px solid #3E4F73}
    .log-item.log-team-b .log-time{color:#1A1A1A!important;background:rgba(255,255,255,.15);padding:1px 4px;border-radius:3px}
    .log-item.log-system{background:transparent;color:#8A8A8A;font-weight:500}
    .log-item.log-error{background:#2A2A2A!important;color:#D4B871!important;font-weight:700!important;border:1px solid #C4A853}
    .log-item.log-error .log-time{color:#1A1A1A!important;background:rgba(212,184,113,.2);padding:1px 4px;border-radius:3px}
    .log-item.log-notice{background:rgba(212,184,113,.12);color:#C4A853;font-weight:600;border:1px solid rgba(212,184,113,.3)}
    .log-item:hover{transform:translateY(-1px);box-shadow:0 2px 6px rgba(0,0,0,.15)}

    @media (max-width:1200px){.main-grid{grid-template-columns:280px 1fr 280px!important}}
    @media (max-width:768px){
      .main-grid{grid-template-columns:1fr!important;gap:16px}
      .teams{grid-template-columns:1fr}
      .targets{grid-template-columns:repeat(auto-fit,minmax(80px,1fr))}
      .action-content{padding:16px;margin:20px}
      #currentPlayerAvatar{width:80px!important;height:80px!important}
    }
  </style>

  <script src="/socket.io/socket.io.js"></script>
  <script>
  (function(){
    'use strict';

    // 상태 변수
    let socket;
    let battleState = null;
    let myPlayer = null;
    let currentAction = null;
    let connectionRetries = 0;
    const maxRetries = 5;

    // URL 파라미터
    const urlParams = new URLSearchParams(window.location.search);
    const battleId   = urlParams.get('battle');
    const token      = urlParams.get('token');
    const playerName = urlParams.get('name');

    if (!battleId) {
      alert('전투 ID가 없습니다.');
      window.location.href = '/';
      return;
    }

    // DOM 참조
    const elements = {
      playerInfo: document.getElementById('playerInfo'),
      nameInput: document.getElementById('nameInput'),
      joinBtn: document.getElementById('joinBtn'),
      nameInputOverlay: document.getElementById('nameInputOverlay'),

      battleStatus: document.getElementById('battleStatus'),
      turnInfo: document.getElementById('turnInfo'),
      roundNumber: document.getElementById('roundNumber'),
      currentTeamTurn: document.getElementById('currentTeamTurn'),
      turnTimer: document.getElementById('turnTimer'),

      currentPlayerAvatar: document.getElementById('currentPlayerAvatar'),
      currentPlayerName: document.getElementById('currentPlayerName'),
      currentPlayerTeam: document.getElementById('currentPlayerTeam'),
      currentPlayerAction: document.getElementById('currentPlayerAction'),

      readyBtn: document.getElementById('readyBtn'),
      chatInput: document.getElementById('chatInput'),
      chatSend: document.getElementById('chatSend'),

      actionOverlay: document.getElementById('actionOverlay'),
      itemOverlay: document.getElementById('itemOverlay'),
      gameOverOverlay: document.getElementById('gameOverOverlay')
    };

    // 유틸
    function esc(str){
      return String(str ?? '')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;');
    }

    // 시간 포맷(누락시 현재시각)
    function formatLogTime(ts){
      const date = new Date(ts || Date.now());
      const h = String(date.getHours()).padStart(2,'0');
      const m = String(date.getMinutes()).padStart(2,'0');
      const s = String(date.getSeconds()).padStart(2,'0');
      return `${h}시 ${m}분 ${s}초`;
    }

    // 로그 클래스 결정 (오탈자/중복 정리)
    function getLogClass(log){
      const type = log?.type || 'system';
      const message = String(log?.message || '');

      switch (type) {
        case 'gold':   return 'log-gold';
        case 'teamA':  return 'log-team-a';
        case 'teamB':  return 'log-team-b';
        case 'system': return 'log-system';
        case 'error':  return 'log-error';
        case 'notice': return 'log-notice';
        default: {
          if (
            message.includes('선공 결정:') ||
            message.includes('팀이 선공입니다!') ||
            message.includes('전투가 시작되었습니다!') ||
            message.includes('라운드 시작') ||
            message.includes('라운드 종료') ||
            message.includes('승리!')
          ) return 'log-gold';

          if (
            message.includes('=== A팀') ||
            message.includes('[A]') ||
            message.includes('A팀 선택')
          ) return 'log-team-a';

          if (
            message.includes('=== B팀') ||
            message.includes('[B]') ||
            message.includes('B팀 선택')
          ) return 'log-team-b';

          return 'log-system';
        }
      }
    }

    // 로그 렌더/추가
    function addLog(log){
      if (!log) return;
      const timeStr = formatLogTime(log.ts);
      const logClass = getLogClass(log);
      const message = esc(log.message || '');
      const html = `<div class="log-item ${logClass}">
        <span class="log-time">[${timeStr}]</span> ${message}
      </div>`;
      const box = document.getElementById('battleLog');
      if (box){
        box.insertAdjacentHTML('beforeend', html);
        box.scrollTop = box.scrollHeight;
      }
    }

    function renderLogs(){
      const box = document.getElementById('battleLog');
      if (!box || !battleState?.logs) return;
      box.innerHTML = '';
      battleState.logs.forEach(log => addLog(log));
    }

    // 채팅
    function addChat(chat){
      if (!chat) return;
      const timeStr = formatLogTime(chat.ts);
      const name = esc(chat.name || '');
      const message = esc(chat.message || '');
      const html = `<div class="chat-line">
        <span class="log-time">[${timeStr}]</span>
        <span class="chat-name">${name}:</span> ${message}
      </div>`;
      const box = document.getElementById('chatContainer');
      if (box){
        box.insertAdjacentHTML('beforeend', html);
        box.scrollTop = box.scrollHeight;
      }
    }

    function sendChat(){
      const msg = elements.chatInput.value.trim();
      if (!msg || !myPlayer || !socket?.connected) return;
      socket.emit('chatMessage', { battleId, name: myPlayer.name, message: msg });
      elements.chatInput.value = '';
    }

    // 인증
    function authenticate(){
      const name = elements.nameInput.value.trim();
      if (!name){ alert('이름을 입력해주세요.'); return; }
      if (!socket?.connected){ alert('서버에 연결되지 않았습니다.'); return; }
      socket.emit('playerAuth', { battleId, name, token, team: null });
    }

    // 준비 완료
    function toggleReady(){
      if (!myPlayer || !socket?.connected) return;
      socket.emit('player:ready', { battleId, playerId: myPlayer.id });
      elements.readyBtn.disabled = true;
      elements.readyBtn.textContent = '준비 완료됨';
      elements.readyBtn.style.background = '#16a34a';
    }

    // 액션
    function canAct(){
      if (!battleState || !myPlayer) return false;
      if (battleState.status !== 'active') return false;
      if (battleState.currentTurn?.currentTeam !== myPlayer.team) return false;
      if (battleState.currentTurn?.currentPlayer?.id !== myPlayer.id) return false;
      return true;
    }

    function getEnemyPlayers(){
      if (!battleState || !myPlayer) return [];
      return battleState.players.filter(p => p.team !== myPlayer.team && p.hp > 0);
    }

    function disableActionButtons(){
      ['attackBtn','defendBtn','dodgeBtn','itemBtn','passBtn'].forEach(id=>{
        const b = document.getElementById(id);
        if (b) b.disabled = true;
      });
    }

    function updateActionButtons(){
      const enabled = canAct();
      ['attackBtn','defendBtn','dodgeBtn','itemBtn','passBtn'].forEach(id=>{
        const b = document.getElementById(id);
        if (b) b.disabled = !enabled;
      });
    }

    function hideOverlays(){
      elements.actionOverlay.classList.remove('show');
      elements.itemOverlay.classList.remove('show');
      currentAction = null;
    }

    function selectTarget(target){
      executeAction({ type: currentAction, targetId: target.id });
      hideOverlays();
    }

    function selectItem(item){
      executeAction({ type: 'item', item: item.type });
      hideOverlays();
    }

    function showActionOverlay(actionType){
      if (!myPlayer || !canAct()) return;

      currentAction = actionType;
      const overlay = elements.actionOverlay;
      const title = document.getElementById('actionTitle');
      const targets = document.getElementById('actionTargets');

      let list = [];
      switch(actionType){
        case 'attack':
          title.textContent = '공격 대상 선택';
          list = getEnemyPlayers();
          break;
        case 'defend':
          executeAction({ type: 'defend' }); return;
        case 'dodge':
          executeAction({ type: 'dodge' }); return;
        case 'pass':
          executeAction({ type: 'pass' }); return;
        default:
          return;
      }

      if (list.length === 0){ alert('선택 가능한 대상이 없습니다.'); return; }

      targets.innerHTML = '';
      list.forEach(t=>{
        const div = document.createElement('div');
        div.className = 'target';
        div.innerHTML = `
          <img src="${t.avatar || ''}" alt="${esc(t.name)}"
               onerror="this.style.background='#333';this.removeAttribute('src')">
          <div class="target-name">${esc(t.name)}</div>
          <div class="target-info">HP ${t.hp}/${t.maxHp}</div>`;
        div.onclick = () => selectTarget(t);
        targets.appendChild(div);
      });
      overlay.classList.add('show');
    }

    function showItemOverlay(){
      if (!myPlayer || !canAct()) return;

      const items = [];
      if (myPlayer.items?.dittany > 0)       items.push({ type:'dittany', name:'디터니', count: myPlayer.items.dittany });
      if (myPlayer.items?.attackBooster > 0) items.push({ type:'attackBooster', name:'공격 보정기', count: myPlayer.items.attackBooster });
      if (myPlayer.items?.defenseBooster > 0)items.push({ type:'defenseBooster', name:'방어 보정기', count: myPlayer.items.defenseBooster });

      if (items.length === 0){ alert('사용 가능한 아이템이 없습니다.'); return; }

      const overlay = elements.itemOverlay;
      const list = document.getElementById('itemList');
      list.innerHTML = '';
      items.forEach(it=>{
        const div = document.createElement('div');
        div.className = 'target';
        div.innerHTML = `<div class="target-name">${it.name}</div>
                         <div class="target-info">보유: ${it.count}개</div>`;
        div.onclick = () => selectItem(it);
        list.appendChild(div);
      });
      overlay.classList.add('show');
    }

    function executeAction(action){
      if (!myPlayer || !canAct() || !socket?.connected) return;
      socket.emit('player:action', { battleId, playerId: myPlayer.id, action });
      disableActionButtons();
    }

    // UI 업데이트
    function updateMyInfo(){
      if (!myPlayer) return;
      const hpPct = Math.max(0, (myPlayer.hp / myPlayer.maxHp) * 100);
      const teamLabel = `${myPlayer.team}팀`;

      const avatar = document.getElementById('myAvatar');
      if (avatar) avatar.src = myPlayer.avatar || '';
      const nm = document.getElementById('myName');
      if (nm) nm.textContent = myPlayer.name;
      const tm = document.getElementById('myTeam');
      if (tm) tm.textContent = teamLabel;
      const fill = document.getElementById('myHpFill');
      if (fill) fill.style.width = hpPct + '%';
      const hpText = document.getElementById('myHpText');
      if (hpText) hpText.textContent = `HP ${myPlayer.hp}/${myPlayer.maxHp}`;
      const stats = document.getElementById('myStats');
      if (stats) stats.textContent =
        `공격 ${myPlayer.stats.attack} | 방어 ${myPlayer.stats.defense} | 민첩 ${myPlayer.stats.agility} | 행운 ${myPlayer.stats.luck}`;
      const items = document.getElementById('myItems');
      if (items) items.textContent =
        `디터니 ${myPlayer.items?.dittany || 0} | 공격보정 ${myPlayer.items?.attackBooster || 0} | 방어보정 ${myPlayer.items?.defenseBooster || 0}`;

      if (elements.playerInfo) elements.playerInfo.textContent = `${myPlayer.name} (${teamLabel})`;
    }

    function renderTeam(players, containerId){
      const box = document.getElementById(containerId);
      if (!box) return;

      if (!players || players.length === 0){
        box.innerHTML = '<div class="empty-team">팀원 없음</div>';
        return;
      }

      let html = '';
      players.forEach(p=>{
        const hpPct = Math.max(0, (p.hp / (p.maxHp || 100)) * 100);
        const ready = p.ready ? '준비완료' : '대기중';
        const dead  = p.hp > 0 ? '' : ' (전투불능)';
        const isMe  = p.id === myPlayer?.id;
        const isCurrent = battleState?.currentTurn?.currentPlayer?.id === p.id;
        html += `
          <div class="player-card ${p.hp > 0 ? '' : 'dead'} ${isMe ? 'my-card' : ''} ${isCurrent ? 'current-player' : ''}">
            <div class="pc-header">
              <img src="${p.avatar || ''}" class="pc-avatar" alt="${esc(p.name)}"
                   onerror="this.style.background='#333';this.removeAttribute('src')"/>
              <div class="pc-info">
                <div class="pc-name">${esc(p.name)}${dead}${isMe ? ' (나)' : ''}${isCurrent ? ' ★' : ''}</div>
                <div class="pc-ready">${ready}</div>
              </div>
            </div>
            <div class="pc-hp">
              <div class="hp-bar"><div class="hp-fill" style="width:${hpPct}%"></div></div>
              <div class="hp-text">HP ${p.hp}/${p.maxHp || 100}</div>
            </div>
            <div class="pc-stats">
              공격 ${p.stats?.attack || 0} | 방어 ${p.stats?.defense || 0} | 민첩 ${p.stats?.agility || 0} | 행운 ${p.stats?.luck || 0}
            </div>
          </div>`;
      });
      box.innerHTML = html;
    }

    function updateTeams(){
      if (!battleState) return;
      const mine = battleState.players?.filter(p=>p.team === myPlayer?.team) || [];
      const enemy= battleState.players?.filter(p=>p.team !== myPlayer?.team) || [];
      renderTeam(mine,'myTeamContainer');
      renderTeam(enemy,'enemyTeamContainer');
    }

    function updateBattleStatus(){
      if (!battleState) return;

      const statusText = {
        waiting: '전투 대기 중',
        active:  '전투 진행 중',
        paused:  '일시정지',
        ended:   '전투 종료'
      }[battleState.status] || '알 수 없음';

      elements.battleStatus.textContent = statusText;
      elements.battleStatus.className = `status-pill ${battleState.status}`;

      if (battleState.currentTurn && battleState.status === 'active'){
        const turn = battleState.currentTurn;
        elements.turnInfo.textContent = `${turn.turnNumber}라운드 - ${turn.currentTeam}팀 차례`;
        elements.roundNumber.textContent = turn.turnNumber ?? '-';
        elements.currentTeamTurn.textContent = turn.currentTeam ?? '-';

        if (turn.currentPlayer){
          elements.currentPlayerAvatar.src = turn.currentPlayer.avatar || '';
          elements.currentPlayerName.textContent = turn.currentPlayer.name;
          elements.currentPlayerTeam.textContent = `${turn.currentPlayer.team}팀`;
          if (myPlayer && turn.currentPlayer.id === myPlayer.id){
            elements.currentPlayerAction.textContent = '내 차례입니다!';
            elements.currentPlayerAction.style.color = 'var(--gold-1)';
          } else {
            elements.currentPlayerAction.textContent = '행동 선택 중...';
            elements.currentPlayerAction.style.color = 'var(--ink)';
          }
        } else {
          elements.currentPlayerName.textContent = '대기 중';
          elements.currentPlayerTeam.textContent = '-';
          elements.currentPlayerAction.textContent = '플레이어 없음';
        }
      } else {
        elements.turnInfo.textContent = '턴 정보 없음';
        elements.roundNumber.textContent = '-';
        elements.currentTeamTurn.textContent = '-';
        elements.currentPlayerName.textContent = '대기 중';
        elements.currentPlayerTeam.textContent = '-';
        elements.currentPlayerAction.textContent = '전투 대기 중';
      }
    }

    function showGameOver(winner){
      const overlay = elements.gameOverOverlay;
      const winnerEl = document.getElementById('winnerTeam');
      const msgEl = document.getElementById('gameOverMessage');
      if (winnerEl) winnerEl.textContent = `${winner}팀`;
      if (myPlayer){
        if (winner === myPlayer.team){
          msgEl.textContent = '축하합니다! 승리했습니다!';
          msgEl.style.color = 'var(--gold-1)';
        } else {
          msgEl.textContent = '아쉽게도 패배했습니다.';
          msgEl.style.color = 'var(--ink-dim)';
        }
      }
      overlay.classList.add('show');
    }

    function render(){
      if (!battleState) return;
      updateBattleStatus();
      updateActionButtons();
      updateTeams();
      renderLogs();
      if (myPlayer) updateMyInfo();
    }

    // 소켓
    function initializeSocket(){
      try {
        if (socket){
          socket.removeAllListeners();
          socket.disconnect();
        }
        socket = io({
          path: '/socket.io',
          transports: ['websocket','polling'],
          upgrade: true,
          rememberUpgrade: true,
          timeout: 20000,
          forceNew: true
        });
        setupSocketEvents();
      } catch (e){
        console.error('소켓 초기화 실패:', e);
        addLog({ ts: Date.now(), type:'error', message:'서버 연결 초기화 실패' });
      }
    }

    function setupSocketEvents(){
      socket.on('connect', ()=>{
        connectionRetries = 0;
        addLog({ ts: Date.now(), type:'notice', message:'서버에 연결되었습니다' });
        socket.emit('join', { battleId });

        if (token || playerName){
          socket.emit('playerAuth', { battleId, name: playerName, token, team: null });
        } else {
          elements.nameInputOverlay.style.display = 'flex';
        }
      });

      socket.on('disconnect', (reason)=>{
        addLog({ ts: Date.now(), type:'error', message:'서버 연결이 끊어졌습니다: ' + reason });
        if (connectionRetries < maxRetries){
          connectionRetries++;
          setTimeout(()=>{
            addLog({ ts: Date.now(), type:'notice', message:`재연결 시도 중... (${connectionRetries}/${maxRetries})` });
            initializeSocket();
          }, 2000 * connectionRetries);
        }
      });

      socket.on('connect_error', (err)=>{
        console.error('연결 오류:', err);
        addLog({ ts: Date.now(), type:'error', message:'서버 연결 오류' });
      });

      // 인증
      socket.on('authSuccess', (data)=>{
        myPlayer = battleState?.players?.find(p=>p.id === data.playerId) || myPlayer;
        elements.nameInputOverlay.style.display = 'none';
        render();
      });
      socket.on('auth:success', (data)=>{
        myPlayer = battleState?.players?.find(p=>p.id === data.playerId) || myPlayer;
        elements.nameInputOverlay.style.display = 'none';
        render();
      });
      socket.on('authError', (data)=>{
        alert('인증에 실패했습니다: ' + (data?.error || '알 수 없는 오류'));
      });

      // 상태 업데이트
      socket.on('battleUpdate', (data)=>{
        battleState = data;
        if (myPlayer){
          const up = battleState?.players?.find(p=>p.id === myPlayer.id);
          if (up) myPlayer = up;
        }
        render();
      });
      socket.on('battle:update', (data)=>{
        battleState = data;
        if (myPlayer){
          const up = battleState?.players?.find(p=>p.id === myPlayer.id);
          if (up) myPlayer = up;
        }
        render();
      });

      // 로그/채팅
      socket.on('battle:log', addLog);
      socket.on('battleLog', addLog);
      socket.on('chatMessage', addChat);
      socket.on('battle:chat', addChat);

      // 액션 응답
      socket.on('actionSuccess', ()=>{ /* no-op */ });
      socket.on('player:action:success', ()=>{ /* no-op */ });
      socket.on('actionError', (data)=>{
        alert('행동 실패: ' + (data?.error || '알 수 없는 오류'));
        updateActionButtons();
      });

      // 종료
      socket.on('battle:ended', (data)=>{
        showGameOver(data?.winner ?? '-');
      });
    }

    // 이벤트 바인딩
    // 입장/엔터
    if (elements.joinBtn) elements.joinBtn.addEventListener('click', authenticate);
    if (elements.nameInput) elements.nameInput.addEventListener('keypress', (e)=>{
      if (e.key === 'Enter'){ e.preventDefault(); authenticate(); }
    });

    // 준비
    if (elements.readyBtn) elements.readyBtn.addEventListener('click', toggleReady);

    // 액션 버튼
    const attackBtn = document.getElementById('attackBtn');
    const defendBtn = document.getElementById('defendBtn');
    const dodgeBtn  = document.getElementById('dodgeBtn');
    const itemBtn   = document.getElementById('itemBtn');
    const passBtn   = document.getElementById('passBtn');

    if (attackBtn) attackBtn.addEventListener('click', ()=> showActionOverlay('attack'));
    if (defendBtn) defendBtn.addEventListener('click', ()=> showActionOverlay('defend'));
    if (dodgeBtn)  dodgeBtn.addEventListener('click', ()=> showActionOverlay('dodge'));
    if (itemBtn)   itemBtn.addEventListener('click', showItemOverlay);
    if (passBtn)   passBtn.addEventListener('click', ()=> showActionOverlay('pass'));

    // 오버레이 닫기
    const cancelAction = document.getElementById('cancelAction');
    const cancelItem   = document.getElementById('cancelItem');
    if (cancelAction) cancelAction.addEventListener('click', hideOverlays);
    if (cancelItem)   cancelItem.addEventListener('click', hideOverlays);

    if (elements.actionOverlay) elements.actionOverlay.addEventListener('click', (e)=>{
      if (e.target === elements.actionOverlay) hideOverlays();
    });
    if (elements.itemOverlay) elements.itemOverlay.addEventListener('click', (e)=>{
      if (e.target === elements.itemOverlay) hideOverlays();
    });

    // 채팅
    if (elements.chatSend) elements.chatSend.addEventListener('click', sendChat);
    if (elements.chatInput) elements.chatInput.addEventListener('keypress', (e)=>{
      if (e.key === 'Enter'){ e.preventDefault(); sendChat(); }
    });

    // 초기 이름오버레이 표시 규칙
    if (!token && !playerName){
      elements.nameInputOverlay.style.display = 'flex';
    } else {
      elements.nameInputOverlay.style.display = 'none';
    }

    // 시작
    initializeSocket();
  })();
  </script>
</body>
</html>
