<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PYXIS 전투</title>
  <style>
    :root{
      --deep-navy:#0B1117; --dark-navy:#131B24; --mid-navy:#1A242F; --light-navy:#2A3441;
      --gold-1:#DCC7A2; --gold-2:#D4BA8D; --gold-bright:#E6D5B7; --gold-shimmer:#F2E8D4;
      --border:#2A3441; --border-light:#3A4451; --border-subtle:#1F2937; --border-gold:#DCC7A2;
      --glass-1:rgba(26,36,47,.65); --glass-2:rgba(26,36,47,.85); --glass-3:rgba(26,36,47,.95);
      --blur-light:blur(4px); --blur-medium:blur(8px); --blur-heavy:blur(12px);
      --text:#E5E7EB; --text-dim:#9CA3AF; --text-muted:#6B7280; --text-accent:#DCC7A2;
      --success:#10B981; --warning:#F59E0B; --danger:#EF4444; --info:#3B82F6;
      --shadow:0 4px 16px rgba(0,0,0,.25); --shadow-soft:0 2px 8px rgba(0,0,0,.15);
      --radius:12px; --radius-sm:8px; --radius-small:6px; --transition:.2s cubic-bezier(.4,0,.2,1);
    }
    body{ margin:0; font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto; background:linear-gradient(135deg,var(--deep-navy) 0%,var(--dark-navy) 100%); color:var(--text); min-height:100vh; overflow-x:hidden; }
    *{ box-sizing:border-box; }

    .header{
      background:var(--glass-3); border-bottom:var(--border);
      backdrop-filter:var(--blur-medium); position:sticky; top:0; z-index:1000;
      padding:12px 0;
    }
    .header-container{ max-width:1600px; margin:0 auto; padding:0 16px; display:flex; align-items:center; justify-content:center; }
    .pyxis-logo{ font-family:Cinzel,serif; font-size:24px; font-weight:700; color:var(--gold-bright); letter-spacing:.08em; }
    .subtitle{ font-size:12px; color:var(--text-dim); margin-top:2px; text-align:center; }

    /* 인증 화면 */
    .auth-view{
      display:flex; align-items:center; justify-content:center; min-height:calc(100vh - 60px);
    }
    .auth-card{
      background:var(--glass-2); border:var(--border-light); border-radius:var(--radius);
      padding:28px; box-shadow:var(--shadow-soft); max-width:380px; width:90%;
      backdrop-filter:var(--blur-medium);
    }
    .auth-title{
      font-family:Cinzel,serif; font-size:18px; font-weight:600; color:var(--gold-bright);
      text-align:center; margin-bottom:20px;
    }
    .form-group{ margin-bottom:16px; }
    .form-label{ display:block; font-size:12px; font-weight:600; color:var(--text-muted); margin-bottom:6px; }
    .form-input{
      width:100%; background:var(--glass-1); border:var(--border); border-radius:8px;
      color:var(--text); font-size:14px; padding:10px 12px; outline:none;
      transition:border-color .2s, box-shadow .2s;
    }
    .form-input:focus{ border-color:var(--gold-1); box-shadow:0 0 0 2px rgba(212,183,126,.16); }
    .btn{
      background:linear-gradient(135deg,var(--gold-1), var(--gold-2));
      color:#0B1117; border:1px solid var(--gold-1); border-radius:8px;
      font-weight:700; font-size:13px; letter-spacing:.04em; padding:10px 14px; cursor:pointer;
      box-shadow:0 2px 8px rgba(212,183,126,.22); transition:all var(--transition);
      outline:none; text-transform:uppercase; width:100%;
    }
    .btn:hover{ background:linear-gradient(135deg,var(--gold-bright),var(--gold-shimmer)); box-shadow:0 4px 12px rgba(212,183,126,.35); transform:translateY(-1px); }
    .btn:disabled{ background:rgba(107,114,128,.3); color:rgba(255,255,255,.4); box-shadow:none; transform:none; cursor:not-allowed; }

    /* 메인 UI - 더 컴팩트하게 */
    .main-container{ 
      max-width:1600px; margin:0 auto; padding:12px 16px; 
      display:none; min-height:calc(100vh - 60px);
    }
    .main-container.show{ display:block; }

    .status-alert{
      background:var(--glass-2); border:var(--border-light); border-radius:var(--radius-small);
      padding:12px; margin-bottom:16px; text-align:center;
    }
    .status-alert.waiting{ border-color:var(--warning); background:rgba(245,158,11,.1); }
    .status-alert.active{ border-color:var(--success); background:rgba(16,185,129,.1); }
    .status-alert.ended{ border-color:var(--text-muted); background:rgba(107,114,128,.1); }
    .alert-title{ font-family:Cinzel,serif; font-size:14px; font-weight:600; margin-bottom:2px; }
    .alert-message{ font-size:11px; color:var(--text-dim); }

    /* 컴팩트 그리드 - 세로 긴 형태에 맞춤 */
    .game-grid{
      display:grid; 
      grid-template-columns:240px 1fr 280px; 
      gap:16px; 
      align-items:start;
      height:calc(100vh - 120px);
    }

    .card{
      background:var(--glass-2); border:var(--border-light); border-radius:var(--radius-sm);
      box-shadow:var(--shadow-soft); padding:14px; backdrop-filter:var(--blur-medium);
      transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .card:hover{ transform:translateY(-1px); box-shadow:var(--shadow); border-color:var(--gold-2); }
    .card-title{
      font-family:Cinzel,serif; font-weight:700; color:var(--gold-bright);
      border-bottom:var(--border-subtle); padding-bottom:8px; margin-bottom:12px; font-size:14px;
    }

    /* 팀 정보 - 더 컴팩트 */
    .team-info{ display:flex; flex-direction:column; gap:12px; }
    .team-card{
      background:var(--glass-1); border:var(--border); border-radius:var(--radius-small);
      padding:12px; min-height:150px;
    }
    .team-name{
      font-family:Cinzel,serif; font-weight:600; color:var(--gold-bright);
      margin-bottom:8px; text-align:center; font-size:16px; letter-spacing:1px;
    }

    .team-roster{ display:flex; flex-direction:column; gap:6px; }
    .player-item{
      background:var(--glass-1); border:var(--border-subtle); border-radius:6px;
      padding:8px; display:flex; align-items:center; gap:8px;
    }
    .player-avatar{
      width:32px; height:32px; border-radius:50%; background:var(--gold-1);
      display:flex; align-items:center; justify-content:center; font-weight:700;
      color:var(--deep-navy); font-size:12px; flex-shrink:0;
    }
    .player-details{ flex:1; }
    .player-name{ font-weight:600; margin-bottom:1px; font-size:12px; }
    .player-stats{ font-size:9px; color:var(--text-muted); }
    .player-hp{
      width:45px; text-align:right; font-size:10px; font-weight:600;
      color:var(--success);
    }

    /* 내 정보 + 액션 - 컴팩트 */
    .player-actions{ display:flex; flex-direction:column; gap:12px; }
    .player-info-card{
      background:var(--glass-1); border:var(--border); border-radius:var(--radius-small);
      padding:12px; text-align:center;
    }
    .player-avatar-large{
      width:60px; height:60px; border-radius:50%; background:var(--gold-1);
      display:flex; align-items:center; justify-content:center; font-weight:700;
      color:var(--deep-navy); font-size:18px; margin:0 auto 8px;
    }
    .player-name-large{ font-weight:700; font-size:14px; margin-bottom:6px; }
    .player-team{ font-size:11px; color:var(--text-muted); margin-bottom:8px; }

    .player-stats-grid{
      display:grid; grid-template-columns:repeat(4, 1fr); gap:6px; margin-bottom:8px;
    }
    .stat-item{
      background:var(--glass-1); border:var(--border-subtle); border-radius:4px;
      padding:4px; text-align:center;
    }
    .stat-label{ font-size:9px; color:var(--text-muted); margin-bottom:2px; }
    .stat-value{ font-weight:700; font-size:12px; color:var(--gold-bright); }

    .player-hp-section{ margin-bottom:8px; }
    .hp-label{ font-size:10px; color:var(--text-muted); margin-bottom:4px; }
    .hp-bar-large{
      height:16px; background:rgba(0,0,0,.3); border-radius:8px;
      overflow:hidden; border:1px solid var(--border-subtle); position:relative;
    }
    .hp-fill{ height:100%; background:linear-gradient(90deg,var(--success),#2ecc71); transition:width .3s ease; }
    .hp-text{
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      font-size:10px; font-weight:700; color:white; z-index:2;
    }

    .items-section{ margin-bottom:12px; }
    .items-grid{
      display:grid; grid-template-columns:repeat(3, 1fr); gap:4px;
    }
    .item-box{
      background:var(--glass-1); border:var(--border-subtle); border-radius:4px;
      padding:4px; text-align:center;
    }
    .item-name{ font-size:8px; color:var(--text-muted); margin-bottom:1px; }
    .item-count{ font-weight:700; font-size:11px; color:var(--gold-bright); }

    .turn-info{
      background:var(--glass-1); border:var(--border); border-radius:var(--radius-small);
      padding:8px; text-align:center; margin-bottom:12px;
    }
    .turn-status{ font-size:11px; color:var(--text-muted); }

    .action-buttons{
      display:grid; grid-template-columns:repeat(3, 1fr); gap:6px;
    }
    .action-btn{
      background:var(--glass-1); border:var(--border); border-radius:6px;
      padding:8px 6px; cursor:pointer; transition:all var(--transition);
      font-size:11px; font-weight:600; text-align:center; color:var(--text);
    }
    .action-btn:hover{
      background:var(--glass-2); border-color:var(--gold-2);
      transform:translateY(-1px);
    }
    .action-btn:disabled{
      opacity:0.5; cursor:not-allowed; transform:none;
    }
    .action-btn.primary{
      background:linear-gradient(135deg,var(--gold-1),var(--gold-2));
      color:var(--deep-navy); border-color:var(--gold-1);
    }

    /* 로그 + 채팅 - 컴팩트 */
    .log-chat{ display:flex; flex-direction:column; gap:12px; }
    .log-container{
      height:200px; overflow-y:auto; background:var(--glass-1);
      border:var(--border); border-radius:var(--radius-small); padding:8px;
    }
    .log-entry{
      padding:4px 0; border-bottom:1px dashed var(--border-subtle);
      font-size:10px; line-height:1.3;
    }
    .log-entry:last-child{ border-bottom:none; }
    .log-time{ color:var(--text-muted); margin-right:6px; }
    .log-system{ color:var(--info); }
    .log-battle{ color:var(--text); }

    .chat-section{
      flex:1; display:flex; flex-direction:column;
    }
    .chat-container{
      flex:1; overflow-y:auto; background:var(--glass-1);
      border:var(--border); border-radius:var(--radius-small); padding:8px;
      margin-bottom:8px; min-height:150px;
    }
    .chat-entry{
      padding:4px 0; border-bottom:1px dashed var(--border-subtle);
      font-size:10px; line-height:1.3;
    }
    .chat-entry:last-child{ border-bottom:none; }
    .chat-time{ color:var(--text-muted); margin-right:6px; }
    .chat-name{ font-weight:600; color:var(--gold-1); margin-right:4px; }

    .chat-input{
      display:flex; gap:6px;
    }
    .chat-input input{
      flex:1; background:var(--glass-1); border:var(--border); border-radius:6px;
      color:var(--text); font-size:11px; padding:6px 8px; outline:none;
    }
    .chat-input button{
      background:var(--gold-1); color:var(--deep-navy); border:none; border-radius:6px;
      padding:6px 10px; font-size:10px; font-weight:600; cursor:pointer;
    }

    /* 모달 */
    .modal{
      position:fixed; inset:0; background:rgba(0,0,0,.7); display:flex;
      align-items:center; justify-content:center; z-index:1000;
    }
    .modal-content{
      background:var(--glass-2); border:var(--border-light); border-radius:var(--radius);
      padding:20px; max-width:400px; width:90%; backdrop-filter:var(--blur-medium);
    }
    .modal-title{
      font-family:Cinzel,serif; font-size:16px; font-weight:600; color:var(--gold-bright);
      margin-bottom:12px; text-align:center;
    }
    .target-list{
      display:flex; flex-direction:column; gap:6px; max-height:200px; overflow:auto;
    }
    .target-row{
      display:flex; justify-content:space-between; align-items:center;
      border:var(--border-subtle); background:var(--glass-1); border-radius:6px; padding:8px;
    }

    .hidden{ display:none !important; }

    /* 반응형 - 세로 긴 형태에 맞춤 */
    @media (max-width:1400px){ 
      .game-grid{ grid-template-columns:220px 1fr 260px; gap:12px; } 
    }
    @media (max-width:1200px){ 
      .game-grid{ grid-template-columns:200px 1fr 240px; gap:10px; } 
      .main-container{ padding:10px 12px; }
    }
    @media (max-width:900px){
      .game-grid{ 
        grid-template-columns:1fr; gap:12px; 
        height:auto;
      }
      .team-info{ 
        display:grid; grid-template-columns:1fr 1fr; gap:12px; 
      }
      .action-buttons{ grid-template-columns:repeat(2, 1fr); }
    }
    @media (max-width:600px){
      .team-info{ grid-template-columns:1fr; }
      .action-buttons{ grid-template-columns:1fr; }
      .player-stats-grid{ grid-template-columns:repeat(2, 1fr); }
    }

    /* 스크롤바 */
    .chat-container::-webkit-scrollbar, .log-container::-webkit-scrollbar, .target-list::-webkit-scrollbar{ width:4px; }
    .chat-container::-webkit-scrollbar-track, .log-container::-webkit-scrollbar-track, .target-list::-webkit-scrollbar-track{ background:var(--glass-1); border-radius:2px; }
    .chat-container::-webkit-scrollbar-thumb, .log-container::-webkit-scrollbar-thumb, .target-list::-webkit-scrollbar-thumb{ background:linear-gradient(to bottom,var(--gold-1),var(--gold-2)); border-radius:2px; }
  </style>
</head>
<body>
  <script src="/socket.io/socket.io.js"></script>

  <!-- 헤더 -->
  <header class="header">
    <div class="header-container">
      <div class="pyxis-logo">PYXIS</div>
      <div class="subtitle">전투 시스템</div>
    </div>
  </header>

  <!-- 인증 화면 -->
  <div class="auth-view" id="authView">
    <div class="auth-card">
      <div class="auth-title">전투 참가자 인증</div>
      <div class="form-group">
        <label class="form-label">비밀번호</label>
        <input type="password" class="form-input" id="otpInput" placeholder="관리자가 제공한 비밀번호를 입력하세요" maxlength="40">
      </div>
      <button class="btn" id="loginBtn">전투 입장</button>
      <div id="authError" class="hidden" style="color:var(--danger); margin-top:12px; font-size:11px;"></div>
    </div>
  </div>

  <!-- 메인 UI -->
  <div class="main-container" id="gameView">
    <div class="status-alert waiting" id="statusAlert">
      <div class="alert-title">전투 대기중</div>
      <div class="alert-message">관리자가 전투를 시작할 때까지 대기해주세요.</div>
    </div>

    <div class="game-grid">
      <!-- 좌: 팀 정보 -->
      <div class="team-info">
        <div class="card">
          <div class="card-title">A팀</div>
          <div class="team-card">
            <div class="team-name">A</div>
            <div class="team-roster" id="teamA-roster">
              <div style="text-align:center;color:var(--text-muted);padding:30px 0;font-size:10px">팀원이 없습니다</div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">B팀</div>
          <div class="team-card">
            <div class="team-name">B</div>
            <div class="team-roster" id="teamB-roster">
              <div style="text-align:center;color:var(--text-muted);padding:30px 0;font-size:10px">팀원이 없습니다</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 중: 내 정보 + 액션 -->
      <div class="player-actions">
        <div class="card">
          <div class="card-title">내 정보</div>
          <div class="player-info-card">
            <div class="player-avatar-large" id="playerAvatar"></div>
            <div class="player-name-large" id="playerName">전투 참가자</div>
            <div class="player-team" id="playerTeam">팀 없음</div>

            <div class="player-stats-grid">
              <div class="stat-item"><div class="stat-label">공격</div><div class="stat-value" id="statAttack">1</div></div>
              <div class="stat-item"><div class="stat-label">방어</div><div class="stat-value" id="statDefense">1</div></div>
              <div class="stat-item"><div class="stat-label">민첩</div><div class="stat-value" id="statAgility">1</div></div>
              <div class="stat-item"><div class="stat-label">행운</div><div class="stat-value" id="statLuck">1</div></div>
            </div>

            <div class="player-hp-section">
              <div class="hp-label">체력</div>
              <div class="hp-bar-large">
                <div class="hp-fill" id="hpFill" style="width:100%"></div>
                <div class="hp-text" id="hpText">100/100</div>
              </div>
            </div>

            <div class="items-section">
              <div class="hp-label">아이템</div>
              <div class="items-grid">
                <div class="item-box">
                  <div class="item-name">디터니</div>
                  <div class="item-count" id="itemDitany">0</div>
                </div>
                <div class="item-box">
                  <div class="item-name">공격보정</div>
                  <div class="item-count" id="itemAttack">0</div>
                </div>
                <div class="item-box">
                  <div class="item-name">방어보정</div>
                  <div class="item-count" id="itemDefense">0</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">행동</div>
          <div class="turn-info">
            <div class="turn-status" id="turnStatus">차례를 기다리고 있습니다</div>
          </div>
          <div class="action-buttons">
            <button class="action-btn primary" id="btnAttack">공격</button>
            <button class="action-btn" id="btnDefend">방어</button>
            <button class="action-btn" id="btnDodge">회피</button>
            <button class="action-btn" id="btnItem">아이템</button>
            <button class="action-btn" id="btnPass">패스</button>
            <div></div>
          </div>
        </div>
      </div>

      <!-- 우: 로그 + 채팅 -->
      <div class="log-chat">
        <div class="card">
          <div class="card-title">전투 로그</div>
          <div class="log-container" id="battleLog"></div>
        </div>

        <div class="card chat-section">
          <div class="card-title">채팅</div>
          <div class="chat-container" id="chatContainer"></div>
          <div class="chat-input">
            <input type="text" id="chatInput" placeholder="메시지 입력..." maxlength="100">
            <button id="btnSendChat">전송</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 대상 선택 모달 -->
  <div class="modal hidden" id="targetModal">
    <div class="modal-content">
      <div class="modal-title" id="targetTitle">대상 선택</div>
      <div class="target-list" id="targetList"></div>
      <div style="margin-top:12px; text-align:center;">
        <button class="btn" id="cancelTarget">취소</button>
      </div>
    </div>
  </div>

  <!-- 아이템 사용 모달 -->
  <div class="modal hidden" id="itemModal">
    <div class="modal-content">
      <div class="modal-title">아이템 사용</div>
      <div class="target-list">
        <div class="target-row">
          <span>디터니 (회복)</span>
          <button class="btn" id="useHealPotion">사용</button>
        </div>
        <div class="target-row">
          <span>공격 보정기</span>
          <button class="btn" id="useAttackBoost">사용</button>
        </div>
        <div class="target-row">
          <span>방어 보정기</span>
          <button class="btn" id="useDefenseBoost">사용</button>
        </div>
      </div>
      <div style="margin-top:12px; text-align:center;">
        <button class="btn" id="cancelItemUse">취소</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    'use strict';

    // 전역 변수
    let socket = null;
    let battleId = null;
    let battle = null;
    let player = { id: null, name: '', team: '', hp: 100, maxHp: 100, stats: {}, items: {} };

    // DOM 요소
    const authView = document.getElementById('authView');
    const gameView = document.getElementById('gameView');
    const otpInput = document.getElementById('otpInput');
    const loginBtn = document.getElementById('loginBtn');
    const authError = document.getElementById('authError');
    
    const statusAlert = document.getElementById('statusAlert');
    const teamARoster = document.getElementById('teamA-roster');
    const teamBRoster = document.getElementById('teamB-roster');
    
    const playerAvatar = document.getElementById('playerAvatar');
    const playerName = document.getElementById('playerName');
    const playerTeam = document.getElementById('playerTeam');
    const statAttack = document.getElementById('statAttack');
    const statDefense = document.getElementById('statDefense');
    const statAgility = document.getElementById('statAgility');
    const statLuck = document.getElementById('statLuck');
    const hpFill = document.getElementById('hpFill');
    const hpText = document.getElementById('hpText');
    const itemDitany = document.getElementById('itemDitany');
    const itemAttack = document.getElementById('itemAttack');
    const itemDefense = document.getElementById('itemDefense');
    
    const turnStatus = document.getElementById('turnStatus');
    const btnAttack = document.getElementById('btnAttack');
    const btnDefend = document.getElementById('btnDefend');
    const btnDodge = document.getElementById('btnDodge');
    const btnItem = document.getElementById('btnItem');
    const btnPass = document.getElementById('btnPass');
    
    const battleLog = document.getElementById('battleLog');
    const chatContainer = document.getElementById('chatContainer');
    const chatInput = document.getElementById('chatInput');
    const btnSendChat = document.getElementById('btnSendChat');
    
    const targetModal = document.getElementById('targetModal');
    const targetTitle = document.getElementById('targetTitle');
    const targetList = document.getElementById('targetList');
    const cancelTarget = document.getElementById('cancelTarget');
    
    const itemModal = document.getElementById('itemModal');
    const useHealPotion = document.getElementById('useHealPotion');
    const useAttackBoost = document.getElementById('useAttackBoost');
    const useDefenseBoost = document.getElementById('useDefenseBoost');
    const cancelItemUse = document.getElementById('cancelItemUse');

    // URL 파라미터에서 정보 추출
    function extractParams(){
      const params = new URLSearchParams(window.location.search);
      battleId = params.get('battle');
      const token = params.get('token');
      const playerId = params.get('playerId');
      const name = params.get('name');
      const team = params.get('team');
      
      if(token) otpInput.value = token;
      if(playerId) player.id = playerId;
      if(name) player.name = name;
      if(team) player.team = team;
      
      if(battleId && token){
        authenticate();
      }
    }

    // 인증
    async function authenticate(){
      const token = otpInput.value.trim();
      if(!token){
        showError('비밀번호를 입력해주세요.');
        return;
      }

      if(!battleId){
        showError('유효한 전투 ID가 필요합니다.');
        return;
      }

      loginBtn.disabled = true;
      loginBtn.textContent = '인증중...';
      hideError();

      try{
        await connectSocket();
        socket.emit('playerAuth', { 
          battleId, 
          token, 
          playerId: player.id,
          name: player.name,
          team: player.team 
        }, (result) => {
          if(result && result.ok){
            battle = result.battle;
            player = { ...player, ...result.player };
            showGame();
            updateUI();
          } else {
            showError(result?.error || '인증 실패');
          }
          loginBtn.disabled = false;
          loginBtn.textContent = '전투 입장';
        });
      } catch(e) {
        showError('연결 실패: ' + (e.message || e));
        loginBtn.disabled = false;
        loginBtn.textContent = '전투 입장';
      }
    }

    // 소켓 연결
    function connectSocket(){
      return new Promise((resolve, reject) => {
        if(socket){
          socket.disconnect();
        }

        socket = io(window.location.origin, {
          path: '/socket.io',
          transports: ['websocket', 'polling'],
          timeout: 10000
        });

        socket.on('connect', () => {
          resolve();
        });

        socket.on('connect_error', (error) => {
          reject(error);
        });

        socket.on('authSuccess', (result) => {
          if(result && result.battle){
            battle = result.battle;
            if(result.player) player = { ...player, ...result.player };
            showGame();
            updateUI();
          }
        });

        socket.on('authError', (error) => {
          showError(error?.error || '인증 실패');
        });

        socket.on('battleUpdate', (updatedBattle) => {
          battle = updatedBattle;
          updateUI();
        });

        socket.on('battle:update', (updatedBattle) => {
          battle = updatedBattle;
          updateUI();
        });

        socket.on('battle:log', (entry) => {
          addLogEntry(entry);
        });

        socket.on('chatMessage', (message) => {
          addChatMessage(message);
        });

        socket.on('chat:message', (message) => {
          addChatMessage(message);
        });
      });
    }

    // UI 표시/숨김
    function showGame(){
      authView.style.display = 'none';
      gameView.classList.add('show');
    }

    function showError(message){
      authError.textContent = message;
      authError.classList.remove('hidden');
    }

    function hideError(){
      authError.classList.add('hidden');
    }

    // UI 업데이트
    function updateUI(){
      if(!battle) return;

      updateStatusAlert();
      updatePlayerInfo();
      updateTeamRoster();
      updateActionButtons();
    }

    function updateStatusAlert(){
      const status = battle.status || 'waiting';
      statusAlert.className = `status-alert ${status}`;
      
      const title = statusAlert.querySelector('.alert-title');
      const message = statusAlert.querySelector('.alert-message');

      switch(status){
        case 'waiting':
          title.textContent = '전투 대기중';
          message.textContent = '관리자가 전투를 시작할 때까지 대기해주세요.';
          break;
        case 'active':
          title.textContent = '전투 진행중';
          message.textContent = '치열한 전투가 벌어지고 있습니다!';
          break;
        case 'paused':
          title.textContent = '전투 일시정지';
          message.textContent = '전투가 일시정지되었습니다.';
          break;
        case 'ended':
          title.textContent = '전투 종료';
          message.textContent = '전투가 종료되었습니다.';
          break;
      }
    }

    function updatePlayerInfo(){
      const initials = (player.name || 'U').trim().slice(0, 2).toUpperCase();
      playerAvatar.textContent = initials;
      playerName.textContent = player.name || '전투 참가자';
      playerTeam.textContent = `${player.team || 'A'}팀`;

      const stats = player.stats || {};
      statAttack.textContent = stats.attack || 1;
      statDefense.textContent = stats.defense || 1;
      statAgility.textContent = stats.agility || 1;
      statLuck.textContent = stats.luck || 1;

      const hp = Math.max(0, player.hp || 100);
      const maxHp = player.maxHp || 100;
      const hpPercent = Math.round((hp / maxHp) * 100);
      
      hpFill.style.width = `${hpPercent}%`;
      hpText.textContent = `${hp}/${maxHp}`;

      const items = player.items || {};
      itemDitany.textContent = items.dittany || items.ditany || 0;
      itemAttack.textContent = items.attackBooster || items.attack_boost || 0;
      itemDefense.textContent = items.defenseBooster || items.defense_boost || 0;
    }

    function updateTeamRoster(){
      const players = battle.players || [];
      const teamA = players.filter(p => p.team === 'A');
      const teamB = players.filter(p => p.team === 'B');

      renderTeam(teamARoster, teamA);
      renderTeam(teamBRoster, teamB);
    }

    function renderTeam(container, players){
      if(players.length === 0){
        container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:30px 0;font-size:10px">팀원이 없습니다</div>';
        return;
      }

      container.innerHTML = players.map(p => {
        const initials = (p.name || 'U').trim().slice(0, 2).toUpperCase();
        return `
          <div class="player-item">
            <div class="player-avatar">${initials}</div>
            <div class="player-details">
              <div class="player-name">${p.name || '익명'}</div>
              <div class="player-stats">공${p.stats?.attack||1} 방${p.stats?.defense||1} 민${p.stats?.agility||1} 행${p.stats?.luck||1}</div>
            </div>
            <div class="player-hp">${p.hp||100}/100</div>
          </div>
        `;
      }).join('');
    }

    function updateActionButtons(){
      const status = battle.status || 'waiting';
      const isActive = status === 'active';
      
      turnStatus.textContent = isActive ? '행동을 선택하세요' : '차례를 기다리고 있습니다';

      btnAttack.disabled = !isActive;
      btnDefend.disabled = !isActive;
      btnDodge.disabled = !isActive;
      btnItem.disabled = !isActive;
      btnPass.disabled = !isActive;
    }

    // 액션 처리
    function performAction(actionType, target = null){
      if(!socket || !battleId || !player.id) return;

      const action = {
        type: actionType,
        playerId: player.id,
        battleId: battleId
      };

      if(target) action.target = target;

      socket.emit('playerAction', action);
      socket.emit('player:action', action);
    }

    function openTargetModal(actionType){
      const enemies = (battle.players || []).filter(p => p.team !== player.team && p.hp > 0);
      
      if(enemies.length === 0){
        alert('공격할 대상이 없습니다.');
        return;
      }

      targetTitle.textContent = '공격 대상 선택';
      targetList.innerHTML = enemies.map(enemy => `
        <div class="target-row">
          <span>${enemy.name} (${enemy.hp}/100)</span>
          <button class="btn" onclick="selectTarget('${enemy.id}', '${actionType}')">선택</button>
        </div>
      `).join('');

      targetModal.classList.remove('hidden');
    }

    window.selectTarget = function(targetId, actionType){
      targetModal.classList.add('hidden');
      performAction(actionType, targetId);
    };

    function openItemModal(){
      const items = player.items || {};
      
      useHealPotion.textContent = `사용 (${items.dittany || items.ditany || 0}개)`;
      useAttackBoost.textContent = `사용 (${items.attackBooster || items.attack_boost || 0}개)`;
      useDefenseBoost.textContent = `사용 (${items.defenseBooster || items.defense_boost || 0}개)`;

      useHealPotion.disabled = (items.dittany || items.ditany || 0) <= 0;
      useAttackBoost.disabled = (items.attackBooster || items.attack_boost || 0) <= 0;
      useDefenseBoost.disabled = (items.defenseBooster || items.defense_boost || 0) <= 0;

      itemModal.classList.remove('hidden');
    }

    // 로그 및 채팅
    function addLogEntry(entry){
      const time = new Date(entry.timestamp || Date.now()).toLocaleTimeString();
      const div = document.createElement('div');
      div.className = `log-entry log-${entry.type || 'system'}`;
      div.innerHTML = `<span class="log-time">${time}</span>${entry.message || ''}`;
      battleLog.appendChild(div);
      battleLog.scrollTop = battleLog.scrollHeight;
    }

    function addChatMessage(message){
      const time = new Date(message.timestamp || Date.now()).toLocaleTimeString();
      const div = document.createElement('div');
      div.className = 'chat-entry';
      div.innerHTML = `<span class="chat-time">${time}</span><span class="chat-name">${message.name || '익명'}:</span>${message.message || ''}`;
      chatContainer.appendChild(div);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function sendChat(){
      const message = chatInput.value.trim();
      if(!message || !socket || !battleId) return;

      socket.emit('chatMessage', {
        battleId,
        message,
        name: player.name || '전투 참가자',
        role: 'player'
      });

      chatInput.value = '';
    }

    // 이벤트 바인딩
    function bindEvents(){
      loginBtn.addEventListener('click', authenticate);
      otpInput.addEventListener('keypress', (e) => {
        if(e.key === 'Enter') authenticate();
      });

      btnAttack.addEventListener('click', () => openTargetModal('attack'));
      btnDefend.addEventListener('click', () => performAction('defend'));
      btnDodge.addEventListener('click', () => performAction('dodge'));
      btnItem.addEventListener('click', openItemModal);
      btnPass.addEventListener('click', () => performAction('pass'));

      btnSendChat.addEventListener('click', sendChat);
      chatInput.addEventListener('keypress', (e) => {
        if(e.key === 'Enter') sendChat();
      });

      cancelTarget.addEventListener('click', () => {
        targetModal.classList.add('hidden');
      });

      cancelItemUse.addEventListener('click', () => {
        itemModal.classList.add('hidden');
      });

      useHealPotion.addEventListener('click', () => {
        itemModal.classList.add('hidden');
        performAction('item', { itemType: 'dittany' });
      });

      useAttackBoost.addEventListener('click', () => {
        itemModal.classList.add('hidden');
        openTargetModal('attack_boost');
      });

      useDefenseBoost.addEventListener('click', () => {
        itemModal.classList.add('hidden');
        performAction('item', { itemType: 'defense_boost' });
      });
    }

    // 초기화
    function init(){
      bindEvents();
      extractParams();
    }

    // 시작
    init();
  })();
  </script>
</body>
</html>
