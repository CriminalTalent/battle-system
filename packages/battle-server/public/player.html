<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>PYXIS - 전투 참가자</title>
<script src="/socket.io/socket.io.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg0:#0a0a0a; --bg1:#0e0e0e; --bg2:#141414;
    --glass-1:rgba(255,255,255,.06);
    --glass-2:rgba(255,255,255,.10);
    --border:rgba(255,255,255,.14);
    --text:#F8F9FA; --muted:#A9AFB6;
    --gold:#DCC7A2; --gold2:#E6D2A8;
    --accent:#3498DB; --danger:#E74C3C;
    --radius:12px; --shadow:0 8px 16px rgba(0,0,0,.35);
    --serif:'Cinzel',serif;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{min-height:100vh;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--text);font-family:var(--serif)}
  .wrap{max-width:1400px;margin:0 auto;padding:18px;display:grid;grid-template-columns:320px 1fr 360px;gap:14px;align-items:start}
  @media (max-width:1200px){.wrap{grid-template-columns:1fr;gap:12px}}
  .card{background:var(--glass-2);border:1px solid var(--border);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
  .title{font-weight:700;color:var(--gold2);border-bottom:1px solid var(--border);padding-bottom:10px;margin-bottom:12px;letter-spacing:.5px}

  .me{display:grid;grid-template-columns:96px 1fr;gap:12px;align-items:center}
  .me img{width:96px;height:96px;border-radius:12px;object-fit:cover;border:1px solid var(--border);background:#0b0b0b}
  .badge{font-size:12px;color:var(--muted)}
  .bar{height:10px;border-radius:6px;background:rgba(255,255,255,.12);overflow:hidden;border:1px solid var(--border);margin-top:6px}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,#b58d52,#e6d2a8)}

  .stats,.items{display:grid;gap:8px}
  .stats{grid-template-columns:repeat(4,1fr)}
  .items{grid-template-columns:repeat(3,1fr)}
  .kv{background:var(--glass-1);border:1px solid var(--border);border-radius:10px;padding:8px;text-align:center;font-size:12px}
  .kv .k{font-size:11px;color:var(--muted)}
  .kv .v{font-weight:700}

  .btn{padding:10px;border-radius:10px;border:1px solid var(--border);cursor:pointer;background:linear-gradient(135deg,var(--gold),var(--gold2));color:#111;font-weight:700}
  .btn:disabled{background:#171717;color:#666;border:1px solid #222;cursor:not-allowed}

  .turnArea{display:grid;grid-template-columns:220px 1fr;gap:14px}
  @media (max-width:1000px){.turnArea{grid-template-columns:1fr}}
  .portrait{width:100%;max-width:220px;aspect-ratio:1/1;border-radius:14px;border:2px solid var(--border);object-fit:cover;background:#0b0b0b}
  .meta{display:flex;gap:8px;align-items:center;margin-bottom:10px}
  .pill{font-size:12px;border:1px solid var(--border);background:var(--glass-1);padding:6px 10px;border-radius:999px}

  .actions{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
  .act{padding:12px;border-radius:10px;border:1px solid var(--border);background:var(--glass-1);cursor:pointer;text-align:center;color:#ddd}
  .act.enabled{border-color:#c7af7b;color:#e6d2a8;font-weight:700}
  .act:disabled{opacity:.45;cursor:not-allowed}

  .teams{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
  .mini{display:flex;gap:8px;align-items:center;margin-bottom:8px;background:var(--glass-1);border:1px solid var(--border);border-radius:10px;padding:6px}
  .mini img{width:32px;height:32px;border-radius:6px;object-fit:cover;background:#0b0b0b;border:1px solid var(--border)}
  .mini .nm{font-size:12px}
  .mini .hp{font-size:11px;color:var(--muted)}

  .log{height:180px;overflow:auto;background:var(--glass-1);border:1px solid var(--border);border-radius:10px;padding:10px}
  .chatView{height:420px;display:flex;flex-direction:column;gap:8px;overflow:auto;background:var(--glass-1);border:1px solid var(--border);border-radius:10px;padding:10px}
  .entry{font-size:12px;margin-bottom:6px}
  .entry .t{color:var(--muted);margin-right:6px;font-size:10px}
  .entry.sys{color:var(--accent)}

  .chatRow{display:flex;gap:8px;margin-top:8px}
  .chatRow input{flex:1;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0b0b0b;color:var(--text)}
  .chatRow button{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:linear-gradient(135deg,var(--gold),var(--gold2));font-weight:700;cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <!-- 좌: 내 정보 + 로그 -->
  <section class="card">
    <div class="title">내 정보</div>
    <div class="me">
      <img id="meAvatar" alt="내 초상화">
      <div>
        <div id="meName" style="font-weight:700">-</div>
        <div class="badge" id="meTeam">-</div>
        <div class="bar"><span id="meHpBar" style="width:100%"></span></div>
        <div class="badge" id="meHpText">HP 100/100</div>
      </div>
    </div>

    <div class="stats" style="margin-top:12px">
      <div class="kv"><div class="k">공격</div><div id="sAtk" class="v">-</div></div>
      <div class="kv"><div class="k">방어</div><div id="sDef" class="v">-</div></div>
      <div class="kv"><div class="k">민첩</div><div id="sAgi" class="v">-</div></div>
      <div class="kv"><div class="k">행운</div><div id="sLuk" class="v">-</div></div>
    </div>

    <div class="items" style="margin-top:10px">
      <div class="kv"><div class="k">디터니</div><div id="iDit" class="v">0</div></div>
      <div class="kv"><div class="k">공격 보정기</div><div id="iAtkB" class="v">0</div></div>
      <div class="kv"><div class="k">방어 보정기</div><div id="iDefB" class="v">0</div></div>
    </div>

    <div style="margin-top:10px">
      <button id="btnReady" class="btn">준비 완료</button>
    </div>

    <div class="title" style="margin-top:12px">실시간 로그</div>
    <div id="log" class="log"></div>
  </section>

  <!-- 중: 현재 턴/행동 + 팀 리스트 -->
  <section class="card">
    <div class="title">전투</div>
    <div class="turnArea">
      <img id="turnPortrait" class="portrait" alt="현재 차례 초상화"/>
      <div>
        <div class="meta">
          <div class="pill">라운드 <span id="round">1</span></div>
          <div class="pill"><span id="turnTeam">-팀</span> 차례</div>
          <div class="pill">남은 시간 <span id="turnTimer">--:--</span></div>
        </div>
        <div class="actions">
          <button id="btnAttack" class="act" disabled>공격</button>
          <button id="btnDefend" class="act" disabled>방어</button>
          <button id="btnDodge"  class="act" disabled>회피</button>
          <button id="btnItem"   class="act" disabled>아이템</button>
          <button id="btnPass"   class="act" disabled>패스</button>
        </div>
      </div>
    </div>

    <div class="teams">
      <div>
        <div class="title" style="border:none;padding:0;margin:8px 0 6px 0;color:#e6d2a8">A팀</div>
        <div id="allyList"></div>
      </div>
      <div>
        <div class="title" style="border:none;padding:0;margin:8px 0 6px 0;color:#e6d2a8">B팀</div>
        <div id="enemyList"></div>
      </div>
    </div>
  </section>

  <!-- 우: 채팅 -->
  <section class="card">
    <div class="title">채팅</div>
    <div id="chatView" class="chatView"></div>
    <div class="chatRow">
      <input id="chatMsg" type="text" maxlength="140" placeholder="메시지 입력"/>
      <button id="btnSend">전송</button>
    </div>
  </section>
</div>

<script>
  const $ = s => document.querySelector(s);
  const escapeHtml = (t)=>String(t).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const q = new URLSearchParams(location.search);
  const battleId = q.get('battle') || '';
  const myName   = q.get('name') || '';
  const token    = q.get('password') || q.get('token') || q.get('otp') || '';
  const myTeamQS = (q.get('team')||'').toUpperCase()==='B'?'B':'A';

  const DEFAULT_AVATAR = 'data:image/svg+xml;utf8,'+encodeURIComponent(
    `<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160">
      <rect width="100%" height="100%" fill="#0b0b0b"/>
      <circle cx="80" cy="58" r="30" fill="#2b2b2b"/>
      <rect x="35" y="100" width="90" height="45" rx="12" fill="#2b2b2b"/>
    </svg>`
  );
  function setImg(el, url){ if(!el) return; el.onerror=null; el.src = url || DEFAULT_AVATAR; el.onerror=()=>{el.onerror=null; el.src=DEFAULT_AVATAR;} }

  let socket=null, me=null, snapshot=null;

  const meAvatar=$('#meAvatar'), meNameEl=$('#meName'), meTeamEl=$('#meTeam'), meHpText=$('#meHpText'), meHpBar=$('#meHpBar');
  const sAtk=$('#sAtk'), sDef=$('#sDef'), sAgi=$('#sAgi'), sLuk=$('#sLuk');
  const iDit=$('#iDit'), iAtkB=$('#iAtkB'), iDefB=$('#iDefB');

  const turnPortrait=$('#turnPortrait'), roundEl=$('#round'), turnTeamEl=$('#turnTeam'), turnTimer=$('#turnTimer');
  const btnReady=$('#btnReady');
  const btnAttack=$('#btnAttack'), btnDefend=$('#btnDefend'), btnDodge=$('#btnDodge'), btnItem=$('#btnItem'), btnPass=$('#btnPass');
  const allyList=$('#allyList'), enemyList=$('#enemyList');

  const logEl=$('#log'), chatView=$('#chatView'), chatMsg=$('#chatMsg'), btnSend=$('#btnSend');

  function addLog(msg, cls='sys'){
    const d=document.createElement('div'); d.className='entry '+cls;
    const t=new Date().toLocaleTimeString('ko-KR',{hour12:false,hour:'2-digit',minute:'2-digit'});
    d.innerHTML=`<span class="t">${t}</span>${escapeHtml(msg)}`;
    logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight;
    while(logEl.children.length>300) logEl.removeChild(logEl.firstChild);
  }
  function addChat(name,msg){
    const d=document.createElement('div'); d.className='entry';
    const t=new Date().toLocaleTimeString('ko-KR',{hour12:false,hour:'2-digit',minute:'2-digit'});
    d.innerHTML=`<span class="t">${t}</span><b>${escapeHtml(name||'익명')}</b>: ${escapeHtml(msg||'')}`;
    chatView.appendChild(d); chatView.scrollTop=chatView.scrollHeight;
    while(chatView.children.length>400) chatView.removeChild(chatView.firstChild);
  }

  function findPlayer(id){ if(!snapshot) return null; return (snapshot.players||[]).find(p=>p.id===id) || null; }

  function renderMe(){
    if(!me) return;
    meNameEl.textContent = me.name||'-';
    meTeamEl.textContent = (me.team||'A')+'팀';
    const ratio = Math.max(0, Math.min(100, Math.round((me.hp||0)/(me.maxHp||100)*100)));
    meHpBar.style.width = ratio+'%';
    meHpText.textContent = `HP ${me.hp||0}/${me.maxHp||100}`;
    sAtk.textContent=me.stats?.attack ?? '-';
    sDef.textContent=me.stats?.defense ?? '-';
    sAgi.textContent=me.stats?.agility ?? '-';
    sLuk.textContent=me.stats?.luck ?? '-';
    iDit.textContent = me.items?.dittany ?? me.items?.ditany ?? 0;
    iAtkB.textContent= me.items?.attack_boost ?? me.items?.attackBooster ?? 0;
    iDefB.textContent= me.items?.defense_boost ?? me.items?.defenseBooster ?? 0;
    setImg(meAvatar, me.avatar);
  }

  function renderTeams(){
    if(!snapshot) return;
    const A=[],B=[];
    (snapshot.players||[]).forEach(p=>{
      const row=document.createElement('div'); row.className='mini';
      const img=document.createElement('img'); setImg(img,p.avatar);
      const box=document.createElement('div');
      box.innerHTML=`<div class="nm">${escapeHtml(p.name||'-')}</div><div class="hp">HP ${p.hp||0}/${p.maxHp||100}</div>`;
      row.appendChild(img); row.appendChild(box);
      (p.team==='B'?B:A).appendChild(row);
    });
    allyList.innerHTML=''; enemyList.innerHTML='';
    (myTeamQS==='B'?B:A).childNodes.forEach(n=>allyList.appendChild(n.cloneNode(true)));
    (myTeamQS==='B'?A:B).childNodes.forEach(n=>enemyList.appendChild(n.cloneNode(true)));
  }

  function updateActionButtons(){
    // 자신의 "개인 턴"만 허용: currentTurn.currentPlayer.id === me.id 가 우선
    const curPlayer = snapshot?.currentTurn?.currentPlayer;
    let enabled = false;
    if(curPlayer?.id){
      enabled = (curPlayer.id === me?.id);
    }else{
      // currentPlayer가 없는 스냅샷일 경우 팀 턴 기준(차선)
      enabled = (snapshot?.currentTurn?.currentTeam === me?.team);
    }
    [btnAttack,btnDefend,btnDodge,btnItem,btnPass].forEach(b=>{
      b.disabled = !enabled;
      b.classList.toggle('enabled', enabled);
    });
  }

  function renderTurn(){
    if(!snapshot) return;
    roundEl.textContent = snapshot.currentTurn?.turnNumber || snapshot.turn?.round || 1;
    turnTeamEl.textContent = (snapshot.currentTurn?.currentTeam || snapshot.currentTeam || '-') + '팀';
    const cur = snapshot.currentTurn?.currentPlayer || null;
    setImg(turnPortrait, cur?.avatar || findPlayer(cur?.id)?.avatar);
    updateActionButtons();
  }

  function onUpdate(b){
    snapshot=b;
    if(me && snapshot){
      me=(snapshot.players||[]).find(p=>p.id===me.id) || me;
    }
    renderMe(); renderTeams(); renderTurn();
  }

  function bindSocket(){
    socket = io();
    socket.on('connect', ()=>{
      addLog('서버에 연결되었습니다.','sys');
      if(!battleId){ addLog('battle 파라미터가 없습니다.','sys'); return; }
      socket.emit('playerAuth',{ battleId, token, password:token, otp:token, playerName:myName }, (res)=>{
        if(!res?.ok){ addLog('인증 실패: '+(res?.message||res?.error||'오류'),'sys'); return; }
        addLog('인증 성공 · 전투 참가 완료','sys');
        me = res.playerData || null;
        snapshot = res.battle || null;
        renderMe(); renderTeams(); renderTurn();
      });
    });

    socket.on('battleUpdate', onUpdate);
    socket.on('battle:update', onUpdate);

    // 로그
    const onLog = (ev)=> addLog(ev?.message || '로그','sys');
    socket.on('battle:log', onLog);
    socket.on('battleLog', onLog);

    // 채팅/응원 → 채팅창에만
    socket.on('chatMessage', (d)=> addChat(d?.name||'익명', d?.message||''));
    socket.on('cheerMessage', (d)=> addChat(d?.name||'관전자', d?.message||''));

    // 액션 결과 알림(옵션)
    socket.on('actionSuccess', ({playerId,action})=>{
      if(!playerId) return;
      const p = findPlayer(playerId);
      if(p) addLog(`[확정] ${p.name} · ${action?.type||'action'}`,'sys');
    });
  }

  // 채팅 송신: chatMessage만 사용(중복 제거)
  btnSend.addEventListener('click', ()=>{
    const m = chatMsg.value.trim(); if(!m || !socket || !battleId) return;
    socket.emit('chatMessage', { battleId, name: myName||'전투 참가자', message: m });
    chatMsg.value='';
  });
  chatMsg.addEventListener('keydown', e=>{ if(e.key==='Enter') btnSend.click(); });

  // 준비 완료
  btnReady.addEventListener('click', ()=>{
    if(!socket || !battleId || !me?.id) return;
    btnReady.disabled = true;
    btnReady.textContent = '준비 완료됨';
    addLog('내 상태: 준비 완료','sys');
    socket.emit('player:ready', { battleId, playerId: me.id, ready:true });
  });

  // 액션 송신(자신의 턴에만 버튼 활성화됨)
  btnAttack.addEventListener('click', ()=> sendAction('attack'));
  btnDefend.addEventListener('click', ()=> sendAction('defend'));
  btnDodge .addEventListener('click', ()=> sendAction('dodge'));
  btnItem  .addEventListener('click', ()=> sendAction('item')); // 세부 종류는 기존 로직에 맞춰 확장 가능
  btnPass  .addEventListener('click', ()=> sendAction('pass'));

  function sendAction(type){
    if(!socket || !battleId || !me?.id) return;
    socket.emit('playerAction', { battleId, playerId: me.id, action:{ type } }, (res)=>{
      if(!res?.ok){
        addLog('행동 전송 실패: '+(res?.error||'오류'),'sys');
      }else{
        addLog(`액션 전송: ${type}`,'sys');
      }
    });
  }

  document.addEventListener('DOMContentLoaded', bindSocket);
</script>
</body>
</html>
