<!doctype html>
$('#def').textContent = me.stats.def;
$('#agi').textContent = me.stats.agi;
$('#luk').textContent = me.stats.luk;
$('#items').textContent = `공격보정 ${me.items.atkBooster} / 방어보정 ${me.items.defBooster} / 디터니 ${me.items.diterni}`;
$('#avatar').src = me.imageUrl || '';
}


function connect(){
socket = io();
socket.on('connect', ()=>{
socket.emit('playerAuth', { battleId, token: playerToken, name: $('#playerName').value.trim() });
});
socket.on('authError', e=> alert('인증 실패: '+(e?.code||'')) );
socket.on('authSuccess', payload=>{
me = payload.me; fill(me);
$('#loginCard').style.display='none';
$('#meCard').style.display='block';
});
socket.on('updateOk', ({ imageUrl })=>{ $('#avatar').src=imageUrl; });
socket.on('chatMessage', (m)=> addMsg(`[플레이어] ${m.from}: ${m.text}`));
socket.on('cheerMessage', (m)=> addMsg(`[관전자] ${m.from}: ${m.text}`));
}


function addMsg(t){
const d=document.createElement('div'); d.textContent=t; $('#chat').appendChild(d); $('#chat').scrollTop=99999;
}


$('#joinBtn').onclick = ()=>{
battleId = $('#battleId').value.trim();
playerToken = $('#playerToken').value.trim();
if(!battleId||!playerToken||!$('#playerName').value.trim()) return alert('모든 값을 입력');
connect();
};


$('#send').onclick = ()=>{
const t=$('#msg').value.trim(); if(!t) return;
socket.emit('chatMessage',{ text:t }); $('#msg').value='';
};


$('#uploadBtn').onclick = async ()=>{
const f=$('#file').files?.[0]; if(!f) return alert('파일 선택');
const fd=new FormData(); fd.append('image', f);
const r=await fetch('/api/upload',{method:'POST',body:fd});
const j=await r.json(); if(!j?.ok) return alert('업로드 실패');
socket.emit('updatePlayerImage',{ path:j.path });
};


$('#copyMyLink').onclick = async ()=>{
if(!battleId||!playerToken||!me) return;
const url = `${location.origin}/play?battle=${battleId}&token=${encodeURIComponent(playerToken)}&name=${encodeURIComponent(me.name)}`;
await navigator.clipboard.writeText(url); alert('복사되었습니다');
};


// URL 파라미터 사전 채움
if(qs.get('battle')) $('#battleId').value = qs.get('battle');
if(qs.get('token')) $('#playerToken').value = qs.get('token');
if(qs.get('name')) $('#playerName').value = qs.get('name');
if($('#battleId').value && $('#playerToken').value && $('#playerName').value){
battleId=$('#battleId').value; playerToken=$('#playerToken').value; connect();
}
</script>
</body>
</html>
