<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PYXIS 플레이어</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root {
      --bg: #0f1419;
      --panel: #1b1f25;
      --ink: #f5e6b8;
      --ink-dim: #9c9270;
      --accent: #d5b67a;
      --line: #313942;
      --radius: 12px;
      --font-serif: 'Cinzel', serif;
    }
    *{ box-sizing: border-box; }
    body{
      margin:0; padding:0; background:var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, sans-serif;
      color:var(--ink);
    }
    .container{ max-width:1200px; margin:auto; padding:20px; }
    header{
      font-family:var(--font-serif); font-size:32px; text-align:center; margin-bottom:16px;
      background:linear-gradient(to right,#d8c278,#ffe5a2);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }
    .status-panel{
      background:var(--panel); padding:16px; border-radius:var(--radius);
      display:flex; justify-content:space-between; gap:20px;
      border:1px solid var(--line); margin-bottom:20px;
    }
    .status-panel div{ flex:1; font-size:14px; }
    .board{ display:grid; grid-template-columns:1fr 2fr 1fr; gap:20px; }
    .team-column{
      background:var(--panel); padding:16px; border-radius:var(--radius);
      border:1px solid var(--line);
    }
    .team-column h3{ font-family:var(--font-serif); margin-bottom:12px; }
    .team-member{ padding:6px 0; border-bottom:1px solid var(--line); }
    .log-box{
      background:var(--panel); padding:16px; height:280px; overflow-y:auto;
      font-size:13px; border:1px solid var(--line); border-radius:var(--radius);
      white-space:pre-wrap; line-height:1.4;
    }
    .action-panel{ display:flex; flex-wrap:wrap; gap:10px; margin-top:16px; }
    .action-panel button{
      flex:1 1 45%; padding:12px; border-radius:var(--radius);
      background:var(--accent); color:#000; font-weight:bold; border:none; cursor:pointer;
      transition:all .2s ease;
    }
    .action-panel button:hover{ background:#ffdd95; }
    .muted{ font-size:12px; color:var(--ink-dim); }
    @media(max-width: 800px){ .board{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <header>PYXIS 전투 아레나</header>

    <div class="status-panel">
      <div>전투 상태: <span id="battleStatus">대기중</span></div>
      <div>남은 시간: <span id="turnTimer">-</span></div>
      <div>현재 팀: <span id="currentTeam">-</span></div>
    </div>

    <div class="board">
      <div class="team-column" id="team1Panel">
        <h3>불사조 기사단</h3>
        <div id="team1Players"></div>
      </div>

      <div>
        <div class="log-box" id="logBox"></div>
        <div class="action-panel">
          <button id="btnAttack">공격</button>
          <button id="btnDefend">방어</button>
          <button id="btnDodge">회피</button>
          <button id="btnItem">아이템</button>
          <button id="btnPass">턴 넘기기</button>
        </div>
        <p class="muted" id="statusMsg"></p>
      </div>

      <div class="team-column" id="team2Panel">
        <h3>죽음을 먹는 자들</h3>
        <div id="team2Players"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ===== 유틸 =====
  const $ = (s) => document.querySelector(s);
  const koTime = (ts) =>
    new Date(ts).toLocaleTimeString('ko-KR', { hour12:false });

  function escapeHtml(s = '') {
    return String(s).replace(/[&<>"']/g, m => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[m]));
  }

  // ===== 상태 =====
  let socket = null;
  let battleId = null;
  let playerId = null;
  let turnDeadlineMs = null;

  // 서버가 /api 프리픽스를 쓰는지 자동 판별해 두 경로 모두 시도
  const API_PREFIXES = ['/api', ''];
  async function tryFetchJson(method, path, body) {
    let lastText = '';
    for (const prefix of API_PREFIXES) {
      try {
        const res = await fetch(prefix + path, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: body ? JSON.stringify(body) : undefined,
        });
        const text = await res.text();
        if (res.ok) return text ? JSON.parse(text) : {};
        lastText = text;
      } catch (e) {
        lastText = e.message;
      }
    }
    throw new Error(`${method} ${path} 실패: ${lastText}`);
  }

  function setMsg(msg) { $('#statusMsg').textContent = msg || ''; }

  // ===== 렌더링 =====
  function updateTimer() {
    if (!turnDeadlineMs) return;
    const remaining = Math.max(0, turnDeadlineMs - Date.now());
    const sec = Math.floor(remaining / 1000);
    const min = Math.floor(sec / 60);
    const remSec = String(sec % 60).padStart(2, '0');
    $('#turnTimer').textContent = `${min}:${remSec}`;
    if (remaining > 0) requestAnimationFrame(updateTimer);
  }

  function renderPlayers(sidePlayers = [], mountSel) {
    const html = sidePlayers.map(p => {
      const hp = `${p.hp ?? '-'} / ${p.maxHp ?? '-'}`;
      const dead = p.alive === false ? ' (사망)' : '';
      return `<div class="team-member">${escapeHtml(p.name)} - HP: ${hp}${dead}</div>`;
    }).join('');
    $(mountSel).innerHTML = html || `<div class="muted">등록된 플레이어 없음</div>`;
  }

  function renderLog(events = []) {
    const html = events.map(e => {
      const t = koTime(e.timestamp || Date.now());
      return `[${t}] ${escapeHtml(e.message || '')}`;
    }).join('\n');
    const box = $('#logBox');
    box.textContent = html || '전투 로그 없음';
    box.scrollTop = box.scrollHeight;
  }

  function renderBattle(b) {
    if (!b) return;
    $('#battleStatus').textContent = b.status ?? '-';
    $('#currentTeam').textContent = b.currentTeam ?? '-';

    if (b.turnDeadline) {
      turnDeadlineMs = new Date(b.turnDeadline).getTime();
      updateTimer();
    }

    const t1 = b.teams?.team1?.players ?? b.team1?.players ?? [];
    const t2 = b.teams?.team2?.players ?? b.team2?.players ?? [];
    renderPlayers(t1, '#team1Players');
    renderPlayers(t2, '#team2Players');

    renderLog(b.battleLog || []);
  }

  // ===== 소켓 =====
  function connectSocket() {
    if (socket && socket.connected) return;

    // 경로 커스텀 필요 시: io({ path: '/socket.io' })
    socket = io(); // 기본 경로 사용
    socket.on('connect', () => {
      setMsg('서버 연결됨');
      socket.emit('playerAuth', { battleId, playerId });
    });
    socket.on('disconnect', () => setMsg('서버 연결 끊김'));
    socket.on('battleUpdate', renderBattle);
    socket.on('error', (e) => setMsg(`소켓 오류: ${e?.message || e}`));
  }

  function sendAction(action) {
    if (!socket || !socket.connected) {
      setMsg('아직 서버와 연결되지 않았습니다.');
      return;
    }
    if (!battleId || !playerId) {
      setMsg('배틀 참가 정보가 없습니다.');
      return;
    }
    socket.emit('playerAction', { battleId, playerId, action });
  }

  // ===== 참가 =====
  async function joinBattle() {
    const url = new URLSearchParams(location.search);
    battleId = url.get('battle');
    const name = url.get('name') || '플레이어';
    const team = url.get('team') || 'team1';

    if (!battleId) {
      setMsg('쿼리에 ?battle=배틀ID 가 필요합니다.');
      return;
    }

    // 새로고침 중복 참가 방지
    const cacheKey = `px_player_${battleId}_${name}`;
    const cached = localStorage.getItem(cacheKey);
    if (cached) {
      try {
        const parsed = JSON.parse(cached);
        if (parsed?.playerId) {
          playerId = parsed.playerId;
          setMsg('기존 세션으로 재접속합니다.');
          connectSocket();
          return;
        }
      } catch {}
    }

    try {
      const resp = await tryFetchJson('POST', `/battles/${encodeURIComponent(battleId)}/players`, {
        name, team,
        stats: { attack: 2, defense: 2, agility: 2, luck: 2 }
      });
      playerId = resp?.player?.id || resp?.id || resp?.playerId;
      if (!playerId) throw new Error('playerId 획득 실패');
      localStorage.setItem(cacheKey, JSON.stringify({ playerId, name, team }));
      setMsg('배틀 참가 완료');
      connectSocket();
    } catch (e) {
      setMsg(String(e.message || e));
      alert('참가 실패: ' + (e.message || e));
    }
  }

  // ===== 이벤트 바인딩 =====
  window.onload = () => {
    joinBattle();
    $('#btnAttack').onclick = () => sendAction('attack');
    $('#btnDefend').onclick = () => sendAction('defend');
    $('#btnDodge').onclick = () => sendAction('dodge');
    $('#btnItem').onclick   = () => sendAction('item');
    $('#btnPass').onclick   = () => sendAction('pass');
  };
})();
</script>
</body>
</html>
