<!-- packages/battle-server/public/play.html -->
<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>PYXIS 플레이어</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&display=swap" rel="stylesheet">
<script src="/socket.io/socket.io.js"></script>
<style>
  :root{
    --gold:#c9a96e;
    --ink:#e9e3d0; --ink-dim:#bfb7a5;
    --bg:#0a0f1a; --panel:#0c1326; --panel2:#0b1020;
    --line:#20283c; --line2:#1a2234;
    --blur: blur(10px) saturate(120%);
    --lift: 0 10px 22px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 600px at 20% -10%, rgba(201,169,110,.12), transparent 60%), #0a0f1a; color:var(--ink); font-family:system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif}

  header{position:relative;padding:18px 16px 10px 16px}
  header::before{
    content:""; position:absolute; inset:-40% -10% auto -10%; height:260px;
    background:conic-gradient(from 0deg, rgba(201,169,110,.18), rgba(201,169,110,.03), rgba(201,169,110,.18));
    filter:blur(40px); animation:spin 28s linear infinite; opacity:.65; pointer-events:none;
  }
  @keyframes spin{to{transform:rotate(360deg)}}
  .wrap{max-width:1280px;margin:0 auto}
  .brand{font-family:"Playfair Display", serif; font-weight:800; letter-spacing:.06em; font-size:28px; color:var(--gold); position:relative; display:inline-block}
  .twinkles{position:absolute; inset:0; pointer-events:none}
  .twinkles span{position:absolute; width:3px; height:3px; background:var(--gold); border-radius:999px; opacity:.7; animation:twinkle 2.1s ease-in-out infinite}
  .twinkles span:nth-child(1){left:12%; top:36%; animation-delay:.2s}
  .twinkles span:nth-child(2){left:34%; top:16%; animation-delay:.7s}
  .twinkles span:nth-child(3){left:62%; top:32%; animation-delay:1.2s}
  .twinkles span:nth-child(4){left:82%; top:18%; animation-delay:1.7s}
  @keyframes twinkle{0%,100%{opacity:.15; transform:scale(.7)}50%{opacity:1; transform:scale(1)}}

  .status{display:flex;gap:10px;align-items:center;color:#a9b6d2}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0d172b}

  /* 레이아웃: 좌측 팀1, 중앙 메인, 우측 팀2 */
  .layout{display:grid;grid-template-columns:260px 1fr 260px;gap:14px;padding:10px 16px}
  @media (max-width:1100px){.layout{grid-template-columns:1fr}}

  .col{display:flex;flex-direction:column;gap:14px}
  .card{position:relative;background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--line); border-radius:16px; padding:14px; backdrop-filter:var(--blur); box-shadow:var(--lift); transition:transform .25s ease}
  .card:hover{transform:translateY(-2px)}
  .title{margin:0 0 8px 0; color:var(--gold); font-weight:700}

  .unit{display:flex;gap:8px;align-items:center;border:1px solid var(--line2);border-radius:12px;padding:8px;background:#0c152b}
  .unit .av{width:44px;height:44px;border-radius:10px;background:#1a2238;overflow:hidden;border:1px solid var(--line2)}
  .unit .av img{width:100%;height:100%;object-fit:cover}
  .bar{height:8px;background:#1b2336;border-radius:8px;overflow:hidden}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,#4da3ff,#67e8f9)}

  /* 메인 */
  .maingrid{display:grid;grid-template-columns:360px 1fr;gap:14px;align-items:stretch}
  @media (max-width:900px){.maingrid{grid-template-columns:1fr}}
  .portrait{background:#0a0f1f;border:1px solid var(--line);border-radius:12px;display:flex;align-items:flex-end;justify-content:center;position:relative;overflow:hidden;min-height:420px}
  .portrait .img{position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:340px;height:420px;object-fit:cover;filter:contrast(1.05) saturate(1.05)}
  .portrait .ph{position:absolute;bottom:0;left:0;right:0;height:420px;background:radial-gradient(600px 300px at 50% 110%, rgba(201,169,110,.10), transparent 60%)}
  .portrait .upload{position:absolute;top:8px;left:8px;right:8px;display:flex;gap:8px;align-items:center;justify-content:space-between;background:rgba(0,0,0,.35);padding:6px;border-radius:10px;border:1px solid var(--line)}
  .portrait .upload input[type="file"]{color:#c8c0ab}

  .pinfo{display:flex;flex-direction:column;gap:8px}
  .pname{font-weight:700;font-size:18px}
  .statrow{display:flex;gap:8px;flex-wrap:wrap}
  .stat{background:#0b172d;border:1px solid var(--line);border-radius:10px;padding:6px 10px}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn{border:1px solid var(--line2); color:var(--ink); background:linear-gradient(180deg,#212f4a,#15243f); padding:10px 12px; border-radius:12px; cursor:pointer; position:relative; overflow:hidden}
  .btn[disabled]{opacity:.45; cursor:not-allowed}
  .btn::after{content:""; position:absolute; inset:0; background:linear-gradient(90deg, transparent, rgba(255,255,255,.25), transparent); transform:translateX(-120%); transition:transform .8s; mix-blend-mode:overlay}
  .btn:hover::after{transform:translateX(120%)}
  .btn.gold{border-color:#6f5a33; background:linear-gradient(180deg,#e6d2a6,#c9a96e); color:#231b0b}

  .inputs{display:flex;gap:8px;flex-wrap:wrap}
  .input, select{background:#0b172d;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:8px}

  /* 중앙 우측: 채팅 */
  .chat{height:420px;overflow:auto;background:#0a1326;border:1px solid var(--line);border-radius:12px;padding:10px}
  .chat .row{display:flex;gap:8px;align-items:baseline;margin-bottom:6px}
  .ts{font-size:11px;color:#8aa0c2;min-width:54px}

  /* 하단 로그 */
  .log{height:220px;overflow:auto;background:#0a1326;border:1px solid var(--line);border-radius:12px;padding:10px}
  .log .row{display:flex;gap:8px;align-items:baseline;margin-bottom:6px}

  /* 터치 친화 */
  button, .input, select{min-height:40px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">PYXIS
      <span class="twinkles"><span></span><span></span><span></span><span></span></span>
    </div>
    <div class="status">
      <span>전장 상태</span>
      <span id="statusPill" class="pill">대기중</span>
    </div>
  </div>
</header>

<div class="wrap layout">
  <!-- 좌측: 팀1 -->
  <div class="col">
    <div class="card">
      <h3 class="title">불사조 기사단</h3>
      <div id="team1"></div>
    </div>
  </div>

  <!-- 중앙: 반신+정보 / 채팅 -->
  <div class="col">
    <div class="card">
      <h3 class="title">현재 턴</h3>
      <div class="maingrid">
        <div class="portrait">
          <div class="upload">
            <label style="color:#c8c0ab">반신 이미지 업로드(256KB 이하)</label>
            <input id="avatarInput" type="file" accept="image/*">
          </div>
          <img id="portraitImg" class="img" alt="">
          <div class="ph"></div>
        </div>
        <div>
          <div class="pinfo">
            <div id="turnName" class="pname">대기 중</div>
            <div id="turnStats" class="statrow"></div>
            <div class="actions">
              <button id="actAttack" disabled class="btn gold">공격</button>
              <button id="actDefend" disabled class="btn">방어</button>
              <button id="actItem" disabled class="btn">아이템</button>
              <button id="actPass" disabled class="btn">패스</button>
            </div>
            <div class="inputs">
              <select id="targetSel" disabled class="input"></select>
              <select id="itemSel" disabled class="input"></select>
            </div>
          </div>
          <div style="height:10px"></div>
          <div class="title" style="color:#aeb6c8;margin:0 0 6px 0;font-weight:600">채팅</div>
          <div id="chat" class="chat"></div>
          <div class="inputs" style="margin-top:6px">
            <input id="chatInput" class="input" placeholder="메시지 입력" style="flex:1 1 auto" />
            <select id="chatChannel" class="input">
              <option value="all">전체</option>
              <option value="team">팀</option>
            </select>
            <button id="chatSend" class="btn gold">보내기</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 class="title">로그</h3>
      <div id="logBox" class="log"></div>
    </div>
  </div>

  <!-- 우측: 팀2 -->
  <div class="col">
    <div class="card">
      <h3 class="title">죽음을 먹는 자들</h3>
      <div id="team2"></div>
    </div>
  </div>
</div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const battle = qs.get('battle');
  const token = qs.get('token');
  const name = qs.get('name');
  const pidFromUrl = qs.get('pid');

  const socket = io({ path: '/socket.io/' });
  let state = null;
  let mePid = null;

  const $ = (id)=>document.getElementById(id);
  const team1 = $('team1'), team2 = $('team2');
  const logBox = $('logBox');
  const chatEl = $('chat');
  const chatInput = $('chatInput');
  const chatSend = $('chatSend');
  const chatChannel = $('chatChannel');
  const statusPill = $('statusPill');

  const actAttack = $('actAttack');
  const actDefend = $('actDefend');
  const actItem = $('actItem');
  const actPass = $('actPass');
  const targetSel = $('targetSel');
  const itemSel = $('itemSel');
  const portraitImg = $('portraitImg');
  const avatarInput = $('avatarInput');
  const turnName = $('turnName');
  const turnStats = $('turnStats');

  function setStatusPill(status){
    statusPill.textContent = status==='waiting'?'대기중':status==='ongoing'?'진행중':status==='paused'?'일시정지':'종료';
  }
  function fmtTs(ts){ try{ return new Date(ts).toLocaleTimeString([], {hour12:false}); }catch{return '--:--:--';} }
  function appendRow(to, klass, ts, text){
    const row = document.createElement('div'); row.className = 'row ' + klass;
    const t = document.createElement('span'); t.className = 'ts'; t.textContent = ts;
    const m = document.createElement('span'); m.textContent = text;
    row.appendChild(t); row.appendChild(m); to.appendChild(row); to.scrollTop = to.scrollHeight;
  }

  function renderTeams(){
    team1.innerHTML = ''; team2.innerHTML = '';
    const mkUnit = (p)=>{
      const box = document.createElement('div'); box.className = 'unit';
      const av = document.createElement('div'); av.className = 'av';
      if (p.avatar) { const img = document.createElement('img'); img.src = p.avatar; av.appendChild(img); }
      const info = document.createElement('div'); info.style.flex='1';
      const nameEl = document.createElement('div'); nameEl.textContent = `${p.name}${p.alive?'':' (불능)'}`;
      const bar = document.createElement('div'); bar.className = 'bar';
      const span = document.createElement('span'); span.style.width = `${Math.round((p.hp/p.maxHp)*100)}%`; bar.appendChild(span);
      const meta = document.createElement('div'); meta.style.color='#a8b0c6'; meta.textContent = `ATK ${p.stats.attack} / DEF ${p.stats.defense} / AGI ${p.stats.agility} / LUCK ${p.stats.luck}`;
      info.appendChild(nameEl); info.appendChild(bar); info.appendChild(meta);
      box.appendChild(av); box.appendChild(info);
      return box;
    };
    Object.values(state.players).filter(p=>p.team==='team1').forEach(p=>team1.appendChild(mkUnit(p)));
    Object.values(state.players).filter(p=>p.team==='team2').forEach(p=>team2.appendChild(mkUnit(p)));
  }

  function renderTurnPanel(){
    const T = state.turn || {turnIndex:0, frameIndex:0, framePlan:[]};
    const cur = T.framePlan[T.frameIndex];
    const actor = cur ? state.players[cur.pid] : null;

    [actAttack, actDefend, actItem, actPass, targetSel, itemSel].forEach(el => el.disabled = true);
    targetSel.innerHTML = ''; itemSel.innerHTML = '';
    turnName.textContent = '대기 중';
    turnStats.innerHTML = '';
    portraitImg.src = '';

    if (!actor) return;

    if (actor.avatar) portraitImg.src = actor.avatar; else portraitImg.removeAttribute('src');

    turnName.textContent = `${actor.name}${actor.alive?'':' (불능)'}`;
    const S = actor.stats || {};
    const addStat = (label,val)=>{ const s = document.createElement('div'); s.className='stat'; s.textContent = `${label} ${val}`; turnStats.appendChild(s); };
    turnStats.innerHTML = '';
    addStat('HP', `${actor.hp}/${actor.maxHp}`);
    addStat('ATK', S.attack||0); addStat('DEF', S.defense||0); addStat('AGI', S.agility||0); addStat('LUCK', S.luck||0);

    const isMine = (mePid && actor.id === mePid);
    const allows = new Set(cur.allows || []);

    if (isMine) {
      actAttack.disabled = !allows.has('ATTACK');
      actDefend.disabled = !allows.has('DEFEND');
      actItem.disabled   = !allows.has('ITEM');
      actPass.disabled   = !allows.has('PASS');

      const list = Object.values(state.players).filter(p=>p.alive && p.id !== mePid);
      if (list.length) {
        targetSel.disabled = false;
        list.forEach(p=>{
          const opt = document.createElement('option');
          opt.value = p.id; opt.textContent = `${p.name} (${p.team === 'team1' ? '팀1':'팀2'})`;
          targetSel.appendChild(opt);
        });
      }
      const me = state.players[mePid];
      if (me && me.inventory && Object.keys(me.inventory).length) {
        itemSel.disabled = false;
        Object.keys(me.inventory).forEach(k=>{
          const q = me.inventory[k] || 0;
          if (q>0) {
            const opt = document.createElement('option');
            opt.value = k; opt.textContent = `${k} (x${q})`;
            itemSel.appendChild(opt);
          }
        });
      }
    }
  }

  function render(){
    if (!state) return;
    setStatusPill(state.status);
    renderTeams();
    renderTurnPanel();
  }

  function choose(kind){
    const payload = { kind };
    if (kind === 'ATTACK') payload.targetId = targetSel.value || null;
    if (kind === 'DEFEND') payload.targetId = targetSel.value || null;
    if (kind === 'ITEM') { payload.itemName = itemSel.value || null; payload.targetId = targetSel.value || null; }
    socket.emit('chooseAction', payload, (ack)=>{ if (!ack || !ack.ok) alert(ack?.error || '액션 실패'); });
  }

  actAttack.onclick = ()=> choose('ATTACK');
  actDefend.onclick = ()=> choose('DEFEND');
  actItem.onclick   = ()=> choose('ITEM');
  actPass.onclick   = ()=> choose('PASS');

  // 반신 이미지 업로드: 256KB 제한
  avatarInput.addEventListener('change', async (ev)=>{
    const file = ev.target.files && ev.target.files[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) { alert('이미지 파일만 업로드할 수 있습니다'); return; }
    if (file.size > 256 * 1024) { alert('파일 용량이 256KB를 초과합니다'); return; }
    const reader = new FileReader();
    reader.onload = ()=>{
      const dataUrl = reader.result;
      socket.emit('uploadAvatar', { dataUrl }, (ack)=>{
        if (!ack || !ack.ok) { alert('업로드 실패: ' + (ack && ack.error || '')); return; }
      });
    };
    reader.readAsDataURL(file);
  });

  chatSend.onclick = ()=>{
    const text = chatInput.value.trim(); if (!text) return;
    socket.emit('chatMessage', { message: text, channel: chatChannel.value });
    chatInput.value = '';
  };

  socket.on('connect', ()=>{
    socket.emit('auth', { battle, token, role:'player', name, pid: pidFromUrl }, (ack)=>{
      if (!ack || !ack.ok) { alert('인증 실패'); return; }
      state = ack.state;
      const list = Object.values(state.players);
      const found = list.find(p => p.name === name);
      mePid = found ? found.id : null;
      render();
    });
  });

  socket.on('state', s => { state = s; render(); });

  socket.on('chat', (msg)=>{
    if (!msg) return;
    const t = fmtTs(msg.ts || Date.now());
    if (msg.type === 'system') appendRow(logBox, 'sys', t, msg.text);
    let text = '';
    if (msg.type === 'system') text = '[시스템] ' + msg.text;
    else if (msg.type === 'cheer') text = '[응원] ' + (msg.from||'관전자') + ': ' + msg.text;
    else if (msg.type === 'chat') text = '[' + (msg.channel === 'team' ? '팀':'전체') + '] ' + (msg.from||'익명') + ': ' + msg.text;
    appendRow(chatEl, '', t, text);
  });

  socket.on('chatError', (m)=> alert(m));
})();
</script>
</body>
</html>
