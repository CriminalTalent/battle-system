<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>전투 플레이어</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- 주의: Nginx가 /socket.io/ 경로를 3001로 프록시해야 WebSocket이 정상 동작합니다 -->
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root{
      --bg:#0f1419; --ink:#f5e6b8; --ink-dim:#cbbd98; --panel:#1a1f26; --line:#39424d;
      --accent:#c8a882; --accent-ink:#0a0f1a; --radius:10px;
    }
    *{box-sizing:border-box}
    body{
      font-family: Arial, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg); color: var(--ink);
      margin: 0; padding: 20px;
    }
    h1,h2,h3{color:#e5c88a;margin:0 0 12px}
    .hidden{display:none}
    .container{max-width:880px;margin:auto}
    input, select, button{
      padding: 12px; margin: 6px 0; width: 100%;
      border-radius: var(--radius); border: 1px solid var(--accent);
      background: var(--panel); color: var(--ink);
      outline: none;
    }
    input:focus, select:focus{ box-shadow: 0 0 0 3px rgba(200,168,130,.2); }
    button{ cursor: pointer; background: var(--accent); color: var(--accent-ink); font-weight: 700; }
    button:disabled{ opacity:.6; cursor:not-allowed }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .team{ border: 1px solid var(--line); margin:10px 0; padding:12px; border-radius:12px; background:#13181f; }
    .log{ background: var(--panel); padding: 12px; height: 220px; overflow-y: auto; font-size: 14px; border:1px solid var(--line); border-radius:12px }
    .muted{ color: var(--ink-dim); font-size: 12px }
    .sep{height:1px;background:linear-gradient(90deg,transparent,#25303a,transparent);margin:12px 0}
  </style>
</head>
<body>
<div class="container">
  <h1>플레이어 입장</h1>

  <!-- 인증 화면 -->
  <div id="authScreen">
    <div class="row">
      <div>
        <label for="playerName" class="muted">플레이어 이름</label>
        <input type="text" id="playerName" placeholder="이름 입력">
      </div>
      <div>
        <label for="teamSelect" class="muted">팀 선택</label>
        <select id="teamSelect">
          <option value="team1">불사조 기사단</option>
          <option value="team2">죽음을 먹는자들</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label for="battleId" class="muted">전투 ID</label>
        <input type="text" id="battleId" placeholder="전투 ID">
      </div>
      <div>
        <label for="otp" class="muted">플레이어 OTP</label>
        <input type="text" id="otp" placeholder="플레이어 OTP">
      </div>
    </div>

    <button id="btnJoin">전투 참가</button>
    <div class="muted">URL 쿼리(battle, token, name, team)로도 자동 채움됩니다.</div>
  </div>

  <div class="sep"></div>

  <!-- 전투 화면 -->
  <div id="battleScreen" class="hidden">
    <h2>전투 상태</h2>
    <div id="battleStatus" class="muted">-</div>

    <h3>팀 현황</h3>
    <div id="teams"></div>

    <h3>행동 선택</h3>
    <div class="row">
      <button id="actAttack">공격</button>
      <button id="actDefend">방어</button>
    </div>
    <div class="row">
      <button id="actDodge">회피</button>
      <button id="actItem">아이템 사용</button>
    </div>
    <button id="actPass">턴 넘기기</button>

    <h3 style="margin-top:16px">전투 로그</h3>
    <div id="log" class="log"></div>
  </div>
</div>

<script>
(() => {
  'use strict';

  const $ = (s)=>document.querySelector(s);

  let socket = null;
  let battleId = null;
  let playerId = null;
  let pollTimer = null;

  // ─────────────────────────────────────────────────────────────────
  // 유틸
  // ─────────────────────────────────────────────────────────────────
  function qs(){
    const p = new URLSearchParams(location.search);
    return {
      battle: p.get('battle') || p.get('battleId') || p.get('b'),
      token:  p.get('token')  || p.get('otp') || p.get('code') || p.get('t'),
      name:   p.get('name')   || p.get('n'),
      team:   p.get('team')   || p.get('tm')
    };
  }

  function escapeHtml(s=''){
    return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  async function getBattle(id){
    const r = await fetch(`/api/battles/${encodeURIComponent(id)}`);
    if(!r.ok) throw new Error(`GET /api/battles/${id} -> ${r.status}`);
    return r.json();
  }

  function showAuth(){
    $('#authScreen').classList.remove('hidden');
    $('#battleScreen').classList.add('hidden');
  }
  function showBattle(){
    $('#authScreen').classList.add('hidden');
    $('#battleScreen').classList.remove('hidden');
  }

  function startPolling(){
    stopPolling();
    pollTimer = setInterval(async ()=>{
      if(!battleId) return;
      try { renderBattle(await getBattle(battleId)); } catch {}
    }, 3000);
  }
  function stopPolling(){
    if(pollTimer){ clearInterval(pollTimer); pollTimer=null; }
  }

  // ─────────────────────────────────────────────────────────────────
  // 렌더링
  // ─────────────────────────────────────────────────────────────────
  function renderBattle(b){
    if(!b) return;
    const status = `상태: ${b.status || '-'} | 라운드: ${b.roundNumber ?? '-'} | 턴: ${b.turnNumber ?? '-'} | 현재 팀: ${b.currentTeam ?? '-'}`;
    $('#battleStatus').textContent = status;

    const teamsDiv = $('#teams');
    teamsDiv.innerHTML = '';
    for(const key of ['team1','team2']){
      const team = b.teams?.[key];
      const div = document.createElement('div');
      div.className = 'team';
      const players = (team?.players || [])
        .map(p => `<div>${escapeHtml(p.name || '플레이어')} (HP: ${p.hp ?? '-'} / ${p.maxHp ?? '-'}) ${p.alive === false ? '(사망)' : ''}</div>`)
        .join('');
      div.innerHTML = `<h4>${escapeHtml(team?.name || key)}</h4>${players || '<div class="muted">플레이어 없음</div>'}`;
      teamsDiv.appendChild(div);
    }

    const logDiv = $('#log');
    logDiv.innerHTML = (b.battleLog || [])
      .map(e => `[${new Date(e.timestamp).toLocaleTimeString()}] ${escapeHtml(e.message)}`)
      .join('<br>');
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  // ─────────────────────────────────────────────────────────────────
  // 참가 / 소켓
  // ─────────────────────────────────────────────────────────────────
  async function joinBattle(){
    const name = $('#playerName').value.trim();
    const bid  = $('#battleId').value.trim();
    const otp  = $('#otp').value.trim();
    const team = $('#teamSelect').value;

    if(!name || !bid || !otp){
      alert('이름, 전투 ID, OTP를 모두 입력하세요.');
      return;
    }

    battleId = bid;

    // 플레이어 등록 REST (서버 응답 형태를 넓게 수용)
    let payload;
    try{
      const res = await fetch(`/api/battles/${encodeURIComponent(battleId)}/players`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          name, team,
          stats: { attack:2, defense:2, agility:2, luck:2 }
        })
      });
      const text = await res.text();
      try{ payload = JSON.parse(text) }catch{ throw new Error(`JSON 파싱 실패: ${text}`); }
      if(!res.ok) throw new Error(payload?.error || `HTTP ${res.status}`);
    }catch(e){
      alert(`플레이어 등록 실패: ${e?.message || e}`);
      return;
    }

    // 가능한 키에서 playerId 추출
    playerId = payload?.player?.id || payload?.playerId || payload?.id || null;
    if(!playerId){
      // 일부 서버는 전투 상태를 반환하지 않고 단순 ok만 줄 수 있으므로, 전투 재조회로 보완
      try{
        const fresh = await getBattle(battleId);
        const all = [...(fresh.teams?.team1?.players||[]), ...(fresh.teams?.team2?.players||[])];
        const found = all.find(p => (p.name||'') === name);
        if(found) playerId = found.id;
      }catch{}
    }
    if(!playerId){
      alert('플레이어 ID를 응답에서 찾지 못했습니다. 서버 코드를 확인하세요.');
      return;
    }

    // 소켓 연결 (현재 서버는 플레이어 전용 소켓 이벤트가 없으므로, 수신 전용으로만 연결)
    connectSocket();

    // 화면 전환 및 상태 표시
    showBattle();
    try{ renderBattle(await getBattle(battleId)); }catch{}

    // 폴백 폴링 시작(서버가 battleUpdate를 보내지 않는 경우 대비)
    startPolling();
  }

  function connectSocket(){
    try{
      if(socket){ try{ socket.disconnect(); }catch{} socket=null; }
      // 서버 설정과 동일한 경로 사용 (nginx와 일치)
      socket = io({ path:'/socket.io/', transports:['websocket','polling'] });

      // 서버가 플레이어 관련 이벤트를 제공하지 않아도 오류 없이 대기
      socket.on('battleUpdate', (battle)=>{ renderBattle(battle); });
      socket.on('connect_error', (err)=>{ console.warn('소켓 연결 오류:', err?.message || err); });
    }catch(e){
      console.warn('소켓 초기화 실패:', e?.message || e);
    }
  }

  // ─────────────────────────────────────────────────────────────────
  // 액션 (현재 서버 미구현 안내)
  // ─────────────────────────────────────────────────────────────────
  function notImplemented(){
    alert('현재 서버에 플레이어 행동 API/소켓이 구현되어 있지 않습니다.\n관리자 페이지에서 전투만 관리할 수 있습니다.');
  }
  function doAttack(){ notImplemented(); }
  function doDefend(){ notImplemented(); }
  function doDodge(){  notImplemented(); }
  function doItem(){   notImplemented(); }
  function doPass(){   notImplemented(); }

  // ─────────────────────────────────────────────────────────────────
  // 바인딩 / 부트
  // ─────────────────────────────────────────────────────────────────
  $('#btnJoin').onclick   = joinBattle;
  $('#actAttack').onclick = doAttack;
  $('#actDefend').onclick = doDefend;
  $('#actDodge').onclick  = doDodge;
  $('#actItem').onclick   = doItem;
  $('#actPass').onclick   = doPass;

  (function boot(){
    const p = qs();
    if(p.battle) $('#battleId').value = p.battle;
    if(p.token)  $('#otp').value      = p.token;
    if(p.name)   $('#playerName').value = p.name;
    if(p.team && (p.team==='team1' || p.team==='team2')) $('#teamSelect').value = p.team;

    // 쿼리에 battle과 token과 name이 있으면 자동 참가 시도
    if($('#battleId').value && $('#otp').value && $('#playerName').value){
      joinBattle();
    }
  })();
})();
</script>
</body>
</html>