<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>ì „íˆ¬ í”Œë ˆì´ì–´</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f1419;
      color: #f5e6b8;
      margin: 0;
      padding: 20px;
    }
    h1 { color: #e5c88a; }
    .hidden { display: none; }
    .container { max-width: 800px; margin: auto; }
    input, select, button {
      padding: 10px; margin: 5px 0;
      width: 100%; border-radius: 5px;
      border: 1px solid #c8a882; background: #1a1f26; color: #f5e6b8;
    }
    button { cursor: pointer; background: #c8a882; color: #0a0f1a; font-weight: bold; }
    .team { border: 1px solid #444; margin: 10px 0; padding: 10px; border-radius: 8px; }
    .log { background: #1a1f26; padding: 10px; height: 200px; overflow-y: auto; font-size: 14px; }
  </style>
</head>
<body>
<div class="container">
  <h1>í”Œë ˆì´ì–´ ì…ì¥</h1>

  <!-- ì¸ì¦ í™”ë©´ -->
  <div id="authScreen">
    <input type="text" id="playerName" placeholder="í”Œë ˆì´ì–´ ì´ë¦„">
    <select id="teamSelect">
      <option value="team1">ë¶ˆì‚¬ì¡° ê¸°ì‚¬ë‹¨</option>
      <option value="team2">ì£½ìŒì„ ë¨¹ëŠ”ìë“¤</option>
    </select>
    <input type="text" id="battleId" placeholder="ì „íˆ¬ ID">
    <input type="text" id="otp" placeholder="í”Œë ˆì´ì–´ OTP">
    <button onclick="joinBattle()">ì „íˆ¬ ì°¸ê°€</button>
  </div>

  <!-- ì „íˆ¬ í™”ë©´ -->
  <div id="battleScreen" class="hidden">
    <h2>ì „íˆ¬ í™”ë©´</h2>
    <div id="battleStatus"></div>

    <div id="teams"></div>

    <h3>í–‰ë™ ì„ íƒ</h3>
    <button onclick="doAction('attack')">ê³µê²©</button>
    <button onclick="doAction('defend')">ë°©ì–´</button>
    <button onclick="doAction('dodge')">íšŒí”¼</button>
    <button onclick="doAction('item')">ì•„ì´í…œ ì‚¬ìš©</button>
    <button onclick="doAction('pass')">í„´ ë„˜ê¸°ê¸°</button>

    <h3>ì „íˆ¬ ë¡œê·¸</h3>
    <div id="log" class="log"></div>
  </div>
</div>

<script>
let socket = null;
let battleId = null;
let playerId = null;

function joinBattle() {
  const name = document.getElementById("playerName").value.trim();
  battleId = document.getElementById("battleId").value.trim();
  const otp = document.getElementById("otp").value.trim();
  const team = document.getElementById("teamSelect").value;

  if (!name || !battleId || !otp) {
    alert("ëª¨ë“  ê°’ì„ ì…ë ¥í•˜ì„¸ìš”");
    return;
  }

  socket = io({ transports: ["websocket", "polling"] });

  socket.on("connect", () => {
    console.log("ì†Œì¼“ ì—°ê²°ë¨", socket.id);

    // í”Œë ˆì´ì–´ ì¸ì¦
    socket.emit("playerAuth", { battleId, otp, playerId });
  });

  socket.on("authSuccess", data => {
    console.log("ì¸ì¦ ì„±ê³µ", data);
    playerId = data.player?.id; // ì„œë²„ì—ì„œ player ì •ë³´ ì£¼ì… ê°€ëŠ¥
    document.getElementById("authScreen").classList.add("hidden");
    document.getElementById("battleScreen").classList.remove("hidden");
    renderBattle(data.battle);
  });

  socket.on("authError", msg => alert("ì¸ì¦ ì‹¤íŒ¨: " + msg));

  socket.on("battleUpdate", battle => {
    renderBattle(battle);
  });

  socket.on("actionError", msg => alert("í–‰ë™ ì‹¤íŒ¨: " + msg));
}

function doAction(type) {
  if (!socket || !battleId || !playerId) return;

  const action = { type };

  if (type === "attack") {
    const targetId = prompt("ê³µê²©í•  ëŒ€ìƒì˜ ID ì…ë ¥");
    if (!targetId) return;
    action.targetId = targetId;
  }

  if (type === "item") {
    const itemType = prompt("ì•„ì´í…œ ì´ë¦„ ì…ë ¥ (ê³µê²© ë³´ì •ê¸°, ë°©ì–´ ë³´ì •ê¸°, ë””í„°ë‹ˆ)");
    action.itemType = itemType;
  }

  socket.emit("playerAction", { battleId, playerId, action });
}

function renderBattle(battle) {
  document.getElementById("battleStatus").innerText =
    `ìƒíƒœ: ${battle.status}, í„´: ${battle.turnNumber}, íŒ€: ${battle.currentTeam}`;

  const teamsDiv = document.getElementById("teams");
  teamsDiv.innerHTML = "";
  for (const teamKey of ["team1", "team2"]) {
    const team = battle.teams[teamKey];
    const div = document.createElement("div");
    div.className = "team";
    div.innerHTML = `<h4>${team.name}</h4>` +
      team.players.map(p =>
        `<div>${p.name} (HP: ${p.hp}/${p.maxHp}) ${p.alive ? "" : "ğŸ’€"}</div>`
      ).join("");
    teamsDiv.appendChild(div);
  }

  const logDiv = document.getElementById("log");
  logDiv.innerHTML = battle.battleLog.map(e =>
    `[${new Date(e.timestamp).toLocaleTimeString()}] ${e.message}`
  ).join("<br>");
  logDiv.scrollTop = logDiv.scrollHeight;
}
</script>
</body>
</html>
