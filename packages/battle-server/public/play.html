<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PYXIS 플레이어</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;800;900&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
<script src="/socket.io/socket.io.js"></script>
<style>
  :root{
    /* 네이비 + 골드 고정 팔레트 */
    --bg-0:#05090f;
    --bg-1:#081223;
    --bg-2:#0b172d;
    --glass:#0e1a33cc;
    --glass-2:#122242cc;
    --border:#1f2b46;
    --border-2:#162139;

    --ink:#e9e3d0;
    --ink-dim:#cfc7b2;
    --muted:#9fb0d1;

    --gold:#c9a96e;
    --gold-2:#e6d2a6;

    --ok:#3f9964;
    --warn:#c1994e;
    --bad:#b45c5c;

    --blur: blur(12px) saturate(120%);
    --lift: 0 14px 30px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.03);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:"Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    background:
      radial-gradient(1200px 600px at 20% -10%, rgba(201,169,110,.10), transparent 60%),
      linear-gradient(180deg, #020509 0%, #051021 40%, #0a1830 100%);
  }

  /* 헤더(브랜딩) */
  header{position:relative; padding:18px 16px 8px 16px}
  header::before{
    content:""; position:absolute; inset:-35% -10% auto -10%; height:320px;
    background:conic-gradient(from 0deg, rgba(201,169,110,.18), rgba(201,169,110,.03), rgba(201,169,110,.18));
    filter:blur(48px); animation:spin 36s linear infinite; opacity:.55; pointer-events:none;
  }
  @keyframes spin{to{transform:rotate(360deg)}}

  .wrap{max-width:1280px; margin:0 auto}

  .brand{
    font-family:"Cinzel", serif; font-weight:900; letter-spacing:.06em;
    font-size:30px; position:relative; display:inline-block;
    background:linear-gradient(180deg,var(--gold-2),var(--gold));
    -webkit-background-clip:text; background-clip:text; color:transparent;
  }

  /* 메인 3열 스테이지: 좌(팀1) - 중앙(포트레이트/채팅/로그) - 우(팀2) */
  .stage{display:grid; grid-template-columns:260px 1fr 260px; gap:14px; padding:12px 16px}
  @media (max-width:1100px){ .stage{grid-template-columns:1fr} }

  /* 카드 */
  .card{
    background:linear-gradient(180deg,var(--glass),var(--glass-2));
    border:1px solid var(--border); border-top:1px solid rgba(255,255,255,.05);
    border-radius:16px; padding:12px; backdrop-filter:var(--blur); box-shadow:var(--lift);
  }

  /* 좌/우 팀 리스트 */
  .side{display:flex; flex-direction:column; gap:10px}
  .unit{display:flex; gap:10px; align-items:center; border:1px solid var(--border); border-radius:12px; padding:8px; background:#0f1d39}
  .unit .avatar{width:44px; height:44px; border-radius:8px; background:#0b1630 center/cover no-repeat; border:1px solid var(--border)}
  .unit .meta{flex:1}
  .hpbar{height:8px;background:#172642;border-radius:8px;overflow:hidden;margin-top:4px}
  .hpbar>span{display:block;height:100%;background:linear-gradient(90deg,#58a7ff,#67e8f9)}
  .unit.active{outline:2px solid rgba(201,169,110,.4)}
  .unit.dead{opacity:.55}

  /* 사이드 액션 패널(내 팀 열에 위치) */
  .side-actions{margin-top:6px}
  .actions .btn{
    border:1px solid var(--border-2); color:var(--ink);
    background:linear-gradient(180deg,#213456,#172a4a);
    padding:10px 12px; border-radius:12px; cursor:pointer; position:relative; overflow:hidden;
    transition:transform .15s ease, box-shadow .15s ease;
  }
  .actions .btn:hover{transform:translateY(-1px)}
  .actions .btn[disabled]{opacity:.55; cursor:not-allowed}
  .actions .btn.gold{border-color:#6f5a33; background:linear-gradient(180deg,#e6d2a6,#c9a96e); color:#2a200f}
  .actions .btn.warn{border-color:#7b5b20; background:linear-gradient(180deg,#cda45a,#8f6d34)}
  .actions .row{display:flex; flex-wrap:wrap; gap:8px}
  .hint{color:#aeb7cf; font-size:12px}

  /* 중앙 레이아웃 */
  .center{display:grid; grid-template-rows:auto 260px 220px; gap:12px}
  @media (max-width:1100px){ .center{grid-template-rows:auto 260px 240px} }

  /* 액티브 포트레이트(반신) */
  .portrait{
    position:relative; min-height:200px; display:flex; align-items:flex-end; justify-content:center;
    border:1px solid var(--border); border-radius:16px;
    background:linear-gradient(180deg,#0a1224,#0a1224);
    overflow:hidden;
  }
  .portrait .img{
    position:absolute; bottom:0; width:40%; max-width:360px; aspect-ratio:3/4; background:#0b1630 center/cover no-repeat; border:1px solid var(--border);
    border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.45);
  }
  .portrait.left  .img{left:24px}
  .portrait.right .img{right:24px}
  .portrait .nameplate{
    position:absolute; top:10px; left:12px; right:12px; display:flex; justify-content:space-between; align-items:center;
    font-weight:700; color:var(--gold);
  }
  .portrait .stats{
    position:absolute; bottom:12px; left:12px; right:12px; display:flex; gap:12px; flex-wrap:wrap; color:#cfd6ea; font-size:14px;
    background:#0c162eaa; border:1px solid var(--border); border-radius:10px; padding:8px 10px;
  }

  /* 채팅, 로그 */
  .chat, .logs{height:100%; overflow:auto; background:#0b1630; border:1px solid var(--border); border-radius:12px; padding:10px}
  .ts{font-size:11px;color:#8aa0c2;min-width:54px;flex:0 0 auto}
  .line{display:flex; gap:8px; align-items:baseline; margin-bottom:6px}

  .chat::-webkit-scrollbar, .logs::-webkit-scrollbar{height:10px;width:10px}
  .chat::-webkit-scrollbar-track, .logs::-webkit-scrollbar-track{background:#0b1426;border-radius:10px}
  .chat::-webkit-scrollbar-thumb, .logs::-webkit-scrollbar-thumb{background:#1e2d4f;border-radius:10px;border:2px solid #0b1426}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">Pyxis</div>
  </div>
</header>

<main class="wrap stage">
  <!-- 좌측: 팀1(불사조 기사단) -->
  <aside class="side" id="teamLeft"></aside>

  <!-- 중앙 -->
  <section class="center">
    <!-- 액티브 포트레이트 -->
    <div class="card portrait" id="portrait">
      <div class="nameplate">
        <div id="turnInfo">대기중</div>
        <div id="modeInfo" style="color:#cfd6ea; font-weight:600"></div>
      </div>
      <div class="img" id="portraitImg" style="display:none"></div>
      <div class="stats" id="portraitStats" style="display:none"></div>
    </div>

    <!-- 채팅 -->
    <div class="card" style="display:grid; grid-template-rows:1fr auto; gap:8px">
      <div id="chat" class="chat"></div>
      <div style="display:flex; gap:8px">
        <select id="chatCh" class="card" style="padding:8px 10px; border-radius:10px; background:#0f1e3b; border:1px solid var(--border)">
          <option value="all">전체</option>
          <option value="team">팀</option>
        </select>
        <input id="chatInput" class="card" placeholder="메시지 입력" style="flex:1; padding:10px; border-radius:10px; background:#0f1e3b; border:1px solid var(--border)" />
        <button id="chatSend" class="actions btn">보내기</button>
      </div>
    </div>

    <!-- 로그 -->
    <div class="card">
      <div id="logs" class="logs"></div>
    </div>
  </section>

  <!-- 우측: 팀2(죽음을 먹는 자들) -->
  <aside class="side" id="teamRight"></aside>
</main>

<!-- 타겟 선택 모달 -->
<div class="modal" id="targetModal" style="position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:30">
  <div class="panel" style="width:min(720px, 94vw); background:linear-gradient(180deg,var(--glass),var(--glass-2)); border:1px solid var(--border); border-radius:16px; padding:14px; backdrop-filter:var(--blur)">
    <h3 id="targetTitle" style="margin:0 0 8px 0; color:var(--gold)">대상 선택</h3>
    <div id="targetList" class="listgrid" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px"></div>
    <div class="controls" style="display:flex; gap:8px; margin-top:8px; justify-content:flex-end">
      <button class="btn" id="targetCancel" style="border:1px solid var(--border); background:#112243; color:var(--ink); border-radius:10px; padding:8px 10px">취소</button>
    </div>
  </div>
</div>

<!-- 아이템 선택 모달 -->
<div class="modal" id="itemModal" style="position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:30">
  <div class="panel" style="width:min(720px, 94vw); background:linear-gradient(180deg,var(--glass),var(--glass-2)); border:1px solid var(--border); border-radius:16px; padding:14px; backdrop-filter:var(--blur)">
    <h3 style="margin:0 0 8px 0; color:var(--gold)">아이템 사용</h3>
    <div id="itemList" class="listgrid" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px"></div>
    <div class="controls" style="display:flex; gap:8px; margin-top:8px; justify-content:flex-end">
      <button class="btn" id="itemCancel" style="border:1px solid var(--border); background:#112243; color:var(--ink); border-radius:10px; padding:8px 10px">닫기</button>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  // DOM
  const teamLeft  = $('teamLeft');
  const teamRight = $('teamRight');
  const portrait  = $('portrait');
  const portraitImg = $('portraitImg');
  const portraitStats = $('portraitStats');
  const turnInfo  = $('turnInfo');
  const modeInfo  = $('modeInfo');

  const chatEl = $('chat'), chatInput = $('chatInput'), chatSend = $('chatSend'), chatCh = $('chatCh');
  const logsEl = $('logs');

  const targetModal = $('targetModal'), targetList = $('targetList'), targetCancel = $('targetCancel'), targetTitle = $('targetTitle');
  const itemModal   = $('itemModal'), itemList = $('itemList'), itemCancel = $('itemCancel');

  // 소켓 & 상태
  const socket = io({ path: '/socket.io/' });
  let state = null;
  let myPid = null;
  let myTeam = null;

  // 현재 렌더링된 액션 버튼 레퍼런스
  let actionUI = null; // {container, btnAtk, btnDef, btnEva, btnItem, btnPass}

  // 쿼리 인증
  const qs = new URLSearchParams(location.search);
  const battle = qs.get('battle'); const token = qs.get('token'); const name = qs.get('name'); const pid = qs.get('pid');

  function fmtTs(ts){ try{ return new Date(ts).toLocaleTimeString([], {hour12:false}); }catch{return '--:--:--';} }

  function appendChat(m){
    const row = document.createElement('div'); row.className='line';
    const ts = document.createElement('span'); ts.className='ts'; ts.textContent = fmtTs(m.ts||Date.now());
    const body = document.createElement('span');
    if (m.type === 'system')      body.textContent = '[시스템] ' + m.text;
    else if (m.type === 'cheer')  body.textContent = '[응원] ' + (m.from||'관전자') + ': ' + m.text;
    else if (m.type === 'chat')   body.textContent = '[' + (m.channel==='team'?'팀':'전체') + '] ' + (m.from||'익명') + ': ' + (m.text||m.message||'');
    else                          body.textContent = m.text || JSON.stringify(m);
    row.appendChild(ts); row.appendChild(body);
    chatEl.appendChild(row); chatEl.scrollTop = chatEl.scrollHeight;
  }
  function appendLog(text){
    const row = document.createElement('div'); row.className='line';
    const ts = document.createElement('span'); ts.className='ts'; ts.textContent = fmtTs(Date.now());
    const body = document.createElement('span'); body.textContent = text;
    row.appendChild(ts); row.appendChild(body);
    logsEl.appendChild(row); logsEl.scrollTop = logsEl.scrollHeight;
  }

  function byTeam(team){ return Object.values(state.players||{}).filter(p=>p.team===team); }
  function getOppTeam(team){ return team==='team1' ? 'team2' : 'team1'; }

  function currentActorPid(){
    const t = state && state.turn;
    if (!t) return null;
    if (Array.isArray(t.pending) && t.pending.length) return t.pending[0];
    return null;
  }

  function isMyTurn(){ return state && state.status==='ongoing' && myPid && currentActorPid() === myPid; }

  function setActionEnables(){
    if (!actionUI) return;
    const en = isMyTurn();
    [actionUI.btnAtk, actionUI.btnDef, actionUI.btnEva, actionUI.btnItem, actionUI.btnPass].forEach(b=>{ b.disabled = !en; });
  }

  function hpPct(p){ return Math.max(0, Math.min(100, Math.round((p.hp/p.maxHp)*100))); }

  function smallUnit(p){
    const el = document.createElement('div'); el.className='unit' + (p.alive?'':' dead');
    if (currentActorPid() === p.id) el.classList.add('active');

    const av = document.createElement('div'); av.className='avatar';
    if (p.avatar) av.style.backgroundImage = `url(${p.avatar})`;
    el.appendChild(av);

    const meta = document.createElement('div'); meta.className='meta';
    const nm = document.createElement('div'); nm.style.fontWeight='700'; nm.textContent = p.name + (p.alive?'':' (불능)');
    const bar = document.createElement('div'); bar.className='hpbar'; const span = document.createElement('span'); span.style.width = hpPct(p)+'%'; bar.appendChild(span);
    const st = document.createElement('div'); st.style.color='#aeb7cf'; st.style.fontSize='12px';
    st.textContent = `공격 ${p.stats.attack} / 방어 ${p.stats.defense} / 민첩 ${p.stats.agility} / 행운 ${p.stats.luck}`;
    meta.appendChild(nm); meta.appendChild(bar); meta.appendChild(st);
    el.appendChild(meta);
    return el;
  }

  function buildActionsPanel(){
    const wrap = document.createElement('div');
    wrap.className = 'card side-actions actions';
    const row = document.createElement('div'); row.className = 'row';
    const bAtk  = document.createElement('button'); bAtk.className  = 'btn gold'; bAtk.textContent  = '공격';
    const bDef  = document.createElement('button'); bDef.className  = 'btn';      bDef.textContent  = '방어';
    const bEva  = document.createElement('button'); bEva.className  = 'btn';      bEva.textContent  = '회피';
    const bItem = document.createElement('button'); bItem.className = 'btn';      bItem.textContent = '아이템';
    const bPass = document.createElement('button'); bPass.className = 'btn warn'; bPass.textContent = '패스';
    row.appendChild(bAtk); row.appendChild(bDef); row.appendChild(bEva); row.appendChild(bItem); row.appendChild(bPass);
    const hint = document.createElement('div'); hint.className='hint'; hint.style.marginTop='6px'; hint.textContent='내 턴에만 버튼이 활성화됩니다.';
    wrap.appendChild(row); wrap.appendChild(hint);

    // 이벤트 바인딩
    bAtk.addEventListener('click', onClickAttack);
    bDef.addEventListener('click', onClickDefend);
    bEva.addEventListener('click', onClickEvade);
    bItem.addEventListener('click', onClickItem);
    bPass.addEventListener('click', onClickPass);

    actionUI = { container: wrap, btnAtk:bAtk, btnDef:bDef, btnEva:bEva, btnItem:bItem, btnPass:bPass };
    return wrap;
  }

  function renderSides(){
    teamLeft.innerHTML=''; teamRight.innerHTML='';
    const leftList = byTeam('team1');
    const rightList = byTeam('team2');

    leftList.forEach(p=>{
      teamLeft.appendChild(smallUnit(p));
      if (p.id === myPid) teamLeft.appendChild(buildActionsPanel());
    });
    rightList.forEach(p=>{
      teamRight.appendChild(smallUnit(p));
      if (p.id === myPid) teamRight.appendChild(buildActionsPanel());
    });
  }

  function renderPortrait(){
    const pid = currentActorPid();
    const p = pid ? state.players[pid] : null;
    const dir = p && p.team==='team2' ? 'right' : 'left';
    portrait.classList.toggle('left',  dir==='left');
    portrait.classList.toggle('right', dir==='right');

    const tm = p ? (p.team==='team1' ? '불사조 기사단' : '죽음을 먹는 자들') : '';
    turnInfo.textContent = p ? `${p.name}의 차례` : '대기중';
    modeInfo.textContent = state ? `${state.mode || ''}` : '';

    if (p && p.avatar){
      portraitImg.style.display='block';
      portraitImg.style.backgroundImage = `url(${p.avatar})`;
    } else {
      portraitImg.style.display='none';
      portraitImg.style.backgroundImage = '';
    }

    if (p){
      portraitStats.style.display='flex';
      portraitStats.innerHTML =
        `<div>팀: ${tm}</div>
         <div>HP: ${p.hp} / ${p.maxHp}</div>
         <div>공격 ${p.stats.attack}</div>
         <div>방어 ${p.stats.defense}</div>
         <div>민첩 ${p.stats.agility}</div>
         <div>행운 ${p.stats.luck}</div>`;
    }else{
      portraitStats.style.display='none';
      portraitStats.innerHTML = '';
    }
  }

  function renderLogsFromState(){
    logsEl.innerHTML = '';
    (state.chat||[]).slice(-200).forEach(m=>{
      if (m.type === 'system'){
        appendLog(m.text);
      }
    });
  }

  function renderAll(){
    if (!state) return;
    renderSides();
    renderPortrait();
    setActionEnables();
    renderLogsFromState();
  }

  // 소켓 이벤트 -------------------------------------------------
  socket.on('connect', ()=>{
    socket.emit('auth', { battle, token, role:'player', name, pid }, (ack)=>{
      if (!ack || !ack.ok) { alert('인증 실패'); return; }
      state = ack.state;
      // 내 PID 파악
      myPid = (function(){
        const s = ack.state;
        if (pid && s.players && s.players[pid]) return pid;
        if (name) {
          const entry = Object.values(s.players||{}).find(p=>p.name===name);
          if (entry) return entry.id;
        }
        // 토큰에 playerId가 실린 경우(서버쪽 구현 따라 다름)
        // 없으면 이후 state 갱신 때도 다시 확인
        return myPid;
      })();
      myTeam = myPid ? (state.players[myPid]?.team || null) : null;
      renderAll();
    });
  });

  socket.on('state', s => {
    state = s;
    if (!myPid && state){
      const cand = Object.values(state.players||{}).find(p=>p.name===name);
      if (cand) { myPid = cand.id; myTeam = cand.team; }
    }
    renderAll();
  });
  socket.on('chat', appendChat);
  socket.on('chatError', txt => alert(txt));

  // 채팅 전송
  chatSend.onclick = ()=>{
    const text = chatInput.value.trim(); if (!text) return;
    socket.emit('chatMessage', { message: text, channel: chatCh.value }, (ack)=>{
      if (ack && ack.error) alert('보내기 실패: ' + ack.error);
    });
    chatInput.value = '';
  };

  // ---------- 액션 처리(공격/방어/회피/아이템/패스) ----------
  function ensureMyTurn(){ if (!isMyTurn()){ alert('지금은 당신의 턴이 아닙니다'); return false; } return true; }

  // 공통 타겟 모달
  function openTargetModal(title, targets, onPick){
    targetTitle.textContent = title;
    targetList.innerHTML = '';
    targets.forEach(p=>{
      const c = document.createElement('div'); c.className='choice'; c.style.border='1px solid var(--border)'; c.style.borderRadius='12px'; c.style.padding='10px'; c.style.background='#0f1d39'; if(!p.alive){ c.style.opacity='.5'; c.style.pointerEvents='none'; }
      const nm = document.createElement('div'); nm.style.fontWeight='700'; nm.textContent = p.name + (p.alive?'':' (불능)');
      const mini = document.createElement('div'); mini.style.fontSize='12px'; mini.style.color='#aeb7cf'; mini.textContent = `HP ${p.hp}/${p.maxHp}`;
      c.appendChild(nm); c.appendChild(mini);
      c.onclick = ()=>{ closeTargetModal(); onPick && onPick(p); };
      targetList.appendChild(c);
    });
    targetModal.style.display='flex';
  }
  function closeTargetModal(){ targetModal.style.display='none'; }
  targetCancel.onclick = closeTargetModal;

  // 아이템 모달
  function openItemModal(onPick){
    itemList.innerHTML='';
    const me = state.players[myPid];
    const inv = me && me.inventory ? me.inventory : {};
    const allowed = ['디터니','공격 보정기','방어 보정기'];
    allowed.forEach(name=>{
      const count = Number(inv[name] || 0);
      const c = document.createElement('div'); c.className='choice'; c.style.border='1px solid var(--border)'; c.style.borderRadius='12px'; c.style.padding='10px'; c.style.background='#0f1d39'; if(count<=0){ c.style.opacity='.5'; c.style.pointerEvents='none'; }
      const nm = document.createElement('div'); nm.style.fontWeight='700'; nm.textContent = `${name} x${count}`;
      const mini = document.createElement('div'); mini.style.fontSize='12px'; mini.style.color='#aeb7cf';
      if (name==='디터니') mini.textContent = '아군 10 회복';
      if (name==='공격 보정기') mini.textContent = '1턴 공격 x1.5 (실패 가능)';
      if (name==='방어 보정기') mini.textContent = '1턴 방어 x1.5 (실패 가능)';
      c.appendChild(nm); c.appendChild(mini);
      if (count>0) c.onclick = ()=>{ closeItemModal(); onPick && onPick(name); };
      itemList.appendChild(c);
    });
    itemModal.style.display='flex';
  }
  function closeItemModal(){ itemModal.style.display='none'; }
  itemCancel.onclick = closeItemModal;

  // 버튼 핸들러들
  function onClickAttack(){
    if (!ensureMyTurn()) return;
    const opps = byTeam(getOppTeam(myTeam)).filter(p=>p.alive);
    if (!opps.length){ alert('공격 대상이 없습니다'); return; }
    openTargetModal('공격 대상 선택', opps, (tgt)=>{
      socket.emit('chooseAction', { kind:'attack', targetId:tgt.id }, (ack)=>{
        if (!ack || !ack.ok) { alert(ack && ack.error ? ('실패: '+ack.error) : '실패'); }
      });
    });
  }
  function onClickDefend(){
    if (!ensureMyTurn()) return;
    socket.emit('chooseAction', { kind:'defend' }, (ack)=>{
      if (!ack || !ack.ok) { alert(ack && ack.error ? ('실패: '+ack.error) : '실패'); }
    });
  }
  function onClickEvade(){
    if (!ensureMyTurn()) return;
    socket.emit('chooseAction', { kind:'evade' }, (ack)=>{
      if (!ack || !ack.ok) { alert(ack && ack.error ? ('실패: '+ack.error) : '실패'); }
    });
  }
  function onClickPass(){
    if (!ensureMyTurn()) return;
    socket.emit('chooseAction', { kind:'pass' }, (ack)=>{
      if (!ack || !ack.ok) { alert(ack && ack.error ? ('실패: '+ack.error) : '실패'); }
    });
  }
  function onClickItem(){
    if (!ensureMyTurn()) return;
    openItemModal((itemName)=>{
      if (itemName === '디터니'){
        const allies = byTeam(myTeam).filter(p=>p.alive);
        openTargetModal('회복 대상 선택', allies, (tgt)=>{
          socket.emit('chooseAction', { kind:'item', itemName, targetId:tgt.id }, (ack)=>{
            if (!ack || !ack.ok) { alert(ack && ack.error ? ('실패: '+ack.error) : '실패'); }
          });
        });
      } else {
        socket.emit('chooseAction', { kind:'item', itemName }, (ack)=>{
          if (!ack || !ack.ok) { alert(ack && ack.error ? ('실패: '+ack.error) : '실패'); }
        });
      }
    });
  }
})();
</script>
</body>
</html>
