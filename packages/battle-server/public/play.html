<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PYXIS 플레이어</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root{
      --bg:#0f1419; --panel:#1b1f25; --ink:#f5e6b8; --ink-dim:#9c9270;
      --accent:#d5b67a; --line:#313942; --radius:14px; --font-serif:'Cinzel',serif;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif}
    .container{max-width:1200px;margin:auto;padding:20px}
    header{
      font-family:var(--font-serif);font-size:32px;text-align:center;margin-bottom:16px;
      background:linear-gradient(to right,#d8c278,#ffe5a2);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent
    }
    .status-panel{background:var(--panel);padding:16px;border-radius:var(--radius);
      display:flex;gap:20px;justify-content:space-between;border:1px solid var(--line);margin-bottom:20px}
    .status-panel div{flex:1;font-size:14px}
    .board{display:grid;grid-template-columns:1fr 2fr 1fr;gap:20px}

    /* 팀/카드 */
    .team-column{background:var(--panel);padding:16px;border-radius:var(--radius);border:1px solid var(--line)}
    .team-column h3{font-family:var(--font-serif);margin:0 0 12px}
    .player-card{
      background:rgba(255,255,255,0.02);
      border:1px solid var(--line);
      border-radius:12px;
      padding:14px;
      margin-bottom:12px;
      box-shadow:0 1px 0 rgba(255,255,255,0.03) inset, 0 6px 16px rgba(0,0,0,.2);
    }
    .pc-head{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:8px}
    .pc-name{font-weight:800}
    .pc-meta{font-size:12px;color:var(--ink-dim)}
    .pc-body{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center}

    /* 원형 HP 링 + 아바타 */
    .pc-ring{
      width:54px;height:54px;border-radius:50%;
      background:conic-gradient(var(--accent) calc(var(--hp,100)*1%), #232931 0);
      display:grid;place-items:center;border:1px solid var(--line);overflow:hidden
    }
    .pc-ring-inner{
      width:42px;height:42px;border-radius:50%;
      border:1px solid var(--line);
      background: var(--avatar, var(--panel)) center/cover no-repeat;
    }

    /* HP 바 */
    .pc-hp{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
    .hpbar{position:relative;height:8px;border:1px solid var(--line);border-radius:999px;overflow:hidden;background:#10151b}
    .hpbar>.fill{position:absolute;inset:0;width:var(--hpPct,100%);background:linear-gradient(90deg,#b43d3d,#d96a6a)}
    .pc-hp .pct{font-size:12px;color:var(--ink-dim);min-width:44px;text-align:right}

    .pc-stats{display:grid;grid-template-columns:1fr 1fr;gap:4px 14px;font-size:13px;color:var(--ink-dim)}
    .pc-stats b{color:var(--ink)}
    .pc-items{margin-top:6px;font-size:12px;color:var(--ink-dim)}
    .badge-ready{font-size:11px;padding:2px 6px;border-radius:999px;background:#2a3a24;border:1px solid #375132;color:#bfe8a6;margin-left:6px}

    /* 버튼 */
    .player-actions{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;margin-top:12px}
    .player-actions button{padding:10px;border-radius:10px;border:none;background:var(--accent);color:#000;font-weight:700;cursor:pointer}
    .player-actions button:hover{background:#ffdd95}
    .player-actions button[data-action="pass"]{grid-column:1 / -1}
    .ready-row{display:flex;gap:8px;margin-top:10px}
    .ready-btn{flex:1;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0f1419;color:var(--ink);cursor:pointer}
    .ready-btn--on{background:#28402b;border-color:#3c5b42;color:#bfe8a6;font-weight:700}

    /* 공지 핀 */
    .notice{background:rgba(213,182,122,.12); border:1px solid var(--accent);
      border-radius:var(--radius); padding:12px; margin-bottom:12px;}
    .notice-title{font-family:var(--font-serif); font-size:16px; margin-bottom:6px;}
    .notice-body{white-space:pre-wrap; line-height:1.45;}
    .notice-controls{display:flex; gap:8px; margin-top:8px;}
    .notice-controls .btn{padding:8px 10px; border-radius:10px; border:1px solid var(--line);
      background:#0f1419; color:var(--ink); cursor:pointer;}
    .notice-controls .btn-primary{border:none; background:var(--accent); color:#000; font-weight:700;}

    /* 로그/채팅 */
    .log-box{background:var(--panel);padding:16px;height:420px;overflow-y:auto;font-size:13px;
      border:1px solid var(--line);border-radius:var(--radius);line-height:1.45}
    .log-line{margin:2px 0;padding:4px 8px;border-radius:8px}
    .log-line--admin{background:rgba(213,182,122,.12);border-left:3px solid var(--accent)}
    .log-line .time{color:var(--ink-dim);margin-right:6px}
    .tag{display:inline-block;font-size:11px;padding:2px 6px;border-radius:999px;border:1px solid var(--line);
      color:var(--ink-dim);margin-right:6px;vertical-align:1px}
    .tag-team{color:#000;background:var(--accent);border-color:var(--accent)}
    .tag-admin{color:#000;background:#ffe5a2;border-color:#ffe5a2;font-weight:700}

    .chat-box{background:var(--panel);padding:12px;border:1px solid var(--line);border-radius:var(--radius);
      display:flex;gap:8px;margin-top:10px}
    .chat-box input{flex:1;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0f1419;color:var(--ink)}
    .chat-box button{padding:10px 14px;border-radius:10px;border:none;background:var(--accent);color:#000;font-weight:700;cursor:pointer}
    .chat-help{margin:6px 2px 0;font-size:12px;color:var(--ink-dim)}
    .muted{font-size:12px;color:var(--ink-dim)}

    /* 타겟 모달 */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center}
    .modal.active{display:flex}
    .modal-card{width:min(640px,calc(100% - 24px));background:var(--panel);border:1px solid var(--line);
      border-radius:var(--radius);padding:16px}
    .modal-title{font-family:var(--font-serif);font-size:20px;margin-bottom:12px}
    .target-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .target-col{border:1px solid var(--line);border-radius:10px;padding:12px}
    .target-col h4{margin:0 0 8px;font-size:14px;color:var(--ink-dim)}
    .target-list{max-height:220px;overflow:auto}
    .target-item{display:flex;align-items:center;gap:8px;padding:6px 4px;border-bottom:1px solid var(--line)}
    .target-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#0f1419;color:var(--ink);cursor:pointer}
    .btn-primary{border:none;background:var(--accent);color:#000;font-weight:700}

    /* 공지 편집 모달 */
    .modal-body textarea{width:100%;min-height:140px;border-radius:10px;border:1px solid var(--line);
      background:#0f1419;color:var(--ink);padding:10px;resize:vertical}

    @media(max-width:800px){.board{grid-template-columns:1fr}.target-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header>PYXIS 전투 아레나</header>

    <div class="status-panel">
      <div>전투 상태: <span id="battleStatus">대기중</span></div>
      <div>팀 타이머: <span id="turnTimer">-</span></div>
      <div>현재 팀: <span id="currentTeam">-</span></div>
      <div>승자: <span id="winnerTeam">-</span></div>
    </div>

    <div class="board">
      <div class="team-column" id="team1Panel">
        <h3>불사조 기사단</h3>
        <div id="team1Players"></div>
      </div>

      <div>
        <!-- 공지 핀 -->
        <div class="notice" id="noticeBox" hidden>
          <div class="notice-title">📌 공지</div>
          <div class="notice-body" id="noticeBody"></div>
          <div class="notice-controls" id="noticeControls" style="display:none">
            <button class="btn btn-primary" id="noticeEditBtn">공지 수정</button>
            <button class="btn" id="noticeClearBtn">핀 해제</button>
          </div>
        </div>

        <div class="log-box" id="logBox"></div>
        <div class="chat-box">
          <input id="chatInput" type="text" placeholder="/t 팀채팅 | 일반 채팅은 그대로 입력" maxlength="300" />
          <button id="chatSend">전송</button>
        </div>
        <div class="chat-help">힌트: <code>/t 내용</code> → 같은 팀 채팅(관리자 열람 가능). 관리자 모드: <code>?admin=1</code> 또는 <code>?role=admin</code>.</div>
        <p class="muted" id="statusMsg"></p>
      </div>

      <div class="team-column" id="team2Panel">
        <h3>죽음을 먹는 자들</h3>
        <div id="team2Players"></div>
      </div>
    </div>
  </div>

  <!-- 타겟 선택 모달 -->
  <div class="modal" id="targetModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="targetTitle">
      <div class="modal-title" id="targetTitle">대상 선택</div>
      <div class="target-grid">
        <div class="target-col">
          <h4>아군</h4>
          <div class="target-list" id="allyList"></div>
        </div>
        <div class="target-col">
          <h4>적군</h4>
          <div class="target-list" id="enemyList"></div>
        </div>
      </div>
      <div class="target-actions">
        <button class="btn" id="targetCancel">취소</button>
        <button class="btn btn-primary" id="targetConfirm">선택</button>
      </div>
    </div>
  </div>

  <!-- 공지 편집 모달 -->
  <div class="modal" id="noticeModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="noticeTitle">
      <div class="modal-title" id="noticeTitle">공지 편집</div>
      <div class="modal-body">
        <textarea id="noticeTextarea" placeholder="여기에 공지 내용을 입력하세요. 줄바꿈 지원(HTML 미사용)"></textarea>
      </div>
      <div class="target-actions">
        <button class="btn" id="noticeCancel">취소</button>
        <button class="btn btn-primary" id="noticeSave">저장</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // ───────── 유틸 ─────────
  const $ = s => document.querySelector(s);
  const escapeHtml = (s='') => String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const koTime = ts => new Date(ts).toLocaleTimeString('ko-KR',{hour12:false});
  const getPid = p => p?.id || p?.pid || p?.playerId || p?.name || '';
  const isSelfPlayer = (pId, pName) => (pId && pId === playerId) || (!pId && pName && pName === playerName);

  // ───────── 상태 ─────────
  let socket=null, battleId=null, playerId=null, playerName='플레이어', playerTeam='team1';
  let isSpectator=false, isAdminSelf=false, isAdminViewer=false, turnDeadlineMs=null;
  let lastBattle=null, endedLocally=false, readyMap={}; // {playerId: bool}
  let pinnedNoticeText='';

  // API prefix fallback
  const API_PREFIXES=['/api',''];
  async function tryFetchJson(method, path, body){
    let lastErr='';
    for(const prefix of API_PREFIXES){
      try{
        const res=await fetch(prefix+path,{method,headers:{'Content-Type':'application/json'},
          body: body?JSON.stringify(body):undefined});
        const txt=await res.text();
        if(res.ok) return txt?JSON.parse(txt):{};
        lastErr=`${res.status} ${txt}`;
      }catch(e){ lastErr=e.message; }
    }
    throw new Error(`${method} ${path} 실패: ${lastErr}`);
  }
  function setMsg(t){ $('#statusMsg').textContent=t||''; }

  // ───────── 채팅/로그 ─────────
  function lineHtml({timestamp,name,message,teamOnly,team,isAdmin}){
    const time=`<span class="time">[${koTime(timestamp||Date.now())}]</span>`;
    const tags=[teamOnly?`<span class="tag tag-team">팀</span>`:'',isAdmin?`<span class="tag tag-admin">관리자</span>`:''].join('');
    const who=`<strong>${escapeHtml(name||'누군가')}</strong>`;
    const text=`: ${escapeHtml(message||'')}`;
    const cls=['log-line']; if(isAdmin) cls.push('log-line--admin');
    return `<div class="${cls.join(' ')}">${time}${tags} ${who}${text}</div>`;
  }
  function pushLogHtml(html){ const box=$('#logBox'); box.insertAdjacentHTML('beforeend',html); box.scrollTop=box.scrollHeight; }

  // ───────── 포맷터 ─────────
  function statVal(p, key, fallback=0){ return p?.stats?.[key] ?? p?.[key] ?? fallback; }
  function itemsLine(p){
    const it=p?.items;
    if(Array.isArray(it)&&it.length) return '아이템: ' + it.map(x=>`${x.name}: ${x.qty ?? 1}`).join(', ');
    if(it && typeof it==='object'){ const parts=Object.entries(it).map(([k,v])=>`${k}: ${v}`); return parts.length?('아이템: '+parts.join(', ')):'아이템: 없음'; }
    return '아이템: 없음';
  }
  function isStarted(b){
    const s=(b?.status||'').toLowerCase();
    return ['in_progress','started','active','battle','진행중','전투중'].some(x=>s.includes(x));
  }

  // ───────── 공지 핀 렌더 ─────────
  function renderNotice(){
    const box = $('#noticeBox');
    const body = $('#noticeBody');
    if(pinnedNoticeText && String(pinnedNoticeText).trim()){
      body.innerHTML = escapeHtml(String(pinnedNoticeText));
      box.hidden = false;
    } else {
      box.hidden = true;
    }
    // 관리자만 컨트롤 노출
    $('#noticeControls').style.display = isAdminSelf ? 'flex' : 'none';
  }

  // ───────── 캐릭터 카드 ─────────
  function playerCardHTML(p){
    const pid=getPid(p);
    const name=p?.name||'이름없음';
    const maxHp=p?.maxHp ?? 100;
    const hp=Math.max(0,Math.min(maxHp, p?.hp ?? maxHp));
    const pct=maxHp?Math.round((hp/maxHp)*100):0;
    const alive=p?.alive !== false;
    const pose=p?.pose || p?.stance || p?.state || '대기';
    const lifeStr=alive?'생존':'사망';
    const avatar=p?.avatar || p?.image || p?.avatarUrl || p?.imageUrl;
    const ready = (p?.ready !== undefined) ? !!p.ready : !!readyMap[pid];

    const atk=statVal(p,'attack',0), def=statVal(p,'defense',0), agi=statVal(p,'agility',0), luk=statVal(p,'luck',0);

    const showActions = isStarted(lastBattle) && !endedLocally && isSelfPlayer(pid,name) && alive && !isSpectator;
    const showReady = !isStarted(lastBattle) && isSelfPlayer(pid,name) && alive && !isSpectator;

    const actions = showActions ? `
      <div class="player-actions">
        <button data-action="attack">공격</button>
        <button data-action="defend">방어</button>
        <button data-action="counter">역공격</button>
        <button data-action="dodge">회피</button>
        <button data-action="item">아이템</button>
        <button data-action="pass">턴 넘기기</button>
      </div>` : '';

    const readyRow = showReady ? `
      <div class="ready-row">
        <button class="ready-btn ${ready?'ready-btn--on':''}" data-ready-toggle="1">
          ${ready ? '준비 취소' : '전투 준비'}
        </button>
      </div>` : '';

    return `
    <div class="player-card" data-pid="${escapeHtml(pid)}" data-name="${escapeHtml(name)}" data-team="${escapeHtml(p?.team||p?.side||'')}">
      <div class="pc-head">
        <div class="pc-name">
          ${escapeHtml(name)}
          ${ready ? '<span class="badge-ready">준비완료</span>' : ''}
        </div>
        <div class="pc-meta">${hp}/${maxHp} HP · ${lifeStr} · ${escapeHtml(pose)}</div>
      </div>
      <div class="pc-body" style="--hp:${pct};">
        <div class="pc-ring" title="HP ${pct}%">
          <div class="pc-ring-inner" style="${avatar?`--avatar:url('${String(avatar).replace(/'/g,"\\'")}')`:''}"></div>
        </div>
        <div class="pc-hp">
          <div class="hpbar"><div class="fill" style="--hpPct:${pct}%;"></div></div>
          <div class="pct">${pct}%</div>
        </div>
        <div class="pc-stats">
          <div>공격 <b>${atk}</b></div><div>방어 <b>${def}</b></div>
          <div>민첩 <b>${agi}</b></div><div>행운 <b>${luk}</b></div>
        </div>
      </div>
      <div class="pc-items">${escapeHtml(itemsLine(p))}</div>
      ${readyRow}
      ${actions}
    </div>`;
  }
  function renderPlayers(list=[], mount){
    const html=list.map(playerCardHTML).join('');
    $(mount).innerHTML = html || `<div class="muted">등록된 플레이어 없음</div>`;
  }

  // ───────── 승패/종료 ─────────
  function checkAnnihilationAndEnd(b){
    const t1=b.teams?.team1?.players ?? b.team1?.players ?? [];
    const t2=b.teams?.team2?.players ?? b.team2?.players ?? [];
    const alive1=t1.filter(p=>p.alive!==false).length;
    const alive2=t2.filter(p=>p.alive!==false).length;
    if(endedLocally) return;
    if((alive1===0 && alive2>0) || (alive2===0 && alive1>0)){
      const winner = alive1>0 ? 'team1' : 'team2';
      endedLocally = true;
      $('#battleStatus').textContent='종료';
      $('#winnerTeam').textContent = winner==='team1' ? '불사조 기사단' : '죽음을 먹는 자들';
      setMsg('전멸 감지: 전투 종료 처리됨');
      try{ socket?.emit('declareWinner', { battleId, winner }); }catch{}
      (async ()=>{
        try{ await tryFetchJson('POST', `/battles/${encodeURIComponent(battleId)}/end`, { winner }); }
        catch(_){ try{ await tryFetchJson('POST', `/battles/${encodeURIComponent(battleId)}/finish`, { winner }); } catch(__){} }
      })();
    }
  }

  // ───────── 배틀 렌더 ─────────
  function renderBattle(b){
    if(!b) return;
    lastBattle=b;
    $('#battleStatus').textContent=b.status ?? '-';
    $('#currentTeam').textContent=b.currentTeam ?? '-';
    $('#winnerTeam').textContent=b.winner ? (b.winner==='team1'?'불사조 기사단':'죽음을 먹는 자들') : (endedLocally?$('#winnerTeam').textContent:'-');

    // 공지(여러 키 지원)
    pinnedNoticeText = b.notice?.text ?? b.notice ?? b.pinnedNotice ?? b.noticeText ?? '';

    const t1=b.teams?.team1?.players ?? b.team1?.players ?? [];
    const t2=b.teams?.team2?.players ?? b.team2?.players ?? [];
    // readyMap 업데이트(서버가 p.ready 제공 시 반영)
    [...t1,...t2].forEach(p => { const pid=getPid(p); if(p.ready!==undefined) readyMap[pid]=!!p.ready; });

    renderPlayers(t1,'#team1Players');
    renderPlayers(t2,'#team2Players');
    renderNotice();

    if(Array.isArray(b.battleLog)){
      const html=b.battleLog.map(e=>lineHtml({
        timestamp:e.timestamp, name:e.name||'시스템', message:e.message, teamOnly:false, team:null, isAdmin:false
      })).join('');
      $('#logBox').innerHTML=html || '';
    }
    if(b.turnDeadline){ turnDeadlineMs=new Date(b.turnDeadline).getTime(); updateTimer(); }

    checkAnnihilationAndEnd(b);
  }
  function updateTimer(){
    if(!turnDeadlineMs) return;
    const left=Math.max(0,turnDeadlineMs-Date.now());
    const s=Math.floor(left/1000), m=Math.floor(s/60), rs=String(s%60).padStart(2,'0');
    $('#turnTimer').textContent=`${m}:${rs}`;
    if(left>0) requestAnimationFrame(updateTimer);
  }

  // ───────── 타겟팅 (2:2 이상) ─────────
  function bothSidesAtLeast2(){
    const t1 = lastBattle?.teams?.team1?.players ?? lastBattle?.team1?.players ?? [];
    const t2 = lastBattle?.teams?.team2?.players ?? lastBattle?.team2?.players ?? [];
    const alive1 = t1.filter(p => p.alive !== false).length;
    const alive2 = t2.filter(p => p.alive !== false).length;
    return alive1 >= 2 && alive2 >= 2;
  }

  let pendingAction=null;
  function openTargetModal(action){
    pendingAction = action;
    const allT1=(lastBattle?.teams?.team1?.players ?? lastBattle?.team1?.players ?? []).filter(p=>p.alive!==false);
    const allT2=(lastBattle?.teams?.team2?.players ?? lastBattle?.team2?.players ?? []).filter(p=>p.alive!==false);
    const allyList=(playerTeam==='team1')?allT1:allT2;
    const enemyList=(playerTeam==='team1')?allT2:allT1;

    $('#allyList').innerHTML = allyList.map(p=>{
      const id=getPid(p); const disabled=(action==='attack' || action==='counter');
      return `<label class="target-item"><input type="radio" name="targetSel" value="${escapeHtml(id)}" data-team="ally" ${disabled?'disabled':''}> ${escapeHtml(p.name||'이름없음')}</label>`;
    }).join('') || `<div class="muted">대상 없음</div>`;
    $('#enemyList').innerHTML = enemyList.map(p=>{
      const id=getPid(p); const disabled=(action==='defend');
      return `<label class="target-item"><input type="radio" name="targetSel" value="${escapeHtml(id)}" data-team="enemy" ${disabled?'disabled':''}> ${escapeHtml(p.name||'이름없음')}</label>`;
    }).join('') || `<div class="muted">대상 없음</div>`;

    setTimeout(()=>{
      const sel = (action==='attack' || action==='counter')
        ? '#enemyList input[type=radio]:not(:disabled)'
        : (action==='defend')
        ? '#allyList input[type=radio]:not(:disabled)'
        : '#allyList input[type=radio]:not(:disabled), #enemyList input[type=radio]:not(:disabled)';
      const first=document.querySelector(sel);
      if(first) first.checked=true;
    },0);

    $('#targetModal').classList.add('active');
    $('#targetModal').setAttribute('aria-hidden','false');
  }
  function closeTargetModal(){ $('#targetModal').classList.remove('active'); $('#targetModal').setAttribute('aria-hidden','true'); pendingAction=null; }
  function readSelectedTarget(){
    const el=document.querySelector('input[name="targetSel"]:checked');
    if(!el) return null;
    const teamKey=el.getAttribute('data-team');
    const team= teamKey==='ally'? playerTeam : (playerTeam==='team1'?'team2':'team1');
    return { id: el.value, team };
  }

  // ───────── 소켓 ─────────
  function connectSocket(){
    if(socket && socket.connected) return;
    socket=io();
    socket.on('connect',()=>{ setMsg('서버 연결됨'); socket.emit('playerAuth',{battleId,playerId}); });
    socket.on('disconnect',()=>setMsg('서버 연결 끊김'));
    socket.on('battleUpdate', renderBattle);

    // 채팅
    const onChat = (payload) => {
      if(!payload) return;
      const msg = {
        timestamp: payload.timestamp || Date.now(),
        name: payload.name || payload.playerName || '누군가',
        message: payload.message || payload.text || '',
        teamOnly: !!(payload.teamOnly || payload.scope==='team'),
        team: payload.team || payload.teamId || null,
        isAdmin: !!(payload.isAdmin || payload.role==='admin')
      };
      if (msg.teamOnly && msg.team !== playerTeam && !isAdminViewer) return;
      pushLogHtml(lineHtml(msg));
    };
    socket.on('chat', onChat);
    socket.on('chatUpdate', onChat);
    socket.on('battleChat', onChat);

    // 준비 상태 브로드캐스트
    socket.on('readyUpdate', (payload)=>{
      if(!payload) return;
      readyMap[payload.playerId] = !!payload.ready;
      if(lastBattle){
        const t1=lastBattle.teams?.team1?.players ?? lastBattle.team1?.players ?? [];
        const t2=lastBattle.teams?.team2?.players ?? lastBattle.team2?.players ?? [];
        renderPlayers(t1,'#team1Players'); renderPlayers(t2,'#team2Players');
      }
    });

    // 공지 업데이트
    socket.on('noticeUpdate', (payload)=>{
      // payload: { text: string }
      pinnedNoticeText = (payload && typeof payload.text==='string') ? payload.text : '';
      renderNotice();
    });
  }

  // ───────── 액션/준비/공지/채팅 ─────────
  function sendAction(action, target){
    if(endedLocally){ setMsg('전투가 종료되었습니다.'); return; }
    if(!socket?.connected){ setMsg('서버 연결 전입니다.'); return; }
    if(!battleId || !playerId){ setMsg('배틀 참가 정보가 없습니다.'); return; }
    const payload={battleId,playerId,action};
    if(target?.id){ payload.targetId=target.id; payload.targetTeam=target.team; }
    socket.emit('playerAction', payload);
  }
  function requireTargetFor(action){
    if(!bothSidesAtLeast2()) return false;
    return (action==='attack' || action==='defend' || action==='item' || action==='counter');
  }
  function delegateActions(){
    const onClick = (e) => {
      const card = e.target.closest('.player-card');
      if(!card) return;

      // 준비 토글
      const rbtn = e.target.closest('[data-ready-toggle]');
      if(rbtn){
        if(isSpectator) return;
        const pid = card.getAttribute('data-pid');
        if(!isSelfPlayer(pid, card.getAttribute('data-name'))) return;
        const curr = !!readyMap[playerId];
        setReady(!curr);
        return;
      }

      // 액션
      const btn = e.target.closest('button[data-action]');
      if(!btn) return;
      const pid = card.getAttribute('data-pid');
      const pname = card.getAttribute('data-name');
      if(!isSelfPlayer(pid, pname)) return;

      const action = btn.getAttribute('data-action');
      if(action==='dodge' || action==='pass'){ sendAction(action); return; }
      if(requireTargetFor(action)){ openTargetModal(action); } else { sendAction(action); }
    };
    $('#team1Players').addEventListener('click', onClick);
    $('#team2Players').addEventListener('click', onClick);

    // 공지 컨트롤(관리자 전용)
    $('#noticeEditBtn').onclick = ()=>{ if(isAdminSelf) openNoticeModal(); };
    $('#noticeClearBtn').onclick = ()=>{ if(isAdminSelf) clearNotice(); };
  }

  async function setReady(ready){
    if(!playerId || !battleId) return;
    // 낙관적 업데이트
    readyMap[playerId] = !!ready;
    if(lastBattle){
      const t1=lastBattle.teams?.team1?.players ?? lastBattle.team1?.players ?? [];
      const t2=lastBattle.teams?.team2?.players ?? lastBattle.team2?.players ?? [];
      renderPlayers(t1,'#team1Players'); renderPlayers(t2,'#team2Players');
    }
    try{ socket?.emit('playerReady', { battleId, playerId, ready }); }catch{}
    // REST 폴백
    try{
      await tryFetchJson('POST', `/battles/${encodeURIComponent(battleId)}/players/${encodeURIComponent(playerId)}/ready`, { ready });
    }catch(_e1){
      try{ await tryFetchJson('POST', `/battles/${encodeURIComponent(battleId)}/ready`, { playerId, ready }); }
      catch(_e2){ try{ await tryFetchJson('POST', `/battles/${encodeURIComponent(battleId)}/playerReady`, { playerId, ready }); }catch{} }
    }
  }

  // ───────── 공지 편집/전송 ─────────
  function openNoticeModal(){
    $('#noticeTextarea').value = String(pinnedNoticeText||'');
    $('#noticeModal').classList.add('active');
    $('#noticeModal').setAttribute('aria-hidden','false');
  }
  function closeNoticeModal(){
    $('#noticeModal').classList.remove('active');
    $('#noticeModal').setAttribute('aria-hidden','true');
  }
  async function saveNotice(text){
    pinnedNoticeText = String(text||'');
    renderNotice();
    try{ socket?.emit('pinNotice', { battleId, text: pinnedNoticeText }); }catch{}
    // REST 폴백
    try{
      await tryFetchJson('POST', `/battles/${encodeURIComponent(battleId)}/notice`, { text: pinnedNoticeText });
    }catch(_){
      try{ await tryFetchJson('POST', `/battles/${encodeURIComponent(battleId)}/pin`, { notice: pinnedNoticeText }); }catch(__){}
    }
  }
  async function clearNotice(){
    pinnedNoticeText = '';
    renderNotice();
    try{ socket?.emit('clearNotice', { battleId }); }catch{}
    // REST 폴백
    try{
      await tryFetchJson('DELETE', `/battles/${encodeURIComponent(battleId)}/notice`);
    }catch(_){
      try{ await tryFetchJson('POST', `/battles/${encodeURIComponent(battleId)}/notice`, { text: '' }); }catch(__){}
    }
  }

  function parseChatInput(raw){
    let text=(raw||'').trim(); let teamOnly=false;
    if(/^\/t\s+/i.test(text)){ teamOnly=true; text=text.replace(/^\/t\s+/i,'').trim(); }
    return { text, teamOnly };
  }
  function sendChat(){
    const input=$('#chatInput'); const raw=input.value;
    if(!raw || !raw.trim()) return;
    if(isSpectator){ setMsg('관전 모드: 채팅 입력 불가'); return; }
    if(!socket?.connected){ setMsg('서버 연결 전입니다.'); return; }

    const { text, teamOnly } = parseChatInput(raw);
    const payload={ battleId, playerId, name:playerName, team:playerTeam,
      message:text, teamOnly, scope:teamOnly?'team':'all', isAdmin:isAdminSelf, role:isAdminSelf?'admin':'player' };

    let acked=false;
    try{ socket.timeout(2000).emit('chat', payload, (err)=>{ if(!err) acked=true; }); }catch{}
    setTimeout(()=>{ if(!acked) try{ socket.emit('playerChat', payload); }catch{} },300);

    pushLogHtml(lineHtml({ timestamp:Date.now(), name:playerName, message:text, teamOnly, team:playerTeam, isAdmin:isAdminSelf }));
    input.value='';
  }

  // ───────── 참가(클라에서 스탯/아이템 전송 X) ─────────
  async function joinBattle(){
    const q=new URLSearchParams(location.search);
    battleId=q.get('battle');
    playerName=q.get('name')||'플레이어';
    playerTeam=q.get('team')||'team1';
    isSpectator=(playerTeam==='spectator');
    isAdminSelf = q.get('admin')==='1' || (q.get('role')||'').toLowerCase()==='admin';
    isAdminViewer = isAdminSelf;

    if(isSpectator){ $('#chatInput').disabled=true; $('#chatSend').disabled=true; setMsg('관전 모드: 채팅 입력 불가'); }
    if(!battleId){ setMsg('쿼리에 ?battle=배틀ID 필요'); return; }

    const cacheKey=`px_player_${battleId}_${playerName}`;
    const cached=localStorage.getItem(cacheKey);
    if(cached){ try{ const obj=JSON.parse(cached); if(obj?.playerId){ playerId=obj.playerId; connectSocket(); return; } }catch{} }

    try{
      const resp=await tryFetchJson('POST', `/battles/${encodeURIComponent(battleId)}/players`, {
        name:playerName, team:playerTeam
      });
      playerId = resp?.player?.id || resp?.id || resp?.playerId;
      if(!playerId) throw new Error('playerId 획득 실패');
      localStorage.setItem(cacheKey, JSON.stringify({playerId, name:playerName, team:playerTeam}));
      connectSocket();
    }catch(e){
      setMsg('참가 실패: '+(e.message||e));
      alert('참가 실패: '+(e.message||e));
    }
  }

  // ───────── 모달 바인딩 ─────────
  function bindModals(){
    // 타겟 모달
    $('#targetCancel').onclick = closeTargetModal;
    $('#targetConfirm').onclick = () => {
      const sel=readSelectedTarget();
      if(!sel){ setMsg('대상을 선택해 주세요.'); return; }
      const act=pendingAction; closeTargetModal(); sendAction(act, sel);
    };
    $('#targetModal').addEventListener('click', e=>{ if(e.target.id==='targetModal') closeTargetModal(); });
    window.addEventListener('keydown', e=>{ if(e.key==='Escape' && $('#targetModal').classList.contains('active')) closeTargetModal(); });

    // 공지 모달
    $('#noticeCancel').onclick = closeNoticeModal;
    $('#noticeSave').onclick = () => {
      const text = $('#noticeTextarea').value;
      closeNoticeModal();
      saveNotice(text);
    };
    $('#noticeModal').addEventListener('click', e=>{ if(e.target.id==='noticeModal') closeNoticeModal(); });
  }

  // ───────── init ─────────
  window.onload=()=>{
    joinBattle();
    delegateActions();
    bindModals();
    $('#chatSend').onclick=sendChat;
    $('#chatInput').addEventListener('keydown',e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendChat(); } });
  };
})();
</script>
</body>
</html>
