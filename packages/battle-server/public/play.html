<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>PYXIS - 전투 플레이어</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="/socket.io/socket.io.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    :root{
      --deep-navy:#0a0f1a; --midnight:#121827; --navy-mist:#1a202c;

      --glass-dark:rgba(201,169,110,.03);
      --glass:rgba(201,169,110,.06);
      --glass-br:rgba(201,169,110,.12);

      --pyxis-gold:#c9a96e; --pyxis-gold-dark:#b8975f;
      --pyxis-gold-light:#d8bd86; --pyxis-gold-bright:#e6cf9e; --pyxis-shimmer:#f2e5c7;

      --text:#f8f4ec; --text-2:#d4c7b0; --text-muted:#9a8d7a;

      --line:rgba(201,169,110,.18); --line-strong:rgba(201,169,110,.28);

      --phoenix-red:#d2691e; --death-eater-green:#2f4f2f;

      --radius:16px;
      --serif:'Playfair Display',serif;
      --sans:'Inter',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text); font-family:var(--sans);
      background:
        radial-gradient(1200px 1200px at 20% 0%, rgba(201,169,110,.08), transparent 60%),
        radial-gradient(800px 800px at 80% 100%, rgba(201,169,110,.06), transparent 60%),
        linear-gradient(135deg, var(--deep-navy) 0%, var(--midnight) 45%, var(--navy-mist) 100%);
      overflow-x:hidden;
    }
    .container{max-width:1300px;margin:0 auto;padding:20px}

    /* Header */
    .brand{
      font-family:var(--serif); font-weight:700;
      font-size:clamp(28px,4vw,40px); text-align:center; letter-spacing:.04em;
      margin:6px 0 18px;
      background:linear-gradient(135deg,var(--pyxis-gold),var(--pyxis-shimmer),var(--pyxis-gold-bright));
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
      position:relative; display:inline-block; width:100%;
    }
    .brand::before,.brand::after{
      content:'✦'; position:absolute; top:.05em; font-size:.45em; color:var(--pyxis-gold-light);
      animation:twinkle 2.6s ease-in-out infinite alternate;
    }
    .brand::before{left:12%;animation-delay:0s}
    .brand::after{right:12%;animation-delay:1.2s}
    @keyframes twinkle{0%,100%{opacity:.45;transform:scale(.85)}50%{opacity:1;transform:scale(1.15)}}

    /* Cards */
    .card{
      background:linear-gradient(145deg,var(--glass-dark),var(--glass));
      backdrop-filter:blur(14px);
      border:1px solid var(--line); border-radius:var(--radius);
      box-shadow:0 8px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
      padding:16px; margin-bottom:18px;
      transition:box-shadow .25s ease, border-color .25s ease, transform .2s ease;
    }
    .card:hover{border-color:var(--line-strong); box-shadow:0 12px 36px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04); transform:translateY(-2px)}
    .card h2,.card h3{font-family:var(--serif); color:var(--pyxis-gold-bright); margin:0 0 10px; letter-spacing:.02em; font-weight:600}

    /* Grids */
    .grid-3{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
    .row{display:grid; grid-template-columns: 1fr 120px; gap:10px}

    label{display:block; font-size:13px; color:var(--text-2); margin:6px 0 6px}
    input,button,select{width:100%; padding:12px 12px; font-size:15px; border-radius:12px; outline:none; transition:border .2s ease, background .2s ease, box-shadow .2s ease, transform .08s ease}
    input,select{background:rgba(16,21,35,.75); border:1px solid var(--line); color:var(--text)}
    input:focus,select:focus{border-color:var(--pyxis-gold); box-shadow:0 0 0 2px rgba(201,169,110,.18)}
    .btn{border:1px solid var(--pyxis-gold-dark); background:linear-gradient(135deg,var(--pyxis-gold-dark),var(--pyxis-gold)); color:#091018; font-weight:700; cursor:pointer}
    .btn:hover{filter:brightness(1.06)} .btn:active{transform:translateY(1px)}
    .btn-ghost{background:rgba(16,21,35,.65); border:1px solid var(--line); color:var(--text); font-weight:600}
    .btn-ghost:hover{border-color:var(--line-strong)}
    .muted{color:var(--text-muted); font-size:13px}
    .hidden{display:none !important}

    /* Battlefield */
    .battlefield{display:grid; grid-template-columns:1.2fr 1.6fr 1.2fr; gap:20px; margin:20px 0}

    .status-bar{
      background:linear-gradient(145deg,var(--glass),var(--glass-br));
      border:1px solid var(--line); border-radius:var(--radius);
      padding:12px; margin-bottom:16px; backdrop-filter:blur(14px);
      display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px;
    }
    .status-pill{display:inline-block; padding:6px 12px; border-radius:999px; border:1px solid var(--line); background:rgba(201,169,110,.08); color:var(--pyxis-gold-bright); font-weight:600; font-size:13px}

    .team-zone{
      background:linear-gradient(145deg, rgba(201,169,110,.05), rgba(201,169,110,.09));
      border:1px solid var(--line); border-radius:var(--radius); padding:16px; backdrop-filter:blur(14px); position:relative; overflow:hidden; box-shadow:0 8px 24px rgba(0,0,0,.3);
    }
    .team-zone::before{content:''; position:absolute; top:0; left:0; right:0; height:3px; opacity:0; transition:opacity .3s ease}
    .team-zone.phoenix::before{background:linear-gradient(90deg,var(--phoenix-red),transparent); opacity:1}
    .team-zone.death-eater::before{background:linear-gradient(90deg,var(--death-eater-green),transparent); opacity:1}

    .team-header{display:flex; align-items:center; justify-content:space-between; margin-bottom:12px}
    .team-name{font-family:var(--serif); color:var(--pyxis-gold-bright); font-weight:700; font-size:16px}
    .team-badge{padding:4px 8px; border-radius:12px; font-size:11px; font-weight:700; border:1px solid var(--line)}
    .phoenix .team-badge{background:rgba(210,105,30,.2); color:#ff8c42; border-color:#d2691e}
    .death-eater .team-badge{background:rgba(47,79,47,.2); color:#90ee90; border-color:#2f4f2f}

    .player-card{border:1px solid var(--line); border-radius:14px; padding:12px; background:rgba(12,16,26,.6); margin-bottom:10px; position:relative; overflow:hidden; transition:all .25s ease}
    .player-card.me{border-color:var(--pyxis-gold); background:linear-gradient(145deg, rgba(201,169,110,.08), rgba(201,169,110,.04)); box-shadow:0 0 20px rgba(201,169,110,.15)}
    .player-card.current-turn{border-color:var(--pyxis-gold-bright); box-shadow:0 0 25px rgba(201,169,110,.25); animation:pulse 2s ease-in-out infinite alternate}
    @keyframes pulse{0%{box-shadow:0 0 20px rgba(201,169,110,.2)}100%{box-shadow:0 0 30px rgba(201,169,110,.4)}}

    .pc-grid{display:grid; grid-template-columns:auto 1fr auto; gap:12px; align-items:center}
    .ring{width:56px; height:56px; border-radius:50%; background:conic-gradient(var(--pyxis-gold) calc(var(--hp,100)*1%), #263041 0); display:grid; place-items:center; border:2px solid var(--line); position:relative; overflow:hidden}
    .ring:after{content:''; position:absolute; inset:2px; border-radius:50%; background:conic-gradient(transparent calc(var(--hp,100)*1%), rgba(201,169,110,.12) 0); animation:ringpulse 2s ease-in-out infinite alternate}
    @keyframes ringpulse{0%{box-shadow:inset 0 0 10px rgba(201,169,110,.22)}100%{box-shadow:inset 0 0 18px rgba(201,169,110,.36)}}
    .avatar{width:44px; height:44px; border-radius:50%; border:1px solid var(--line); background:var(--avatar, linear-gradient(135deg, #0f1724, #1b2232)) center/cover no-repeat; z-index:1}

    .pmeta .name{font-weight:700; color:var(--text)}
    .pmeta .sub{font-size:12px; color:var(--text-muted)}
    .pmeta .stats{font-size:11px; color:var(--text-muted); margin-top:4px}

    .hpbar{position:relative; height:8px; border-radius:6px; border:1px solid var(--line); background:#151c28; overflow:hidden; margin-top:6px}
    .hpbar .fill{position:absolute; inset:0; width:var(--w,100%); background:linear-gradient(90deg, var(--pyxis-gold-dark), var(--pyxis-gold)); transition:width .25s ease}

    .action-panel{background:rgba(12,16,26,.7); border:1px solid var(--line); border-radius:12px; padding:12px; margin-top:12px}
    .action-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-bottom:8px}
    .action-btn{padding:10px; border-radius:10px; border:1px solid var(--line); background:linear-gradient(135deg,var(--pyxis-gold-dark),var(--pyxis-gold)); color:#091018; font-weight:700; cursor:pointer; transition:all .15s ease; font-size:13px}
    .action-btn:hover{transform:translateY(-1px); box-shadow:0 4px 12px rgba(201,169,110,.3)}
    .action-btn:disabled{opacity:.4; cursor:not-allowed; transform:none; box-shadow:none}
    .action-btn.pass{background:linear-gradient(135deg,#6b6b6b,#8a8a8a); border-color:#797979; grid-column:1 / -1}

    .command-center{background:linear-gradient(145deg, rgba(201,169,110,.08), rgba(201,169,110,.12)); border:1px solid var(--pyxis-gold); border-radius:var(--radius); padding:16px; backdrop-filter:blur(16px); box-shadow:0 8px 24px rgba(201,169,110,.15)}

    .log-section,.chat-section{background:rgba(12,16,26,.6); border:1px solid var(--line); border-radius:12px; padding:10px; margin-bottom:12px; font-size:13px; line-height:1.45; box-shadow:inset 0 2px 4px rgba(0,0,0,.25)}
    .log-section{height:250px; overflow-y:auto}
    .chat-section{height:200px; overflow-y:auto}

    .logline{padding:4px 6px; border-radius:6px; margin:2px 0}
    .logline:hover{background:rgba(201,169,110,.06)}
    .logline .t{color:var(--text-muted); margin-right:6px; font-weight:600}
    .tag{display:inline-block; padding:2px 6px; border-radius:999px; border:1px solid var(--line); color:var(--text-2); font-size:10px; font-weight:600; margin-right:6px; vertical-align:1px}
    .tag-admin{background:var(--pyxis-shimmer); color:#0a0f1a; border-color:var(--pyxis-shimmer)}
    .tag-team{background:var(--pyxis-gold); color:#0a0f1a; border-color:var(--pyxis-gold)}

    .chatbox{display:flex; gap:8px; margin-top:8px}

    /* Target modal */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:50}
    .modal.show{display:flex}
    .modal .panel{width:min(520px, 92vw); background:linear-gradient(145deg, var(--glass-dark), var(--glass)); border:1px solid var(--line); border-radius:14px; padding:14px}
    .targets{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:8px}
    .target-btn{border:1px solid var(--line); background:rgba(16,21,35,.65); color:var(--text); border-radius:10px; padding:10px; display:flex; gap:10px; align-items:center; cursor:pointer; transition:all .15s ease}
    .target-btn:hover{border-color:var(--line-strong); transform:translateY(-1px)}

    /* Responsive */
    @media (max-width:1200px){ .battlefield{grid-template-columns:1fr 1fr; gap:16px} .command-center{grid-column:1 / -1; order:-1} }
    @media (max-width:800px){ .battlefield{grid-template-columns:1fr} .log-section{height:200px} .chat-section{height:150px} .action-grid{grid-template-columns:1fr} .grid-3{grid-template-columns:1fr} .row{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="container">
    <div class="brand">PYXIS 전투 플레이어</div>

    <!-- Auth -->
    <section id="auth" class="card">
      <h2>전투 참가</h2>
      <div class="grid-3">
        <div>
          <label for="playerName">플레이어 이름</label>
          <input id="playerName" type="text" placeholder="이름 입력" />
        </div>
        <div>
          <label for="battleId">전투 ID</label>
          <input id="battleId" type="text" placeholder="전투 ID" />
        </div>
        <div>
          <label for="otp">플레이어 OTP</label>
          <input id="otp" type="text" placeholder="OTP" />
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <div>
          <label for="avatarFile">아바타 이미지 (선택)</label>
          <input id="avatarFile" type="file" accept="image/*" />
        </div>
        <button id="btnJoin" class="btn">전투 참가</button>
      </div>
      <p class="muted" style="margin-top:6px;">
        URL 쿼리(battle, token, name, pid)로 자동 인식됩니다.
        관리자가 설정한 캐릭터 정보가 자동으로 적용됩니다.
      </p>
    </section>

    <!-- Main -->
    <section id="main" class="hidden">
      <div class="status-bar">
        <div id="statusPill" class="status-pill">-</div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="btnCopyLink" class="btn-ghost" style="padding:6px 12px;">현재 화면 링크 복사</button>
          <label class="muted" style="display:flex;align-items:center;gap:4px;">
            <input type="checkbox" id="viewTeamOnly" /> 팀 채팅만 보기
          </label>
        </div>
      </div>

      <div class="battlefield">
        <!-- Team 1 -->
        <div class="team-zone phoenix">
          <div class="team-header">
            <div class="team-name">불사조 기사단</div>
            <div class="team-badge">PHOENIX</div>
          </div>
          <div id="team1List"></div>
        </div>

        <!-- Middle -->
        <div class="command-center">
          <h3 style="margin:0 0 10px;">전투 로그</h3>
          <div id="log" class="log-section"></div>

          <h3 style="margin:12px 0 8px;">실시간 채팅</h3>
          <div id="chat" class="chat-section"></div>
          <div class="chatbox">
            <input id="chatInput" type="text" placeholder="/t 로 팀 채팅, 미입력 시 전체 채팅" />
            <button id="btnSendChat" class="btn" style="padding:8px 12px;">보내기</button>
          </div>
        </div>

        <!-- Team 2 -->
        <div class="team-zone death-eater">
          <div class="team-header">
            <div class="team-name">죽음을 먹는 자들</div>
            <div class="team-badge">DEATH EATER</div>
          </div>
          <div id="team2List"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- Target Modal -->
  <div id="targetModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="targetTitle">
    <div class="panel">
      <h3 id="targetTitle">대상 선택</h3>
      <div class="targets" id="targetList"></div>
      <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end;">
        <button id="btnTargetCancel" class="btn-ghost" style="width:auto;padding:8px 12px;">취소</button>
      </div>
    </div>
  </div>

<script>
(() => {
  'use strict';

  // ===== Helpers =====
  const $  = (s) => document.querySelector(s);
  const $$ = (s) => document.querySelectorAll(s);
  const esc = (s='') => String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const fmtTime = (t) => new Date(t).toLocaleTimeString();
  const qs = () => {
    const p = new URLSearchParams(location.search);
    return {
      battle: p.get('battle') || p.get('b'),
      token:  p.get('token')  || p.get('otp') || p.get('t'),
      name:   p.get('name')   || p.get('n'),
      pid:    p.get('pid')
    };
  };

  async function fileToDataURL(file, maxBytes=256*1024){
    if(!file) return null;
    if(file.size > maxBytes){ alert('아바타 파일이 너무 큽니다 (최대 256KB).'); return null; }
    return new Promise((resolve,reject)=>{
      const fr = new FileReader();
      fr.onload = () => resolve(fr.result);
      fr.onerror = () => reject(fr.error);
      fr.readAsDataURL(file);
    });
  }

  // ===== State =====
  let socket = null;
  let battleId = null;
  let playerOtp = null;
  let myId = null;
  let myName = null;
  let myTeam = null;

  let currentBattle = null;
  let actionLock = false;
  let pendingAction = null; // { type, scope: 'enemy'|'ally', itemType? }
  let avatarDataURL = null;

  // ===== Socket =====
  function connectSocket(){
    if(socket){ try{ socket.disconnect(); }catch(_){ } }

    socket = io({ path: '/socket.io/', transports: ['websocket', 'polling'] });

    socket.on('connect', () => {
      // 이름 또는 ID로 인증
      if(myId) socket.emit('playerAuth', { battleId, otp: playerOtp, playerId: myId });
      else     socket.emit('playerAuth', { battleId, otp: playerOtp, playerName: myName });
    });

    socket.on('authSuccess', async (data) => {
      if(data?.player){
        myId = data.player.id;
        myName = data.player.name;
        myTeam = data.player.team;
      }
      if(data?.battle){
        currentBattle = data.battle;
        hydrateUI(data.battle);
      }
      $('#auth').classList.add('hidden');
      $('#main').classList.remove('hidden');

      // 아바타 업로드 선택되어 있으면 즉시 전송
      if(avatarDataURL){
        socket.emit('updateAvatar', { battleId, playerId: myId, dataUrl: avatarDataURL });
      }
    });

    socket.on('authError', (msg) => alert(msg || '인증 실패'));

    socket.on('battleUpdate', (battle) => {
      currentBattle = battle;
      hydrateUI(battle);
    });

    socket.on('actionSuccess', () => { actionLock = false; });
    socket.on('actionError', (msg) => { actionLock = false; alert(msg || '행동 실패'); });

    socket.on('chatMessage', ({ sender, message, senderType, channel, timestamp, team }) => {
      if(!message) return;
      appendChatMessage({
        sender: sender || '알 수 없음',
        message,
        senderType: senderType || 'system',
        channel: channel || 'all',
        timestamp: timestamp || Date.now(),
        team: team || null
      });
    });

    socket.on('connect_error', (err) => console.warn('소켓 오류:', err?.message || err));
  }

  // ===== Render =====
  function hydrateUI(b){
    if(!b) return;
    renderStatus(b);
    renderTeams(b);
    renderLog(b);
    renderChat(b);
  }

  function renderStatus(b){
    const currentTeamName = b.currentTeam === 'team1' ? '불사조 기사단' :
                            b.currentTeam === 'team2' ? '죽음을 먹는 자들' : '-';
    $('#statusPill').textContent =
      `상태: ${b.status || '-'} | 라운드: ${b.roundNumber ?? '-'} | 턴: ${b.turnNumber ?? '-'} | 현재 팀: ${currentTeamName}`;
  }

  function renderTeams(b){
    const renderList = (teamKey, rootSel) => {
      const root = $(rootSel);
      const team = b.teams?.[teamKey] || { players: [] };
      root.innerHTML = (team.players || []).map(p => {
        const hpPct = Math.max(0, Math.min(100, Math.round((p.hp ?? 0) * 100 / (p.maxHp || 100))));
        const dead  = p.alive === false;
        const avatarStyle = p.imageData
          ? `style="--avatar: url('${esc(p.imageData)}');"`
          : (p.imageUrl ? `style="--avatar: url('${esc(p.imageUrl)}');"` : '');
        const isMe  = p.id === myId;
        const isCurrentTurn = (b.currentTeam === p.team && p.alive && !p.hasActed && b.status === 'ongoing');

        const statsLine = `ATK ${p.stats?.attack ?? '-'} · DEF ${p.stats?.defense ?? '-'} · AGI ${p.stats?.agility ?? '-'} · LUK ${p.stats?.luck ?? '-'}`;
        const inventoryLine = (p.inventory && p.inventory.length > 0) ? p.inventory.join(', ') : '아이템 없음';

        let actionArea = '';
        if(isMe && !dead){
          const canAct = isCurrentTurn;
          const dis = canAct ? '' : 'disabled';

          actionArea = `
            <div class="action-panel">
              <div class="action-grid">
                <button class="action-btn" data-act="attack" ${dis}>공격</button>
                <button class="action-btn" data-act="defend" ${dis}>방어</button>
                <button class="action-btn" data-act="dodge"  ${dis}>회피</button>
                <button class="action-btn" data-act="item"   ${dis}>아이템</button>
              </div>
              <button class="action-btn pass" data-act="pass" ${dis}>턴 넘기기</button>
            </div>
          `;
        }

        const cardClass = `player-card ${isMe ? 'me' : ''} ${isCurrentTurn ? 'current-turn' : ''}`;

        return `
          <div class="${cardClass}" ${dead ? 'style="opacity:.65; filter:grayscale(0.15)"' : ''} data-player-id="${p.id}">
            <div class="pc-grid">
              <div class="ring" style="--hp:${hpPct}">
                <div class="avatar" ${avatarStyle}></div>
              </div>
              <div class="pmeta">
                <div class="name">${esc(p.name||'플레이어')}${dead ? ' <span style="color:#ff6b6b;">[사망]</span>':''}</div>
                <div class="stats">${statsLine}</div>
                <div class="hpbar" aria-label="HP"><div class="fill" style="--w:${hpPct}%"></div></div>
                <div class="sub" style="margin-top:4px;font-size:11px;color:var(--text-muted);">
                  HP ${p.hp ?? 0} / ${p.maxHp ?? 100} (${hpPct}%) | ${inventoryLine}
                </div>
              </div>
              <div>${isCurrentTurn ? '<div style="color:var(--pyxis-gold);font-size:10px;font-weight:700;">행동 차례</div>' : ''}</div>
            </div>
            ${actionArea}
          </div>
        `;
      }).join('') || `<div class="muted">플레이어 없음</div>`;

      // bind action buttons
      root.querySelectorAll('.action-btn').forEach(btn => btn.addEventListener('click', onActionButton));
    };

    renderList('team1', '#team1List');
    renderList('team2', '#team2List');
  }

  function renderLog(b){
    const log = $('#log');
    log.innerHTML = (b.battleLog || [])
      .map(e => `<div class="logline"><span class="t">[${fmtTime(e.timestamp)}]</span>${esc(e.message || '')}</div>`)
      .join('');
    log.scrollTop = log.scrollHeight;
  }

  function renderChat(b){
    const chat = $('#chat');
    const teamOnly = $('#viewTeamOnly').checked;

    const filtered = (b.chatLog || []).filter(c => {
      if(!teamOnly) return true;
      return c.channel === 'team' && c.team === myTeam;
    });

    chat.innerHTML = filtered.map(c => {
      const tag = c.senderType === 'admin' ? '<span class="tag tag-admin">관리자</span>' :
                  (c.channel === 'team' ? '<span class="tag tag-team">팀</span>' : '<span class="tag">전체</span>');
      return `<div class="logline"><span class="t">[${fmtTime(c.timestamp)}]</span>${tag} <b>${esc(c.sender||'-')}</b>: ${esc(c.message||'')}</div>`;
    }).join('');
    chat.scrollTop = chat.scrollHeight;
  }

  function appendChatMessage(msg){
    const chat = $('#chat');
    const teamOnly = $('#viewTeamOnly').checked;
    if(teamOnly && !(msg.channel === 'team' && msg.team === myTeam)) return; // 필터링

    const tag = msg.senderType === 'admin' ? '<span class="tag tag-admin">관리자</span>' :
                (msg.channel === 'team' ? '<span class="tag tag-team">팀</span>' : '<span class="tag">전체</span>');
    const line = `<div class="logline"><span class="t">[${fmtTime(msg.timestamp)}]</span>${tag} <b>${esc(msg.sender||'-')}</b>: ${esc(msg.message||'')}</div>`;
    chat.insertAdjacentHTML('beforeend', line);
    chat.scrollTop = chat.scrollHeight;
  }

  // ===== Actions =====
  function onActionButton(e){
    const el = e.currentTarget;
    const act = el.dataset.act;
    if(!act || actionLock) return;

    if(act === 'attack'){
      pendingAction = { type: 'attack', scope: 'enemy' };
      openTargetModal('공격 대상 선택', collectTargets('enemy'));
      return;
    }

    if(act === 'item'){
      const me = findMe(currentBattle);
      if(!me || !Array.isArray(me.inventory) || me.inventory.length === 0){
        alert('사용 가능한 아이템이 없습니다.');
        return;
      }
      const pick = prompt(`아이템을 선택하세요:\n${me.inventory.join(', ')}`);
      if(!pick) return;
      const itemType = pick.trim();

      const needsAllyTarget = /디터니|회복|힐|치유/i.test(itemType);
      const needsEnemyTarget = false; // 현재 아이템은 적 대상 없음

      if(needsAllyTarget){
        pendingAction = { type: 'item', scope: 'ally', itemType };
        openTargetModal('아이템 사용 대상(아군) 선택', collectTargets('ally'));
        return;
      }
      if(needsEnemyTarget){
        pendingAction = { type: 'item', scope: 'enemy', itemType };
        openTargetModal('아이템 사용 대상(적군) 선택', collectTargets('enemy'));
        return;
      }
      // 대상 불필요
      emitAction({ type: 'item', itemType });
      return;
    }

    if(act === 'defend'){ emitAction({ type:'defend' }); return; }
    if(act === 'dodge'){  emitAction({ type:'dodge'  }); return; }
    if(act === 'pass'){   emitAction({ type:'pass'   }); return; }
  }

  function emitAction(payload){
    if(!socket || socket.disconnected) return alert('연결이 끊어졌습니다.');
    if(actionLock) return;
    actionLock = true;
    try{
      socket.emit('playerAction', { battleId, playerId: myId, action: payload });
    }catch(e){
      actionLock = false;
      alert('행동 전송 실패');
    }
  }

  // ===== Target selection =====
  function collectTargets(scope){
    if(!currentBattle) return [];
    const all = [
      ...(currentBattle.teams?.team1?.players || []),
      ...(currentBattle.teams?.team2?.players || []),
    ].filter(p => p.alive !== false);

    const me = all.find(p => p.id === myId);
    if(!me) return [];

    return scope === 'enemy' ? all.filter(p => p.team !== me.team) : all.filter(p => p.team === me.team);
  }

  function openTargetModal(title, targets){
    if(!targets || targets.length === 0){
      alert('선택 가능한 대상이 없습니다.');
      pendingAction = null;
      return;
    }
    $('#targetTitle').textContent = title;
    const root = $('#targetList');
    root.innerHTML = targets.map(t => {
      const hpPct = Math.max(0, Math.min(100, Math.round((t.hp ?? 0) * 100 / (t.maxHp || 100))));
      const avatarStyle = t.imageData ? `style="--avatar: url('${esc(t.imageData)}');"` :
                          (t.imageUrl ? `style="--avatar: url('${esc(t.imageUrl)}');"` : '');
      return `
        <button class="target-btn" data-id="${t.id}">
          <span class="ring" style="--hp:${hpPct}"><span class="avatar" ${avatarStyle}></span></span>
          <span style="text-align:left;">
            <div style="font-weight:700">${esc(t.name || '플레이어')}</div>
            <div style="font-size:12px; color:var(--text-muted)">HP ${t.hp ?? 0}/${t.maxHp ?? 100} (${hpPct}%)</div>
          </span>
        </button>
      `;
    }).join('');
    root.querySelectorAll('.target-btn').forEach(btn => btn.addEventListener('click', () => chooseTarget(btn.dataset.id)));
    $('#targetModal').classList.add('show');
  }

  function chooseTarget(id){
    const act = pendingAction;
    pendingAction = null;
    $('#targetModal').classList.remove('show');
    if(!act) return;

    if(act.type === 'attack'){ emitAction({ type:'attack', targetId:id }); return; }
    if(act.type === 'item'){   emitAction({ type:'item', itemType: act.itemType, targetId:id }); return; }
  }
  $('#btnTargetCancel').addEventListener('click', () => { pendingAction = null; $('#targetModal').classList.remove('show'); });

  // ===== Chat =====
  function sendChat(){
    const el = $('#chatInput');
    let msg = el.value.trim();
    if(!msg) return;

    let channel = 'all';
    if(/^\/t\b/i.test(msg)){
      channel = 'team';
      msg = msg.replace(/^\/t\b\s*/i, '');
      if(!msg) return;
    }

    if(!socket || socket.disconnected) return alert('연결이 끊어졌습니다.');
    socket.emit('chatMessage', { message: msg, channel });
    el.value = '';
  }

  // ===== Utils =====
  function findMe(b){
    if(!b) return null;
    const all = [...(b.teams?.team1?.players || []), ...(b.teams?.team2?.players || [])];
    return all.find(p => p.id === myId) || null;
  }

  function copyCurrentLink(){
    const u = new URL(location.href);
    u.searchParams.set('battle', battleId || '');
    u.searchParams.set('token',  playerOtp || '');
    u.searchParams.set('name',   myName || '');
    if(myId) u.searchParams.set('pid', myId);
    navigator.clipboard.writeText(u.toString()).then(() => alert('링크가 복사되었습니다.')).catch(() => alert('복사 실패'));
  }

  // ===== Join =====
  async function joinBattle(){
    if(!$('#battleId').value || !$('#otp').value || !$('#playerName').value){
      alert('전투 ID, OTP, 이름을 모두 입력하세요.');
      return;
    }
    battleId = $('#battleId').value.trim();
    playerOtp = $('#otp').value.trim();
    myName = $('#playerName').value.trim();

    // avatar read (optional)
    const file = $('#avatarFile').files?.[0];
    avatarDataURL = file ? await fileToDataURL(file, 256*1024) : null;

    connectSocket();
    $('#auth').classList.add('hidden');
    $('#main').classList.remove('hidden');
  }

  // ===== Bindings =====
  $('#btnJoin').addEventListener('click', joinBattle);
  $('#btnSendChat').addEventListener('click', sendChat);
  $('#chatInput').addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendChat(); }});
  $('#btnCopyLink').addEventListener('click', copyCurrentLink);
  $('#viewTeamOnly').addEventListener('change', ()=>{ if(currentBattle) renderChat(currentBattle); });

  // ===== Boot from query =====
  (function boot(){
    const p = qs();
    if(p.battle) $('#battleId').value = p.battle, battleId = p.battle;
    if(p.token)  $('#otp').value = p.token, playerOtp = p.token;
    if(p.name)   $('#playerName').value = p.name, myName = p.name;
    if(p.pid)    myId = p.pid;
    // 자동 참가
    if(battleId && playerOtp && myName){ joinBattle(); }
  })();
})();
</script>
</body>
</html>
