<!-- packages/battle-server/public/play.html -->
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>PYXIS | 플레이어</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root{
      --bg:#0e1320; --panel:#121a2a; --panel2:#0f1525;
      --ink:#e9e4d4; --ink-dim:#bdb8a8;
      --gold:#e9c981; --gold-2:#d7b770; --line:#273044;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .badge{padding:6px 10px;border:1px solid var(--gold-2);border-radius:999px;color:var(--gold)}
    .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:12px}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:var(--radius);padding:12px}
    .teams{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .team h3{margin:0 0 8px 0;color:var(--gold)}
    .unit{display:flex;gap:10px;align-items:center;padding:8px;border:1px solid var(--line);border-radius:12px;margin-bottom:8px}
    .unit .av{width:44px;height:44px;border-radius:10px;background:#222;overflow:hidden;border:1px solid var(--line);flex:0 0 auto}
    .unit .av img{width:100%;height:100%;object-fit:cover;display:block}
    .bar{height:8px;background:#2b3346;border-radius:8px;overflow:hidden}
    .bar>span{display:block;height:100%;background:linear-gradient(90deg,#4da3ff,#67e8f9)}
    .turn{font-size:14px;color:var(--ink-dim);margin-bottom:8px}
    .actions label{display:block;margin:6px 0 2px}
    input, select, button, textarea{background:#0b1222;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:8px}
    button.primary{background:#16243f;border-color:#2a3b60}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chat{height:320px;overflow:auto;background:#0b1222;border:1px solid var(--line);border-radius:12px;padding:8px}
    .chat .sys{color:#9fb0d0}
    .chat .cheer{color:#9fe09f}
    .chat .me{color:#e8d4a8}
    .muted{color:var(--ink-dim)}
    .upload{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="row">
      <div class="badge">플레이어</div>
      <div id="headInfo" class="muted"></div>
    </div>
    <div class="upload">
      <input type="file" id="avatarFile" accept="image/*" />
      <button id="btnUpload" class="primary">아바타 적용</button>
      <span id="upMsg" class="muted"></span>
    </div>
  </header>

  <div class="grid">
    <div class="card">
      <div class="turn" id="turnInfo">대기중</div>
      <div class="teams">
        <div class="team">
          <h3 id="t1name">불사조 기사단</h3>
          <div id="team1"></div>
        </div>
        <div class="team">
          <h3 id="t2name">죽음을 먹는 자들</h3>
          <div id="team2"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0;color:var(--gold)">행동</h3>
      <div class="actions" id="actionsBox">
        <div class="muted">당신의 차례가 되면 버튼이 활성화됩니다.</div>
        <div style="height:8px"></div>
        <div class="row">
          <button id="actAttack" disabled class="primary">공격</button>
          <button id="actDefend" disabled>방어</button>
          <button id="actItem" disabled>아이템</button>
          <button id="actPass" disabled>패스</button>
        </div>
        <label>대상</label>
        <select id="targetSel" disabled></select>
        <label>아이템</label>
        <select id="itemSel" disabled></select>
      </div>

      <div style="height:12px"></div>
      <h3 style="margin:0 0 8px 0;color:var(--gold)">채팅</h3>
      <div class="chat" id="chat"></div>
      <div class="row" style="margin-top:6px">
        <input id="chatInput" placeholder="메시지 입력" style="flex:1 1 auto" />
        <select id="chatChannel">
          <option value="all">전체</option>
          <option value="team">팀</option>
        </select>
        <button id="chatSend" class="primary">보내기</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const battle = qs.get('battle');
  const token = qs.get('token');
  const name = qs.get('name');
  const pid = qs.get('pid');

  const socket = io({ path: '/socket.io/' });
  let state = null;
  let mePid = null;

  const el = (id) => document.getElementById(id);
  const headInfo = el('headInfo');
  const team1 = el('team1'), team2 = el('team2');
  const t1name = el('t1name'), t2name = el('t2name');
  const turnInfo = el('turnInfo');
  const chatEl = el('chat');
  const chatInput = el('chatInput');
  const chatSend = el('chatSend');
  const chatChannel = el('chatChannel');

  const actAttack = el('actAttack');
  const actDefend = el('actDefend');
  const actItem = el('actItem');
  const actPass = el('actPass');
  const targetSel = el('targetSel');
  const itemSel = el('itemSel');

  const avatarFile = el('avatarFile');
  const btnUpload = el('btnUpload');
  const upMsg = el('upMsg');

  function appendChat(msg){
    const div = document.createElement('div');
    if (msg.type === 'system') { div.className = 'sys'; div.textContent = `[시스템] ${msg.text}`; }
    else if (msg.type === 'cheer') { div.className = 'cheer'; div.textContent = `[응원] ${msg.from}: ${msg.text}`; }
    else if (msg.type === 'chat') {
      const who = msg.from || '익명';
      div.className = (msg.pid && msg.pid === mePid) ? 'me' : '';
      div.textContent = `[${msg.channel === 'team' ? '팀' : '전체'}] ${who}: ${msg.text}`;
    }
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function render(){
    if (!state) return;
    headInfo.textContent = `전투 ${state.id} / 모드 ${state.mode} / 상태 ${state.status}`;

    t1name.textContent = state.teams.team1;
    t2name.textContent = state.teams.team2;

    team1.innerHTML = ''; team2.innerHTML = '';
    const players = Object.values(state.players);

    const mkUnit = (p) => {
      const box = document.createElement('div'); box.className = 'unit';
      const av = document.createElement('div'); av.className = 'av';
      if (p.avatar) { const img = document.createElement('img'); img.src = p.avatar; av.appendChild(img); }
      const info = document.createElement('div'); info.style.flex='1';
      const title = document.createElement('div'); title.textContent = `${p.name}${p.alive?'':' (불능)'}`;
      const bar = document.createElement('div'); bar.className = 'bar';
      const span = document.createElement('span'); span.style.width = `${Math.round((p.hp/p.maxHp)*100)}%`; bar.appendChild(span);
      const meta = document.createElement('div'); meta.className='muted'; meta.textContent = `ATK ${p.stats.attack} / DEF ${p.stats.defense} / AGI ${p.stats.agility} / LUCK ${p.stats.luck}`;
      info.appendChild(title); info.appendChild(bar); info.appendChild(meta);
      box.appendChild(av); box.appendChild(info);
      return box;
    };

    players.filter(p => p.team==='team1').forEach(p => team1.appendChild(mkUnit(p)));
    players.filter(p => p.team==='team2').forEach(p => team2.appendChild(mkUnit(p)));

    // 턴 안내
    const T = state.turn || {turnIndex:0, frameIndex:0, framePlan:[]};
    turnInfo.textContent = `턴 ${T.turnIndex} / 프레임 ${T.frameIndex+1} / 총 ${T.framePlan.length}`;

    // 내 차례 여부와 허용 행동
    let myFrame = null;
    if (mePid && T && T.framePlan && typeof T.frameIndex === 'number') {
      const f = T.framePlan[T.frameIndex];
      if (f && f.pid === mePid) myFrame = f;
    }

    // 초기화
    [actAttack, actDefend, actItem, actPass, targetSel, itemSel]
      .forEach(e => e.disabled = true);

    if (myFrame) {
      const allows = new Set(myFrame.allows || []);
      actAttack.disabled = !allows.has('ATTACK');
      actDefend.disabled = !allows.has('DEFEND');
      actItem.disabled   = !allows.has('ITEM');
      actPass.disabled   = !allows.has('PASS');

      // 타겟 목록
      targetSel.innerHTML = '';
      if (myFrame.targetable) {
        targetSel.disabled = false;
        const list = Object.values(state.players)
          .filter(p => p.alive && (!myFrame.targetTeam || p.team === myFrame.targetTeam));
        for (const p of list) {
          const opt = document.createElement('option');
          opt.value = p.id; opt.textContent = `${p.name} (${p.team=== 'team1' ? '팀1':'팀2'})`;
          targetSel.appendChild(opt);
        }
      }

      // 아이템 목록
      const me = state.players[mePid];
      itemSel.innerHTML = '';
      if (actItem.disabled === false && me && Array.isArray(me.inventory)) {
        itemSel.disabled = false;
        for (const it of me.inventory) {
          const opt = document.createElement('option');
          opt.value = it; opt.textContent = it;
          itemSel.appendChild(opt);
        }
      }
    }
  }

  function choose(kind) {
    const payload = { kind };
    if (!actAttack.disabled && kind === 'ATTACK') payload.targetId = targetSel.value || null;
    if (!actDefend.disabled && kind === 'DEFEND') payload.targetId = targetSel.value || null; // 방어 대상을 지정 가능(동팀)
    if (!actItem.disabled   && kind === 'ITEM') { payload.itemName = itemSel.value || null; payload.targetId = targetSel.value || null; }
    socket.emit('chooseAction', payload, (ack) => {
      if (!ack || !ack.ok) alert(ack?.error || '액션 실패');
    });
  }

  actAttack.onclick = ()=> choose('ATTACK');
  actDefend.onclick = ()=> choose('DEFEND');
  actItem.onclick   = ()=> choose('ITEM');
  actPass.onclick   = ()=> choose('PASS');

  chatSend.onclick = () => {
    const text = chatInput.value.trim(); if (!text) return;
    socket.emit('chatMessage', { message: text, channel: chatChannel.value });
    chatInput.value = '';
  };

  // 아바타 업로드
  btnUpload.onclick = async () => {
    const file = avatarFile.files && avatarFile.files[0];
    if (!file) { upMsg.textContent = '파일을 선택하세요'; return; }
    if (!file.type.startsWith('image/')) { upMsg.textContent = '이미지 파일만 가능'; return; }
    if (file.size > 300*1024) { upMsg.textContent = '300KB 이하만 가능'; return; }
    const b64 = await fileToDataUrl(file);
    socket.emit('uploadAvatar', { dataUrl: b64 }, (ack) => {
      if (!ack || !ack.ok) upMsg.textContent = `실패: ${ack?.error||'error'}`;
      else upMsg.textContent = '적용됨';
    });
  };

  function fileToDataUrl(file){
    return new Promise((res, rej)=>{
      const r = new FileReader();
      r.onload = () => res(r.result);
      r.onerror = rej;
      r.readAsDataURL(file);
    });
  }

  // 소켓 이벤트
  socket.on('connect', () => {
    socket.emit('auth', { battle, token, role:'player', name, pid }, (ack) => {
      if (!ack || !ack.ok) { alert('인증 실패'); return; }
      state = ack.state;
      // mePid 찾기: state.players 중 name 매칭
      const list = Object.values(state.players);
      const found = list.find(p => p.name === name);
      mePid = found ? found.id : null;
      render();
    });
  });
  socket.on('state', s => { state = s; render(); });
  socket.on('chat', appendChat);
  socket.on('chatError', (m)=> alert(m));

  // 최초 렌더
  render();
})();
</script>
</body>
</html>
