<!-- packages/battle-server/public/play.html -->
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>PYXIS | 플레이어</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400..900&display=swap" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root{
      --ink:#e8e2cf; --ink-dim:#b8b3a2;
      --gold:#e4c476; --gold-2:#c9ab5f; --gold-3:#a98b45;
      --line:#2a2f42; --line-subtle:#1b2033;
      --card:#0b1020; --card2:#0f1530; --card3:#0a0f1f;
      --st-wait:#6a7aa5; --st-go:#49c07d; --st-pause:#d5a746; --st-end:#c04c4c;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:#000;color:var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;}
    .wrap{max-width:1280px;margin:0 auto;padding:14px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .brand{font-family:"Cinzel", serif; letter-spacing:.06em; font-weight:800; font-size:20px;
      background:linear-gradient(90deg,#f6e3a1,#e4c476,#d2b062); -webkit-background-clip:text; background-clip:text; color:transparent;}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0c1526a6}
    .pill.wait{border-color:var(--st-wait); color:var(--st-wait)}
    .pill.go{border-color:var(--st-go); color:var(--st-go)}
    .pill.pause{border-color:var(--st-pause); color:var(--st-pause)}
    .pill.end{border-color:var(--st-end); color:var(--st-end)}

    /* 레이아웃: 좌/중/우 */
    .layout{display:grid;grid-template-columns:260px 1fr 260px;gap:12px}
    @media (max-width: 1100px){ .layout{grid-template-columns:1fr;}}
    .col{display:flex;flex-direction:column;gap:12px}

    .card{background:linear-gradient(180deg,var(--card),var(--card3));
      border:1px solid var(--line); border-radius:14px; padding:12px}

    .title{margin:0 0 8px 0; color:var(--gold); font-weight:700; letter-spacing:.02em}
    .muted{color:var(--ink-dim)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}

    /* 팀 리스트 */
    .unit{display:flex;gap:8px;align-items:center;border:1px solid var(--line-subtle);border-radius:12px;padding:8px;background:#0c1326}
    .unit .av{width:44px;height:44px;border-radius:10px;background:#1a2238;overflow:hidden;border:1px solid var(--line)}
    .unit .av img{width:100%;height:100%;object-fit:cover;display:block}
    .bar{height:8px;background:#1b2136;border-radius:8px;overflow:hidden}
    .bar>span{display:block;height:100%;background:linear-gradient(90deg,#4da3ff,#67e8f9)}

    /* 현재 턴 플레이어 패널(반신) */
    .turnpanel{display:grid;grid-template-columns:360px 1fr;gap:12px;align-items:stretch}
    @media (max-width: 900px){ .turnpanel{grid-template-columns:1fr}}
    .portrait{background:#0a0f1f;border:1px solid var(--line);border-radius:12px;display:flex;align-items:flex-end;justify-content:center;position:relative;overflow:hidden;min-height:420px}
    .portrait .img{position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:340px;height:420px;object-fit:cover;filter:contrast(1.05) saturate(1.05)}
    .portrait .ph{position:absolute;bottom:0;left:0;right:0;height:420px;background:linear-gradient(180deg,rgba(255,255,255,.02),transparent 20%, transparent), radial-gradient(600px 300px at 50% 110%, rgba(228,196,118,.08), transparent 60%);}
    .portrait .upload{position:absolute;top:8px;left:8px;right:8px;display:flex;gap:8px;align-items:center;justify-content:space-between;background:rgba(0,0,0,.35);padding:6px;border-radius:10px;border:1px solid var(--line)}
    .portrait .upload input[type="file"]{color:#c8c0ab}
    .pinfo{display:grid;grid-template-rows:auto auto 1fr auto;gap:10px}
    .statrow{display:flex;gap:8px;flex-wrap:wrap}
    .stat{background:#0b142a;border:1px solid var(--line);border-radius:10px;padding:6px 10px}
    .actions .row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:1px solid var(--line); color:var(--ink); padding:10px 12px; border-radius:12px; cursor:pointer; background:linear-gradient(180deg,#2a3c66,#192746)}
    .btn[disabled]{opacity:.45; cursor:not-allowed}
    .btn.gold{border-color:var(--gold-3); background:linear-gradient(180deg,#f2d98b,#d0b266); color:#261b06}
    .input, select{background:#0b142a;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:8px}

    /* 중앙 로그/채팅 */
    .midstack{display:grid;grid-template-rows:1fr 1fr;gap:12px;min-height:520px}
    .log, .chat{background:#0a1122;border:1px solid var(--line);border-radius:12px;padding:10px;overflow:auto}
    .log .row, .chat .row{display:flex;gap:8px;align-items:baseline;margin-bottom:6px}
    .ts{font-size:11px;color:#8aa0c2;min-width:54px}
    .log::-webkit-scrollbar, .chat::-webkit-scrollbar{width:10px}
    .log::-webkit-scrollbar-thumb, .chat::-webkit-scrollbar-thumb{background:#2a3552;border-radius:10px;border:2px solid #0b1222}

    /* 상태 Pill */
    .status{display:inline-flex;gap:8px;align-items:center}
    .status .pill{margin-left:6px}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">PYXIS</div>
    <div class="status">
      <span>전장 상태</span>
      <span id="statusPill" class="pill wait">대기중</span>
    </div>
  </header>

  <div class="layout">
    <!-- 좌측: 팀1 -->
    <div class="col" id="leftCol">
      <div class="card">
        <h3 class="title">불사조 기사단</h3>
        <div id="team1"></div>
      </div>
    </div>

    <!-- 중앙: 현재 턴 패널 + 로그/채팅 -->
    <div class="col">
      <div class="card">
        <h3 class="title">현재 턴</h3>
        <div class="turnpanel">
          <div class="portrait">
            <div class="upload">
              <label class="muted">반신 이미지 업로드(256KB 이하)</label>
              <input id="avatarInput" type="file" accept="image/*">
            </div>
            <img id="portraitImg" class="img" alt="">
            <div class="ph"></div>
          </div>
          <div class="pinfo">
            <div id="turnName" style="font-weight:700;font-size:18px"></div>
            <div class="statrow" id="turnStats"></div>
            <div class="actions">
              <div class="row">
                <button id="actAttack" disabled class="btn">공격</button>
                <button id="actDefend" disabled class="btn">방어</button>
                <button id="actItem" disabled class="btn">아이템</button>
                <button id="actPass" disabled class="btn">패스</button>
              </div>
              <div class="row" style="margin-top:8px">
                <select id="targetSel" disabled class="input"></select>
                <select id="itemSel" disabled class="input"></select>
              </div>
              <div class="muted" style="margin-top:6px">
                아이템 안내: 디터니(HP +10), 공격 보정기(1턴 공격 x1.5, 실패 확률), 방어 보정기(1턴 방어 x1.5, 실패 확률)
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="midstack">
        <div class="card">
          <h3 class="title">로그</h3>
          <div class="log" id="logBox"></div>
        </div>
        <div class="card">
          <h3 class="title">채팅</h3>
          <div class="chat" id="chat"></div>
          <div class="row" style="margin-top:6px">
            <input id="chatInput" class="input" placeholder="메시지 입력" style="flex:1 1 auto" />
            <select id="chatChannel" class="input">
              <option value="all">전체</option>
              <option value="team">팀</option>
            </select>
            <button id="chatSend" class="btn gold">보내기</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 우측: 팀2 -->
    <div class="col" id="rightCol">
      <div class="card">
        <h3 class="title">죽음을 먹는 자들</h3>
        <div id="team2"></div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const battle = qs.get('battle');
  const token = qs.get('token');
  const name = qs.get('name');
  const pidFromUrl = qs.get('pid');

  const socket = io({ path: '/socket.io/' });
  let state = null;
  let mePid = null;

  const $ = (id)=>document.getElementById(id);
  const team1 = $('team1'), team2 = $('team2');
  const logBox = $('logBox');
  const chatEl = $('chat');
  const chatInput = $('chatInput');
  const chatSend = $('chatSend');
  const chatChannel = $('chatChannel');
  const statusPill = $('statusPill');

  const actAttack = $('actAttack');
  const actDefend = $('actDefend');
  const actItem = $('actItem');
  const actPass = $('actPass');
  const targetSel = $('targetSel');
  const itemSel = $('itemSel');
  const portraitImg = $('portraitImg');
  const avatarInput = $('avatarInput');
  const turnName = $('turnName');
  const turnStats = $('turnStats');

  function setStatusPill(status){
    statusPill.classList.remove('wait','go','pause','end');
    if (status === 'waiting') { statusPill.textContent = '대기중'; statusPill.classList.add('wait'); }
    else if (status === 'ongoing') { statusPill.textContent = '진행중'; statusPill.classList.add('go'); }
    else if (status === 'paused') { statusPill.textContent = '일시정지'; statusPill.classList.add('pause'); }
    else if (status === 'ended') { statusPill.textContent = '종료'; statusPill.classList.add('end'); }
  }
  function fmtTs(ts){ try{ return new Date(ts).toLocaleTimeString([], {hour12:false}); }catch{return '--:--:--';} }
  function appendRow(to, klass, ts, text){
    const row = document.createElement('div'); row.className = 'row ' + klass;
    const t = document.createElement('span'); t.className = 'ts'; t.textContent = ts;
    const m = document.createElement('span'); m.textContent = text;
    row.appendChild(t); row.appendChild(m); to.appendChild(row); to.scrollTop = to.scrollHeight;
  }

  function renderTeams(){
    team1.innerHTML = ''; team2.innerHTML = '';
    const mkUnit = (p)=>{
      const box = document.createElement('div'); box.className = 'unit';
      const av = document.createElement('div'); av.className = 'av';
      if (p.avatar) { const img = document.createElement('img'); img.src = p.avatar; av.appendChild(img); }
      const info = document.createElement('div'); info.style.flex='1';
      const nameEl = document.createElement('div'); nameEl.textContent = `${p.name}${p.alive?'':' (불능)'}`;
      const bar = document.createElement('div'); bar.className = 'bar';
      const span = document.createElement('span'); span.style.width = `${Math.round((p.hp/p.maxHp)*100)}%`; bar.appendChild(span);
      const meta = document.createElement('div'); meta.className='muted'; meta.textContent = `ATK ${p.stats.attack} / DEF ${p.stats.defense} / AGI ${p.stats.agility} / LUCK ${p.stats.luck}`;
      info.appendChild(nameEl); info.appendChild(bar); info.appendChild(meta);
      box.appendChild(av); box.appendChild(info);
      return box;
    };
    Object.values(state.players).filter(p=>p.team==='team1').forEach(p=>team1.appendChild(mkUnit(p)));
    Object.values(state.players).filter(p=>p.team==='team2').forEach(p=>team2.appendChild(mkUnit(p)));
  }

  function renderTurnPanel(){
    const T = state.turn || {turnIndex:0, frameIndex:0, framePlan:[]};
    const cur = T.framePlan[T.frameIndex];
    const actor = cur ? state.players[cur.pid] : null;

    [actAttack, actDefend, actItem, actPass, targetSel, itemSel].forEach(el => el.disabled = true);
    targetSel.innerHTML = ''; itemSel.innerHTML = '';
    turnName.textContent = '대기 중';
    turnStats.innerHTML = '';
    portraitImg.src = '';

    if (!actor) return;

    if (actor.avatar) portraitImg.src = actor.avatar; else portraitImg.removeAttribute('src');

    turnName.textContent = `${actor.name}${actor.alive?'':' (불능)'}`;
    turnStats.innerHTML = '';
    const S = actor.stats || {};
    const addStat = (label,val)=>{ const s = document.createElement('div'); s.className='stat'; s.textContent = `${label} ${val}`; turnStats.appendChild(s); };
    addStat('HP', `${actor.hp}/${actor.maxHp}`);
    addStat('ATK', S.attack||0); addStat('DEF', S.defense||0); addStat('AGI', S.agility||0); addStat('LUCK', S.luck||0);

    const isMine = (mePid && actor.id === mePid);
    const allows = new Set(cur.allows || []);

    if (isMine) {
      actAttack.disabled = !allows.has('ATTACK');
      actDefend.disabled = !allows.has('DEFEND');
      actItem.disabled   = !allows.has('ITEM');
      actPass.disabled   = !allows.has('PASS');

      const list = Object.values(state.players).filter(p=>p.alive && p.id !== mePid);
      if (list.length) {
        targetSel.disabled = false;
        list.forEach(p=>{
          const opt = document.createElement('option');
          opt.value = p.id; opt.textContent = `${p.name} (${p.team === 'team1' ? '팀1':'팀2'})`;
          targetSel.appendChild(opt);
        });
      }
      const me = state.players[mePid];
      if (me && me.inventory && Object.keys(me.inventory).length) {
        itemSel.disabled = false;
        Object.keys(me.inventory).forEach(k=>{
          const q = me.inventory[k] || 0;
          if (q>0) {
            const opt = document.createElement('option');
            opt.value = k; opt.textContent = `${k} (x${q})`;
            itemSel.appendChild(opt);
          }
        });
      }
    }
  }

  function render(){
    if (!state) return;
    setStatusPill(state.status);
    renderTeams();
    renderTurnPanel();
  }

  function choose(kind){
    const payload = { kind };
    if (kind === 'ATTACK') payload.targetId = targetSel.value || null;
    if (kind === 'DEFEND') payload.targetId = targetSel.value || null;
    if (kind === 'ITEM') { payload.itemName = itemSel.value || null; payload.targetId = targetSel.value || null; }
    socket.emit('chooseAction', payload, (ack)=>{ if (!ack || !ack.ok) alert(ack?.error || '액션 실패'); });
  }

  actAttack.onclick = ()=> choose('ATTACK');
  actDefend.onclick = ()=> choose('DEFEND');
  actItem.onclick   = ()=> choose('ITEM');
  actPass.onclick   = ()=> choose('PASS');

  // 반신 이미지 업로드: 256KB 제한, image/* 만 허용
  avatarInput.addEventListener('change', async (ev)=>{
    const file = ev.target.files && ev.target.files[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) { alert('이미지 파일만 업로드할 수 있습니다'); return; }
    if (file.size > 256 * 1024) { alert('파일 용량이 256KB를 초과합니다'); return; }
    const reader = new FileReader();
    reader.onload = ()=>{
      const dataUrl = reader.result;
      socket.emit('uploadAvatar', { dataUrl }, (ack)=>{
        if (!ack || !ack.ok) { alert('업로드 실패: ' + (ack && ack.error || '')); return; }
      });
    };
    reader.readAsDataURL(file);
  });

  chatSend.onclick = ()=>{
    const text = chatInput.value.trim(); if (!text) return;
    socket.emit('chatMessage', { message: text, channel: chatChannel.value });
    chatInput.value = '';
  };

  socket.on('connect', ()=>{
    socket.emit('auth', { battle, token, role:'player', name, pid: pidFromUrl }, (ack)=>{
      if (!ack || !ack.ok) { alert('인증 실패'); return; }
      state = ack.state;
      const list = Object.values(state.players);
      const found = list.find(p => p.name === name);
      mePid = found ? found.id : null;
      render();
    });
  });

  socket.on('state', s => { state = s; render(); });

  socket.on('chat', (msg)=>{
    if (!msg) return;
    const t = fmtTs(msg.ts || Date.now());
    if (msg.type === 'system') appendRow(logBox, 'sys', t, msg.text);
    let text = '';
    if (msg.type === 'system') text = '[시스템] ' + msg.text;
    else if (msg.type === 'cheer') text = '[응원] ' + (msg.from||'관전자') + ': ' + msg.text;
    else if (msg.type === 'chat') text = '[' + (msg.channel === 'team' ? '팀':'전체') + '] ' + (msg.from||'익명') + ': ' + msg.text;
    appendRow(chatEl, '', t, text);
  });

  socket.on('chatError', (m)=> alert(m));
})();
</script>
</body>
</html>
