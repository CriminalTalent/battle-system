<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>PYXIS - 관전자</title>
<script src="/socket.io/socket.io.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#0e0e0e; --bg2:#141414;
    --glass-1:rgba(0,0,0,.7); --glass-2:rgba(0,0,0,.5);
    --border:rgba(220,199,162,.3);
    --text:#F8F9FA; --muted:#A9AFB6;
    --gold:#DCC7A2; --gold2:#E6D2A8;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --shadow:0 10px 30px rgba(0,0,0,.45);
    /* 팀별 컬러 */
    --team-a-color:#8b5757;
    --team-b-color:#5d6b8d;
    --result-bg:#DCC7A2;
    --result-text:#000;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:linear-gradient(135deg,#000813,#001122);color:var(--text);font-family:system-ui,-apple-system,sans-serif;min-height:100vh;padding:8px}
  body.battle-ended{overflow:hidden}
  .container{max-width:1400px;margin:0 auto}
  .header{text-align:center;padding:16px;font-family:Cinzel,serif;color:var(--gold);font-size:24px;letter-spacing:.1em}
  .main-grid{display:grid;gap:12px;grid-template-columns:1fr;}
  @media (min-width:768px){ .main-grid{ grid-template-columns:1fr 2fr 1fr; } }
  .team-container{background:var(--glass-1);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:var(--shadow);height:fit-content}
  .team-title{font-family:Cinzel,serif;color:var(--gold);font-weight:700;letter-spacing:.08em;margin-bottom:12px;font-size:16px;text-align:center}
  .center-section{display:flex;flex-direction:column;gap:12px}
  .card{background:var(--glass-1);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:var(--shadow)}
  .title{font-family:Cinzel,serif;color:var(--gold);font-weight:700;letter-spacing:.08em;margin-bottom:8px;font-size:14px}
  .player-card{background:var(--glass-2);border:1px solid var(--border);border-radius:8px;padding:8px;margin-bottom:8px;display:flex;align-items:center;gap:8px}
  .player-card.dead{opacity:.5}
  .player-avatar{width:32px;height:32px;border-radius:50%;object-fit:cover;border:1px solid var(--gold);background:#000}
  .player-info{flex:1;min-width:0}
  .player-name{font-size:12px;font-weight:600;color:var(--gold);margin-bottom:2px}
  .hp{height:6px;background:#0b0b0b;border:1px solid var(--border);border-radius:999px;overflow:hidden;margin-bottom:2px}
  .hp>span{display:block;height:100%;background:linear-gradient(90deg,#4ade80,#22c55e);transition:width .3s}
  .hp-text{font-size:10px;color:var(--muted);margin-bottom:2px}
  .stats{font-size:10px;color:var(--muted)}
  .items-info{font-size:9px;color:var(--text);margin-top:2px}
  .ready-status{font-size:9px;color:var(--gold);margin-top:2px}

  /* 현재 플레이어 */
  .current-player-info{background:var(--glass-2);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px}
  .current-avatar{width:100px;height:100px;border-radius:16px;object-fit:cover;border:4px solid var(--gold);margin-bottom:12px;background:#000}
  .turn-info{font-size:16px;margin-bottom:8px;color:var(--text);font-weight:600}
  .timer-display{color:var(--gold);font-size:32px;margin-bottom:8px;font-weight:700}
  .timer-seconds{font-size:14px;color:var(--muted);margin-bottom:16px}

  .battle-main{text-align:center}

  /* 응원 */
  .cheer-section{background:var(--glass-2);border:1px solid var(--border);border-radius:8px;padding:16px}
  .cheer-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:12px}
  .cheer-btn{background:var(--glass-1);color:var(--text);border:1px solid var(--border);padding:10px 6px;border-radius:8px;font-size:12px;cursor:pointer;transition:all .2s;font-weight:600}
  .cheer-btn:hover:not(:disabled){background:var(--gold2);color:#000}
  .cheer-btn:disabled{opacity:.4;cursor:not-allowed}

  /* 로그/채팅 */
  .logs-section{height:400px;overflow-y:auto;background:var(--glass-2);border:1px solid var(--border);padding:8px;border-radius:8px;margin-bottom:12px}
  .chat-section{height:400px;overflow-y:auto;background:var(--glass-2);border:1px solid var(--border);padding:8px;border-radius:8px;margin-bottom:8px}
  .log-item{margin-bottom:4px;font-size:11px;line-height:1.4;padding:2px 4px;border-radius:4px}
  .log-time{color:var(--gold);font-weight:600}
  .chat-item{margin-bottom:4px;font-size:11px}
  .chat-name{color:var(--gold);font-weight:600}

  /* 로그 분류 */
  .log-team-a{background-color:var(--team-a-color);color:var(--text)}
  .log-team-b{background-color:var(--team-b-color);color:var(--text)}
  .log-result{background-color:var(--result-bg);color:var(--result-text)}
  .log-notice{background-color:var(--glass-1);color:var(--gold)}
  .log-error{background-color:#000;color:var(--gold)}
  .log-system{background-color:transparent;color:var(--muted)}

  /* 이름 입력 오버레이 */
  .name-input-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;z-index:10000}
  .name-input-box{background:var(--glass-1);border:2px solid var(--gold);border-radius:12px;padding:24px;text-align:center;max-width:400px;width:90%}
  .name-input-box h2{color:var(--gold);margin-bottom:16px;font-family:Cinzel,serif}
  .name-input-box input{width:100%;padding:8px 12px;margin:8px 0 16px 0;background:var(--glass-2);border:1px solid var(--border);color:var(--text);border-radius:6px;font-size:14px}
  .name-input-box button{background:var(--gold);color:#000;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px}
  .name-input-box button:hover{background:var(--gold2)}

  /* 게임 종료 오버레이 */
  .game-over-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;z-index:9999;opacity:0;visibility:hidden;transition:all .3s}
  .game-over-overlay.show{opacity:1;visibility:visible}
  .game-over-content{text-align:center;background:var(--glass-1);border:2px solid var(--gold);border-radius:16px;padding:32px;max-width:400px;width:90%}
  .game-over-title{font-family:Cinzel,serif;font-size:28px;color:var(--gold);margin-bottom:16px}
  .winner-announcement{font-size:20px;margin-bottom:16px}
  .winner-team{color:var(--gold);font-weight:700;font-size:24px}
  .spectator-message{color:var(--muted);font-size:14px}

  @media (max-width:767px){
    .main-grid{grid-template-columns:1fr}
    .cheer-grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">PYXIS 전투 시스템</div>

  <div class="main-grid">
    <!-- 좌측: A팀 + 실시간 로그 -->
    <div>
      <div class="team-container" style="margin-bottom:12px">
        <div class="team-title">A팀</div>
        <div id="teamA"></div>
      </div>

      <div class="card">
        <div class="title">실시간 로그</div>
        <div class="logs-section" id="logPanel"></div>
      </div>
    </div>

    <!-- 중앙: 현재 전투 진행 + 응원 -->
    <div class="center-section">
      <div class="card battle-main">
        <div class="current-player-info">
          <img id="currentPortrait" class="current-avatar" alt="현재 플레이어">
          <div id="turnInfo" class="turn-info">대기 중...</div>
          <div id="timerDisplay" class="timer-display">5:00</div>
          <div id="timerSeconds" class="timer-seconds">300초</div>
        </div>
      </div>

      <div class="card">
        <div class="cheer-section">
          <div class="title" style="text-align:center">응원하기</div>
          <div class="cheer-grid">
            <button class="cheer-btn" data-msg="멋지다!">멋지다!</button>
            <button class="cheer-btn" data-msg="이겨라!">이겨라!</button>
            <button class="cheer-btn" data-msg="살아서 돌아와!">살아서 돌아와!</button>
            <button class="cheer-btn" data-msg="화이팅!">화이팅!</button>
            <button class="cheer-btn" data-msg="죽으면 나한테 죽어!">죽으면 나한테 죽어!</button>
            <button class="cheer-btn" data-msg="힘내요!">힘내요!</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 우측: B팀 + 채팅 -->
    <div>
      <div class="team-container" style="margin-bottom:12px">
        <div class="team-title">B팀</div>
        <div id="teamB"></div>
      </div>

      <div class="card">
        <div class="title">채팅</div>
        <div class="chat-section" id="chatPanel"></div>
      </div>
    </div>
  </div>
</div>

<!-- 이름 입력 오버레이 -->
<div id="nameInputOverlay" class="name-input-overlay">
  <div class="name-input-box">
    <h2>관전자 이름 입력</h2>
    <input id="spectatorNameInput" type="text" placeholder="관전자 이름을 입력하세요" maxlength="20"/>
    <button id="enterSpectatorBtn" type="button">입장하기</button>
  </div>
</div>

<!-- 게임 종료 오버레이 -->
<div id="gameOverOverlay" class="game-over-overlay">
  <div class="game-over-content">
    <div class="game-over-title">전투 종료</div>
    <div class="winner-announcement">
      <span id="winnerTeam" class="winner-team"></span> 승리!
    </div>
    <div class="spectator-message">전투 관전이 종료되었습니다.</div>
  </div>
</div>

<script>
(function(){
  /* 안전한 검정 placeholder (svg) */
  function blackSvg(size){
    var s = String(size||32);
    var svg = "<svg xmlns='http://www.w3.org/2000/svg' width='"+s+"' height='"+s+"'><rect width='100%' height='100%' fill='#000'/></svg>";
    return "data:image/svg+xml," + encodeURIComponent(svg);
  }

  function esc(s){ return s ? s.replace(/</g,"&lt;").replace(/>/g,"&gt;") : ""; }

  var qs = new URLSearchParams(location.search);
  var battleId = qs.get("battle");
  var otp      = qs.get("otp");
  var urlName  = qs.get("name");

  if(!battleId || !otp){
    alert("올바르지 않은 URL입니다");
    return;
  }

  var socket = io({ path: "/socket.io" });
  var logPanel  = document.getElementById("logPanel");
  var chatPanel = document.getElementById("chatPanel");
  var spectatorName = urlName || "";
  var battleState = null;

  /* --- 렌더링: 팀 카드 --- */
  function cardHtml(p){
    var hpPct = Math.max(0, (p.hp/(p.maxHp||100))*100);
    var isAlive = p.hp > 0;
    var ready = p.ready ? "준비완료" : "대기중";
    var items = [];
    if((p.items && (p.items.dittany>0 || p.items.ditany>0))) items.push("디터니 " + (p.items.dittany || p.items.ditany));
    if((p.items && (p.items.attackBooster>0 || p.items.attack_boost>0))) items.push("공격보정 " + (p.items.attackBooster || p.items.attack_boost));
    if((p.items && (p.items.defenseBooster>0 || p.items.defense_boost>0))) items.push("방어보정 " + (p.items.defenseBooster || p.items.defense_boost));

    var img = "<img class=\"player-avatar\" src=\"" + (p.avatar || blackSvg(32)) + "\" alt=\"" + esc(p.name) + "\" onerror=\"this.src='" + blackSvg(32) + "'\">";
    var html = ""
      + "<div class=\"player-card " + (isAlive ? "" : "dead") + "\">"
      +   img
      +   "<div class=\"player-info\">"
      +     "<div class=\"player-name\">" + esc(p.name) + "</div>"
      +     "<div class=\"hp\"><span style=\"width:" + hpPct + "%\"></span></div>"
      +     "<div class=\"hp-text\">HP " + p.hp + "/" + (p.maxHp||100) + "</div>"
      +     "<div class=\"stats\">공" + ((p.stats&&p.stats.attack)||0) + " 방" + ((p.stats&&p.stats.defense)||0) + " 민" + ((p.stats&&p.stats.agility)||0) + " 행" + ((p.stats&&p.stats.luck)||0) + "</div>"
      +     "<div class=\"items-info\">" + (items.length ? items.join(", ") : "아이템 없음") + "</div>"
      +     "<div class=\"ready-status\">" + ready + "</div>"
      +   "</div>"
      + "</div>";
    return html;
  }

  function renderTeams(){
    if(!battleState || !battleState.players) return;
    var teamA = battleState.players.filter(function(p){ return p.team === "A"; });
    var teamB = battleState.players.filter(function(p){ return p.team === "B"; });

    var aHtml = teamA.map(cardHtml).join("");
    var bHtml = teamB.map(cardHtml).join("");

    document.getElementById("teamA").innerHTML = aHtml;
    document.getElementById("teamB").innerHTML = bHtml;
  }

  /* --- 상단(턴, 타이머, 현재플레이어) --- */
  function render(){
    if(!battleState) return;
    var turn = battleState.currentTurn || {};
    var phase = battleState.phase;
    var phaseText = phase==="A_select" ? "A팀 선택 중"
                   : phase==="B_select" ? "B팀 선택 중"
                   : phase==="resolve"  ? "라운드 해석 중"
                   : phase==="inter"    ? "다음 라운드 대기" : "대기중";
    var info = document.getElementById("turnInfo");
    if(turn.currentPlayer && turn.currentPlayer.name){
      info.textContent = phaseText + " - " + turn.currentPlayer.name + " 차례";
    }else{
      info.textContent = phaseText;
    }

    var timeLeft = turn.timeLeftSec || 0;
    var mm = Math.floor(timeLeft/60);
    var ss = (timeLeft%60).toString().padStart(2,"0");
    document.getElementById("timerDisplay").textContent = mm + ":" + ss;
    document.getElementById("timerSeconds").textContent = timeLeft + "초";

    var cp = document.getElementById("currentPortrait");
    cp.src = (turn.currentPlayer && turn.currentPlayer.avatar) ? turn.currentPlayer.avatar : blackSvg(100);
    cp.onerror = function(){ this.src = blackSvg(100); };

    renderTeams();
  }

  /* --- 로그/채팅 --- */
  function getLogClass(message, type){
    if(type==="battle" || type==="item"){
      if(message.indexOf("A1")>-1||message.indexOf("A2")>-1||message.indexOf("A3")>-1||message.indexOf("A4")>-1||
         message.indexOf("A팀")>-1||message.indexOf("=== A팀")>-1) return "log-team-a";
      if(message.indexOf("B1")>-1||message.indexOf("B2")>-1||message.indexOf("B3")>-1||message.indexOf("B4")>-1||
         message.indexOf("B팀")>-1||message.indexOf("=== B팀")>-1) return "log-team-b";
      if(message.indexOf("라운드 종료")>-1||message.indexOf("승리")>-1||message.indexOf("전투가")>-1||
         message.indexOf("결과")>-1||message.indexOf("===")>-1) return "log-result";
    }
    if(type==="notice") return "log-notice";
    if(type==="error")  return "log-error";
    return "log-system";
  }

  function addLog(payload){
    if(!payload || !payload.message) return;
    var time = new Date(payload.ts).toLocaleTimeString("ko-KR",{hour12:false});
    var div = document.createElement("div");
    div.className = "log-item " + getLogClass(payload.message, payload.type);
    div.innerHTML = "<span class=\"log-time\">[" + time + "]</span> " + esc(payload.message);
    logPanel.appendChild(div);
    logPanel.scrollTop = logPanel.scrollHeight;
  }

  function addChat(payload){
    if(!payload || !payload.name || !payload.message) return;
    var div = document.createElement("div");
    div.className = "chat-item";
    div.innerHTML = "<span class=\"chat-name\">" + esc(payload.name) + "</span>: " + esc(payload.message);
    chatPanel.appendChild(div);
    chatPanel.scrollTop = chatPanel.scrollHeight;
  }

  /* --- 응원 전송 --- */
  function sendCheer(msg){
    if(!msg) return;
    var name = spectatorName || "관전자";
    socket.emit("spectator:cheer", { battleId: battleId, name: name, message: msg }, function(){});
  }

  function setupUI(){
    document.getElementById("enterSpectatorBtn").onclick = function(){
      var input = document.getElementById("spectatorNameInput");
      var name = input.value.trim();
      if(!name){ alert("이름을 입력해주세요"); return; }
      if(name.length>20){ alert("이름은 20자 이하로 입력해주세요"); return; }
      spectatorName = name;
      document.getElementById("nameInputOverlay").style.display = "none";
    };
    document.getElementById("spectatorNameInput").addEventListener("keypress", function(e){
      if(e.key === "Enter"){ document.getElementById("enterSpectatorBtn").click(); }
    });
    var btns = document.querySelectorAll(".cheer-btn");
    for(var i=0;i<btns.length;i++){
      (function(b){
        b.onclick = function(){
          var m = b.getAttribute("data-msg");
          sendCheer(m);
        };
      })(btns[i]);
    }
  }

  /* --- 소켓 --- */
  socket.on("connect", function(){
    // 방에는 즉시 입장(이름 입력 전이라도 상태/로그 갱신)
    socket.emit("join", { battleId: battleId }, function(){});
  });

  // 상태 스냅샷
  function onSnap(snap){ battleState = snap; render(); }
  socket.on("battle:update", onSnap);
  socket.on("battleUpdate", onSnap);

  // 로그
  socket.on("battle:log", addLog);
  socket.on("battleLog", addLog);

  // 채팅(모든 경로 수신)
  socket.on("chatMessage", addChat);
  socket.on("battle:chat", addChat);
  socket.on("spectator:cheer", addChat);
  socket.on("cheerMessage", addChat);

  // 게임 종료
  function showGameOverOverlay(winner){
    var wt = document.getElementById("winnerTeam");
    wt.textContent = winner + "팀";
    document.getElementById("gameOverOverlay").classList.add("show");
    document.body.classList.add("battle-ended");
  }
  socket.on("battle:ended", function(d){ showGameOverOverlay(d.winner); });
  socket.on("battleEnded",  function(d){ showGameOverOverlay(d.winner); });

  // 초기화
  setupUI();
  document.getElementById("spectatorNameInput").focus();

})();
</script>
</body>
</html>
