<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PYXIS - 관전자</title>
  <script src="/socket.io/socket.io.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --black:#0b0b0d; --black-2:#101216; --panel:rgba(255,255,255,.04); --panel2:rgba(255,255,255,.08);
      --border:rgba(255,255,255,.14); --text:#f7f8fa; --muted:#aeb3be; --gold:#dcc7a2; --gold2:#e6d2a8;
      --success:#27ae60; --danger:#e74c3c; --info:#3498db; --radius:14px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{min-height:100%;background:var(--black);color:var(--text);font-family:'Cinzel',serif;line-height:1.6}

    .header{position:sticky;top:0;z-index:10;background:var(--panel2);border-bottom:1px solid var(--border)}
    .header-inner{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;padding:12px 14px}
    .logo{color:var(--gold2);font-weight:800}
    .status{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:12px}
    .dot{width:8px;height:8px;border-radius:50%;background:#666}.dot.on{background:var(--success)}

    .main{max-width:1400px;margin:0 auto;padding:16px;display:grid;grid-template-columns:1fr 520px 420px;gap:16px;align-items:start}
    @media (max-width:1200px){.main{grid-template-columns:1fr}}
    .card{background:var(--panel2);border:1px solid var(--border);border-radius:var(--radius);padding:12px}
    .title{color:var(--gold2);font-weight:800;border-bottom:1px solid var(--border);padding-bottom:8px;margin-bottom:10px;text-align:center}

    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:#0e0f13;font-size:11px;color:var(--muted)}
    .hpbar{height:8px;border-radius:6px;background:#1a1d24;border:1px solid var(--border);overflow:hidden}
    .hpbar>span{display:block;height:100%;background:#2ecc71}

    /* 팀 카드 */
    .teamCol .member{display:flex;gap:8px;align-items:center;border:1px solid var(--border);border-radius:10px;padding:8px;background:#0e0f13}
    .avatar{width:28px;height:28px;border-radius:6px;background:#0f1014 center/cover no-repeat;border:1px solid var(--border)}

    /* 중앙: 큰 초상화 */
    .big-portrait{width:100%;aspect-ratio:3/4;border-radius:16px;border:1px solid var(--border);background:#0f1014 center/cover no-repeat}

    /* 우측: 로그(위) + 채팅(아래) 세로 분리 */
    .rightCol{display:flex;flex-direction:column;gap:16px}
    .logs{height:280px;overflow:auto;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px;font-size:12px}
    .logline{padding:4px 0;border-bottom:1px dashed rgba(255,255,255,.08)}
    .logline:last-child{border-bottom:none}
    .ts{color:var(--muted);font-size:10px;margin-right:6px}

    .chatPanel{display:flex;flex-direction:column;gap:10px}
    .chatBox{height:220px;overflow:auto;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px;font-size:12px}
    .chatline{padding:4px 0;border-bottom:1px dashed rgba(255,255,255,.08)}
    .chatline:last-child{border-bottom:none}
    .cheers{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;min-height:36px;padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--text);font-weight:800;cursor:pointer}
    .btn.gold{background:linear-gradient(180deg,var(--gold),var(--gold2));color:#111}

    /* 인증 모달 */
    #authOverlay{position:fixed;inset:0;z-index:9999;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.78)}
    .auth-card{width:min(520px,92vw);background:#101216;border:1px solid var(--border);border-radius:16px;padding:18px}
    .auth-card h2{color:var(--gold2);text-align:center;margin-bottom:10px}
    .grid{display:grid;gap:8px}
    .g2{grid-template-columns:1fr 1fr}
    .input,.select,button{font-family:'Cinzel',serif}
    .input,.select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#0e0f13;color:var(--text);font-size:13px}
    .err{color:var(--danger);font-size:12px;margin-top:6px;min-height:16px}
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <div class="logo">PYXIS · 관전자</div>
      <div class="status"><span id="connText">연결 대기</span><span id="connDot" class="dot"></span></div>
    </div>
  </header>

  <main class="main">
    <!-- 좌: 팀 목록 -->
    <section class="card teamCol">
      <div class="title">A팀</div>
      <div id="teamAList" style="display:grid;gap:8px"></div>
      <div class="title" style="margin-top:12px">B팀</div>
      <div id="teamBList" style="display:grid;gap:8px"></div>
    </section>

    <!-- 중: 턴/초상화 -->
    <section class="card">
      <div class="title">현재 턴</div>
      <div id="turnPortrait" class="big-portrait"></div>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:8px;flex-wrap:wrap">
        <div class="pill">선공팀 <strong id="firstTeam" style="margin-left:6px">-</strong></div>
        <div class="pill">현재팀 <strong id="turnTeam" style="margin-left:6px">-</strong></div>
        <div class="pill">라운드 <strong id="roundNo" style="margin-left:6px">-</strong></div>
        <div class="pill">팀 제한시간 <strong id="teamTimer" style="margin-left:6px">-</strong></div>
      </div>
    </section>

    <!-- 우: 로그(위) + 채팅(아래) -->
    <section class="rightCol">
      <div class="card">
        <div class="title">실시간 로그</div>
        <div id="logs" class="logs"></div>
      </div>

      <div class="card chatPanel">
        <div class="title">채팅</div>
        <!-- 입력창/전송버튼 없이 목록 + 응원 버튼만 -->
        <div id="chatBox" class="chatBox"></div>
        <div class="cheers">
          <button class="btn" data-say="멋지다!">멋지다!</button>
          <button class="btn" data-say="이겨라!">이겨라!</button>
          <button class="btn" data-say="살아서 돌아와!">살아서 돌아와!</button>
          <button class="btn" data-say="화이팅!">화이팅!</button>
          <button class="btn" data-say="죽으면 나한테 죽어!">죽으면 나한테 죽어!</button>
          <button class="btn" data-say="힘내요!">힘내요!</button>
        </div>
      </div>
    </section>
  </main>

  <!-- 인증 모달 -->
  <div id="authOverlay">
    <div class="auth-card">
      <h2>관전 인증</h2>
      <div class="grid g2">
        <input id="nameInput" class="input" placeholder="이름(필수)"/>
        <input id="passwordInput" class="input" placeholder="비밀번호(OTP, 필수)"/>
      </div>
      <div class="grid" style="margin-top:8px">
        <button id="authBtn" class="btn gold">관전 시작</button>
      </div>
      <div id="authErr" class="err"></div>
    </div>
  </div>

  <script>
    const $=q=>document.querySelector(q), esc=s=>String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const ts=()=>new Date().toLocaleTimeString('ko-KR',{hour12:false});

    // 상태
    let socket=null,battleId=null,viewerName='';

    function addLog(msg){
      const el=document.createElement('div'); el.className='logline';
      el.innerHTML=`<span class="ts">${ts()}</span>${esc(msg)}`;
      const box=$('#logs'); box.appendChild(el); box.scrollTop=box.scrollHeight;
      while(box.children.length>400) box.removeChild(box.firstChild);
    }
    function addChat(name,msg){
      const el=document.createElement('div'); el.className='chatline';
      el.innerHTML=`<span class="ts">${ts()}</span><strong>${esc(name)}</strong>: ${esc(msg)}`;
      const box=$('#chatBox'); box.appendChild(el); box.scrollTop=box.scrollHeight;
      while(box.children.length>400) box.removeChild(box.firstChild);
    }

    function connect(){
      socket=window.io({path:'/socket.io',transports:['websocket','polling']});
      socket.on('connect',()=>{$('#connText').textContent='연결됨';$('#connDot').classList.add('on');addLog('서버에 연결되었습니다.')});
      socket.on('disconnect',()=>{$('#connText').textContent='연결 끊김';$('#connDot').classList.remove('on');addLog('서버 연결이 끊어졌습니다.')});

      // 스냅샷
      const onUpdate=(b)=>renderBattle(b);
      socket.on('battleUpdate',onUpdate); socket.on('battle:update',onUpdate);

      // 로그
      socket.on('battleLog',d=> addLog(d?.message||'로그'));
      socket.on('battle:log',d=> addLog(d?.message||'로그'));

      // 채팅(플레이어/관리자)
      socket.on('chatMessage',d=> addChat(d?.name||'익명', d?.message||''));
      socket.on('battle:chat',d=> addChat(d?.name||d?.senderName||'익명', d?.message||''));

      // 응원(관전자)
      socket.on('cheerMessage',d=> addChat(d?.name||'관전자', d?.message||''));
      socket.on('spectator:cheer',d=> addChat(d?.name||'관전자', d?.message||''));
    }

    function renderBattle(b){
      if(!b) return;
      // 팀
      const A=(b.players||[]).filter(p=>p.team==='A'), B=(b.players||[]).filter(p=>p.team==='B');
      const mk=(p)=>`<div class="member">
        <div class="avatar" style="background-image:${p.avatar?`url('${esc(p.avatar)}')`:'none'}"></div>
        <div style="min-width:0;flex:1">
          <div style="font-weight:800">${esc(p.name)}</div>
          <div class="hpbar" style="margin-top:2px"><span style="width:${Math.max(0,Math.min(100,(p.hp||0)/(p.maxHp||100)*100))}%"></span></div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px">공${p.stats?.attack} 방${p.stats?.defense} 민${p.stats?.agility} 행${p.stats?.luck}</div>
        </div>
      </div>`;
      $('#teamAList').innerHTML=A.map(mk).join('');
      $('#teamBList').innerHTML=B.map(mk).join('');
      // 턴/초상화
      const cur=(b.currentTurn?.currentCharacter)||(b.players||[])[0]||null;
      $('#turnPortrait').style.backgroundImage=cur?.avatar?`url('${cur.avatar}')`:'';
      $('#firstTeam').textContent=b.firstTeam||'-';
      $('#turnTeam').textContent=b.currentTurn?.currentTeam||'-';
      $('#roundNo').textContent=b.currentTurn?.round||1;
      $('#teamTimer').textContent=b.timeLeft!=null?(b.timeLeft+'s'):'-';
    }

    // 인증
    function showAuth(msg){
      $('#authOverlay').style.display='flex';
      if(msg) $('#authErr').textContent=msg;
    }
    function hideAuth(){ $('#authOverlay').style.display='none'; $('#authErr').textContent=''; }

    function requiredAuth(){
      const p=new URLSearchParams(location.search);
      battleId=p.get('battle')||p.get('id')||null;
      const otp=p.get('otp')||p.get('token')||p.get('password')||'';
      const name=(p.get('name')||'').trim();
      if(!battleId){ showAuth('전투 ID가 없습니다.'); return; }
      if(name){ $('#nameInput').value=name; }
      if(otp){ $('#passwordInput').value=otp; }
      // 이름/OTP 모두 있어야 자동 시도
      if(name && otp){ doAuth(name,otp); } else { showAuth(); }
    }

    function doAuth(name,otp){
      if(!name.trim()){ $('#authErr').textContent='이름을 입력하세요.'; return; }
      if(!otp.trim()){ $('#authErr').textContent='비밀번호(OTP)를 입력하세요.'; return; }
      viewerName=name.trim();
      socket.emit('join',{battleId});
      // 관전자 토큰 이벤트(서버는 cheer/event만 쓰므로 join만으로 충분한 경우가 많음)
      hideAuth(); addLog(`관전자 인증: ${viewerName}`);
    }

    // 응원 버튼
    function bindCheers(){
      document.querySelectorAll('.cheers .btn').forEach(b=>{
        b.addEventListener('click',()=>{
          const msg=b.dataset.say||b.textContent||'응원';
          if(!battleId) return;
          socket.emit('cheerMessage',{ battleId, name: viewerName||'관전자', message: msg });
          socket.emit('spectator:cheer',{ battleId, name: viewerName||'관전자', message: msg });
          addChat(viewerName||'관전자', msg);
        });
      });
    }

    // 초기화
    (function init(){
      connect();
      bindCheers();
      requiredAuth();
      $('#authBtn').onclick=()=> doAuth($('#nameInput').value,$('#passwordInput').value);
    })();
  </script>
</body>
</html>
