<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>PYXIS - 관전자</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="/socket.io/socket.io.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --black:#0a0a0a;
      --black-2:#111;
      --black-3:#161616;
      --gold:#DCC7A2;
      --gold-2:#E6D2A8;
      --muted:#A7A7A7;
      --accent:#2a2a2a;
      --border:rgba(255,255,255,0.08);
      --radius:12px;
      --shadow:0 6px 18px rgba(0,0,0,0.35);
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;
      padding:0;
      background:linear-gradient(135deg,var(--black),#000);
      color:#f5f5f5;
      font-family:'Cinzel',serif;
      min-height:100vh;
    }
    .wrap{
      max-width:1280px;
      margin:0 auto;
      padding:16px;
      display:grid;
      grid-template-columns: 1fr 420px;
      gap:16px;
    }
    @media (max-width:1100px){
      .wrap{ grid-template-columns: 1fr; }
    }

    .card{
      background:linear-gradient(180deg,var(--black-2),var(--black-3));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .title{
      color:var(--gold);
      font-weight:800;
      letter-spacing:1px;
      margin-bottom:12px;
      border-bottom:1px solid var(--border);
      padding-bottom:8px;
    }

    .teams{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-bottom:16px;
    }
    .teamTitle{
      color:var(--gold-2);
      font-size:13px;
      letter-spacing:1px;
      margin-bottom:8px;
      text-transform:uppercase;
    }
    .list{
      border:1px solid var(--border);
      border-radius:10px;
      background:var(--black-2);
      max-height:260px;
      overflow:auto;
    }
    .item{
      display:flex;
      gap:10px;
      align-items:center;
      padding:8px 10px;
      border-bottom:1px solid var(--border);
      font-size:12px;
    }
    .item:last-child{border-bottom:none;}
    .ava{
      width:32px;height:32px;border-radius:8px;object-fit:cover;
      border:1px solid var(--border);background:#222;
    }
    .nm{font-weight:700}
    .hp{color:var(--muted);font-size:11px}

    /* 하단: 로그(위) + 채팅(아래) 세로 분리 */
    .rightCol{
      display:grid;
      grid-template-rows: minmax(220px, 1fr) minmax(160px, 240px);
      gap:12px;
    }

    .logBox,.chatBox{
      border:1px solid var(--border);
      border-radius:10px;
      background:#0f0f0f;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .logHead,.chatHead{
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      color:var(--gold);
      font-weight:700;
      letter-spacing:0.5px;
      background:#0c0c0c;
    }
    .logBody,.chatBody{
      padding:10px 12px;
      overflow:auto;
      flex:1;
      font-size:12px;
      line-height:1.5;
    }
    .logRow{padding:4px 0;border-bottom:1px dashed rgba(255,255,255,0.06)}
    .logRow:last-child{border-bottom:none}
    .logRow .ts{color:#888;font-size:11px;margin-right:8px}
    .logRow.system{color:#8ab4f8}
    .logRow.admin{color:#f2a654}
    .logRow.chat{color:#c7e1ff}
    .logRow.cheer{color:#9ce29c}

    .chatMsg{margin-bottom:6px}
    .chatMsg .nm{color:var(--gold-2);font-weight:700;margin-right:6px}

    /* 응원 버튼 영역 */
    .cheerPanel{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:8px;
    }
    .btn{
      background:linear-gradient(180deg,#222,#1a1a1a);
      border:1px solid var(--border);
      border-radius:10px;
      color:#f5f5f5;
      padding:10px 12px;
      font-weight:700;
      cursor:pointer;
    }
    .btn:hover{background:#222}
    .btn:active{transform:translateY(1px)}

    /* 인증 오버레이 */
    .overlay{
      position:fixed;inset:0;
      display:flex;align-items:center;justify-content:center;
      background:rgba(0,0,0,0.75);
      z-index:50;
    }
    .ovCard{
      width:92%;max-width:460px;
      background:linear-gradient(180deg,#0e0e0e,#121212);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:var(--shadow);
      padding:18px;
    }
    .ovTitle{color:var(--gold);font-weight:800;margin-bottom:12px}
    .field{margin-bottom:12px}
    .label{display:block;color:#cfcfcf;font-size:12px;margin-bottom:6px}
    .inp{
      width:100%;padding:10px 12px;border-radius:10px;
      border:1px solid var(--border);background:#0a0a0a;color:#f5f5f5;
      font-family:'Cinzel',serif;
    }
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    .btnPrimary{
      background:linear-gradient(180deg,#2b2b2b,#1e1e1e);
      border:1px solid var(--border);color:#f5f5f5;
      padding:10px 14px;border-radius:10px;font-weight:800;cursor:pointer;
    }
    .btnPrimary:hover{background:#2a2a2a}

    .header{
      display:flex;align-items:center;justify-content:space-between;
      margin-bottom:12px;
    }
    .brand{color:var(--gold-2);font-weight:800;letter-spacing:1px}
    .status{font-size:12px;color:#9e9e9e}
    .dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;background:#666;vertical-align:middle}
    .dot.on{background:#2ecc71}
  </style>
</head>
<body>
  <div class="overlay" id="overlay">
    <div class="ovCard">
      <div class="ovTitle">관전 인증</div>
      <div class="field">
        <label class="label">전투 ID (URL의 ?battle= 값)</label>
        <input class="inp" id="ovBattle" placeholder="예: battle_xxxxxx" />
      </div>
      <div class="field">
        <label class="label">관전자 비밀번호 (OTP)</label>
        <input class="inp" id="ovOtp" placeholder="관전자 OTP 입력" />
      </div>
      <div class="field">
        <label class="label">이름 (필수)</label>
        <input class="inp" id="ovName" placeholder="표시될 이름" />
      </div>
      <div class="actions">
        <button class="btnPrimary" id="btnStart">관전 시작</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div>
      <div class="header">
        <div class="brand">PYXIS 관전자</div>
        <div class="status"><span id="connDot" class="dot"></span><span id="connText">연결 대기</span></div>
      </div>

      <div class="card">
        <div class="title">팀 구성</div>
        <div class="teams">
          <div>
            <div class="teamTitle">A팀</div>
            <div id="teamA" class="list"></div>
          </div>
          <div>
            <div class="teamTitle">B팀</div>
            <div id="teamB" class="list"></div>
          </div>
        </div>

        <div class="title">응원</div>
        <div class="cheerPanel">
          <button class="btn" data-cheer="멋지다!">멋지다!</button>
          <button class="btn" data-cheer="이겨라!">이겨라!</button>
          <button class="btn" data-cheer="살아서 돌아와!">살아서 돌아와!</button>
          <button class="btn" data-cheer="화이팅!">화이팅!</button>
          <button class="btn" data-cheer="죽으면 나한테 죽어!">죽으면 나한테 죽어!</button>
          <button class="btn" data-cheer="힘내요!">힘내요!</button>
        </div>
      </div>
    </div>

    <div class="rightCol">
      <div class="logBox card">
        <div class="logHead">실시간 로그</div>
        <div id="logBody" class="logBody"></div>
      </div>

      <div class="chatBox card">
        <div class="chatHead">채팅 / 응원</div>
        <div id="chatBody" class="chatBody"></div>
      </div>
    </div>
  </div>

  <script>
    const $ = (q) => document.querySelector(q);
    const teamAEl = $('#teamA');
    const teamBEl = $('#teamB');
    const logBody = $('#logBody');
    const chatBody = $('#chatBody');
    const connDot = $('#connDot');
    const connText = $('#connText');

    const overlay = $('#overlay');
    const ovBattle = $('#ovBattle');
    const ovOtp = $('#ovOtp');
    const ovName = $('#ovName');
    const btnStart = $('#btnStart');

    let socket = null;
    let battleId = null;
    let myName = null;
    let otp = null;

    // URL 파라미터 폴백
    (function seedFromURL(){
      const u = new URL(window.location.href);
      const b = u.searchParams.get('battle');
      const t = u.searchParams.get('otp') || u.searchParams.get('token') || u.searchParams.get('password') || u.searchParams.get('pwd') || u.searchParams.get('auth');
      if (b) ovBattle.value = b;
      if (t) ovOtp.value = t;
    })();

    function setConn(on){
      if (on){
        connDot.classList.add('on');
        connText.textContent = '연결됨';
      }else{
        connDot.classList.remove('on');
        connText.textContent = '연결 끊김';
      }
    }

    function addLog({type='system', message='', ts=Date.now()}){
      const row = document.createElement('div');
      row.className = `logRow ${type}`;
      const time = new Date(ts).toLocaleTimeString('ko-KR',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
      row.innerHTML = `<span class="ts">${time}</span>${escapeHtml(message)}`;
      logBody.appendChild(row);
      logBody.scrollTop = logBody.scrollHeight;
      // 제한
      while (logBody.children.length > 400) logBody.removeChild(logBody.firstChild);
    }

    function addChat({name='익명', message=''}){
      const row = document.createElement('div');
      row.className = 'chatMsg';
      row.innerHTML = `<span class="nm">${escapeHtml(name)}</span><span>${escapeHtml(message)}</span>`;
      chatBody.appendChild(row);
      chatBody.scrollTop = chatBody.scrollHeight;
      while (chatBody.children.length > 400) chatBody.removeChild(chatBody.firstChild);
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function renderTeams(snapshot){
      const players = snapshot?.players || [];
      const A = players.filter(p=> (p.team||'A')==='A');
      const B = players.filter(p=> (p.team||'A')==='B');

      teamAEl.innerHTML = '';
      teamBEl.innerHTML = '';

      const makeItem = (p)=>{
        const el = document.createElement('div');
        el.className = 'item';
        el.innerHTML = `
          <img class="ava" src="${escapeHtml(p.avatar||'')}" alt="${escapeHtml(p.name||'전투 참가자')}">
          <div>
            <div class="nm">${escapeHtml(p.name||'전투 참가자')}</div>
            <div class="hp">HP ${p.hp ?? 100}/${p.maxHp ?? 100} · 공${p.stats?.attack ?? '-'} 방${p.stats?.defense ?? '-'} 민${p.stats?.agility ?? '-'} 행${p.stats?.luck ?? '-'}</div>
          </div>
        `;
        return el;
      };

      if (A.length === 0){
        const empty = document.createElement('div');
        empty.className = 'item';
        empty.textContent = 'A팀 참가자 없음';
        teamAEl.appendChild(empty);
      }else{
        A.forEach(p=> teamAEl.appendChild(makeItem(p)));
      }

      if (B.length === 0){
        const empty = document.createElement('div');
        empty.className = 'item';
        empty.textContent = 'B팀 참가자 없음';
        teamBEl.appendChild(empty);
      }else{
        B.forEach(p=> teamBEl.appendChild(makeItem(p)));
      }
    }

    function bindSocket(){
      socket = window.io('/', { path: '/socket.io' });

      socket.on('connect', ()=> setConn(true));
      socket.on('disconnect', ()=> setConn(false));

      // 인증 결과
      socket.on('authSuccess', (data)=>{
        addLog({type:'system', message:`관전 인증 성공: ${data?.name || ''}`});
        overlay.style.display = 'none';
        // 방 스냅샷 즉시 반영
        if (data?.battle) renderTeams(data.battle);
      });
      socket.on('auth:success', (d)=> socket.emit('authSuccess', d)); // 호환 처리(없어도 무해)

      socket.on('authError', (err)=>{
        addLog({type:'system', message:`인증 실패: ${err?.message || '오류'}`});
      });

      // 스냅샷 수신
      const onSnap = (snap)=> renderTeams(snap);
      socket.on('battleUpdate', onSnap);
      socket.on('battle:update', onSnap);

      // 로그 수신
      const onLog = (entry)=> addLog(entry);
      socket.on('battleLog', onLog);
      socket.on('battle:log', onLog);

      // 채팅 수신(일반 채팅)
      socket.on('chatMessage', ({name, message})=>{
        addChat({name: name || '익명', message: message || ''});
      });

      // 응원 수신 → 채팅 패널에만
      socket.on('cheerMessage', ({name, message})=>{
        addChat({name: name || '관전자', message: message || ''});
      });
      socket.on('spectator:cheer', ({name, message})=>{
        addChat({name: name || '관전자', message: message || ''});
      });
    }

    function joinRoom(){
      if (!socket) return;
      socket.emit('join', { battleId });
    }

    // 응원 버튼
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-cheer]');
      if (!btn) return;
      if (!socket || !battleId) return;
      const msg = btn.getAttribute('data-cheer');
      socket.emit('spectator:cheer', { battleId, message: msg, name: myName }, (res)=>{
        if (res?.ok){
          // 본인에게도 즉시 반영(낙관적)
          addChat({name: myName || '관전자', message: msg});
        }
      });
    });

    // 시작 버튼
    btnStart.addEventListener('click', ()=>{
      const b = (ovBattle.value || '').trim();
      const t = (ovOtp.value || '').trim();
      const n = (ovName.value || '').trim();
      if (!b){ alert('전투 ID를 입력해주세요.'); return; }
      if (!t){ alert('관전자 비밀번호(OTP)를 입력해주세요.'); return; }
      if (!n){ alert('이름을 입력해주세요.'); return; }

      battleId = b; otp = t; myName = n;

      if (!socket) bindSocket();

      socket.emit('spectatorAuth', { battleId, token: otp, name: myName }, (res)=>{
        if (!res?.ok){
          addLog({type:'system', message:`인증 실패: ${res?.message || res?.error || '오류'}`});
          return;
        }
        // 방 조인(서버에서 이미 join 하지만, 명시 호출로 안전망)
        joinRoom();
      });
    });
  </script>
</body>
</html>
