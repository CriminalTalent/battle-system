<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PYXIS - 관전자</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --deep-navy:#0A0F1A; --dark-blue:#0C1221; --mid-blue:#1E2A47; --light-blue:#3D5A80;
      --gold:#DCC7A2; --gold-bright:#E6D2A8; --gold-shimmer:#F0E6C8;
      --text:#F8F9FA; --text-accent:#E9ECEF; --text-muted:#ADB5BD;
      --glass-1:rgba(30,42,71,0.3); --glass-2:rgba(30,42,71,0.5); --glass-light:rgba(248,249,250,0.05);
      --border:rgba(61,90,128,0.4); --border-light:rgba(61,90,128,0.6); --border-subtle:rgba(61,90,128,0.2);
      --blur-light:blur(10px); --blur-medium:blur(15px); --blur-heavy:blur(20px);
      --transition-fast:.2s ease-out; --transition-slow:.4s ease-out;
      --radius:12px; --radius-small:8px; --shadow-soft:0 4px 6px rgba(0,0,0,.1);
      --shadow-medium:0 8px 15px rgba(0,0,0,.2); --shadow-deep:0 20px 25px rgba(0,0,0,.4);
      --serif:'Cinzel',serif; --success:#27AE60; --success-light:rgba(39,174,96,.1);
      --warning:#F39C12; --warning-light:rgba(243,156,18,.1);
      --danger:#E74C3C; --danger-light:rgba(231,76,60,.1);
      --info:#3498DB; --info-light:rgba(52,152,219,.1);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      font-family:var(--serif);
      background:linear-gradient(135deg,var(--deep-navy) 0%,var(--dark-blue) 100%);
      color:var(--text); line-height:1.6; letter-spacing:.01em; min-height:100vh;
    }
    .container{max-width:1600px;margin:0 auto;padding:0 20px}

    /* 헤더 */
    .header{background:var(--glass-2);backdrop-filter:var(--blur-light);border-bottom:1px solid var(--border-light);
      padding:16px 0; position:sticky; top:0; z-index:100; box-shadow:var(--shadow-soft)}
    .title{text-align:center;color:var(--gold-bright)}
    .title-main{
      font-size:32px;font-weight:800;letter-spacing:2px;text-shadow:0 2px 4px rgba(0,0,0,.3);
      background:linear-gradient(135deg,var(--gold),var(--gold-bright));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text
    }
    .title-sub{font-size:14px;font-weight:400;color:var(--text-muted);margin-top:4px}

    /* 인증 카드 */
    .auth-card{background:var(--glass-2);backdrop-filter:var(--blur-light);border:1px solid var(--border-light);
      border-radius:var(--radius);padding:40px;margin:60px auto;max-width:500px;text-align:center;box-shadow:var(--shadow-deep)}
    .section-title{font-size:24px;font-weight:600;color:var(--gold-bright);margin-bottom:32px;text-shadow:0 2px 4px rgba(0,0,0,.3)}
    .form-group{margin-bottom:20px;text-align:left}
    .label{display:block;font-size:14px;font-weight:600;color:var(--text-accent);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px}
    input[type="text"],input[type="password"]{
      width:100%;background:var(--glass-1);border:1px solid var(--border-light);border-radius:var(--radius-small);
      padding:12px 16px;color:var(--text);font-size:14px;transition:all var(--transition-fast)
    }
    input:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 2px rgba(212,183,126,.2)}
    .actions{margin-top:24px}
    .btn{
      background:linear-gradient(135deg,var(--gold),var(--gold-bright));color:var(--deep-navy);border:none;border-radius:var(--radius-small);
      padding:12px 24px;font-size:14px;font-weight:600;cursor:pointer;transition:all var(--transition-fast);
      text-transform:uppercase;letter-spacing:.5px;box-shadow:var(--shadow-soft);position:relative;overflow:hidden
    }
    .btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);transition:left .6s}
    .btn:hover:not(:disabled){background:linear-gradient(135deg,var(--gold-bright),var(--gold-shimmer));transform:translateY(-2px);box-shadow:var(--shadow-medium)}
    .btn:hover:not(:disabled)::before{left:100%}
    .btn:disabled{background:var(--glass-1);color:var(--text-muted);cursor:not-allowed;transform:none;box-shadow:none}

    /* 레이아웃 */
    .main-layout{display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr auto;gap:24px;padding:24px 0;min-height:calc(100vh - 100px)}

    /* 카드 */
    .card{background:var(--glass-2);backdrop-filter:var(--blur-light);border:1px solid var(--border-light);
      border-radius:var(--radius);padding:24px;box-shadow:var(--shadow-soft);transition:all var(--transition-fast)}
    .card-title{font-size:18px;font-weight:600;color:var(--gold-bright);margin-bottom:20px;text-align:center;text-shadow:0 2px 4px rgba(0,0,0,.3);text-transform:uppercase;letter-spacing:1px}

    .team-a-section{grid-column:1;grid-row:1}
    .team-b-section{grid-column:2;grid-row:1}

    .team-list{display:flex;flex-direction:column;gap:16px}
    .team-member{background:var(--glass-1);border:1px solid var(--border-subtle);border-radius:var(--radius-small);padding:16px;transition:all var(--transition-fast)}
    .team-member:hover{background:var(--glass-2);border-color:var(--border-light);transform:translateY(-2px);box-shadow:var(--shadow-soft)}

    .member-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .member-avatar{width:50px;height:50px;border-radius:var(--radius-small);border:2px solid var(--gold);background:var(--glass-1);overflow:hidden;flex-shrink:0}
    .member-avatar img{width:100%;height:100%;object-fit:cover}
    .member-info{flex:1}
    .member-name{font-weight:700;color:var(--gold-bright);font-size:16px;margin-bottom:4px}
    .member-team{font-size:12px;color:var(--text-muted)}

    .member-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
    .stat-box{background:var(--glass-1);border:1px solid var(--border-subtle);border-radius:4px;padding:8px;text-align:center}
    .stat-label{font-size:10px;color:var(--text-muted);margin-bottom:2px;text-transform:uppercase;letter-spacing:.5px}
    .stat-value{font-size:16px;font-weight:700;color:var(--gold-bright)}

    .member-hp-section{background:var(--glass-1);border:1px solid var(--border-subtle);border-radius:var(--radius-small);padding:12px}
    .hp-label{font-size:12px;color:var(--text-muted);margin-bottom:8px;text-align:center;text-transform:uppercase;letter-spacing:.5px}
    .hp-display{font-size:18px;font-weight:700;color:var(--gold-bright);text-align:center;margin-bottom:8px}
    .hp-bar-container{background:var(--glass-1);border:1px solid var(--border-subtle);border-radius:8px;height:16px;overflow:hidden;position:relative}
    .hp-bar{background:linear-gradient(90deg,var(--success),#27ae60);height:100%;transition:width .5s ease;border-radius:8px}

    /* 응원/채팅 */
    .cheer-section{grid-column:1;grid-row:2}
    .cheer-buttons{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .cheer-btn{background:linear-gradient(135deg,var(--gold),var(--gold-bright));color:var(--deep-navy);border:none;border-radius:var(--radius-small);
      padding:16px 12px;font-size:14px;font-weight:600;cursor:pointer;transition:all var(--transition-fast);text-transform:uppercase;letter-spacing:.5px;box-shadow:var(--shadow-soft);position:relative;overflow:hidden}
    .cheer-btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);transition:left .6s}
    .cheer-btn:hover{background:linear-gradient(135deg,var(--gold-bright),var(--gold-shimmer));transform:translateY(-2px);box-shadow:var(--shadow-medium)}
    .cheer-btn:hover::before{left:100%}
    .cheer-btn:active{transform:translateY(0);background:linear-gradient(135deg,var(--warning),var(--gold))}

    .chat-section{grid-column:2;grid-row:2}
    .log-container{height:300px;overflow-y:auto;font-size:13px;line-height:1.6;padding-right:8px}
    .log-container::-webkit-scrollbar{width:6px}
    .log-container::-webkit-scrollbar-track{background:var(--glass-1);border-radius:3px}
    .log-container::-webkit-scrollbar-thumb{background:var(--gold);border-radius:3px}
    .log-container::-webkit-scrollbar-thumb:hover{background:var(--gold-bright)}
    .log-entry{margin-bottom:8px;padding:12px;border-radius:var(--radius-small);background:var(--glass-1);border-left:3px solid transparent;transition:all var(--transition-fast);animation:slideInUp .3s ease-out;position:relative;overflow:hidden}
    .log-entry::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(212,183,126,.1),transparent);transition:left .8s ease-out}
    .log-entry.new::before{left:100%}
    .log-entry:hover{background:var(--glass-2);transform:translateX(3px)}
    .log-entry.system{color:var(--text-accent);border-left-color:var(--gold);background:rgba(212,183,126,.08)}
    .log-entry.battle{color:var(--text);border-left-color:var(--info);background:rgba(52,152,219,.08)}
    .log-entry.chat{color:#96ffc8;border-left-color:var(--success);background:var(--success-light)}
    .log-entry.cheer{color:var(--warning);border-left-color:var(--warning);background:var(--warning-light);font-weight:600}
    .log-entry.damage{color:var(--danger);border-left-color:var(--danger);background:var(--danger-light);font-weight:600}
    .log-entry.heal{color:var(--success);border-left-color:var(--success);background:var(--success-light);font-weight:600}
    .log-entry.critical{color:var(--warning);border-left-color:var(--warning);background:var(--warning-light);font-weight:700;text-shadow:0 0 8px rgba(243,156,18,.5)}
    .log-timestamp{font-size:10px;color:var(--text-muted);margin-bottom:4px;opacity:.7}
    .log-content{font-size:12px;line-height:1.4}

    /* 턴 오버레이 */
    .turn-overlay{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--glass-2);backdrop-filter:var(--blur-medium);
      border:2px solid var(--gold);border-radius:var(--radius);padding:30px;text-align:center;box-shadow:var(--shadow-deep);z-index:200;min-width:300px}
    .turn-status{font-size:20px;font-weight:700;color:var(--gold-bright);margin-bottom:12px;text-shadow:0 2px 4px rgba(0,0,0,.3)}
    .turn-timer{font-size:16px;color:var(--warning);font-weight:600;margin-bottom:20px}
    .current-character{width:100px;height:100px;border-radius:var(--radius);border:3px solid var(--gold);background:var(--glass-1);margin:0 auto 16px;overflow:hidden;box-shadow:var(--shadow-medium)}
    .current-character img{width:100%;height:100%;object-fit:cover}
    .current-character-name{font-size:16px;font-weight:600;color:var(--text)}

    /* 배지 */
    .badge{display:inline-block;margin-top:6px;padding:4px 8px;border:1px solid var(--border-light);border-radius:999px;font-size:11px;color:var(--text-muted);background:var(--glass-1)}

    /* 애니메이션 */
    @keyframes slideInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}

    /* 반응형 */
    @media (max-width:1200px){
      .main-layout{grid-template-columns:1fr;grid-template-rows:auto auto auto auto;gap:16px}
      .team-a-section{grid-column:1;grid-row:1}
      .team-b-section{grid-column:1;grid-row:2}
      .cheer-section{grid-column:1;grid-row:3}
      .chat-section{grid-column:1;grid-row:4}
      .container{padding:0 16px}
    }

    /* 토스트 */
    .toast{position:fixed;top:20px;right:20px;background:var(--glass-2);backdrop-filter:var(--blur-light);
      border:1px solid var(--border-light);border-radius:var(--radius-small);padding:12px 16px;color:var(--text);
      font-size:14px;font-weight:600;box-shadow:var(--shadow-medium);z-index:1000;animation:slideInUp .3s ease-out}
    .toast.success{border-left:4px solid var(--success)}
    .toast.error{border-left:4px solid var(--danger)}
    .toast.warning{border-left:4px solid var(--warning)}

    .loading{opacity:.6;pointer-events:none}
    .hidden{display:none !important}
  </style>
</head>
<body>
  <!-- 헤더 -->
  <header class="header">
    <div class="container">
      <div class="title">
        <div class="title-main">PYXIS</div>
        <div class="title-sub">관전자 <span class="badge">데스매치 · 무승부 없음</span></div>
      </div>
    </div>
  </header>

  <!-- 메인 컨테이너 -->
  <div class="container">
    <!-- 인증 카드 -->
    <div class="auth-card" id="authCard">
      <h2 class="section-title">관전자 인증</h2>
      <div class="form-group">
        <label class="label">관전자 이름 (선택)</label>
        <input type="text" id="nameInput" placeholder="표시할 이름을 입력하세요"/>
      </div>
      <div class="form-group">
        <label class="label">비밀번호</label>
        <input type="password" id="passwordInput" placeholder="관리자가 제공한 비밀번호를 입력하세요"/>
      </div>
      <div class="actions">
        <button class="btn" id="authBtn">관전 시작</button>
      </div>
    </div>

    <!-- 메인 UI -->
    <div class="main-layout" id="gameLayout" style="display:none;">
      <!-- A팀 -->
      <section class="team-a-section">
        <div class="card">
          <h3 class="card-title">A팀</h3>
          <div class="team-list" id="teamAList"></div>
        </div>
      </section>
      <!-- B팀 -->
      <section class="team-b-section">
        <div class="card">
          <h3 class="card-title">B팀</h3>
          <div class="team-list" id="teamBList"></div>
        </div>
      </section>
      <!-- 응원 -->
      <section class="cheer-section">
        <div class="card">
          <h3 class="card-title">응원하기</h3>
          <div class="cheer-buttons">
            <button class="cheer-btn" data-cheer="멋지다!">멋지다!</button>
            <button class="cheer-btn" data-cheer="이겨라!">이겨라!</button>
            <button class="cheer-btn" data-cheer="살아서 돌아와!">살아서 돌아와!</button>
            <button class="cheer-btn" data-cheer="화이팅!">화이팅!</button>
            <button class="cheer-btn" data-cheer="죽으면 나한테 죽어!">죽으면 나한테 죽어!</button>
            <button class="cheer-btn" data-cheer="힘내요!">힘내요!</button>
          </div>
        </div>
      </section>
      <!-- 로그 -->
      <section class="chat-section">
        <div class="card">
          <h3 class="card-title">실시간 로그</h3>
          <div class="log-container" id="battleLog"></div>
        </div>
      </section>
    </div>

    <!-- 턴 오버레이 -->
    <div class="turn-overlay" id="turnOverlay" style="display:none;">
      <div class="turn-status" id="turnStatus">현재 순서팀: A팀</div>
      <div class="turn-timer" id="turnTimer">팀 제한 시간 3:45</div>
      <div class="current-character" id="currentCharacter">
        <img src="" alt="현재 턴 캐릭터" id="currentCharacterImg"/>
      </div>
      <div class="current-character-name" id="currentCharacterName">전투 참가자</div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ===== 전역 변수 =====
    let socket = null;
    let battleId = null;
    let battleState = null;
    let isAuthenticated = false;
    let spectatorName = '관전자';

    // ===== DOM 요소 =====
    const authCard = document.getElementById('authCard');
    const gameLayout = document.getElementById('gameLayout');
    const passwordInput = document.getElementById('passwordInput');
    const nameInput = document.getElementById('nameInput');
    const authBtn = document.getElementById('authBtn');
    const teamAList = document.getElementById('teamAList');
    const teamBList = document.getElementById('teamBList');
    const battleLog = document.getElementById('battleLog');
    const turnOverlay = document.getElementById('turnOverlay');
    const turnStatus = document.getElementById('turnStatus');
    const turnTimer = document.getElementById('turnTimer');
    const currentCharacterImg = document.getElementById('currentCharacterImg');
    const currentCharacterName = document.getElementById('currentCharacterName');

    // ===== 유틸 =====
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleTimeString('ko-KR', { hour12: false });
    }

    function addLogEntry(container, message, type = 'system', timestamp = Date.now()) {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type} new`;
      entry.innerHTML = `
        <div class="log-timestamp">${formatTime(timestamp)}</div>
        <div class="log-content">${escapeHtml(message)}</div>
      `;
      container.appendChild(entry);
      container.scrollTop = container.scrollHeight;
      setTimeout(() => entry.classList.remove('new'), 100);
    }

    // ===== 팀 렌더링 =====
    function createTeamMemberElement(player) {
      const div = document.createElement('div');
      div.className = 'team-member';

      const hp = Number(player.hp ?? 100);
      const maxHp = Number(player.maxHp ?? 100);
      const hpPercent = Math.max(0, Math.min(100, maxHp ? (hp / maxHp) * 100 : 0));

      const stats = player.stats || {};
      const attack = stats.attack || stats.공격 || '-';
      const defense = stats.defense || stats.방어 || '-';
      const agility = stats.agility || stats.민첩 || '-';
      const luck = stats.luck || stats.행운 || '-';

      div.innerHTML = `
        <div class="member-header">
          <div class="member-avatar">
            ${player.avatar ? `<img src="${player.avatar}" alt="${escapeHtml(player.name || '')}">` : ''}
          </div>
          <div class="member-info">
            <div class="member-name">${escapeHtml(player.name || '전투 참가자')}</div>
            <div class="member-team">팀 ${player.team}</div>
          </div>
        </div>
        <div class="member-stats">
          <div class="stat-box"><div class="stat-label">공격</div><div class="stat-value">${attack}</div></div>
          <div class="stat-box"><div class="stat-label">방어</div><div class="stat-value">${defense}</div></div>
          <div class="stat-box"><div class="stat-label">민첩</div><div class="stat-value">${agility}</div></div>
          <div class="stat-box"><div class="stat-label">행운</div><div class="stat-value">${luck}</div></div>
        </div>
        <div class="member-hp-section">
          <div class="hp-label">체력</div>
          <div class="hp-display">${hp}/${maxHp}</div>
          <div class="hp-bar-container"><div class="hp-bar" style="width:${hpPercent}%;"></div></div>
        </div>
      `;
      return div;
    }

    function updateTeamLists() {
      if (!battleState || !battleState.players) return;

      const teamA = battleState.players.filter(p => (p.team || 'A') === 'A');
      const teamB = battleState.players.filter(p => (p.team || 'A') === 'B');

      teamAList.innerHTML = teamA.length
        ? ''
        : '<div style="text-align:center;color:var(--text-muted);padding:40px 0;font-size:14px">팀원이 없습니다</div>';
      teamBList.innerHTML = teamB.length
        ? ''
        : '<div style="text-align:center;color:var(--text-muted);padding:40px 0;font-size:14px">팀원이 없습니다</div>';

      teamA.forEach(player => teamAList.appendChild(createTeamMemberElement(player)));
      teamB.forEach(player => teamBList.appendChild(createTeamMemberElement(player)));
    }

    // ===== 턴 정보 =====
    function updateTurnInfo() {
      if (!battleState) return;

      const currentTeam = battleState.currentTeam || 'A';
      const teamName = currentTeam === 'A' ? 'A팀' : 'B팀';
      turnStatus.textContent = `현재 순서팀: ${teamName}`;

      const timeLeft = Number(battleState.timeLeft ?? 300);
      const minutes = Math.max(0, Math.floor(timeLeft / 60));
      const seconds = Math.max(0, Math.floor(timeLeft % 60));
      turnTimer.textContent = `팀 제한 시간 ${minutes}:${String(seconds).padStart(2, '0')}`;

      const currentTeamPlayers = (battleState.players || [])
        .filter(p => (p.team || 'A') === currentTeam && Number(p.hp || 0) > 0);

      if (currentTeamPlayers.length > 0) {
        const activePlayer = currentTeamPlayers[0];
        if (activePlayer.avatar) {
          currentCharacterImg.src = activePlayer.avatar;
          currentCharacterImg.style.display = 'block';
        } else {
          currentCharacterImg.style.display = 'none';
        }
        currentCharacterName.textContent = activePlayer.name || '전투 참가자';
      } else {
        currentCharacterImg.style.display = 'none';
        currentCharacterName.textContent = '준비 중';
      }

      turnOverlay.style.display = battleState.status === 'active' ? 'block' : 'none';
    }

    function updateUI() {
      updateTeamLists();
      updateTurnInfo();
    }

    // ===== 소켓 연결 =====
    function connectSocket() {
      socket = io({ transports: ['websocket', 'polling'], withCredentials: true, timeout: 20000 });

      socket.on('connect', () => { showToast('서버에 연결되었습니다.'); });
      socket.on('disconnect', () => { showToast('서버 연결이 끊어졌습니다.', 'error'); });

      socket.on('battleUpdate', data => { battleState = data; updateUI(); });
      socket.on('battle:update', data => { battleState = data; updateUI(); });

      socket.on('battleLog', message => addLogEntry(battleLog, message, 'battle'));
      socket.on('battle:log', data => addLogEntry(battleLog, data.message || data, 'battle'));

      socket.on('chatMessage', data => {
        const senderName = data.name || data.senderName || '전투 참가자';
        addLogEntry(battleLog, `${senderName}: ${data.message}`, 'chat');
      });
      socket.on('battle:chat', data => {
        const senderName = data.name || data.senderName || '전투 참가자';
        addLogEntry(battleLog, `${senderName}: ${data.message}`, 'chat');
      });

      socket.on('cheerMessage', data => {
        const senderName = data.name || '관전자';
        addLogEntry(battleLog, `[응원] ${senderName}: ${data.message}`, 'cheer');
      });
      socket.on('spectator:cheer', data => {
        const senderName = data.name || '관전자';
        addLogEntry(battleLog, `[응원] ${senderName}: ${data.message}`, 'cheer');
      });

      socket.on('playerReady', data => {
        const senderName = data.name || data.playerName || '전투 참가자';
        addLogEntry(battleLog, `${senderName}님이 준비 완료했습니다!`, 'system');
        if (data.allReady) addLogEntry(battleLog, '모든 전투 참가자가 준비 완료되었습니다.', 'battle');
      });
      socket.on('player:ready', data => {
        const senderName = data.name || data.playerName || '전투 참가자';
        addLogEntry(battleLog, `${senderName}님이 준비 완료했습니다!`, 'system');
        if (data.allReady) addLogEntry(battleLog, '모든 전투 참가자가 준비 완료되었습니다.', 'battle');
      });

      socket.on('battleStarted', data => {
        const firstTeam = data.firstTeam || (data.turn && data.turn.order && data.turn.order[0]) || 'A';
        const round = (data.turn && data.turn.round) || 1;
        const teamName = firstTeam === 'A' ? 'A팀' : 'B팀';
        addLogEntry(battleLog, '전투가 시작되었습니다.', 'battle');
        addLogEntry(battleLog, `${round}라운드 - 선공: ${teamName}`, 'critical');
      });
      socket.on('battle:started', data => {
        const firstTeam = data.firstTeam || (data.turn && data.turn.order && data.turn.order[0]) || 'A';
        const round = (data.turn && data.turn.round) || 1;
        const teamName = firstTeam === 'A' ? 'A팀' : 'B팀';
        addLogEntry(battleLog, '전투가 시작되었습니다.', 'battle');
        addLogEntry(battleLog, `${round}라운드 - 선공: ${teamName}`, 'critical');
      });

      socket.on('roundStart', data => {
        const round = data.round || 1;
        const firstTeam = data.firstTeam || 'A';
        const teamName = firstTeam === 'A' ? 'A팀' : 'B팀';
        addLogEntry(battleLog, `${round}라운드 시작 - 선공: ${teamName}`, 'critical');
      });

      socket.on('actionSuccess', data => addLogEntry(battleLog, data.message || '액션이 성공했습니다.', 'system'));
      socket.on('actionError', data => addLogEntry(battleLog, data.message || '액션이 실패했습니다.', 'system'));

      socket.on('battle:ended', data => {
        const winner = data.winner || '종료';
        addLogEntry(battleLog, `전투가 종료되었습니다. 승자: ${winner}`, 'system');
        turnOverlay.style.display = 'none';
      });
    }

    // ===== 인증 처리 =====
    function authenticate() {
      const password = (passwordInput?.value || '').trim();
      const name = (nameInput?.value || '').trim();

      if (!password) { showToast('비밀번호를 입력해주세요.', 'error'); return; }

      const urlParams = new URLSearchParams(window.location.search);
      battleId = urlParams.get('battle');
      if (!battleId) { showToast('잘못된 전투 링크입니다.', 'error'); return; }

      spectatorName = name || spectatorName;
      authBtn.disabled = true;
      authBtn.textContent = '인증 중...';

      socket.emit('spectatorAuth', {
        battleId: battleId,
        token: password,
        name: spectatorName
      });

      socket.once('authSuccess', (data) => {
        isAuthenticated = true;
        battleState = data.battle;
        authCard.style.display = 'none';
        gameLayout.style.display = 'grid';
        showToast(`${spectatorName}님, 관전을 시작합니다.`);
        updateUI();
      });

      socket.once('auth:success', (data) => {
        isAuthenticated = true;
        battleState = data.battle;
        authCard.style.display = 'none';
        gameLayout.style.display = 'grid';
        showToast(`${spectatorName}님, 관전을 시작합니다.`);
        updateUI();
      });

      socket.once('authError', (data) => {
        showToast(data?.message || '인증에 실패했습니다.', 'error');
        authBtn.disabled = false;
        authBtn.textContent = '관전 시작';
      });
    }

    // ===== 이벤트 바인딩 =====
    authBtn.addEventListener('click', authenticate);
    passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') authenticate(); });
    nameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') authenticate(); });

    // 응원 버튼 리스너
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('cheer-btn')) {
        if (!socket || !battleId || !isAuthenticated) { showToast('먼저 인증을 완료해주세요.', 'error'); return; }
        const cheerMessage = e.target.dataset.cheer;
        socket.emit('cheerMessage', { battleId, message: cheerMessage, name: spectatorName });
        socket.emit('spectator:cheer', { battleId, message: cheerMessage, name: spectatorName });
        showToast(`${spectatorName}: "${cheerMessage}"`, 'success');
      }
    });

    // ===== 초기화 =====
    document.addEventListener('DOMContentLoaded', () => {
      connectSocket();

      const urlParams = new URLSearchParams(window.location.search);
      const autoPassword =
        urlParams.get('otp') ||
        urlParams.get('token') ||
        urlParams.get('password') ||
        urlParams.get('pwd') ||
        urlParams.get('auth');

      if (autoPassword) {
        passwordInput.value = autoPassword;
      }
    });
  </script>
</body>
</html>
