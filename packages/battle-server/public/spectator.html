<!-- packages/battle-server/public/spectator.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PYXIS - 관전자</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --deep-navy:#0A0F1A; --dark-blue:#0C1221; --mid-blue:#1E2A47; --light-blue:#3D5A80;
      --gold:#DCC7A2; --gold-bright:#E6D2A8; --gold-shimmer:#F0E6C8;
      --text:#F8F9FA; --text-accent:#E9ECEF; --text-muted:#ADB5BD;
      --glass-1:rgba(30,42,71,0.3); --glass-2:rgba(30,42,71,0.5); --glass-light:rgba(248,249,250,0.05);
      --border:rgba(61,90,128,0.4); --border-light:rgba(61,90,128,0.6); --border-subtle:rgba(61,90,128,0.2);
      --blur-light:blur(10px); --blur-medium:blur(15px); --blur-heavy:blur(20px);
      --transition-fast:.2s ease-out; --transition-slow:.4s ease-out;
      --radius:12px; --radius-small:8px; --shadow-soft:0 4px 6px rgba(0,0,0,.1);
      --shadow-medium:0 8px 15px rgba(0,0,0,.2); --shadow-deep:0 20px 25px rgba(0,0,0,.4);
      --serif:'Cinzel',serif; --success:#27AE60; --success-light:rgba(39,174,96,.1);
      --warning:#F39C12; --warning-light:rgba(243,156,18,.1);
      --danger:#E74C3C; --danger-light:rgba(231,76,60,.1);
      --info:#3498DB; --info-light:rgba(52,152,219,.1);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      font-family:var(--serif);
      background:linear-gradient(135deg,var(--deep-navy) 0%,var(--dark-blue) 100%);
      color:var(--text); line-height:1.6; letter-spacing:.01em; min-height:100vh;
    }
    .container{max-width:1600px;margin:0 auto;padding:0 20px}

    /* 헤더 */
    .header{background:var(--glass-2);backdrop-filter:var(--blur-light);border-bottom:1px solid var(--border-light);
      padding:16px 0; position:sticky; top:0; z-index:100; box-shadow:var(--shadow-soft)}
    .title{text-align:center;color:var(--gold-bright)}
    .title-main{
      font-size:32px;font-weight:800;letter-spacing:2px;text-shadow:0 2px 4px rgba(0,0,0,.3);
      background:linear-gradient(135deg,var(--gold),var(--gold-bright));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text
    }
    .title-sub{font-size:14px;font-weight:400;color:var(--text-muted);margin-top:4px}

    /* 인증 카드 */
    .auth-card{background:var(--glass-2);backdrop-filter:var(--blur-light);border:1px solid var(--border-light);
      border-radius:var(--radius);padding:40px;margin:60px auto;max-width:500px;text-align:center;box-shadow:var(--shadow-deep)}
    .section-title{font-size:24px;font-weight:600;color:var(--gold-bright);margin-bottom:32px;text-shadow:0 2px 4px rgba(0,0,0,.3)}
    .form-group{margin-bottom:20px;text-align:left}
    .label{display:block;font-size:14px;font-weight:600;color:var(--text-accent);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px}
    input[type="text"],input[type="password"]{
      width:100%;background:var(--glass-1);border:1px solid var(--border-light);border-radius:var(--radius-small);
      padding:12px 16px;color:var(--text);font-size:14px;transition:all var(--transition-fast)
    }
    input:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 2px rgba(212,183,126,.2)}
    .actions{margin-top:24px}
    .btn{
      background:linear-gradient(135deg,var(--gold),var(--gold-bright));color:var(--deep-navy);border:none;border-radius:var(--radius-small);
      padding:12px 24px;font-size:14px;font-weight:600;cursor:pointer;transition:all var(--transition-fast);
      text-transform:uppercase;letter-spacing:.5px;box-shadow:var(--shadow-soft);position:relative;overflow:hidden
    }
    .btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);transition:left .6s}
    .btn:hover:not(:disabled){background:linear-gradient(135deg,var(--gold-bright),var(--gold-shimmer));transform:translateY(-2px);box-shadow:var(--shadow-medium)}
    .btn:hover:not(:disabled)::before{left:100%}
    .btn:disabled{background:var(--glass-1);color:var(--text-muted);cursor:not-allowed;transform:none;box-shadow:none}

    /* 레이아웃 */
    .main-layout{display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr auto;gap:24px;padding:24px 0;min-height:calc(100vh - 100px)}

    /* 카드 */
    .card{background:var(--glass-2);backdrop-filter:var(--blur-light);border:1px solid var(--border-light);
      border-radius:var(--radius);padding:24px;box-shadow:var(--shadow-soft);transition:all var(--transition-fast)}
    .card-title{font-size:18px;font-weight:600;color:var(--gold-bright);margin-bottom:20px;text-align:center;text-shadow:0 2px 4px rgba(0,0,0,.3);text-transform:uppercase;letter-spacing:1px}

    .team-a-section{grid-column:1;grid-row:1}
    .team-b-section{grid-column:2;grid-row:1}

    .team-list{display:flex;flex-direction:column;gap:16px}
    .team-member{background:var(--glass-1);border:1px solid var(--border-subtle);border-radius:var(--radius-small);padding:16px;transition:all var(--transition-fast)}
    .team-member:hover{background:var(--glass-2);border-color:var(--border-light);transform:translateY(-2px);box-shadow:var(--shadow-soft)}

    .member-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .member-avatar{width:50px;height:50px;border-radius:var(--radius-small);border:2px solid var(--gold);background:var(--glass-1);overflow:hidden;flex-shrink:0}
    .member-avatar img{width:100%;height:100%;object-fit:cover}
    .member-info{flex:1}
    .member-name{font-weight:700;color:var(--gold-bright);font-size:16px;margin-bottom:4px}
    .member-team{font-size:12px;color:var(--text-muted)}

    .member-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
    .stat-box{background:var(--glass-1);border:1px solid var(--border-subtle);border-radius:4px;padding:8px;text-align:center}
    .stat-label{font-size:10px;color:var(--text-muted);margin-bottom:2px;text-transform:uppercase;letter-spacing:.5px}
    .stat-value{font-size:16px;font-weight:700;color:var(--gold-bright)}

    .member-hp-section{background:var(--glass-1);border:1px solid var(--border-subtle);border-radius:var(--radius-small);padding:12px}
    .hp-label{font-size:12px;color:var(--text-muted);margin-bottom:8px;text-align:center;text-transform:uppercase;letter-spacing:.5px}
    .hp-display{font-size:18px;font-weight:700;color:var(--gold-bright);text-align:center;margin-bottom:8px}
    .hp-bar-container{background:var(--glass-1);border:1px solid var(--border-subtle);border-radius:8px;height:16px;overflow:hidden;position:relative}
    .hp-bar{background:linear-gradient(90deg,var(--success),#27ae60);height:100%;transition:width .5s ease;border-radius:8px}

    /* 응원/채팅 */
    .cheer-section{grid-column:1;grid-row:2}
    .cheer-buttons{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .cheer-btn{background:linear-gradient(135deg,var(--gold),var(--gold-bright));color:var(--deep-navy);border:none;border-radius:var(--radius-small);
      padding:16px 12px;font-size:14px;font-weight:600;cursor:pointer;transition:all var(--transition-fast);text-transform:uppercase;letter-spacing:.5px;box-shadow:var(--shadow-soft);position:relative;overflow:hidden}
    .cheer-btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);transition:left .6s}
    .cheer-btn:hover{background:linear-gradient(135deg,var(--gold-bright),var(--gold-shimmer));transform:translateY(-2px);box-shadow:var(--shadow-medium)}
    .cheer-btn:hover::before{left:100%}
    .cheer-btn:active{transform:translateY(0);background:linear-gradient(135deg,var(--warning),var(--gold))}

    .chat-section{grid-column:2;grid-row:2}
    .log-container{height:300px;overflow-y:auto;font-size:13px;line-height:1.6;padding-right:8px}
    .log-container::-webkit-scrollbar{width:6px}
    .log-container::-webkit-scrollbar-track{background:var(--glass-1);border-radius:3px}
    .log-container::-webkit-scrollbar-thumb{background:var(--gold);border-radius:3px}
    .log-container::-webkit-scrollbar-thumb:hover{background:var(--gold-bright)}

    .log-entry{margin-bottom:8px;padding:12px;border-radius:var(--radius-small);background:var(--glass-1);border-left:3px solid transparent;transition:all var(--transition-fast);animation:slideInUp .3s ease-out;position:relative;overflow:hidden}
    .log-entry::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(212,183,126,.1),transparent);transition:left .8s ease-out}
    .log-entry.new::before{left:100%}
    .log-entry:hover{background:var(--glass-2);transform:translateX(3px)}
    .log-entry.system{color:var(--text-accent);border-left-color:var(--gold);background:rgba(212,183,126,.08)}
    .log-entry.battle{color:var(--text);border-left-color:var(--info);background:rgba(52,152,219,.08)}
    .log-entry.chat{color:#96ffc8;border-left-color:var(--success);background:var(--success-light)}
    .log-entry.cheer{color:var(--warning);border-left-color:var(--warning);background:var(--warning-light);font-weight:600}
    .log-entry.damage{color:var(--danger);border-left-color:var(--danger);background:var(--danger-light);font-weight:600}
    .log-entry.heal{color:var(--success);border-left-color:var(--success);background:var(--success-light);font-weight:600}
    .log-entry.critical{color:var(--warning);border-left-color:var(--warning);background:var(--warning-light);font-weight:700;text-shadow:0 0 8px rgba(243,156,18,.5)}
    .log-timestamp{font-size:10px;color:var(--text-muted);margin-bottom:4px;opacity:.7}
    .log-content{font-size:12px;line-height:1.4}

    /* 턴 오버레이 */
    .turn-overlay{position:fixed;top:50%;left:50%;transform:translate(-50%, -50%);background:var(--glass-2);backdrop-filter:var(--blur-medium);
      border:2px solid var(--gold);border-radius:var(--radius);padding:22px 24px;text-align:center;box-shadow:var(--shadow-deep);z-index:200;min-width:320px}
    .turn-status{font-size:18px;font-weight:700;color:var(--gold-bright);margin-bottom:10px;text-shadow:0 2px 4px rgba(0,0,0,.3)}
    .turn-timer{font-size:14px;color:var(--warning);font-weight:600;margin-bottom:12px}

    .queue{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin:8px 0 12px}
    .q-item{font-size:11px;padding:4px 8px;border:1px solid var(--border-subtle);border-radius:999px;background:var(--glass-1);color:var(--text-muted)}
    .q-item.alive{color:var(--text)}
    .q-item.acted{opacity:.45;text-decoration:line-through}
    .q-item.current{border-color:var(--gold);box-shadow:0 0 10px rgba(220,199,162,.25)}

    .current-character{width:110px;height:110px;border-radius:var(--radius);border:3px solid var(--gold);background:var(--glass-1);margin:0 auto 10px;overflow:hidden;box-shadow:var(--shadow-medium)}
    .current-character img{width:100%;height:100%;object-fit:cover}
    .current-character-name{font-size:16px;font-weight:600;color:var(--text)}

    /* 배지 */
    .badge{display:inline-block;margin-top:6px;padding:4px 8px;border:1px solid var(--border-light);border-radius:999px;font-size:11px;color:var(--text-muted);background:var(--glass-1)}

    /* 애니메이션 */
    @keyframes slideInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

    /* 반응형 */
    @media (max-width:1200px){
      .main-layout{grid-template-columns:1fr;grid-template-rows:auto auto auto auto;gap:16px}
      .team-a-section{grid-column:1;grid-row:1}
      .team-b-section{grid-column:1;grid-row:2}
      .cheer-section{grid-column:1;grid-row:3}
      .chat-section{grid-column:1;grid-row:4}
      .container{padding:0 16px}
    }

    /* 토스트 */
    .toast{position:fixed;top:20px;right:20px;background:var(--glass-2);backdrop-filter:var(--blur-light);
      border:1px solid var(--border-light);border-radius:var(--radius-small);padding:12px 16px;color:var(--text);
      font-size:14px;font-weight:600;box-shadow:var(--shadow-medium);z-index:1000;animation:slideInUp .3s ease-out}
    .toast.success{border-left:4px solid var(--success)}
    .toast.error{border-left:4px solid var(--danger)}
    .toast.warning{border-left:4px solid var(--warning)}

    .loading{opacity:.6;pointer-events:none}
    .hidden{display:none !important}
  </style>
</head>
<body>
  <!-- 헤더 -->
  <header class="header">
    <div class="container">
      <div class="title">
        <div class="title-main">PYXIS</div>
        <div class="title-sub">관전자 <span class="badge">데스매치 · 무승부 없음</span></div>
      </div>
    </div>
  </header>

  <!-- 메인 컨테이너 -->
  <div class="container">
    <!-- 인증 카드 -->
    <div class="auth-card" id="authCard">
      <h2 class="section-title">관전자 인증</h2>
      <div class="form-group">
        <label class="label">관전자 이름 (선택)</label>
        <input type="text" id="nameInput" placeholder="표시할 이름을 입력하세요"/>
      </div>
      <div class="form-group">
        <label class="label">비밀번호</label>
        <input type="password" id="passwordInput" placeholder="관리자가 제공한 비밀번호를 입력하세요"/>
      </div>
      <div class="actions">
        <button class="btn" id="authBtn">관전 시작</button>
      </div>
    </div>

    <!-- 메인 UI -->
    <div class="main-layout" id="gameLayout" style="display:none;">
      <!-- A팀 -->
      <section class="team-a-section">
        <div class="card">
          <h3 class="card-title">A팀</h3>
          <div class="team-list" id="teamAList"></div>
        </div>
      </section>
      <!-- B팀 -->
      <section class="team-b-section">
        <div class="card">
          <h3 class="card-title">B팀</h3>
          <div class="team-list" id="teamBList"></div>
        </div>
      </section>
      <!-- 응원 -->
      <section class="cheer-section">
        <div class="card">
          <h3 class="card-title">응원하기</h3>
          <div class="cheer-buttons">
            <button class="cheer-btn" data-cheer="멋지다!">멋지다!</button>
            <button class="cheer-btn" data-cheer="이겨라!">이겨라!</button>
            <button class="cheer-btn" data-cheer="살아서 돌아와!">살아서 돌아와!</button>
            <button class="cheer-btn" data-cheer="화이팅!">화이팅!</button>
            <button class="cheer-btn" data-cheer="죽으면 나한테 죽어!">죽으면 나한테 죽어!</button>
            <button class="cheer-btn" data-cheer="힘내요!">힘내요!</button>
          </div>
        </div>
      </section>
      <!-- 로그 -->
      <section class="chat-section">
        <div class="card">
          <h3 class="card-title">실시간 로그</h3>
          <div class="log-container" id="battleLog"></div>
        </div>
      </section>
    </div>

    <!-- 턴 오버레이 -->
    <div class="turn-overlay" id="turnOverlay" style="display:none;">
      <div class="turn-status" id="turnStatus">현재 순서팀: A팀</div>
      <div class="turn-timer" id="turnTimer">팀 제한 시간 -</div>

      <!-- 현재팀 행동 큐 -->
      <div class="queue" id="queue"></div>

      <div class="current-character" id="currentCharacter">
        <img src="" alt="현재 턴 캐릭터" id="currentCharacterImg"/>
      </div>
      <div class="current-character-name" id="currentCharacterName">전투 참가자</div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ===== 전역 상태 =====
    let socket = null;
    let battleId = null;
    let battleState = null;
    let isAuthenticated = false;
    let spectatorName = '관전자';

    // ===== DOM =====
    const authCard = document.getElementById('authCard');
    const gameLayout = document.getElementById('gameLayout');
    const passwordInput = document.getElementById('passwordInput');
    const nameInput = document.getElementById('nameInput');
    const authBtn = document.getElementById('authBtn');
    const teamAList = document.getElementById('teamAList');
    const teamBList = document.getElementById('teamBList');
    const battleLog = document.getElementById('battleLog');
    const turnOverlay = document.getElementById('turnOverlay');
    const turnStatus = document.getElementById('turnStatus');
    const turnTimer = document.getElementById('turnTimer');
    const currentCharacterImg = document.getElementById('currentCharacterImg');
    const currentCharacterName = document.getElementById('currentCharacterName');
    const queueEl = document.getElementById('queue');

    // ===== 유틸 =====
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
    const esc = (s)=>String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m]));
    function formatTime(ts){ try{ return new Date(ts).toLocaleTimeString('ko-KR',{hour12:false}); }catch{ return '-'; } }

    // 로그 분류 + 이펙트
    function classifyLog(dataOrType, msg=''){
      const t = (typeof dataOrType==='string'?dataOrType:(dataOrType?.type||'')).toLowerCase();
      if (t.includes('critical') || /치명타|크리티컬/i.test(msg)) return 'critical';
      if (t.includes('heal') || /회복|치유|디터니/i.test(msg))   return 'heal';
      if (t.includes('damage') || /피해|데미지/i.test(msg))      return 'damage';
      if (t.includes('cheer'))                                   return 'cheer';
      if (t.includes('chat'))                                    return 'chat';
      if (t.includes('system'))                                  return 'system';
      return 'battle';
    }
    function addLogEntry(container, message, type='battle', ts=Date.now()){
      const entry = document.createElement('div');
      entry.className = `log-entry ${classifyLog(type, message)} new`;
      entry.innerHTML = `<div class="log-timestamp">${formatTime(ts)}</div><div class="log-content">${esc(message)}</div>`;
      container.appendChild(entry);
      container.scrollTop = container.scrollHeight;
      setTimeout(()=>entry.classList.remove('new'), 120);
      if (container.children.length > 500) container.removeChild(container.firstChild);
    }

    // ===== 팀 렌더링 =====
    function memberCard(player){
      const div = document.createElement('div');
      div.className = 'team-member';
      const hp = Number(player.hp ?? 100), max = Number(player.maxHp ?? 100);
      const pct = Math.max(0, Math.min(100, max ? (hp/max)*100 : 0));
      const st = player.stats || {};
      div.innerHTML = `
        <div class="member-header">
          <div class="member-avatar">${player.avatar?`<img src="${esc(player.avatar)}" alt="${esc(player.name||'')}"/>`:''}</div>
          <div class="member-info">
            <div class="member-name">${esc(player.name||'전투 참가자')}</div>
            <div class="member-team">팀 ${esc(player.team||'-')}</div>
          </div>
        </div>
        <div class="member-stats">
          <div class="stat-box"><div class="stat-label">공격</div><div class="stat-value">${st.attack ?? '-'}</div></div>
          <div class="stat-box"><div class="stat-label">방어</div><div class="stat-value">${st.defense ?? '-'}</div></div>
          <div class="stat-box"><div class="stat-label">민첩</div><div class="stat-value">${st.agility ?? '-'}</div></div>
          <div class="stat-box"><div class="stat-label">행운</div><div class="stat-value">${st.luck ?? '-'}</div></div>
        </div>
        <div class="member-hp-section">
          <div class="hp-label">체력</div>
          <div class="hp-display">${hp}/${max}</div>
          <div class="hp-bar-container"><div class="hp-bar" style="width:${pct}%"></div></div>
        </div>`;
      return div;
    }
    function renderTeams(){
      if (!battleState?.players) return;
      const A = battleState.players.filter(p => (p.team||'A')==='A');
      const B = battleState.players.filter(p => (p.team||'A')==='B');
      teamAList.innerHTML = A.length ? '' : '<div style="text-align:center;color:var(--text-muted);padding:40px 0;font-size:14px">팀원이 없습니다</div>';
      teamBList.innerHTML = B.length ? '' : '<div style="text-align:center;color:var(--text-muted);padding:40px 0;font-size:14px">팀원이 없습니다</div>';
      A.forEach(p=>teamAList.appendChild(memberCard(p)));
      B.forEach(p=>teamBList.appendChild(memberCard(p)));
    }

    // ===== 큐/턴 표시 =====
    function getCurrentTeam(){
      return battleState?.currentTurn?.currentTeam || battleState?.currentTeam || 'A';
    }
    function aliveTeamPlayers(team){
      const list = (battleState?.players||[]).filter(p => (p.team===team) && Number(p.hp||0) > 0);
      // 서버에 정렬이 있으면 그대로, 없으면 민첩/행운/이름으로 정렬
      if (!battleState?.currentTurn?.order){
        list.sort((a,b)=>{
          const ag = (b.stats?.agility||0) - (a.stats?.agility||0);
          if (ag) return ag;
          const lk = (b.stats?.luck||0) - (a.stats?.luck||0);
          if (lk) return lk;
          return String(a.name||'').localeCompare(String(b.name||''));
        });
      }
      return list;
    }
    function buildQueue(){
      const team = getCurrentTeam();
      const turn = battleState?.currentTurn || {};
      const acted = turn.playerActions || {};
      // 우선 서버 order/actor 제공 시 활용
      let names = Array.isArray(turn.order) ? [...turn.order] : aliveTeamPlayers(team).map(p=>p.name);
      queueEl.innerHTML = '';
      names.forEach(n=>{
        const el = document.createElement('div');
        el.className = 'q-item alive' + (acted?.[n] ? ' acted' : '') + ((turn.actorName && turn.actorName===n) ? ' current' : '');
        el.textContent = n || '참가자';
        queueEl.appendChild(el);
      });
    }
    function currentActor(){
      const team = getCurrentTeam();
      const turn = battleState?.currentTurn || {};
      // 1) actorId/actorName 우선
      if (turn.actorId || turn.actorName){
        const byName = (battleState?.players||[]).find(p=>p.name===turn.actorName);
        const byId   = (battleState?.players||[]).find(p=>(p.id||p._id)===turn.actorId);
        return byName || byId || null;
      }
      // 2) order와 playerActions로 미행동자 찾기
      const order = Array.isArray(turn.order) ? turn.order : [];
      const acted = turn.playerActions || {};
      for (const nm of order){ if (!acted[nm]) return (battleState?.players||[]).find(p=>p.name===nm) || null; }
      // 3) 대안: 생존자 첫 명
      return aliveTeamPlayers(team)[0] || null;
    }
    function msLeft(){
      const turn = battleState?.currentTurn || {};
      // 서버가 남은 초를 직접 주면 사용(timeLeftSec)
      if (typeof turn.timeLeftSec === 'number') return Math.max(0, turn.timeLeftSec*1000);
      // startedAt + LIMIT(5분) 계산
      const start = Number(turn.startedAt || battleState?.turnStartTime || 0);
      if (!start) return null;
      const LIMIT = 5*60*1000;
      return Math.max(0, LIMIT - (Date.now() - start));
    }
    let ticker = null;
    function startTimer(){
      if (ticker) clearInterval(ticker);
      const tick = ()=>{
        const rest = msLeft();
        if (rest === null) { turnTimer.textContent = '팀 제한 시간 -'; return; }
        const m = Math.floor(rest/60000), s = Math.floor((rest%60000)/1000);
        turnTimer.textContent = `팀 제한 시간 ${m}:${String(s).padStart(2,'0')}`;
      };
      tick(); ticker = setInterval(tick, 500);
    }
    function renderTurn(){
      const status = battleState?.status || 'waiting';
      turnOverlay.style.display = (status==='active' || status==='started') ? 'block' : 'none';
      const team = getCurrentTeam();
      turnStatus.textContent = `현재 순서팀: ${team==='A'?'A팀':'B팀'}`;
      // 큐
      buildQueue();
      // 현재 배우 표시
      const actor = currentActor();
      if (actor?.avatar){ currentCharacterImg.src = actor.avatar; currentCharacterImg.style.display='block'; }
      else { currentCharacterImg.removeAttribute('src'); currentCharacterImg.style.display='none'; }
      currentCharacterName.textContent = actor?.name || '대기 중';
      // 타이머
      startTimer();
    }

    function renderAll(){
      renderTeams();
      renderTurn();
    }

    // ===== 소켓 =====
    function connect(){
      socket = io({ path:'/socket.io', transports:['websocket','polling'] });
      socket.on('connect', ()=> showToast('서버에 연결되었습니다.'));
      socket.on('disconnect', ()=> showToast('서버 연결이 끊어졌습니다.', 'error'));

      // 스냅샷/턴 갱신
      function onBattle(s){ battleState = s; renderAll(); }
      function onTurn(t){ if (!battleState) battleState = {}; battleState.currentTurn = t; renderTurn(); }
      socket.on('battleUpdate', onBattle);
      socket.on('battle:update', onBattle);
      socket.on('turnUpdate', onTurn);
      socket.on('turn:update', onTurn);

      // 로그류 (종류별 이펙트)
      socket.on('battleLog',    d => addLogEntry(battleLog, typeof d==='string'?d : (d.message||''), classifyLog(d, d?.message), Date.now()));
      socket.on('battle:log',   d => addLogEntry(battleLog, d?.message||'', classifyLog(d, d?.message), Date.now()));
      socket.on('systemMessage',d => addLogEntry(battleLog, d?.message||'', 'system'));
      socket.on('chatMessage',  d => addLogEntry(battleLog, `${d?.name||'전투 참가자'}: ${d?.message||''}`, 'chat'));
      socket.on('battle:chat',  d => addLogEntry(battleLog, `${d?.name||'전투 참가자'}: ${d?.message||''}`, 'chat'));
      socket.on('cheerMessage', d => addLogEntry(battleLog, `[응원] ${d?.name||'관전자'}: ${d?.message||''}`, 'cheer'));
      socket.on('spectator:cheer', d => addLogEntry(battleLog, `[응원] ${d?.name||'관전자'}: ${d?.message||''}`, 'cheer'));

      // 진행 알림
      socket.on('battleStarted', d=>{
        addLogEntry(battleLog, '전투가 시작되었습니다.', 'battle');
        const first = d?.firstTeam || getCurrentTeam();
        addLogEntry(battleLog, `라운드 ${d?.turn?.round||1} 시작 - 선공: ${first==='A'?'A팀':'B팀'}`, 'critical');
      });
      socket.on('battle:started', d=>{
        addLogEntry(battleLog, '전투가 시작되었습니다.', 'battle');
        const first = d?.firstTeam || getCurrentTeam();
        addLogEntry(battleLog, `라운드 ${d?.turn?.round||1} 시작 - 선공: ${first==='A'?'A팀':'B팀'}`, 'critical');
      });
      socket.on('roundStart', d=>{
        addLogEntry(battleLog, `${d?.round||1}라운드 시작 - 선공: ${(d?.firstTeam||'A')==='A'?'A팀':'B팀'}`, 'critical');
      });
      socket.on('roundEnd', d=>{
        const r = d?.round ?? '?';
        const sum = d?.summary ? ` (${d.summary})` : '';
        addLogEntry(battleLog, `라운드 ${r} 종료${sum}`, 'system');
      });
      socket.on('battle:ended', d=>{
        addLogEntry(battleLog, `전투가 종료되었습니다. 승자: ${d?.winner||'알 수 없음'}`, 'system');
        turnOverlay.style.display = 'none';
      });
    }

    // ===== 인증 =====
    function authenticate(){
      const pwd = (passwordInput.value||'').trim();
      const nm  = (nameInput.value||'').trim();
      if (!pwd){ showToast('비밀번호를 입력해주세요.', 'error'); return; }

      const p = new URLSearchParams(location.search);
      battleId = p.get('battle') || p.get('id');
      if (!battleId){ showToast('잘못된 전투 링크입니다.', 'error'); return; }

      spectatorName = nm || spectatorName;
      authBtn.disabled = true; authBtn.textContent = '인증 중...';

      socket.emit('spectatorAuth', { battleId, token: pwd, name: spectatorName });

      const onOk = (data)=>{
        isAuthenticated = true;
        battleState = data?.battle || battleState;
        authCard.style.display = 'none';
        gameLayout.style.display = 'grid';
        showToast(`${spectatorName}님, 관전을 시작합니다.`);
        if (battleId) socket.emit('join', { battleId });
        renderAll();
      };
      const onErr = (data)=>{
        showToast(data?.message || '인증에 실패했습니다.', 'error');
        authBtn.disabled = false; authBtn.textContent = '관전 시작';
      };

      socket.once('authSuccess', onOk);
      socket.once('auth:success', onOk);
      socket.once('authError', onErr);
    }

    // ===== 이벤트 바인딩 =====
    authBtn.addEventListener('click', authenticate);
    passwordInput.addEventListener('keydown', e=>{ if(e.key==='Enter') authenticate(); });
    nameInput.addEventListener('keydown', e=>{ if(e.key==='Enter') authenticate(); });

    // 응원 버튼
    document.addEventListener('click', e=>{
      if (!e.target.classList.contains('cheer-btn')) return;
      if (!socket || !battleId || !isAuthenticated){ showToast('먼저 인증을 완료해주세요.', 'error'); return; }
      const msg = e.target.dataset.cheer;
      socket.emit('cheerMessage', { battleId, message: msg, name: spectatorName });
      socket.emit('spectator:cheer', { battleId, message: msg, name: spectatorName });
      showToast(`${spectatorName}: "${msg}"`, 'success');
    });

    // ===== 초기화 =====
    document.addEventListener('DOMContentLoaded', ()=>{
      connect();
      // URL에서 OTP 자동 채움
      const p = new URLSearchParams(location.search);
      const autoPwd = p.get('otp') || p.get('token') || p.get('password') || p.get('pwd') || p.get('auth');
      if (autoPwd) passwordInput.value = autoPwd;
    });
  </script>
</body>
</html>
