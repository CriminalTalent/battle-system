<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PYXIS - 관전자</title>
  <script src="/socket.io/socket.io.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      /* 블랙 테마 */
      --black:#0a0a0a; --black-3:#141414;
      --panel: rgba(255,255,255,.04); --panel-2: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.1); --border-2: rgba(255,255,255,.18);
      --gold:#DCC7A2; --gold-2:#E6D2A8; --text:#F5F6F7; --muted:#A5A7AA;
      --radius:12px; --shadow:0 8px 24px rgba(0,0,0,.35); --serif:'Cinzel',serif;
      --success:#27AE60; --danger:#E74C3C;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{min-height:100vh;background:linear-gradient(145deg,var(--black),var(--black-3));color:var(--text);font-family:var(--serif)}
    .header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(10,10,10,.96),rgba(10,10,10,.74));border-bottom:1px solid var(--border);padding:10px 16px;display:flex;justify-content:space-between;align-items:center}
    .brand{font-weight:900;color:var(--gold-2);letter-spacing:1px}
    .dot{width:10px;height:10px;border-radius:999px;background:#555}
    .dot.ok{background:#2fa362}.dot.bad{background:#a63a2f}
    .wrap{max-width:1400px;margin:0 auto;padding:16px;display:grid;grid-template-columns:320px 1fr 380px;gap:16px}
    @media (max-width:1200px){.wrap{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:16px}
    .title{font-weight:800;color:var(--gold-2);border-bottom:1px solid var(--border);padding-bottom:10px;margin-bottom:12px;text-transform:uppercase;font-size:16px}
    .hint{font-size:11px;color:var(--muted)}
    input,button{
      font-family:var(--serif);
    }
    input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.03);color:var(--text)}
    input:focus,select:focus{outline:none;border-color:var(--gold)}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:linear-gradient(180deg,var(--panel-2),var(--panel));color:var(--text);cursor:pointer;font-weight:800}
    .btn:hover{border-color:var(--border-2)}
    .btn-primary{background:linear-gradient(180deg,#a68c64,#8c774f);border-color:#947e59;color:#0c0c0c}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .kpi .box{background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:10px;padding:10px}
    .stat{display:flex;justify-content:space-between;font-size:12px}
    .hpbar{height:8px;border-radius:999px;background:rgba(255,255,255,.07);overflow:hidden;border:1px solid var(--border)}
    .hpbar>span{display:block;height:100%;background:linear-gradient(90deg,#3fb45f,#2a8f49)}
    .team-list{display:flex;flex-direction:column;gap:8px;max-height:400px;overflow:auto}
    .mini{display:flex;gap:10px;align-items:center;border:1px solid var(--border);background:rgba(255,255,255,.02);padding:8px;border-radius:10px}
    .mini img{width:36px;height:36px;border-radius:8px;object-fit:cover;border:1px solid var(--border)}
    .chip{display:inline-block;padding:4px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px}
    .hero{display:grid;grid-template-rows:auto 1fr auto;gap:12px;min-height:540px}
    .turn-bar{display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:12px;padding:10px 12px}
    .portrait{display:grid;place-items:center;border-radius:16px;border:1px solid var(--border);background:rgba(255,255,255,.03);min-height:360px;position:relative;overflow:hidden}
    .portrait img{width:100%;height:100%;object-fit:cover}
    .portrait .meta{position:absolute;left:12px;bottom:12px;background:rgba(0,0,0,.4);backdrop-filter:blur(4px);border:1px solid var(--border);border-radius:10px;padding:10px;min-width:240px}
    .log{height:260px;overflow:auto;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:10px;padding:10px;font-size:12px}
    .log .item{padding:6px 4px;border-bottom:1px dashed rgba(255,255,255,.08)}
    .log .ts{color:#9aa; font-size:11px;margin-right:8px}
    .chat{height:140px;overflow:auto;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:10px;padding:10px;margin-top:8px}
    .row{display:flex;gap:8px;align-items:center}
    .auth-card{max-width:560px;margin:36px auto;padding:16px;border:1px solid var(--border);border-radius:12px;background:var(--panel)}
    .sr{height:6px}
  </style>
</head>
<body>
  <div class="header">
    <div class="brand">PYXIS · 관전자</div>
    <div class="row">
      <span class="hint" id="connText">연결 대기</span>
      <span id="connDot" class="dot"></span>
    </div>
  </div>

  <!-- 인증(이름 필수) -->
  <div id="authView" class="auth-card">
    <div class="title">관전 입장</div>
    <div class="sr"></div>
    <div class="grid2">
      <div>
        <div class="hint">전투 ID</div>
        <input id="battleIdInput" placeholder="battle_xxxxxxxx"/>
      </div>
      <div>
        <div class="hint">이름(필수)</div>
        <input id="nameInput" placeholder="관전자 이름"/>
      </div>
    </div>
    <div class="sr"></div>
    <div class="grid2">
      <div>
        <div class="hint">비밀번호/토큰(필수)</div>
        <input id="tokenInput" placeholder="OTP/Token"/>
      </div>
      <div>
        <div class="hint">도움말</div>
        <div class="hint">이름/비밀번호 모두 입력해야 관전 시작 가능.</div>
      </div>
    </div>
    <div class="sr"></div>
    <div class="row">
      <button id="btnAuth" class="btn btn-primary" style="flex:1">관전 시작</button>
      <button id="btnAuthFill" class="btn" title="URL 파라미터로 채우기">URL 채우기</button>
    </div>
  </div>

  <!-- 본 화면(전투 참가자와 동일 3열 레이아웃: 좌팀/중앙초상화/우로그) -->
  <div id="mainView" class="wrap" style="display:none">
    <!-- 좌: 팀 현황 -->
    <div class="card">
      <div class="title">팀 현황</div>
      <div class="title" style="margin-top:0">A팀</div>
      <div id="teamA" class="team-list"></div>
      <div class="title" style="margin-top:8px">B팀</div>
      <div id="teamB" class="team-list"></div>
    </div>

    <!-- 중앙: 큰 초상화 + 현재 턴 -->
    <div class="card hero">
      <div class="turn-bar">
        <div class="row">
          <span class="chip">상태: <b id="battleStatus">-</b></span>
          <span class="chip">현재 팀: <b id="currentTeam">-</b></span>
          <span class="chip">선공 팀: <b id="firstTeam">-</b></span>
          <span class="chip">라운드: <b id="roundNum">-</b></span>
        </div>
        <div class="row">
          <span class="hint">데스매치 · 무승부 없음</span>
        </div>
      </div>

      <div class="portrait">
        <img id="turnPortrait" alt="현재 차례 초상화"/>
        <div class="meta">
          <div style="font-weight:900" id="turnName">-</div>
          <div class="stat"><span>HP</span><span id="turnHpText">0/100</span></div>
          <div class="hpbar"><span id="turnHpBar" style="width:0%"></span></div>
        </div>
      </div>

      <div class="row" style="gap:6px;flex-wrap:wrap">
        <!-- 고정 응원 멘트 -->
        <button class="btn" data-cheer="멋지다!">멋지다!</button>
        <button class="btn" data-cheer="이겨라!">이겨라!</button>
        <button class="btn" data-cheer="살아서 돌아와!">살아서 돌아와!</button>
        <button class="btn" data-cheer="화이팅!">화이팅!</button>
        <button class="btn" data-cheer="죽으면 나한테 죽어!">죽으면 나한테 죽어!</button>
        <button class="btn" data-cheer="힘내요!">힘내요!</button>
      </div>
    </div>

    <!-- 우: 로그/채팅 -->
    <div class="card">
      <div class="title">실시간 로그</div>
      <div id="logBox" class="log"></div>
      <div class="title" style="margin-top:12px">채팅</div>
      <div id="chatBox" class="chat"></div>
      <div class="row" style="margin-top:8px">
        <input id="chatInput" placeholder="메시지 입력(Enter 전송)"/>
        <button id="btnSendChat" class="btn">전송</button>
      </div>
    </div>
  </div>

  <script>
    const $=(q)=>document.querySelector(q);
    const h=(html)=>{const d=document.createElement('div');d.innerHTML=html.trim();return d.firstChild;}
    const ts = ()=> new Date().toLocaleTimeString('ko-KR',{hour12:false});
    function escapeHtml(s){return String(s).replace(/[&<>\"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}
    const logBox = $('#logBox');
    function addLog(msg, type='info'){
      const el = h(`<div class="item"><span class="ts">${ts()}</span><span>[${type}]</span> ${escapeHtml(msg)}</div>`);
      logBox.appendChild(el); logBox.scrollTop = logBox.scrollHeight;
    }

    let socket=null, battle=null, firstTeamMemo=null;
    const connText=$('#connText'), connDot=$('#connDot');

    const authView=$('#authView'), mainView=$('#mainView');
    const battleIdInput=$('#battleIdInput'), nameInput=$('#nameInput'), tokenInput=$('#tokenInput');

    $('#btnAuthFill').onclick=()=>{
      const u=new URL(location.href);
      battleIdInput.value = u.searchParams.get('battle')||'';
      nameInput.value = u.searchParams.get('name')||'';
      tokenInput.value = u.searchParams.get('otp')||u.searchParams.get('token')||u.searchParams.get('password')||'';
      addLog('URL 파라미터로 인증 폼 채움');
    };

    $('#btnAuth').onclick = ()=>{
      const id=(battleIdInput.value||'').trim();
      const nm=(nameInput.value||'').trim();
      const tk=(tokenInput.value||'').trim();
      if(!id || !nm || !tk){ addLog('이름/전투ID/비밀번호는 필수입니다.','error'); return; }
      ensureSocket();
      socket.emit('join',{battleId:id});
      addLog('join 송신');
      // 관전은 별도 spectatorAuth가 없어도 가능. 이름은 응원/채팅에 사용.
      authView.style.display='none'; mainView.style.display='grid';
      addLog('관전 화면 진입');
    };

    function ensureSocket(){
      if(socket) return;
      socket = window.io ? window.io({ path:'/socket.io' }) : null;
      if(!socket){ addLog('소켓 초기화 실패','error'); return; }

      socket.on('connect',()=>{connText.textContent='연결됨'; connDot.classList.remove('bad'); connDot.classList.add('ok'); addLog('소켓 연결 완료');});
      socket.on('disconnect',()=>{connText.textContent='연결 끊김'; connDot.classList.remove('ok'); connDot.classList.add('bad'); addLog('소켓 끊김','error');});

      socket.on('battleUpdate', onBattleUpdate);
      socket.on('battle:update', onBattleUpdate);

      socket.on('chatMessage', ({name,message})=>{
        pushChat(name||'익명', message||'');
        addLog(`채팅 수신 <${name||'익명'}>: ${message||''}`,'chat');
      });
      socket.on('battle:chat', ({name,senderName,message})=>{
        const nm=name||senderName||'익명';
        pushChat(nm, message||'');
        addLog(`채팅 수신 <${nm}>: ${message||''}`,'chat');
      });
    }

    function onBattleUpdate(b){
      battle=b;
      addLog(`스냅샷 수신: status=${b?.status}, players=${(b?.players||[]).length}`);
      // 상태/턴
      $('#battleStatus').textContent=b?.status||'-';
      const ct=b?.currentTurn?.currentTeam || b?.currentTeam || '-';
      $('#currentTeam').textContent=ct;
      if(!firstTeamMemo && (b?.status==='active') && (ct==='A' || ct==='B')) firstTeamMemo=ct;
      $('#firstTeam').textContent=firstTeamMemo||'-';
      $('#roundNum').textContent=b?.currentTurn?.turnNumber || b?.turn?.round || 1;

      // 팀 표시
      renderTeams(b);

      // 현재 차례 초상화
      const list=(b.players||[]).filter(p=>p.team===ct && (p.hp||0)>0);
      const target = list[0] || (b.players||[])[0];
      $('#turnName').textContent = target?.name||'-';
      $('#turnHpText').textContent = `${target?.hp||0}/${target?.maxHp||100}`;
      $('#turnHpBar').style.width = `${Math.max(0, Math.min(100, (target?.hp||0)/(target?.maxHp||100)*100))}%`;
      $('#turnPortrait').src = target?.avatar||'';
    }

    function renderTeams(b){
      const A=(b.players||[]).filter(p=> (p.team||'A')==='A');
      const B=(b.players||[]).filter(p=> (p.team||'A')==='B');
      fill('#teamA',A); fill('#teamB',B);
    }
    function fill(sel, arr){
      const box=$(sel); box.innerHTML='';
      if(arr.length===0){ box.appendChild(h(`<div class="hint">없음</div>`)); return; }
      for(const p of arr){
        const el=h(`<div class="mini">
          <img src="${escapeHtml(p.avatar||'')}" alt="${escapeHtml(p.name||'-')}"/>
          <div style="flex:1">
            <div style="font-weight:800">${escapeHtml(p.name||'-')}</div>
            <div class="stat"><span>HP</span><span>${p.hp||0}/${p.maxHp||100}</span></div>
            <div class="hpbar"><span style="width:${Math.max(0, Math.min(100, (p.hp||0)/(p.maxHp||100)*100))}%"></span></div>
          </div>
          <div class="chip">${p.team}팀</div>
        </div>`);
        box.appendChild(el);
      }
      addLog(`팀 갱신(${sel}): ${arr.length}명`);
    }

    // 응원 버튼
    document.addEventListener('click',(e)=>{
      const btn = e.target.closest('[data-cheer]');
      if(!btn) return;
      const msg = btn.getAttribute('data-cheer');
      const nm = (nameInput.value||'관전자');
      if(!socket || !battle) return;
      socket.emit('chatMessage',{ battleId:battle.id, name:nm, role:'spectator', message:`[응원] ${msg}` });
      addLog(`응원 전송 <${nm}>: ${msg}`);
    });

    function pushChat(nm, msg){
      const box=$('#chatBox');
      const el=h(`<div class="item"><span class="ts">${ts()}</span><b>${escapeHtml(nm)}</b>: ${escapeHtml(msg)}</div>`);
      box.appendChild(el); box.scrollTop=box.scrollHeight;
    }
    $('#btnSendChat').onclick = sendChat;
    $('#chatInput').addEventListener('keydown',(e)=>{ if(e.key==='Enter') sendChat(); });
    function sendChat(){
      const msg = $('#chatInput').value.trim(); if(!msg) return;
      const nm = (nameInput.value||'관전자');
      if(!socket || !battle) return;
      socket.emit('chatMessage',{ battleId:battle.id, name:nm, message:msg });
      $('#chatInput').value='';
      addLog(`채팅 전송 <${nm}>: ${msg}`,'chat');
    }

    // 최초 진입 시 URL만 채움(자동 로그인 금지)
    (function fillFromUrl(){
      const u=new URL(location.href);
      if(u.searchParams.get('battle')) battleIdInput.value=u.searchParams.get('battle');
      if(u.searchParams.get('name'))   nameInput.value=u.searchParams.get('name');
      const tk=u.searchParams.get('otp')||u.searchParams.get('token')||u.searchParams.get('password');
      if(tk) tokenInput.value=tk;
      addLog('초기: URL 파라미터 로드(자동 입장 안 함).');
      ensureSocket();
    })();
  </script>
</body>
</html>
