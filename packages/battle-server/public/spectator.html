<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>PYXIS - 관전자</title>
<script src="/socket.io/socket.io.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#0e0e0e; --bg2:#141414;
    --glass-1:rgba(0,0,0,.7); --glass-2:rgba(0,0,0,.5);
    --border:rgba(220,199,162,.3);
    --text:#F8F9FA; --muted:#A9AFB6;
    --gold:#DCC7A2; --gold2:#E6D2A8;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --shadow:0 10px 30px rgba(0,0,0,.45);
    --team-a-color:#8b5757; --team-b-color:#5d6b8d;
    --result-bg:#DCC7A2; --result-text:#000;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:linear-gradient(135deg,#000813,#001122);color:var(--text);font-family:system-ui,-apple-system,sans-serif;min-height:100vh;padding:8px}
  .container{max-width:1400px;margin:0 auto}
  .header{text-align:center;padding:16px;font-family:Cinzel,serif;color:var(--gold);font-size:24px;letter-spacing:.1em}
  .main-grid{display:grid;gap:12px;grid-template-columns:1fr;}
  @media (min-width:768px){ .main-grid{ grid-template-columns:1fr 2fr 1fr; } }

  .team-container{background:var(--glass-1);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:var(--shadow);height:fit-content}
  .team-title{font-family:Cinzel,serif;color:var(--gold);font-weight:700;letter-spacing:.08em;margin-bottom:12px;font-size:16px;text-align:center}
  .card{background:var(--glass-1);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:var(--shadow)}
  .title{font-family:Cinzel,serif;color:var(--gold);font-weight:700;letter-spacing:.08em;margin-bottom:8px;font-size:14px}

  .player-card{background:var(--glass-2);border:1px solid var(--border);border-radius:8px;padding:8px;margin-bottom:8px;display:flex;align-items:center;gap:8px}
  .player-card.dead{opacity:.5}
  .player-avatar{width:32px;height:32px;border-radius:6px;object-fit:cover;border:1px solid var(--gold);background:#000}
  .player-info{flex:1;min-width:0}
  .player-name{font-size:12px;font-weight:600;color:var(--gold);margin-bottom:2px}
  .hp{height:6px;background:#0b0b0b;border:1px solid var(--border);border-radius:999px;overflow:hidden;margin-bottom:2px}
  .hp>span{display:block;height:100%;background:linear-gradient(90deg,#4ade80,#22c55e);transition:width .3s}
  .hp-text{font-size:10px;color:var(--muted);margin-bottom:2px}
  .stats{font-size:10px;color:var(--muted)}
  .ready-status{font-size:9px;color:var(--gold);margin-top:2px}

  .battle-main{text-align:center}
  .current-player-info{background:var(--glass-2);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px}
  .current-avatar{
    width:100%; max-width:420px; height:420px; margin:0 auto 12px auto;
    display:block; object-fit:cover; border:4px solid var(--gold); border-radius:16px; background:#000;
  }
  .turn-info{font-size:16px;margin-bottom:8px;color:var(--text);font-weight:600}
  .timer-display{color:var(--gold);font-size:32px;margin-bottom:8px;font-weight:700}
  .timer-seconds{font-size:14px;color:var(--muted);margin-bottom:16px}

  .cheer-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .cheer-btn{
    background:transparent;color:var(--gold);border:2px solid var(--gold);
    padding:10px 6px;border-radius:8px;font-size:12px;cursor:pointer;transition:all .2s;font-weight:700
  }
  .cheer-btn:hover{background:var(--gold);color:#000}

  .logs-section, .chat-section{
    height:400px;overflow-y:auto;background:var(--glass-2);
    border:1px solid var(--border);padding:8px;border-radius:8px;margin-bottom:8px
  }
  .log-item{margin-bottom:4px;font-size:11px;line-height:1.4;padding:2px 4px;border-radius:4px}
  .log-time{color:var(--muted)}
  .chat-item{margin-bottom:4px;font-size:11px}
  .chat-name{color:var(--gold);font-weight:700}
  .log-team-a{background-color:var(--team-a-color);color:var(--text)}
  .log-team-b{background-color:var(--team-b-color);color:var(--text)}
  .log-result{background-color:var(--result-bg);color:var(--result-text)}
  .log-notice{background-color:var(--glass-1);color:var(--gold)}
  .log-error{background-color:#000;color:var(--gold)}
  .log-system{background-color:transparent;color:var(--muted)}

  .name-overlay{position:fixed;inset:0;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;z-index:10000}
  .name-box{background:var(--glass-1);border:2px solid var(--gold);border-radius:12px;padding:24px;text-align:center;max-width:400px;width:90%}
  .name-box h2{color:var(--gold);margin-bottom:12px;font-family:Cinzel,serif}
  .name-input{width:100%;background:var(--glass-2);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:8px;font-size:13px;margin-bottom:12px}
  .enter-btn{background:var(--gold);color:#000;border:none;padding:10px 16px;border-radius:8px;font-size:13px;cursor:pointer;font-weight:700;width:100%}
  .enter-btn:hover{background:var(--gold2)}

  @media (max-width:767px){
    .main-grid{grid-template-columns:1fr}
    .cheer-grid{grid-template-columns:1fr}
    .current-avatar{height:360px}
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">PYXIS 전투 시스템</div>

  <div class="main-grid">
    <!-- 좌측: A팀 + 로그 -->
    <div>
      <div class="team-container" style="margin-bottom:12px">
        <div class="team-title">A팀</div>
        <div id="teamA"></div>
      </div>

      <div class="card">
        <div class="title">실시간 로그</div>
        <div class="logs-section" id="logPanel"></div>
      </div>
    </div>

    <!-- 중앙: 현재 전투 + 응원 -->
    <div>
      <div class="card battle-main">
        <div class="current-player-info">
          <img id="currentPortrait" class="current-avatar" alt="현재 플레이어" onerror="this.style.background='#000';this.removeAttribute('src')"/>
          <div id="turnInfo" class="turn-info">대기 중...</div>
          <div id="timerDisplay" class="timer-display">0:00</div>
          <div id="timerSeconds" class="timer-seconds">0초</div>
        </div>
      </div>

      <div class="card">
        <div class="title" style="text-align:center">응원하기</div>
        <div class="cheer-grid">
          <button class="cheer-btn" data-msg="멋지다!">멋지다!</button>
          <button class="cheer-btn" data-msg="이겨라!">이겨라!</button>
          <button class="cheer-btn" data-msg="살아서 돌아와!">살아서 돌아와!</button>
          <button class="cheer-btn" data-msg="화이팅!">화이팅!</button>
          <button class="cheer-btn" data-msg="죽으면 나한테 죽어!">죽으면 나한테 죽어!</button>
          <button class="cheer-btn" data-msg="힘내요!">힘내요!</button>
        </div>
      </div>
    </div>

    <!-- 우측: B팀 + 채팅뷰(입력 없음) -->
    <div>
      <div class="team-container" style="margin-bottom:12px">
        <div class="team-title">B팀</div>
        <div id="teamB"></div>
      </div>

      <div class="card">
        <div class="title">채팅</div>
        <div class="chat-section" id="chatPanel"></div>
      </div>
    </div>
  </div>
</div>

<!-- 이름 입력 오버레이 -->
<div id="nameOverlay" class="name-overlay">
  <div class="name-box">
    <h2>관전자 이름 입력</h2>
    <input id="nameInput" type="text" maxlength="20" placeholder="관전자 이름" class="name-input"/>
    <button id="enterBtn" class="enter-btn" type="button">입장하기</button>
  </div>
</div>

<script>
(()=> {
  const qs = new URLSearchParams(location.search);
  const battleId = qs.get('battle');
  if (!battleId) { alert('올바르지 않은 URL입니다'); return; }

  const socket = io();
  const logPanel  = document.getElementById('logPanel');
  const chatPanel = document.getElementById('chatPanel');

  let spectatorName = '';
  let battle = null;
  let currentPhase = null;
  const bufferedResolutionLogs = [];

  const esc = s => s ? s.replace(/</g,'&lt;').replace(/>/g,'&gt;') : '';

  function classForLog(type, message){
    if (type === 'teamA') return 'log-team-a';
    if (type === 'teamB') return 'log-team-b';
    if (type === 'result') return 'log-result';
    if (type === 'notice') return 'log-notice';
    if (type === 'error')  return 'log-error';
    if (type === 'system') return 'log-system';
    const m = message||'';
    if (/(^|\s)A[1-4]\b|A팀|=== A팀/.test(m)) return 'log-team-a';
    if (/(^|\s)B[1-4]\b|B팀|=== B팀/.test(m)) return 'log-team-b';
    if (/라운드 해석|승리|결과|===/.test(m)) return 'log-result';
    return 'log-system';
  }

  function stripDetail(msg){
    return msg
      .replace(/\s*\(피해\s*[\d]+\)\s*→\s*HP\s*[\d]+/g,'')
      .replace(/\s*\(회복\s*[\d]+\)\s*→\s*HP\s*[\d]+/g,'')
      .replace(/\s*→\s*HP\s*[\d]+/g,'');
  }

  function pushLog(text, cls='log-system', ts){
    const time = new Date(ts||Date.now()).toLocaleTimeString('ko-KR',{hour12:false});
    const div = document.createElement('div');
    div.className = `log-item ${cls}`;
    div.innerHTML = `<span class="log-time">[${time}]</span> ${esc(text)}`;
    logPanel.appendChild(div);
    logPanel.scrollTop = logPanel.scrollHeight;
  }

  function addLog({ts, type, message}){
    if (!message) return;
    const phase = battle?.phase || currentPhase;
    const isSelect = (phase === 'A_select' || phase === 'B_select');
    const hasDetail = /(피해\s*\d+|회복\s*\d+|→\s*HP\s*\d+)/.test(message);

    if (isSelect && hasDetail) {
      pushLog(stripDetail(message), classForLog(type, message), ts);
      bufferedResolutionLogs.push({ ts, text: message });
      return;
    }
    if (message.includes('라운드 해석')) {
      pushLog('라운드 해석', 'log-result', ts);
      bufferedResolutionLogs.forEach(x => pushLog(x.text, 'log-result', x.ts));
      bufferedResolutionLogs.length = 0;
      return;
    }
    pushLog(message, classForLog(type, message), ts);
  }

  function addChat({name, message}){
    if (!name || !message) return;
    const div = document.createElement('div');
    div.className = 'chat-item';
    div.innerHTML = `<span class="chat-name">${esc(name)}</span>: ${esc(message)}`;
    chatPanel.appendChild(div);
    chatPanel.scrollTop = chatPanel.scrollHeight;
    while (chatPanel.children.length > 300) chatPanel.removeChild(chatPanel.firstChild);
  }

  function renderTeams(){
    if(!battle?.players) return;
    const teamA = battle.players.filter(p=>p.team==='A');
    const teamB = battle.players.filter(p=>p.team==='B');
    const render = (list, id)=>{
      let html = '';
      list.forEach(p=>{
        const hpPct = Math.max(0, p.hp/(p.maxHp||100)*100);
        const ready = p.ready ? '준비완료' : '대기중';
        html += `
        <div class="player-card ${p.hp>0?'':'dead'}">
          <img src="${p.avatar||''}" class="player-avatar" alt="${esc(p.name)}"
               onerror="this.style.background='#000';this.removeAttribute('src')"/>
          <div class="player-info">
            <div class="player-name">${esc(p.name)}</div>
            <div class="hp"><span style="width:${hpPct}%"></span></div>
            <div class="hp-text">HP ${p.hp}/${p.maxHp||100}</div>
            <div class="stats">공${p.stats?.attack||0} 방${p.stats?.defense||0} 민${p.stats?.agility||0} 행${p.stats?.luck||0}</div>
            <div class="ready-status">${ready}</div>
          </div>
        </div>`;
      });
      document.getElementById(id).innerHTML = html;
    };
    render(teamA,'teamA');
    render(teamB,'teamB');
  }

  function renderCenter(){
    const turn = battle?.currentTurn || {};
    const current = turn.currentPlayer;
    const img = document.getElementById('currentPortrait');
    const info = document.getElementById('turnInfo');

    const phaseText =
      battle?.phase === 'A_select' ? 'A팀 선택 중' :
      battle?.phase === 'B_select' ? 'B팀 선택 중' :
      battle?.phase === 'resolve'  ? '라운드 해석 중' :
      battle?.phase === 'inter'    ? '다음 라운드 대기' : '대기중';

    if (current && current.name) {
      info.textContent = `${phaseText} - ${current.name} 차례`;
      if (current.avatar) { img.src = current.avatar; img.style.background='#000'; }
      else { img.removeAttribute('src'); img.style.background='#000'; }
    } else {
      info.textContent = phaseText;
      img.removeAttribute('src'); img.style.background='#000';
    }

    const tl = turn.timeLeftSec||0;
    const mm = Math.floor(tl/60);
    const ss = String(tl%60).padStart(2,'0');
    document.getElementById('timerDisplay').textContent = `${mm}:${ss}`;
    document.getElementById('timerSeconds').textContent = `${tl}초`;
  }

  function renderAll(){
    if (battle?.phase && battle.phase !== currentPhase) {
      currentPhase = battle.phase;
      if (currentPhase === 'resolve' && bufferedResolutionLogs.length) {
        pushLog('라운드 해석', 'log-result');
        bufferedResolutionLogs.forEach(x => pushLog(x.text, 'log-result', x.ts));
        bufferedResolutionLogs.length = 0;
      }
    }
    renderCenter();
    renderTeams();
  }

  // 이름 입력 → 채팅 발송용 이름만 세팅 (관전자 인증 불필요)
  document.getElementById('enterBtn').onclick = ()=>{
    const v = document.getElementById('nameInput').value.trim();
    if (!v) { alert('이름을 입력하세요'); return; }
    spectatorName = v;
    document.getElementById('nameOverlay').style.display = 'none';
  };
  document.getElementById('nameInput').addEventListener('keydown', (e)=>{
    if (e.key==='Enter'){ e.preventDefault(); document.getElementById('enterBtn').click(); }
  });

  // 응원 버튼 → 일반 채팅 채널로 송출(서버가 중계만 하면 됨)
  document.addEventListener('click',(e)=>{
    const b = e.target.closest('.cheer-btn');
    if (!b) return;
    const msg = b.getAttribute('data-msg');
    socket.emit('chatMessage', { battleId, name: spectatorName || '관전자', message: msg, type:'cheer' });
  });

  // 소켓
  socket.on('connect', ()=>{ socket.emit('join', { battleId }); });
  const onSnap = (snap)=>{ battle = snap; renderAll(); };
  socket.on('battle:update', onSnap);
  socket.on('battle:log', addLog);
  socket.on('chatMessage', addChat);

  document.getElementById('nameInput').focus();
})();
</script>
</body>
</html>
