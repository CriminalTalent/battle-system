<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PYXIS 관전</title>
  <style>
    :root{
      --deep-navy:#0B1117; --dark-navy:#131B24; --mid-navy:#1A242F; --light-navy:#2A3441;
      --gold-1:#DCC7A2; --gold-2:#D4BA8D; --gold-bright:#E6D5B7; --gold-shimmer:#F2E8D4;
      --border:#2A3441; --border-light:#3A4451; --border-subtle:#1F2937; --border-gold:#DCC7A2;
      --glass-1:rgba(26,36,47,.65); --glass-2:rgba(26,36,47,.85); --glass-3:rgba(26,36,47,.95);
      --blur-light:blur(4px); --blur-medium:blur(8px); --blur-heavy:blur(12px);
      --text:#E5E7EB; --text-dim:#9CA3AF; --text-muted:#6B7280; --text-accent:#DCC7A2;
      --success:#10B981; --warning:#F59E0B; --danger:#EF4444; --info:#3B82F6;
      --shadow:0 4px 16px rgba(0,0,0,.25); --shadow-soft:0 2px 8px rgba(0,0,0,.15);
      --radius:12px; --radius-sm:8px; --radius-small:6px; --transition:.2s cubic-bezier(.4,0,.2,1);
    }
    body{ margin:0; font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto; background:linear-gradient(135deg,var(--deep-navy) 0%,var(--dark-navy) 100%); color:var(--text); min-height:100vh; }
    *{ box-sizing:border-box; }

    .header{
      background:var(--glass-3); border-bottom:var(--border);
      backdrop-filter:var(--blur-medium); position:sticky; top:0; z-index:1000;
      padding:16px 0;
    }
    .header-container{ max-width:1200px; margin:0 auto; padding:0 20px; display:flex; align-items:center; justify-content:center; }
    .pyxis-logo{ font-family:Cinzel,serif; font-size:28px; font-weight:700; color:var(--gold-bright); letter-spacing:.08em; }
    .subtitle{ font-size:14px; color:var(--text-dim); margin-top:4px; text-align:center; }

    /* 인증 화면 */
    .auth-view{
      display:flex; align-items:center; justify-content:center; min-height:calc(100vh - 80px);
    }
    .auth-card{
      background:var(--glass-2); border:var(--border-light); border-radius:var(--radius);
      padding:32px; box-shadow:var(--shadow-soft); max-width:400px; width:90%;
      backdrop-filter:var(--blur-medium);
    }
    .auth-title{
      font-family:Cinzel,serif; font-size:20px; font-weight:600; color:var(--gold-bright);
      text-align:center; margin-bottom:24px;
    }
    .form-group{ margin-bottom:20px; }
    .form-label{ display:block; font-size:12px; font-weight:600; color:var(--text-muted); margin-bottom:8px; }
    .form-input{
      width:100%; background:var(--glass-1); border:var(--border); border-radius:10px;
      color:var(--text); font-size:14px; padding:12px 16px; outline:none;
      transition:border-color .2s, box-shadow .2s;
    }
    .form-input:focus{ border-color:var(--gold-1); box-shadow:0 0 0 2px rgba(212,183,126,.16); }
    .btn{
      background:linear-gradient(135deg,var(--gold-1), var(--gold-2));
      color:#0B1117; border:1px solid var(--gold-1); border-radius:10px;
      font-weight:700; font-size:14px; letter-spacing:.04em; padding:12px 16px; cursor:pointer;
      box-shadow:0 2px 8px rgba(212,183,126,.22); transition:all var(--transition);
      outline:none; text-transform:uppercase; width:100%;
    }
    .btn:hover{ background:linear-gradient(135deg,var(--gold-bright),var(--gold-shimmer)); box-shadow:0 4px 12px rgba(212,183,126,.35); transform:translateY(-1px); }
    .btn:disabled{ background:rgba(107,114,128,.3); color:rgba(255,255,255,.4); box-shadow:none; transform:none; cursor:not-allowed; }

    /* 메인 UI */
    .main-container{ max-width:1200px; margin:0 auto; padding:20px; display:none; }
    .main-container.show{ display:block; }

    .status-alert{
      background:var(--glass-2); border:var(--border-light); border-radius:var(--radius-small);
      padding:16px; margin-bottom:20px; text-align:center;
    }
    .status-alert.waiting{ border-color:var(--warning); background:rgba(245,158,11,.1); }
    .status-alert.active{ border-color:var(--success); background:rgba(16,185,129,.1); }
    .status-alert.ended{ border-color:var(--text-muted); background:rgba(107,114,128,.1); }
    .alert-title{ font-family:Cinzel,serif; font-size:16px; font-weight:600; margin-bottom:4px; }
    .alert-message{ font-size:13px; color:var(--text-dim); }

    .game-grid{
      display:grid; grid-template-columns:1fr 1fr 1fr; gap:20px; align-items:start;
    }

    .card{
      background:var(--glass-2); border:var(--border-light); border-radius:var(--radius);
      box-shadow:var(--shadow-soft); padding:20px; backdrop-filter:var(--blur-medium);
      transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .card:hover{ transform:translateY(-1px); box-shadow:var(--shadow); border-color:var(--gold-2); }
    .card-title{
      font-family:Cinzel,serif; font-weight:700; color:var(--gold-bright);
      border-bottom:var(--border-subtle); padding-bottom:12px; margin-bottom:16px; font-size:16px;
    }

    .team-info{ display:flex; flex-direction:column; gap:16px; }
    .team-card{
      background:var(--glass-1); border:var(--border); border-radius:var(--radius-sm);
      padding:16px;
    }
    .team-name{
      font-family:Cinzel,serif; font-weight:600; color:var(--gold-bright);
      margin-bottom:12px; text-align:center; font-size:14px;
    }

    .team-roster{ display:flex; flex-direction:column; gap:8px; }
    .player-item{
      background:var(--glass-1); border:var(--border-subtle); border-radius:8px;
      padding:12px; display:flex; align-items:center; gap:12px;
    }
    .player-avatar{
      width:40px; height:40px; border-radius:50%; background:var(--gold-1);
      display:flex; align-items:center; justify-content:center; font-weight:700;
      color:var(--deep-navy); font-size:14px; flex-shrink:0;
    }
    .player-details{ flex:1; }
    .player-name{ font-weight:600; margin-bottom:2px; }
    .player-stats{ font-size:11px; color:var(--text-muted); }
    .player-hp{
      width:60px; text-align:right; font-size:12px; font-weight:600;
      color:var(--success);
    }

    .spectator-info{
      background:var(--glass-1); border:var(--border); border-radius:var(--radius-sm);
      padding:16px; text-align:center;
    }
    .spectator-title{
      font-family:Cinzel,serif; font-weight:600; color:var(--gold-bright);
      margin-bottom:8px;
    }
    .spectator-message{ font-size:12px; color:var(--text-dim); }

    .cheer-buttons{
      display:grid; grid-template-columns:repeat(2, 1fr); gap:8px; margin-bottom:12px;
    }
    .cheer-btn{
      background:var(--glass-1); border:var(--border); border-radius:8px;
      padding:8px 12px; cursor:pointer; transition:all var(--transition);
      font-size:12px; font-weight:600; text-align:center;
    }
    .cheer-btn:hover{
      background:var(--glass-2); border-color:var(--gold-2);
      transform:translateY(-1px);
    }

    .log-container{
      height:300px; overflow-y:auto; background:var(--glass-1);
      border:var(--border); border-radius:var(--radius-sm); padding:12px;
    }
    .log-entry{
      padding:6px 0; border-bottom:1px dashed var(--border-subtle);
      font-size:12px; line-height:1.4;
    }
    .log-entry:last-child{ border-bottom:none; }
    .log-time{ color:var(--text-muted); margin-right:8px; }
    .log-system{ color:var(--info); }
    .log-battle{ color:var(--text); }
    .log-chat{ color:var(--gold-1); }

    .chat-container{
      height:200px; overflow-y:auto; background:var(--glass-1);
      border:var(--border); border-radius:var(--radius-sm); padding:12px;
      margin-bottom:12px;
    }
    .chat-entry{
      padding:6px 0; border-bottom:1px dashed var(--border-subtle);
      font-size:12px; line-height:1.4;
    }
    .chat-entry:last-child{ border-bottom:none; }
    .chat-time{ color:var(--text-muted); margin-right:8px; }
    .chat-name{ font-weight:600; color:var(--gold-1); margin-right:4px; }

    .hidden{ display:none !important; }

    /* 반응형 */
    @media (max-width:1200px){ 
      .game-grid{ grid-template-columns:1fr 1fr; gap:16px; } 
      .team-info{ grid-column:1 / -1; display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    }
    @media (max-width:768px){
      .game-grid{ grid-template-columns:1fr; gap:16px; }
      .team-info{ grid-column:1; display:flex; flex-direction:column; }
      .main-container{ padding:16px 12px; }
      .card{ padding:16px; }
      .cheer-buttons{ grid-template-columns:1fr; }
    }

    .chat-container::-webkit-scrollbar, .log-container::-webkit-scrollbar{ width:6px; }
    .chat-container::-webkit-scrollbar-track, .log-container::-webkit-scrollbar-track{ background:var(--glass-1); border-radius:3px; }
    .chat-container::-webkit-scrollbar-thumb, .log-container::-webkit-scrollbar-thumb{ background:linear-gradient(to bottom,var(--gold-1),var(--gold-2)); border-radius:3px; }
  </style>
</head>
<body>
  <script src="/socket.io/socket.io.js"></script>

  <!-- 헤더 -->
  <header class="header">
    <div class="header-container">
      <div class="pyxis-logo">PYXIS</div>
      <div class="subtitle">전투 시스템</div>
    </div>
  </header>

  <!-- 인증 화면 -->
  <div class="auth-view" id="authView">
    <div class="auth-card">
      <div class="auth-title">관전자 인증</div>
      <div class="form-group">
        <label class="form-label">비밀번호</label>
        <input type="password" class="form-input" id="tokenInput" placeholder="관리자가 제공한 비밀번호를 입력하세요" maxlength="40">
      </div>
      <button class="btn" id="loginBtn">관전 시작</button>
      <div id="authError" class="hidden" style="color:var(--danger); margin-top:16px; font-size:13px;"></div>
    </div>
  </div>

  <!-- 메인 UI -->
  <div class="main-container" id="gameView">
    <div class="status-alert waiting" id="statusAlert">
      <div class="alert-title">전투 대기중</div>
      <div class="alert-message">관리자가 전투를 시작할 때까지 대기해주세요.</div>
    </div>

    <div class="game-grid">
      <!-- 좌: 팀 정보 -->
      <div class="team-info">
        <div class="card">
          <div class="card-title">불사조 기사단</div>
          <div class="team-card">
            <div class="team-name">A팀</div>
            <div class="team-roster" id="teamA-roster">
              <div style="text-align:center;color:var(--text-muted);padding:40px 0;font-size:12px">팀원이 없습니다</div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">죽음을 먹는 자들</div>
          <div class="team-card">
            <div class="team-name">B팀</div>
            <div class="team-roster" id="teamB-roster">
              <div style="text-align:center;color:var(--text-muted);padding:40px 0;font-size:12px">팀원이 없습니다</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 중: 관전자 응원 -->
      <div class="card">
        <div class="card-title">관전자 응원</div>
        <div class="spectator-info">
          <div class="spectator-title">전투를 관전하고 있습니다</div>
          <div class="spectator-message">아래 버튼으로 전투 참가자들을 응원해보세요!</div>
        </div>

        <div class="cheer-buttons">
          <button class="cheer-btn" data-cheer="멋지다!">멋지다!</button>
          <button class="cheer-btn" data-cheer="이겨라!">이겨라!</button>
          <button class="cheer-btn" data-cheer="살아서 돌아와!">살아서 돌아와!</button>
          <button class="cheer-btn" data-cheer="화이팅!">화이팅!</button>
          <button class="cheer-btn" data-cheer="죽으면 나한테 죽어!">죽으면 나한테 죽어!</button>
          <button class="cheer-btn" data-cheer="힘내요!">힘내요!</button>
        </div>

        <div class="card-title" style="margin-top:20px; margin-bottom:16px; padding-bottom:8px;">전투 로그</div>
        <div class="log-container" id="battleLog"></div>
      </div>

      <!-- 우: 채팅 -->
      <div class="card">
        <div class="card-title">채팅</div>
        <div class="chat-container" id="chatContainer"></div>
        <div style="font-size:11px; color:var(--text-muted); text-align:center; padding:8px;">
          관전자는 채팅을 볼 수만 있습니다
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    'use strict';

    // 전역 변수
    let socket = null;
    let battleId = null;
    let battle = null;

    // DOM 요소
    const authView = document.getElementById('authView');
    const gameView = document.getElementById('gameView');
    const tokenInput = document.getElementById('tokenInput');
    const loginBtn = document.getElementById('loginBtn');
    const authError = document.getElementById('authError');
    const statusAlert = document.getElementById('statusAlert');
    const teamARoster = document.getElementById('teamA-roster');
    const teamBRoster = document.getElementById('teamB-roster');
    const battleLog = document.getElementById('battleLog');
    const chatContainer = document.getElementById('chatContainer');

    // URL 파라미터에서 정보 추출
    function extractParams(){
      const params = new URLSearchParams(window.location.search);
      battleId = params.get('battle');
      const token = params.get('token') || params.get('otp');
      
      if(token){
        tokenInput.value = token;
      }
      
      if(battleId && token){
        authenticate();
      }
    }

    // 인증
    async function authenticate(){
      const token = tokenInput.value.trim();
      if(!token){
        showError('비밀번호를 입력해주세요.');
        return;
      }

      if(!battleId){
        showError('유효한 전투 ID가 필요합니다.');
        return;
      }

      loginBtn.disabled = true;
      loginBtn.textContent = '인증중...';
      hideError();

      try{
        await connectSocket();
        socket.emit('spectatorAuth', { battleId, token }, (result) => {
          if(result && result.ok){
            battle = result.battle;
            showGame();
            updateUI();
          } else {
            showError(result?.error || '인증 실패');
          }
          loginBtn.disabled = false;
          loginBtn.textContent = '관전 시작';
        });
      } catch(e) {
        showError('연결 실패: ' + (e.message || e));
        loginBtn.disabled = false;
        loginBtn.textContent = '관전 시작';
      }
    }

    // 소켓 연결
    function connectSocket(){
      return new Promise((resolve, reject) => {
        if(socket){
          socket.disconnect();
        }

        socket = io(window.location.origin, {
          path: '/socket.io',
          transports: ['websocket', 'polling'],
          timeout: 10000
        });

        socket.on('connect', () => {
          resolve();
        });

        socket.on('connect_error', (error) => {
          reject(error);
        });

        socket.on('authSuccess', (result) => {
          if(result && result.battle){
            battle = result.battle;
            showGame();
            updateUI();
          }
        });

        socket.on('authError', (error) => {
          showError(error?.error || '인증 실패');
        });

        socket.on('battleUpdate', (updatedBattle) => {
          battle = updatedBattle;
          updateUI();
        });

        socket.on('battle:update', (updatedBattle) => {
          battle = updatedBattle;
          updateUI();
        });

        socket.on('battle:log', (entry) => {
          addLogEntry(entry);
        });

        socket.on('chatMessage', (message) => {
          addChatMessage(message);
        });

        socket.on('chat:message', (message) => {
          addChatMessage(message);
        });
      });
    }

    // UI 표시/숨김
    function showGame(){
      authView.style.display = 'none';
      gameView.classList.add('show');
    }

    function showError(message){
      authError.textContent = message;
      authError.classList.remove('hidden');
    }

    function hideError(){
      authError.classList.add('hidden');
    }

    // UI 업데이트
    function updateUI(){
      if(!battle) return;

      // 상태 알림 업데이트
      updateStatusAlert();

      // 팀 로스터 업데이트
      updateTeamRoster();
    }

    function updateStatusAlert(){
      const status = battle.status || 'waiting';
      statusAlert.className = `status-alert ${status}`;
      
      const title = statusAlert.querySelector('.alert-title');
      const message = statusAlert.querySelector('.alert-message');

      switch(status){
        case 'waiting':
          title.textContent = '전투 대기중';
          message.textContent = '관리자가 전투를 시작할 때까지 대기해주세요.';
          break;
        case 'active':
          title.textContent = '전투 진행중';
          message.textContent = '치열한 전투가 벌어지고 있습니다!';
          break;
        case 'paused':
          title.textContent = '전투 일시정지';
          message.textContent = '전투가 일시정지되었습니다.';
          break;
        case 'ended':
          title.textContent = '전투 종료';
          message.textContent = '전투가 종료되었습니다.';
          break;
      }
    }

    function updateTeamRoster(){
      const players = battle.players || [];
      const teamA = players.filter(p => p.team === 'A');
      const teamB = players.filter(p => p.team === 'B');

      renderTeam(teamARoster, teamA);
      renderTeam(teamBRoster, teamB);
    }

    function renderTeam(container, players){
      if(players.length === 0){
        container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:40px 0;font-size:12px">팀원이 없습니다</div>';
        return;
      }

      container.innerHTML = players.map(player => {
        const initials = (player.name || 'U').trim().slice(0, 2).toUpperCase();
        const stats = player.stats || {};
        const statsText = `공${stats.attack||1} 방${stats.defense||1} 민${stats.agility||1} 행${stats.luck||1}`;
        
        return `
          <div class="player-item">
            <div class="player-avatar">${initials}</div>
            <div class="player-details">
              <div class="player-name">${player.name || '익명'}</div>
              <div class="player-stats">${statsText}</div>
            </div>
            <div class="player-hp">${player.hp || 100}/100</div>
          </div>
        `;
      }).join('');
    }

    // 로그 추가
    function addLogEntry(entry){
      const time = new Date(entry.timestamp || Date.now()).toLocaleTimeString();
      const div = document.createElement('div');
      div.className = `log-entry log-${entry.type || 'system'}`;
      div.innerHTML = `<span class="log-time">${time}</span>${entry.message || ''}`;
      battleLog.appendChild(div);
      battleLog.scrollTop = battleLog.scrollHeight;
    }

    // 채팅 추가
    function addChatMessage(message){
      const time = new Date(message.timestamp || Date.now()).toLocaleTimeString();
      const div = document.createElement('div');
      div.className = 'chat-entry';
      div.innerHTML = `<span class="chat-time">${time}</span><span class="chat-name">${message.name || '익명'}:</span>${message.message || ''}`;
      chatContainer.appendChild(div);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // 응원 버튼 이벤트
    function setupCheerButtons(){
      const cheerButtons = document.querySelectorAll('.cheer-btn');
      cheerButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const cheer = btn.dataset.cheer;
          if(socket && battleId){
            socket.emit('chatMessage', {
              battleId,
              message: cheer,
              name: '관전자',
              role: 'spectator'
            });
          }
        });
      });
    }

    // 이벤트 바인딩
    function bindEvents(){
      loginBtn.addEventListener('click', authenticate);
      tokenInput.addEventListener('keypress', (e) => {
        if(e.key === 'Enter'){
          authenticate();
        }
      });

      setupCheerButtons();
    }

    // 초기화
    function init(){
      bindEvents();
      extractParams();
    }

    // 시작
    init();
  })();
  </script>
</body>
</html>
