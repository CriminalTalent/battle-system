<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>PYXIS - 관전자</title>
  <script src="/socket.io/socket.io.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --black-1:#0a0a0a; --black-2:#121214; --black-3:#191a1d;
      --gold:#dcc7a2; --gold-2:#e6d2a8; --gold-3:#f0e6c8;
      --text:#f8f9fa; --muted:#aeb4bb; --border:rgba(255,255,255,0.14);
      --radius:14px; --shadow:0 10px 24px rgba(0,0,0,.45);
      --accent:#3498db;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{min-height:100vh;background:linear-gradient(135deg,var(--black-1),var(--black-2));color:var(--text);font-family:'Cinzel',serif}
    .wrap{max-width:1280px;margin:0 auto;padding:16px}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .brand{font-weight:800;letter-spacing:2px;color:var(--gold-2)}
    .grid{display:grid;grid-template-columns:320px minmax(0,1fr) 340px;gap:16px;align-items:start}
    @media (max-width:1100px){.grid{grid-template-columns:minmax(0,1fr)}}
    .card{background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);min-width:0}
    .head{padding:12px 14px;border-bottom:1px solid var(--border);color:var(--gold-2);font-weight:700}
    .body{padding:14px}
    /* form */
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .field{margin-bottom:10px}
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;text-transform:uppercase}
    .field input,.field select{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);
      background:var(--black-3);color:var(--text);appearance:none
    }
    select option{background:var(--black-3);color:var(--text)}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:10px;border:1px solid var(--border);font-weight:700;cursor:pointer}
    .btn-gold{background:linear-gradient(135deg,var(--gold),var(--gold-2));color:#111}
    .btn-dark{background:var(--black-3);color:var(--text)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    /* center portrait */
    .portrait{width:100%;aspect-ratio:16/10;max-height:420px;border-radius:16px;border:1px solid var(--border);background:#222 center/cover no-repeat;display:flex;align-items:flex-end;justify-content:space-between;gap:8px;padding:10px}
    .pill{background:rgba(0,0,0,.5);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px}
    /* lists */
    .team{display:grid;grid-template-columns:1fr;gap:8px}
    .unit{display:flex;gap:10px;align-items:center;border:1px solid var(--border);background:rgba(255,255,255,.05);border-radius:10px;padding:8px}
    .unit img{width:44px;height:44px;border-radius:10px;border:1px solid var(--border);object-fit:cover;background:#333}
    .u-meta{font-size:12px}
    .u-meta .name{font-weight:700}
    /* logs + cheer */
    .logbox{height:240px;overflow:auto;border:1px solid var(--border);background:var(--black-3);border-radius:10px;margin-top:8px}
    .log{padding:8px 10px;border-bottom:1px solid var(--border);font-size:12px;white-space:pre-wrap;word-break:break-word;overflow-wrap:anywhere}
    .log .t{color:var(--muted);font-size:10px;margin-right:6px}
    .cheers{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .toast{position:fixed;top:86px;right:20px;background:var(--black-3);border:1px solid var(--border);border-left:4px solid var(--accent);padding:12px 14px;border-radius:10px;transform:translateX(420px);transition:transform .25s ease;box-shadow:var(--shadow);z-index:999}
    .toast.show{transform:translateX(0)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <div class="brand">PYXIS</div>
      <div style="font-size:12px;color:var(--muted)">관전자 화면</div>
    </div>
    <div style="font-size:12px;color:var(--muted)"><span id="conn">연결 대기</span></div>
  </div>

  <!-- 인증 -->
  <section id="authCard" class="card" style="margin-bottom:12px">
    <div class="head">관전 입장</div>
    <div class="body">
      <div class="row">
        <div class="field">
          <label>전투 ID</label>
          <input id="battleId" placeholder="battle_xxxx"/>
        </div>
        <div class="field">
          <label>이름(필수)</label>
          <input id="spName" placeholder="관전자 이름"/>
        </div>
      </div>
      <div class="field">
        <label>비밀번호/토큰(선택)</label>
        <input id="spToken" placeholder="있다면 입력"/>
      </div>
      <button id="btnEnter" class="btn btn-gold" style="width:100%;margin-top:6px">관전 시작</button>
      <div style="margin-top:6px;color:var(--muted);font-size:12px">이름은 필수입니다. 자동 로그인은 사용하지 않습니다.</div>
    </div>
  </section>

  <section id="layout" style="display:none" class="grid">
    <!-- 좌: A팀 -->
    <div class="card">
      <div class="head">A팀</div>
      <div class="body">
        <div id="teamA" class="team"></div>
      </div>
    </div>

    <!-- 중: 초상화 + 선공/타이머 -->
    <div class="card">
      <div class="head">전투</div>
      <div class="body">
        <div id="portrait" class="portrait">
          <div id="firstTeam" class="pill">선공 팀: -</div>
          <div id="turnInfo" class="pill">대기 중</div>
        </div>

        <div style="margin:10px 0;color:var(--muted);font-size:12px" id="queueInfo">행동 대기열: -</div>
        <div style="color:var(--gold-2);margin-bottom:8px;font-weight:700">응원</div>
        <div class="cheers">
          <button class="btn btn-dark" data-msg="멋지다!">멋지다!</button>
          <button class="btn btn-dark" data-msg="이겨라!">이겨라!</button>
          <button class="btn btn-dark" data-msg="살아서 돌아와!">살아서 돌아와!</button>
          <button class="btn btn-dark" data-msg="화이팅!">화이팅!</button>
          <button class="btn btn-dark" data-msg="죽으면 나한테 죽어!">죽으면 나한테 죽어!</button>
          <button class="btn btn-dark" data-msg="힘내요!">힘내요!</button>
        </div>

        <div class="logbox" id="battleLog"></div>
      </div>
    </div>

    <!-- 우: B팀 -->
    <div class="card">
      <div class="head">B팀</div>
      <div class="body">
        <div id="teamB" class="team"></div>
      </div>
    </div>
  </section>
</div>

<div id="toast" class="toast"></div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const escapeHtml = s => String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  const authCard=$('#authCard'), layout=$('#layout');
  const battleIdInp=$('#battleId'), spNameInp=$('#spName'), spTokenInp=$('#spToken'), btnEnter=$('#btnEnter');
  const teamA=$('#teamA'), teamB=$('#teamB');
  const portrait=$('#portrait'), firstTeam=$('#firstTeam'), turnInfo=$('#turnInfo'), queueInfo=$('#queueInfo'), logbox=$('#battleLog');
  const toast=$('#toast'), conn=$('#conn');

  let socket=null, battle=null, spectatorName=''; let computedFirstTeam=null;

  const showToast=(m)=>{ toast.textContent=m; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),2200); };
  const tnow=()=> new Date().toLocaleTimeString('ko-KR',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const addLog=(msg)=>{ const el=document.createElement('div'); el.className='log'; el.innerHTML=`<span class="t">${tnow()}</span>${msg}`; logbox.appendChild(el); logbox.scrollTop=logbox.scrollHeight; };

  function connect(){
    socket = window.io ? window.io({ path:'/socket.io' }) : null;
    if(!socket){ showToast('소켓 초기화 실패'); return; }

    socket.on('connect', ()=>{ conn.textContent='연결됨'; });
    socket.on('disconnect', ()=>{ conn.textContent='연결 끊김'; addLog('서버 연결 끊김'); });

    const onUpdate = (data)=>{
      battle=data; render();
    };
    socket.on('battleUpdate', onUpdate);
    socket.on('battle:update', onUpdate);

    socket.on('chatMessage',(d)=> addLog(`[채팅] ${d.name||'익명'}: ${d.message||''}`));

    addLog('소켓 리스너 등록 완료');
  }

  function render(){
    if(!battle) return;
    const players = battle.players||[];
    const A = players.filter(p=>(p.team||'A')==='A');
    const B = players.filter(p=>(p.team||'A')==='B');

    teamA.innerHTML=''; teamB.innerHTML='';
    const unit = (p)=>{
      const d=document.createElement('div'); d.className='unit';
      d.innerHTML=`<img src="${p.avatar||''}" alt="${escapeHtml(p.name)}"/>
        <div class="u-meta"><div class="name">${escapeHtml(p.name)}</div>
        <div style="color:var(--muted)">HP ${p.hp}/${p.maxHp||100} · 공${p.stats?.attack} 방${p.stats?.defense} 민${p.stats?.agility} 행${p.stats?.luck}</div></div>`;
      return d;
    };
    A.forEach(p=>teamA.appendChild(unit(p)));
    B.forEach(p=>teamB.appendChild(unit(p)));

    // portrait: 현재 턴 캐릭터가 없으니 대표로 선공팀 첫 캐릭터 사용
    if(!computedFirstTeam && players.length){
      computedFirstTeam = computeFirstTeam(A,B);
      addLog(`선공 계산 완료: ${computedFirstTeam}팀`);
    }
    firstTeam.textContent = `선공 팀: ${computedFirstTeam||'-'}팀`;

    const rep = (computedFirstTeam==='B'? B[0]: A[0]) || players[0];
    if(rep?.avatar) portrait.style.backgroundImage = `url(${rep.avatar})`;
    const st = battle.status;
    turnInfo.textContent = st==='active' ? '진행 중' : st==='paused' ? '일시정지' : st==='ended' ? '종료' : '대기 중';
    queueInfo.textContent = `행동 대기열: ${players.map(p=>p.name).join(' · ') || '-'}`;
  }

  function computeFirstTeam(A,B){
    const sum = arr=> arr.reduce((t,p)=> t + (parseInt(p.stats?.agility||0)||0),0);
    function roll(){ return 1 + Math.floor(Math.random()*20); }
    let a=sum(A), b=sum(B), ra, rb;
    do{ ra=roll(); rb=roll(); } while(a+ra===b+rb);
    const log = `민합 A=${a} B=${b} · 주사위 A=${ra} B=${rb}`;
    addLog(`선공 판정: ${log}`);
    return (a+ra) > (b+rb) ? 'A' : 'B';
  }

  btnEnter.onclick = ()=>{
    const id=(battleIdInp.value||'').trim();
    const nm=(spNameInp.value||'').trim();
    if(!id){ showToast('전투 ID가 필요합니다'); return; }
    if(!nm){ showToast('이름은 필수입니다'); return; }

    spectatorName = nm;
    socket.emit('join',{ battleId:id });
    addLog(`관전자 입장 요청: ${id} · 이름=${nm}`);
    authCard.style.display='none'; layout.style.display='grid';
  };

  // cheer buttons → chatMessage로 브로드캐스트
  document.addEventListener('click',(e)=>{
    const b = e.target.closest('button[data-msg]');
    if(!b || !battle) return;
    const msg = b.getAttribute('data-msg');
    socket.emit('chatMessage',{ battleId:battle.id, name: spectatorName||'관전자', message: msg });
    addLog(`[응원] ${spectatorName||'관전자'}: ${msg}`);
  });

  connect();
  const q=new URLSearchParams(location.search);
  if(q.get('battle')) battleIdInp.value = q.get('battle')||'';
})();
</script>
</body>
</html>
