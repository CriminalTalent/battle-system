<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>PYXIS - 관전자</title>
  <style>
    :root{
      --deep-navy:#000813;
      --gold:#DCC7A2;
      --gold-bright:#D4BA8D;
      --glass-1:rgba(0,8,19,.7);
      --glass-2:rgba(0,8,19,.5);
      --border-light:rgba(220,199,162,.3);
      --text:#fff;
      --text-muted:rgba(255,255,255,.7);
      --radius:6px;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Cinzel',serif;
      background:linear-gradient(135deg,var(--deep-navy) 0%, #001122 100%);
      color:var(--text); min-height:100vh; line-height:1.6;
    }
    .header{ text-align:center; padding:20px 0; background:var(--glass-1);
      border-bottom:1px solid var(--border-light); backdrop-filter:blur(10px) }
    .title{ color:var(--gold); font-size:2.2rem; font-weight:700; letter-spacing:.12em;
      text-shadow:0 0 20px rgba(220,199,162,.5) }

    .container{ max-width:1400px; margin:0 auto; padding:20px }
    .grid3{ display:grid; grid-template-columns:1fr 1.2fr 1fr; gap:20px; align-items:start }
    @media (max-width:1100px){ .grid3{ grid-template-columns:1fr; } }

    .card{
      background:var(--glass-1); border:1px solid var(--border-light);
      border-radius:var(--radius); padding:16px; backdrop-filter:blur(10px)
    }
    .section h2{ color:var(--gold); margin-bottom:12px; font-size:1.1rem; font-weight:600 }

    .team-list{ display:grid; gap:10px }
    .player{
      display:flex; gap:12px; align-items:center;
      background:var(--glass-2); border:1px solid var(--border-light);
      border-radius:var(--radius); padding:10px
    }
    .player img{
      width:42px; height:42px; border-radius:50%; border:2px solid var(--gold);
      object-fit:cover; background:#0b1420
    }
    .player .meta{ flex:1 }
    .name{ color:var(--gold); font-weight:700; font-size:.95rem }
    .stats{ font-size:.78rem; color:var(--text-muted); font-family:'JetBrains Mono',monospace; margin-top:2px }
    .hpbar{ height:8px; border-radius:10px; background:#0b1420; border:1px solid var(--border-light); margin-top:6px; position:relative }
    .hpfill{ height:100%; border-radius:9px; background:linear-gradient(90deg,#4ade80 0%, #22c55e 100%) }

    /* 중앙 전투 상태 */
    .center-wrap{ display:grid; gap:16px }
    .nowturn{
      display:grid; grid-template-columns:100px 1fr; gap:16px; align-items:center;
      background:var(--glass-2); border:1px solid var(--border-light); border-radius:var(--radius); padding:12px
    }
    .nowturn img{ width:100px; height:100px; border-radius:12px; border:3px solid var(--gold); object-fit:cover; background:#0b1420 }
    .nowturn .lbl{ color:var(--gold); font-weight:700; margin-bottom:6px }
    .timer{ font-family:'JetBrains Mono',monospace; color:#000; background:var(--gold); padding:2px 8px; border-radius:8px; display:inline-block; margin-left:8px }

    /* 응원/로그/채팅 */
    .cheers{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px }
    .btn{
      background:linear-gradient(135deg,var(--gold) 0%, var(--gold-bright) 100%); color:#0b0f14;
      border:none; padding:10px 12px; border-radius:8px; font-weight:700; cursor:pointer
    }
    .logs,.chat{ max-height:260px; overflow:auto; display:grid; gap:6px }
    .log{ font-size:.92rem; line-height:1.45; background:rgba(255,255,255,.02);
      border:1px solid rgba(220,199,162,.12); border-radius:8px; padding:6px 8px; color:var(--text) }
    .log.rule{ background:var(--gold); color:#000; font-weight:700 }
    .log.error{ color:#ff6b6b }
    .chat-entry{ font-size:.92rem; line-height:1.45; background:rgba(255,255,255,.02);
      border:1px solid rgba(220,199,162,.12); border-radius:8px; padding:6px 8px; color:var(--text) }
    .tmark{ font-family:'JetBrains Mono',monospace; color:#000; background:var(--gold); border-radius:6px; padding:0 6px; margin-right:6px }

    /* 입장 오버레이 */
    .overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center
    }
    .dialog{
      width:min(420px,92vw); background:var(--glass-1); border:1px solid var(--border-light);
      border-radius:12px; padding:16px
    }
    .dialog h3{ color:var(--gold); margin-bottom:10px }
    .field{ margin-top:10px }
    .field input{
      width:100%; padding:8px 12px; background:var(--deep-navy); color:var(--text);
      border:1px solid var(--border-light); border-radius:var(--radius); font-size:.95rem
    }
  </style>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet"/>
</head>
<body>
  <header class="header"><h1 class="title">PYXIS 관전자</h1></header>

  <div class="container">
    <div class="grid3">
      <!-- 좌: A 팀 -->
      <div class="card">
        <div class="section"><h2>A</h2></div>
        <div id="teamA" class="team-list"></div>
      </div>

      <!-- 중앙: 현재 턴 / 응원 / 로그/채팅 -->
      <div class="center-wrap">
        <div class="card nowturn">
          <img id="turnAvatar" src="/uploads/avatars/default.svg" onerror="this.src='/uploads/avatars/default.svg'" alt="NOW"/>
          <div>
            <div class="lbl">현재 턴 <span id="turnTeam">-</span> <span class="timer" id="turnTimer">--:--</span></div>
            <div>라운드 <span id="turnNumber">-</span></div>
            <div style="margin-top:6px; font-size:.95rem; color:var(--text-muted)">현재 진행자: <span id="turnPlayer">-</span></div>
          </div>
        </div>

        <div class="card">
          <div class="section"><h2>응원</h2></div>
          <div class="cheers" id="cheerBox">
            <button class="btn" data-cheer="좋아요!">좋아요!</button>
            <button class="btn" data-cheer="멋지다!">멋지다!</button>
            <button class="btn" data-cheer="집중!">집중!</button>
            <button class="btn" data-cheer="화이팅!">화이팅!</button>
            <button class="btn" data-cheer="역전 가자!">역전 가자!</button>
            <button class="btn" data-cheer="수고했어!">수고했어!</button>
          </div>
        </div>

        <div class="card">
          <div class="section"><h2>로그</h2></div>
          <div id="logs" class="logs"></div>
        </div>

        <div class="card">
          <div class="section"><h2>채팅</h2></div>
          <div id="chat" class="chat"></div>
        </div>
      </div>

      <!-- 우: B 팀 -->
      <div class="card">
        <div class="section"><h2>B</h2></div>
        <div id="teamB" class="team-list"></div>
      </div>
    </div>
  </div>

  <!-- 이름 입력 오버레이 -->
  <div class="overlay" id="overlay">
    <div class="dialog">
      <h3>관전자 이름 입력</h3>
      <div class="field"><input id="spectatorName" type="text" placeholder="이름(필수)"/></div>
      <div class="field"><button id="btnEnter" class="btn" style="width:100%">입장</button></div>
      <div class="field" style="color:var(--text-muted); font-size:.85rem">비밀번호는 링크에 포함되어 자동 적용됩니다.</div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
  (function(){
    const socket = io({ path:"/socket.io" });
    const params = new URL(location.href).searchParams;
    const battleId = params.get('battle') || '';
    const spectatorOtp = params.get('otp') || ''; // 서버에 별도 검증 이벤트가 없으므로 링크 소지 가정
    let myName = '';

    // 유틸
    const esc = (t)=> String(t||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    const pct = (hp,max)=>{ const m=Number(max||100); const h=Math.max(0,Number(hp||0)); return Math.max(0,Math.min(100,(h/m)*100)); };
    const tmark = ()=> new Date().toLocaleTimeString();

    // 렌더: 팀
    function renderTeams(players){
      const A = (players||[]).filter(p=>p.team==='A');
      const B = (players||[]).filter(p=>p.team==='B');
      const aBox = document.getElementById('teamA');
      const bBox = document.getElementById('teamB');
      aBox.innerHTML = ''; bBox.innerHTML = '';

      const row = (p)=>{
        const wrap = document.createElement('div'); wrap.className='player';
        const hp = Number(p.hp||0), max=Number(p.maxHp||100);
        wrap.innerHTML = `
          <img src="${esc(p.avatar||'/uploads/avatars/default.svg')}" onerror="this.src='/uploads/avatars/default.svg'" alt="${esc(p.name)}"/>
          <div class="meta">
            <div class="name">${esc(p.name)}</div>
            <div class="stats">공:${p.stats?.attack??1} 방:${p.stats?.defense??1} 민:${p.stats?.agility??1} 행:${p.stats?.luck??1}</div>
            <div class="hpbar"><div class="hpfill" style="width:${pct(hp,max)}%"></div></div>
            <div style="font-size:.75rem; color:var(--text-muted)">${hp}/${max}</div>
          </div>
        `;
        return wrap;
      };
      A.forEach(p=>aBox.appendChild(row(p)));
      B.forEach(p=>bBox.appendChild(row(p)));
    }

    // 렌더: 현재 턴
    let timerId = null;
    function renderTurn(snap){
      const turn = snap?.currentTurn || {};
      document.getElementById('turnTeam').textContent = turn.currentTeam ? `${turn.currentTeam}팀` : '-';
      document.getElementById('turnNumber').textContent = String(turn.turnNumber||'-');

      const cp = turn.currentPlayer || null;
      const cpId = turn.currentPlayerId || cp?.id || null;
      let avatar = '/uploads/avatars/default.svg';
      let name   = '-';
      if(cpId){
        const p = (snap?.players||[]).find(x=>x.id===cpId);
        if(p){ avatar = p.avatar || avatar; name = p.name || name; }
      }else if(cp){
        avatar = cp.avatar || avatar; name = cp.id || name;
      }
      const img = document.getElementById('turnAvatar');
      img.src = avatar; img.onerror = ()=>{ img.onerror=null; img.src='/uploads/avatars/default.svg'; };
      document.getElementById('turnPlayer').textContent = name;

      // 타이머
      const tEl = document.getElementById('turnTimer');
      if(timerId) clearInterval(timerId);
      let left = Number(turn.timeLeftSec ?? null);
      function fmt(s){ if(s==null) return '--:--'; s=Math.max(0,Number(s)||0); const m=Math.floor(s/60), r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`; }
      tEl.textContent = fmt(left);
      if(left!=null){
        timerId = setInterval(()=>{ left=Math.max(0,left-1); tEl.textContent=fmt(left); if(left<=0){ clearInterval(timerId); } }, 1000);
      }
    }

    // 로그/채팅
    function addLog(msg,type='info'){
      const box=document.getElementById('logs'); if(!box) return;
      const el=document.createElement('div');
      el.className='log'+(type==='battle'?' rule': type==='error'?' error':'');
      el.innerHTML = `<span class="tmark">${esc(tmark())}</span>${esc(msg)}`;
      box.appendChild(el); box.scrollTop=box.scrollHeight;
    }
    function addChat(payload){
      const text = payload?.message || payload?.text || '';
      const name = payload?.name || payload?.playerName || '익명';
      if(!text) return;
      const box=document.getElementById('chat');
      const el=document.createElement('div');
      el.className='chat-entry';
      el.textContent = `[${name}] ${text}`;
      box.appendChild(el); box.scrollTop=box.scrollHeight;
    }

    // 소켓
    socket.on('battleUpdate', (snap)=>{ if(!snap) return; renderTeams(snap.players||[]); renderTurn(snap); });
    socket.on('battle:update', (snap)=>{ if(!snap) return; renderTeams(snap.players||[]); renderTurn(snap); });
    socket.on('battle:log', (p)=>{ const msg=p?.message||''; const type=p?.type||'info'; if(msg) addLog(msg,type); });
    socket.on('battleLog',  (p)=>{ const msg=p?.message||''; const type=p?.type||'info'; if(msg) addLog(msg,type); });
    socket.on('chatMessage', addChat);
    socket.on('battle:chat', addChat);

    // 입장
    document.getElementById('btnEnter').addEventListener('click', ()=>{
      const nm = document.getElementById('spectatorName').value.trim();
      if(!nm){ alert('이름을 입력해주세요.'); return; }
      myName = nm;
      document.getElementById('overlay').style.display='none';
      if(battleId){ socket.emit('join', { battleId }); addLog(`${myName} 입장`); }
    });

    // 응원 6종(채팅으로만 송출, 로그 X)
    document.getElementById('cheerBox').addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-cheer]'); if(!btn) return;
      if(!battleId){ alert('전투 방이 없습니다.'); return; }
      const text = btn.getAttribute('data-cheer');
      socket.emit('spectator:cheer', { battleId, name: myName || '관전자', message: text });
    });

    // 초기 안내
    if(!battleId){
      alert('battle 파라미터가 없습니다. 예: /spectator?battle=...&otp=....');
    }
  })();
  </script>
</body>
</html>
