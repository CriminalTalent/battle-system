<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PYXIS - 관리자 콘솔</title>
  <script src="/socket.io/socket.io.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --black-0:#000000;
      --black-1:#0a0a0a;
      --black-2:#111214;
      --black-3:#1a1b1e;
      --gold:#dcc7a2;
      --gold-2:#e6d2a8;
      --gold-3:#f0e6c8;
      --text:#f8f9fa;
      --text-2:#e9ecef;
      --muted:#adb5bd;
      --glass-1:rgba(255,255,255,0.04);
      --glass-2:rgba(255,255,255,0.08);
      --border:rgba(255,255,255,0.12);
      --border-2:rgba(255,255,255,0.18);
      --radius:12px;
      --shadow:0 8px 18px rgba(0,0,0,.35);
      --success:#27ae60;
      --danger:#e74c3c;
      --warn:#f39c12;
      --info:#3498db;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{min-height:100vh;background:linear-gradient(135deg,var(--black-1),var(--black-2));color:var(--text);font-family:'Cinzel',serif;line-height:1.65;overflow-x:hidden}
    a{color:var(--gold)}
    /* header */
    .header{position:sticky;top:0;z-index:50;background:var(--glass-2);backdrop-filter:blur(10px);border-bottom:1px solid var(--border-2)}
    .header-inner{max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:14px 20px}
    .logo{font-weight:800;letter-spacing:2px;color:var(--gold-2);font-size:26px}
    .subtitle{font-size:12px;color:var(--muted);text-transform:uppercase}
    .conn{display:flex;gap:8px;align-items:center;font-size:12px;color:var(--muted)}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--danger)}
    /* layout */
    .main{max-width:1400px;margin:0 auto;padding:20px;display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr) minmax(0,1fr);gap:20px;align-items:start}
    @media (max-width:1200px){.main{grid-template-columns:minmax(0,1fr)}}
    .card{min-width:0;background:var(--glass-2);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .head{padding:14px 16px;border-bottom:1px solid var(--border);color:var(--gold-2);font-weight:700;letter-spacing:.5px;text-align:center}
    .card .body{padding:16px}
    /* fields */
    .field{margin-bottom:14px}
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;text-transform:uppercase}
    .field input,.field select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--black-3);color:var(--text);font-family:'Cinzel',serif}
    .field input[readonly]{color:var(--muted)}
    .row{display:grid;grid-template-columns:1fr 120px;gap:10px}
    .row2{display:grid;grid-template-columns:1fr 200px;gap:10px}
    /* buttons */
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:linear-gradient(135deg,var(--gold),var(--gold-2));color:var(--black-1);font-weight:700;cursor:pointer;user-select:none}
    .btn:disabled{opacity:.5;cursor:not-allowed;background:var(--glass-1);color:var(--muted)}
    .btn-row{display:flex;gap:8px;margin-bottom:10px}
    .btn-fill{width:100%}
    .btn-danger{background:linear-gradient(135deg,#c0392b,#a93226);color:#fff;border:none}
    .btn-success{background:linear-gradient(135deg,#2ecc71,#27ae60);color:#fff;border:none}
    .btn-dark{background:var(--black-3);color:var(--text);border-color:var(--border)}
    .btn-sm{padding:6px 10px;font-size:12px}
    /* lists */
    .list{border:1px solid var(--border);background:var(--black-3);border-radius:10px;max-height:220px;overflow:auto}
    .item{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid var(--border)}
    .item:last-child{border-bottom:none}
    .left{display:flex;align-items:center;gap:8px}
    .avatar{width:26px;height:26px;border-radius:8px;background:#333;object-fit:cover;border:1px solid var(--border)}
    .meta{font-size:12px}
    .meta .name{color:var(--text-2);font-weight:700}
    .meta .sub{color:var(--muted);font-size:11px}
    /* logs / chat */
    .logbox{height:260px;max-height:32vh;overflow:auto;overflow-x:hidden;border:1px solid var(--border);background:var(--black-3);border-radius:10px}
    .log{padding:8px 10px;border-bottom:1px solid var(--border);font-size:12px;white-space:pre-wrap;word-break:break-word;overflow-wrap:anywhere}
    .log .t{color:var(--muted);font-size:10px;margin-right:6px}
    .log.sys{color:var(--info)}
    .log.ok{color:var(--success)}
    .log.err{color:var(--danger)}
    .chatbox{height:150px;overflow:auto;border:1px solid var(--border);background:var(--black-3);border-radius:10px}
    .chat{padding:8px 10px;border-bottom:1px solid var(--border);font-size:12px;white-space:pre-wrap;word-break:break-word;overflow-wrap:anywhere}
    .chat .n{color:var(--gold-2);font-weight:700}
    .toast{position:fixed;top:86px;right:20px;z-index:999;background:var(--black-3);border:1px solid var(--border-2);border-left:4px solid var(--info);padding:12px 14px;border-radius:10px;transform:translateX(420px);transition:transform .25s ease;box-shadow:var(--shadow)}
    .toast.show{transform:translateX(0)}
  </style>
</head>
<body>
<header class="header">
  <div class="header-inner">
    <div>
      <div class="logo">PYXIS</div>
      <div class="subtitle">관리자 콘솔</div>
    </div>
    <div class="conn"><span id="connText">연결 대기</span><span id="connDot" class="dot"></span></div>
  </div>
</header>

<main class="main">
  <!-- 좌: 전투 제어 -->
  <section class="card">
    <div class="head">전투 제어</div>
    <div class="body">
      <div class="field">
        <label for="mode">전투 모드</label>
        <select id="mode">
          <option value="1v1">1 vs 1</option>
          <option value="2v2" selected>2 vs 2</option>
          <option value="3v3">3 vs 3</option>
          <option value="4v4">4 vs 4</option>
        </select>
      </div>
      <div class="btn-row">
        <button id="btnCreate" class="btn btn-fill">전투 생성</button>
        <button id="btnStart" class="btn btn-success btn-fill" disabled>시작</button>
      </div>
      <div class="btn-row">
        <button id="btnPause" class="btn btn-dark btn-fill" disabled>일시정지</button>
        <button id="btnResume" class="btn btn-dark btn-fill" disabled>재개</button>
      </div>
      <div class="btn-row">
        <button id="btnEnd" class="btn btn-danger btn-fill" disabled>종료</button>
      </div>

      <div class="field" style="margin-top:10px">
        <label>전투 ID</label>
        <input id="battleId" type="text" readonly>
      </div>
      <div class="field">
        <label>상태</label>
        <input id="battleStatus" type="text" readonly>
      </div>
    </div>
  </section>

  <!-- 중: 참가자 관리 -->
  <section class="card">
    <div class="head">전투 참가자 관리</div>
    <div class="body">
      <div class="row">
        <div class="field">
          <label for="pName">이름</label>
          <input id="pName" type="text" placeholder="전투 참가자 이름" maxlength="20"/>
        </div>
        <div class="field">
          <label for="pTeam">팀</label>
          <select id="pTeam">
            <option value="A">A팀</option>
            <option value="B">B팀</option>
          </select>
        </div>
      </div>

      <div class="row2">
        <div class="field">
          <label for="pHp">체력 (100 고정 권장)</label>
          <input id="pHp" type="number" min="1" max="100" value="100"/>
        </div>
        <div class="field">
          <label>아바타 이미지</label>
          <input id="pAvatar" type="file" accept="image/*"/>
        </div>
      </div>

      <div class="field">
        <label>스탯 (1~5)</label>
        <div class="row" style="grid-template-columns:repeat(4,1fr);gap:8px">
          <input id="sAtk" type="number" min="1" max="5" value="3" aria-label="공격"/>
          <input id="sDef" type="number" min="1" max="5" value="3" aria-label="방어"/>
          <input id="sAgi" type="number" min="1" max="5" value="3" aria-label="민첩"/>
          <input id="sLuk" type="number" min="1" max="5" value="2" aria-label="행운"/>
        </div>
      </div>

      <div class="field">
        <label>시작 아이템</label>
        <div class="row" style="grid-template-columns:repeat(3,1fr);gap:8px">
          <input id="iDit" type="number" min="0" max="99" value="1" aria-label="디터니"/>
          <input id="iAtkB" type="number" min="0" max="99" value="0" aria-label="공격 보정기"/>
          <input id="iDefB" type="number" min="0" max="99" value="0" aria-label="방어 보정기"/>
        </div>
      </div>

      <button id="btnAdd" class="btn btn-fill">전투 참가자 추가</button>

      <div style="margin-top:16px">
        <div style="color:var(--gold);font-weight:700;margin-bottom:8px">A팀</div>
        <div id="listA" class="list"><div class="item"><span class="meta sub">아직 추가된 참가자가 없습니다.</span></div></div>
      </div>
      <div style="margin-top:14px">
        <div style="color:var(--gold);font-weight:700;margin-bottom:8px">B팀</div>
        <div id="listB" class="list"><div class="item"><span class="meta sub">아직 추가된 참가자가 없습니다.</span></div></div>
      </div>
    </div>
  </section>

  <!-- 우: 로그 & 채팅 -->
  <section class="card">
    <div class="head">실시간 로그 / 채팅</div>
    <div class="body">
      <div id="logs" class="logbox" aria-live="polite"></div>
      <div style="height:8px"></div>
      <div id="chatLogs" class="chatbox"></div>
      <div class="row" style="margin-top:8px">
        <input id="chatMsg" type="text" placeholder="관리자 메시지 입력..." maxlength="100"/>
        <button id="btnSend" class="btn">전송</button>
      </div>
    </div>
  </section>
</main>

<div id="toast" class="toast"></div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const connText = $('#connText'), connDot = $('#connDot');
  const logs = $('#logs'), chatLogs = $('#chatLogs'), toast = $('#toast');
  const mode = $('#mode');
  const btnCreate = $('#btnCreate'), btnStart=$('#btnStart'), btnPause=$('#btnPause'), btnResume=$('#btnResume'), btnEnd=$('#btnEnd');
  const battleIdEl=$('#battleId'), battleStatusEl=$('#battleStatus');
  const pName=$('#pName'), pTeam=$('#pTeam'), pHp=$('#pHp'), pAvatar=$('#pAvatar');
  const sAtk=$('#sAtk'), sDef=$('#sDef'), sAgi=$('#sAgi'), sLuk=$('#sLuk');
  const iDit=$('#iDit'), iAtkB=$('#iAtkB'), iDefB=$('#iDefB');
  const btnAdd=$('#btnAdd'), listA=$('#listA'), listB=$('#listB');
  const chatMsg=$('#chatMsg'), btnSend=$('#btnSend');

  let socket = null;
  let battle = null;

  const showToast=(m,type='info')=>{
    toast.textContent = m;
    toast.style.borderLeftColor = (type==='error'? '#e74c3c': type==='success'? '#27ae60': '#3498db');
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'),2500);
  };
  const now = ()=> new Date().toLocaleTimeString('ko-KR',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const addLog=(msg,cls='sys')=>{
    const el=document.createElement('div'); el.className = `log ${cls}`;
    el.innerHTML = `<span class="t">${now()}</span>${msg}`;
    logs.appendChild(el); logs.scrollTop=logs.scrollHeight;
  };
  const addChat=(name,msg)=>{
    const el=document.createElement('div'); el.className='chat';
    el.innerHTML = `<span class="n">${escapeHtml(name)}</span>: ${escapeHtml(msg)}`;
    chatLogs.appendChild(el); chatLogs.scrollTop=chatLogs.scrollHeight;
  };
  const escapeHtml = s => String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

  // 소켓 연결
  function connect(){
    socket = window.io ? window.io({ path: "/socket.io" }) : null;
    if(!socket){ showToast('소켓 초기화 실패','error'); return; }

    socket.on('connect', ()=>{
      connText.textContent='연결됨';
      connDot.style.background = 'var(--success)';
      addLog('서버에 연결되었습니다.','ok');
    });
    socket.on('disconnect', ()=>{
      connText.textContent='연결 끊김';
      connDot.style.background = 'var(--danger)';
      addLog('서버 연결 끊김','err');
    });

    // 전투 스냅샷
    const onUpdate = (data)=>{
      battle = data;
      battleStatusEl.value = data.status || '';
      if(!battleIdEl.value && data.id) battleIdEl.value = data.id;
      renderLists();
    };
    socket.on('battleUpdate', onUpdate);
    socket.on('battle:update', onUpdate);

    socket.on('battle:log',(e)=>{
      addLog(`[${e.type||'system'}] ${e.message||''}`);
    });

    socket.on('chatMessage',(d)=>{
      addChat(d.name||'익명', d.message||'');
    });
  }

  // UI 렌더
  function renderLists(){
    if(!battle) return;
    const A = (battle.players||[]).filter(p=> (p.team||'A')==='A');
    const B = (battle.players||[]).filter(p=> (p.team||'A')==='B');

    const make = (p)=> {
      const li = document.createElement('div'); li.className='item';
      li.innerHTML = `
        <div class="left">
          <img class="avatar" src="${p.avatar||''}" alt="${escapeHtml(p.name)}"/>
          <div class="meta">
            <div class="name">${escapeHtml(p.name)}</div>
            <div class="sub">HP ${p.hp}/${p.maxHp||100} · 공${p.stats?.attack} 방${p.stats?.defense} 민${p.stats?.agility} 행${p.stats?.luck}</div>
          </div>
        </div>
        <button class="btn btn-sm btn-danger" data-id="${p.id}">삭제</button>
      `;
      li.querySelector('button').onclick = ()=> {
        if(!battle) return;
        socket.emit('deletePlayer',{ battleId: battle.id, playerId: p.id }, (ack)=>{
          if(ack?.ok){ addLog(`참가자 삭제: ${p.name}`,'ok'); }
          else { addLog(`참가자 삭제 실패: ${p.name}`,'err'); }
        });
      };
      return li;
    };

    listA.innerHTML = ''; listB.innerHTML = '';
    if(A.length===0) listA.innerHTML = `<div class="item"><span class="meta sub">아직 추가된 참가자가 없습니다.</span></div>`;
    else A.forEach(p=> listA.appendChild(make(p)));
    if(B.length===0) listB.innerHTML = `<div class="item"><span class="meta sub">아직 추가된 참가자가 없습니다.</span></div>`;
    else B.forEach(p=> listB.appendChild(make(p)));

    // 버튼 상태
    const st = battle.status;
    btnStart.disabled = st!=='waiting';
    btnPause.disabled = st!=='active';
    btnResume.disabled = st!=='paused';
    btnEnd.disabled = !battle.id || st==='waiting';
  }

  // 이벤트 바인딩
  btnCreate.onclick = ()=>{
    if(!socket) return;
    const m = mode.value;
    addLog(`전투 생성 요청: ${m}`);
    socket.emit('createBattle', { mode: m }, (ack)=>{
      if(ack?.ok){
        battle = ack.battle;
        battleIdEl.value = battle.id;
        battleStatusEl.value = battle.status;
        socket.emit('join',{ battleId: battle.id });
        addLog(`전투가 생성되었습니다. ID=${battle.id}`,'ok');
        btnStart.disabled = false;
      }else{
        addLog(`전투 생성 실패: ${ack?.error||'알 수 없음'}`,'err');
      }
    });
  };

  btnStart.onclick = ()=>{
    if(!battle) return;
    socket.emit('startBattle', { battleId: battle.id }, (ack)=>{
      if(ack?.ok){ addLog('전투 시작','ok'); }
      else addLog('전투 시작 실패','err');
    });
  };
  btnPause.onclick = ()=>{
    if(!battle) return;
    socket.emit('pauseBattle', { battleId: battle.id }, (ack)=>{
      if(ack?.ok){ addLog('전투 일시정지','ok'); }
      else addLog('전투 일시정지 실패','err');
    });
  };
  btnResume.onclick = ()=>{
    if(!battle) return;
    socket.emit('resumeBattle', { battleId: battle.id }, (ack)=>{
      if(ack?.ok){ addLog('전투 재개','ok'); }
      else addLog('전투 재개 실패','err');
    });
  };
  btnEnd.onclick = ()=>{
    if(!battle) return;
    if(!confirm('정말로 전투를 종료하시겠습니까?')) return;
    socket.emit('endBattle', { battleId: battle.id }, (ack)=>{
      if(ack?.ok){ addLog('전투 종료','ok'); }
      else addLog('전투 종료 실패','err');
    });
  };

  btnAdd.onclick = async ()=>{
    if(!battle){ showToast('먼저 전투를 생성하세요','error'); return; }
    const name = (pName.value||'').trim();
    if(!name){ showToast('이름을 입력하세요','error'); return; }

    // 아바타 업로드(선택)
    let avatarUrl = '';
    if(pAvatar.files && pAvatar.files[0]){
      try{
        const fd = new FormData();
        fd.append('avatar', pAvatar.files[0]);
        const r = await fetch('/api/upload/avatar',{ method:'POST', body:fd });
        const j = await r.json();
        if(j?.ok && j.url) avatarUrl = j.url;
        addLog(`아바타 업로드: ${j?.ok? '성공':'실패'}`);
      }catch(e){ addLog(`아바타 업로드 오류: ${e?.message||e}`,'err'); }
    }

    const player = {
      name,
      team: pTeam.value,
      hp: Math.max(1, Math.min(100, parseInt(pHp.value||100))),
      stats: {
        attack: parseInt(sAtk.value||3),
        defense: parseInt(sDef.value||3),
        agility: parseInt(sAgi.value||3),
        luck: parseInt(sLuk.value||2)
      },
      items: {
        dittany: parseInt(iDit.value||0),
        attackBooster: parseInt(iAtkB.value||0),
        defenseBooster: parseInt(iDefB.value||0)
      },
      avatar: avatarUrl || null
    };

    addLog(`참가자 추가 요청: ${player.name} (${player.team})`);
    socket.emit('addPlayer', { battleId: battle.id, player }, (ack)=>{
      if(ack?.ok){
        addLog(`참가자 추가 성공: ${player.name}`,'ok');
        pName.value=''; pHp.value='100'; pAvatar.value='';
      }else{
        addLog(`참가자 추가 실패: ${ack?.error||'알 수 없음'}`,'err');
      }
    });
  };

  btnSend.onclick = ()=>{
    const msg = (chatMsg.value||'').trim();
    if(!msg || !battle) return;
    socket.emit('chatMessage',{ battleId: battle.id, name:'관리자', message: msg });
    chatMsg.value='';
    addLog(`[채팅] 관리자: ${msg}`);
  };

  // 시작
  connect();
})();
</script>
</body>
</html>
