<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>Pyxis - 전투 관리자</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="/socket.io/socket.io.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --deep-navy: #0b0f1c;
      --navy: #121827;
      --navy-light: #1c2333;
      --glass: rgba(255, 255, 255, 0.03);
      --glass-light: rgba(255, 255, 255, 0.07);
      --gold: #E5C88A;
      --gold-light: #F0D9A3;
      --gold-dark: #C9A86A;
      --danger: #D9534F;
      --success: #5cb85c;
      --warning: #f0ad4e;
      --info: #5bc0de;
      --text: #f9f5eb;
      --text-muted: #c8c3ba;
      --border: rgba(255, 255, 255, 0.08);
      --radius: 12px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100%;
      background: linear-gradient(135deg, var(--deep-navy), var(--navy-light));
      color: var(--text);
      font-family: 'Inter', sans-serif;
    }
    h1, h2, h3 { font-family: 'Cinzel', serif; color: var(--gold); }

    .container { max-width: 1400px; margin: auto; padding: 2rem; }
    .card {
      background: var(--glass);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
    .card-title { font-size: 1.5rem; margin-bottom: 1rem; color: var(--gold-light); position: relative; }
    .card-title::after { content:''; display:block; width:60px; height:2px; background:var(--gold); margin-top:6px; }

    .btn { display:inline-block; padding:0.6rem 1.1rem; font-weight:700; font-size:0.95rem; border-radius:var(--radius); text-align:center; cursor:pointer; transition:all .2s ease; border:1px solid transparent; }
    .btn:hover { opacity:.95; box-shadow:0 4px 10px rgba(0,0,0,.2); }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .btn-primary { background: linear-gradient(135deg, var(--gold-dark), var(--gold)); color: var(--deep-navy); border-color: var(--gold-dark); }
    .btn-secondary { background: var(--glass-light); color: var(--text-muted); border: 1px solid var(--border); }
    .btn-success { background: var(--success); color:#fff; }
    .btn-warning { background: var(--warning); color:#fff; }
    .btn-danger { background: var(--danger); color:#fff; }

    .form-group { margin-bottom: 1rem; }
    .form-label { display:block; margin-bottom:.5rem; color:var(--gold-light); font-weight:600; }
    .form-input, .form-select, .form-textarea {
      width:100%; padding:.75rem 1rem; font-size:1rem;
      background: var(--glass-light); border:1px solid var(--border); border-radius: var(--radius); color: var(--text);
      transition: border .2s ease;
    }
    .form-textarea { min-height: 120px; resize: vertical; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline:none; border-color: var(--gold); box-shadow:0 0 0 2px rgba(229,200,138,.2); }

    .grid { display:grid; gap:1.5rem; }
    .grid-2 { grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    .grid-3 { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .grid-4 { grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }

    .hidden { display:none !important; }

    .status-pill { display:inline-block; padding:.25rem .75rem; font-size:.8rem; border-radius:999px; background:var(--glass-light); color:var(--text-muted); border:1px solid var(--border); }
    .status-waiting{ background: var(--info); color:#fff; }
    .status-running{ background: var(--success); color:#fff; }
    .status-ended{ background: var(--danger); color:#fff; }

    .scrollable { max-height: 260px; overflow-y:auto; }
    .scrollable::-webkit-scrollbar { width:8px; }
    .scrollable::-webkit-scrollbar-thumb { background-color: var(--gold-dark); border-radius:4px; }

    .log-box { background: var(--glass); border:1px solid var(--border); border-radius: var(--radius); padding:.5rem; max-height:320px; overflow:auto; }
    .log-entry { padding:.5rem; border-bottom:1px solid var(--border); font-size:.92rem; color:var(--text-muted); }
    .log-entry:last-child{ border-bottom:none; }
    .log-time { font-weight:700; color: var(--gold); margin-right:.5rem; }
    .log-system { font-style: italic; color: var(--info); }

    .pill { display:inline-block; font-size:.75rem; padding:.2rem .5rem; border:1px solid var(--border); border-radius: 999px; background: var(--glass-light); color: var(--text-muted); }
    .pill-ready{ background:#2a3a24; border-color:#375132; color:#bfe8a6; }
    .pill-dead{ background:#3a2626; border-color:#553939; color:#f0b3b3; }

    .team-col { border:1px solid var(--border); border-radius: var(--radius); padding: .75rem; }
    .player-row { display:grid; grid-template-columns: 1fr auto auto auto; gap:.5rem; align-items:center; padding:.5rem .25rem; border-bottom:1px dashed var(--border); }
    .player-row:last-child{ border-bottom:none; }
    .player-name { font-weight:700; }
    .player-actions .btn { padding:.35rem .6rem; font-size:.8rem; }

    /* Modal */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index: 40; }
    .modal.show { display:flex; }
    .modal-content { width:min(720px, calc(100% - 24px)); background: var(--navy); border:1px solid var(--border); border-radius: var(--radius); padding:1rem 1.25rem; }
    .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:.75rem; }
    .modal-title { font-family:'Cinzel',serif; color: var(--gold-light); font-size:1.25rem; }
  </style>
</head>
<body>
  <div class="container">
    <!-- 헤더 -->
    <header class="card" style="text-align:center;">
      <h1 style="font-size:2.6rem;">Pyxis</h1>
      <p style="color:var(--text-muted); font-size:1.1rem;">전투 관리자 시스템</p>
      <div style="margin-top:.75rem;">
        <span id="serverStatus" class="status-pill status-waiting">서버 상태 확인 중...</span>
      </div>
    </header>

    <!-- 관리자 인증 -->
    <section id="authScreen" class="card">
      <h2 class="card-title">관리자 인증</h2>
      <div class="grid grid-2">
        <div>
          <div class="form-group">
            <label class="form-label" for="battleId">전투 ID</label>
            <input type="text" id="battleId" class="form-input" placeholder="전투 ID 입력">
          </div>
          <div class="form-group">
            <label class="form-label" for="adminOtp">관리자 OTP</label>
            <input type="text" id="adminOtp" class="form-input" placeholder="OTP 입력">
          </div>
          <button id="btnAuth" class="btn btn-primary" style="width:100%;">인증</button>
        </div>

        <div>
          <div class="form-group">
            <label class="form-label">빠른 생성</label>
            <div class="grid grid-2">
              <select id="battleMode" class="form-select">
                <option value="1v1">1 vs 1</option>
                <option value="2v2">2 vs 2</option>
                <option value="3v3">3 vs 3</option>
                <option value="4v4">4 vs 4</option>
              </select>
              <button id="btnCreateBattle" class="btn btn-success">전투 생성</button>
            </div>
          </div>
          <div class="form-group">
            <button id="btnListBattles" class="btn btn-secondary" style="width:100%;">전투 목록 불러오기</button>
          </div>
          <div id="battlesList" class="scrollable hidden"></div>
        </div>
      </div>
    </section>

    <!-- 관리자 패널 -->
    <section id="adminScreen" class="hidden">
      <div class="grid grid-3">
        <!-- 전투 상태 -->
        <div class="card">
          <h2 class="card-title">현재 전투</h2>
          <div id="currentBattleInfo" style="line-height:1.7;">
            <p style="color:var(--text-muted);">인증 후 전투를 불러옵니다.</p>
          </div>
          <div id="readySummary" style="margin-top:.5rem; color:var(--text-muted);"></div>
        </div>

        <!-- 전투 제어 -->
        <div class="card">
          <h2 class="card-title">전투 제어</h2>
          <button id="btnStartBattle" class="btn btn-success" style="width:100%; margin-bottom:.5rem;" disabled>전투 시작</button>
          <button id="btnPauseBattle" class="btn btn-warning" style="width:100%; margin-bottom:.5rem;" disabled>일시 정지</button>
          <button id="btnEndBattle" class="btn btn-danger" style="width:100%; margin-bottom:.5rem;" disabled>전투 종료</button>
          <div class="grid grid-2" style="margin-top:.5rem;">
            <button id="btnDeclareTeam1" class="btn btn-secondary" disabled>승자: 팀1 선언</button>
            <button id="btnDeclareTeam2" class="btn btn-secondary" disabled>승자: 팀2 선언</button>
          </div>
        </div>

        <!-- 공지 관리 -->
        <div class="card">
          <h2 class="card-title">공지 관리</h2>
          <div class="form-group">
            <textarea id="noticeText" class="form-textarea" placeholder="플레이어 상단에 고정될 공지 텍스트(줄바꿈 허용)"></textarea>
          </div>
          <div class="grid grid-2">
            <button id="btnPinNotice" class="btn btn-primary" disabled>공지 저장/핀</button>
            <button id="btnClearNotice" class="btn btn-secondary" disabled>핀 해제</button>
          </div>
        </div>
      </div>

      <!-- 팀 구성 & 준비 현황 -->
      <div class="card">
        <h2 class="card-title">팀 구성 & 준비 현황</h2>
        <div class="grid grid-2">
          <div class="team-col">
            <h3 style="margin-bottom:.5rem;">불사조 기사단</h3>
            <div id="team1List"></div>
          </div>
          <div class="team-col">
            <h3 style="margin-bottom:.5rem;">죽음을 먹는 자들</h3>
            <div id="team2List"></div>
          </div>
        </div>
      </div>

      <!-- 플레이어 편집기 -->
      <div class="card">
        <h2 class="card-title">플레이어 편집기</h2>
        <div class="grid grid-4">
          <div>
            <label class="form-label">플레이어 선택</label>
            <select id="playerSelect" class="form-select"></select>
          </div>
          <div>
            <label class="form-label">팀</label>
            <select id="editTeam" class="form-select">
              <option value="team1">team1</option>
              <option value="team2">team2</option>
            </select>
          </div>
          <div>
            <label class="form-label">HP / Max</label>
            <div class="grid grid-2">
              <input id="editHp" class="form-input" type="number" min="0" placeholder="HP">
              <input id="editMaxHp" class="form-input" type="number" min="1" placeholder="Max HP">
            </div>
          </div>
          <div>
            <label class="form-label">아바타 URL</label>
            <input id="editAvatar" class="form-input" type="text" placeholder="https://...">
          </div>
        </div>
        <div class="grid grid-4" style="margin-top:1rem;">
          <div><label class="form-label">공격</label><input id="editAtk" class="form-input" type="number" min="0"></div>
          <div><label class="form-label">방어</label><input id="editDef" class="form-input" type="number" min="0"></div>
          <div><label class="form-label">민첩</label><input id="editAgi" class="form-input" type="number" min="0"></div>
          <div><label class="form-label">행운</label><input id="editLuk" class="form-input" type="number" min="0"></div>
        </div>
        <div class="form-group" style="margin-top:1rem;">
          <label class="form-label">아이템 (예: "포션:2, 수류탄:1")</label>
          <input id="editItems" class="form-input" type="text">
        </div>
        <div class="grid grid-3">
          <button id="btnSavePlayer" class="btn btn-primary" disabled>저장</button>
          <button id="btnHealFull" class="btn btn-success" disabled>풀회복</button>
          <button id="btnToggleAlive" class="btn btn-warning" disabled>생사 토글</button>
        </div>
      </div>

      <!-- 링크 & 상태 & 로그 -->
      <div class="grid grid-3">
        <div class="card">
          <h2 class="card-title">링크 관리</h2>
          <div class="grid grid-2">
            <button id="btnGenerateLinks" class="btn btn-primary" disabled>링크 생성</button>
            <button id="btnRefreshOtp" class="btn btn-secondary" disabled>OTP 갱신</button>
          </div>
        </div>

        <div class="card">
          <h2 class="card-title">연결 상태</h2>
          <p>플레이어: <span id="playerCount">0</span></p>
          <p>관전자: <span id="spectatorCount">0</span></p>
          <p>관리자: <span id="adminCount">1</span></p>
        </div>

        <div class="card">
          <h2 class="card-title">유틸</h2>
          <button id="btnClearLogs" class="btn btn-secondary" style="width:100%;">로그 비우기</button>
        </div>
      </div>

      <div class="grid grid-2">
        <div class="card">
          <h2 class="card-title">전투 로그</h2>
          <div id="battleLog" class="log-box"></div>
        </div>
        <div class="card">
          <h2 class="card-title">액션 히스토리</h2>
          <div id="actionHistoryLog" class="log-box"></div>
        </div>
      </div>

      <!-- 링크 복사 모달 -->
      <div id="linkModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">링크 복사</h3>
            <button class="btn btn-secondary" id="closeLinkModal">닫기</button>
          </div>
          <div class="modal-body">
            <div class="form-group"><label class="form-label">관리자 링크</label><input type="text" id="adminLink" class="form-input" readonly></div>
            <div class="form-group"><label class="form-label">팀 1 링크</label><input type="text" id="team1Link" class="form-input" readonly></div>
            <div class="form-group"><label class="form-label">팀 2 링크</label><input type="text" id="team2Link" class="form-input" readonly></div>
            <div class="form-group"><label class="form-label">관전자 링크</label><input type="text" id="spectatorLink" class="form-input" readonly></div>
          </div>
        </div>
      </div>
    </section>
  </div>

<script>
(() => {
  'use strict';

  // ---------- DOM helpers ----------
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const el = {
    serverStatus: $('#serverStatus'),
    authScreen: $('#authScreen'),
    adminScreen: $('#adminScreen'),
    // auth
    battleId: $('#battleId'),
    adminOtp: $('#adminOtp'),
    btnAuth: $('#btnAuth'),
    btnCreateBattle: $('#btnCreateBattle'),
    battleMode: $('#battleMode'),
    btnListBattles: $('#btnListBattles'),
    battlesList: $('#battlesList'),
    // current battle
    currentBattleInfo: $('#currentBattleInfo'),
    readySummary: $('#readySummary'),
    // control
    btnStart: $('#btnStartBattle'),
    btnPause: $('#btnPauseBattle'),
    btnEnd: $('#btnEndBattle'),
    btnDeclareTeam1: $('#btnDeclareTeam1'),
    btnDeclareTeam2: $('#btnDeclareTeam2'),
    // notice
    noticeText: $('#noticeText'),
    btnPinNotice: $('#btnPinNotice'),
    btnClearNotice: $('#btnClearNotice'),
    // teams
    team1List: $('#team1List'),
    team2List: $('#team2List'),
    // editor
    playerSelect: $('#playerSelect'),
    editTeam: $('#editTeam'),
    editHp: $('#editHp'),
    editMaxHp: $('#editMaxHp'),
    editAvatar: $('#editAvatar'),
    editAtk: $('#editAtk'),
    editDef: $('#editDef'),
    editAgi: $('#editAgi'),
    editLuk: $('#editLuk'),
    editItems: $('#editItems'),
    btnSavePlayer: $('#btnSavePlayer'),
    btnHealFull: $('#btnHealFull'),
    btnToggleAlive: $('#btnToggleAlive'),
    // links/status/logs
    btnGenerateLinks: $('#btnGenerateLinks'),
    btnRefreshOtp: $('#btnRefreshOtp'),
    playerCount: $('#playerCount'),
    spectatorCount: $('#spectatorCount'),
    adminCount: $('#adminCount'),
    btnClearLogs: $('#btnClearLogs'),
    battleLog: $('#battleLog'),
    actionHistoryLog: $('#actionHistoryLog'),
    // link modal
    linkModal: $('#linkModal'),
    closeLinkModal: $('#closeLinkModal'),
    adminLink: $('#adminLink'),
    team1Link: $('#team1Link'),
    team2Link: $('#team2Link'),
    spectatorLink: $('#spectatorLink'),
  };

  // ---------- Global state ----------
  let socket = null;
  let currentBattleId = null;
  let lastBattle = null;
  const API_PREFIXES = ['/api', ''];

  // ---------- Helpers ----------
  async function tryFetchJson(method, path, body) {
    let lastErr = '';
    for (const prefix of API_PREFIXES) {
      try {
        const res = await fetch(prefix + path, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: body ? JSON.stringify(body) : undefined
        });
        const txt = await res.text();
        if (res.ok) return txt ? JSON.parse(txt) : {};
        lastErr = `${res.status} ${txt}`;
      } catch (e) { lastErr = e.message; }
    }
    throw new Error(`${method} ${path} 실패: ${lastErr}`);
  }
  const ts = (d) => new Date(d).toLocaleString();

  function setServerPill(status) {
    el.serverStatus.classList.remove('status-waiting','status-running','status-ended');
    if (status === 'connected') {
      el.serverStatus.classList.add('status-running');
      el.serverStatus.textContent = '소켓 연결됨';
    } else if (status === 'disconnected') {
      el.serverStatus.classList.add('status-ended');
      el.serverStatus.textContent = '연결 끊김';
    } else {
      el.serverStatus.classList.add('status-waiting');
      el.serverStatus.textContent = '서버 상태 확인 중...';
    }
  }

  function battleStarted(b) {
    const s = String(b?.status||'').toLowerCase();
    return ['in_progress','started','active','battle','진행중','전투중'].some(x=>s.includes(x));
  }

  function pill(text, cls='') { return `<span class="pill ${cls}">${text}</span>`; }

  // ---------- Renderers ----------
  function renderBattleInfo(b) {
    if (!b) return;
    const t1 = b.teams?.team1?.players ?? b.team1?.players ?? [];
    const t2 = b.teams?.team2?.players ?? b.team2?.players ?? [];
    const alive1 = t1.filter(p=>p.alive!==false).length;
    const alive2 = t2.filter(p=>p.alive!==false).length;

    el.currentBattleInfo.innerHTML = `
      <p><strong>ID:</strong> ${b.id || currentBattleId}</p>
      <p><strong>상태:</strong> ${b.status ?? '-'}</p>
      <p><strong>모드:</strong> ${b.mode ?? '-'}</p>
      <p><strong>생성:</strong> ${b.createdAt ? ts(b.createdAt) : '-'}</p>
      <p><strong>턴 마감:</strong> ${b.turnDeadline ? ts(b.turnDeadline) : '-'}</p>
      ${b.winner ? `<p><strong>승자:</strong> ${b.winner==='team1'?'불사조 기사단':'죽음을 먹는 자들'}</p>` : ''}
    `;

    const r1 = t1.map(p => p.ready===true).filter(Boolean).length;
    const r2 = t2.map(p => p.ready===true).filter(Boolean).length;
    el.readySummary.innerHTML =
      `팀1 준비: ${r1}/${t1.length} · 생존 ${alive1}/${t1.length} &nbsp;|&nbsp; 팀2 준비: ${r2}/${t2.length} · 생존 ${alive2}/${t2.length}`;

    el.btnStart.disabled = !(r1===t1.length && r2===t2.length) || battleStarted(b);
    el.btnPause.disabled = !battleStarted(b);
    el.btnEnd.disabled = false;
    el.btnDeclareTeam1.disabled = false;
    el.btnDeclareTeam2.disabled = false;

    el.playerCount.textContent = (t1.length + t2.length);
    el.spectatorCount.textContent = b.spectators?.length ?? (b.spectatorCount ?? 0);
  }

  function renderTeams(b) {
    const t1 = b.teams?.team1?.players ?? b.team1?.players ?? [];
    const t2 = b.teams?.team2?.players ?? b.team2?.players ?? [];
    function row(p) {
      const r = p.ready===true;
      const alive = p.alive !== false;
      const hpTxt = `${Math.max(0, p.hp ?? p.currentHp ?? p.health ?? 0)}/${p.maxHp ?? 100}`;
      return `
        <div class="player-row" data-pid="${p.id || p.playerId || p.name}">
          <div class="player-name">${p.name || '이름없음'}</div>
          <div>${hpTxt} ${alive? '' : pill('사망','pill-dead')}</div>
          <div>${r ? pill('준비','pill-ready') : pill('대기')}</div>
          <div class="player-actions">
            <button class="btn btn-secondary btn-sm" data-force-ready="${r? '0':'1'}">강제${r?'해제':'준비'}</button>
          </div>
        </div>`;
    }
    el.team1List.innerHTML = t1.map(row).join('') || '<div class="text-muted">플레이어 없음</div>';
    el.team2List.innerHTML = t2.map(row).join('') || '<div class="text-muted">플레이어 없음</div>';
  }

  function populateEditor(b) {
    const players = [...(b.teams?.team1?.players ?? b.team1?.players ?? []),
                     ...(b.teams?.team2?.players ?? b.team2?.players ?? [])];
    el.playerSelect.innerHTML = players.map(p => {
      const id = p.id || p.playerId || p.name;
      const team = p.team || p.side || ((b.teams?.team1?.players ?? b.team1?.players ?? []).includes(p) ? 'team1' : 'team2');
      return `<option value="${id}">${p.name} (${team})</option>`;
    }).join('');
    const first = players[0];
    if (first) loadPlayerToEditor(first, b);
    const enable = players.length>0;
    [el.btnSavePlayer, el.btnHealFull, el.btnToggleAlive].forEach(btn=>btn.disabled=!enable);
  }

  function itemsObjToLine(it){
    if(Array.isArray(it) && it.length) return it.map(x=>`${x.name}:${x.qty??1}`).join(', ');
    if(it && typeof it==='object') return Object.entries(it).map(([k,v])=>`${k}:${v}`).join(', ');
    return '';
  }
  function lineToItemsObj(line){
    const obj={}; if(!line) return obj;
    line.split(',').map(s=>s.trim()).filter(Boolean).forEach(pair=>{
      const idx=pair.lastIndexOf(':');
      if(idx>0){ const k=pair.slice(0,idx).trim(); const v=parseInt(pair.slice(idx+1).trim(),10); obj[k]=isNaN(v)?1:v; }
      else { obj[pair]=1; }
    });
    return obj;
  }

  function findPlayerById(b, pid) {
    const all = [...(b.teams?.team1?.players ?? b.team1?.players ?? []),
                 ...(b.teams?.team2?.players ?? b.team2?.players ?? [])];
    return all.find(p => (p.id||p.playerId||p.name) == pid);
  }
  function loadPlayerToEditor(p, b){
    const team = p.team || p.side || ( (b.teams?.team1?.players ?? b.team1?.players ?? []).includes(p) ? 'team1' : 'team2' );
    el.editTeam.value = team;
    el.editHp.value = p.hp ?? p.currentHp ?? 0;
    el.editMaxHp.value = p.maxHp ?? 100;
    el.editAvatar.value = p.avatar || p.image || p.avatarUrl || p.imageUrl || '';
    el.editAtk.value = p.stats?.attack ?? p.attack ?? 0;
    el.editDef.value = p.stats?.defense ?? p.defense ?? 0;
    el.editAgi.value = p.stats?.agility ?? p.agility ?? 0;
    el.editLuk.value = p.stats?.luck ?? p.luck ?? 0;
    el.editItems.value = itemsObjToLine(p.items);
  }

  function log(box, text, cls=''){
    const div = document.createElement('div');
    div.className = 'log-entry ' + cls;
    const time = new Date().toLocaleTimeString();
    div.innerHTML = `<span class="log-time">${time}</span><span class="log-text">${text}</span>`;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  }

  function checkAnnihilation(b) {
    const t1=b.teams?.team1?.players ?? b.team1?.players ?? [];
    const t2=b.teams?.team2?.players ?? b.team2?.players ?? [];
    const alive1=t1.filter(p=>p.alive!==false).length;
    const alive2=t2.filter(p=>p.alive!==false).length;
    if ((alive1===0 && alive2>0) || (alive2===0 && alive1>0)) {
      const winner = alive1>0 ? 'team1' : 'team2';
      if(!b.winner){
        try{ socket?.emit('declareWinner', { battleId: currentBattleId, winner }); }catch{}
        tryFetchJson('POST', `/battles/${encodeURIComponent(currentBattleId)}/end`, { winner })
          .catch(()=>tryFetchJson('POST', `/battles/${encodeURIComponent(currentBattleId)}/finish`, { winner }).catch(()=>{}));
        log(el.battleLog, `전멸 감지 → ${winner==='team1'?'팀1':'팀2'} 승리 선언 시도`, 'log-system');
      }
    }
  }

  // ---------- Socket ----------
  function bindSocketHandlers() {
    socket.on('connect', ()=> setServerPill('connected'));
    socket.on('disconnect', ()=> setServerPill('disconnected'));

    socket.on('authSuccess', ({ battle }) => {
      lastBattle = battle;
      currentBattleId = battle.id;
      el.authScreen.classList.add('hidden');
      el.adminScreen.classList.remove('hidden');
      [el.btnStart, el.btnPause, el.btnEnd, el.btnPinNotice, el.btnClearNotice, el.btnGenerateLinks, el.btnRefreshOtp]
        .forEach(btn=>btn.disabled=false);
      renderBattleInfo(battle);
      renderTeams(battle);
      populateEditor(battle);
      el.noticeText.value = battle.notice?.text ?? battle.notice ?? battle.pinnedNotice ?? '';
      log(el.battleLog, '관리자 인증 성공', 'log-system');
    });
    socket.on('authError', () => alert('인증 실패'));

    socket.on('battleUpdate', (b) => {
      lastBattle = b;
      renderBattleInfo(b);
      renderTeams(b);
      populateEditor(b);
      if (typeof b.notice!=='undefined') { el.noticeText.value = b.notice?.text ?? b.notice ?? b.pinnedNotice ?? ''; }
      checkAnnihilation(b);
    });
    socket.on('chat', (payload)=>{
      const name = payload.name || payload.playerName || '누군가';
      const tag = payload.teamOnly ? '[팀]' : '[전체]';
      log(el.battleLog, `채팅 ${tag} ${name}: ${payload.message}`);
    });
    socket.on('actionExecuted', (action)=>{
      const who = action.playerName || action.playerId || '누군가';
      const type = String(action.type||action.action||'').toUpperCase();
      const det = action.detail || action.targetName || action.targetId || '';
      log(el.actionHistoryLog, `${who} → ${type} ${det? '('+det+')':''}`);
    });
    socket.on('readyUpdate', ({playerId, ready})=>{
      if(!lastBattle) return;
      const p = findPlayerById(lastBattle, playerId);
      if (p){ p.ready = !!ready; renderTeams(lastBattle); renderBattleInfo(lastBattle); }
    });
    socket.on('noticeUpdate', ({text})=>{
      el.noticeText.value = text || '';
      log(el.battleLog, '공지 업데이트 수신', 'log-system');
    });
  }

  // ---------- Auth (manual & auto) ----------
  async function doAuth(id, otp) {
    if (!id || !otp) { alert('전투 ID와 OTP가 필요합니다.'); return; }
    try { await tryFetchJson('GET', `/battles/${encodeURIComponent(id)}`); }
    catch { alert('전투를 찾을 수 없습니다.'); return; }

    socket = io();
    setServerPill('connected');
    bindSocketHandlers();
    socket.emit('adminAuth', { battleId: id, otp });
  }

  el.btnAuth.addEventListener('click', () => {
    doAuth(el.battleId.value.trim(), el.adminOtp.value.trim());
  });

  // Create → auto-auth
  el.btnCreateBattle.addEventListener('click', async ()=>{
    try{
      const data = await tryFetchJson('POST', '/battles', { mode: el.battleMode.value });
      const b = data.battle || data;
      el.battleId.value = b.id;
      el.adminOtp.value = b.otps?.admin || '';
      await doAuth(b.id, b.otps?.admin || '');
    }catch(e){ alert('생성 실패: ' + e.message); }
  });

  el.btnListBattles.addEventListener('click', async ()=>{
    try{
      const data = await tryFetchJson('GET', '/battles');
      const list = data.battles || data || [];
      el.battlesList.classList.remove('hidden');
      el.battlesList.innerHTML = list.map(b=>`
        <div class="card" style="padding:.75rem; margin-bottom:.75rem;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <div><b>ID:</b> ${b.id}</div>
              <div style="color:var(--text-muted); font-size:.9rem;">${b.mode} · ${b.status} · ${b.createdAt?ts(b.createdAt):''}</div>
            </div>
            <div>
              <button class="btn btn-secondary" data-pick="${b.id}">ID 선택</button>
            </div>
          </div>
        </div>`).join('') || '<div class="text-muted">전투 없음</div>';
      $$('#battlesList [data-pick]').forEach(btn=>{
        btn.addEventListener('click', ()=>{ el.battleId.value = btn.getAttribute('data-pick'); alert('전투 ID가 입력되었습니다. OTP를 입력하고 인증하세요.'); });
      });
    }catch(e){ alert('목록 불러오기 실패: ' + e.message); }
  });

  // ---------- Controls ----------
  async function controlBattle(kind){
    if(!currentBattleId) return;
    try{
      const map = {start:'adminStartBattle', pause:'adminPauseBattle', end:'adminEndBattle'};
      if(map[kind]) socket?.emit(map[kind], { battleId: currentBattleId });
    }catch{}
    const path = kind==='start'? '/start' : kind==='pause'? '/pause' : '/end';
    try{ await tryFetchJson('POST', `/admin/battles/${encodeURIComponent(currentBattleId)}${path}`); }
    catch(_){ try{ await tryFetchJson('POST', `/battles/${encodeURIComponent(currentBattleId)}${path}`); } catch(__){} }
    log(el.battleLog, `전투 ${kind} 명령 전송`, 'log-system');
  }
  $('#btnStartBattle').addEventListener('click', ()=>controlBattle('start'));
  $('#btnPauseBattle').addEventListener('click', ()=>controlBattle('pause'));
  $('#btnEndBattle').addEventListener('click',   ()=>controlBattle('end'));
  $('#btnDeclareTeam1').addEventListener('click', ()=>declareWinner('team1'));
  $('#btnDeclareTeam2').addEventListener('click', ()=>declareWinner('team2'));

  async function declareWinner(team){
    if(!currentBattleId) return;
    try{ socket?.emit('declareWinner', { battleId: currentBattleId, winner: team }); }catch{}
    try{ await tryFetchJson('POST', `/battles/${encodeURIComponent(currentBattleId)}/end`, { winner: team }); }
    catch(_){ try{ await tryFetchJson('POST', `/battles/${encodeURIComponent(currentBattleId)}/finish`, { winner: team }); } catch(__){} }
    log(el.battleLog, `승자 선언: ${team==='team1'?'팀1':'팀2'}`, 'log-system');
  }

  // Force ready toggle in lists
  function delegateTeamLists(){
    function onClick(e){
      const btn = e.target.closest('[data-force-ready]');
      if(!btn || !lastBattle) return;
      const row = btn.closest('.player-row');
      const pid = row.getAttribute('data-pid');
      const toReady = btn.getAttribute('data-force-ready')==='1';
      try{ socket?.emit('playerReady', { battleId: currentBattleId, playerId: pid, ready: toReady }); }catch{}
      tryFetchJson('POST', `/battles/${encodeURIComponent(currentBattleId)}/players/${encodeURIComponent(pid)}/ready`, { ready: toReady })
        .catch(()=>tryFetchJson('POST', `/battles/${encodeURIComponent(currentBattleId)}/ready`, { playerId: pid, ready: toReady }).catch(()=>{}));
      log(el.battleLog, `강제 ${toReady?'준비':'해제'}: ${pid}`);
    }
    el.team1List.addEventListener('click', onClick);
    el.team2List.addEventListener('click', onClick);
  }
  delegateTeamLists();

  // Notice
  $('#btnPinNotice').addEventListener('click', async()=>{
    const text = el.noticeText.value || '';
    try{ socket?.emit('pinNotice', { battleId: currentBattleId, text }); }catch{}
    try{
      await tryFetchJson('POST', `/battles/${encodeURIComponent(currentBattleId)}/notice`, { text });
    }catch(_){ try{ await tryFetchJson('POST', `/battles/${encodeURIComponent(currentBattleId)}/pin`, { notice: text }); }catch(__){} }
    log(el.battleLog, '공지 저장/핀 완료', 'log-system');
  });
  $('#btnClearNotice').addEventListener('click', async()=>{
    el.noticeText.value = '';
    try{ socket?.emit('clearNotice', { battleId: currentBattleId }); }catch{}
    try{ await tryFetchJson('DELETE', `/battles/${encodeURIComponent(currentBattleId)}/notice`); }
    catch(_){ try{ await tryFetchJson('POST', `/battles/${encodeURIComponent(currentBattleId)}/notice`, { text:'' }); }catch(__){} }
    log(el.battleLog, '공지 핀 해제', 'log-system');
  });

  // Editor
  el.playerSelect.addEventListener('change', ()=>{
    const pid = el.playerSelect.value;
    const p = findPlayerById(lastBattle, pid);
    if (p) loadPlayerToEditor(p, lastBattle);
  });
  el.btnHealFull.addEventListener('click', async ()=>{
    const pid = el.playerSelect.value; if(!pid) return;
    const p = findPlayerById(lastBattle, pid); if(!p) return;
    el.editHp.value = el.editMaxHp.value = (p.maxHp ?? 100);
    await savePlayer(false);
  });
  el.btnToggleAlive.addEventListener('click', async ()=>{
    const pid = el.playerSelect.value; if(!pid) return;
    const p = findPlayerById(lastBattle, pid); if(!p) return;
    const newAlive = !(p.alive !== false);
    await savePlayer(false, { alive: newAlive });
  });
  el.btnSavePlayer.addEventListener('click', ()=>savePlayer(true));

  function toNum(v){ const n=parseInt(v,10); return isNaN(n)?0:n; }
  async function savePlayer(showToast=true, extra={}) {
    const pid = el.playerSelect.value; if(!pid || !lastBattle) return;
    const body = {
      team: el.editTeam.value,
      hp: toNum(el.editHp.value),
      maxHp: toNum(el.editMaxHp.value) || undefined,
      avatar: el.editAvatar.value || undefined,
      stats: {
        attack: toNum(el.editAtk.value),
        defense: toNum(el.editDef.value),
        agility: toNum(el.editAgi.value),
        luck: toNum(el.editLuk.value),
      },
      items: lineToItemsObj(el.editItems.value),
      ...extra
    };
    try{ socket?.emit('adminUpdatePlayer', { battleId: currentBattleId, playerId: pid, update: body }); }catch{}
    try{
      await tryFetchJson('PATCH', `/battles/${encodeURIComponent(currentBattleId)}/players/${encodeURIComponent(pid)}`, body);
    }catch(_){
      try{ await tryFetchJson('POST', `/battles/${encodeURIComponent(currentBattleId)}/players/${encodeURIComponent(pid)}`, body); }
      catch(__){}
    }
    if (showToast) log(el.battleLog, `플레이어 저장: ${pid}`, 'log-system');
    try{ await tryFetchJson('GET', `/battles/${encodeURIComponent(currentBattleId)}`); }catch{}
  }

  // Links
  el.btnGenerateLinks.addEventListener('click', async()=>{
    if(!currentBattleId) return;
    let urls = null;
    try{
      const data = await tryFetchJson('POST', `/admin/battles/${encodeURIComponent(currentBattleId)}/links`);
      urls = data.urls;
    }catch(_){
      const origin = location.origin;
      const playerPath = (p)=> `${origin}/player.html?battle=${encodeURIComponent(currentBattleId)}&team=${p}`;
      const adminPath = `${origin}${location.pathname}?battle=${encodeURIComponent(currentBattleId)}&role=admin`;
      urls = { admin: adminPath, team1: playerPath('team1'), team2: playerPath('team2'), spectator: playerPath('spectator') };
    }
    el.adminLink.value = urls.admin || '';
    el.team1Link.value = urls.team1 || '';
    el.team2Link.value = urls.team2 || '';
    el.spectatorLink.value = urls.spectator || '';
    el.linkModal.classList.add('show');
  });
  el.closeLinkModal.addEventListener('click', ()=> el.linkModal.classList.remove('show'));
  [el.adminLink, el.team1Link, el.team2Link, el.spectatorLink].forEach(inp=>{
    inp.addEventListener('focus', ()=>inp.select());
    inp.addEventListener('click', ()=>{ inp.select(); document.execCommand('copy'); });
  });

  // Logs
  el.btnClearLogs.addEventListener('click', ()=>{
    el.battleLog.innerHTML=''; el.actionHistoryLog.innerHTML='';
  });

})();
</script>
</body>
</html>
