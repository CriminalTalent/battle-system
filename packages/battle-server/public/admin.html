<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>PYXIS 관리자 콘솔</title>

  <!-- 폰트 -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;800;900&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- 공용 효과 CSS (필수) -->
  <link rel="stylesheet" href="/assets/css/effects.css" />

  <style>
    :root{
      --deep-navy:#00080D;
      --glass-1:rgba(15,25,40,.8);
      --glass-2:rgba(20,30,45,.9);
      --gold-1:#DCC7A2;
      --gold-2:#D4BA8D;
      --gold-bright:#F0E6C7;
      --text:#E5E7EB;
      --text-dim:#D1D5DB;
      --text-muted:#9CA3AF;
      --success:#10B981;
      --danger:#EF4444;
      --warning:#F59E0B;
      --info:#3B82F6;
      --radius:12px;
      --radius-sm:8px;
      --shadow:0 8px 28px rgba(0,0,0,.35);
      --shadow-soft:0 4px 18px rgba(0,0,0,.3);
      --border:1px solid rgba(212,183,126,.22);
      --border-subtle:1px solid rgba(212,183,126,.12);
    }
    *{box-sizing:border-box}
    body{
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple SD Gothic Neo", "Malgun Gothic", "Nanum Gothic", sans-serif;
      color:var(--text);
      background:linear-gradient(135deg,var(--deep-navy) 0%, #000B14 50%, var(--deep-navy) 100%);
      min-height:100vh;
    }
    .header{
      position:sticky; top:0; z-index:30;
      background:var(--glass-2);
      backdrop-filter: blur(12px) saturate(180%);
      border-bottom:var(--border);
    }
    .header-inner{
      max-width:1280px; margin:0 auto; padding:18px 16px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .brand{
      display:flex; align-items:baseline; gap:10px;
    }
    .logo{
      font-family:Cinzel, serif;
      font-weight:900; letter-spacing:.18em; font-size:30px;
      background:linear-gradient(135deg,var(--gold-1), var(--gold-bright), var(--gold-2));
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
      text-shadow:0 0 18px rgba(220,199,162,.35);
    }
    .subtitle{ font-size:12px; color:var(--text-muted); text-transform:uppercase; letter-spacing:.08em; }
    .conn{
      display:flex; align-items:center; gap:8px; color:var(--text-muted); font-size:12px;
    }
    .dot{ width:10px; height:10px; border-radius:50%; background:#6B7280; border:1px solid rgba(255,255,255,.18);}
    .dot.ok{ background:var(--success); border-color:rgba(16,185,129,.5); box-shadow:0 0 8px rgba(16,185,129,.35); }

    .container{ max-width:1280px; margin:0 auto; padding:24px 16px; }
    .grid{ display:grid; grid-template-columns:340px 1fr 360px; gap:18px; align-items:start; }
    @media (max-width: 1200px){ .grid{ grid-template-columns:1fr 1fr; } }
    @media (max-width: 860px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background:var(--glass-2);
      border:var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow-soft);
      padding:16px;
      transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .card:hover{ transform:translateY(-1px); box-shadow:var(--shadow); border-color:var(--gold-2); }
    .title{
      font-family:Cinzel, serif; font-weight:700; color:var(--gold-bright);
      border-bottom:var(--border-subtle); padding-bottom:10px; margin-bottom:14px;
      display:flex; align-items:center; justify-content:space-between;
    }

    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .row-3{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
    .row-4{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px; }
    .field label{ display:block; font-size:12px; font-weight:600; color:var(--text-muted); margin-bottom:6px; letter-spacing:.02em; }
    input[type="text"],input[type="number"],select, .mono{
      width:100%; background:var(--glass-1); border:var(--border);
      border-radius:10px; color:var(--text); font-size:13px; padding:10px 12px;
      outline:none; transition: border-color .2s, box-shadow .2s;
    }
    input:focus, select:focus, .mono:focus{ border-color:var(--gold-1); box-shadow:0 0 0 2px rgba(212,183,126,.16); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .btn{
      background:linear-gradient(135deg,var(--gold-1), var(--gold-2));
      color:#0B1117; border:1px solid var(--gold-1); border-radius:10px;
      font-weight:700; font-size:12px; letter-spacing:.04em; padding:10px 12px; cursor:pointer;
      box-shadow:0 2px 8px rgba(212,183,126,.22);
      transition:transform .15s ease, box-shadow .15s ease, background .15s ease, opacity .2s;
      min-height:38px;
    }
    .btn:hover{ transform:translateY(-1px); box-shadow:0 6px 16px rgba(212,183,126,.35); background:linear-gradient(135deg,var(--gold-bright),#E8DDB5); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none; box-shadow:none; }
    .btn-row{ display:grid; grid-template-columns:repeat(4,1fr); gap:8px; }
    .btn-danger{ background:linear-gradient(135deg,var(--danger), #DC2626); color:#fff; border-color:var(--danger);}
    .btn-success{ background:linear-gradient(135deg,var(--success), #059669); color:#fff; border-color:var(--success);}

    .meta{
      display:grid; grid-template-columns:repeat(3,1fr); gap:10px;
      background:var(--glass-1); border:var(--border-subtle); border-radius:10px; padding:10px;
      margin-bottom:14px;
    }
    .meta-item{ text-align:center; }
    .meta-k{ font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:.08em; }
    .meta-v{ font-weight:700; color:var(--gold-bright); margin-top:4px; }

    .preview-wrap{ display:flex; align-items:center; gap:10px; }
    .preview{
      width:108px; height:108px; border-radius:14px;
      background:#0b121b center/cover no-repeat;
      border:var(--border-subtle); display:flex; align-items:center; justify-content:center;
      color:var(--text-muted); font-size:12px;
    }

    table{ width:100%; border-collapse:separate; border-spacing:0 8px; }
    thead th{
      text-align:left; font-size:11px; color:var(--text-muted); font-weight:700; padding:6px 8px;
      border-bottom:var(--border-subtle);
    }
    tbody td{
      background:rgba(0,0,0,.18); border:var(--border-subtle);
      padding:8px; font-size:12px;
    }
    tbody tr td:first-child{ border-radius:8px 0 0 8px; }
    tbody tr td:last-child{ border-radius:0 8px 8px 0; }

    .log, .chat{
      background:var(--glass-1); border:var(--border); border-radius:12px; padding:10px;
      height:260px; overflow:auto; font-size:12px; line-height:1.45;
    }
    .log div, .chat div{ padding:6px 6px; border-left:2px solid transparent; }
    .log .sys{ border-left-color:var(--info); background:rgba(59,130,246,.08);}
    .log .err{ border-left-color:var(--danger); background:rgba(239,68,68,.08);}
    .log .adm{ border-left-color:var(--gold-1); background:rgba(212,183,126,.08);}
    .chat-input{ display:flex; gap:8px; margin-top:8px; }
    .toast{
      position:fixed; bottom:16px; left:50%; transform:translateX(-50%);
      background:var(--glass-2); border:var(--border); padding:10px 14px; border-radius:10px;
      box-shadow:var(--shadow-soft); opacity:0; transition:opacity .2s, transform .2s; pointer-events:none;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-4px); }
  </style>
</head>
<body>
  <!-- 헤더 -->
  <header class="header">
    <div class="header-inner">
      <div class="brand">
        <div class="logo">PYXIS</div>
        <div class="subtitle">관리자 콘솔</div>
      </div>
      <div class="conn">
        <span id="connText">서버 연결</span>
        <span id="connDot" class="dot"></span>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- 전투 메타 -->
    <div class="meta" id="battleMeta">
      <div class="meta-item">
        <div class="meta-k">상태</div>
        <div class="meta-v" id="metaStatus">대기중</div>
      </div>
      <div class="meta-item">
        <div class="meta-k">모드</div>
        <div class="meta-v" id="metaMode">-</div>
      </div>
      <div class="meta-item">
        <div class="meta-k">전투 ID</div>
        <div class="meta-v" id="metaId">-</div>
      </div>
    </div>

    <div class="grid">
      <!-- 좌: 전투 제어 -->
      <section class="card">
        <div class="title">전투 제어</div>

        <div class="field">
          <label for="mode">전투 모드</label>
          <select id="mode">
            <option value="1v1">1 vs 1</option>
            <option value="2v2">2 vs 2</option>
            <option value="3v3">3 vs 3</option>
            <option value="4v4" selected>4 vs 4</option>
          </select>
        </div>

        <div class="row" style="margin-top:8px;">
          <button class="btn" id="btnCreate">전투 생성</button>
          <button class="btn btn-success" id="btnStart" disabled>시작</button>
        </div>

        <div class="btn-row" style="margin-top:8px;">
          <button class="btn" id="btnResume" disabled>재개</button>
          <button class="btn" id="btnPause" disabled>일시정지</button>
          <button class="btn btn-danger" id="btnEnd" disabled>종료</button>
          <span></span>
        </div>

        <div class="title" style="margin-top:14px;">링크 및 비밀번호</div>

        <div class="row">
          <button class="btn" id="btnGenPlayer">전투 참가자 링크 생성</button>
          <button class="btn" id="btnGenSpectator">관전자 비밀번호 발급</button>
        </div>

        <div class="field" style="margin-top:8px;">
          <label for="spectatorOtp">관전자 비밀번호</label>
          <input id="spectatorOtp" type="text" class="mono" placeholder="발급 후 표시됩니다" readonly />
        </div>

        <div class="row">
          <button class="btn" id="btnBuildSpectator">관전자 URL 생성/복사</button>
          <input id="spectatorUrl" type="text" class="mono" placeholder="관전자 URL" readonly />
        </div>

        <div class="field" style="margin-top:12px;">
          <label>참가자 개별 링크</label>
          <div id="playerLinks" style="display:flex; flex-direction:column; gap:8px;">
            <!-- 동적 추가 -->
          </div>
        </div>
      </section>

      <!-- 중간: 참가자 관리 -->
      <section class="card">
        <div class="title">전투 참가자 관리</div>

        <div class="row">
          <div class="field">
            <label for="pName">이름</label>
            <input id="pName" type="text" maxlength="20" placeholder="최대 20자" />
          </div>
          <div class="field">
            <label for="pTeam">팀</label>
            <select id="pTeam">
              <option value="A">A팀</option>
              <option value="B">B팀</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="pHp">체력(최대 100)</label>
            <input id="pHp" type="number" min="1" max="100" value="100" />
          </div>
          <div class="field">
            <label>아바타</label>
            <div class="preview-wrap">
              <div id="preview" class="preview">미리보기</div>
              <input id="pAvatar" type="file" accept="image/*" />
            </div>
          </div>
        </div>

        <div class="title" style="margin-top:12px;">스탯 (각 1~5)</div>
        <div class="row-4">
          <div class="field">
            <label for="sAtk">공격</label>
            <input id="sAtk" type="number" min="1" max="5" value="3" />
          </div>
          <div class="field">
            <label for="sDef">방어</label>
            <input id="sDef" type="number" min="1" max="5" value="3" />
          </div>
          <div class="field">
            <label for="sAgi">민첩</label>
            <input id="sAgi" type="number" min="1" max="5" value="3" />
          </div>
          <div class="field">
            <label for="sLuk">행운</label>
            <input id="sLuk" type="number" min="1" max="5" value="2" />
          </div>
        </div>

        <div class="title" style="margin-top:12px;">시작 아이템</div>
        <div class="row-3">
          <div class="field">
            <label for="iDit">디터니</label>
            <input id="iDit" type="number" min="0" max="99" value="1" />
          </div>
          <div class="field">
            <label for="iAtkB">공격 보정기</label>
            <input id="iAtkB" type="number" min="0" max="99" value="0" />
          </div>
          <div class="field">
            <label for="iDefB">방어 보정기</label>
            <input id="iDefB" type="number" min="0" max="99" value="0" />
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="btn" id="btnAdd" disabled>전투 참가자 추가</button>
          <span></span>
        </div>

        <div class="title" style="margin-top:16px;">팀 로스터</div>
        <div class="row">
          <div>
            <div style="font-size:12px; color:var(--text-muted); margin:6px 0;">A팀</div>
            <table id="listA">
              <thead>
                <tr>
                  <th>이름</th><th>HP</th><th>스탯</th><th>아이템</th><th>상태</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="5" style="text-align:center; color:var(--text-muted);">없음</td></tr>
              </tbody>
            </table>
          </div>
          <div>
            <div style="font-size:12px; color:var(--text-muted); margin:6px 0;">B팀</div>
            <table id="listB">
              <thead>
                <tr>
                  <th>이름</th><th>HP</th><th>스탯</th><th>아이템</th><th>상태</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="5" style="text-align:center; color:var(--text-muted);">없음</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- 우: 로그/채팅 -->
      <section class="card">
        <div class="title">실시간 로그</div>
        <div id="log" class="log"></div>

        <div class="title" style="margin-top:14px;">채팅</div>
        <div id="chat" class="chat"></div>
        <div class="chat-input">
          <input id="chatMsg" type="text" placeholder="관리자 메시지 입력" />
          <button id="btnSend" class="btn">전송</button>
        </div>
      </section>
    </div>
  </main>

  <div id="toast" class="toast">완료</div>

  <!-- Socket.IO (서버에서 제공) -->
  <script src="/socket.io/socket.io.js"></script>

  <!-- 공용 효과 스크립트 (필수) -->
  <script src="/assets/js/effects.js"></script>

  <!-- 관리자 콘솔 로직 (인라인) -->
  <script>
  (function(){
    "use strict";

    var $ = function(id){ return document.getElementById(id); };

    var els = {
      // meta
      metaStatus: $('metaStatus'),
      metaMode:   $('metaMode'),
      metaId:     $('metaId'),
      connDot:    $('connDot'),
      // control
      mode: $('mode'),
      btnCreate: $('btnCreate'),
      btnStart:  $('btnStart'),
      btnPause:  $('btnPause'),
      btnResume: $('btnResume'),
      btnEnd:    $('btnEnd'),
      // links
      btnGenPlayer:    $('btnGenPlayer'),
      btnGenSpectator: $('btnGenSpectator'),
      spectatorOtp:    $('spectatorOtp'),
      btnBuildSpectator:$('btnBuildSpectator'),
      spectatorUrl:    $('spectatorUrl'),
      playerLinks:     $('playerLinks'),
      // add player
      pName: $('pName'),
      pTeam: $('pTeam'),
      pHp:   $('pHp'),
      sAtk:  $('sAtk'),
      sDef:  $('sDef'),
      sAgi:  $('sAgi'),
      sLuk:  $('sLuk'),
      iDit:  $('iDit'),
      iAtkB: $('iAtkB'),
      iDefB: $('iDefB'),
      pAvatar: $('pAvatar'),
      preview: $('preview'),
      btnAdd:  $('btnAdd'),
      // lists
      listA: $('listA').querySelector('tbody'),
      listB: $('listB').querySelector('tbody'),
      // comms
      log: $('log'),
      chat: $('chat'),
      chatMsg: $('chatMsg'),
      btnSend: $('btnSend'),
      // toast
      toast: $('toast')
    };

    var socket = null;
    var battleId = null;
    var lastSnap = null;

    function toast(msg){
      var t = els.toast;
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(function(){ t.classList.remove('show'); }, 1600);
    }
    function setConn(on){ els.connDot.classList.toggle('ok', !!on); }
    function log(kind, msg){
      var d = document.createElement('div');
      d.className = kind || '';
      d.textContent = msg;
      els.log.appendChild(d);
      els.log.scrollTop = els.log.scrollHeight;
    }
    function chatAppend(sender, text){
      var d = document.createElement('div');
      d.textContent = (sender? sender + ': ':'') + text;
      els.chat.appendChild(d);
      els.chat.scrollTop = els.chat.scrollHeight;
    }
    function esc(s){ return String(s||''); }
    function clamp(n,lo,hi){ n=+n||0; return Math.max(lo, Math.min(hi, n)); }
    function toAB(team){
      var s = String(team||'').toLowerCase();
      if (s==='a'||s==='phoenix') return 'A';
      if (s==='b'||s==='eaters'||s==='death') return 'B';
      return 'A';
    }

    // UI state
    function renderMeta(snap){
      if (!snap){ els.metaStatus.textContent='대기중'; els.metaMode.textContent='-'; els.metaId.textContent='-'; return; }
      var st = snap.status || 'waiting';
      els.metaStatus.textContent =
        st==='waiting' ? '대기중' :
        st==='active'  ? '진행중' :
        st==='paused'  ? '일시정지' : '종료';
      els.metaMode.textContent = snap.mode || '-';
      els.metaId.textContent   = snap.id || '-';

      els.btnStart.disabled  = !(st==='waiting' || st==='paused');
      els.btnPause.disabled  = !(st==='active');
      els.btnResume.disabled = !(st==='paused');
      els.btnEnd.disabled    = (st==='ended');

      var linkEnabled = !!battleId && st!=='ended';
      els.btnGenPlayer.disabled    = !linkEnabled;
      els.btnGenSpectator.disabled = !linkEnabled;
      els.btnBuildSpectator.disabled = !linkEnabled;
      els.btnAdd.disabled = !linkEnabled;
    }

    function renderLists(snap){
      var players = snap && snap.players || [];
      var A = players.filter(function(p){ return toAB(p.team)==='A'; });
      var B = players.filter(function(p){ return toAB(p.team)==='B'; });

      function row(p){
        var maxHp = p.maxHp==null? 100 : p.maxHp;
        var st = p.stats || {};
        var it = p.items || {};
        var tr = document.createElement('tr');
        tr.innerHTML =
          '<td>'+esc(p.name)+'</td>'+
          '<td>'+esc(p.hp)+'/'+esc(maxHp)+'</td>'+
          '<td>공 '+esc(st.attack)+' · 방 '+esc(st.defense)+' · 민 '+esc(st.agility)+' · 운 '+esc(st.luck)+'</td>'+
          '<td>디터니 '+esc(it.dittany||0)+' · 공보 '+esc(it.attack_boost||0)+' · 방보 '+esc(it.defense_boost||0)+'</td>'+
          '<td>'+(p.ready?'준비':'-')+'</td>';
        return tr;
      }

      els.listA.innerHTML = '';
      if (A.length===0){ var e=document.createElement('tr'); e.innerHTML='<td colspan="5" style="text-align:center; color:var(--text-muted);">없음</td>'; els.listA.appendChild(e); }
      else { A.forEach(function(p){ els.listA.appendChild(row(p)); }); }

      els.listB.innerHTML = '';
      if (B.length===0){ var f=document.createElement('tr'); f.innerHTML='<td colspan="5" style="text-align:center; color:var(--text-muted);">없음</td>'; els.listB.appendChild(f); }
      else { B.forEach(function(p){ els.listB.appendChild(row(p)); }); }
    }

    // connect
    function bindSocket(){
      if (!socket) return;
      socket.on('connect', function(){ setConn(true); log('sys','소켓 연결 성공'); });
      socket.on('disconnect', function(){ setConn(false); log('sys','소켓 연결 해제'); });

      ['battleUpdate','battle:update','battleState','state:update'].forEach(function(ev){
        socket.on(ev, onBattleUpdate);
      });

      socket.on('battle:created', function(b){ onBattleUpdate(b); });
      socket.on('admin:created', function(payload){ if (payload&&payload.battle) onBattleUpdate(payload.battle); });

      socket.on('battleLog', function(m){ log('adm', typeof m==='string'? m : (m&&m.message||JSON.stringify(m))); });
      socket.on('battle:log', function(payload){ log('adm', payload&&payload.message||''); });

      socket.on('chatMessage', function(payload){
        if (typeof payload==='string'){ chatAppend('플레이어', payload); return; }
        chatAppend(payload.name||payload.senderName||'플레이어', payload.message||'');
      });
      socket.on('chat:message', function(payload){ chatAppend(payload.name||payload.senderName||'플레이어', payload.message||''); });
      socket.on('battle:chat', function(payload){ chatAppend(payload.name||'플레이어', payload.message||''); });
    }

    function connect(){
      try{
        socket = io(window.location.origin, {
          path: '/socket.io',
          transports: ['websocket','polling'],
          reconnection:true, reconnectionAttempts:12, reconnectionDelay:400, reconnectionDelayMax:3000,
          query:{ role:'admin' }
        });
        bindSocket();
      }catch(e){
        log('err','소켓 생성 실패: '+(e&&e.message||e));
      }
    }

    // events
    function onBattleUpdate(snap){
      if (!snap) return;
      lastSnap = snap;
      battleId = snap.id || battleId;
      renderMeta(snap);
      renderLists(snap);
    }

    // controls
    function createBattle(){
      if (!socket || !socket.connected){ log('err','연결 후 시도하세요'); return; }
      var mode = els.mode.value || '4v4';
      var payload = { mode: mode };
      log('sys', '전투 생성 요청: '+mode);

      var ack = function(res){
        if (!res){ log('err','ACK 없음'); return; }
        if (res.error||res.err){ log('err','오류: '+(res.error||res.err)); return; }
        var b = res.battle || res;
        if (b && (b.id||b.battleId)){
          battleId = b.id||b.battleId;
          socket.emit('join', { battleId: battleId });
          onBattleUpdate(b);
          els.btnAdd.disabled=false;
          els.btnGenPlayer.disabled=false;
          els.btnGenSpectator.disabled=false;
          els.btnBuildSpectator.disabled=false;
          toast('전투가 생성되었습니다');
        }
      };
      try{ socket.emit('createBattle', payload, ack); }catch(e){}
      try{ socket.emit('battle:create', payload, ack); }catch(e){}
      try{ socket.emit('admin:createBattle', payload, ack); }catch(e){}
    }

    function adminAction(kind){
      if (!battleId){ toast('전투 생성부터 진행하세요'); return; }
      if (!socket || !socket.connected){ toast('연결을 확인하세요'); return; }
      var ch = { battleId: battleId };
      if (kind==='start'){ socket.emit('startBattle', ch); socket.emit('battle:start', ch); }
      if (kind==='pause'){ socket.emit('pauseBattle', ch); socket.emit('battle:pause', ch); }
      if (kind==='resume'){ socket.emit('resumeBattle',ch); socket.emit('battle:resume', ch); }
      if (kind==='end'){   socket.emit('endBattle',   ch); socket.emit('battle:end',    ch); }
    }

    function validatePlayer(){
      var name = (els.pName.value||'').trim();
      if (!name){ toast('이름을 입력하세요'); els.pName.focus(); return {ok:false}; }

      var hp   = clamp(els.pHp.value, 1, 100);
      var atk  = clamp(els.sAtk.value,1,5);
      var def  = clamp(els.sDef.value,1,5);
      var agi  = clamp(els.sAgi.value,1,5);
      var luk  = clamp(els.sLuk.value,1,5);

      return { ok:true, name:name, hp:hp, atk:atk, def:def, agi:agi, luk:luk };
    }

    async function uploadAvatar(file){
      if (!file) return '';
      var okTypes = ['image/png','image/jpeg','image/gif','image/webp'];
      if (okTypes.indexOf(file.type)===-1){ log('err','지원하지 않는 이미지 형식'); return ''; }
      var fd = new FormData(); fd.append('avatar', file, file.name);
      try{
        var r = await fetch('/api/upload/avatar', { method:'POST', body:fd, credentials:'include' });
        var txt = await r.text();
        if (!r.ok){ log('err','아바타 업로드 실패: '+r.status+' '+txt); return ''; }
        var j = {}; try{ j = JSON.parse(txt); }catch(_){}
        var url = j.url||j.imageUrl||j.avatarUrl||j.fileUrl;
        var path = j.path||j.publicPath;
        var fname = j.filename||j.fileName;
        var resolved = '';
        if (url) resolved = new URL(url, window.location.origin).toString();
        else if (path) resolved = new URL(path, window.location.origin).toString();
        else if (fname) resolved = new URL('/uploads/'+fname, window.location.origin).toString();
        return resolved || '';
      }catch(e){
        log('err','아바타 업로드 예외: '+(e&&e.message||e));
        return '';
      }
    }

    async function addPlayer(){
      if (!battleId){ toast('전투 생성부터 진행하세요'); return; }
      if (!socket || !socket.connected){ toast('연결을 확인하세요'); return; }

      var v = validatePlayer(); if (!v.ok) return;

      var avatarUrl = '';
      var file = els.pAvatar.files && els.pAvatar.files[0];
      if (file){
        var u = await uploadAvatar(file);
        if (!u) log('err','아바타 업로드 실패: 업로드 실패. 아바타 없이 진행합니다.');
        else avatarUrl = u;
      }

      var player = {
        name: v.name,
        team: els.pTeam.value,            // A/B 고정
        hp: v.hp, maxHp: 100,
        stats: { attack:v.atk, defense:v.def, agility:v.agi, luck:v.luk },
        items: {
          dittany:       clamp(els.iDit.value, 0, 99),
          attack_boost:  clamp(els.iAtkB.value, 0, 99),
          defense_boost: clamp(els.iDefB.value, 0, 99)
        },
        avatar: avatarUrl
      };

      var payload = { battleId:battleId, player:player };

      var ack = function(res){
        if (!res){ log('err','참가자 추가 ACK 없음'); return; }
        if (res.error||res.err){ log('err','오류: '+(res.error||res.err)); return; }
        var b = res.battle || null;
        if (b){ onBattleUpdate(b); toast('참가자 추가 완료'); }
      };

      try{ socket.emit('addPlayer', payload, ack); }catch(e){}
      try{ socket.emit('admin:addPlayer', payload, ack); }catch(e){}

      // 폼 리셋
      els.pName.value='';
      els.pAvatar.value='';
      resetPreview();
    }

    function resetPreview(){
      els.preview.style.backgroundImage='none';
      els.preview.textContent='미리보기';
    }
    function onPreview(){
      var f = els.pAvatar.files && els.pAvatar.files[0];
      if (!f){ resetPreview(); return; }
      var ok = ['image/png','image/jpeg','image/gif','image/webp'];
      if (ok.indexOf(f.type)===-1){ toast('지원하지 않는 이미지 형식'); els.pAvatar.value=''; resetPreview(); return; }
      var r = new FileReader();
      r.onload = function(){ els.preview.style.backgroundImage = "url('"+r.result+"')"; els.preview.textContent=''; };
      r.readAsDataURL(f);
    }

    async function genPlayerLinks(){
      if (!battleId){ toast('전투 생성 후 이용'); return; }
      try{
        var res = await fetch('/api/admin/battles/'+battleId+'/links', { method:'POST', credentials:'include' });
        if (!res.ok){ res = await fetch('/api/battles/'+battleId+'/links', { method:'POST', credentials:'include' }); }
        if (!res.ok) throw new Error('링크 생성 실패');
        var data = await res.json();
        var links = data.playerLinks || data.links || [];
        els.playerLinks.innerHTML = '';
        links.forEach(function(ln, i){
          var row = document.createElement('div');
          row.style.display='grid'; row.style.gridTemplateColumns='38px 1fr 72px'; row.style.gap='6px';
          row.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;color:var(--text-muted)">'+(i+1)+'</div>'+
                          '<input type="text" class="mono" value="'+(ln.url||'')+'" readonly />'+
                          '<button class="btn">복사</button>';
          var input = row.querySelector('input');
          row.querySelector('button').addEventListener('click', function(){ navigator.clipboard.writeText(input.value).then(function(){toast('복사되었습니다');}); });
          els.playerLinks.appendChild(row);
        });
        toast('참가자 링크가 생성되었습니다');
      }catch(e){
        log('err','참가자 링크 생성 실패');
      }
    }

    async function genSpectatorOtp(){
      if (!battleId){ toast('전투 생성 후 이용'); return; }
      try{
        var res = await fetch('/api/admin/battles/'+battleId+'/links', { method:'POST', credentials:'include' });
        if (!res.ok){ res = await fetch('/api/battles/'+battleId+'/links', { method:'POST', credentials:'include' }); }
        if (!res.ok) throw new Error();
        var data = await res.json();
        var otp = data.spectatorOtp || (data.spectator && data.spectator.otp) || data.otp || '';
        els.spectatorOtp.value = otp || '';
        toast('관전자 비밀번호가 발급되었습니다');
      }catch(e){
        log('err','관전자 비밀번호 발급 실패');
      }
    }

    async function buildSpectatorUrl(){
      if (!battleId){ toast('전투 생성 후 이용'); return; }
      var otp = (els.spectatorOtp.value||'').trim();
      if (!otp){ toast('관전자 비밀번호 발급 후 이용'); return; }
      var url = new URL('/spectator.html', window.location.origin);
      url.searchParams.set('battle', battleId);
      url.searchParams.set('otp', otp);
      els.spectatorUrl.value = url.toString();
      try{ await navigator.clipboard.writeText(url.toString()); toast('관전자 URL이 복사되었습니다'); }catch(_){ toast('관전자 URL이 생성되었습니다'); }
    }

    // bindings
    function bind(){
      // control
      els.btnCreate.addEventListener('click', createBattle);
      els.btnStart .addEventListener('click', function(){ adminAction('start'); });
      els.btnPause .addEventListener('click', function(){ adminAction('pause'); });
      els.btnResume.addEventListener('click', function(){ adminAction('resume'); });
      els.btnEnd   .addEventListener('click', function(){ adminAction('end'); });
      // links
      els.btnGenPlayer.addEventListener('click', genPlayerLinks);
      els.btnGenSpectator.addEventListener('click', genSpectatorOtp);
      els.btnBuildSpectator.addEventListener('click', buildSpectatorUrl);
      // players
      els.btnAdd.addEventListener('click', addPlayer);
      els.pAvatar.addEventListener('change', onPreview);
      // chat
      els.btnSend.addEventListener('click', sendChat);
      els.chatMsg.addEventListener('keydown', function(e){
        if (e.key==='Enter'){ e.preventDefault(); sendChat(); }
      });
    }

    function sendChat(){
      var text = (els.chatMsg.value||'').trim();
      if (!text || !battleId) return;
      if (socket && socket.connected){
        var payload = { battleId:battleId, message:text, role:'admin', name:'관리자' };
        socket.emit('chatMessage', payload);
        socket.emit('chat:send', payload);
      }
      chatAppend('관리자', text);
      els.chatMsg.value='';
    }

    // init
    bind();
    connect();
    log('sys','관리자 콘솔이 시작되었습니다.');
  })();
  </script>
</body>
</html>
