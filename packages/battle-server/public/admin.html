<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>PYXIS - ì „íˆ¬ ê´€ë¦¬ì</title>
<script src="/socket.io/socket.io.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#0e0e0e; --bg2:#141414;
    --glass-1:rgba(0,0,0,.7); --glass-2:rgba(0,0,0,.5);
    --border:rgba(220,199,162,.3);
    --text:#F8F9FA; --muted:#A9AFB6;
    --gold:#DCC7A2; --gold2:#E6D2A8;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --shadow:0 10px 30px rgba(0,0,0,.45);
    /* íŒ€ë³„ ì»¬ëŸ¬ ì •ì˜ - ì±„ë„ ë‚®ì€ ìƒ‰ìƒ */
    --team-a-color:#8b5757; /* ì±„ë„ ë‚®ì€ ë¹¨ê°„ìƒ‰ */
    --team-b-color:#5d6b8d; /* ì±„ë„ ë‚®ì€ íŒŒë€ìƒ‰ */
    --result-bg:#DCC7A2;    /* ê¸ˆìƒ‰ ë°°ê²½ */
    --result-text:#000;     /* ê²€ì€ ê¸€ì */
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:linear-gradient(135deg,#000813,#001122);color:var(--text);font-family:system-ui,-apple-system,sans-serif;min-height:100vh;padding:8px}
  body.battle-ended{overflow:hidden}
  .container{max-width:1400px;margin:0 auto}
  .header{text-align:center;padding:16px;font-family:Cinzel,serif;color:var(--gold);font-size:24px;letter-spacing:.1em}
  .main-grid{display:grid;gap:12px;grid-template-columns:1fr;}
  @media (min-width:768px){ .main-grid{grid-template-columns:1fr 2fr 1fr;} }
  .card{background:var(--glass-1);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:var(--shadow)}
  .title{font-family:Cinzel,serif;color:var(--gold);font-weight:700;letter-spacing:.08em;margin-bottom:8px;font-size:14px}

  /* ì „íˆ¬ ì œì–´ */
  .control-section{background:var(--glass-2);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:12px}
  .control-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:12px}
  .control-grid.single{grid-template-columns:1fr}
  .control-btn{background:var(--glass-1);color:var(--text);border:1px solid var(--border);padding:8px 12px;border-radius:6px;font-size:12px;cursor:pointer;transition:all .2s;font-weight:600}
  .control-btn:hover:not(:disabled){background:var(--gold2);color:#000}
  .control-btn:disabled{opacity:.4;cursor:not-allowed}
  .control-btn.primary{background:var(--gold);color:#000}
  .control-btn.primary:hover:not(:disabled){background:var(--gold2)}
  .control-btn.danger{background:var(--bad);color:#fff}
  .control-btn.danger:hover:not(:disabled){background:#dc2626}

  /* ì „íˆ¬ ì°¸ê°€ì ê´€ë¦¬ */
  .player-form{background:var(--glass-2);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:12px}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
  .form-field{margin-bottom:8px}
  .form-label{color:var(--gold);font-size:11px;margin-bottom:2px;display:block;font-weight:600}
  .form-input,.form-select{width:100%;background:var(--glass-2);border:1px solid var(--border);color:var(--text);padding:6px 8px;border-radius:4px;font-size:11px}
  .form-input:focus,.form-select:focus{outline:none;border-color:var(--gold)}
  .upload-row{display:flex;align-items:center;gap:8px}
  .upload-btn{background:var(--glass-1);color:var(--text);border:1px solid var(--border);padding:6px 12px;border-radius:4px;font-size:10px;cursor:pointer}
  .upload-btn:hover{background:var(--gold2);color:#000}
  .avatar-preview{width:28px;height:28px;border-radius:6px;border:1px solid var(--border);object-fit:cover;background:#000;display:inline-block}

  /* íŒ€ ëª©ë¡ */
  .team-container{background:var(--glass-1);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:var(--shadow);height:fit-content}
  .team-title{font-family:Cinzel,serif;color:var(--gold);font-weight:700;letter-spacing:.08em;margin-bottom:12px;font-size:16px;text-align:center}
  .player-card{background:var(--glass-2);border:1px solid var(--border);border-radius:8px;padding:8px;margin-bottom:8px;display:flex;align-items:center;gap:8px}
  .player-card.dead{opacity:.5}
  .player-avatar{width:32px;height:32px;border-radius:50%;object-fit:cover;border:1px solid var(--gold)}
  .player-info{flex:1;min-width:0}
  .player-name{font-size:12px;font-weight:600;color:var(--gold);margin-bottom:2px}
  .hp{height:6px;background:#0b0b0b;border:1px solid var(--border);border-radius:999px;overflow:hidden;margin-bottom:2px}
  .hp>span{display:block;height:100%;background:linear-gradient(90deg,#4ade80,#22c55e);transition:width .3s}
  .hp-text{font-size:10px;color:var(--muted);margin-bottom:2px}
  .stats{font-size:10px;color:var(--muted)}
  .items-info{font-size:9px;color:var(--text);margin-top:2px}
  .ready-status{font-size:9px;color:var(--gold);margin-top:2px}
  .remove-btn{background:var(--bad);color:#fff;border:none;padding:4px 8px;border-radius:4px;font-size:10px;cursor:pointer;margin-top:4px}
  .remove-btn:hover{background:#dc2626}

  /* ë§í¬ ìƒì„± */
  .links-section{background:var(--glass-2);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:12px}
  .links-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:12px}
  .link-item{background:var(--glass-1);border:1px solid var(--border);border-radius:6px;padding:8px;margin-bottom:6px}
  .link-label{color:var(--gold);font-size:10px;margin-bottom:4px;font-weight:600}
  .link-url{background:var(--glass-2);border:1px solid var(--border);color:var(--text);padding:4px 6px;border-radius:4px;font-size:9px;word-break:break-all;margin-bottom:4px;cursor:pointer}
  .link-url:hover{background:var(--gold2);color:#000}
  .copy-btn{background:var(--ok);color:#fff;border:none;padding:3px 6px;border-radius:3px;font-size:9px;cursor:pointer}
  .copy-btn:hover{background:#16a34a}

  /* ë¡œê·¸ì™€ ì±„íŒ… */
  .logs-section{height:300px;overflow-y:auto;background:var(--glass-2);border:1px solid var(--border);padding:8px;border-radius:8px;margin-bottom:12px}
  .chat-section{height:200px;overflow-y:auto;background:var(--glass-2);border:1px solid var(--border);padding:8px;border-radius:8px;margin-bottom:8px}
  .log-item{margin-bottom:4px;font-size:11px;line-height:1.4;padding:2px 4px;border-radius:4px}
  .log-time{color:var(--muted);font-weight:normal}
  .chat-item{margin-bottom:4px;font-size:11px}
  .chat-name{color:var(--gold);font-weight:600}
  .input-group{display:flex;gap:4px}
  .chat-input{flex:1;background:var(--glass-2);border:1px solid var(--border);color:var(--text);padding:6px 8px;border-radius:6px;font-size:11px}
  .send-btn{background:var(--gold);color:#000;border:none;padding:6px 12px;border-radius:6px;font-size:11px;cursor:pointer;font-weight:600}

  /* ë¡œê·¸ ë¶„ë¥˜ ìŠ¤íƒ€ì¼ */
  .log-team-a{background-color:var(--team-a-color);color:var(--text)}
  .log-team-b{background-color:var(--team-b-color);color:var(--text)}
  .log-result{background-color:var(--result-bg);color:var(--result-text)}
  .log-notice{background-color:var(--glass-1);color:var(--gold)}
  .log-error{background-color:#000;color:var(--gold)}
  .log-system{background-color:transparent;color:var(--muted)}

  /* ê²Œì„ ì¢…ë£Œ ì˜¤ë²„ë ˆì´ */
  .game-over-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;z-index:9999;opacity:0;visibility:hidden;transition:all .3s}
  .game-over-overlay.show{opacity:1;visibility:visible}
  .game-over-content{text-align:center;background:var(--glass-1);border:2px solid var(--gold);border-radius:16px;padding:32px;max-width:400px;width:90%}
  .game-over-title{font-family:Cinzel,serif;font-size:28px;color:var(--gold);margin-bottom:16px}
  .winner-announcement{font-size:20px;margin-bottom:16px}
  .winner-team{color:var(--gold);font-weight:700;font-size:24px}
  .admin-message{color:var(--muted);font-size:14px;margin-bottom:16px}
  .restart-btn{background:var(--gold);color:#000;border:none;padding:12px 24px;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px}
  .restart-btn:hover{background:var(--gold2)}

  @media (max-width:767px){
    .main-grid{grid-template-columns:1fr}
    .control-grid{grid-template-columns:1fr}
    .form-grid{grid-template-columns:1fr}
    .links-grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">PYXIS ì „íˆ¬ ê´€ë¦¬ì</div>

  <div class="main-grid">
    <!-- ì¢Œì¸¡: ì „íˆ¬ ì œì–´ + ë§í¬ ìƒì„± -->
    <div>
      <!-- ì „íˆ¬ ì œì–´ -->
      <div class="card">
        <div class="title">ì „íˆ¬ ì œì–´</div>
        <div class="control-section">
          <div class="form-field">
            <label class="form-label">ì „íˆ¬ ëª¨ë“œ</label>
            <select id="battleMode" class="form-select">
              <option value="1v1">1v1</option>
              <option value="2v2" selected>2v2</option>
              <option value="3v3">3v3</option>
              <option value="4v4">4v4</option>
            </select>
          </div>
          <div class="control-grid single">
            <button id="btnCreate" class="control-btn primary">ì „íˆ¬ ìƒì„±</button>
          </div>
          <div class="control-grid">
            <button id="btnStart" class="control-btn" disabled>ì‹œì‘</button>
            <button id="btnPause" class="control-btn" disabled>ì¼ì‹œì •ì§€</button>
            <button id="btnResume" class="control-btn" disabled>ì¬ê°œ</button>
            <button id="btnEnd" class="control-btn danger" disabled>ì¢…ë£Œ</button>
          </div>
        </div>
      </div>

      <!-- ë§í¬ ìƒì„± -->
      <div class="card">
        <div class="title">ë§í¬ ìƒì„±</div>
        <div class="links-section">
          <div class="links-grid">
            <button id="btnGenPlayerLinks" class="control-btn">ì°¸ê°€ì ë§í¬</button>
            <button id="btnGenSpectatorLink" class="control-btn">ê´€ì „ì ë§í¬</button>
          </div>
          <div id="linksContainer"></div>
        </div>
      </div>
    </div>

    <!-- ì¤‘ì•™: ì „íˆ¬ ì°¸ê°€ì ê´€ë¦¬ + íŒ€ ëª©ë¡ -->
    <div>
      <!-- ì „íˆ¬ ì°¸ê°€ì ê´€ë¦¬ -->
      <div class="card">
        <div class="title">ì „íˆ¬ ì°¸ê°€ì ì¶”ê°€</div>
        <div class="player-form">
          <div class="form-grid">
            <div class="form-field">
              <label class="form-label">ì´ë¦„</label>
              <input id="playerName" class="form-input" type="text" placeholder="ì´ë¦„ ì…ë ¥"/>
            </div>
            <div class="form-field">
              <label class="form-label">íŒ€</label>
              <select id="playerTeam" class="form-select">
                <option value="A">AíŒ€</option>
                <option value="B">BíŒ€</option>
              </select>
            </div>
          </div>
          <div class="form-grid">
            <div class="form-field">
              <label class="form-label">HP</label>
              <input id="playerHP" class="form-input" type="number" value="100" min="1" max="1000"/>
            </div>
            <div class="form-field">
              <label class="form-label">ì´ë¯¸ì§€ ì—…ë¡œë“œ</label>
              <div class="upload-row">
                <input id="avatarUpload" type="file" accept="image/*" style="display:none"/>
                <button class="upload-btn" id="avatarPickBtn" type="button">ì´ë¯¸ì§€ ì„ íƒ</button>
                <!-- ğŸ”¹ ë¯¸ë¦¬ë³´ê¸°(ì‘ì€ ì‚¬ê°í˜•) -->
                <img id="avatarPreview" class="avatar-preview" alt="ë¯¸ë¦¬ë³´ê¸°"/>
              </div>
            </div>
          </div>
          <div class="form-grid">
            <div class="form-field">
              <label class="form-label">ê³µê²©ë ¥ (1-5)</label>
              <input id="playerAttack" class="form-input" type="number" value="1" min="1" max="5"/>
            </div>
            <div class="form-field">
              <label class="form-label">ë°©ì–´ë ¥ (1-5)</label>
              <input id="playerDefense" class="form-input" type="number" value="1" min="1" max="5"/>
            </div>
            <div class="form-field">
              <label class="form-label">ë¯¼ì²©ì„± (1-5)</label>
              <input id="playerAgility" class="form-input" type="number" value="1" min="1" max="5"/>
            </div>
            <div class="form-field">
              <label class="form-label">í–‰ìš´ (1-5)</label>
              <input id="playerLuck" class="form-input" type="number" value="1" min="1" max="5"/>
            </div>
          </div>
          <div class="form-grid">
            <div class="form-field">
              <label class="form-label">ë””í„°ë‹ˆ</label>
              <input id="playerDittany" class="form-input" type="number" value="0" min="0" max="10"/>
            </div>
            <div class="form-field">
              <label class="form-label">ê³µê²© ë³´ì •ê¸°</label>
              <input id="playerAttackBooster" class="form-input" type="number" value="0" min="0" max="10"/>
            </div>
            <div class="form-field">
              <label class="form-label">ë°©ì–´ ë³´ì •ê¸°</label>
              <input id="playerDefenseBooster" class="form-input" type="number" value="0" min="0" max="10"/>
            </div>
          </div>
          <button id="btnAddPlayer" class="control-btn primary" style="width:100%">ì „íˆ¬ ì°¸ê°€ì ì¶”ê°€</button>
        </div>
      </div>

      <!-- AíŒ€ ëª©ë¡ -->
      <div class="team-container" style="margin-bottom:12px">
        <div class="team-title">AíŒ€</div>
        <div id="teamA"></div>
      </div>

      <!-- BíŒ€ ëª©ë¡ -->
      <div class="team-container">
        <div class="team-title">BíŒ€</div>
        <div id="teamB"></div>
      </div>
    </div>

    <!-- ìš°ì¸¡: ì‹¤ì‹œê°„ ë¡œê·¸ + ì±„íŒ… -->
    <div>
      <div class="card">
        <div class="title">ì‹¤ì‹œê°„ ë¡œê·¸</div>
        <div class="logs-section" id="logPanel"></div>
      </div>

      <div class="card">
        <div class="title">ì±„íŒ…</div>
        <div class="chat-section" id="chatPanel"></div>
        <div class="input-group">
          <input class="chat-input" id="chatInput" type="text" placeholder="ë©”ì‹œì§€ ì…ë ¥..."/>
          <button class="send-btn" id="chatSend" type="button">ì „ì†¡</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ê²Œì„ ì¢…ë£Œ ì˜¤ë²„ë ˆì´ -->
<div id="gameOverOverlay" class="game-over-overlay">
  <div class="game-over-content">
    <div class="game-over-title">ì „íˆ¬ ì¢…ë£Œ</div>
    <div class="winner-announcement">
      <span id="winnerTeam" class="winner-team"></span> ìŠ¹ë¦¬!
    </div>
    <div class="admin-message">ì „íˆ¬ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</div>
    <button id="restartBtn" class="restart-btn">ìƒˆ ì „íˆ¬ ì‹œì‘</button>
  </div>
</div>

<script>
(() => {
  const socket = io();
  window.socket = socket;

  const logPanel = document.getElementById('logPanel');
  const chatPanel = document.getElementById('chatPanel');

  let currentBattleId = null;
  let battleState = null;
  let uploadedAvatarUrl = null;

  function esc(s){ return s ? String(s).replace(/</g,'&lt;').replace(/>/g,'&gt;') : ''; }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° (ìš”ì²­ì‚¬í•­) â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const avatarUpload = document.getElementById('avatarUpload');
  const avatarPickBtn = document.getElementById('avatarPickBtn');
  const avatarPreview = document.getElementById('avatarPreview');
  avatarPickBtn.addEventListener('click', () => avatarUpload.click());
  avatarUpload.addEventListener('change', (e) => {
    const f = e.target.files && e.target.files[0];
    if (!f) { avatarPreview.removeAttribute('src'); return; }
    const reader = new FileReader();
    reader.onload = () => { avatarPreview.src = reader.result; };
    reader.readAsDataURL(f);
    // ì„œë²„ ì—…ë¡œë“œ
    uploadAvatar(f);
  });

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ê²Œì„ ì¢…ë£Œ ì˜¤ë²„ë ˆì´ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function showGameOverOverlay(winner){
    const overlay=document.getElementById('gameOverOverlay');
    const winnerTeam=document.getElementById('winnerTeam');
    winnerTeam.textContent = winner + 'íŒ€';
    overlay.classList.add('show');
    document.body.classList.add('battle-ended');
  }
  function hideGameOverOverlay(){
    const overlay=document.getElementById('gameOverOverlay');
    overlay.classList.remove('show');
    document.body.classList.remove('battle-ended');
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ íŒ€ ë Œë”ë§ (ì›ë³¸ ìœ ì§€) â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function renderTeams(){
    if(!battleState?.players) return;
    const teamA = battleState.players.filter(p=>p.team==='A');
    const teamB = battleState.players.filter(p=>p.team==='B');

    function renderTeam(players, containerId){
      let html = '';
      players.forEach(p=>{
        const hpPct = Math.max(0, p.hp/(p.maxHp||100)*100);
        const isAlive = p.hp > 0;
        const readyStatus = p.ready ? 'ì¤€ë¹„ì™„ë£Œ' : 'ëŒ€ê¸°ì¤‘';
        const items=[];
        if((p.items?.dittany || p.items?.ditany) > 0) items.push(`ë””í„°ë‹ˆ ${p.items?.dittany || p.items?.ditany}`);
        if((p.items?.attackBooster || p.items?.attack_boost) > 0) items.push(`ê³µê²©ë³´ì • ${p.items?.attackBooster || p.items?.attack_boost}`);
        if((p.items?.defenseBooster || p.items?.defense_boost) > 0) items.push(`ë°©ì–´ë³´ì • ${p.items?.defenseBooster || p.items?.defense_boost}`);

        html += '<div class="player-card ' + (isAlive ? '' : 'dead') + '">' +
          '<img src="' + (p.avatar || 'data:image/svg+xml,<svg width=\'32\' height=\'32\' xmlns=\'http://www.w3.org/2000/svg\'><circle cx=\'16\' cy=\'16\' r=\'14\' fill=\'%23DCC7A2\' stroke=\'%23000\' stroke-width=\'2\'/><text x=\'16\' y=\'20\' text-anchor=\'middle\' fill=\'%23000\' font-size=\'12\'>?</text></svg>') + '" class="player-avatar" alt="' + esc(p.name) + '" onerror="this.src=\'data:image/svg+xml,<svg width=\\'32\\' height=\\'32\\' xmlns=\\'http://www.w3.org/2000/svg\\'><circle cx=\\'16\\' cy=\\'16\\' r=\\'14\\' fill=\\'%23DCC7A2\\' stroke=\\'%23000\\' stroke-width=\\'2\\'/><text x=\\'16\\' y=\\'20\\' text-anchor=\\'middle\\' fill=\\'%23000\\' font-size=\\'12\\'>?</text></svg>\'"/>' +
          '<div class="player-info">' +
            '<div class="player-name">' + esc(p.name) + '</div>' +
            '<div class="hp"><span style="width:' + hpPct + '%"></span></div>' +
            '<div class="hp-text">HP ' + p.hp + '/' + (p.maxHp||100) + '</div>' +
            '<div class="stats">ê³µ' + (p.stats && p.stats.attack || 0) + ' ë°©' + (p.stats && p.stats.defense || 0) + ' ë¯¼' + (p.stats && p.stats.agility || 0) + ' í–‰' + (p.stats && p.stats.luck || 0) + '</div>' +
            '<div class="items-info">' + (items.length ? items.join(', ') : 'ì•„ì´í…œ ì—†ìŒ') + '</div>' +
            '<div class="ready-status">' + readyStatus + '</div>' +
            '<button class="remove-btn" onclick="removePlayer(\'' + p.id + '\')">ì œê±°</button>' +
          '</div>' +
        '</div>';
      });
      document.getElementById(containerId).innerHTML = html;
    }
    renderTeam(teamA,'teamA');
    renderTeam(teamB,'teamB');
  }

  function updateBattleControls(){
    const btnStart=document.getElementById('btnStart');
    const btnPause=document.getElementById('btnPause');
    const btnResume=document.getElementById('btnResume');
    const btnEnd=document.getElementById('btnEnd');
    if(!battleState){
      [btnStart,btnPause,btnResume,btnEnd].forEach(b=>b && (b.disabled=true));
      return;
    }
    const st=battleState.status;
    if(btnStart) btnStart.disabled = st!=='waiting';
    if(btnPause) btnPause.disabled = st!=='active';
    if(btnResume) btnResume.disabled = st!=='paused';
    if(btnEnd) btnEnd.disabled = st==='ended';
  }
  function render(){ renderTeams(); updateBattleControls(); }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë¡œê·¸/ì±„íŒ… (ì¤‘ë³µ í•„í„° ì œê±°: í‘œì‹œ ìš°ì„ ) â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function getLogClass(message, type){
    if(type==='battle' || type==='item'){
      if(message.includes('A1')||message.includes('A2')||message.includes('A3')||message.includes('A4')||
         message.includes('AíŒ€')||message.includes('=== AíŒ€')) return 'log-team-a';
      if(message.includes('B1')||message.includes('B2')||message.includes('B3')||message.includes('B4')||
         message.includes('BíŒ€')||message.includes('=== BíŒ€')) return 'log-team-b';
      if(message.includes('ë¼ìš´ë“œ ì¢…ë£Œ')||message.includes('ìŠ¹ë¦¬')||message.includes('ì „íˆ¬ê°€')||
         message.includes('ê²°ê³¼')||message.includes('===')) return 'log-result';
    }
    if(type==='notice') return 'log-notice';
    if(type==='error') return 'log-error';
    return 'log-system';
  }

  function addChat({name,message}){
    if(!name||!message) return;
    const div=document.createElement('div');
    div.className='chat-item';
    div.innerHTML=`<span class="chat-name">${esc(name)}</span>: ${esc(message)}`;
    chatPanel.appendChild(div);
    chatPanel.scrollTop=chatPanel.scrollHeight;
    while(chatPanel.children.length>100) chatPanel.removeChild(chatPanel.firstChild);
  }

  function addLog({ts,type,message:txt}){
    if(!txt) return;
    const time=new Date(ts).toLocaleTimeString('ko-KR',{hour12:false});
    const div=document.createElement('div');
    div.className=`log-item ${getLogClass(txt,type)}`;
    div.innerHTML=`<span class="log-time">[${time}]</span> ${esc(txt)}`;
    logPanel.appendChild(div);
    logPanel.scrollTop=logPanel.scrollHeight;
    while(logPanel.children.length>500) logPanel.removeChild(logPanel.firstChild);
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì „íˆ¬ ìƒì„±/ì œì–´ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function createBattle(){
    const mode=document.getElementById('battleMode').value;
    socket.emit('createBattle',{mode},(res)=>{
      if(res?.ok){
        currentBattleId = res.battleId || res.battle?.id || null;
        if(!currentBattleId){ alert('ì „íˆ¬ ìƒì„± ì‘ë‹µì— ID ì—†ìŒ'); return; }

        // ìƒíƒœê°€ ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì•ˆì „ ì´ˆê¸°í™”
        battleState = res.battle || { id: currentBattleId, status:'waiting', mode, players:[], logs:[] };
        addLog({ts:Date.now(), type:'notice', message:`${mode} ì „íˆ¬ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤ (ID: ${currentBattleId})`});
        render();

        socket.emit('join',{battleId:currentBattleId},(j)=>{ if(!j?.ok) console.warn('ë°© ì…ì¥ ì‹¤íŒ¨:', j?.error); });
      } else {
        alert('ì „íˆ¬ ìƒì„± ì‹¤íŒ¨: ' + (res?.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      }
    });
  }
  function startBattle(){ if(!currentBattleId) return; socket.emit('startBattle',{battleId:currentBattleId},(r)=>{ if(!r?.ok) alert('ì „íˆ¬ ì‹œì‘ ì‹¤íŒ¨'); }); }
  function pauseBattle(){ if(!currentBattleId) return; socket.emit('pauseBattle',{battleId:currentBattleId},(r)=>{ if(!r?.ok) alert('ì¼ì‹œì •ì§€ ì‹¤íŒ¨'); }); }
  function resumeBattle(){ if(!currentBattleId) return; socket.emit('resumeBattle',{battleId:currentBattleId},(r)=>{ if(!r?.ok) alert('ì¬ê°œ ì‹¤íŒ¨'); }); }
  function endBattle(){
    if(!currentBattleId) return;
    if(!confirm('ì •ë§ ì „íˆ¬ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    socket.emit('endBattle',{battleId:currentBattleId},(r)=>{ if(!r?.ok) alert('ì „íˆ¬ ì¢…ë£Œ ì‹¤íŒ¨'); });
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì—…ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function uploadAvatar(file){
    const formData=new FormData();
    formData.append('avatar',file);
    try{
      const res=await fetch('/api/upload/avatar',{method:'POST',body:formData});
      const json=await res.json();
      if(json.url){
        uploadedAvatarUrl=json.url;
        addLog({ts:Date.now(),type:'notice',message:'ì•„ë°”íƒ€ ì—…ë¡œë“œ ì™„ë£Œ'});
      }else{
        throw new Error(json.error||'ì—…ë¡œë“œ ì‹¤íŒ¨');
      }
    }catch(e){
      alert('ì•„ë°”íƒ€ ì—…ë¡œë“œ ì‹¤íŒ¨: '+e.message);
      uploadedAvatarUrl=null;
    }
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì°¸ê°€ì ì¶”ê°€ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function addPlayer(){
    if(!currentBattleId){ alert('ë¨¼ì € ì „íˆ¬ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”'); return; }
    const name=document.getElementById('playerName').value.trim();
    const team=document.getElementById('playerTeam').value;
    const hp=parseInt(document.getElementById('playerHP').value);
    const attack=parseInt(document.getElementById('playerAttack').value);
    const defense=parseInt(document.getElementById('playerDefense').value);
    const agility=parseInt(document.getElementById('playerAgility').value);
    const luck=parseInt(document.getElementById('playerLuck').value);
    const dittany=parseInt(document.getElementById('playerDittany').value);
    const attackBooster=parseInt(document.getElementById('playerAttackBooster').value);
    const defenseBooster=parseInt(document.getElementById('playerDefenseBooster').value);
    if(!name){ alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

    const playerData={
      name,team,hp,maxHp:hp,
      stats:{attack,defense,agility,luck},
      items:{dittany,attackBooster,defenseBooster},
      avatar:uploadedAvatarUrl
    };

    socket.emit('addPlayer',{battleId:currentBattleId,player:playerData},(res)=>{
      if(res?.ok){
        addLog({ts:Date.now(),type:'notice',message:`${name}ì´(ê°€) ${team}íŒ€ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤`});
        clearPlayerForm();
      }else{
        alert('ì „íˆ¬ ì°¸ê°€ì ì¶”ê°€ ì‹¤íŒ¨: '+(res?.error||'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      }
    });
  }

  function removePlayer(playerId){
    if(!currentBattleId || !playerId) return;
    const player=battleState?.players?.find(p=>p.id===playerId);
    const playerName=player?.name || 'Unknown';
    if(!confirm(`${playerName}ì„(ë¥¼) ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    socket.emit('deletePlayer',{battleId:currentBattleId,playerId},(res)=>{
      if(res?.ok) addLog({ts:Date.now(),type:'notice',message:`${playerName}ì´(ê°€) ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤`});
      else alert('ì „íˆ¬ ì°¸ê°€ì ì œê±° ì‹¤íŒ¨: '+(res?.error||'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
    });
  }

  function clearPlayerForm(){
    document.getElementById('playerName').value='';
    document.getElementById('playerTeam').value='A';
    document.getElementById('playerHP').value='100';
    document.getElementById('playerAttack').value='1';
    document.getElementById('playerDefense').value='1';
    document.getElementById('playerAgility').value='1';
    document.getElementById('playerLuck').value='1';
    document.getElementById('playerDittany').value='0';
    document.getElementById('playerAttackBooster').value='0';
    document.getElementById('playerDefenseBooster').value='0';
    document.getElementById('avatarUpload').value='';
    document.getElementById('avatarPreview').removeAttribute('src');
    uploadedAvatarUrl=null;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë§í¬ ìƒì„± (ì„œë²„ ì‘ë‹µ í¬ë§· í˜¸í™˜) â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function generateLinks(){
    if(!currentBattleId){ alert('ë¨¼ì € ì „íˆ¬ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”'); return; }
    fetch(`/api/admin/battles/${currentBattleId}/links`,{method:'POST'})
      .then(r=>r.json())
      .then(d=>{
        const payload=d?.links || d;
        if(payload?.spectator && (payload?.players || payload?.playerLinks)) displayLinks(payload);
        else throw new Error('ë§í¬ ìƒì„± ì‹¤íŒ¨');
      })
      .catch(e=>alert('ë§í¬ ìƒì„± ì‹¤íŒ¨: '+(e?.message||e)));
  }

  function displayLinks(data){
    const container=document.getElementById('linksContainer');
    let html='';
    if(data.spectator?.url){
      html += `<div class="link-item">
        <div class="link-label">ê´€ì „ì ë§í¬</div>
        <div class="link-url" onclick="copyToClipboard('${data.spectator.url}')">${data.spectator.url}</div>
        <button class="copy-btn" onclick="copyToClipboard('${data.spectator.url}')">ë³µì‚¬</button>
      </div>`;
    }
    const list = Array.isArray(data.playerLinks) ? data.playerLinks
               : (Array.isArray(data.players) ? data.players : []);
    list.forEach(link=>{
      const nm = link.playerName || link.name || 'Player';
      html += `<div class="link-item">
        <div class="link-label">${nm} (${link.team}íŒ€)</div>
        <div class="link-url" onclick="copyToClipboard('${link.url}')">${link.url}</div>
        <button class="copy-btn" onclick="copyToClipboard('${link.url}')">ë³µì‚¬</button>
      </div>`;
    });
    container.innerHTML=html;
  }

  function copyToClipboard(text){
    navigator.clipboard.writeText(text).then(()=>{
      const btn=event.target;
      const org=btn.textContent;
      btn.textContent='ë³µì‚¬ë¨!';
      btn.style.background='#16a34a';
      setTimeout(()=>{ btn.textContent=org; btn.style.background=''; },1000);
    }).catch(()=>alert('ë³µì‚¬ ì‹¤íŒ¨'));
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì±„íŒ… â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function sendChat(){
    const input=document.getElementById('chatInput');
    const message=input.value.trim();
    if(!message || !currentBattleId) return;
    socket.emit('chatMessage',{battleId:currentBattleId,name:'ê´€ë¦¬ì',message},(res)=>{
      if(res?.ok) input.value='';
    });
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function setupEventListeners(){
    document.getElementById('btnCreate').addEventListener('click',createBattle);
    document.getElementById('btnStart').addEventListener('click',startBattle);
    document.getElementById('btnPause').addEventListener('click',pauseBattle);
    document.getElementById('btnResume').addEventListener('click',resumeBattle);
    document.getElementById('btnEnd').addEventListener('click',endBattle);

    document.getElementById('btnAddPlayer').addEventListener('click',addPlayer);

    document.getElementById('btnGenPlayerLinks').addEventListener('click',generateLinks);
    document.getElementById('btnGenSpectatorLink').addEventListener('click',generateLinks);

    document.getElementById('chatSend').addEventListener('click',sendChat);
    document.getElementById('chatInput').addEventListener('keypress',(e)=>{
      if(e.key==='Enter'){ e.preventDefault(); sendChat(); }
    });

    document.getElementById('restartBtn').addEventListener('click',()=>{
      hideGameOverOverlay();
      createBattle();
    });
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì „ì—­ í•¨ìˆ˜ ë…¸ì¶œ (ì˜¨í´ë¦­ í˜¸í™˜) â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  window.removePlayer = removePlayer;
  window.copyToClipboard = copyToClipboard;

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì†Œì¼“ ë¦¬ìŠ¤ë„ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  socket.on('connect',()=>{
    addLog({ts:Date.now(),type:'notice',message:'ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤'});
    // ì¬ì—°ê²° ì‹œ ë°© ì¬ì…ì¥
    if(currentBattleId) socket.emit('join',{battleId:currentBattleId});
  });
  socket.on('disconnect',()=> addLog({ts:Date.now(),type:'error',message:'ì„œë²„ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤'}));
  socket.on('connect_error',(err)=> addLog({ts:Date.now(),type:'error',message:'ì„œë²„ ì—°ê²° ì˜¤ë¥˜: '+err.message}));

  socket.on('battle:created',(d)=>{ if(d?.id){ currentBattleId=d.id; battleState=d; render(); }});
  socket.on('battleCreated',(d)=>{ if(d?.id){ currentBattleId=d.id; battleState=d; render(); }});

  const onSnap=(snap)=>{ battleState=snap; render(); };
  socket.on('battleUpdate',onSnap);
  socket.on('battle:update',onSnap);

  socket.on('battle:log',addLog);
  socket.on('battleLog',addLog);
  socket.on('importantLog',addLog);

  socket.on('chatMessage',addChat);
  socket.on('battle:chat',addChat);

  socket.on('battle:ended',(d)=>showGameOverOverlay(d.winner));
  socket.on('battleEnded',(d)=>showGameOverOverlay(d.winner));

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  setupEventListeners();

  const qs=new URLSearchParams(location.search);
  const battleFromUrl=qs.get('battle');
  if(battleFromUrl){
    currentBattleId=battleFromUrl;
    socket.emit('join',{battleId:currentBattleId});
  }
})();
</script>
</body>
</html>
