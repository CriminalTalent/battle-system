<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>PYXIS - 관리자 콘솔</title>
  <script src="/socket.io/socket.io.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg0:#0a0a0a;--bg1:#0e0e0e;--bg2:#121212;
      --glass1:rgba(255,255,255,.06);--glass2:rgba(255,255,255,.10);
      --border:rgba(255,255,255,.12);--text:#F8F9FA;--muted:#A9AFB6;
      --gold:#DCC7A2;--gold2:#E6D2A8;--success:#27AE60;--danger:#E74C3C;--info:#3498DB;
      --r:12px;--shadow:0 8px 16px rgba(0,0,0,.35);--font:'Cinzel',serif
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{min-height:100vh;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--text);font-family:var(--font)}
    select, input[type="text"], input[type="number"], input[type="file"]{
      background:#0b0b0b;color:var(--text);border:1px solid var(--border);
    }
    .hdr{position:sticky;top:0;background:var(--glass2);border-bottom:1px solid var(--border);padding:14px 0;z-index:5}
    .hdr-in{max-width:1400px;margin:0 auto;padding:0 20px;display:flex;justify-content:space-between;align-items:center}
    .logo{font-weight:800;color:var(--gold2);letter-spacing:1px}
    .stat{display:flex;gap:8px;align-items:center;font-size:12px;color:var(--muted)}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--success)}
    .wrap{max-width:1400px;margin:0 auto;padding:20px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;align-items:start}
    @media (max-width:1200px){.wrap{grid-template-columns:1fr}}
    .card{background:var(--glass2);border:1px solid var(--border);border-radius:var(--r);padding:16px;box-shadow:var(--shadow)}
    .ttl{font-weight:700;color:var(--gold2);border-bottom:1px solid var(--border);padding-bottom:10px;margin-bottom:12px;text-align:center}
    .field{margin-bottom:12px}
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .field input,.field select{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px}
    .btn{padding:10px 12px;border:none;border-radius:10px;background:linear-gradient(135deg,var(--gold),var(--gold2));color:#111;font-weight:700;cursor:pointer}
    .btn:disabled{background:#222;color:#666;border:1px solid #333;cursor:not-allowed}
    .btn-row{display:flex;gap:8px;margin-bottom:8px}
    .btn-danger{background:linear-gradient(135deg,var(--danger),#c0392b);color:#fff}
    .btn-copy{background:linear-gradient(135deg,var(--info),#21618c);color:#fff}
    .list{background:var(--glass1);border:1px solid var(--border);border-radius:10px;max-height:220px;overflow:auto}
    .row{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);padding:8px 10px;font-size:12px}
    .row:last-child{border-bottom:none}
    .row .meta{display:flex;gap:8px;align-items:center}
    .av{width:24px;height:24px;border-radius:6px;object-fit:cover;background:#0b0b0b;border:1px solid var(--border)}
    .logs{height:300px;overflow:auto;background:var(--glass1);border:1px solid var(--border);border-radius:10px;padding:10px}
    .log{font-size:12px;border-bottom:1px solid rgba(255,255,255,.08);padding:6px 0}
    .log:last-child{border-bottom:none}
    .chat{height:150px;overflow:auto;background:var(--glass1);border:1px solid var(--border);border-radius:10px;padding:10px;margin-top:8px}
    .links .item{display:flex;gap:8px;align-items:flex-start;border:1px solid var(--border);border-radius:10px;background:var(--glass1);padding:8px;margin-bottom:8px}
    .mono{font-family:"Courier New",monospace;font-size:11px;word-break:break-all;color:var(--muted)}
    .toast{position:fixed;top:90px;right:20px;background:var(--glass2);border:1px solid var(--border);border-left:4px solid var(--info);padding:12px;border-radius:10px;transform:translateX(360px);transition:.25s;z-index:10}
    .toast.show{transform:translateX(0)}
  </style>
</head>
<body>
  <div class="hdr">
    <div class="hdr-in">
      <div>
        <div class="logo">PYXIS 관리자 콘솔</div>
        <div style="font-size:12px;color:var(--muted)">블랙 + 골드 포인트</div>
      </div>
      <div class="stat"><span id="connText">연결 대기</span><span id="connDot" class="dot"></span></div>
    </div>
  </div>

  <div class="wrap">
    <!-- 좌: 전투 제어 + 링크 발급 -->
    <section class="card">
      <div class="ttl">전투 제어</div>
      <div class="field">
        <label for="mode">전투 모드</label>
        <select id="mode">
          <option value="1v1">1 vs 1</option>
          <option value="2v2" selected>2 vs 2</option>
          <option value="3v3">3 vs 3</option>
          <option value="4v4">4 vs 4</option>
        </select>
      </div>
      <div class="btn-row">
        <button id="btnCreate" class="btn">전투 생성</button>
        <button id="btnStart" class="btn" disabled>시작</button>
      </div>
      <div class="btn-row">
        <button id="btnPause" class="btn" disabled>일시정지</button>
        <button id="btnResume" class="btn" disabled>재개</button>
      </div>
      <div class="btn-row">
        <button id="btnEnd" class="btn btn-danger" disabled>종료</button>
      </div>

      <div id="battleBox" style="display:none;margin-top:10px">
        <div class="field"><label>전투 ID</label><input id="battleId" readonly></div>
        <div class="field"><label>상태</label><input id="battleStatus" readonly></div>
      </div>

      <div class="ttl" style="margin-top:14px">링크 및 비밀번호</div>
      <div class="btn-row">
        <button id="btnGenPlayer" class="btn" disabled>전투 참가자 링크 생성</button>
        <button id="btnGenSpectator" class="btn" disabled>관전자 비밀번호 발급</button>
      </div>
      <div class="field">
        <label>관전자 비밀번호</label>
        <input id="spectatorOtp" readonly placeholder="발급 전">
      </div>
      <div class="field">
        <label>관전자 URL</label>
        <input id="spectatorUrl" readonly placeholder="발급 전">
        <div class="btn-row" style="margin-top:6px">
          <button id="btnBuildSpectator" class="btn btn-copy" disabled>관전자 URL 복사</button>
        </div>
      </div>

      <div class="field">
        <label>전투 참가자 개별 링크</label>
        <div id="playerLinks" class="links">
          <div class="mono" style="opacity:.7">아직 생성된 링크가 없습니다.</div>
        </div>
      </div>
    </section>

    <!-- 중: 전투 참가자 관리 -->
    <section class="card">
      <div class="ttl">전투 참가자 관리</div>

      <div style="display:grid;grid-template-columns:1fr 120px;gap:10px">
        <div class="field"><label>이름</label><input id="pName" placeholder="전투 참가자 이름"></div>
        <div class="field">
          <label>팀</label>
          <select id="pTeam"><option value="A">A팀</option><option value="B">B팀</option></select>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div class="field"><label>체력(1~100)</label><input id="pHp" type="number" min="1" max="100" value="100"></div>
        <div class="field">
          <label>아바타 업로드</label>
          <div style="display:flex;gap:8px;align-items:center">
            <img id="preview" class="av" alt="미리보기">
            <input id="pAvatar" type="file" accept="image/*">
          </div>
        </div>
      </div>

      <div class="field"><label>스탯 (각 1~5)</label>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
          <div class="field"><label>공격</label><input id="sAtk" type="number" min="1" max="5" value="3"></div>
          <div class="field"><label>방어</label><input id="sDef" type="number" min="1" max="5" value="3"></div>
          <div class="field"><label>민첩</label><input id="sAgi" type="number" min="1" max="5" value="3"></div>
          <div class="field"><label>행운</label><input id="sLuk" type="number" min="1" max="5" value="2"></div>
        </div>
      </div>

      <div class="field"><label>아이템(수량)</label>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
          <div class="field"><label>디터니</label><input id="iDit" type="number" min="0" value="1"></div>
          <div class="field"><label>공격 보정기</label><input id="iAtkB" type="number" min="0" value="0"></div>
          <div class="field"><label>방어 보정기</label><input id="iDefB" type="number" min="0" value="0"></div>
        </div>
      </div>

      <button id="btnAdd" class="btn" style="width:100%">전투 참가자 추가</button>

      <div class="field" style="margin-top:12px"><label>A팀</label>
        <div id="listA" class="list"><div class="mono" style="padding:10px;opacity:.7">없음</div></div>
      </div>
      <div class="field"><label>B팀</label>
        <div id="listB" class="list"><div class="mono" style="padding:10px;opacity:.7">없음</div></div>
      </div>
    </section>

    <!-- 우: 로그 + 채팅 -->
    <section class="card">
      <div class="ttl">실시간 로그</div>
      <div id="logs" class="logs"></div>

      <div class="ttl" style="margin-top:12px">채팅</div>
      <div id="chatLogs" class="chat"></div>
      <div class="btn-row" style="margin-top:6px">
        <input id="chatMsg" placeholder="관리자 메시지" style="flex:1;padding:10px;border:1px solid var(--border);border-radius:10px;background:#0b0b0b;color:var(--text)">
        <button id="btnSend" class="btn">전송</button>
      </div>
    </section>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const $=s=>document.querySelector(s);
    const esc=s=>String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    let socket=null,currentBattle=null;

    const DEFAULT_AVATAR='data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"><rect width="100%" height="100%" fill="#0b0b0b"/><circle cx="24" cy="18" r="10" fill="#2b2b2b"/><rect x="10" y="30" width="28" height="12" rx="6" fill="#2b2b2b"/></svg>`);
    const setImg=(img,url)=>{ if(!img) return; img.onerror=null; img.src=url||DEFAULT_AVATAR; img.onerror=()=>{img.onerror=null; img.src=DEFAULT_AVATAR;}; };

    // 헤더 상태
    const connText=$('#connText'), connDot=$('#connDot');

    // 제어
    const mode=$('#mode'), btnCreate=$('#btnCreate'), btnStart=$('#btnStart'), btnPause=$('#btnPause'), btnResume=$('#btnResume'), btnEnd=$('#btnEnd');
    const battleBox=$('#battleBox'), battleIdEl=$('#battleId'), battleStatusEl=$('#battleStatus');

    // 링크/비번
    const btnGenPlayer=$('#btnGenPlayer'), btnGenSpectator=$('#btnGenSpectator');
    const spectatorOtp=$('#spectatorOtp'), spectatorUrl=$('#spectatorUrl'), btnBuildSpectator=$('#btnBuildSpectator');
    const playerLinks=$('#playerLinks');

    // 참가자 폼
    const pName=$('#pName'), pTeam=$('#pTeam'), pHp=$('#pHp'), pAvatar=$('#pAvatar'), preview=$('#preview');
    const sAtk=$('#sAtk'), sDef=$('#sDef'), sAgi=$('#sAgi'), sLuk=$('#sLuk');
    const iDit=$('#iDit'), iAtkB=$('#iAtkB'), iDefB=$('#iDefB');
    const btnAdd=$('#btnAdd');

    // 목록/로그/채팅
    const listA=$('#listA'), listB=$('#listB'), logs=$('#logs'), chatLogs=$('#chatLogs'), chatMsg=$('#chatMsg'), btnSend=$('#btnSend');

    const toastEl=$('#toast');
    function toast(msg){ toastEl.textContent=msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),2200); }

    function addLog(msg){
      const t=new Date().toLocaleTimeString('ko-KR',{hour12:false,hour:'2-digit',minute:'2-digit'});
      const d=document.createElement('div'); d.className='log'; d.innerHTML=`<span style="color:#888;font-size:10px;margin-right:6px">${t}</span>${esc(msg)}`;
      logs.appendChild(d); logs.scrollTop=logs.scrollHeight; while(logs.children.length>400) logs.removeChild(logs.firstChild);
    }
    function addChat(name,msg){
      const t=new Date().toLocaleTimeString('ko-KR',{hour12:false,hour:'2-digit',minute:'2-digit'});
      const d=document.createElement('div'); d.innerHTML=`<b style="color:var(--gold)">${esc(name)}</b>: ${esc(msg)} <span style="color:#888;font-size:10px;margin-left:6px">${t}</span>`;
      chatLogs.appendChild(d); chatLogs.scrollTop=chatLogs.scrollHeight; while(chatLogs.children.length>300) chatLogs.removeChild(chatLogs.firstChild);
    }

    function connect(){
      socket=io();
      socket.on('connect',()=>{connText.textContent='연결됨';connDot.style.background='var(--success)';addLog('서버 연결');});
      socket.on('disconnect',()=>{connText.textContent='연결 끊김';connDot.style.background='var(--danger)';addLog('서버 연결 끊김');});

      const onUpdate=b=>{
        if(!b) return;
        currentBattle=b;
        battleStatusEl.value=b.status||'waiting';
        btnStart.disabled=b.status!=='waiting';
        btnPause.disabled=b.status!=='active';
        btnResume.disabled=b.status!=='paused';
        btnEnd.disabled=b.status==='waiting';
        // 링크 버튼은 전투가 존재해야 활성화
        const linkBtnsDisabled=!currentBattle;
        btnGenPlayer.disabled=linkBtnsDisabled;
        btnGenSpectator.disabled=linkBtnsDisabled;
        btnBuildSpectator.disabled = !spectatorUrl.value;
        renderTeams();
      };
      socket.on('battleUpdate',onUpdate);
      socket.on('battle:update',onUpdate);

      socket.on('chatMessage',d=>addChat(d?.name||'익명',d?.message||''));
      socket.on('battle:chat', d=>addChat(d?.name||d?.senderName||'익명',d?.message||''));
      socket.on('battle:log', d=>addLog(d?.message||'로그'));
      socket.on('battleLog',  d=>addLog(d?.message||'로그'));
    }

    // 전투 제어
    btnCreate.addEventListener('click',()=>{
      socket.emit('createBattle',{mode:mode.value},(res)=>{
        if(!res?.ok){toast('전투 생성 실패');addLog('전투 생성 실패');return;}
        currentBattle=res.battle; battleBox.style.display='block';
        battleIdEl.value=currentBattle.id; battleStatusEl.value=currentBattle.status||'waiting';
        btnStart.disabled=false; btnGenPlayer.disabled=false; btnGenSpectator.disabled=false;
        addLog(`전투 생성: ${currentBattle.id} (${mode.value})`); toast('전투 생성됨');
      });
    });
    btnStart.addEventListener('click',()=>{ if(!currentBattle) return; socket.emit('startBattle',{battleId:currentBattle.id},r=>{addLog(r?.ok?'전투 시작':'전투 시작 실패');});});
    btnPause.addEventListener('click',()=>{ if(!currentBattle) return; socket.emit('pauseBattle',{battleId:currentBattle.id}); addLog('일시정지 요청');});
    btnResume.addEventListener('click',()=>{ if(!currentBattle) return; socket.emit('resumeBattle',{battleId:currentBattle.id}); addLog('재개 요청');});
    btnEnd.addEventListener('click',()=>{ if(!currentBattle) return; if(confirm('전투 종료?')){socket.emit('endBattle',{battleId:currentBattle.id}); addLog('종료 요청');}});

    // 링크/비번 발급 (서버 엔드포인트: /api/admin/battles/:id/links)
    async function requestLinks(){
      if(!currentBattle){toast('전투를 먼저 생성하세요');return;}
      try{
        const res=await fetch(`/api/admin/battles/${currentBattle.id}/links`,{method:'POST'});
        const json=await res.json();
        if(!json?.ok){toast('링크 생성 실패');addLog('링크 생성 실패');return;}
        // 관전자 OTP/URL
        spectatorOtp.value=json.spectatorOtp||'';
        spectatorUrl.value=json.spectatorUrl||'';
        btnBuildSpectator.disabled=!spectatorUrl.value;
        addLog(`관전자 비밀번호 발급: ${spectatorOtp.value}`);
        // 참가자 링크
        renderPlayerLinks(json.playerLinks||[]);
        toast('링크가 생성되었습니다');
      }catch(e){toast('요청 실패');addLog('링크 생성 요청 실패');}
    }
    btnGenPlayer.addEventListener('click',requestLinks);
    btnGenSpectator.addEventListener('click',requestLinks);
    $('#btnBuildSpectator').addEventListener('click',()=>{
      if(!spectatorUrl.value){toast('URL이 없습니다');return;}
      copy(spectatorUrl.value); toast('관전자 URL 복사됨');
    });

    function renderPlayerLinks(links){
      if(!links.length){playerLinks.innerHTML='<div class="mono" style="opacity:.7">생성된 링크가 없습니다.</div>';return;}
      playerLinks.innerHTML='';
      links.forEach(l=>{
        const div=document.createElement('div'); div.className='item';
        div.innerHTML=`
          <div style="flex:1">
            <div><b>${esc(l.playerName||'전투 참가자')}</b> <span style="color:#aaa;font-size:12px">(${esc(l.team||'A')}팀)</span></div>
            <div class="mono" style="margin-top:4px">${esc(l.url||'')}</div>
            <div class="mono" style="margin-top:2px;opacity:.8">비밀번호: ${esc(l.otp||'')}</div>
          </div>
          <div>
            <button class="btn btn-copy">복사</button>
          </div>`;
        div.querySelector('.btn-copy').addEventListener('click',()=>copy(l.url||''));
        playerLinks.appendChild(div);
      });
    }

    function copy(text){
      if(!text) return;
      if(navigator.clipboard){ navigator.clipboard.writeText(text); }
      else { const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); }
    }

    // 참가자 추가/삭제
    pAvatar.addEventListener('change',e=>{
      const f=e.target.files[0];
      if(f){ const r=new FileReader(); r.onload=ev=>{preview.src=ev.target.result}; r.readAsDataURL(f); } else { preview.removeAttribute('src'); }
    });

    btnAdd.addEventListener('click',async()=>{
      if(!currentBattle){toast('전투를 먼저 생성하세요');return;}
      const name=pName.value.trim(); if(!name){toast('이름을 입력하세요');return;}
      const payload={
        name, team:pTeam.value, hp:parseInt(pHp.value)||100, maxHp:parseInt(pHp.value)||100,
        stats:{attack:parseInt(sAtk.value)||3, defense:parseInt(sDef.value)||3, agility:parseInt(sAgi.value)||3, luck:parseInt(sLuk.value)||2},
        items:{ditany:parseInt(iDit.value)||0, attackBooster:parseInt(iAtkB.value)||0, defenseBooster:parseInt(iDefB.value)||0}
      };
      // 아바타 업로드
      if(pAvatar.files[0]){
        try{
          const fd=new FormData(); fd.append('avatar',pAvatar.files[0]);
          const r=await fetch('/api/upload/avatar',{method:'POST',body:fd});
          const j=await r.json(); if(j?.ok&&j.url) payload.avatar=j.url;
        }catch(e){addLog('아바타 업로드 실패');}
      }
      socket.emit('addPlayer',{battleId:currentBattle.id, player:payload},res=>{
        if(res?.ok){addLog(`참가자 추가: ${name} (${payload.team}팀)`); resetForm();}
        else {addLog('참가자 추가 실패');}
      });
    });

    function resetForm(){
      pName.value=''; pHp.value='100'; pAvatar.value=''; preview.removeAttribute('src');
      sAtk.value='3'; sDef.value='3'; sAgi.value='3'; sLuk.value='2';
      iDit.value='1'; iAtkB.value='0'; iDefB.value='0';
    }

    function renderTeams(){
      if(!currentBattle){listA.innerHTML='<div class="mono" style="padding:10px;opacity:.7">없음</div>';listB.innerHTML='<div class="mono" style="padding:10px;opacity:.7">없음</div>';return;}
      const A=(currentBattle.players||[]).filter(p=>p.team==='A'), B=(currentBattle.players||[]).filter(p=>p.team==='B');
      const fill=(el,arr)=>{
        if(!arr.length){el.innerHTML='<div class="mono" style="padding:10px;opacity:.7">없음</div>';return;}
        el.innerHTML='';
        arr.forEach(p=>{
          const row=document.createElement('div'); row.className='row';
          row.innerHTML=`
            <div class="meta">
              <img class="av" alt="${esc(p.name)}">
              <div>
                <div><b>${esc(p.name)}</b></div>
                <div style="color:#aaa;font-size:11px">HP ${p.hp||100}/${p.maxHp||100} · 공${p.stats?.attack||3} 방${p.stats?.defense||3} 민${p.stats?.agility||3} 행${p.stats?.luck||2}</div>
              </div>
            </div>
            <button class="btn btn-danger" data-id="${p.id}">삭제</button>`;
          const img=row.querySelector('img'); setImg(img,p.avatar);
          row.querySelector('button').addEventListener('click',()=>{
            socket.emit('deletePlayer',{battleId:currentBattle.id, playerId:p.id},r=>{
              addLog(r?.ok?`참가자 삭제: ${p.name}`:'참가자 삭제 실패');
            });
            socket.emit('removePlayer',{battleId:currentBattle.id, playerId:p.id}); // 호환 별칭
          });
          el.appendChild(row);
        });
      };
      fill(listA,A); fill(listB,B);
    }

    // 채팅
    btnSend.addEventListener('click',()=>{
      const m=chatMsg.value.trim(); if(!m||!currentBattle) return;
      socket.emit('chatMessage',{battleId:currentBattle.id,name:'관리자',message:m});
      socket.emit('battle:chat',{battleId:currentBattle.id,name:'관리자',senderName:'관리자',message:m});
      chatMsg.value='';
    });
    chatMsg.addEventListener('keydown',e=>{ if(e.key==='Enter') btnSend.click(); });

    document.addEventListener('DOMContentLoaded',()=>{connect(); addLog('관리자 콘솔 로드');});
  </script>
</body>
</html>
