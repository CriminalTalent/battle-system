<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PYXIS - 관리자 콘솔</title>
  <script src="/socket.io/socket.io.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --deep-navy: #0A0F1A; --dark-blue: #0C1221; --mid-blue: #1E2A47; --light-blue: #3D5A80;
      --gold: #DCC7A2; --gold-bright: #E6D2A8; --gold-shimmer: #F0E6C8;
      --text: #F8F9FA; --text-accent: #E9ECEF; --text-muted: #ADB5BD;
      --glass-1: rgba(30,42,71,.3); --glass-2: rgba(30,42,71,.5);
      --border: rgba(61,90,128,.4); --border-light: rgba(61,90,128,.6);
      --blur-light: blur(10px); --transition-fast: .2s ease-out; --radius: 12px;
      --shadow-soft: 0 4px 6px rgba(0,0,0,.1); --shadow-medium: 0 8px 15px rgba(0,0,0,.2);
      --success:#27AE60; --danger:#E74C3C; --info:#3498DB;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{font-family:'Cinzel',serif;background:linear-gradient(135deg,var(--deep-navy),var(--dark-blue));
      color:var(--text);line-height:1.6;min-height:100vh;overflow-x:hidden}
    .header{background:var(--glass-2);backdrop-filter:var(--blur-light);border-bottom:1px solid var(--border-light);
      padding:16px 0;position:sticky;top:0;z-index:100;box-shadow:var(--shadow-soft)}
    .header-inner{display:flex;justify-content:space-between;align-items:center;max-width:1400px;margin:0 auto;padding:0 20px}
    .brand .logo{font-size:28px;font-weight:800;color:var(--gold-bright);letter-spacing:2px;text-shadow:0 2px 4px rgba(0,0,0,.3)}
    .brand .subtitle{font-size:12px;color:var(--text-muted);letter-spacing:1px;text-transform:uppercase}
    .connection-status{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text-muted)}
    .status-dot{width:8px;height:8px;border-radius:50%;background:var(--danger);animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

    .main-container{max-width:1400px;margin:0 auto;padding:20px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;align-items:start}
    @media (max-width:1200px){.main-container{grid-template-columns:1fr;gap:16px}}

    .card{background:var(--glass-2);backdrop-filter:var(--blur-light);border:1px solid var(--border);border-radius:var(--radius);
      padding:20px;box-shadow:var(--shadow-soft);transition:all var(--transition-fast)}
    .card:hover{transform:translateY(-2px);box-shadow:var(--shadow-medium)}
    .card-title{font-size:18px;font-weight:700;color:var(--gold-bright);margin-bottom:20px;text-align:center;text-transform:uppercase;
      letter-spacing:1px;border-bottom:1px solid var(--border);padding-bottom:12px}

    .field{margin-bottom:16px}
    .field label{display:block;font-size:12px;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px;font-weight:600}
    .field input,.field select{width:100%;padding:10px 12px;background:var(--glass-1);border:1px solid var(--border);border-radius:var(--radius);
      color:var(--text);font-size:14px;transition:all var(--transition-fast)}
    .field input:focus,.field select:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 2px rgba(220,199,162,.2);background:var(--glass-2)}
    .field input[readonly]{background:var(--glass-1);color:var(--text-muted);cursor:default}

    .btn{padding:10px 16px;background:linear-gradient(135deg,var(--gold),var(--gold-bright));color:#0A0F1A;border:none;border-radius:var(--radius);
      font-size:14px;font-weight:600;cursor:pointer;transition:all var(--transition-fast);text-transform:uppercase;letter-spacing:.5px;
      box-shadow:var(--shadow-soft);min-height:40px;display:flex;align-items:center;justify-content:center;gap:6px}
    .btn:hover:not(:disabled){background:linear-gradient(135deg,var(--gold-bright),var(--gold-shimmer));transform:translateY(-2px);box-shadow:var(--shadow-medium)}
    .btn:disabled{background:var(--glass-1);color:var(--text-muted);cursor:not-allowed;transform:none;box-shadow:none}
    .btn-success{background:linear-gradient(135deg,var(--success),#2ecc71);color:#fff}
    .btn-success:hover:not(:disabled){background:linear-gradient(135deg,#2ecc71,#27ae60)}
    .btn-danger{background:linear-gradient(135deg,var(--danger),#c0392b);color:#fff}
    .btn-danger:hover:not(:disabled){background:linear-gradient(135deg,#c0392b,#a93226)}
    .btn-sm{padding:6px 10px;font-size:11px;min-height:28px}
    .btn-copy{background:linear-gradient(135deg,var(--info),#2980b9);color:#fff;font-size:12px;padding:6px 12px;min-height:32px}
    .btn-copy:hover:not(:disabled){background:linear-gradient(135deg,#2980b9,#21618c)}
    .btn-group{display:flex;gap:8px;margin-bottom:12px}.btn-group .btn{flex:1}

    .team-section{margin-bottom:20px}.team-title{font-size:14px;font-weight:600;color:var(--gold);margin-bottom:12px;text-transform:uppercase;letter-spacing:.5px}
    .player-list{background:var(--glass-1);border:1px solid var(--border);border-radius:var(--radius);max-height:200px;overflow-y:auto}
    .player-item{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-bottom:1px solid var(--border);font-size:12px}
    .player-item:last-child{border-bottom:none}
    .player-info{display:flex;align-items:center;gap:8px}
    .player-avatar{width:24px;height:24px;border-radius:6px;object-fit:cover;background:var(--mid-blue);border:1px solid var(--border)}
    .player-name{color:var(--text-accent);font-weight:600}
    .player-hp{color:var(--text-muted);font-size:11px}

    .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px}
    .items-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px}

    .preview-section{display:flex;align-items:center;gap:12px}
    .preview{width:60px;height:60px;border-radius:var(--radius);background:var(--glass-1);border:2px solid var(--border);
      display:flex;align-items:center;justify-content:center;color:var(--text-muted);font-size:10px;text-align:center;background-size:cover;background-position:center}
    .file-input{flex:1}

    .log-container{height:300px;overflow-y:auto;background:var(--glass-1);border:1px solid var(--border);border-radius:var(--radius);padding:12px}
    .log-entry{padding:6px 0;border-bottom:1px solid rgba(61,90,128,.2);font-size:12px;line-height:1.4}
    .log-entry:last-child{border-bottom:none}
    .log-time{color:var(--text-muted);font-size:10px;margin-right:8px}
    .log-entry.system{color:var(--info)} .log-entry.error{color:var(--danger)} .log-entry.success{color:var(--success)}

    .player-links{margin-top:16px}
    .link-item{display:flex;align-items:center;gap:8px;margin-bottom:8px;padding:8px;background:var(--glass-1);border:1px solid var(--border);border-radius:var(--radius)}
    .link-info{flex:1;font-size:12px}
    .link-name{color:var(--text-accent);font-weight:600}
    .link-team{color:var(--text-muted);font-size:11px}
    .link-url{font-family:'Courier New',monospace;color:var(--text-muted);font-size:10px;margin-top:2px;word-break:break-all}

    .chat-section{margin-top:20px}
    .chat-messages{height:150px;overflow-y:auto;background:var(--glass-1);border:1px solid var(--border);border-radius:var(--radius);padding:12px;margin-bottom:8px}
    .chat-entry{font-size:12px;line-height:1.4;margin-bottom:6px;color:var(--text-accent)}
    .chat-entry .name{color:var(--gold);font-weight:600}
    .chat-input-row{display:flex;gap:8px}
    .chat-input{flex:1;padding:8px 12px;background:var(--glass-1);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:12px}
    .chat-input:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 2px rgba(220,199,162,.2)}

    .toast{position:fixed;top:100px;right:20px;background:var(--glass-2);backdrop-filter:var(--blur-light);border:1px solid var(--border-light);
      border-radius:var(--radius);padding:16px;color:var(--text);font-size:14px;box-shadow:var(--shadow-medium);transform:translateX(400px);
      transition:transform .3s ease-out;z-index:3000;max-width:300px}
    .toast.show{transform:translateX(0)} .toast.success{border-left:4px solid var(--success)} .toast.error{border-left:4px solid var(--danger)} .toast.info{border-left:4px solid var(--info)}
  </style>
</head>
<body>
<header class="header">
  <div class="header-inner">
    <div class="brand">
      <div class="logo">PYXIS</div>
      <div class="subtitle">관리자 콘솔</div>
    </div>
    <div class="connection-status">
      <span id="connText">연결 끊김</span>
      <div class="status-dot" id="connDot"></div>
    </div>
  </div>
</header>

<div class="main-container">
  <!-- 좌측: 전투 제어 및 링크 관리 -->
  <div class="card">
    <div class="card-title">전투 제어</div>

    <div class="field">
      <label for="battleMode">전투 모드</label>
      <select id="battleMode">
        <option value="1v1">1 vs 1</option>
        <option value="2v2" selected>2 vs 2</option>
        <option value="3v3">3 vs 3</option>
        <option value="4v4">4 vs 4</option>
      </select>
    </div>

    <div class="btn-group">
      <button id="btnCreate" class="btn">전투 생성</button>
      <button id="btnStart" class="btn btn-success" disabled>시작</button>
    </div>

    <div class="btn-group">
      <button id="btnPause" class="btn" disabled>일시정지</button>
      <button id="btnResume" class="btn" disabled>재개</button>
    </div>

    <div class="btn-group">
      <button id="btnEnd" class="btn btn-danger" disabled>종료</button>
    </div>

    <div id="battleInfo" style="margin-top:20px;display:none;">
      <div class="field">
        <label>전투 ID</label>
        <input id="battleId" type="text" readonly>
      </div>
      <div class="field">
        <label>상태</label>
        <input id="battleStatus" type="text" readonly>
      </div>
    </div>

    <!-- 링크 및 비밀번호 관리 -->
    <div style="margin-top:18px;">
      <div class="card-title" style="font-size:14px;margin-bottom:12px;">링크 및 비밀번호</div>

      <div class="field">
        <label>관전자 비밀번호 / URL</label>
        <div class="btn-group">
          <button id="btnGenSpectator" class="btn">관전자 비밀번호 발급</button>
          <button id="btnCopySpectatorUrl" class="btn btn-copy" disabled>관전자 URL 복사</button>
        </div>
        <div class="field" style="margin-top:8px;">
          <input id="spectatorOtp" type="text" readonly placeholder="발급된 비밀번호 표시">
        </div>
        <div class="field">
          <input id="spectatorUrl" type="text" readonly placeholder="발급된 관전자 URL 표시">
        </div>
      </div>

      <div style="margin-top:14px;">
        <div class="field">
          <label>전투 참가자 비밀번호 (이름으로 조회)</label>
          <div style="display:flex;gap:6px;">
            <input id="playerNameForOtp" type="text" placeholder="참가자 이름 입력" style="flex:1;">
            <button id="btnGenPlayerOtp" class="btn">OTP 발급</button>
          </div>
        </div>
        <div id="playerOtpDisplay" style="display:none;">
          <div class="field">
            <input id="playerOtpName" type="text" readonly>
          </div>
          <div class="field">
            <input id="playerOtp" type="text" readonly>
          </div>
          <button id="btnCopyPlayerUrl" class="btn btn-copy" style="width:100%;">전투 참가자 URL 복사</button>
        </div>
      </div>

      <div class="player-links">
        <div class="team-title">생성된 참가자 링크</div>
        <div id="generatedLinks" class="player-list">
          <div style="padding:14px;text-align:center;color:var(--text-muted);font-size:11px;">
            아직 생성된 링크가 없습니다.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 중앙: 전투 참가자 관리 -->
  <div class="card">
    <div class="card-title">전투 참가자 관리</div>

    <div style="display:grid;grid-template-columns:1fr 120px;gap:12px;margin-bottom:16px;">
      <div class="field">
        <label for="playerName">이름</label>
        <input id="playerName" type="text" placeholder="전투 참가자 이름" maxlength="20">
      </div>
      <div class="field">
        <label for="playerTeam">팀</label>
        <select id="playerTeam">
          <option value="A">A팀</option>
          <option value="B">B팀</option>
        </select>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 200px;gap:12px;margin-bottom:16px;">
      <div class="field">
        <label for="playerHp">체력 (최대 100)</label>
        <input id="playerHp" type="number" min="1" max="100" value="100">
      </div>
      <div class="field">
        <label>아바타 이미지</label>
        <div class="preview-section">
          <div id="avatarPreview" class="preview">미리보기</div>
          <input id="avatarFile" type="file" accept="image/*" class="file-input">
        </div>
      </div>
    </div>

    <div style="margin-bottom:12px;">
      <label style="display:block;font-size:11px;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase;">스탯 (각 1~5)</label>
      <div class="stats-grid">
        <div class="field"><label for="statAttack">공격</label><input id="statAttack" type="number" min="1" max="5" value="3"></div>
        <div class="field"><label for="statDefense">방어</label><input id="statDefense" type="number" min="1" max="5" value="3"></div>
        <div class="field"><label for="statAgility">민첩</label><input id="statAgility" type="number" min="1" max="5" value="3"></div>
        <div class="field"><label for="statLuck">행운</label><input id="statLuck" type="number" min="1" max="5" value="2"></div>
      </div>
    </div>

    <div style="margin-bottom:14px;">
      <label style="display:block;font-size:11px;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase;">시작 아이템</label>
      <div class="items-grid">
        <div class="field"><label for="itemDittany">디터니</label><input id="itemDittany" type="number" min="0" max="99" value="1"></div>
        <div class="field"><label for="itemAtkBoost">공격 보정기</label><input id="itemAtkBoost" type="number" min="0" max="99" value="0"></div>
        <div class="field"><label for="itemDefBoost">방어 보정기</label><input id="itemDefBoost" type="number" min="0" max="99" value="0"></div>
      </div>
    </div>

    <button id="btnAddPlayer" class="btn" style="width:100%;">전투 참가자 추가</button>

    <div style="margin-top:18px;">
      <div class="team-section">
        <div class="team-title">A팀</div>
        <div id="teamAList" class="player-list">
          <div style="padding:14px;text-align:center;color:var(--text-muted);font-size:11px;">아직 추가된 참가자가 없습니다.</div>
        </div>
      </div>
      <div class="team-section">
        <div class="team-title">B팀</div>
        <div id="teamBList" class="player-list">
          <div style="padding:14px;text-align:center;color:var(--text-muted);font-size:11px;">아직 추가된 참가자가 없습니다.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- 우측: 실시간 로그 및 채팅 -->
  <div class="card">
    <div class="card-title">실시간 로그</div>
    <div id="logContainer" class="log-container"></div>

    <div class="chat-section">
      <div class="team-title">채팅</div>
      <div id="chatMessages" class="chat-messages"></div>
      <div class="chat-input-row">
        <input id="chatInput" class="chat-input" type="text" placeholder="관리자 메시지 입력..." maxlength="100">
        <button id="btnSendChat" class="btn btn-sm">전송</button>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
  const $ = (q) => document.querySelector(q);
  const escapeHtml = (s) => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  let socket = null;
  let currentBattle = null;
  let generatedLinks = []; // 서버가 만든 링크 목록 캐시

  // UI refs
  const connText = $('#connText'); const connDot = $('#connDot');
  const battleMode = $('#battleMode');
  const btnCreate = $('#btnCreate'); const btnStart = $('#btnStart'); const btnPause = $('#btnPause'); const btnResume = $('#btnResume'); const btnEnd = $('#btnEnd');
  const battleInfo = $('#battleInfo'); const battleId = $('#battleId'); const battleStatus = $('#battleStatus');

  const btnGenSpectator = $('#btnGenSpectator'); const btnCopySpectatorUrl = $('#btnCopySpectatorUrl');
  const spectatorOtp = $('#spectatorOtp'); const spectatorUrl = $('#spectatorUrl');

  const playerNameForOtp = $('#playerNameForOtp'); const btnGenPlayerOtp = $('#btnGenPlayerOtp');
  const playerOtpDisplay = $('#playerOtpDisplay'); const playerOtpName = $('#playerOtpName'); const playerOtp = $('#playerOtp'); const btnCopyPlayerUrl = $('#btnCopyPlayerUrl');

  const generatedLinksEl = $('#generatedLinks');

  const playerName = $('#playerName'); const playerTeam = $('#playerTeam'); const playerHp = $('#playerHp');
  const avatarFile = $('#avatarFile'); const avatarPreview = $('#avatarPreview');
  const statAttack = $('#statAttack'); const statDefense = $('#statDefense'); const statAgility = $('#statAgility'); const statLuck = $('#statLuck');
  const itemDittany = $('#itemDittany'); const itemAtkBoost = $('#itemAtkBoost'); const itemDefBoost = $('#itemDefBoost');
  const btnAddPlayer = $('#btnAddPlayer');

  const teamAList = $('#teamAList'); const teamBList = $('#teamBList');

  const logContainer = $('#logContainer'); const chatMessages = $('#chatMessages'); const chatInput = $('#chatInput'); const btnSendChat = $('#btnSendChat');
  const toastEl = $('#toast');

  const showToast = (message, type='info') => {
    toastEl.textContent = message; toastEl.className = `toast ${type} show`; setTimeout(()=>toastEl.classList.remove('show'), 3000);
  };
  const addLog = (message, type='system') => {
    const entry = document.createElement('div'); entry.className = `log-entry ${type}`;
    const time = document.createElement('span'); time.className = 'log-time';
    time.textContent = new Date().toLocaleTimeString('ko-KR',{hour12:false,hour:'2-digit',minute:'2-digit'});
    const content = document.createElement('span'); content.textContent = message;
    entry.appendChild(time); entry.appendChild(content); logContainer.appendChild(entry); logContainer.scrollTop = logContainer.scrollHeight;
    while (logContainer.children.length > 200) logContainer.removeChild(logContainer.firstChild);
  };
  const addChat = (name, message) => {
    const entry = document.createElement('div'); entry.className = 'chat-entry';
    entry.innerHTML = `<span class="name">${escapeHtml(name)}</span>: ${escapeHtml(message)}`;
    chatMessages.appendChild(entry); chatMessages.scrollTop = chatMessages.scrollHeight;
    while (chatMessages.children.length > 100) chatMessages.removeChild(chatMessages.firstChild);
  };
  const copyToClipboard = async (text) => {
    try { await navigator.clipboard.writeText(text); showToast('클립보드에 복사되었습니다.','success'); }
    catch {
      const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
      showToast('클립보드에 복사되었습니다.','success');
    }
  };

  // Socket
  const connectSocket = () => {
    socket = window.io({ path: '/socket.io' });
    if (!socket) { showToast('소켓 초기화 실패','error'); return; }

    socket.on('connect', () => { connText.textContent='연결됨'; connDot.style.background='var(--success)'; addLog('서버에 연결되었습니다.','system'); });
    socket.on('disconnect', () => { connText.textContent='연결 끊김'; connDot.style.background='var(--danger)'; addLog('서버 연결이 끊어졌습니다.','system'); });

    socket.on('battleUpdate', onBattleUpdate);
    socket.on('battle:update', onBattleUpdate);

    socket.on('chatMessage', (d)=> addChat(d.name || '익명', d.message || ''));
    socket.on('battle:log', (d)=> addLog(d.message || '로그', d.type || 'system'));
  };

  const onBattleUpdate = (data) => {
    if (!data) return;
    currentBattle = data;
    battleStatus.value = data.status || 'waiting';
    btnStart.disabled  = data.status !== 'waiting';
    btnPause.disabled  = data.status !== 'active';
    btnResume.disabled = data.status !== 'paused';
    btnEnd.disabled    = data.status === 'waiting';
    updateTeamLists();
  };

  const updateTeamLists = () => {
    if (!currentBattle || !currentBattle.players) return;
    const teamA = currentBattle.players.filter(p => (p.team || 'A') === 'A');
    const teamB = currentBattle.players.filter(p => (p.team || 'A') === 'B');

    const render = (container, arr) => {
      if (arr.length === 0) {
        container.innerHTML = '<div style="padding:14px;text-align:center;color:var(--text-muted);font-size:11px;">아직 추가된 참가자가 없습니다.</div>';
        return;
      }
      container.innerHTML = '';
      arr.forEach(p => {
        const item = document.createElement('div'); item.className='player-item';
        const hp = p.hp || 100; const maxHp = p.maxHp || 100; const s = p.stats || {};
        item.innerHTML = `
          <div class="player-info">
            <img class="player-avatar" src="${p.avatar || ''}" alt="${escapeHtml(p.name || '전투 참가자')}">
            <div>
              <div class="player-name">${escapeHtml(p.name || '전투 참가자')}</div>
              <div class="player-hp">HP: ${hp}/${maxHp} | 공:${s.attack||3} 방:${s.defense||3} 민:${s.agility||3} 행:${s.luck||2}</div>
            </div>
          </div>
          <button class="btn btn-sm btn-danger">삭제</button>
        `;
        item.querySelector('button').addEventListener('click', ()=>{
          if (!currentBattle) return;
          socket.emit('deletePlayer', { battleId: currentBattle.id, playerId: p.id }, (res)=>{
            if (res?.ok) showToast('삭제되었습니다.','success'); else showToast('삭제 실패','error');
          });
        });
        container.appendChild(item);
      });
    };
    render(teamAList, teamA); render(teamBList, teamB);
  };

  // 업로드 미리보기
  avatarFile.addEventListener('change', (e)=>{
    const f = e.target.files[0];
    if (!f) { avatarPreview.style.backgroundImage=''; avatarPreview.textContent='미리보기'; return; }
    const reader = new FileReader();
    reader.onload = (ev)=>{ avatarPreview.style.backgroundImage=`url(${ev.target.result})`; avatarPreview.textContent=''; };
    reader.readAsDataURL(f);
  });

  // 서버 링크(관전자+참가자) 재생성 호출
  const rebuildLinks = async () => {
    if (!currentBattle) return null;
    const res = await fetch(`/api/admin/battles/${currentBattle.id}/links`, { method:'POST' });
    if (!res.ok) throw new Error('LINK_API_FAILED');
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || 'LINK_API_FAILED');
    return data;
  };

  // 버튼 바인딩
  const bindEvents = () => {
    btnCreate.addEventListener('click', ()=>{
      if (!socket) return;
      const mode = battleMode.value;
      btnCreate.disabled = true;
      socket.emit('createBattle', { mode }, (res)=>{
        if (!res || !res.ok) {
          btnCreate.disabled = false;
          showToast('전투 생성 실패','error');
          return;
        }
        currentBattle = res.battle;
        battleInfo.style.display = 'block';
        battleId.value = currentBattle.id;
        battleStatus.value = currentBattle.status || 'waiting';
        socket.emit('join', { battleId: currentBattle.id });
        btnStart.disabled = false;
        addLog(`전투 생성: ${currentBattle.id} (${mode})`,'success');
        showToast(`전투가 생성되었습니다. (ID: ${currentBattle.id})`,'success');
      });
    });

    btnStart.addEventListener('click', ()=>{
      if (!socket || !currentBattle) return;
      socket.emit('startBattle', { battleId: currentBattle.id }, (res)=>{
        if (res?.ok) { showToast('전투 시작','success'); }
      });
    });

    btnPause.addEventListener('click', ()=>{
      if (!socket || !currentBattle) return;
      socket.emit('pauseBattle', { battleId: currentBattle.id }, (res)=>{
        if (res?.ok) { showToast('전투 일시정지','success'); }
      });
    });

    btnResume.addEventListener('click', ()=>{
      if (!socket || !currentBattle) return;
      socket.emit('resumeBattle', { battleId: currentBattle.id }, (res)=>{
        if (res?.ok) { showToast('전투 재개','success'); }
      });
    });

    btnEnd.addEventListener('click', ()=>{
      if (!socket || !currentBattle) return;
      if (!confirm('정말로 전투를 종료하시겠습니까?')) return;
      socket.emit('endBattle', { battleId: currentBattle.id }, (res)=>{
        if (res?.ok) { showToast('전투 종료','success'); }
      });
    });

    // 관전자 비밀번호 발급(= 서버 링크 재생성)
    btnGenSpectator.addEventListener('click', async ()=>{
      if (!currentBattle) { showToast('먼저 전투를 생성해주세요.','error'); return; }
      try {
        const data = await rebuildLinks();
        spectatorOtp.value = data.spectatorOtp || '';
        spectatorUrl.value = data.spectatorUrl || '';
        btnCopySpectatorUrl.disabled = !spectatorUrl.value;
        generatedLinks = data.playerLinks || [];
        renderGeneratedLinks();
        showToast('관전자 비밀번호/URL이 발급되었습니다.','success');
      } catch(e) {
        showToast('발급 실패','error');
      }
    });

    btnCopySpectatorUrl.addEventListener('click', ()=>{
      if (!spectatorUrl.value) { showToast('먼저 관전자 비밀번호를 발급해주세요.','error'); return; }
      copyToClipboard(spectatorUrl.value);
    });

    // 참가자 OTP 발급(서버 링크 재생성 후 이름으로 검색)
    btnGenPlayerOtp.addEventListener('click', async ()=>{
      const name = playerNameForOtp.value.trim();
      if (!name) { showToast('참가자 이름을 입력해주세요.','error'); return; }
      if (!currentBattle) { showToast('먼저 전투를 생성해주세요.','error'); return; }
      try {
        const data = await rebuildLinks();
        generatedLinks = data.playerLinks || [];
        const found = generatedLinks.find(l => (l.playerName||'').toLowerCase() === name.toLowerCase());
        if (!found) { showToast('해당 이름의 참가자 링크가 없습니다. 먼저 참가자를 추가하세요.','error'); return; }
        playerOtpName.value = `${found.playerName}님의 비밀번호`;
        playerOtp.value = found.otp;
        playerOtpDisplay.style.display = 'block';
        btnCopyPlayerUrl.onclick = ()=> copyToClipboard(found.url);
        renderGeneratedLinks();
        showToast('전투 참가자 비밀번호가 발급되었습니다.','success');
      } catch {
        showToast('발급 실패','error');
      }
    });

    // 전투 참가자 추가
    btnAddPlayer.addEventListener('click', async ()=>{
      const name = playerName.value.trim();
      if (!name) { showToast('참가자 이름을 입력해주세요.','error'); return; }
      if (!currentBattle) { showToast('먼저 전투를 생성해주세요.','error'); return; }

      // 아바타 업로드(선택)
      let avatarUrl = null;
      if (avatarFile.files[0]) {
        try {
          const formData = new FormData();
          formData.append('avatar', avatarFile.files[0]);
          const res = await fetch(`/api/upload/avatar`, { method:'POST', body: formData });
          const up = await res.json();
          if (up?.ok) avatarUrl = up.url;
        } catch(e) {}
      }

      const player = {
        name,
        team: playerTeam.value,
        hp: parseInt(playerHp.value) || 100,
        stats: {
          attack: parseInt(statAttack.value) || 3,
          defense: parseInt(statDefense.value) || 3,
          agility: parseInt(statAgility.value) || 3,
          luck: parseInt(statLuck.value) || 2
        },
        items: {
          dittany: parseInt(itemDittany.value) || 0,
          attack_boost: parseInt(itemAtkBoost.value) || 0,
          defense_boost: parseInt(itemDefBoost.value) || 0
        },
        avatar: avatarUrl
      };

      socket.emit('addPlayer', { battleId: currentBattle.id, player }, (res)=>{
        if (res?.ok) {
          showToast(`${res.player.name}이(가) 추가되었습니다.`,'success');
          addLog(`전투 참가자 추가: ${res.player.name} (${res.player.team}팀)`,'success');
          resetPlayerForm();
        } else {
          showToast('추가 실패','error');
        }
      });
    });

    // 채팅
    btnSendChat.addEventListener('click', sendChat);
    chatInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') sendChat(); });

    // 이름 입력 후 Enter로 OTP
    playerNameForOtp.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') btnGenPlayerOtp.click(); });
  };

  const renderGeneratedLinks = () => {
    const list = generatedLinksEl;
    if (!generatedLinks || generatedLinks.length === 0) {
      list.innerHTML = '<div style="padding:14px;text-align:center;color:var(--text-muted);font-size:11px;">아직 생성된 링크가 없습니다.</div>';
      return;
    }
    list.innerHTML = '';
    generatedLinks.forEach(link => {
      const item = document.createElement('div');
      item.className = 'link-item';
      item.innerHTML = `
        <div class="link-info">
          <div class="link-name">${escapeHtml(link.playerName)}</div>
          <div class="link-team">${link.team}팀</div>
          <div class="link-url">${escapeHtml(link.url)}</div>
        </div>
        <button class="btn btn-copy btn-sm">복사</button>
      `;
      item.querySelector('button').addEventListener('click', ()=> copyToClipboard(link.url));
      list.appendChild(item);
    });
  };

  const resetPlayerForm = () => {
    playerName.value=''; playerHp.value='100'; avatarFile.value='';
    avatarPreview.style.backgroundImage=''; avatarPreview.textContent='미리보기';
    statAttack.value='3'; statDefense.value='3'; statAgility.value='3'; statLuck.value='2';
    itemDittany.value='1'; itemAtkBoost.value='0'; itemDefBoost.value='0';
  };

  const sendChat = ()=>{
    const message = chatInput.value.trim();
    if (!message || !socket || !currentBattle) return;
    socket.emit('chatMessage', { battleId: currentBattle.id, name:'관리자', message });
    chatInput.value=''; addLog(`[채팅] 관리자: ${message}`,'info');
  };

  const init = ()=>{
    connectSocket();
    bindEvents();
    addLog('PYXIS 관리자 콘솔이 시작되었습니다.','system');
  };
  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
