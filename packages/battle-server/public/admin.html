<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Pyxis - 전투 관리자</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>

  <!-- PYXIS 공용 테마 & 파비콘 -->
  <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
  <link rel="stylesheet" href="/assets/pyxis-theme.css">
  <style>
    /* 페이지 전용 보조 스타일 (테마와 충돌 없이 소량만) */
    .split { display:grid; grid-template-columns: 1.2fr .8fr; gap:14px }
    @media (max-width: 1024px){ .split { grid-template-columns: 1fr } }
    .controls { display:grid; gap:10px; grid-template-columns: 1fr 1fr }
    .controls .btn { width:100% }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace }
    .kv { display:grid; grid-template-columns: 110px 1fr; gap:6px 10px; font-size:14px; color:var(--text-dim) }
    .kv b { color:var(--gold-light); font-weight:700 }
    .pill { display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border-1); color:var(--text-dim) }
  </style>
</head>
<body>
  <div class="container">
    <section class="hero">
      <h1 class="hero-title">Pyxis 전투 관리자</h1>
      <div class="muted" id="serverLine">서버 상태 확인 중...</div>
    </section>

    <!-- 상태 바 -->
    <div class="status" id="statusBar">
      <div class="item">전투 상태: <b id="battleStatus">-</b></div>
      <div class="item">현재 팀: <b id="currentTeam">-</b></div>
      <div class="item">라운드/턴: <b id="roundTurn">-</b></div>
      <div class="item">플레이어 수: <b id="playerCount">0</b></div>
    </div>

    <!-- 인증 카드 -->
    <section class="card" id="authCard">
      <div class="title">관리자 인증</div>
      <div class="row">
        <div>
          <div class="muted">전투 ID</div>
          <input id="inpBattleId" class="input" placeholder="전투 ID 입력" />
        </div>
        <div>
          <div class="muted">관리자 OTP</div>
          <input id="inpAdminOtp" class="input" placeholder="관리자 OTP 입력" />
        </div>
      </div>
      <div style="display:flex; gap:10px; margin-top:10px">
        <button id="btnAdminAuth" class="btn">인증</button>
        <button id="btnLoadBattle" class="btn-ghost">전투 조회</button>
      </div>
      <div class="muted" style="margin-top:8px">쿼리 파라미터(battle, token)로 자동 입력됩니다.</div>
    </section>

    <!-- 메인 패널 -->
    <div id="adminMain" class="hidden split">
      <!-- 좌측: 생성/현재/로그 -->
      <div class="grid">

        <!-- 전투 생성 -->
        <section class="card">
          <div class="title">전투 생성</div>
          <div class="row">
            <div>
              <div class="muted">전투 모드</div>
              <select id="selMode" class="select">
                <option value="1v1">1 vs 1</option>
                <option value="2v2">2 vs 2</option>
                <option value="3v3">3 vs 3</option>
                <option value="4v4">4 vs 4</option>
              </select>
            </div>
            <div>
              <div class="muted">관리자 식별자(선택)</div>
              <input id="inpAdminId" class="input" placeholder="admin id (옵션)" />
            </div>
          </div>
          <div style="display:flex; gap:10px; margin-top:10px">
            <button id="btnCreate" class="btn">전투 생성</button>
            <button id="btnGenLinksFromCreate" class="btn-ghost" disabled>링크 열기</button>
          </div>
          <div id="createResult" class="muted" style="margin-top:8px"></div>
        </section>

        <!-- 현재 전투 정보 -->
        <section class="card">
          <div class="title">현재 전투</div>
          <div id="currentInfo" class="kv">
            <b>ID</b><div id="ciId">-</div>
            <b>모드</b><div id="ciMode">-</div>
            <b>상태</b><div id="ciStatus">-</div>
            <b>생성시각</b><div id="ciCreatedAt">-</div>
            <b>선공팀</b><div id="ciCurrentTeam">-</div>
          </div>

          <div class="notice" style="margin-top:12px">
            <div class="notice-title">관리자 공지(채팅으로 발송)</div>
            <textarea id="inpNotice" class="input" rows="3" placeholder="간단한 공지를 입력하세요. 플레이어/관전자 채팅으로 전송됩니다."></textarea>
            <div class="notice-controls">
              <button id="btnSendNotice" class="btn">공지 전송</button>
              <button id="btnClearNotice" class="btn-ghost">지우기</button>
            </div>
          </div>
        </section>

        <!-- 로그 -->
        <section class="card">
          <div class="title">전투 로그</div>
          <div id="battleLog" class="log"></div>
          <div style="display:flex; gap:8px; margin-top:8px">
            <button id="btnClearLog" class="btn-ghost">화면 지우기</button>
            <span class="muted" id="logHint">서버 로그는 배틀 상태 갱신 시 자동 반영됩니다.</span>
          </div>
        </section>

      </div>

      <!-- 우측: 제어/링크/채팅 -->
      <div class="grid">

        <!-- 제어 -->
        <section class="card">
          <div class="title">전투 제어</div>
          <div class="controls">
            <button id="btnStart" class="btn" disabled>전투 시작</button>
            <button id="btnEnd" class="btn-ghost" disabled>전투 종료</button>
          </div>
          <div class="muted" style="margin-top:8px">전투 시작은 관리자 인증 후 가능. 종료 시 전투는 메모리에서 제거됩니다.</div>
        </section>

        <!-- 링크 -->
        <section class="card">
          <div class="title">링크 / OTP</div>
          <div style="display:flex; gap:10px">
            <button id="btnGenLinks" class="btn" disabled>링크 생성</button>
            <button id="btnOpenModal" class="btn-ghost" disabled>모달 열기</button>
          </div>

          <div id="otpWrap" class="grid" style="margin-top:10px">
            <div>
              <div class="muted">관리자 OTP</div>
              <input id="otpAdmin" class="input mono" readonly />
            </div>
            <div>
              <div class="muted">플레이어 OTP</div>
              <input id="otpPlayer" class="input mono" readonly />
            </div>
            <div>
              <div class="muted">플레이어 OTPs</div>
              <input id="otpPlayers" class="input mono" readonly />
            </div>
            <div>
              <div class="muted">관전자 OTP</div>
              <input id="otpSpectator" class="input mono" readonly />
            </div>
          </div>

          <div id="urlWrap" class="grid" style="margin-top:10px">
            <div>
              <div class="muted">관리자 링크</div>
              <input id="urlAdmin" class="input mono" readonly />
            </div>
            <div>
              <div class="muted">플레이어 링크</div>
              <input id="urlPlayer" class="input mono" readonly />
            </div>
            <div>
              <div class="muted">관전자 링크</div>
              <input id="urlSpectator" class="input mono" readonly />
            </div>
          </div>

          <div style="display:flex; gap:10px; margin-top:10px">
            <button id="btnCopyAll" class="btn-ghost" disabled>모두 복사</button>
          </div>
        </section>

        <!-- 실시간 채팅 -->
        <section class="card">
          <div class="title">실시간 채팅</div>
          <div id="chatLog" class="chatlog"></div>
          <div class="chatbox">
            <input id="chatInput" class="input" placeholder="메시지 입력…" />
            <button id="btnSendChat" class="btn">보내기</button>
          </div>
        </section>

      </div>
    </div>

    <!-- 링크 모달 -->
    <div id="linkModal" class="hidden" style="position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.45); z-index:1000;">
      <div class="card" style="width:min(620px, 92vw)">
        <div class="title">링크 복사</div>
        <div class="row">
          <div>
            <div class="muted">관리자 링크</div>
            <input id="mAdmin" class="input mono" readonly onclick="this.select();document.execCommand('copy')" />
          </div>
          <div>
            <div class="muted">플레이어 링크</div>
            <input id="mPlayer" class="input mono" readonly onclick="this.select();document.execCommand('copy')" />
          </div>
          <div>
            <div class="muted">관전자 링크</div>
            <input id="mSpectator" class="input mono" readonly onclick="this.select();document.execCommand('copy')" />
          </div>
        </div>
        <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end">
          <button class="btn-ghost" onclick="document.getElementById('linkModal').classList.add('hidden')">닫기</button>
          <button class="btn" id="mCopyAll">모두 복사</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const $ = (s) => document.querySelector(s);

      // Elements
      const serverLine = $('#serverLine');
      const statusBar = {
        status: $('#battleStatus'),
        team: $('#currentTeam'),
        rt: $('#roundTurn'),
        pc: $('#playerCount')
      };

      const authCard = $('#authCard');
      const adminMain = $('#adminMain');
      const inpBattleId = $('#inpBattleId');
      const inpAdminOtp = $('#inpAdminOtp');
      const btnAdminAuth = $('#btnAdminAuth');
      const btnLoadBattle = $('#btnLoadBattle');

      const selMode = $('#selMode');
      const inpAdminId = $('#inpAdminId');
      const btnCreate = $('#btnCreate');
      const btnGenLinksFromCreate = $('#btnGenLinksFromCreate');
      const createResult = $('#createResult');

      const currentInfo = {
        id: $('#ciId'), mode: $('#ciMode'), status: $('#ciStatus'), created: $('#ciCreatedAt'), curTeam: $('#ciCurrentTeam')
      };

      const otpAdmin = $('#otpAdmin');
      const otpPlayer = $('#otpPlayer');
      const otpPlayers = $('#otpPlayers');
      const otpSpectator = $('#otpSpectator');

      const urlAdmin = $('#urlAdmin');
      const urlPlayer = $('#urlPlayer');
      const urlSpectator = $('#urlSpectator');

      const btnStart = $('#btnStart');
      const btnEnd = $('#btnEnd');
      const btnGenLinks = $('#btnGenLinks');
      const btnOpenModal = $('#btnOpenModal');
      const btnCopyAll = $('#btnCopyAll');

      const battleLog = $('#battleLog');
      const chatLog = $('#chatLog');
      const chatInput = $('#chatInput');
      const btnSendChat = $('#btnSendChat');

      const linkModal = $('#linkModal');
      const mAdmin = $('#mAdmin');
      const mPlayer = $('#mPlayer');
      const mSpectator = $('#mSpectator');
      const mCopyAll = $('#mCopyAll');

      const inpNotice = $('#inpNotice');
      const btnSendNotice = $('#btnSendNotice');
      const btnClearNotice = $('#btnClearNotice');
      const btnClearLog = $('#btnClearLog');

      // State
      let socket = null;
      let currentBattleId = null;
      let authed = false;

      // Helpers
      function fmtTime(ts){ try { return new Date(ts).toLocaleString(); } catch { return '-'; } }
      function setServerLine(ok, msg){
        serverLine.textContent = ok ? `서버 OK · ${msg || ''}` : `서버 오류 · ${msg || ''}`;
        serverLine.className = ok ? 'muted' : 'pill';
      }
      function fillStatus(b){
        if(!b){ statusBar.status.textContent='-'; statusBar.team.textContent='-'; statusBar.rt.textContent='-'; statusBar.pc.textContent='0'; return; }
        statusBar.status.textContent = b.status || '-';
        statusBar.team.textContent = b.currentTeam || '-';
        statusBar.rt.textContent = `${b.roundNumber ?? '-'} / ${b.turnNumber ?? '-'}`;
        const pcount = (b.teams?.team1?.players?.length || 0) + (b.teams?.team2?.players?.length || 0);
        statusBar.pc.textContent = String(pcount);
      }
      function fillCurrentInfo(b){
        if(!b){ currentInfo.id.textContent='-'; currentInfo.mode.textContent='-'; currentInfo.status.textContent='-'; currentInfo.created.textContent='-'; currentInfo.curTeam.textContent='-'; return; }
        currentInfo.id.textContent = b.id;
        currentInfo.mode.textContent = b.mode;
        currentInfo.status.textContent = b.status;
        currentInfo.created.textContent = fmtTime(b.createdAt);
        currentInfo.curTeam.textContent = b.currentTeam || '-';
      }
      function renderLogs(b){
        if(!b) return;
        battleLog.innerHTML = (b.battleLog||[]).map(e=>{
          const cls = e.type === 'system' ? 'll admin' : 'll';
          return `<div class="${cls}"><span class="t">${fmtTime(e.timestamp)}</span>${escapeHtml(e.message||'')}</div>`;
        }).join('');
        battleLog.scrollTop = battleLog.scrollHeight;

        chatLog.innerHTML = (b.chatLog||[]).map(c=>{
          const tag = c.senderType==='admin' ? '<span class="tag tag-admin">ADMIN</span>' : '<span class="tag">CHAT</span>';
          return `<div class="msg"><span class="t">${fmtTime(c.timestamp)}</span>${tag} <b>${escapeHtml(c.sender||'-')}</b>: ${escapeHtml(c.message||'')}</div>`;
        }).join('');
        chatLog.scrollTop = chatLog.scrollHeight;
      }
      function escapeHtml(s=''){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
      function enableControls(b){
        const canStart = authed && b && b.status === 'waiting';
        const canEnd   = authed && b && (b.status === 'ongoing' || b.status === 'waiting');
        btnStart.disabled = !canStart;
        btnEnd.disabled   = !canEnd;
        btnGenLinks.disabled = !authed || !b;
        btnOpenModal.disabled = !authed || !b;
        btnCopyAll.disabled = !(urlAdmin.value || urlPlayer.value || urlSpectator.value);
      }
      function setOtps(b){
        const o = (b&&b.otps) || {};
        otpAdmin.value = o.admin || '';
        otpPlayer.value = o.player || '';
        otpPlayers.value = Array.isArray(o.players)? o.players.join(', '): (o.players || '');
        otpSpectator.value = o.spectator || o.spectators || '';
      }
      function setUrls(u){
        urlAdmin.value = u?.admin || '';
        urlPlayer.value = u?.player || '';
        urlSpectator.value = u?.spectator || '';
        mAdmin.value = urlAdmin.value;
        mPlayer.value = urlPlayer.value;
        mSpectator.value = urlSpectator.value;
        btnCopyAll.disabled = !(urlAdmin.value || urlPlayer.value || urlSpectator.value);
      }
      function copyAll(){
        [urlAdmin, urlPlayer, urlSpectator].forEach(el => { if(el.value){ el.select(); document.execCommand('copy'); } });
      }

      // Server health
      fetch('/api/health').then(r=>r.json()).then(j=>{
        setServerLine(true, `활성 전투: ${j.battles}`);
      }).catch(()=>{
        setServerLine(false, '헬스 체크 실패');
      });

      // Query prefill
      (function(){
        const p = new URLSearchParams(location.search);
        const b = p.get('battle'); const t = p.get('token');
        if(b) inpBattleId.value = b;
        if(t) inpAdminOtp.value = t;
      })();

      // Socket
      function connectSocket(){
        if(socket){ try{ socket.disconnect(); }catch{} socket=null; }
        socket = io({ path:'/socket.io/', transports:['websocket','polling'] });
        socket.on('connect', ()=>{
          if(currentBattleId && inpAdminOtp.value){
            socket.emit('adminAuth', { battleId: currentBattleId, otp: inpAdminOtp.value });
          }
        });
        socket.on('authSuccess', ({ battle })=>{
          authed = true;
          authCard.classList.add('hidden');
          adminMain.classList.remove('hidden');
          updateAll(battle);
        });
        socket.on('authError', (msg)=>{
          authed = false;
          alert('인증 실패: ' + (msg||''));
        });
        socket.on('battleUpdate', (battle)=>{
          updateAll(battle);
        });
        socket.on('connect_error', (e)=>console.warn('socket error', e?.message||e));
      }

      function updateAll(battle){
        if(!battle) return;
        currentBattleId = battle.id;
        fillStatus(battle);
        fillCurrentInfo(battle);
        setOtps(battle);
        renderLogs(battle);
        enableControls(battle);
      }

      // Actions
      btnAdminAuth.onclick = async ()=>{
        const id = inpBattleId.value.trim();
        const otp = inpAdminOtp.value.trim();
        if(!id || !otp){ alert('전투 ID와 관리자 OTP를 입력하세요.'); return; }
        // 존재여부 확인
        try{
          const r = await fetch(`/api/battles/${encodeURIComponent(id)}`);
          if(!r.ok) throw new Error('전투 없음');
          const b = await r.json();
          currentBattleId = b.id;
          if(!socket) connectSocket(); else socket.emit('adminAuth', { battleId: currentBattleId, otp });
        }catch(e){
          alert('전투 조회 실패: ' + (e.message||e));
        }
      };

      btnLoadBattle.onclick = async ()=>{
        const id = inpBattleId.value.trim();
        if(!id){ alert('전투 ID를 입력하세요.'); return; }
        try{
          const r = await fetch(`/api/battles/${encodeURIComponent(id)}`);
          if(!r.ok) throw new Error('전투 없음');
          const b = await r.json();
          updateAll(b);
        }catch(e){
          alert('전투 조회 실패: ' + (e.message||e));
        }
      };

      btnCreate.onclick = async ()=>{
        const mode = selMode.value;
        const adminId = inpAdminId.value.trim() || null;
        try{
          const r = await fetch('/api/battles', {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ mode, adminId })
          });
          if(!r.ok) throw new Error('생성 실패');
          const battle = await r.json();
          createResult.textContent = `전투 생성 완료: ${battle.id}`;
          // 폼 프리필
          inpBattleId.value = battle.id;
          inpAdminOtp.value = battle.otps?.admin || '';
          btnGenLinksFromCreate.disabled = false;
          updateAll(battle);
        }catch(e){
          alert('생성 실패: ' + (e.message||e));
        }
      };

      btnGenLinksFromCreate.onclick = ()=> genLinks();
      btnGenLinks.onclick = ()=> genLinks();
      async function genLinks(){
        if(!currentBattleId){ alert('전투가 선택되지 않았습니다.'); return; }
        try{
          const r = await fetch(`/api/admin/battles/${currentBattleId}/links`, { method:'POST' });
          if(!r.ok) throw new Error('링크 생성 실패');
          const j = await r.json(); // { id, otps, urls }
          setOtps({ otps: j.otps });
          setUrls(j.urls);
          btnOpenModal.disabled = false;
          linkModal.classList.remove('hidden');
        }catch(e){
          alert('링크 생성 실패: ' + (e.message||e));
        }
      }

      btnOpenModal.onclick = ()=> linkModal.classList.remove('hidden');
      mCopyAll.onclick = ()=> {
        [mAdmin, mPlayer, mSpectator].forEach(el => { if(el.value){ el.select(); document.execCommand('copy'); } });
      };
      btnCopyAll.onclick = copyAll;

      btnStart.onclick = async ()=>{
        if(!currentBattleId) return;
        try{
          const r = await fetch(`/api/admin/battles/${currentBattleId}/start`, { method:'POST' });
          if(!r.ok){
            const j = await r.json().catch(()=>({}));
            throw new Error(j.error || '시작 실패');
          }
          // 서버에서 battleUpdate가 브로드캐스트 됩니다.
        }catch(e){
          alert('전투 시작 실패: ' + (e.message||e));
        }
      };

      btnEnd.onclick = async ()=>{
        if(!currentBattleId) return;
        if(!confirm('전투를 종료하시겠습니까? 종료 후 메모리에서 제거됩니다.')) return;
        try{
          const r = await fetch(`/api/admin/battles/${currentBattleId}/end`, { method:'POST' });
          if(!r.ok){
            const j = await r.json().catch(()=>({}));
            throw new Error(j.error || '종료 실패');
          }
          // 종료되면 서버에서 해당 전투를 제거하므로, 화면 리셋
          resetUIAfterEnd();
        }catch(e){
          alert('전투 종료 실패: ' + (e.message||e));
        }
      };

      function resetUIAfterEnd(){
        currentBattleId = null;
        authed = false;
        authCard.classList.remove('hidden');
        adminMain.classList.add('hidden');
        inpAdminOtp.value = '';
        fillStatus(null);
        fillCurrentInfo(null);
        battleLog.innerHTML = '';
        chatLog.innerHTML = '';
        [otpAdmin, otpPlayer, otpPlayers, otpSpectator, urlAdmin, urlPlayer, urlSpectator].forEach(i=>i.value='');
        enableControls(null);
      }

      btnSendChat.onclick = ()=>{
        const msg = chatInput.value.trim();
        if(!msg){ return; }
        if(!socket || !currentBattleId){ alert('소켓 또는 전투가 준비되지 않았습니다.'); return; }
        // 관리자도 공통 chatMessage 채널 사용 (서버에서 role=admin으로 기록)
        socket.emit('chatMessage', { message: msg });
        chatInput.value = '';
      };

      btnSendNotice.onclick = ()=>{
        const msg = inpNotice.value.trim();
        if(!msg){ return; }
        if(!socket || !currentBattleId){ alert('소켓 또는 전투가 준비되지 않았습니다.'); return; }
        socket.emit('chatMessage', { message: msg });
        inpNotice.value = '';
      };

      btnClearNotice.onclick = ()=> { inpNotice.value=''; };
      btnClearLog.onclick = ()=> { battleLog.innerHTML=''; };

      // Close modal when backdrop clicked
      linkModal.addEventListener('click', (e)=>{ if(e.target === linkModal){ linkModal.classList.add('hidden'); } });

      // Initial socket
      connectSocket();
    })();
  </script>
</body>
</html>
