<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>PYXIS - 전투 관리자</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --deep-navy:#000813; --gold:#DCC7A2; --gold-bright:#D4BA8D;
      --glass-1:rgba(0,8,19,.7); --glass-2:rgba(0,8,19,.5);
      --border-light:rgba(220,199,162,.3); --text:#fff; --text-muted:rgba(255,255,255,.7); --radius:6px;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Cinzel',serif;background:linear-gradient(135deg,var(--deep-navy) 0%, #001122 100%);color:var(--text); min-height:100vh; line-height:1.6;}
    .header{ text-align:center; padding:20px 0; background:var(--glass-1);border-bottom:1px solid var(--border-light); backdrop-filter:blur(10px) }
    .title{ color:var(--gold); font-size:2.5rem; font-weight:700; letter-spacing:.15em;text-shadow:0 0 20px rgba(220,199,162,.5) }
    .admin-container{ max-width:1400px; margin:0 auto; padding:20px }
    .admin-grid{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:24px; align-items:start }
    @media (max-width:1200px){ .admin-grid{ grid-template-columns:1fr 1fr } }
    @media (max-width:768px){ .admin-grid{ grid-template-columns:1fr } }
    .section h2{ color:var(--gold); margin-bottom:16px; font-size:1.2rem; font-weight:600 }
    .card{ background:var(--glass-1); border:1px solid var(--border-light); border-radius:var(--radius); padding:20px; margin-bottom:16px; backdrop-filter:blur(10px) }
    .field{ margin-bottom:12px }
    .field label{ display:block; color:var(--gold); font-weight:600; margin-bottom:4px; font-size:.9rem }
    .field input,.field select{ width:100%; padding:8px 12px; background:var(--deep-navy); color:var(--text); border:1px solid var(--border-light); border-radius:var(--radius); font-size:.9rem }
    .field input:focus,.field select:focus{ outline:none; border-color:var(--gold); box-shadow:0 0 0 2px rgba(220,199,162,.2) }
    .grid{ display:grid; gap:12px }
    .grid-4{ grid-template-columns:1fr 1fr 1fr 1fr }
    .compact{ gap:8px }
    .btn{ background:linear-gradient(135deg,var(--gold) 0%, var(--gold-bright) 100%);border:none; color:#0b0f14; padding:10px 12px; border-radius:8px; font-weight:700; cursor:pointer }
    .btn.ghost{ background:transparent; border:1px solid var(--gold); color:var(--gold) }
    .btn.danger{ background:#3b0c0c; border:1px solid #8a5; color:var(--gold) }
    .btn.block{ width:100% } .btn.small{ padding:4px 8px; font-size:.75rem }
    .btn:disabled{ opacity:0.5; cursor:not-allowed; }
    .hint{ color:var(--text-muted); font-size:.8rem; margin-top:6px }
    .team-rosters{ display:grid; grid-template-columns:1fr 1fr; gap:16px }
    @media (max-width:768px){ .team-rosters{ grid-template-columns:1fr } }
    .team h4{ color:var(--gold); margin-bottom:8px; font-size:1rem }
    .team-list{ display:grid; gap:8px }
    .player-card{ background:var(--glass-2); border:1px solid var(--border-light); border-radius:var(--radius); padding:12px }
    .player-info{ display:flex; align-items:center; gap:12px }
    .player-info img{ width:40px; height:40px; border-radius:50%; border:2px solid var(--gold); object-fit:cover; background:#0b1420 }
    .player-details{ flex:1 }
    .player-details .name{ font-weight:600; color:var(--gold); font-size:.9rem }
    .hp-bar{ background:#0b1420; border-radius:10px; height:8px; margin:4px 0; position:relative; border:1px solid var(--border-light) }
    .hp-fill{ background:linear-gradient(90deg,#4ade80 0%, #22c55e 100%); height:100%; border-radius:9px; transition:width .3s ease }
    .hp-text{ font-size:.7rem; color:var(--text-muted) }
    .stats{ font-size:.7rem; color:var(--text-muted); font-family:'JetBrains Mono',monospace }
    .avatar-preview{ width:60px; height:60px; border-radius:50%; border:2px solid var(--gold); margin-top:8px; display:block; object-fit:cover; background:#0b1420 }
    .logs,.chat{ max-height:340px; overflow:auto; display:grid; gap:6px }
    .log{ font-size:.92rem; line-height:1.45; background:rgba(255,255,255,.02); border:1px solid rgba(220,199,162,.12); border-radius:8px; padding:6px 8px; color:var(--text) }
    .log.rule{ background:var(--gold); color:#000; font-weight:700 }
    .log.error{ color:#ff6b6b }
    .chat-entry{ font-size:.92rem; line-height:1.45; background:rgba(255,255,255,.02); border:1px solid rgba(220,199,162,.12); border-radius:8px; padding:6px 8px; color:var(--text) }
    .tmark{ font-family:'JetBrains Mono',monospace; color:#000; background:var(--gold); border-radius:6px; padding:0 6px; margin-right:6px }
    .chat-name{ font-weight:700 } .chat-sep{ padding:0 4px; opacity:.9 }

    /* 게임 종료 오버레이 */
    .game-over-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 8, 19, 0.95);
      backdrop-filter: blur(20px);
      z-index: 10000;
      display: none;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.5s ease-in-out;
    }
    
    .game-over-overlay.show {
      display: flex;
    }
    
    .game-over-content {
      background: var(--glass-1);
      border: 2px solid var(--gold);
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      backdrop-filter: blur(15px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
      max-width: 500px;
      width: 90%;
    }
    
    .game-over-title {
      font-family: 'Cinzel', serif;
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--gold);
      margin-bottom: 20px;
      text-shadow: 0 0 30px rgba(220, 199, 162, 0.8);
      letter-spacing: 0.1em;
    }
    
    .winner-announcement {
      font-size: 1.5rem;
      color: var(--text);
      margin-bottom: 30px;
      line-height: 1.4;
    }
    
    .winner-team {
      color: var(--gold);
      font-weight: 700;
      font-size: 2rem;
      text-shadow: 0 0 20px rgba(220, 199, 162, 0.6);
    }
    
    .game-over-message {
      font-size: 1.1rem;
      color: var(--text-muted);
      margin-bottom: 30px;
    }
    
    .restart-button {
      background: linear-gradient(135deg, var(--gold) 0%, var(--gold-bright) 100%);
      border: none;
      color: var(--deep-navy);
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .restart-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(220, 199, 162, 0.4);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* 전투 종료 시 모든 버튼 비활성화 */
    body.battle-ended .btn:not(.restart-button) {
      opacity: 0.3 !important;
      cursor: not-allowed !important;
      pointer-events: none !important;
    }

    body.battle-ended input, 
    body.battle-ended select, 
    body.battle-ended textarea {
      opacity: 0.3 !important;
      pointer-events: none !important;
    }
  </style>
</head>
<body>
  <header class="header"><h1 class="title">PYXIS</h1></header>
  
  <div class="admin-container">
    <div class="admin-grid">
      <!-- 전투 제어 -->
      <div class="section">
        <h2>전투 제어</h2>
        <div class="card">
          <div class="field">
            <label>전투 모드</label>
            <select id="battleMode">
              <option value="1v1">1v1</option>
              <option value="2v2" selected>2v2</option>
              <option value="3v3">3v3</option>
              <option value="4v4">4v4</option>
            </select>
          </div>
          <button id="btnCreate" class="btn block">전투 생성</button>
        </div>

        <div class="card">
          <div class="field">
            <label>전투 ID</label>
            <input id="currentBattleId" type="text" readonly placeholder="전투 생성 후 표시"/>
          </div>
          <div class="grid grid-4 compact">
            <button id="btnStart" class="btn">시작</button>
            <button id="btnPause" class="btn ghost">일시정지</button>
            <button id="btnResume" class="btn ghost">재개</button>
            <button id="btnEnd" class="btn danger">종료</button>
          </div>
        </div>

        <div class="card">
          <h3>링크 생성</h3>
          <div class="grid grid-2 compact">
            <button id="btnGenPlayerLinks" class="btn block">전투 참가자 링크</button>
            <button id="btnGenSpectatorLink" class="btn block">관전자 링크</button>
          </div>
          <div id="generatedLinks" style="margin-top:12px"></div>
        </div>
      </div>

      <!-- 참가자 관리 -->
      <div class="section">
        <h2>전투 참가자 추가</h2>
        <div class="card">
          <div class="field">
            <label>이름</label>
            <input id="playerName" type="text" placeholder="참가자 이름"/>
          </div>
          
          <div class="field">
            <label>팀</label>
            <select id="playerTeam">
              <option value="A">A팀</option>
              <option value="B">B팀</option>
            </select>
          </div>

          <div class="field">
            <label>이미지 업로드</label>
            <input id="playerAvatar" type="file" accept="image/*"/>
            <div class="hint">권장: 정사각형, 500KB 이하</div>
          </div>

          <div class="grid grid-4">
            <div class="field"><label>공격</label><input id="playerAttack" type="number" value="1" min="1" max="5"/></div>
            <div class="field"><label>방어</label><input id="playerDefense" type="number" value="1" min="1" max="5"/></div>
            <div class="field"><label>민첩</label><input id="playerAgility" type="number" value="1" min="1" max="5"/></div>
            <div class="field"><label>행운</label><input id="playerLuck" type="number" value="1" min="1" max="5"/></div>
          </div>

          <div class="grid grid-3">
            <div class="field"><label>디터니</label><input id="playerDittany" type="number" value="0" min="0" max="9"/></div>
            <div class="field"><label>공격 보정기</label><input id="playerAttackBooster" type="number" value="0" min="0" max="9"/></div>
            <div class="field"><label>방어 보정기</label><input id="playerDefenseBooster" type="number" value="0" min="0" max="9"/></div>
          </div>

          <button id="btnAddPlayer" class="btn block">전투 참가자 추가</button>
        </div>

        <div class="card">
          <h3>팀 목록</h3>
          <div class="team-rosters">
            <div class="team">
              <h4>A</h4>
              <div id="teamA" class="team-list"></div>
            </div>
            <div class="team">
              <h4>B</h4>
              <div id="teamB" class="team-list"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- 로그 & 채팅 -->
      <div class="section">
        <h2>실시간 로그</h2>
        <div class="card">
          <div id="logs" class="logs"></div>
        </div>

        <h2>채팅</h2>
        <div class="card">
          <div id="chat" class="chat" style="margin-bottom:8px"></div>
          <div class="field" style="display:flex; gap:8px">
            <input id="chatMsg" type="text" placeholder="메시지 입력..." />
            <button id="btnSend" class="btn">전송</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 게임 종료 오버레이 -->
  <div id="gameOverOverlay" class="game-over-overlay">
    <div class="game-over-content">
      <div class="game-over-title">전투 종료</div>
      <div class="winner-announcement">
        <span id="winnerTeam" class="winner-team"></span> 승리!
      </div>
      <div class="game-over-message">전투가 종료되었습니다.</div>
      <button id="restartButton" class="restart-button">새 전투 시작</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // 게임 종료 처리 함수들
    function showGameOverOverlay(winner) {
      const overlay = document.getElementById('gameOverOverlay');
      const winnerTeam = document.getElementById('winnerTeam');
      
      winnerTeam.textContent = winner + '팀';
      overlay.classList.add('show');
      document.body.classList.add('battle-ended');
    }

    function hideGameOverOverlay() {
      const overlay = document.getElementById('gameOverOverlay');
      overlay.classList.remove('show');
      document.body.classList.remove('battle-ended');
    }

    // 소켓 연결 및 게임 종료 이벤트 리스너
    const socket = io();
    
    // 게임 종료 이벤트 처리 (신/구 버전 모두 대응)
    socket.on('battle:ended', (data) => {
      console.log('전투 종료:', data);
      showGameOverOverlay(data.winner);
    });

    socket.on('battleEnded', (data) => {
      console.log('전투 종료 (호환):', data);
      showGameOverOverlay(data.winner);
    });

    // 재시작 버튼 클릭 핸들러
    document.getElementById('restartButton').addEventListener('click', () => {
      hideGameOverOverlay();
      // 새 전투 생성 로직은 기존 admin.js에서 처리
      document.getElementById('btnCreate').click();
    });

    // 기존 관리자 기능들은 별도 admin.js에서 로드
  </script>
  <script defer src="/assets/js/admin.js"></script>
</body>
</html>
