<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Pyxis - 전투 관리자</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="/socket.io/socket.io.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --deep-navy:#0a0f1a;
      --midnight:#121827;
      --navy:#1a202c;

      --glass:#111726cc;
      --glass-weak:#111726a6;
      --glass-line:rgba(201,169,110,.14);

      --gold:#c9a96e;
      --gold-weak:#d4b77e;
      --gold-bright:#e0c494;
      --gold-dark:#b8985f;
      --gold-shimmer:#f2e5c7;

      --text:#f7f3ea;
      --text-weak:#d5c9b8;
      --muted:#9a8d7a;

      --phoenix-red:#d2691e;
      --death-eater-green:#2f4f2f;

      --radius:14px;
      --font-serif:'Playfair Display',serif;
      --font-sans:'Inter',system-ui,-apple-system,Segoe UI,Roboto;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family:var(--font-sans);
      background:radial-gradient(1200px 900px at 10% -10%, rgba(201,169,110,.06), transparent 60%),
                 radial-gradient(1200px 900px at 110% 110%, rgba(201,169,110,.05), transparent 60%),
                 linear-gradient(135deg, var(--deep-navy), var(--midnight) 50%, var(--navy));
      overflow-x:hidden;
    }

    .container{max-width:1400px;margin:auto;padding:20px}

    /* 헤더 */
    .title{
      font-family:var(--font-serif);
      font-weight:700;
      text-align:center;
      font-size:clamp(28px,4.2vw,40px);
      letter-spacing:.04em;
      margin:10px 0 18px;
      background:linear-gradient(135deg,var(--gold),var(--gold-shimmer),var(--gold-bright));
      -webkit-background-clip:text;background-clip:text;
      -webkit-text-fill-color:transparent;
      position:relative;display:block;
    }
    .title::before,.title::after{
      content:'✦';position:absolute;top:-6px;color:var(--gold-weak);font-size:.6em;
      animation:twinkle 2.6s ease-in-out infinite alternate;
    }
    .title::before{left:12%;animation-delay:0s}
    .title::after{right:12%;animation-delay:1.1s}
    @keyframes twinkle{0%,100%{opacity:.5;transform:scale(.85)}50%{opacity:1;transform:scale(1.2)}}

    /* 상단 상태바 */
    .topbar{
      background:linear-gradient(145deg,rgba(201,169,110,.06),rgba(201,169,110,.10));
      border:1px solid var(--glass-line);backdrop-filter:blur(12px);
      padding:12px;border-radius:var(--radius);margin-bottom:18px;
      box-shadow:0 6px 22px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.05);
      display:grid;grid-template-columns:repeat(4,1fr);gap:12px;
    }
    .topcell{font-size:14px;font-weight:600;color:var(--text-weak)}
    .topcell span{color:var(--gold)}

    /* 카드 */
    .card{
      background:var(--glass);
      border:1px solid var(--glass-line);
      border-radius:var(--radius);
      padding:16px; margin-bottom:18px;
      backdrop-filter:blur(14px);
      box-shadow:0 8px 24px rgba(0,0,0,.30), inset 0 1px 0 rgba(255,255,255,.05);
      transition:box-shadow .25s ease, border-color .25s ease;
    }
    .card:hover{border-color:rgba(201,169,110,.28);box-shadow:0 12px 30px rgba(0,0,0,.40)}
    .card-title{
      font-family:var(--font-serif);
      color:var(--gold-bright);
      font-size:18px;font-weight:600;margin:0 0 12px;
    }

    /* 배틀필드 레이아웃 */
    .battlefield{
      display:grid;
      grid-template-columns:1fr 2fr 1fr;
      gap:20px;
      margin:20px 0;
    }
    
    .command-center{
      background:linear-gradient(145deg,rgba(201,169,110,.08),rgba(201,169,110,.12));
      border:1px solid var(--gold);
      border-radius:var(--radius);
      padding:16px;
      backdrop-filter:blur(16px);
      box-shadow:0 8px 24px rgba(201,169,110,.15);
    }

    /* 팀 영역 */
    .team-zone{
      background:linear-gradient(145deg,var(--glass),rgba(201,169,110,.06));
      border:1px solid var(--glass-line);
      border-radius:var(--radius);
      padding:16px;
      backdrop-filter:blur(14px);
      position:relative;
      overflow:hidden;
    }
    .team-zone::before{
      content:'';position:absolute;top:0;left:0;right:0;height:3px;
      background:linear-gradient(90deg,var(--phoenix-red),transparent);
      opacity:0;transition:opacity .3s ease;
    }
    .team-zone.phoenix::before{background:linear-gradient(90deg,var(--phoenix-red),transparent);opacity:1}
    .team-zone.death-eater::before{background:linear-gradient(90deg,var(--death-eater-green),transparent);opacity:1}

    .team-header{
      display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;
    }
    .team-name{
      font-family:var(--font-serif);color:var(--gold-bright);font-weight:700;font-size:16px;
    }
    .team-badge{
      padding:4px 8px;border-radius:12px;font-size:11px;font-weight:700;
      border:1px solid var(--glass-line);
    }
    .phoenix .team-badge{background:rgba(210,105,30,.2);color:#ff8c42;border-color:#d2691e}
    .death-eater .team-badge{background:rgba(47,79,47,.2);color:#90ee90;border-color:#2f4f2f}

    /* 로스터 관리 */
    .roster-section{margin-top:12px}
    .add-player-form{
      background:rgba(16,21,35,.6);
      border:1px solid var(--glass-line);
      border-radius:12px;
      padding:12px;
      margin-bottom:12px;
    }
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
    .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:8px}
    .inventory-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:8px}

    /* 폼 */
    .form-label{display:block;margin:2px 0 4px;color:var(--gold-weak);font-weight:600;font-size:12px}
    .form-input,.form-select{
      width:100%;padding:8px;border-radius:8px;
      border:1px solid var(--glass-line);background:#0f1421cc;color:var(--text);
      outline:0;transition:border-color .2s ease;font-size:13px;
    }
    .form-input:focus,.form-select:focus{
      border-color:var(--gold);box-shadow:0 0 0 2px rgba(201,169,110,.18);
    }
    .form-input.small{padding:6px;font-size:12px}

    /* 버튼 */
    .btn{
      display:inline-block;padding:10px 14px;border-radius:8px;border:1px solid transparent;
      font-weight:700;cursor:pointer;transition:all .15s ease;
      background:linear-gradient(135deg,var(--gold-dark),var(--gold));color:#0d1017;
      font-size:13px;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(201,169,110,.35)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn-small{padding:6px 10px;font-size:12px}
    .btn-ghost{background:#0f1421;border:1px solid var(--glass-line);color:var(--text)}
    .btn-ghost:hover{border-color:var(--gold);box-shadow:0 4px 12px rgba(201,169,110,.25)}
    .btn-danger{background:linear-gradient(135deg,#8d3f3a,#b24e49);color:#fff}
    .btn-success{background:linear-gradient(135deg,#2d5a3d,#4a7c59);color:#fff}

    /* 플레이어 카드 */
    .player-card{
      background:rgba(16,21,35,.7);
      border:1px solid var(--glass-line);
      border-radius:10px;
      padding:10px;
      margin-bottom:8px;
      transition:all .2s ease;
    }
    .player-card:hover{border-color:var(--gold);transform:translateY(-1px)}
    .player-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .player-name{font-weight:700;color:var(--text)}
    .player-controls{display:flex;gap:4px}
    .player-stats{font-size:11px;color:var(--muted);margin-bottom:4px}
    .player-inventory{font-size:11px;color:var(--gold-weak)}

    /* 로그 & 채팅 */
    .log-section{
      background:rgba(12,16,26,.7);
      border:1px solid var(--glass-line);
      border-radius:12px;
      padding:12px;
      height:300px;
      overflow-y:auto;
      font-size:13px;
      box-shadow:inset 0 2px 4px rgba(0,0,0,.25);
    }
    .log-line{padding:4px 6px;border-radius:6px;margin:2px 0}
    .log-line:hover{background:rgba(201,169,110,.06)}
    .log-line .t{color:var(--gold);font-weight:600;margin-right:6px}
    .log-line.admin{background:rgba(201,169,110,.1);border-left:3px solid var(--gold)}

    .chat-section{
      background:rgba(12,16,26,.7);
      border:1px solid var(--glass-line);
      border-radius:12px;
      padding:12px;
      height:200px;
      overflow-y:auto;
      font-size:13px;
      box-shadow:inset 0 2px 4px rgba(0,0,0,.25);
      margin-bottom:8px;
    }
    .chat-input-row{display:flex;gap:8px}
    .chat-input-row input{flex:1;padding:8px;border-radius:8px;border:1px solid var(--glass-line);background:#0f1421cc;color:var(--text)}

    .muted{color:var(--muted);font-size:12px}
    .hidden{display:none !important}

    /* 링크 모달 */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:100}
    .modal.show{display:flex}
    .modal-card{
      width:min(700px,95vw);max-height:90vh;overflow-y:auto;
      background:var(--glass);border:1px solid var(--glass-line);border-radius:14px;padding:20px;
      backdrop-filter:blur(20px);
      box-shadow:0 20px 40px rgba(0,0,0,.4);
    }
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .modal-title{font-family:var(--font-serif);color:var(--gold-bright);font-size:20px;margin:0}
    .close-btn{background:none;border:none;color:var(--muted);font-size:24px;cursor:pointer;padding:0;width:30px;height:30px}
    .close-btn:hover{color:var(--text)}

    .link-section{margin-bottom:16px}
    .link-section h4{color:var(--gold-bright);margin:0 0 8px;font-size:14px}
    .link-item{display:flex;gap:8px;margin-bottom:8px;align-items:center}
    .link-item input{flex:1;padding:8px;border-radius:8px;border:1px solid var(--glass-line);background:#0f1421cc;color:var(--text);font-size:12px}
    .link-item button{padding:8px 12px;font-size:12px}

    /* 반응형 */
    @media (max-width:1200px){
      .battlefield{grid-template-columns:1fr 1fr;gap:16px}
      .command-center{grid-column:1/-1;order:-1}
      .topbar{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width:800px){
      .battlefield{grid-template-columns:1fr}
      .form-grid{grid-template-columns:1fr}
      .stats-grid{grid-template-columns:repeat(2,1fr)}
      .topbar{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">Pyxis 전투 관리자</h1>

    <!-- 상단 상태바 -->
    <div class="topbar" id="statusBar">
      <div class="topcell">전투 상태: <span id="sStatus">-</span></div>
      <div class="topcell">현재 팀: <span id="sTeam">-</span></div>
      <div class="topcell">라운드/턴: <span id="sRound">-</span></div>
      <div class="topcell">플레이어 수: <span id="sCount">0</span></div>
    </div>

    <!-- 인증 화면 -->
    <section id="authScreen" class="card">
      <h2 class="card-title">관리자 인증</h2>

      <!-- 빠른 전투 생성 -->
      <div class="command-center" style="margin-bottom:16px">
        <h3 style="color:var(--gold-bright);margin:0 0 12px;font-family:var(--font-serif)">새 전투 생성</h3>
        <div style="display:grid;grid-template-columns:1fr 120px;gap:12px;align-items:end">
          <div>
            <label class="form-label" for="battleModeQuick">전투 모드</label>
            <select id="battleModeQuick" class="form-select">
              <option value="1v1">1 vs 1</option>
              <option value="2v2">2 vs 2</option>
              <option value="3v3">3 vs 3</option>
              <option value="4v4">4 vs 4</option>
            </select>
          </div>
          <button id="btnQuickCreate" class="btn">생성</button>
        </div>
        <p class="muted" style="margin-top:8px">생성 후 전투 ID와 관리자 OTP가 자동 입력되고 즉시 인증됩니다.</p>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
        <div>
          <label class="form-label" for="battleId">전투 ID</label>
          <input id="battleId" class="form-input" placeholder="전투 ID 입력" />
        </div>
        <div>
          <label class="form-label" for="adminOtp">관리자 OTP</label>
          <input id="adminOtp" class="form-input" placeholder="관리자 OTP 입력" />
        </div>
      </div>
      <div style="display:flex;gap:10px">
        <button id="btnAuth" class="btn" style="flex:1">인증</button>
        <button id="btnFetch" class="btn-ghost" style="width:120px">조회</button>
      </div>
      <p class="muted" style="margin-top:8px">URL ?battle=, ?token= 값이 있으면 자동으로 입력됩니다.</p>
    </section>

    <!-- 관리자 패널 -->
    <section id="adminScreen" class="hidden">
      <!-- 전투 제어 -->
      <div class="command-center">
        <h3 style="color:var(--gold-bright);margin:0 0 12px;font-family:var(--font-serif)">전투 제어</h3>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
          <button id="btnStart" class="btn">전투 시작</button>
          <button id="btnPause" class="btn btn-ghost">일시정지</button>
          <button id="btnEnd" class="btn btn-danger">전투 종료</button>
          <button id="btnLinks" class="btn btn-success">링크 관리</button>
        </div>
      </div>

      <!-- 배틀필드 -->
      <div class="battlefield">
        <!-- 불사조 기사단 -->
        <div class="team-zone phoenix">
          <div class="team-header">
            <div class="team-name">불사조 기사단</div>
            <div class="team-badge">PHOENIX</div>
          </div>
          
          <div class="roster-section">
            <div class="add-player-form">
              <div class="form-grid">
                <div>
                  <label class="form-label">이름</label>
                  <input type="text" class="form-input small" id="phoenixName" placeholder="플레이어 이름" />
                </div>
                <div>
                  <label class="form-label">이미지 URL (선택)</label>
                  <input type="url" class="form-input small" id="phoenixImage" placeholder="https://..." />
                </div>
              </div>
              <div class="stats-grid">
                <div>
                  <label class="form-label">공격</label>
                  <input type="number" class="form-input small" id="phoenixAtk" min="1" max="5" value="3" />
                </div>
                <div>
                  <label class="form-label">방어</label>
                  <input type="number" class="form-input small" id="phoenixDef" min="1" max="5" value="3" />
                </div>
                <div>
                  <label class="form-label">민첩</label>
                  <input type="number" class="form-input small" id="phoenixAgi" min="1" max="5" value="3" />
                </div>
                <div>
                  <label class="form-label">행운</label>
                  <input type="number" class="form-input small" id="phoenixLuk" min="1" max="5" value="3" />
                </div>
              </div>
              <div class="inventory-grid">
                <div>
                  <label class="form-label">공격 보정기</label>
                  <input type="number" class="form-input small" id="phoenixAtkBuff" min="0" max="3" value="1" />
                </div>
                <div>
                  <label class="form-label">방어 보정기</label>
                  <input type="number" class="form-input small" id="phoenixDefBuff" min="0" max="3" value="1" />
                </div>
                <div>
                  <label class="form-label">디터니</label>
                  <input type="number" class="form-input small" id="phoenixHeal" min="0" max="5" value="2" />
                </div>
              </div>
              <button class="btn btn-small" style="width:100%" onclick="addPlayer('team1')">추가</button>
            </div>
            <div id="phoenixRoster"></div>
          </div>
        </div>

        <!-- 중앙 명령부 -->
        <div class="command-center">
          <h3 style="color:var(--gold-bright);margin:0 0 12px;font-family:var(--font-serif)">전투 로그</h3>
          <div id="logBox" class="log-section"></div>
          
          <h3 style="color:var(--gold-bright);margin:16px 0 8px;font-family:var(--font-serif)">관리자 채팅</h3>
          <div id="chatBox" class="chat-section"></div>
          <div class="chat-input-row">
            <input id="adminChatInput" type="text" placeholder="관리자 메시지 입력..." />
            <button id="btnSendChat" class="btn btn-small">보내기</button>
          </div>

          <div style="display:flex;gap:8px;margin-top:12px">
            <button id="btnClearLog" class="btn-ghost" style="flex:1">로그 지우기</button>
            <button id="btnReload" class="btn-ghost" style="flex:1">새로고침</button>
          </div>
        </div>

        <!-- 죽음을 먹는 자들 -->
        <div class="team-zone death-eater">
          <div class="team-header">
            <div class="team-name">죽음을 먹는 자들</div>
            <div class="team-badge">DEATH EATER</div>
          </div>
          
          <div class="roster-section">
            <div class="add-player-form">
              <div class="form-grid">
                <div>
                  <label class="form-label">이름</label>
                  <input type="text" class="form-input small" id="deathName" placeholder="플레이어 이름" />
                </div>
                <div>
                  <label class="form-label">이미지 URL (선택)</label>
                  <input type="url" class="form-input small" id="deathImage" placeholder="https://..." />
                </div>
              </div>
              <div class="stats-grid">
                <div>
                  <label class="form-label">공격</label>
                  <input type="number" class="form-input small" id="deathAtk" min="1" max="5" value="3" />
                </div>
                <div>
                  <label class="form-label">방어</label>
                  <input type="number" class="form-input small" id="deathDef" min="1" max="5" value="3" />
                </div>
                <div>
                  <label class="form-label">민첩</label>
                  <input type="number" class="form-input small" id="deathAgi" min="1" max="5" value="3" />
                </div>
                <div>
                  <label class="form-label">행운</label>
                  <input type="number" class="form-input small" id="deathLuk" min="1" max="5" value="3" />
                </div>
              </div>
              <div class="inventory-grid">
                <div>
                  <label class="form-label">공격 보정기</label>
                  <input type="number" class="form-input small" id="deathAtkBuff" min="0" max="3" value="1" />
                </div>
                <div>
                  <label class="form-label">방어 보정기</label>
                  <input type="number" class="form-input small" id="deathDefBuff" min="0" max="3" value="1" />
                </div>
                <div>
                  <label class="form-label">디터니</label>
                  <input type="number" class="form-input small" id="deathHeal" min="0" max="5" value="2" />
                </div>
              </div>
              <button class="btn btn-small" style="width:100%" onclick="addPlayer('team2')">추가</button>
            </div>
            <div id="deathRoster"></div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- 링크 관리 모달 -->
  <div id="linkModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-header">
        <h3 class="modal-title">참여 링크 관리</h3>
        <button id="btnCloseModal" class="close-btn" aria-label="닫기">×</button>
      </div>
      
      <div class="link-section">
        <h4>관리자</h4>
        <div class="link-item">
          <input id="linkAdmin" type="text" readonly />
          <button class="btn btn-small" onclick="copyLink('linkAdmin')">복사</button>
        </div>
      </div>

      <div class="link-section">
        <h4>관전자</h4>
        <div class="link-item">
          <input id="linkSpectator" type="text" readonly />
          <button class="btn btn-small" onclick="copyLink('linkSpectator')">복사</button>
        </div>
      </div>

      <div class="link-section">
        <h4>불사조 기사단</h4>
        <div id="phoenixLinks"></div>
      </div>

      <div class="link-section">
        <h4>죽음을 먹는 자들</h4>
        <div id="deathLinks"></div>
      </div>

      <div style="margin-top:16px;display:flex;gap:8px">
        <button id="btnCopyAllLinks" class="btn" style="flex:1">모든 링크 복사</button>
        <button id="btnRefreshLinks" class="btn-ghost" style="width:100px">새로고침</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      'use strict';
      const $ = (s)=>document.querySelector(s);
      const byId = (id)=>document.getElementById(id);

      // Elements
      const elStatus = { s:$('#sStatus'), t:$('#sTeam'), r:$('#sRound'), c:$('#sCount') };
      const elAuth = $('#authScreen');
      const elAdmin = $('#adminScreen');

      const battleIdInput = $('#battleId');
      const adminOtpInput = $('#adminOtp');
      const btnAuth = $('#btnAuth');
      const btnFetch = $('#btnFetch');

      const qcMode = $('#battleModeQuick');
      const btnQuick = $('#btnQuickCreate');

      const btnStart = $('#btnStart');
      const btnPause = $('#btnPause');
      const btnEnd   = $('#btnEnd');
      const btnLinks = $('#btnLinks');
      const btnReload= $('#btnReload');
      const btnClear = $('#btnClearLog');
      const btnSendChat = $('#btnSendChat');

      const logBox = $('#logBox');
      const chatBox = $('#chatBox');
      const adminChatInput = $('#adminChatInput');

      const linkModal = $('#linkModal');
      const btnCloseModal = $('#btnCloseModal');
      const btnCopyAllLinks = $('#btnCopyAllLinks');
      const btnRefreshLinks = $('#btnRefreshLinks');

      let socket = null;
      let currentBattleId = null;
      let currentBattle = null;

      function esc(s=''){return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}

      // ---- UI helpers ----
      function showAdmin(){
        elAuth.style.display='none';
        elAdmin.style.display='block';
              function showAdmin(){
        elAuth.style.display='none';
        elAdmin.style.display='block';
      }
      function showAuth(){
        elAdmin.style.display='none';
        elAuth.style.display='block';
      }

      // ------------------------------
      // 간단 유틸
      // ------------------------------
      function uiStatus(b){
        elStatus.s.textContent = b?.status ?? '-';
        elStatus.t.textContent = b?.currentTeam ?? '-';
        elStatus.r.textContent = `${b?.roundNumber ?? '-'} / ${b?.turnNumber ?? '-'}`;
        const c = (b?.teams?.team1?.players?.length || 0) + (b?.teams?.team2?.players?.length || 0);
        elStatus.c.textContent = c;
      }
      function repeatLabel(n, label){
        const out = [];
        for(let i=0;i<(Number(n)||0);i++) out.push(label);
        return out;
      }
      function buildJoinURL(battleId, playerOtp, name){
        const u = new URL(location.origin);
        u.pathname = '/play';
        u.searchParams.set('battle', battleId);
        if (playerOtp) u.searchParams.set('token', playerOtp);
        if (name) u.searchParams.set('name', name);
        return u.toString();
      }
      function copyText(text){
        navigator.clipboard?.writeText(text).catch(()=>{});
      }
      window.copyLink = function(id){
        const el = byId(id);
        if(el) copyText(el.value || '');
      };

      // ------------------------------
      // API 래퍼
      // ------------------------------
      async function apiCreateBattle(mode){
        const r = await fetch('/api/battles', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ mode })
        });
        if(!r.ok) throw new Error('전투 생성 실패');
        return r.json(); // { id, otps, teams, ... }
      }
      async function apiGetBattle(id){
        const r = await fetch(`/api/battles/${encodeURIComponent(id)}`);
        if(!r.ok) throw new Error('전투 조회 실패');
        return r.json();
      }
      async function apiAddPlayer(id, payload){
        const r = await fetch(`/api/battles/${encodeURIComponent(id)}/players`, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        if(!r.ok) throw new Error('플레이어 추가 실패');
        return r.json();
      }
      async function apiLinks(id){
        const r = await fetch(`/api/admin/battles/${encodeURIComponent(id)}/links`, { method:'POST' });
        if(!r.ok) throw new Error('링크 조회 실패');
        return r.json();
      }
      async function apiControl(id, cmd){ // 'start' | 'end'
        const r = await fetch(`/api/admin/battles/${encodeURIComponent(id)}/${cmd}`, { method:'POST' });
        if(!r.ok) throw new Error('전투 제어 실패');
        return r.json();
      }

      // ------------------------------
      // 렌더: 로스터 / 로그 / 채팅
      // ------------------------------
      function renderRoster(teamKey, targetSel, battle){
        const wrap = byId(targetSel);
        const team = battle?.teams?.[teamKey];
        const players = team?.players || [];
        const playerOtp = battle?.otps?.player || (Array.isArray(battle?.otps?.players) ? battle.otps.players[0] : '');

        if(!players.length){
          wrap.innerHTML = `<div class="muted">등록된 플레이어가 없습니다.</div>`;
          return;
        }

        wrap.innerHTML = players.map(p=>{
          const inv = (p.inventory||[]).join(', ') || '아이템 없음';
          const stats = `ATK ${p.stats?.attack ?? '-'} · DEF ${p.stats?.defense ?? '-'} · AGI ${p.stats?.agility ?? '-'} · LUK ${p.stats?.luck ?? '-'}`;
          const url = buildJoinURL(battle.id, playerOtp, p.name);
          return `
            <div class="player-card">
              <div class="player-header">
                <div class="player-name">${esc(p.name)}</div>
                <div class="player-controls">
                  <button class="btn btn-small" data-link="${esc(url)}">링크 복사</button>
                </div>
              </div>
              <div class="player-stats">${stats}</div>
              <div class="player-inventory">${inv}</div>
            </div>
          `;
        }).join('');

        // 버튼 이벤트
        wrap.querySelectorAll('button[data-link]').forEach(btn=>{
          btn.addEventListener('click', ()=> copyText(btn.dataset.link));
        });
      }

      function renderLogs(battle){
        const arr = battle?.battleLog || [];
        logBox.innerHTML = arr.map(e=>{
          const t = new Date(e.timestamp||Date.now()).toLocaleTimeString();
          const cls = e.type === 'system' ? 'log-line admin' : 'log-line';
          return `<div class="${cls}"><span class="t">[${t}]</span>${esc(e.message||'')}</div>`;
        }).join('');
        logBox.scrollTop = logBox.scrollHeight;
      }

      function renderChat(battle){
        const arr = battle?.chatLog || [];
        chatBox.innerHTML = arr.map(c=>{
          const t = new Date(c.timestamp||Date.now()).toLocaleTimeString();
          return `<div class="log-line"><span class="t">[${t}]</span><b>${esc(c.sender||'')}</b>: ${esc(c.message||'')}</div>`;
        }).join('');
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function renderAll(battle){
        currentBattle = battle;
        uiStatus(battle);
        renderRoster('team1', 'phoenixRoster', battle);
        renderRoster('team2', 'deathRoster', battle);
        renderLogs(battle);
        renderChat(battle);
        showAdmin();
      }

      // ------------------------------
      // 링크 모달
      // ------------------------------
      async function refreshLinks(){
        if(!currentBattleId) return;
        const linkData = await apiLinks(currentBattleId); // { urls, otps }
        const b = await apiGetBattle(currentBattleId);

        // 기본 링크
        byId('linkAdmin').value = linkData?.urls?.admin || '';
        byId('linkSpectator').value = linkData?.urls?.spectator || '';

        const playerOtp = b?.otps?.player || (Array.isArray(b?.otps?.players) ? b.otps.players[0] : '');
        const team1 = b?.teams?.team1?.players || [];
        const team2 = b?.teams?.team2?.players || [];

        const makeRows = (players) => players.map(p=>{
          const url = buildJoinURL(b.id, playerOtp, p.name);
          const safeId = 'inp_'+Math.random().toString(36).slice(2,8);
          return `
            <div class="link-item">
              <input id="${safeId}" type="text" readonly value="${esc(url)}" />
              <button class="btn btn-small" data-target="${safeId}">복사</button>
            </div>
          `;
        }).join('') || `<div class="muted">플레이어 없음</div>`;

        byId('phoenixLinks').innerHTML = makeRows(team1);
        byId('deathLinks').innerHTML   = makeRows(team2);

        // 개별 복사 버튼
        linkModal.querySelectorAll('button[data-target]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const id = btn.getAttribute('data-target');
            const el = byId(id);
            if(el){ el.select(); copyText(el.value); }
          });
        });
      }

      function openLinkModal(){
        linkModal.classList.add('show');
        refreshLinks().catch(()=>{});
      }
      function closeLinkModal(){
        linkModal.classList.remove('show');
      }

      btnLinks.addEventListener('click', openLinkModal);
      btnCloseModal.addEventListener('click', closeLinkModal);
      linkModal.addEventListener('click', (e)=>{ if(e.target === linkModal) closeLinkModal(); });
      btnRefreshLinks.addEventListener('click', ()=> refreshLinks().catch(()=>{}));
      btnCopyAllLinks.addEventListener('click', ()=>{
        const allInputs = linkModal.querySelectorAll('.link-item input');
        const text = Array.from(allInputs).map(i=>i.value).join('\n');
        copyText(text);
      });

      // ------------------------------
      // 소켓
      // ------------------------------
      function connectSocket(id, otp){
        if(socket){ try{ socket.disconnect(); }catch{} }
        socket = io({ path:'/socket.io/', transports:['websocket','polling'] });
        socket.on('connect', ()=>{
          socket.emit('adminAuth', { battleId: id, otp });
        });
        socket.on('authSuccess', ({ battle })=>{
          currentBattleId = battle.id;
          renderAll(battle);
        });
        socket.on('battleUpdate', (battle)=> renderAll(battle));
        socket.on('authError', (m)=> alert('인증 실패: '+m));
      }

      // ------------------------------
      // 플레이어 추가 (폼 → 서버)
      // ------------------------------
      window.addPlayer = async function(teamKey){
        if(!currentBattleId) { alert('먼저 인증하세요.'); return; }

        const isT1 = teamKey === 'team1';
        const prefix = isT1 ? 'phoenix' : 'death';

        const name = byId(prefix+'Name').value.trim();
        if(!name){ alert('이름을 입력하세요.'); return; }

        const imageUrl = byId(prefix+'Image').value.trim();
        const atk = Number(byId(prefix+'Atk').value || 3);
        const def = Number(byId(prefix+'Def').value || 3);
        const agi = Number(byId(prefix+'Agi').value || 3);
        const luk = Number(byId(prefix+'Luk').value || 3);

        const atkBuff = Number(byId(prefix+'AtkBuff').value || 0);
        const defBuff = Number(byId(prefix+'DefBuff').value || 0);
        const heal    = Number(byId(prefix+'Heal').value || 0);

        const inventory = [
          ...repeatLabel(atkBuff, '공격 보정기'),
          ...repeatLabel(defBuff, '방어 보정기'),
          ...repeatLabel(heal, '디터니'),
        ];

        try{
          await apiAddPlayer(currentBattleId, {
            name,
            team: teamKey,
            stats: { attack: atk, defense: def, agility: agi, luck: luk },
            inventory,
            imageUrl
          });
          const b = await apiGetBattle(currentBattleId);
          renderAll(b);

          // 이름/아이템 수량만 초기화
          byId(prefix+'Name').value = '';
          byId(prefix+'AtkBuff').value = '1';
          byId(prefix+'DefBuff').value = '1';
          byId(prefix+'Heal').value    = '2';
        }catch(e){
          alert(e.message || '추가 실패');
        }
      };

      // ------------------------------
      // 버튼 동작
      // ------------------------------
      btnQuick.addEventListener('click', async ()=>{
        try{
          const mode = qcMode.value;
          const battle = await apiCreateBattle(mode);
          // 최신 스키마 대응 (battle | 전체)
          const id = battle.id || battle?.battle?.id || battle?.battleId;
          const adminOtp = (battle.otps?.admin) || (battle?.battle?.otps?.admin) || '';
          if(!id || !adminOtp) {
            alert('전투가 생성되었지만 ID/OTP를 찾지 못했습니다.');
            return;
          }
          battleIdInput.value = id;
          adminOtpInput.value = adminOtp;
          connectSocket(id, adminOtp);
        }catch(e){
          alert(e.message || '생성 실패');
        }
      });

      btnFetch.addEventListener('click', async ()=>{
        const id = battleIdInput.value.trim();
        if(!id) return alert('전투 ID를 입력하세요.');
        try{
          const b = await apiGetBattle(id);
          currentBattleId = b.id;
          renderAll(b);
        }catch(e){
          alert(e.message || '조회 실패');
        }
      });

      btnAuth.addEventListener('click', ()=>{
        const id = battleIdInput.value.trim();
        const otp = adminOtpInput.value.trim();
        if(!id || !otp) return alert('전투 ID/관리자 OTP를 입력하세요.');
        connectSocket(id, otp);
      });

      btnStart.addEventListener('click', async ()=>{
        if(!currentBattleId) return;
        try{
          await apiControl(currentBattleId, 'start');
          const b = await apiGetBattle(currentBattleId);
          renderAll(b);
        }catch(e){ alert(e.message || '시작 실패'); }
      });

      btnEnd.addEventListener('click', async ()=>{
        if(!currentBattleId) return;
        if(!confirm('전투를 종료할까요?')) return;
        try{
          await apiControl(currentBattleId, 'end');
          const b = await apiGetBattle(currentBattleId).catch(()=>null);
          if(b) renderAll(b);
        }catch(e){ alert(e.message || '종료 실패'); }
      });

      btnClear.addEventListener('click', ()=>{
        logBox.innerHTML = '';
      });

      btnReload.addEventListener('click', async ()=>{
        if(!currentBattleId) return;
        try{
          const b = await apiGetBattle(currentBattleId);
          renderAll(b);
        }catch(e){ alert('새로고침 실패'); }
      });

      btnSendChat.addEventListener('click', ()=>{
        const msg = adminChatInput.value.trim();
        if(!msg || !socket) return;
        socket.emit('chatMessage', { message: msg });
        adminChatInput.value = '';
      });

      // ------------------------------
      // 쿼리 파라미터로 자동 채움
      // ------------------------------
      (function boot(){
        const p = new URLSearchParams(location.search);
        const b = p.get('battle') || p.get('b');
        const t = p.get('token')  || p.get('otp') || p.get('t');

        if(b) battleIdInput.value = b;
        if(t) adminOtpInput.value = t;

        if(b && t){
          connectSocket(b, t);
        } else if (b){
          // id만 있으면 조회만
          apiGetBattle(b).then(renderAll).catch(()=>{});
        } else {
          showAuth();
        }
      })();

    })();
  </script>
</body>
</html>
