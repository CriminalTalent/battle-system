<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pyxis - 플레이어 입장</title>
<link rel="icon" href="data:,">
<script src="/socket.io/socket.io.js"></script>
<style>
:root{ --deep-navy:#0a0f1a; --navy:#0f1419; --navy-light:#1a1f26;
  --gold:#E5C88A; --gold-light:#F5E6B8; --gold-dark:#C8A882;
  --accent:#2a3441; --text-primary:#F5E6B8; --text-secondary:#D4C39A;
  --border:rgba(229,200,138,.3); --border-light:rgba(229,200,138,.15);
  --glass:rgba(15,20,25,.85); --glass-dark:rgba(10,15,26,.9); }
*{box-sizing:border-box;margin:0;padding:0}
body{background:linear-gradient(135deg,var(--deep-navy),var(--navy) 50%,var(--navy-light));
  color:var(--text-primary);font-family:'Cinzel','Times New Roman',serif;min-height:100vh}
.wrap{max-width:720px;margin:0 auto;padding:20px;display:flex;flex-direction:column;gap:16px}
.card{background:var(--glass);border:1px solid var(--border-light);border-radius:12px;padding:18px}
h1{color:var(--gold);margin-bottom:8px;font-size:1.6rem}
label{display:block;margin:6px 0;color:var(--gold);font-weight:600}
.input,.select{width:100%;min-height:44px;padding:10px 12px;border-radius:8px;background:rgba(10,15,26,.8);border:1px solid var(--border-light);color:var(--text-primary)}
.row{display:grid;gap:10px}
.cols-2{grid-template-columns:1fr 1fr}
.btn{min-height:44px;border-radius:8px;border:1px solid var(--gold);background:linear-gradient(135deg,var(--gold-dark),var(--gold));color:#0a0f1a;font-weight:700;cursor:pointer}
.pill{display:inline-block;background:rgba(229,200,138,.12);border:1px solid var(--border-light);color:var(--gold);border-radius:16px;padding:6px 10px;font-size:.85rem}
.item-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.item-box{border:1px solid var(--border-light);border-radius:8px;padding:8px;background:rgba(10,15,26,.7);display:grid;grid-template-columns:1fr auto;gap:6px;align-items:center}
.counter input{width:56px;text-align:center}
.log{height:220px;overflow:auto;background:rgba(10,15,26,.8);border:1px solid var(--border-light);border-radius:8px;padding:10px;font-family:ui-monospace,Consolas,monospace}
.small{font-size:.9rem;color:var(--text-secondary)}
</style>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <h1>플레이어 입장</h1>
      <div class="small">배포받은 링크로 접속해야 인증(토큰)이 포함됩니다</div>
      <div class="row cols-2" style="margin-top:8px">
        <div><label>전투 ID</label><input id="battleId" class="input" readonly></div>
        <div><label>토큰</label><input id="token" class="input" readonly></div>
      </div>
    </section>

    <section class="card">
      <h2 style="color:var(--gold);margin-bottom:8px">캐릭터 생성</h2>
      <div class="row cols-2">
        <div><label>이름</label><input id="name" class="input" placeholder="중복 불가"></div>
        <div>
          <label>팀</label>
          <select id="team" class="select">
            <option value="team1">불사조 기사단</option>
            <option value="team2">죽음을 먹는자들</option>
          </select>
        </div>
      </div>
      <div class="row cols-2" style="margin-top:8px">
        <div><label>이미지 URL(선택)</label><input id="imageUrl" class="input" placeholder="https://..."></div>
        <div class="pill" id="hint">-</div>
      </div>
      <div class="row cols-2" style="margin-top:8px">
        <div><label>공격</label><input id="atk" class="input" type="number" min="1" max="5" value="3"></div>
        <div><label>방어</label><input id="def" class="input" type="number" min="1" max="5" value="3"></div>
      </div>
      <div class="row cols-2" style="margin-top:8px">
        <div><label>민첩</label><input id="agi" class="input" type="number" min="1" max="5" value="3"></div>
        <div><label>행운</label><input id="luk" class="input" type="number" min="1" max="5" value="3"></div>
      </div>

      <div style="margin-top:10px">
        <label>아이템 수량</label>
        <div class="item-grid">
          <div class="item-box"><b>공격 보정기</b><span class="counter"><input id="i_atk" class="input" type="number" min="0" value="0"></span></div>
          <div class="item-box"><b>방어 보정기</b><span class="counter"><input id="i_def" class="input" type="number" min="0" value="0"></span></div>
          <div class="item-box"><b>디터니</b><span class="counter"><input id="i_heal" class="input" type="number" min="0" value="0"></span></div>
        </div>
      </div>

      <div class="row cols-2" style="margin-top:12px">
        <button id="btnJoin" class="btn">플레이어 등록</button>
        <button id="btnConnect" class="btn">실시간 연결</button>
      </div>
    </section>

    <section class="card">
      <h2 style="color:var(--gold);margin-bottom:8px">내 상태 / 전투 로그</h2>
      <div class="row cols-2">
        <div class="pill" id="me">-</div>
        <div class="pill" id="turn">현재 팀: -</div>
      </div>
      <div id="log" class="log" style="margin-top:8px"></div>
    </section>
  </main>

<script>
'use strict';
const $ = s => document.querySelector(s);
const qs = new URLSearchParams(location.search);
const BATTLE = qs.get('battle') || '';
const PLAYER_OTP = qs.get('token') || qs.get('otp') || '';
let PLAYER_ID = '';
let socket = null;

$('#battleId').value = BATTLE;
$('#token').value = PLAYER_OTP;

const clamp=(v,min,max)=>Math.max(min,Math.min(max,Number(v||0)));
const invFromCounts=(a,b,c)=>{const out=[]; for(let i=0;i<clamp(a,0,99);i++) out.push('공격 보정기'); for(let i=0;i<clamp(b,0,99);i++) out.push('방어 보정기'); for(let i=0;i<clamp(c,0,99);i++) out.push('디터니'); return out; };
const escapeHtml = s => (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

async function api(url,opt={}){ const r = await fetch(url,{ headers:{'content-type':'application/json'}, ...opt }); if(!r.ok) throw new Error(`${r.status} ${await r.text()}`); const t = await r.text(); try{return JSON.parse(t);}catch{return t;} }

function draw(b){
  if(!b) return;
  $('#turn').textContent = `현재 팀: ${b.currentTeam ?? '-'}`;
  const lines = (b.battleLog||[]).slice(-40).map(e=>`[${new Date(e.timestamp).toLocaleTimeString()}] ${e.message}`);
  $('#log').innerHTML = lines.map(escapeHtml).join('<br>');
}

$('#btnJoin').onclick = async ()=>{
  if(!BATTLE) return alert('전투 ID 없음');
  const name = $('#name').value.trim(); if(!name) return alert('이름을 입력하세요');
  const team = $('#team').value;
  const stats = { attack:clamp($('#atk').value,1,5), defense:clamp($('#def').value,1,5), agility:clamp($('#agi').value,1,5), luck:clamp($('#luk').value,1,5) };
  const inventory = invFromCounts($('#i_atk').value,$('#i_def').value,$('#i_heal').value);
  const imageUrl = $('#imageUrl').value.trim();
  const res = await api(`/api/battles/${BATTLE}/players`,{ method:'POST', body: JSON.stringify({ name, team, stats, inventory, imageUrl }) });
  PLAYER_ID = res?.player?.id || '';
  $('#me').textContent = `나: ${res?.player?.name} · HP ${res?.player?.hp}/${res?.player?.maxHp}`;
  $('#hint').textContent = '등록 완료';
  draw(await api(`/api/battles/${BATTLE}`));
};

function connect(){
  if(!BATTLE || !PLAYER_ID || !PLAYER_OTP) return alert('전투/플레이어/토큰 정보가 필요합니다');
  if(socket){ try{socket.disconnect();}catch{} socket=null; }
  socket = io({ path:'/socket.io/', transports:['websocket','polling'] });
  socket.on('connect', ()=>{
    socket.emit('playerAuth',{ battleId:BATTLE, playerId:PLAYER_ID, otp:PLAYER_OTP });
  });
  socket.on('authSuccess', d => d?.battle && draw(d.battle));
  socket.on('battleUpdate', b => draw(b));
  socket.on('authError', m => alert(`인증 실패: ${m}`));
}
$('#btnConnect').onclick = connect;

// 초기 상태 표시
(async function boot(){ if(BATTLE){ draw(await api(`/api/battles/${BATTLE}`)); }})();
</script>
</body>
</html>
