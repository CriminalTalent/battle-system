<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PYXIS 관리자</title>
  <link rel="icon" href="data:,">
  <style>
    :root{
      --bg:#0b1117; --panel:#121a23; --panel-2:#0f1620; --fg:#e9e4d7;
      --muted:#cdbfa5; --brand:#dcc7a2; --line:rgba(220,199,162,.22);
      --accent:#2f81f7; --danger:#7e1b14; --ok:#2d5a27;
      --ink:#0b0d10;
    }
    *{box-sizing:border-box}
    html,body{background:var(--bg);color:var(--fg);margin:0;font-family:ui-sans-serif,system-ui,AppleSDGothicNeo,Segoe UI,Roboto,Helvetica,Arial,'Apple Color Emoji','Segoe UI Emoji';}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    h2{font-size:18px;margin:0 0 12px 0}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:10px;margin:16px 0;padding:16px}
    .row{display:flex;gap:12px;align-items:center}
    .row.wrap{flex-wrap:wrap}
    .between{justify-content:space-between}
    label{font-size:12px;color:var(--muted)}
    input[type=text],input[type=number],select,textarea{width:100%;background:var(--panel-2);color:var(--fg);border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:14px;outline:none}
    input[readonly]{opacity:.9}
    .btn{border-radius:12px;border:1px solid var(--line);background:var(--brand);color:var(--ink);padding:10px 14px;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--fg)}
    .btn.danger{background:#3a0f0c;border-color:#5c1a16;color:#f7d6cf}
    .btn.block{display:block;width:100%}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:var(--panel-2);font-size:12px;color:var(--muted)}
    .logs{max-height:240px;overflow:auto;background:var(--panel-2);border:1px solid var(--line);border-radius:10px;padding:8px}
    .log{padding:6px 8px;border-bottom:1px solid rgba(255,255,255,.06);font-size:13px}
    .log.rule{background:var(--brand);color:#000;border-radius:6px;margin:6px 0}
    .section-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .field{margin:8px 0}
    .hint{color:var(--muted);font-size:12px}
    .avatar-preview{width:60px;height:80px;border-radius:6px;border:1px solid var(--line);object-fit:cover;background:#111;display:block}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- 전투 제어 -->
    <div class="card">
      <div class="section-title"><h2>전투 제어</h2><span class="pill" id="connState">연결됨</span></div>
      <div class="field">
        <label>전투 모드</label>
        <select id="battleMode">
          <option value="1v1">1v1</option>
          <option value="2v2" selected>2v2</option>
          <option value="3v3">3v3</option>
          <option value="4v4">4v4</option>
        </select>
      </div>
      <div class="row">
        <button id="btnCreate" class="btn">전투 생성</button>
        <button id="btnStart" class="btn">시작</button>
        <button id="btnPause" class="btn ghost">일시정지</button>
        <button id="btnResume" class="btn ghost">재개</button>
        <button id="btnEnd" class="btn danger">종료</button>
      </div>
    </div>

    <!-- 링크 / 비밀번호 -->
    <div class="card">
      <h2>링크 / 비밀번호</h2>
      <button id="btnGenLinks" class="btn block">참가자 링크 / 관전자 비번 생성</button>
      <div class="field">
        <label>관전자 비밀번호</label>
        <input id="spectatorOtp" type="text" readonly/>
      </div>
      <div class="field">
        <label>관전자 URL</label>
        <input id="spectatorUrl" type="text" readonly/>
      </div>
      <div class="hint">참가자 개별 링크(이름/팀/OTP 포함)는 아래 목록에 표시됩니다.</div>
      <div id="playerLinks" class="field"></div>
    </div>

    <!-- 전투 참가자 관리 -->
    <div class="card">
      <h2>전투 참가자 관리</h2>
      <div class="grid">
        <div class="field">
          <label>이름</label>
          <input id="playerName" type="text" placeholder="전투 참가자 이름"/>
        </div>
        <div class="field">
          <label>팀</label>
          <select id="playerTeam">
            <option value="A">A팀</option>
            <option value="B" selected>B팀</option>
          </select>
        </div>
        <div class="field">
          <label>HP</label>
          <input id="playerHp" type="number" value="100" min="1" max="100"/>
        </div>
      </div>
      <div class="grid">
        <div class="field">
          <label>초상화 업로드</label>
          <input id="avatarFile" type="file" accept="image/*"/>
          <img id="avatarPreview" class="avatar-preview" alt="미리보기"/>
          <div class="hint">업로드 시 서버가 `/uploads/avatars/...` URL을 돌려줍니다. 이 URL이 플레이어/관전자에 그대로 표시됩니다.</div>
        </div>
        <div>
          <div class="grid-3">
            <div class="field"><label>공격 (1-5)</label><input id="statAttack" type="number" min="1" max="5" value="3"/></div>
            <div class="field"><label>방어 (1-5)</label><input id="statDefense" type="number" min="1" max="5" value="3"/></div>
            <div class="field"><label>민첩 (1-5)</label><input id="statAgility" type="number" min="1" max="5" value="3"/></div>
          </div>
          <div class="grid-3">
            <div class="field"><label>행운 (1-5)</label><input id="statLuck" type="number" min="1" max="5" value="3"/></div>
            <div class="field"><label>디터니</label><input id="itemDittany" type="number" min="0" value="0"/></div>
            <div class="field"><label>공격 보정기</label><input id="itemAtkBoost" type="number" min="0" value="0"/></div>
          </div>
          <div class="grid-3">
            <div class="field"><label>방어 보정기</label><input id="itemDefBoost" type="number" min="0" value="0"/></div>
          </div>
        </div>
      </div>
      <button id="btnAddPlayer" class="btn block">전투 참가자 추가</button>

      <div id="playerList" class="field"></div>
    </div>

    <!-- 로그 / 채팅 -->
    <div class="card">
      <h2>로그</h2>
      <div id="logs" class="logs"></div>
      <div class="row" style="margin-top:8px">
        <input id="chatMsg" type="text" placeholder="관리자 메시지"/>
        <button id="btnSend" class="btn">보내기</button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
  (()=>{
    // ===== 유틸 =====
    const $ = s => document.querySelector(s);
    const qs = s => Array.from(document.querySelectorAll(s));
    const escapeHtml = t => String(t??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',\"'\":'&#39;' }[m]));
    const addLog = (msg, cls='')=>{
      const el = document.createElement('div');
      el.className = 'log '+cls;
      el.textContent = msg;
      const logs = $('#logs');
      logs.appendChild(el);
      logs.scrollTop = logs.scrollHeight;
    };
    const copy = async (t)=>{ try{ await navigator.clipboard.writeText(t) }catch(e){} };

    // ===== 상태 =====
    const sp = new URL(location.href).searchParams;
    const battleId = (sp.get('battle')||'').trim();
    let socket = io({ path: '/socket.io' });

    socket.on('connect', ()=>{ $('#connState').textContent='연결됨'; if(battleId) socket.emit('join', { battleId }); });
    socket.on('disconnect', ()=>{ $('#connState').textContent='연결 끊김'; });

    // ===== 서버 이벤트 수신 (호환) =====
    const once = (fn)=>{ let called=false; return (...a)=>{ if(called) return; called=true; fn(...a);} };

    const onBattleUpdate = (snap)=>{
      // 필요 시 관리자 화면 요소 갱신 (간단 표기만)
      // addLog('스냅샷 수신', '');  // 디버그는 표시하지 않음
    };
    socket.on('battleUpdate', onBattleUpdate);
    socket.on('battle:update', onBattleUpdate);

    const onBattleLog = (entry)=>{
      if(!entry || !entry.message) return;
      const isRule = /선공|라운드|교대|판정|중계/.test(entry.message);
      addLog(entry.message, isRule ? 'rule' : '');
    };
    socket.on('battle:log', onBattleLog);
    socket.on('battleLog', onBattleLog);

    // 채팅(수신은 호환, 표시는 1회)
    let lastChatId = null;
    const onChat = (payload)=>{
      const msg = payload?.message || payload?.text || '';
      const name = payload?.name || payload?.playerName || '익명';
      if(!msg) return;
      addLog(`[${name}] ${msg}`);
    };
    socket.on('chatMessage', onChat);
    socket.on('battle:chat', onChat);

    // ===== 전투 제어 버튼 =====
    $('#btnCreate').addEventListener('click', async ()=>{
      try{
        const mode = $('#battleMode').value;
        const res = await fetch('/api/battles', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ mode })
        });
        const data = await res.json();
        const id = data?.id || data?.battleId || data?.battle?.id;
        if(id){
          addLog(`전투 생성: ${id}`);
          // URL에 battle 파라미터 없으면 붙여줌
          if(!battleId){
            const u = new URL(location.href);
            u.searchParams.set('battle', id);
            history.replaceState(null,'',u.toString());
            socket.emit('join', { battleId:id });
          }
        }else{
          addLog('전투 생성 실패', 'error');
        }
      }catch(e){ addLog('전투 생성 실패', 'error'); }
    });

    $('#btnStart').addEventListener('click', ()=>{ if(battleId) socket.emit('startBattle', { battleId }, r=> addLog(r?.ok?'전투 시작':'전투 시작 실패')); });
    $('#btnPause').addEventListener('click', ()=>{ if(battleId) socket.emit('pauseBattle', { battleId }, r=> addLog(r?.ok?'일시정지':'일시정지 실패')); });
    $('#btnResume').addEventListener('click',()=>{ if(battleId) socket.emit('resumeBattle',{ battleId }, r=> addLog(r?.ok?'재개':'재개 실패')); });
    $('#btnEnd').addEventListener('click',   ()=>{ if(battleId) socket.emit('endBattle',   { battleId }, r=> addLog(r?.ok?'전투 종료':'전투 종료 실패')); });

    // ===== 링크/비밀번호 생성 (신/구/변형 키 모두 수용) =====
    function pick(obj, ...paths){
      for(const p of paths){
        const v = p.split('.').reduce((acc,key)=> (acc && acc[key]!=null) ? acc[key] : undefined, obj);
        if(v!=null) return v;
      }
      return undefined;
    }
    function unifyPlayers(payload){
      if(Array.isArray(payload?.players)) return payload.players;
      if(Array.isArray(payload?.playerLinks)){
        return payload.playerLinks.map(pl=>({
          playerId: pl.playerId || pl.id,
          name: pl.playerName || pl.name,
          team: pl.team,
          token: pl.otp,
          url: pl.url
        }));
      }
      return [];
    }
    async function postJson(url){
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({}) });
      if(!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }
    async function onGeneratePlayerLinks(){
      const id = (new URL(location.href)).searchParams.get('battle') || '';
      if(!id){ addLog('전투 ID가 없습니다(?battle=...)','error'); return; }
      let data;
      try{ data = await postJson(`/api/admin/battles/${id}/links`); }
      catch{ data = await postJson(`/api/battles/${id}/links`); }
      console.log('[LINKS_RAW]', data);

      const otp = pick(data, 'spectator.otp','spectator.code','spectator.password','spectatorOtp','otp') || '';
      let url = pick(data, 'spectator.url','spectatorUrl','url') || '';
      if(!url && otp){ url = `${location.origin}/spectator.html?battle=${encodeURIComponent(id)}&otp=${encodeURIComponent(otp)}`; addLog('관전자 URL(폴백) 생성됨'); }
      $('#spectatorOtp').value = otp;
      $('#spectatorUrl').value = url;

      const list = unifyPlayers(data);
      const base = location.origin;
      const box = $('#playerLinks'); box.innerHTML='';
      list.forEach(p=>{
        const link = p.url || `${base}/player.html?battle=${encodeURIComponent(id)}&playerId=${encodeURIComponent(p.playerId||'')}&name=${encodeURIComponent(p.name||'')}&team=${p.team||''}`;
        const row = document.createElement('div');
        row.className = 'field';
        row.innerHTML = `
          <div class="row between" style="gap:8px">
            <div><strong>${escapeHtml(p.name||'')}</strong> <span class="pill">${escapeHtml(p.team||'')}</span></div>
            <button class="btn ghost" data-copy="${escapeHtml(link)}">URL복사</button>
          </div>
          <input type="text" readonly value="${escapeHtml(link)}">
        `;
        box.appendChild(row);
      });
      addLog('링크/비밀번호 생성 완료');
      if(otp) addLog('관전자 비밀번호 설정됨: '+otp);
      if(url) addLog('관전자 URL 설정됨: '+url);
    }
    $('#btnGenLinks').addEventListener('click', (ev)=>{ ev.stopImmediatePropagation?.(); onGeneratePlayerLinks(); });
    document.addEventListener('click', (e)=>{
      const t = e.target;
      if(t && t.matches('[data-copy]')){ copy(t.getAttribute('data-copy')||''); addLog('복사됨'); }
    });

    // ===== 아바타 업로드 =====
    $('#avatarFile').addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const fd = new FormData(); fd.append('avatar', f);
      try{
        const res = await fetch('/api/upload/avatar', { method:'POST', body: fd });
        const data = await res.json();
        const url = data?.url || data?.filepath || data?.path;
        if(url){ $('#avatarPreview').src = url; $('#avatarPreview').onerror = ()=>{ $('#avatarPreview').src='' }; }
        addLog(url ? '아바타 업로드 완료' : '아바타 업로드 실패', url?'':'error');
      }catch{ addLog('아바타 업로드 실패','error'); }
    });

    // ===== 참가자 추가/삭제 =====
    $('#btnAddPlayer').addEventListener('click', ()=>{
      const id = (new URL(location.href)).searchParams.get('battle') || '';
      if(!id){ addLog('전투 ID가 없습니다','error'); return; }
      const payload = {
        battleId:id,
        name: $('#playerName').value.trim(),
        team: $('#playerTeam').value,
        hp: Number($('#playerHp').value||100),
        avatar: $('#avatarPreview').getAttribute('src') || null,
        stats: {
          attack: Number($('#statAttack').value||1),
          defense: Number($('#statDefense').value||1),
          agility: Number($('#statAgility').value||1),
          luck: Number($('#statLuck').value||1),
        },
        items: {
          dittany: Number($('#itemDittany').value||0),
          attackBooster: Number($('#itemAtkBoost').value||0),
          defenseBooster: Number($('#itemDefBoost').value||0),
        }
      };
      socket.emit('addPlayer', payload, (res)=>{
        addLog(res?.ok ? '참가자 추가 완료' : '참가자 추가 실패');
      });
    });

    // 삭제 위임
    document.addEventListener('click', (e)=>{
      const del = e.target.closest('[data-del]');
      if(!del) return;
      const id = (new URL(location.href)).searchParams.get('battle') || '';
      if(!id) return;
      const pid = del.getAttribute('data-del');
      socket.emit('deletePlayer', { battleId:id, playerId: pid }, (res)=> addLog(res?.ok?'삭제 완료':'삭제 실패'));
    });

    // ===== 채팅 송신 (emit은 chatMessage 단일) =====
    const sendChat = ()=>{
      const id = (new URL(location.href)).searchParams.get('battle') || '';
      const m = $('#chatMsg').value.trim(); if(!m || !id) return;
      socket.emit('chatMessage', { battleId:id, name:'관리자', message:m });
      $('#chatMsg').value='';
    };
    $('#btnSend').addEventListener('click', sendChat);
    $('#chatMsg').addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendChat(); });
  })();
  </script>
</body>
</html>
