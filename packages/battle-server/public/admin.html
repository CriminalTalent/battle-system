<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PYXIS 관리자</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root{
      --deep-navy:#0B1117; --dark-navy:#131B24; --mid-navy:#1A242F; --light-navy:#2A3441;
      --gold-1:#DCC7A2; --gold-2:#D4BA8D; --gold-bright:#E6D5B7; --gold-shimmer:#F2E8D4;
      --border:#2A3441; --border-light:#3A4451; --border-subtle:#1F2937; --border-gold:#DCC7A2;
      --glass-1:rgba(26,36,47,.65); --glass-2:rgba(26,36,47,.85); --glass-3:rgba(26,36,47,.95);
      --blur-light:blur(4px); --blur-medium:blur(8px); --blur-heavy:blur(12px);
      --text:#E5E7EB; --text-dim:#9CA3AF; --text-muted:#6B7280; --text-accent:#DCC7A2;
      --success:#10B981; --warning:#F59E0B; --danger:#EF4444; --info:#3B82F6;
      --shadow:0 4px 16px rgba(0,0,0,.25); --shadow-soft:0 2px 8px rgba(0,0,0,.15);
      --radius:12px; --radius-sm:8px; --radius-small:6px; --transition:.2s cubic-bezier(.4,0,.2,1);
    }
    body{ margin:0; font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto; background:linear-gradient(135deg,var(--deep-navy) 0%,var(--dark-navy) 100%); color:var(--text); min-height:100vh; }
    *{ box-sizing:border-box; }

    .header{
      background:var(--glass-3); border-bottom:var(--border);
      backdrop-filter:var(--blur-medium); position:sticky; top:0; z-index:1000;
    }
    .header-inner{ max-width:1280px; margin:0 auto; padding:16px 20px; display:flex; justify-content:space-between; align-items:center; }
    .brand .logo{ font-family:Cinzel,serif; font-size:24px; font-weight:700; color:var(--gold-bright); letter-spacing:.08em; }
    .brand .subtitle{ font-size:12px; color:var(--text-dim); margin-top:2px; }
    .conn{ display:flex; align-items:center; gap:8px; font-size:12px; color:var(--text-muted); }
    .dot{ width:10px; height:10px; border-radius:50%; background:#6B7280; border:1px solid rgba(255,255,255,.18);}
    .dot.ok{ background:var(--success); border-color:rgba(16,185,129,.5); box-shadow:0 0 8px rgba(16,185,129,.35); }

    .container{ max-width:1280px; margin:0 auto; padding:24px 16px; }
    .meta{ background:var(--glass-2); border:var(--border); border-radius:var(--radius); padding:16px; margin-bottom:20px; display:grid; grid-template-columns:repeat(3,1fr); gap:16px; }
    .meta-item{ text-align:center; }
    .meta-k{ font-size:11px; color:var(--text-muted); margin-bottom:4px; font-weight:600; letter-spacing:.04em; }
    .meta-v{ font-size:14px; font-weight:700; color:var(--gold-bright); }

    .grid{ display:grid; grid-template-columns:340px 1fr 360px; gap:18px; align-items:start; }
    @media (max-width: 1200px){ .grid{ grid-template-columns:1fr 1fr; } }
    @media (max-width: 860px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background:var(--glass-2);
      border:var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow-soft);
      padding:16px;
      transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .card:hover{ transform:translateY(-1px); box-shadow:var(--shadow); border-color:var(--gold-2); }
    .title{
      font-family:Cinzel, serif; font-weight:700; color:var(--gold-bright);
      border-bottom:var(--border-subtle); padding-bottom:10px; margin-bottom:14px;
      display:flex; align-items:center; justify-content:space-between;
    }

    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .row-3{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
    .row-4{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px; }
    .field label{ display:block; font-size:12px; font-weight:600; color:var(--text-muted); margin-bottom:6px; letter-spacing:.02em; }
    input[type="text"],input[type="number"],select, .mono{
      width:100%; background:var(--glass-1); border:var(--border);
      border-radius:10px; color:var(--text); font-size:13px; padding:10px 12px;
      outline:none; transition: border-color .2s, box-shadow .2s;
    }
    input:focus, select:focus, .mono:focus{ border-color:var(--gold-1); box-shadow:0 0 0 2px rgba(212,183,126,.16); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .btn{
      background:linear-gradient(135deg,var(--gold-1), var(--gold-2));
      color:#0B1117; border:1px solid var(--gold-1); border-radius:10px;
      font-weight:700; font-size:12px; letter-spacing:.04em; padding:10px 12px; cursor:pointer;
      box-shadow:0 2px 8px rgba(212,183,126,.22);
      transition:all var(--transition); outline:none; text-transform:uppercase;
    }
    .btn:hover{ background:linear-gradient(135deg,var(--gold-bright),var(--gold-shimmer)); box-shadow:0 4px 12px rgba(212,183,126,.35); transform:translateY(-1px); }
    .btn:disabled{ background:rgba(107,114,128,.3); color:rgba(255,255,255,.4); box-shadow:none; transform:none; cursor:not-allowed; }
    .btn-success{ background:linear-gradient(135deg,var(--success),#059669); color:#fff; border-color:var(--success); }
    .btn-danger{ background:linear-gradient(135deg,var(--danger),#DC2626); color:#fff; border-color:var(--danger); }

    .logs{ height:380px; overflow-y:auto; background:var(--glass-1); border:var(--border); border-radius:var(--radius-sm); padding:8px; }
    .log{ padding:8px 10px; border-bottom:1px dashed var(--border-subtle); font-size:12px; line-height:1.4; }
    .log:last-child{ border-bottom:none; }
    .log .time{ color:var(--text-muted); margin-right:8px; }
    .log.sys{ border-left:3px solid var(--info); background:rgba(59,130,246,.06); }
    .log.err{ border-left:3px solid var(--danger); background:rgba(239,68,68,.08);}
    .log.adm{ border-left:3px solid var(--gold-1); background:rgba(212,183,126,.08);}

    .lists{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    table{ width:100%; border-collapse:collapse; font-size:12px; }
    th{ background:var(--glass-1); padding:6px 8px; text-align:left; color:var(--text-muted); border-bottom:var(--border-subtle); }
    td{ padding:6px 8px; border-bottom:1px dashed var(--border-subtle); }
    tr:last-child td{ border-bottom:none; }

    .preview-wrap{ display:flex; align-items:center; gap:8px; }
    .preview{ width:44px; height:44px; border-radius:8px; background:var(--glass-1); border:var(--border); display:flex; align-items:center; justify-content:center; font-size:10px; color:var(--text-muted); background-size:cover; background-position:center; }
    #pAvatar{ font-size:10px; }

    .chat-input{ display:flex; gap:8px; margin-top:8px; }
    .toast{
      position:fixed; bottom:16px; left:50%; transform:translateX(-50%);
      background:var(--glass-2); border:var(--border); padding:10px 14px; border-radius:10px;
      box-shadow:var(--shadow-soft); opacity:0; transition:opacity .2s, transform .2s; pointer-events:none;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-4px); }
  </style>
</head>
<body>
  <!-- 헤더 -->
  <header class="header">
    <div class="header-inner">
      <div class="brand">
        <div class="logo">PYXIS</div>
        <div class="subtitle">관리자 콘솔</div>
      </div>
      <div class="conn">
        <span id="connText">서버 연결</span>
        <span id="connDot" class="dot"></span>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- 전투 메타 -->
    <div class="meta" id="battleMeta">
      <div class="meta-item">
        <div class="meta-k">상태</div>
        <div class="meta-v" id="metaStatus">대기중</div>
      </div>
      <div class="meta-item">
        <div class="meta-k">모드</div>
        <div class="meta-v" id="metaMode">-</div>
      </div>
      <div class="meta-item">
        <div class="meta-k">전투 ID</div>
        <div class="meta-v" id="metaId">-</div>
      </div>
    </div>

    <div class="grid">
      <!-- 좌: 전투 제어 -->
      <section class="card">
        <div class="title">전투 제어</div>

        <div class="field">
          <label for="mode">전투 모드</label>
          <select id="mode">
            <option value="1v1" selected>1 vs 1</option>
            <option value="2v2">2 vs 2</option>
            <option value="3v3">3 vs 3</option>
            <option value="4v4">4 vs 4</option>
          </select>
        </div>

        <div class="row" style="margin-top:8px;">
          <button class="btn" id="btnCreate">전투 생성</button>
          <button class="btn btn-success" id="btnStart" disabled>시작</button>
        </div>

        <div class="row" style="margin-top:8px;">
          <button class="btn" id="btnResume" disabled>재개</button>
          <button class="btn" id="btnPause" disabled>일시정지</button>
        </div>

        <div class="row" style="margin-top:8px;">
          <button class="btn btn-danger" id="btnEnd" disabled>종료</button>
          <span></span>
        </div>

        <div class="title" style="margin-top:14px;">링크 및 비밀번호</div>

        <div class="row">
          <button class="btn" id="btnGenPlayer">전투 참가자 링크 생성</button>
          <button class="btn" id="btnGenSpectator">관전자 비밀번호 발급</button>
        </div>

        <div class="field" style="margin-top:8px;">
          <label for="spectatorOtp">관전자 비밀번호</label>
          <input id="spectatorOtp" type="text" class="mono" placeholder="발급 후 표시됩니다" readonly />
        </div>

        <div class="row">
          <button class="btn" id="btnBuildSpectator">관전자 URL 생성/복사</button>
          <input id="spectatorUrl" type="text" class="mono" placeholder="관전자 URL" readonly />
        </div>

        <div class="field" style="margin-top:12px;">
          <label>참가자 개별 링크</label>
          <div id="playerLinks" style="display:flex; flex-direction:column; gap:8px;">
            <!-- 동적 추가 -->
          </div>
        </div>
      </section>

      <!-- 중간: 참가자 관리 -->
      <section class="card">
        <div class="title">전투 참가자 관리</div>

        <div class="row">
          <div class="field">
            <label for="pName">이름</label>
            <input id="pName" type="text" maxlength="20" placeholder="최대 20자" />
          </div>
          <div class="field">
            <label for="pTeam">팀</label>
            <select id="pTeam">
              <option value="A">A팀</option>
              <option value="B">B팀</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="pHp">체력(최대 100)</label>
            <input id="pHp" type="number" min="1" max="100" value="100" />
          </div>
          <div class="field">
            <label>이미지</label>
            <div class="preview-wrap">
              <div id="preview" class="preview">미리보기</div>
              <input id="pAvatar" type="file" accept="image/*" />
            </div>
          </div>
        </div>

        <div class="title" style="margin-top:12px;">스탯 (각 1~5)</div>
        <div class="row-4">
          <div class="field">
            <label for="sAtk">공격</label>
            <input id="sAtk" type="number" min="1" max="5" value="3" />
          </div>
          <div class="field">
            <label for="sDef">방어</label>
            <input id="sDef" type="number" min="1" max="5" value="3" />
          </div>
          <div class="field">
            <label for="sAgi">민첩</label>
            <input id="sAgi" type="number" min="1" max="5" value="3" />
          </div>
          <div class="field">
            <label for="sLuk">행운</label>
            <input id="sLuk" type="number" min="1" max="5" value="2" />
          </div>
        </div>

        <div class="title" style="margin-top:12px;">시작 아이템</div>
        <div class="row-3">
          <div class="field">
            <label for="iDit">디터니</label>
            <input id="iDit" type="number" min="0" max="99" value="1" />
          </div>
          <div class="field">
            <label for="iAtkB">공격 보정기</label>
            <input id="iAtkB" type="number" min="0" max="99" value="0" />
          </div>
          <div class="field">
            <label for="iDefB">방어 보정기</label>
            <input id="iDefB" type="number" min="0" max="99" value="0" />
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="btn" id="btnAdd" disabled>전투 참가자 추가</button>
          <span></span>
        </div>

        <div class="title" style="margin-top:16px;">팀 구성</div>
        <div class="lists">
          <div>
            <div style="font-size:12px; color:var(--text-muted); margin:6px 0;">A팀</div>
            <table id="listA">
              <thead>
                <tr>
                  <th>이름</th><th>HP</th><th>스탯</th><th>아이템</th><th>상태</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="5" style="text-align:center; color:var(--text-muted);">없음</td></tr>
              </tbody>
            </table>
          </div>
          <div>
            <div style="font-size:12px; color:var(--text-muted); margin:6px 0;">B팀</div>
            <table id="listB">
              <thead>
                <tr>
                  <th>이름</th><th>HP</th><th>스탯</th><th>아이템</th><th>상태</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="5" style="text-align:center; color:var(--text-muted);">없음</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- 우: 로그/채팅 -->
      <section class="card">
        <div class="title">실시간 로그</div>
        <div class="logs" id="logs"></div>

        <div class="title" style="margin-top:16px;">채팅</div>
        <div class="logs" id="chatLogs" style="height:180px;"></div>
        <div class="chat-input">
          <input id="chatMsg" type="text" placeholder="관리자 메시지 입력..." />
          <button class="btn" id="btnSend">전송</button>
        </div>
      </section>
    </div>
  </main>

  <div id="toast" class="toast"></div>

  <script>
  (function(){
    'use strict';

    // 전역 변수
    let socket = null;
    let battleId = null;
    let lastSnap = null;

    // DOM 요소
    const els = {
      connDot: document.getElementById('connDot'),
      connText: document.getElementById('connText'),
      metaStatus: document.getElementById('metaStatus'),
      metaMode: document.getElementById('metaMode'),
      metaId: document.getElementById('metaId'),
      mode: document.getElementById('mode'),
      btnCreate: document.getElementById('btnCreate'),
      btnStart: document.getElementById('btnStart'),
      btnPause: document.getElementById('btnPause'),
      btnResume: document.getElementById('btnResume'),
      btnEnd: document.getElementById('btnEnd'),
      btnGenPlayer: document.getElementById('btnGenPlayer'),
      btnGenSpectator: document.getElementById('btnGenSpectator'),
      btnBuildSpectator: document.getElementById('btnBuildSpectator'),
      spectatorOtp: document.getElementById('spectatorOtp'),
      spectatorUrl: document.getElementById('spectatorUrl'),
      playerLinks: document.getElementById('playerLinks'),
      pName: document.getElementById('pName'),
      pTeam: document.getElementById('pTeam'),
      pHp: document.getElementById('pHp'),
      pAvatar: document.getElementById('pAvatar'),
      preview: document.getElementById('preview'),
      sAtk: document.getElementById('sAtk'),
      sDef: document.getElementById('sDef'),
      sAgi: document.getElementById('sAgi'),
      sLuk: document.getElementById('sLuk'),
      iDit: document.getElementById('iDit'),
      iAtkB: document.getElementById('iAtkB'),
      iDefB: document.getElementById('iDefB'),
      btnAdd: document.getElementById('btnAdd'),
      listA: document.getElementById('listA'),
      listB: document.getElementById('listB'),
      logs: document.getElementById('logs'),
      chatLogs: document.getElementById('chatLogs'),
      chatMsg: document.getElementById('chatMsg'),
      btnSend: document.getElementById('btnSend'),
      toast: document.getElementById('toast')
    };

    // -------- 유틸 --------
    function log(type, msg){
      const time = new Date().toLocaleTimeString();
      const div = document.createElement('div');
      div.className = `log ${type}`;
      div.innerHTML = `<span class="time">${time}</span>${msg}`;
      els.logs.appendChild(div);
      els.logs.scrollTop = els.logs.scrollHeight;
    }

    function toast(msg){
      els.toast.textContent = msg;
      els.toast.classList.add('show');
      setTimeout(() => els.toast.classList.remove('show'), 2000);
    }

    function setConn(ok){
      els.connDot.classList.toggle('ok', ok);
      els.connText.textContent = ok ? '서버 연결' : '연결 대기';
    }

    // -------- 소켓 연결 --------
    function connect(){
      if(socket){ try{ socket.disconnect(); }catch(_){} }

      socket = io({ path: '/socket.io', transports: ['websocket', 'polling'] });

      socket.on('connect', () => {
        setConn(true);
        log('sys', '서버에 연결되었습니다');
        autoJoinFromURL();
      });

      socket.on('disconnect', () => {
        setConn(false);
        log('err', '서버 연결이 끊어졌습니다');
      });

      socket.on('battleUpdate', onBattleUpdate);
      socket.on('battle:update', onBattleUpdate);
      socket.on('battle:log', (entry) => log('sys', entry.message || entry.type || '로그'));
      socket.on('chatMessage', (data) => chatAppend(data.name || '익명', data.message || ''));
    }

    function autoJoinFromURL(){
      const p = new URLSearchParams(window.location.search);
      const b = p.get('battle');
      const t = p.get('token') || p.get('otp');

      if(!socket || !socket.connected) return;

      if(b){
        battleId = b;
        socket.emit('join', { battleId });
        log('sys', `전투 ${battleId}에 참가합니다`);
      }
      if(b && t){
        socket.emit('adminAuth', { battleId, otp: t, token: t }, (ack) => {
          if(ack && ack.error){
            log('err', `인증 실패: ${ack.error}`);
          } else {
            log('sys', '관리자 인증 성공');
          }
        });
      }
    }

    // -------- 전투 생성 --------
    async function createBattle(){
      if(!socket || !socket.connected){
        toast('서버 연결을 확인하세요');
        return;
      }

      const mode = els.mode.value || '1v1';
      log('sys', `전투 생성 요청: ${mode}`);

      const payload = { mode };
      socket.emit('createBattle', payload, (ack) => {
        if(!ack || ack.error){
          log('err', `전투 생성 실패: ${ack && ack.error || '응답 없음'}`);
          return;
        }

        battleId = ack.battleId || ack.id;
        if(battleId){
          socket.emit('join', { battleId });
          onBattleUpdate(ack.battle || ack);
          toast('전투가 생성되었습니다');
          log('sys', `전투 생성 성공: ${battleId}`);
        }
      });
    }

    function adminAction(action){
      if(!battleId){
        toast('전투를 먼저 생성하세요');
        return;
      }
      if(!socket || !socket.connected){
        toast('서버 연결을 확인하세요');
        return;
      }

      socket.emit(`${action}Battle`, { battleId });
      log('sys', `${action} 요청`);
    }

    // -------- 링크 생성 --------
    async function genPlayerLinks(){
      if(!battleId){
        toast('전투 생성 후 이용하세요');
        return;
      }

      try{
        // 수정된 부분: 괄호 추가
        let res = await fetch(`/api/admin/battles/${battleId}/links`, { method:'POST', credentials:'include' });
        if(!res.ok){
          res = await fetch(`/api/battles/${battleId}/links`, { method:'POST', credentials:'include' });
        }
        if(!res.ok) throw new Error('링크 생성 실패');

        const data = await res.json();
        const links = data.playerLinks || data.links || [];

        els.playerLinks.innerHTML = '';
        links.forEach((ln, i) => {
          const row = document.createElement('div');
          row.style.display = 'grid';
          row.style.gridTemplateColumns = '38px 1fr 72px';
          row.style.gap = '6px';
          row.innerHTML = `
            <div style="display:flex;align-items:center;justify-content:center;color:var(--text-muted)">${i+1}</div>
            <input type="text" class="mono" value="${ln.url||''}" readonly />
            <button class="btn">복사</button>
          `;
          const input = row.querySelector('input');
          row.querySelector('button').addEventListener('click', function(){
            navigator.clipboard.writeText(input.value).then(() => toast('복사되었습니다'));
          });
          els.playerLinks.appendChild(row);
        });
        toast('참가자 링크가 생성되었습니다');
      }catch(e){
        log('err', '참가자 링크 생성 실패');
      }
    }

    async function genSpectatorOtp(){
      if(!battleId){
        toast('전투 생성 후 이용하세요');
        return;
      }

      try{
        let res = await fetch(`/api/admin/battles/${battleId}/links`, { method:'POST', credentials:'include' });
        if(!res.ok){
          res = await fetch(`/api/battles/${battleId}/links`, { method:'POST', credentials:'include' });
        }
        if(!res.ok) throw new Error('OTP 발급 실패');

        const data = await res.json();
        const otp = data.spectatorOtp || (data.spectator && data.spectator.otp) || data.otp || '';
        els.spectatorOtp.value = otp || '';
        toast('관전자 비밀번호가 발급되었습니다');
      }catch(e){
        log('err', '관전자 비밀번호 발급 실패');
      }
    }

    async function buildSpectatorUrl(){
      if(!battleId){
        toast('전투 생성 후 이용하세요');
        return;
      }

      const otp = (els.spectatorOtp.value||'').trim();
      if(!otp){
        toast('관전자 비밀번호 발급 후 이용하세요');
        return;
      }

      const url = new URL('/spectator.html', window.location.origin);
      url.searchParams.set('battle', battleId);
      url.searchParams.set('otp', otp);
      els.spectatorUrl.value = url.toString();

      try{
        await navigator.clipboard.writeText(url.toString());
        toast('관전자 URL이 복사되었습니다');
      }catch(_){
        toast('관전자 URL이 생성되었습니다');
      }
    }

    // -------- 참가자 관리 --------
    function addPlayer(){
      if(!battleId){
        toast('전투를 먼저 생성하세요');
        return;
      }

      const name = (els.pName.value||'').trim();
      if(!name){
        toast('이름을 입력하세요');
        return;
      }

      const player = {
        name,
        team: els.pTeam.value || 'A',
        hp: parseInt(els.pHp.value) || 100,
        stats: {
          attack: parseInt(els.sAtk.value) || 1,
          defense: parseInt(els.sDef.value) || 1,
          agility: parseInt(els.sAgi.value) || 1,
          luck: parseInt(els.sLuk.value) || 1
        },
        items: {
          ditany: parseInt(els.iDit.value) || 0,
          attackBooster: parseInt(els.iAtkB.value) || 0,
          defenseBooster: parseInt(els.iDefB.value) || 0
        }
      };

      socket.emit('addPlayer', { battleId, player }, (ack) => {
        if(!ack || ack.error){
          log('err', `참가자 추가 실패: ${ack && ack.error || '응답 없음'}`);
          return;
        }
        toast('참가자가 추가되었습니다');
        // 입력 필드 초기화
        els.pName.value = '';
        els.pHp.value = 100;
        els.sAtk.value = 3;
        els.sDef.value = 3;
        els.sAgi.value = 3;
        els.sLuk.value = 2;
        els.iDit.value = 1;
        els.iAtkB.value = 0;
        els.iDefB.value = 0;
        els.preview.style.backgroundImage = '';
        els.preview.textContent = '미리보기';
      });
    }

    // -------- 아바타 미리보기 --------
    function onPreview(){
      const f = els.pAvatar.files[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = () => {
        els.preview.style.backgroundImage = `url('${r.result}')`;
        els.preview.textContent = '';
      };
      r.readAsDataURL(f);
    }

    // -------- 채팅 --------
    function chatAppend(name, msg){
      const time = new Date().toLocaleTimeString();
      const div = document.createElement('div');
      div.className = 'log';
      div.innerHTML = `<span class="time">${time}</span><strong>${name}:</strong> ${msg}`;
      els.chatLogs.appendChild(div);
      els.chatLogs.scrollTop = els.chatLogs.scrollHeight;
    }

    function sendChat(){
      const text = (els.chatMsg.value||'').trim();
      if(!text) return;

      const payload = { battleId, message: text, role: 'admin', name: '관리자' };
      
      if(socket && socket.connected){
        socket.emit('chatMessage', payload);
        socket.emit('chat:send', payload);
        socket.emit('battle:chat', payload);
        socket.emit('chat:message', payload);
      }
      
      chatAppend('관리자', text);
      els.chatMsg.value = '';
    }

    // -------- 전투 상태 업데이트 --------
    function onBattleUpdate(snap){
      if(!snap) return;
      lastSnap = snap;
      battleId = snap.id || battleId;

      // 메타 정보 업데이트
      els.metaStatus.textContent = snap.status || '대기중';
      els.metaMode.textContent = snap.mode || '-';
      els.metaId.textContent = snap.id || '-';

      // 버튼 상태 업데이트
      const st = snap.status || 'waiting';
      els.btnStart.disabled = !(st === 'waiting' || st === 'paused');
      els.btnPause.disabled = !(st === 'active');
      els.btnResume.disabled = !(st === 'paused');
      els.btnEnd.disabled = (st === 'ended');

      const linkEnabled = !!battleId && st !== 'ended';
      els.btnGenPlayer.disabled = !linkEnabled;
      els.btnGenSpectator.disabled = !linkEnabled;
      els.btnBuildSpectator.disabled = !linkEnabled;
      els.btnAdd.disabled = !linkEnabled;

      // 팀 목록 업데이트
      renderTeamLists(snap);
    }

    function renderTeamLists(snap){
      const players = snap.players || [];
      const teamA = players.filter(p => p.team === 'A');
      const teamB = players.filter(p => p.team === 'B');

      renderTeamTable(els.listA, teamA);
      renderTeamTable(els.listB, teamB);
    }

    function renderTeamTable(table, players){
      const tbody = table.querySelector('tbody');
      tbody.innerHTML = '';

      if(players.length === 0){
        const row = tbody.insertRow();
        row.innerHTML = '<td colspan="5" style="text-align:center; color:var(--text-muted);">없음</td>';
        return;
      }

      players.forEach(p => {
        const row = tbody.insertRow();
        const stats = p.stats || {};
        const items = p.items || {};
        const statsText = `${stats.attack||1}/${stats.defense||1}/${stats.agility||1}/${stats.luck||1}`;
        const itemsText = `디${items.ditany||0} 공${items.attackBooster||0} 방${items.defenseBooster||0}`;
        
        row.innerHTML = `
          <td>${p.name || '익명'}</td>
          <td>${p.hp || 100}</td>
          <td>${statsText}</td>
          <td>${itemsText}</td>
          <td>${p.status || '대기'}</td>
        `;
      });
    }

    // -------- 이벤트 바인딩 --------
    function bind(){
      els.btnCreate.addEventListener('click', createBattle);
      els.btnStart.addEventListener('click', () => adminAction('start'));
      els.btnPause.addEventListener('click', () => adminAction('pause'));
      els.btnResume.addEventListener('click', () => adminAction('resume'));
      els.btnEnd.addEventListener('click', () => adminAction('end'));
      
      els.btnGenPlayer.addEventListener('click', genPlayerLinks);
      els.btnGenSpectator.addEventListener('click', genSpectatorOtp);
      els.btnBuildSpectator.addEventListener('click', buildSpectatorUrl);
      
      els.btnAdd.addEventListener('click', addPlayer);
      els.pAvatar.addEventListener('change', onPreview);
      
      els.btnSend.addEventListener('click', sendChat);
      els.chatMsg.addEventListener('keydown', (e) => {
        if(e.key === 'Enter'){
          e.preventDefault();
          sendChat();
        }
      });
    }

    // -------- 초기화 --------
    bind();
    connect();
    log('sys', '관리자 콘솔이 시작되었습니다.');
  })();
  </script>
</body>
</html>
