<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>PYXIS - 관리자</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body{font-family:system-ui,-apple-system,sans-serif;background:#0b1020;color:#eee;margin:0;padding:20px}
  .wrap{max-width:900px;margin:0 auto}
  h1{margin:0 0 12px}
  .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:12px;margin:10px 0}
  input,button{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.2);background:#0e152b;color:#eee}
  button{cursor:pointer}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .log{height:220px;overflow:auto;font-size:12px;background:#0a1226;border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,.12)}
  .time{color:#7b8794;margin-right:6px}
  .ok{color:#a7f3d0} .bad{color:#fecaca}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
</style>
</head>
<body>
<div class="wrap">
  <h1>PYXIS 관리자</h1>

  <div class="card">
    <div class="row">
      <button id="createBtn">전투 생성</button>
      <span>battleId: <code id="battleId" class="mono">-</code></span>
      <button id="startBtn" disabled>전투 시작</button>
      <button id="pauseBtn" disabled>일시정지</button>
      <button id="resumeBtn" disabled>재개</button>
      <button id="endBtn" disabled>종료</button>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <input id="pName" placeholder="이름"/>
      <select id="pTeam">
        <option value="A">A팀</option>
        <option value="B">B팀</option>
      </select>
      <button id="addPlayerBtn" disabled>참가 추가</button>
    </div>
  </div>

  <div class="card">
    <div>실시간 로그</div>
    <div id="log" class="log"></div>
  </div>
</div>

<script>
const socket = io({path:'/socket.io'});
let currentBattleId = null;

// 로그 표시
function addLog(msg, type='info'){
  const panel = document.getElementById('log');
  const div = document.createElement('div');
  const t = new Date().toLocaleTimeString('ko-KR');
  const cls = type==='ok'?'ok':(type==='bad'?'bad':'');
  div.innerHTML = `<span class="time">[${t}]</span><span class="${cls}">${msg}</span>`;
  panel.appendChild(div);
  panel.scrollTop = panel.scrollHeight;
}

// 전투 생성
document.getElementById('createBtn').onclick = ()=>{
  socket.emit('createBattle', {mode:'2v2'}, (res)=>{
    if(!res?.ok){ addLog('전투 생성 실패','bad'); return; }
    currentBattleId = res.battleId;
    document.getElementById('battleId').textContent = currentBattleId;
    document.getElementById('startBtn').disabled = false;
    document.getElementById('addPlayerBtn').disabled = false;
    document.getElementById('pauseBtn').disabled = false;
    document.getElementById('resumeBtn').disabled = false;
    document.getElementById('endBtn').disabled = false;

    // 방 참가해 로그 수신
    socket.emit('join', {battleId: currentBattleId});
    addLog(`전투 생성됨: ${currentBattleId}`, 'ok');
  });
};

// 전투 시작 (필수: battleId 반드시 전달 + 콜백 확인)
document.getElementById('startBtn').onclick = ()=>{
  if(!currentBattleId){ addLog('battleId 없음','bad'); return; }
  socket.emit('startBattle', {battleId: currentBattleId}, (res)=>{
    if(res?.ok){ addLog('전투 시작됨','ok'); }
    else { addLog('전투 시작 실패: '+(res?.error||'UNKNOWN'), 'bad'); }
  });
};

// 일시정지/재개/종료
document.getElementById('pauseBtn').onclick = ()=>{
  if(!currentBattleId) return;
  socket.emit('pauseBattle', {battleId: currentBattleId}, (r)=> addLog(r?.ok?'일시정지됨':'일시정지 실패','bad'));
};
document.getElementById('resumeBtn').onclick = ()=>{
  if(!currentBattleId) return;
  socket.emit('resumeBattle', {battleId: currentBattleId}, (r)=> addLog(r?.ok?'재개됨':'재개 실패','bad'));
};
document.getElementById('endBtn').onclick = ()=>{
  if(!currentBattleId) return;
  socket.emit('endBattle', {battleId: currentBattleId}, (r)=> addLog(r?.ok?'종료됨':'종료 실패','bad'));
};

// 참가 추가
document.getElementById('addPlayerBtn').onclick = ()=>{
  if(!currentBattleId){ addLog('battleId 없음','bad'); return; }
  const name = document.getElementById('pName').value.trim() || '참가자';
  const team = document.getElementById('pTeam').value;
  const player = { name, team, stats:{attack:1,defense:1,agility:1,luck:1}, items:{} };
  socket.emit('addPlayer', {battleId: currentBattleId, player}, (res)=>{
    if(res?.ok) addLog(`참가 추가: ${name} (${team})`, 'ok');
    else addLog('참가 추가 실패','bad');
  });
};

// 서버 로그 수신
socket.on('battle:log', (log)=> addLog(log.message));
</script>
</body>
</html>
