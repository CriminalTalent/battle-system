<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PYXIS 전투 관리석</title>
  <style>
    /* 기본 리셋 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0a0e1a 0%, #1a2332 50%, #2a3441 100%);
      color: #f8f9fa;
      min-height: 100vh;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
      padding: 40px 20px;
      background: rgba(10, 14, 26, 0.8);
      border: 1px solid rgba(201, 169, 110, 0.3);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .title {
      font-size: 3.5rem;
      font-weight: 300;
      color: #c9a96e;
      margin-bottom: 10px;
      letter-spacing: 2px;
    }

    .subtitle {
      font-size: 1.2rem;
      color: #adb5bd;
      font-weight: 300;
      letter-spacing: 1px;
    }

    .card {
      background: rgba(26, 35, 50, 0.6);
      border: 1px solid rgba(201, 169, 110, 0.2);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
    }

    .card-title {
      font-size: 1.5rem;
      color: #c9a96e;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(201, 169, 110, 0.2);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .card-title::before {
      content: '';
      width: 4px;
      height: 24px;
      background: linear-gradient(to bottom, #d4b982, #c9a96e);
      border-radius: 2px;
    }

    .form-grid {
      display: grid;
      gap: 16px;
    }

    .form-grid.cols-2 { grid-template-columns: 1fr 1fr; }
    .form-grid.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
    .form-grid.cols-4 { grid-template-columns: repeat(4, 1fr); }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-label {
      color: #c9a96e;
      font-size: 0.9rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .form-input, .form-select {
      background: rgba(10, 14, 26, 0.8);
      border: 1px solid rgba(201, 169, 110, 0.3);
      border-radius: 8px;
      padding: 12px 16px;
      color: #f8f9fa;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #c9a96e;
      box-shadow: 0 0 0 2px rgba(201, 169, 110, 0.2);
    }

    .btn {
      background: linear-gradient(135deg, #b8935a, #c9a96e);
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      color: #0a0e1a;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 0.9rem;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(201, 169, 110, 0.3);
      background: linear-gradient(135deg, #c9a96e, #d4b982);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #3a4451, #2c3e50);
      color: #f8f9fa;
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, #2c3e50, #3a4451);
    }

    .btn-danger {
      background: linear-gradient(135deg, #dc3545, #c82333);
      color: white;
    }

    .btn-success {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
    }

    .btn-warning {
      background: linear-gradient(135deg, #ffc107, #fd7e14);
      color: #0a0e1a;
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }

    .status-card {
      background: rgba(10, 14, 26, 0.6);
      border: 1px solid rgba(201, 169, 110, 0.2);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }

    .status-label {
      color: #adb5bd;
      font-size: 0.8rem;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .status-value {
      color: #c9a96e;
      font-size: 1.2rem;
      font-weight: 700;
    }

    .url-display {
      margin-top: 20px;
      padding: 20px;
      background: rgba(10, 14, 26, 0.6);
      border-radius: 12px;
      border: 1px solid rgba(201, 169, 110, 0.2);
    }

    .url-item {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      gap: 16px;
    }

    .url-label {
      color: #c9a96e;
      font-weight: 600;
      min-width: 120px;
      font-size: 0.9rem;
    }

    .code-display {
      background: rgba(10, 14, 26, 0.8);
      border: 1px solid rgba(201, 169, 110, 0.2);
      border-radius: 6px;
      padding: 8px 12px;
      font-family: monospace;
      font-size: 0.8rem;
      color: #d4b982;
      cursor: pointer;
      flex: 1;
      word-break: break-all;
    }

    .code-display:hover {
      background: rgba(201, 169, 110, 0.1);
      border-color: #c9a96e;
    }

    .player-list {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 16px;
    }

    .player-card {
      background: rgba(10, 14, 26, 0.6);
      border: 1px solid rgba(201, 169, 110, 0.2);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      border-left: 3px solid #c9a96e;
    }

    .player-name {
      color: #c9a96e;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .player-stats {
      color: #adb5bd;
      font-size: 0.9rem;
    }

    .chat-area {
      background: rgba(10, 14, 26, 0.8);
      border: 1px solid rgba(201, 169, 110, 0.2);
      border-radius: 8px;
      height: 200px;
      overflow-y: auto;
      padding: 16px;
      margin-bottom: 16px;
      font-family: monospace;
      font-size: 0.9rem;
    }

    .chat-controls {
      display: flex;
      gap: 12px;
    }

    .chat-input {
      flex: 1;
      background: rgba(10, 14, 26, 0.8);
      border: 1px solid rgba(201, 169, 110, 0.3);
      border-radius: 8px;
      padding: 12px;
      color: #f8f9fa;
    }

    .chat-input:focus {
      outline: none;
      border-color: #c9a96e;
    }

    /* 모달 스타일 */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .modal:not(.hidden) {
      opacity: 1;
      pointer-events: all;
    }

    .modal-content {
      background: rgba(26, 35, 50, 0.95);
      border: 1px solid rgba(201, 169, 110, 0.3);
      border-radius: 16px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 1.4rem;
      color: #c9a96e;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      color: #adb5bd;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 4px 8px;
    }

    .modal-close:hover {
      color: #f8f9fa;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 20px;
    }

    .stats-section, .items-section {
      margin-bottom: 20px;
    }

    .section-label {
      color: #c9a96e;
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stats-row, .items-row {
      display: grid;
      gap: 12px;
      margin-bottom: 16px;
    }

    .stats-row {
      grid-template-columns: repeat(4, 1fr);
    }

    .items-row {
      grid-template-columns: repeat(3, 1fr);
    }

    .stat-input-group, .item-input-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 12px;
      background: rgba(10, 14, 26, 0.6);
      border: 1px solid rgba(201, 169, 110, 0.2);
      border-radius: 8px;
    }

    .stat-label, .item-label {
      color: #adb5bd;
      font-size: 0.8rem;
      font-weight: 500;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-input, .item-input {
      background: rgba(10, 14, 26, 0.8);
      border: 1px solid rgba(201, 169, 110, 0.3);
      border-radius: 6px;
      padding: 8px;
      color: #f8f9fa;
      text-align: center;
      font-weight: 600;
      width: 100%;
    }

    .stat-input:focus, .item-input:focus {
      outline: none;
      border-color: #c9a96e;
    }

    .hidden {
      display: none !important;
    }

    .team-section {
      text-align: center;
      margin-bottom: 20px;
    }

    .team-title {
      color: #c9a96e;
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* 반응형 */
    @media (max-width: 768px) {
      .form-grid.cols-2,
      .form-grid.cols-3,
      .form-grid.cols-4 {
        grid-template-columns: 1fr;
      }
      .stats-row {
        grid-template-columns: repeat(2, 1fr);
      }
      .items-row {
        grid-template-columns: 1fr;
      }
      .title {
        font-size: 2.5rem;
      }
      .chat-controls {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 헤더 -->
    <div class="header">
      <h1 class="title">PYXIS</h1>
      <p class="subtitle">전투 관리석</p>
    </div>

    <!-- 플레이어 추가 모달 -->
    <div id="playerModal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">플레이어 추가</h3>
          <button class="modal-close" id="closeModal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">캐릭터 이름</label>
            <input type="text" id="modalPlayerName" class="form-input" placeholder="캐릭터 이름을 입력하세요" maxlength="20">
          </div>
          
          <div class="form-group">
            <label class="form-label">팀 선택</label>
            <select id="modalTeam" class="form-select">
              <option value="phoenix">불사조 기사단</option>
              <option value="death">죽음을 먹는자들</option>
            </select>
          </div>

          <div class="stats-section">
            <div class="section-label">캐릭터 스탯 (1-5 범위)</div>
            <div class="stats-row">
              <div class="stat-input-group">
                <div class="stat-label">공격력</div>
                <input type="number" class="stat-input" id="modalAttack" min="1" max="5" value="1">
              </div>
              <div class="stat-input-group">
                <div class="stat-label">방어력</div>
                <input type="number" class="stat-input" id="modalDefense" min="1" max="5" value="1">
              </div>
              <div class="stat-input-group">
                <div class="stat-label">민첩성</div>
                <input type="number" class="stat-input" id="modalAgility" min="1" max="5" value="1">
              </div>
              <div class="stat-input-group">
                <div class="stat-label">행운</div>
                <input type="number" class="stat-input" id="modalLuck" min="1" max="5" value="1">
              </div>
            </div>
          </div>
          
          <div class="items-section">
            <div class="section-label">아이템 보유량</div>
            <div class="items-row">
              <div class="item-input-group">
                <div class="item-label">공격 보정기<br>(공격력×1.5)</div>
                <input type="number" class="item-input" id="modalAttackBoost" min="0" max="5" value="2">
              </div>
              <div class="item-input-group">
                <div class="item-label">방어 보정기<br>(방어력×1.5)</div>
                <input type="number" class="item-input" id="modalDefenseBoost" min="0" max="5" value="2">
              </div>
              <div class="item-input-group">
                <div class="item-label">디터니<br>(HP+10 회복)</div>
                <input type="number" class="item-input" id="modalDittany" min="0" max="5" value="2">
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelModal">취소</button>
          <button class="btn btn-primary" id="confirmAddPlayer">플레이어 추가</button>
        </div>
      </div>
    </div>

    <!-- 전투 구성 -->
    <section class="card">
      <div class="card-title">전투 구성</div>
      
      <div class="form-grid cols-3">
        <div class="form-group">
          <label class="form-label">전투 ID</label>
          <input type="text" id="battleId" class="form-input" placeholder="전투 ID" readonly>
        </div>
        <div class="form-group">
          <label class="form-label">전투 모드</label>
          <select id="mode" class="form-select">
            <option value="1v1">1v1</option>
            <option value="2v2">2v2</option>
            <option value="3v3">3v3</option>
            <option value="4v4">4v4</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">동작</label>
          <div class="form-grid cols-3">
            <button class="btn btn-primary" id="btnCreate">전투 생성</button>
            <button class="btn btn-secondary" id="btnLinks" disabled>링크 생성</button>
            <button class="btn btn-secondary" id="btnFetch">상태 갱신</button>
          </div>
        </div>
      </div>
      
      <div id="urlSection" class="url-display hidden">
        <div class="url-item">
          <span class="url-label">관리자 URL:</span>
          <code id="adminUrl" class="code-display">-</code>
        </div>
        <div class="url-item">
          <span class="url-label">플레이어 URL:</span>
          <code id="playerUrl" class="code-display">-</code>
        </div>
        <div class="url-item">
          <span class="url-label">관전자 URL:</span>
          <code id="spectUrl" class="code-display">-</code>
        </div>
      </div>

      <div class="status-grid">
        <div class="status-card">
          <div class="status-label">ID</div>
          <div class="status-value" id="statusId">undefined</div>
        </div>
        <div class="status-card">
          <div class="status-label">모드</div>
          <div class="status-value" id="statusMode">undefined</div>
        </div>
        <div class="status-card">
          <div class="status-label">단계</div>
          <div class="status-value" id="statusPhase">undefined</div>
        </div>
        <div class="status-card">
          <div class="status-label">현재</div>
          <div class="status-value" id="statusCurrent">미정</div>
        </div>
      </div>
    </section>

    <!-- 전투 관리 -->
    <section class="card">
      <div class="card-title">전투 관리</div>
      <div class="form-grid cols-4">
        <button id="btnStart" class="btn btn-warning" disabled>전투 시작</button>
        <button id="btnWinner" class="btn btn-secondary">승자 지정</button>
        <button id="btnForceEnd" class="btn btn-danger" disabled>강제 종료</button>
        <button id="btnDelete" class="btn btn-danger" disabled>전투 삭제</button>
      </div>
      
      <div style="margin-top: 20px; display: flex; gap: 16px; justify-content: flex-end;">
        <button class="btn btn-success" id="btnAddPlayer">플레이어 추가</button>
        <button class="btn btn-success" id="btnPerformance">성능 정보</button>
      </div>
    </section>

    <!-- 참가자 현황 -->
    <section class="card">
      <div class="card-title">참가자 현황</div>
      
      <div class="form-grid cols-2">
        <div class="team-section">
          <h4 class="team-title">불사조 기사단</h4>
          <div class="player-list" id="phoenixPlayers">
            <div style="text-align: center; color: #adb5bd; padding: 20px;">참가자가 없습니다</div>
          </div>
        </div>
        <div class="team-section">
          <h4 class="team-title">죽음을 먹는자들</h4>
          <div class="player-list" id="deathPlayers">
            <div style="text-align: center; color: #adb5bd; padding: 20px;">참가자가 없습니다</div>
          </div>
        </div>
      </div>
    </section>

    <!-- 실시간 채팅 -->
    <section class="card">
      <div class="card-title">실시간 채팅</div>
      <div id="chatArea" class="chat-area"></div>
      <div class="chat-controls">
        <input type="text" id="chatInput" class="chat-input" placeholder="메시지 입력">
        <button class="btn btn-primary" id="btnSendChat">전송</button>
        <button class="btn btn-secondary" id="btnClearChat">지우기</button>
      </div>
    </section>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    let socket;
    let currentBattle = null;

    // 서버 연결
    function connectToServer() {
      socket = io();
      
      socket.on('connect', () => {
        console.log('서버 연결 성공');
      });
      
      socket.on('disconnect', () => {
        console.log('서버 연결 해제');
      });
      
      socket.on('battleUpdate', (battle) => {
        console.log('전투 상태 업데이트:', battle);
        currentBattle = battle;
        updateUI(battle);
      });
      
      socket.on('chatMessage', (data) => {
        addChatMessage(data);
      });
    }

    // UI 업데이트
    function updateUI(battle) {
      if (!battle) return;

      document.getElementById('statusId').textContent = battle.id || 'undefined';
      document.getElementById('statusMode').textContent = battle.mode || 'undefined';
      document.getElementById('statusPhase').textContent = battle.phase || 'undefined';
      document.getElementById('statusCurrent').textContent = battle.currentTeam || '미정';

      // 플레이어 목록 업데이트
      renderPlayers(battle.teams?.phoenix || [], document.getElementById('phoenixPlayers'));
      renderPlayers(battle.teams?.death || [], document.getElementById('deathPlayers'));

      // 버튼 상태 업데이트
      document.getElementById('btnStart').disabled = battle.phase !== 'setup';
      document.getElementById('btnForceEnd').disabled = battle.phase === 'ended';
      document.getElementById('btnDelete').disabled = battle.phase !== 'ended';
    }

    // 플레이어 렌더링
    function renderPlayers(players, element) {
      element.innerHTML = '';
      if (players.length === 0) {
        element.innerHTML = '<div style="text-align: center; color: #adb5bd; padding: 20px;">참가자가 없습니다</div>';
        return;
      }
      
      players.forEach(player => {
        const div = document.createElement('div');
        div.className = 'player-card';
        div.innerHTML = `
          <div class="player-name">${player.name}</div>
          <div class="player-stats">
            HP: ${player.hp}/${player.maxHp} | 
            공격: ${player.stats?.attack ?? '-'} | 
            방어: ${player.stats?.defense ?? '-'} | 
            민첩: ${player.stats?.agility ?? '-'} | 
            행운: ${player.stats?.luck ?? '-'}
          </div>
        `;
        element.appendChild(div);
      });
    }

    // 채팅 메시지 추가
    function addChatMessage(data) {
      const chatArea = document.getElementById('chatArea');
      const messageDiv = document.createElement('div');
      messageDiv.innerHTML = `
        <div style="margin-bottom: 8px;">
          <strong style="color: #c9a96e;">[${data.senderType}] ${data.sender}:</strong> 
          <span style="color: #f8f9fa;">${data.message}</span>
          <br><small style="color: #adb5bd;">${new Date(data.timestamp).toLocaleTimeString()}</small>
        </div>
      `;
      chatArea.appendChild(messageDiv);
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    // 모달 관리
    function openPlayerModal() {
      document.getElementById('playerModal').classList.remove('hidden');
    }

    function closePlayerModal() {
      document.getElementById('playerModal').classList.add('hidden');
      // 폼 초기화
      document.getElementById('modalPlayerName').value = '';
      document.getElementById('modalTeam').value = 'phoenix';
      document.getElementById('modalAttack').value = 1;
      document.getElementById('modalDefense').value = 1;
      document.getElementById('modalAgility').value = 1;
      document.getElementById('modalLuck').value = 1;
      document.getElementById('modalAttackBoost').value = 2;
      document.getElementById('modalDefenseBoost').value = 2;
      document.getElementById('modalDittany').value = 2;
    }

    // 모달에서 플레이어 추가
    async function addPlayerFromModal() {
      const battleId = document.getElementById('battleId').value;
      if (!battleId) return alert('전투 ID가 없습니다.');

      const name = document.getElementById('modalPlayerName').value.trim();
      if (!name) return alert('캐릭터 이름을 입력해주세요.');

      const team = document.getElementById('modalTeam').value;
      const stats = {
        attack: parseInt(document.getElementById('modalAttack').value) || 1,
        defense: parseInt(document.getElementById('modalDefense').value) || 1,
        agility: parseInt(document.getElementById('modalAgility').value) || 1,
        luck: parseInt(document.getElementById('modalLuck').value) || 1
      };
      const items = {
        attackBoost: parseInt(document.getElementById('modalAttackBoost').value) || 0,
        defenseBoost: parseInt(document.getElementById('modalDefenseBoost').value) || 0,
        dittany: parseInt(document.getElementById('modalDittany').value) || 0
      };

      try {
        const response = await fetch(`/api/battles/${battleId}/players`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, team, stats, items })
        });

        const data = await response.json();
        if (response.ok) {
          console.log('플레이어 추가 완료:', data);
          closePlayerModal();
          fetchBattleStatus();
        } else {
          alert('플레이어 추가 실패: ' + data.error);
        }
      } catch (error) {
        console.error('플레이어 추가 오류:', error);
        alert('플레이어 추가 중 오류가 발생했습니다.');
      }
    }

    // 전투 상태 조회
    async function fetchBattleStatus() {
      const battleId = document.getElementById('battleId').value;
      if (!battleId) return;

      try {
        const battle = await response.json();
        
        if (response.ok) {
          currentBattle = battle;
          updateUI(battle);
        } else {
          console.error('전투 상태 조회 실패:', battle.error);
        }
      } catch (error) {
        console.error('전투 상태 조회 오류:', error);
      }
    }

    // 채팅 전송
    function sendChat() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (message && socket) {
        socket.emit('chatMessage', {
          message: message,
          senderType: 'admin',
          sender: 'Admin'
        });
        input.value = '';
      }
    }

    // 이벤트 리스너 등록
    function setupEventListeners() {
      // 모달 이벤트
      document.getElementById('btnAddPlayer').addEventListener('click', openPlayerModal);
      document.getElementById('closeModal').addEventListener('click', closePlayerModal);
      document.getElementById('cancelModal').addEventListener('click', closePlayerModal);
      document.getElementById('confirmAddPlayer').addEventListener('click', addPlayerFromModal);

      // 전투 생성
      document.getElementById('btnCreate').addEventListener('click', async () => {
        try {
          const mode = document.getElementById('mode').value;
          const response = await fetch('/api/battles', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode })
          });
          
          const battle = await response.json();
          if (response.ok) {
            document.getElementById('battleId').value = battle.id;
            document.getElementById('btnLinks').disabled = false;
            console.log('전투 생성 완료:', battle);
            fetchBattleStatus();
          } else {
            alert('전투 생성 실패: ' + battle.error);
          }
        } catch (error) {
          console.error('전투 생성 오류:', error);
          alert('전투 생성 중 오류가 발생했습니다.');
        }
      });

      // 링크 생성
      document.getElementById('btnLinks').addEventListener('click', async () => {
        const battleId = document.getElementById('battleId').value;
        if (!battleId) return alert('전투 ID가 없습니다.');

        try {
          const response = await fetch(`/api/admin/battles/${battleId}/links`, {
            method: 'POST'
          });
          
          const data = await response.json();
          if (response.ok) {
            const baseUrl = window.location.origin;
            
            document.getElementById('adminUrl').textContent = `${baseUrl}/admin?battle=${battleId}&token=${data.adminToken}`;
            document.getElementById('playerUrl').textContent = `${baseUrl}/play?battle=${battleId}&token=${data.playerToken}`;
            document.getElementById('spectUrl').textContent = `${baseUrl}/watch?battle=${battleId}&token=${data.spectatorToken}`;
            
            document.getElementById('urlSection').classList.remove('hidden');
            console.log('링크 생성 완료:', data);
          } else {
            alert('링크 생성 실패: ' + data.error);
          }
        } catch (error) {
          console.error('링크 생성 오류:', error);
          alert('링크 생성 중 오류가 발생했습니다.');
        }
      });

      // 상태 갱신
      document.getElementById('btnFetch').addEventListener('click', fetchBattleStatus);

      // 전투 시작
      document.getElementById('btnStart').addEventListener('click', async () => {
        const battleId = document.getElementById('battleId').value;
        if (!battleId) return alert('전투 ID가 없습니다.');

        try {
          const response = await fetch(`/api/admin/battles/${battleId}/start`, {
            method: 'POST'
          });
          
          const data = await response.json();
          if (response.ok) {
            console.log('전투 시작:', data);
            fetchBattleStatus();
          } else {
            alert('전투 시작 실패: ' + data.error);
          }
        } catch (error) {
          console.error('전투 시작 오류:', error);
          alert('전투 시작 중 오류가 발생했습니다.');
        }
      });

      // 강제 종료
      document.getElementById('btnForceEnd').addEventListener('click', async () => {
        const battleId = document.getElementById('battleId').value;
        if (!battleId) return alert('전투 ID가 없습니다.');
        if (!confirm('정말로 전투를 강제 종료하시겠습니까?')) return;

        try {
          const response = await fetch(`/api/admin/battles/${battleId}/end`, {
            method: 'POST'
          });
          
          const data = await response.json();
          if (response.ok) {
            console.log('전투 강제 종료:', data);
            fetchBattleStatus();
          } else {
            alert('전투 종료 실패: ' + data.error);
          }
        } catch (error) {
          console.error('전투 종료 오류:', error);
          alert('전투 종료 중 오류가 발생했습니다.');
        }
      });

      // 전투 삭제
      document.getElementById('btnDelete').addEventListener('click', async () => {
        const battleId = document.getElementById('battleId').value;
        if (!battleId) return alert('전투 ID가 없습니다.');
        if (!confirm('정말로 전투를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) return;

        try {
          const response = await fetch(`/api/battles/${battleId}`, {
            method: 'DELETE'
          });
          
          if (response.ok) {
            console.log('전투 삭제 완료');
            document.getElementById('battleId').value = '';
            document.getElementById('urlSection').classList.add('hidden');
            updateUI(null);
            alert('전투가 삭제되었습니다.');
          } else {
            const data = await response.json();
            alert('전투 삭제 실패: ' + data.error);
          }
        } catch (error) {
          console.error('전투 삭제 오류:', error);
          alert('전투 삭제 중 오류가 발생했습니다.');
        }
      });

      // 채팅 전송
      document.getElementById('btnSendChat').addEventListener('click', sendChat);
      document.getElementById('chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendChat();
      });

      // 채팅 지우기
      document.getElementById('btnClearChat').addEventListener('click', () => {
        document.getElementById('chatArea').innerHTML = '';
      });

      // 성능 정보
      document.getElementById('btnPerformance').addEventListener('click', async () => {
        try {
          const response = await fetch('/api/health');
          const data = await response.json();
          alert(`서버 상태: ${data.status}\n업타임: ${data.uptime}\n메모리 사용량: ${data.memory}`);
        } catch (error) {
          console.error('성능 정보 조회 오류:', error);
          alert('성능 정보를 조회할 수 없습니다.');
        }
      });

      // URL 클릭 복사
      document.querySelectorAll('.code-display').forEach(el => {
        el.addEventListener('click', () => {
          navigator.clipboard.writeText(el.textContent).then(() => {
            el.style.backgroundColor = 'rgba(201, 169, 110, 0.2)';
            setTimeout(() => {
              el.style.backgroundColor = '';
            }, 500);
          }).catch(() => {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = el.textContent;
            document.body.appendChild(textArea);
            textArea.select();
            try {
              document.execCommand('copy');
            } catch (err) {
              console.error('복사 실패:', err);
            }
            document.body.removeChild(textArea);
          });
        });
      });

      // 승자 지정
      document.getElementById('btnWinner').addEventListener('click', () => {
        if (!currentBattle || !currentBattle.teams) {
          return alert('전투 데이터가 없습니다.');
        }

        const phoenixHp = (currentBattle.teams.phoenix || [])
          .reduce((sum, p) => sum + (p.hp || 0), 0);
        const deathHp = (currentBattle.teams.death || [])
          .reduce((sum, p) => sum + (p.hp || 0), 0);

        let winner;
        if (phoenixHp > deathHp) {
          winner = '불사조 기사단';
        } else if (deathHp > phoenixHp) {
          winner = '죽음을 먹는자들';
        } else {
          winner = '무승부';
        }

        alert(`현재 HP 합계:\n불사조 기사단: ${phoenixHp}\n죽음을 먹는자들: ${deathHp}\n\n결과: ${winner} 승리`);
      });
    }

    // 초기화
    document.addEventListener('DOMContentLoaded', () => {
      connectToServer();
      setupEventListeners();
      
      // URL에서 전투 ID 추출
      const params = new URLSearchParams(window.location.search);
      const battleId = params.get('battle');
      if (battleId) {
        document.getElementById('battleId').value = battleId;
        document.getElementById('btnLinks').disabled = false;
        fetchBattleStatus();
      }
    });
  </script>
</body>
</html>
