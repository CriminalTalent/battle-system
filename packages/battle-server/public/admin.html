<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pyxis 전투 시스템</title>
  <style>
    :root {
      --deep-navy: #0a0f1a;
      --navy: #0f1419;
      --navy-light: #1a1f26;
      --gold: #E5C88A;
      --gold-light: #F5E6B8;
      --gold-dark: #C8A882;
      --accent: #2a3441;
      --text-primary: #F5E6B8;
      --text-secondary: #D4C39A;
      --border: rgba(229, 200, 138, 0.3);
      --border-light: rgba(229, 200, 138, 0.15);
      --glass: rgba(15, 20, 25, 0.85);
      --glass-dark: rgba(10, 15, 26, 0.9);
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: linear-gradient(135deg, var(--deep-navy) 0%, var(--navy) 50%, var(--navy-light) 100%);
      color: var(--text-primary);
      font-family: 'Times New Roman', serif;
      min-height: 100vh;
      padding: 20px;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 20%, rgba(229, 200, 138, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(229, 200, 138, 0.05) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: var(--glass);
      border: 2px solid var(--border-light);
      border-radius: 16px;
      padding: 30px;
      backdrop-filter: blur(10px);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .title {
      font-size: 2.5rem;
      color: var(--gold);
      text-shadow: 0 0 20px rgba(229, 200, 138, 0.5);
      margin-bottom: 10px;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 1.1rem;
    }

    .card {
      background: var(--navy-light);
      border: 1px solid var(--border-light);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
    }

    .card-title {
      font-size: 1.4rem;
      color: var(--gold);
      margin-bottom: 15px;
      border-bottom: 2px solid var(--border-light);
      padding-bottom: 8px;
    }

    .form-section {
      background: var(--navy);
      border: 1px solid var(--border-light);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .form-grid {
      display: grid;
      gap: 15px;
      margin-bottom: 20px;
    }

    .form-grid.cols-2 {
      grid-template-columns: 1fr 1fr;
    }

    .form-grid.cols-3 {
      grid-template-columns: 1fr 1fr 1fr;
    }

    .form-grid.cols-4 {
      grid-template-columns: 1fr 1fr 1fr 1fr;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-label {
      color: var(--gold);
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .form-input, .form-select {
      background: var(--deep-navy);
      border: 1px solid var(--border-light);
      border-radius: 8px;
      padding: 10px 12px;
      color: var(--text-primary);
      font-size: 14px;
    }

    .form-select {
      cursor: pointer;
    }

    .btn {
      background: var(--accent);
      border: 2px solid var(--border-light);
      border-radius: 10px;
      padding: 12px 20px;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-align: center;
    }

    .btn:hover:not(:disabled) {
      background: var(--gold-dark);
      border-color: var(--gold);
      color: var(--navy);
      transform: translateY(-2px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-primary {
      background: var(--gold-dark);
      border-color: var(--gold);
      color: var(--navy);
    }

    .btn-secondary {
      background: var(--accent);
      border-color: var(--border-light);
    }

    .btn-success {
      background: var(--success);
      border-color: #27ae60;
    }

    .btn-warning {
      background: var(--warning);
      border-color: #f39c12;
    }

    .btn-danger {
      background: var(--danger);
      border-color: #e74c3c;
    }

    .url-display {
      margin-top: 20px;
    }

    .url-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      gap: 15px;
    }

    .url-label {
      color: var(--gold);
      font-weight: 600;
      min-width: 120px;
      font-size: 14px;
    }

    .code-display {
      background: var(--deep-navy);
      border: 1px solid var(--border-light);
      border-radius: 6px;
      padding: 8px 12px;
      color: var(--text-primary);
      font-family: monospace;
      font-size: 12px;
      flex: 1;
      word-break: break-all;
    }

    .pill {
      background: var(--deep-navy);
      border: 1px solid var(--border-light);
      border-radius: 20px;
      padding: 6px 12px;
      color: var(--gold-light);
      font-family: monospace;
      font-size: 12px;
      text-align: center;
      min-width: 80px;
    }

    .pill.success {
      background: var(--success);
      color: white;
    }

    .pill.warning {
      background: var(--warning);
      color: white;
    }

    .pill.danger {
      background: var(--danger);
      color: white;
    }

    .teams-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 20px;
    }

    .team-section {
      background: var(--navy);
      border: 1px solid var(--border-light);
      border-radius: 12px;
      padding: 20px;
    }

    .team-title {
      color: var(--gold);
      font-size: 1.3rem;
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--border-light);
    }

    .player-form {
      background: var(--deep-navy);
      border: 1px solid var(--border-light);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .player-form input {
      background: var(--navy-light);
      border: 1px solid var(--border-light);
      border-radius: 6px;
      padding: 8px 10px;
      color: var(--text-primary);
      font-size: 12px;
      margin-bottom: 8px;
      width: 100%;
    }

    .stats-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 8px;
      margin-bottom: 10px;
    }

    .items-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-bottom: 15px;
    }

    .player-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .player-card {
      background: var(--deep-navy);
      border: 1px solid var(--border-light);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
    }

    .player-name {
      color: var(--gold);
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .player-stats {
      color: var(--text-secondary);
      font-size: 11px;
      line-height: 1.3;
    }

    .chat-section {
      margin-top: 20px;
    }

    .chat-area {
      background: var(--deep-navy);
      border: 1px solid var(--border-light);
      border-radius: 8px;
      height: 200px;
      overflow-y: auto;
      padding: 15px;
      font-family: monospace;
      font-size: 12px;
      line-height: 1.4;
      margin-bottom: 10px;
      color: var(--text-secondary);
    }

    .chat-controls {
      display: flex;
      gap: 10px;
    }

    .chat-input {
      flex: 1;
      background: var(--navy);
      border: 1px solid var(--border-light);
      border-radius: 6px;
      padding: 8px 12px;
      color: var(--text-primary);
      font-size: 14px;
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .status-card {
      background: var(--navy);
      border: 1px solid var(--border-light);
      border-radius: 8px;
      padding: 15px;
      text-align: center;
    }

    .status-label {
      color: var(--text-secondary);
      font-size: 11px;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .status-value {
      color: var(--gold);
      font-size: 16px;
      font-weight: 600;
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 1200px) {
      .form-grid.cols-4 {
        grid-template-columns: 1fr 1fr;
      }
      .teams-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .form-grid.cols-2,
      .form-grid.cols-3 {
        grid-template-columns: 1fr;
      }
      .stats-row {
        grid-template-columns: 1fr 1fr;
      }
      .items-row {
        grid-template-columns: 1fr;
      }
      .container {
        padding: 20px;
      }
      .title {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 class="title">Pyxis 전투 시스템</h1>
      <p class="subtitle">관리자 콘솔</p>
    </div>

    <!-- 전투 구성 -->
    <section class="card">
      <div class="card-title">전투 구성</div>
      
      <div class="form-section">
        <div class="form-grid cols-3">
          <div class="form-group">
            <label class="form-label">전투 ID</label>
            <input type="text" id="battleId" class="form-input" placeholder="전투 ID" readonly>
          </div>
          <div class="form-group">
            <label class="form-label">전투 모드</label>
            <select id="mode" class="form-select">
              <option value="1v1">1v1</option>
              <option value="2v2">2v2</option>
              <option value="3v3">3v3</option>
              <option value="4v4">4v4</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">동작</label>
            <div class="form-grid cols-3">
              <button class="btn btn-primary" id="btnCreate">전투 생성</button>
              <button class="btn btn-secondary" id="btnLinks" disabled>링크 생성</button>
              <button class="btn btn-secondary" id="btnFetch">상태 갱신</button>
            </div>
          </div>
        </div>
      </div>
      
      <div id="urlSection" class="url-display hidden">
        <div class="url-item">
          <span class="url-label">관리자 URL:</span>
          <code id="adminUrl" class="code-display">-</code>
        </div>
        <div class="url-item">
          <span class="url-label">플레이어 URL:</span>
          <code id="playerUrl" class="code-display">-</code>
        </div>
        <div class="url-item">
          <span class="url-label">관전자 URL:</span>
          <code id="spectUrl" class="code-display">-</code>
        </div>
      </div>

      <div class="status-grid">
        <div class="status-card">
          <div class="status-label">ID</div>
          <div class="status-value" id="statusId">undefined</div>
        </div>
        <div class="status-card">
          <div class="status-label">모드</div>
          <div class="status-value" id="statusMode">undefined</div>
        </div>
        <div class="status-card">
          <div class="status-label">단계</div>
          <div class="status-value" id="statusPhase">undefined</div>
        </div>
        <div class="status-card">
          <div class="status-label">현재</div>
          <div class="status-value" id="statusCurrent">미정</div>
        </div>
      </div>
    </section>

    <!-- OTP 관리 -->
    <section class="card otp-section">
      <div class="card-title">인증 및 접근 제어</div>
      <div class="form-grid cols-2">
        <div>
          <div class="form-grid cols-4" style="margin-bottom: 16px;">
            <button id="btnIssueAdmin" class="btn btn-secondary">관리자 OTP</button>
            <span class="pill" id="adminOtp">-</span>
            <input id="adminOtpInput" class="form-input" placeholder="관리자 OTP 입력">
            <button class="btn btn-primary" id="btnAdminLogin">관리자 로그인</button>
          </div>
          <div class="pill" id="adminLoginState">인증되지 않음</div>
        </div>
        <div>
          <div class="form-grid cols-3" style="margin-bottom: 16px;">
            <input id="playerNameForOtp" class="form-input" placeholder="플레이어 이름">
            <button id="btnIssuePlayer" class="btn btn-secondary">플레이어 OTP</button>
            <span class="pill" id="playerOtp">-</span>
          </div>
          <div class="form-grid cols-2">
            <button id="btnIssueSpect" class="btn btn-secondary">관전자 OTP</button>
            <span class="pill" id="spectOtp">-</span>
          </div>
        </div>
      </div>
    </section>

    <!-- 전투 관리 -->
    <section class="card">
      <div class="card-title">전투 관리</div>
      <div class="form-grid cols-4">
        <button id="btnStart" class="btn btn-warning" disabled>전투 시작</button>
        <button id="btnWinner" class="btn btn-secondary">승자 지정 (HP 합계)</button>
        <button id="btnForceEnd" class="btn btn-danger" disabled>강제 종료</button>
        <button id="btnDelete" class="btn btn-danger" disabled>전투 삭제</button>
      </div>
      
      <div style="margin-top: 15px; text-align: right;">
        <button class="btn btn-success" id="btnPerformance">현재 성능 정보</button>
      </div>
    </section>

    <!-- 팀 구성 -->
    <section class="card">
      <div class="card-title">팀 구성</div>
      
      <div class="teams-grid">
        <!-- 불사조 기사단 -->
        <div class="team-section">
          <h3 class="team-title">불사조 기사단</h3>
          
          <div class="player-form">
            <input type="text" id="team1Name" placeholder="캐릭터 이름" maxlength="20">
            
            <div class="form-section" style="margin-bottom: 15px;">
              <label style="color: var(--gold); font-size: 12px; margin-bottom: 8px; display: block;">스탯 배분 (각 1-5 범위, 총합 8-20)</label>
              <div class="stats-row">
                <input type="number" id="team1Attack" placeholder="공격" min="1" max="5" value="2" title="공격력: 데미지 계산 기본값">
                <input type="number" id="team1Defense" placeholder="방어" min="1" max="5" value="2" title="방어력: 받는 데미지 차감값">
                <input type="number" id="team1Agility" placeholder="민첩" min="1" max="5" value="2" title="민첩성: 선공 결정 및 회피 능력">
                <input type="number" id="team1Luck" placeholder="행운" min="1" max="5" value="2" title="행운: 치명타 확률">
              </div>
              <div style="font-size: 10px; color: var(--gold); text-align: center; margin-top: 5px;">
                총합: <span id="team1StatTotal">8</span>/20
              </div>
            </div>
            
            <div class="form-section" style="margin-bottom: 15px;">
              <label style="color: var(--gold); font-size: 12px; margin-bottom: 8px; display: block;">아이템 배분 (각 0-3개)</label>
              <div class="items-row">
                <input type="number" id="team1AttackItem" placeholder="공격 보정기" min="0" max="3" value="0" title="공격력 x1.5 (1턴)">
                <input type="number" id="team1DefenseItem" placeholder="방어 보정기" min="0" max="3" value="0" title="방어력 x1.5 (1턴)">
                <input type="number" id="team1HealItem" placeholder="디터니" min="0" max="3" value="0" title="HP 10 즉시 회복">
              </div>
            </div>
            
            <button class="btn btn-success" id="btnAddTeam1">팀에 추가</button>
          </div>
          
          <div id="team1Players" class="player-list"></div>
        </div>

        <!-- 죽음을 먹는자들 -->
        <div class="team-section">
          <h3 class="team-title">죽음을 먹는자들</h3>
          
          <div class="player-form">
            <input type="text" id="team2Name" placeholder="캐릭터 이름" maxlength="20">
            
            <div class="form-section" style="margin-bottom: 15px;">
              <label style="color: var(--gold); font-size: 12px; margin-bottom: 8px; display: block;">스탯 배분 (각 1-5 범위, 총합 8-20)</label>
              <div class="stats-row">
                <input type="number" id="team2Attack" placeholder="공격" min="1" max="5" value="2" title="공격력: 데미지 계산 기본값">
                <input type="number" id="team2Defense" placeholder="방어" min="1" max="5" value="2" title="방어력: 받는 데미지 차감값">
                <input type="number" id="team2Agility" placeholder="민첩" min="1" max="5" value="2" title="민첩성: 선공 결정 및 회피 능력">
                <input type="number" id="team2Luck" placeholder="행운" min="1" max="5" value="2" title="행운: 치명타 확률">
              </div>
              <div style="font-size: 10px; color: var(--gold); text-align: center; margin-top: 5px;">
                총합: <span id="team2StatTotal">8</span>/20
              </div>
            </div>
            
            <div class="form-section" style="margin-bottom: 15px;">
              <label style="color: var(--gold); font-size: 12px; margin-bottom: 8px; display: block;">아이템 배분 (각 0-3개)</label>
              <div class="items-row">
                <input type="number" id="team2AttackItem" placeholder="공격 보정기" min="0" max="3" value="0" title="공격력 x1.5 (1턴)">
                <input type="number" id="team2DefenseItem" placeholder="방어 보정기" min="0" max="3" value="0" title="방어력 x1.5 (1턴)">
                <input type="number" id="team2HealItem" placeholder="디터니" min="0" max="3" value="0" title="HP 10 즉시 회복">
              </div>
            </div>
            
            <button class="btn btn-success" id="btnAddTeam2">팀에 추가</button>
          </div>
          
          <div id="team2Players" class="player-list"></div>
        </div>
      </div>
    </section>

    <!-- 실시간 채팅 -->
    <section class="card chat-section">
      <div class="card-title">실시간 채팅</div>
      <div id="chatArea" class="chat-area">관리자 메시지 (최대 200자)</div>
      <div class="chat-controls">
        <input type="text" id="chatInput" class="chat-input" placeholder="관리자 메시지 (최대 200자)" maxlength="200">
        <button id="sendChatBtn" class="btn btn-primary">전송</button>
      </div>
    </section>
  </div>

  <script>
    let currentBattleId = null;
    let battleData = null;

    function $(id) {
      return document.getElementById(id);
    }

    function addChatMessage(message, type = 'system') {
      const chatArea = $('chatArea');
      const timestamp = new Date().toLocaleTimeString();
      chatArea.textContent += `[${timestamp}] ${type === 'admin' ? '[관리자]' : ''} ${message}\n`;
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    // 전투 생성
    async function createBattle() {
      try {
        const mode = $('mode').value;
        $('btnCreate').disabled = true;
        
        addChatMessage('전투 생성 중...');
        
        const response = await fetch('/api/battles', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mode })
        });
        
        if (!response.ok) throw new Error('전투 생성 실패');
        
        const data = await response.json();
        currentBattleId = data.battleId;
        battleData = data.battle;
        
        $('battleId').value = currentBattleId;
        $('statusId').textContent = currentBattleId.substring(0, 8) + '...';
        $('statusMode').textContent = mode;
        $('statusPhase').textContent = '대기중';
        
        $('btnLinks').disabled = false;
        $('btnStart').disabled = false;
        $('btnForceEnd').disabled = false;
        $('btnDelete').disabled = false;
        
        addChatMessage(`전투 생성 완료: ${currentBattleId}`);
        addChatMessage('링크 생성을 클릭하여 참가자 링크를 생성하세요.');
        
      } catch (error) {
        addChatMessage(`전투 생성 실패: ${error.message}`);
        $('btnCreate').disabled = false;
      }
    }

    // 링크 생성
    async function generateLinks() {
      if (!currentBattleId) return;
      
      try {
        $('btnLinks').disabled = true;
        addChatMessage('링크 생성 중...');
        
        const response = await fetch(`/api/admin/battles/${currentBattleId}/links`, {
          method: 'POST'
        });
        
        if (!response.ok) throw new Error('링크 생성 실패');
        
        const data = await response.json();
        const baseUrl = window.location.origin;
        
        $('adminUrl').textContent = `${baseUrl}${data.urls.admin}`;
        $('playerUrl').textContent = `${baseUrl}${data.urls.player}`;
        $('spectUrl').textContent = `${baseUrl}${data.urls.spectator}`;
        
        $('adminOtp').textContent = data.tokens.admin;
        $('playerOtp').textContent = data.tokens.player;
        $('spectOtp').textContent = data.tokens.spectator;
        
        $('urlSection').classList.remove('hidden');
        
        addChatMessage('링크 생성 완료');
        addChatMessage('플레이어들에게 링크를 배포하세요.');
        
      } catch (error) {
        addChatMessage(`링크 생성 실패: ${error.message}`);
        $('btnLinks').disabled = false;
      }
    }

    // 플레이어 추가
    async function addPlayer(team) {
      if (!currentBattleId) {
        addChatMessage('먼저 전투를 생성하세요.');
        return;
      }
      
      const nameInput = $(team + 'Name');
      const name = nameInput.value.trim();
      if (!name) {
        addChatMessage('캐릭터 이름을 입력하세요.');
        return;
      }
      
      const stats = {
        attack: parseInt($(team + 'Attack').value) || 2,
        defense: parseInt($(team + 'Defense').value) || 2,
        agility: parseInt($(team + 'Agility').value) || 2,
        luck: parseInt($(team + 'Luck').value) || 2
      };
      
      // 스탯 총합 체크 (8-20 범위)
      const statTotal = stats.attack + stats.defense + stats.agility + stats.luck;
      if (statTotal < 8 || statTotal > 20) {
        addChatMessage('스탯 총합은 8-20 범위여야 합니다.');
        return;
      }
      
      const inventory = [];
      const attackItems = parseInt($(team + 'AttackItem').value) || 0;
      const defenseItems = parseInt($(team + 'DefenseItem').value) || 0;
      const healItems = parseInt($(team + 'HealItem').value) || 0;
      
      for (let i = 0; i < attackItems; i++) inventory.push('공격 보정기');
      for (let i = 0; i < defenseItems; i++) inventory.push('방어 보정기');
      for (let i = 0; i < healItems; i++) inventory.push('디터니');
      
      const teamName = team === 'team1' ? 'team1' : 'team2';
      
      try {
        const response = await fetch(`/api/battles/${currentBattleId}/players`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name, 
            team: teamName, 
            stats, 
            inventory
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error);
        }
        
        $('statusPhase').textContent = '진행중';
        addChatMessage('전투가 시작되었습니다!');
        
      } catch (error) {
        addChatMessage(`전투 시작 실패: ${error.message}`);
      }
    }

    // 전투 종료
    async function endBattle() {
      if (!currentBattleId) return;
      
      if (!confirm('정말로 전투를 강제 종료하시겠습니까?')) return;
      
      try {
        const response = await fetch(`/api/admin/battles/${currentBattleId}/end`, {
          method: 'POST'
        });
        
        if (!response.ok) throw new Error('전투 종료 실패');
        
        $('statusPhase').textContent = '종료';
        addChatMessage('전투가 강제 종료되었습니다.');
        
      } catch (error) {
        addChatMessage(`전투 종료 실패: ${error.message}`);
      }
    }

    // 상태 새로고침
    async function refreshStatus() {
      if (!currentBattleId) return;
      
      try {
        const response = await fetch(`/api/battles/${currentBattleId}`);
        if (response.ok) {
          const battle = await response.json();
          
          $('statusPhase').textContent = battle.status === 'waiting' ? '대기중' : 
                                         battle.status === 'ongoing' ? '진행중' : '종료';
          
          const playerCount = battle.teams.team1.players.length + battle.teams.team2.players.length;
          const maxPlayers = battle.config.playersPerTeam * 2;
          $('statusCurrent').textContent = `${playerCount}/${maxPlayers}명`;
          
          addChatMessage('상태가 업데이트되었습니다.');
        }
      } catch (error) {
        addChatMessage('상태 업데이트 실패: ' + error.message);
      }
    }

    // 채팅 전송
    function sendChat() {
      const message = $('chatInput').value.trim();
      if (!message) return;
      
      addChatMessage(message, 'admin');
      $('chatInput').value = '';
    }

    // 성능 정보
    function showPerformance() {
      const info = `
서버 상태: 정상 작동
메모리 사용량: 약 68MB
CPU 사용률: 0-1%
활성 연결: ${currentBattleId ? '1개 전투' : '0개 전투'}
업타임: 정상`;
      
      addChatMessage('=== 성능 정보 ===');
      addChatMessage(info);
      addChatMessage('================');
    }

    // 관리자 OTP 발급
    function issueAdminOtp() {
      if (!currentBattleId) {
        addChatMessage('먼저 전투를 생성하세요.');
        return;
      }
      addChatMessage('관리자 OTP는 링크 생성 시 자동으로 발급됩니다.');
    }

    // 관리자 로그인
    function loginAdmin() {
      const otp = $('adminOtpInput').value.trim();
      const displayedOtp = $('adminOtp').textContent.trim();
      
      if (!otp) {
        addChatMessage('OTP를 입력하세요.');
        return;
      }
      
      if (!displayedOtp || displayedOtp === '-') {
        addChatMessage('먼저 링크를 생성하여 관리자 OTP를 발급받으세요.');
        return;
      }
      
      if (otp === displayedOtp) {
        $('adminLoginState').textContent = '인증됨';
        $('adminLoginState').className = 'pill success';
        $('adminLoginState').style.color = 'var(--gold)';
        addChatMessage('관리자 인증 성공');
      } else {
        $('adminLoginState').textContent = '인증 실패';
        $('adminLoginState').className = 'pill danger';
        $('adminLoginState').style.color = 'var(--danger)';
        addChatMessage('OTP가 일치하지 않습니다.');
      }
      
      $('adminOtpInput').value = '';
    }

    // 이벤트 리스너
    $('btnCreate').onclick = createBattle;
    $('btnLinks').onclick = generateLinks;
    $('btnFetch').onclick = refreshStatus;
    $('btnStart').onclick = startBattle;
    $('btnForceEnd').onclick = endBattle;
    $('btnDelete').onclick = endBattle;
    $('btnPerformance').onclick = showPerformance;
    $('btnIssueAdmin').onclick = issueAdminOtp;
    $('btnAdminLogin').onclick = loginAdmin;
    $('btnAddTeam1').onclick = () => addPlayer('team1');
    $('btnAddTeam2').onclick = () => addPlayer('team2');
    $('sendChatBtn').onclick = sendChat;

    // 엔터키 이벤트
    $('chatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendChat();
    });

    $('adminOtpInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') loginAdmin();
    });

    // 초기화
    addChatMessage('Pyxis 전투 시스템 관리자 콘솔이 준비되었습니다.');
    addChatMessage('전투 생성부터 시작하세요.');

    // 5초마다 상태 자동 새로고침
    setInterval(() => {
      if (currentBattleId) {
        refreshStatus();
      }
    }, 5000);
  </script>
</body>
</html>
