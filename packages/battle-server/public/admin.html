<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>전투 관리자</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f1419;
      color: #f5e6b8;
      margin: 0;
      padding: 20px;
    }
    h1 { color: #e5c88a; }
    .hidden { display: none; }
    .container { max-width: 900px; margin: auto; }
    input, button, select {
      padding: 10px; margin: 5px 0;
      width: 100%; border-radius: 5px;
      border: 1px solid #c8a882; background: #1a1f26; color: #f5e6b8;
    }
    button { cursor: pointer; background: #c8a882; color: #0a0f1a; font-weight: bold; }
    .battle-card { border: 1px solid #444; margin: 10px 0; padding: 10px; border-radius: 8px; }
    .log, .chat {
      background: #1a1f26; padding: 10px;
      height: 200px; overflow-y: auto; font-size: 14px;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>전투 관리자 페이지</h1>

  <!-- 전투 생성 -->
  <h2>전투 생성</h2>
  <select id="battleMode">
    <option value="1v1">1 vs 1</option>
    <option value="2v2">2 vs 2</option>
    <option value="3v3">3 vs 3</option>
    <option value="4v4">4 vs 4</option>
  </select>
  <button onclick="createBattle()">전투 생성</button>

  <!-- 전투 목록 -->
  <h2>전투 목록</h2>
  <div id="battleList"></div>

  <!-- 선택된 전투 관리 -->
  <div id="battleManager" class="hidden">
    <h2>전투 관리</h2>
    <div id="battleInfo"></div>
    <button onclick="startBattle()">전투 시작</button>
    <button onclick="endBattle()">전투 강제 종료</button>
    <button onclick="regenerateLinks()">링크 재발급</button>

    <h3>발급된 링크</h3>
    <div id="links"></div>

    <h3>전투 로그</h3>
    <div id="log" class="log"></div>

    <h3>채팅</h3>
    <div id="chat" class="chat"></div>
  </div>
</div>

<script>
let selectedBattleId = null;
let socket = null;
let adminOtp = null;

// 전투 생성
async function createBattle() {
  const mode = document.getElementById("battleMode").value;
  const res = await fetch("/api/battles", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ mode })
  });
  const data = await res.json();
  if (data.success) {
    alert("전투가 생성되었습니다");
    loadBattles();
  } else {
    alert("생성 실패: " + data.error);
  }
}

// 전투 목록 불러오기
async function loadBattles() {
  const res = await fetch("/api/battles");
  const data = await res.json();
  const listDiv = document.getElementById("battleList");
  listDiv.innerHTML = "";

  data.battles.forEach(b => {
    const div = document.createElement("div");
    div.className = "battle-card";
    div.innerHTML = `
      <strong>ID:</strong> ${b.id}<br>
      <strong>모드:</strong> ${b.mode}<br>
      <strong>상태:</strong> ${b.status}<br>
      <strong>플레이어:</strong> ${b.playerCount}/${b.maxPlayers}<br>
      <button onclick="selectBattle('${b.id}')">관리</button>
    `;
    listDiv.appendChild(div);
  });
}

// 전투 선택
async function selectBattle(battleId) {
  selectedBattleId = battleId;
  document.getElementById("battleManager").classList.remove("hidden");

  // 링크 재발급 자동 실행
  await regenerateLinks();

  // 소켓 연결
  if (!socket) {
    socket = io({ transports: ["websocket", "polling"] });
    socket.on("connect", () => {
      console.log("소켓 연결됨 (관리자)", socket.id);
      socket.emit("adminAuth", { battleId, otp: adminOtp });
    });
    socket.on("authSuccess", data => {
      console.log("관리자 인증 성공", data);
      renderBattle(data.battle);
    });
    socket.on("battleUpdate", battle => renderBattle(battle));
    socket.on("authError", msg => alert("인증 실패: " + msg));
  }
}

// 전투 시작
async function startBattle() {
  if (!selectedBattleId) return;
  const res = await fetch(`/api/admin/battles/${selectedBattleId}/start`, { method: "POST" });
  const data = await res.json();
  if (data.success) {
    alert("전투 시작됨");
  } else {
    alert("실패: " + data.error);
  }
}

// 전투 강제 종료
async function endBattle() {
  if (!selectedBattleId) return;
  const res = await fetch(`/api/admin/battles/${selectedBattleId}/end`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ winner: null })
  });
  const data = await res.json();
  if (data.success) {
    alert("전투 종료됨");
  } else {
    alert("실패: " + data.error);
  }
}

// 링크 재발급
async function regenerateLinks() {
  if (!selectedBattleId) return;
  const res = await fetch(`/api/admin/battles/${selectedBattleId}/links`, { method: "POST" });
  const data = await res.json();
  if (data.success) {
    adminOtp = data.tokens.admin;
    const linksDiv = document.getElementById("links");
    linksDiv.innerHTML = `
      <div>관리자: <a href="${data.urls.admin}" target="_blank">${data.urls.admin}</a></div>
      <div>플레이어: <a href="${data.urls.player}" target="_blank">${data.urls.player}</a></div>
      <div>관전자: <a href="${data.urls.spectator}" target="_blank">${data.urls.spectator}</a></div>
    `;
  }
}

// 전투 정보 출력
function renderBattle(battle) {
  document.getElementById("battleInfo").innerText =
    `ID: ${battle.id}, 상태: ${battle.status}, 턴: ${battle.turnNumber}, 현재 팀: ${battle.currentTeam}`;

  // 로그
  const logDiv = document.getElementById("log");
  logDiv.innerHTML = battle.battleLog.map(e =>
    `[${new Date(e.timestamp).toLocaleTimeString()}] ${e.message}`
  ).join("<br>");
  logDiv.scrollTop = logDiv.scrollHeight;

  // 채팅
  const chatDiv = document.getElementById("chat");
  chatDiv.innerHTML = battle.chatLog.map(c =>
    `[${new Date(c.timestamp).toLocaleTimeString()}] ${c.sender} (${c.senderType}): ${c.message}`
  ).join("<br>");
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

// 페이지 로드 시 전투 목록 불러오기
loadBattles();
</script>
</body>
</html>
