<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PYXIS 관리자</title>
<link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;800;900&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link href="/assets/pyxis-theme.css" rel="stylesheet">
<script src="/socket.io/socket.io.js"></script>
<style>
/* 관리자 전용 스타일 */
.admin-header{
  position:relative; 
  padding:32px 16px 12px; 
  overflow:hidden;
}

.admin-header::before{
  content:''; 
  position:absolute; 
  inset:-40% -15% auto -15%; 
  height:350px;
  background:conic-gradient(from 0deg at 50% 50%, 
    rgba(201,169,110,.18) 0deg, 
    rgba(201,169,110,.06) 90deg, 
    rgba(201,169,110,.18) 180deg, 
    rgba(201,169,110,.06) 270deg, 
    rgba(201,169,110,.18) 360deg
  );
  filter:blur(60px);
  animation:adminRotate 50s linear infinite;
  opacity:.7;
  pointer-events:none;
  z-index:-1;
}

@keyframes adminRotate{
  0%{transform:rotate(0deg) scale(1)}
  50%{transform:rotate(180deg) scale(1.15)}
  100%{transform:rotate(360deg) scale(1)}
}

.admin-brand{
  font-family:var(--serif); 
  font-weight:900; 
  letter-spacing:.08em; 
  font-size:36px;
  background:linear-gradient(135deg, 
    var(--gold-bright) 0%, 
    var(--gold-shimmer) 25%, 
    var(--gold) 50%, 
    var(--gold-light) 75%,
    var(--gold-bright) 100%
  );
  background-size:400% 400%;
  -webkit-background-clip:text; 
  background-clip:text; 
  -webkit-text-fill-color:transparent;
  animation:adminShimmer 4s ease-in-out infinite;
  position:relative;
  display:inline-block;
}

@keyframes adminShimmer{
  0%,100%{background-position:0% 50%}
  50%{background-position:100% 50%}
}

.admin-brand::after{
  content:'관리자';
  position:absolute;
  top:-8px;
  right:-60px;
  font-size:12px;
  font-weight:700;
  color:var(--gold);
  background:linear-gradient(135deg, rgba(201,169,110,.2), rgba(201,169,110,.1));
  border:1px solid var(--gold);
  border-radius:999px;
  padding:4px 12px;
  letter-spacing:.02em;
}

.admin-stage{
  display:grid; 
  grid-template-columns:1.2fr 1fr 1fr; 
  gap:20px; 
  padding:16px 20px;
  max-width:1500px;
  margin:0 auto;
}

@media (max-width:1400px){
  .admin-stage{
    grid-template-columns:1fr;
    gap:16px;
  }
}

/* 섹션 헤더 */
.section-header{
  display:flex; 
  align-items:center; 
  justify-content:space-between; 
  gap:12px; 
  margin-bottom:16px;
  padding-bottom:8px;
  border-bottom:1px solid rgba(201,169,110,.15);
}

.section-title{
  font-family:var(--serif); 
  font-weight:800; 
  color:var(--gold-bright);
  font-size:22px;
  position:relative;
  padding-left:16px;
}

.section-title::before{
  content:'';
  position:absolute;
  left:0;
  top:50%;
  transform:translateY(-50%);
  width:6px;
  height:70%;
  background:linear-gradient(to bottom, var(--gold-bright), var(--gold));
  border-radius:3px;
  box-shadow:0 0 8px rgba(201,169,110,.4);
}

.status-indicator{
  display:flex; 
  align-items:center; 
  gap:8px; 
  font-size:14px; 
  font-weight:600;
  color:var(--text-dim);
}

.status-dot{
  width:10px; 
  height:10px; 
  border-radius:50%;
  background:var(--info);
  box-shadow:0 0 12px currentColor;
  animation:statusPulse 2s ease-in-out infinite;
}

@keyframes statusPulse{
  0%,100%{opacity:.6; transform:scale(1)}
  50%{opacity:1; transform:scale(1.1)}
}

.status-dot.active{
  background:var(--success);
  color:var(--success);
}

.status-dot.ended{
  background:var(--danger);
  color:var(--danger);
}

/* 컨트롤 그리드 */
.control-grid{
  display:grid; 
  gap:12px;
}

.control-row{
  display:grid;
  grid-template-columns:2fr 1fr;
  gap:12px;
  align-items:end;
}

.control-actions{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:8px;
  margin-top:12px;
}

.control-actions .btn{
  font-size:13px;
  padding:10px 16px;
}

@media (max-width:600px){
  .control-row{
    grid-template-columns:1fr;
  }
  .control-actions{
    grid-template-columns:1fr;
  }
}

/* 폼 필드 */
.field{
  display:flex;
  flex-direction:column;
  gap:6px;
}

.field label{
  font-weight:600;
  color:var(--text-dim);
  font-size:13px;
  letter-spacing:.02em;
}

/* 링크 섹션 */
.links-section{
  margin-top:20px;
  padding-top:16px;
  border-top:1px solid rgba(201,169,110,.1);
}

.link-item{
  display:flex;
  gap:8px;
  align-items:center;
  margin-bottom:8px;
  padding:8px 0;
}

.link-input{
  flex:1;
  font-size:12px;
  padding:8px 12px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  background:rgba(8,13,25,.6);
}

.copy-btn{
  padding:8px 12px;
  font-size:12px;
  white-space:nowrap;
}

/* 로스터 섹션 */
.roster-form{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  margin-bottom:16px;
}

.roster-form .field{
  min-width:0;
}

@media (max-width:800px){
  .roster-form{
    grid-template-columns:repeat(2,1fr);
  }
}

@media (max-width:500px){
  .roster-form{
    grid-template-columns:1fr;
  }
}

.stats-grid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:8px;
  margin:8px 0;
}

.items-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
  margin:8px 0;
}

@media (max-width:600px){
  .stats-grid{
    grid-template-columns:repeat(2,1fr);
  }
  .items-grid{
    grid-template-columns:1fr;
  }
}

/* 팀 로스터 */
.teams-roster{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
  margin-top:16px;
}

@media (max-width:700px){
  .teams-roster{
    grid-template-columns:1fr;
  }
}

.team-section{
  background:rgba(8,13,25,.4);
  border:1px solid var(--border-subtle);
  border-radius:12px;
  padding:12px;
}

.team-header{
  font-weight:800;
  color:var(--gold-bright);
  margin-bottom:12px;
  font-size:16px;
  text-align:center;
  padding:8px;
  background:linear-gradient(135deg, rgba(201,169,110,.1), rgba(201,169,110,.05));
  border-radius:8px;
  border:1px solid rgba(201,169,110,.2);
}

/* 플레이어 카드 */
.player-card{
  display:grid;
  grid-template-columns:60px 1fr auto;
  gap:12px;
  align-items:center;
  padding:12px;
  margin-bottom:10px;
  background:rgba(16,21,35,.6);
  border:1px solid var(--border-1);
  border-radius:12px;
  transition:all .25s ease;
}

.player-card:hover{
  transform:translateY(-1px);
  border-color:var(--border-2);
  box-shadow:var(--shadow-soft);
}

.player-avatar{
  width:60px;
  height:60px;
  border-radius:10px;
  background:linear-gradient(135deg, var(--midnight), var(--navy-mist)) center/cover no-repeat;
  border:2px solid var(--border-1);
  position:relative;
  overflow:hidden;
}

.player-info{
  flex:1;
  min-width:0;
}

.player-name{
  font-weight:800;
  color:var(--text);
  margin-bottom:4px;
}

.player-stats{
  font-size:11px;
  color:var(--text-muted);
  margin-bottom:6px;
  line-height:1.3;
}

.player-hp{
  height:6px;
  background:rgba(26,31,42,.8);
  border-radius:3px;
  overflow:hidden;
  position:relative;
}

.player-hp-fill{
  height:100%;
  background:linear-gradient(90deg, var(--gold-dark), var(--gold));
  transition:width .3s ease;
}

.player-items{
  font-size:10px;
  color:var(--text-muted);
  margin-top:4px;
}

.player-actions{
  display:flex;
  gap:6px;
  align-items:center;
}

.player-actions .btn{
  font-size:11px;
  padding:6px 10px;
  min-width:auto;
}

/* 로그 & 채팅 */
.log-chat-container{
  display:flex;
  flex-direction:column;
  height:100%;
}

.log-viewer{
  flex:1;
  background:rgba(8,28,49,.9);
  border:1px solid var(--border-1);
  border-radius:var(--radius);
  padding:16px;
  overflow-y:auto;
  font-size:13px;
  line-height:1.4;
  min-height:480px;
  backdrop-filter:var(--blur-light);
  box-shadow:inset 0 2px 8px rgba(0,0,0,.3);
}

.log-entry{
  display:flex;
  gap:10px;
  align-items:baseline;
  margin-bottom:8px;
  padding:6px 0;
  border-bottom:1px solid rgba(201,169,110,.05);
}

.log-time{
  font-size:11px;
  color:var(--text-muted);
  min-width:60px;
  font-weight:600;
}

.log-content{
  flex:1;
  color:var(--text-dim);
}

.log-entry.system .log-content{
  color:var(--gold);
  font-weight:600;
}

.log-entry.admin .log-content{
  color:var(--gold-bright);
  font-weight:600;
}

.chat-input-container{
  display:flex;
  gap:10px;
  align-items:center;
  margin-top:12px;
  padding:12px;
  background:rgba(16,21,35,.6);
  border:1px solid var(--border-1);
  border-radius:12px;
}

.chat-channel-select{
  min-width:90px;
}

.chat-input{
  flex:1;
}

/* 스크롤바 개선 */
.log-viewer::-webkit-scrollbar{
  width:8px;
}

.log-viewer::-webkit-scrollbar-track{
  background:rgba(10,15,26,.8);
  border-radius:4px;
}

.log-viewer::-webkit-scrollbar-thumb{
  background:linear-gradient(to bottom, var(--gold), var(--gold-dark));
  border-radius:4px;
  border:1px solid rgba(0,0,0,.2);
}

.log-viewer::-webkit-scrollbar-thumb:hover{
  background:linear-gradient(to bottom, var(--gold-bright), var(--gold));
}

/* 숨김 헬퍼 */
.hide{
  display:none !important;
}

/* 복사 피드백 */
.copy-success{
  animation:copyFeedback .6s ease;
}

@keyframes copyFeedback{
  0%{background:var(--success); color:white; transform:scale(1)}
  50%{transform:scale(1.05)}
  100%{background:var(--success); color:white; transform:scale(1)}
}

/* 로딩 상태 */
.loading{
  opacity:.6;
  pointer-events:none;
  position:relative;
}

.loading::after{
  content:'';
  position:absolute;
  inset:0;
  background:linear-gradient(90deg, 
    transparent, 
    rgba(201,169,110,.1), 
    transparent
  );
  animation:shimmer 1.5s infinite;
}

@keyframes shimmer{
  0%{transform:translateX(-100%)}
  100%{transform:translateX(100%)}
}
</style>
</head>
<body>
<header class="admin-header">
  <div class="wrap">
    <div class="admin-brand">Pyxis</div>
  </div>
</header>

<main class="admin-stage">
  <!-- 전투 생성 및 제어 섹션 -->
  <section class="card">
    <div class="section-header">
      <div class="section-title">전투 생성 및 제어</div>
      <div class="status-indicator">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">대기중</span>
      </div>
    </div>

    <div class="control-grid">
      <!-- 전투 생성 -->
      <div class="control-row">
        <div class="field">
          <label for="battleMode">전투 모드</label>
          <select id="battleMode" class="select">
            <option value="1v1">1 vs 1</option>
            <option value="2v2">2 vs 2</option>
            <option value="3v3">3 vs 3</option>
            <option value="4v4">4 vs 4</option>
          </select>
        </div>
        <button id="btnCreateBattle" class="btn btn-gold">전투 생성</button>
      </div>

      <!-- 전투 정보 -->
      <div class="field">
        <label for="battleId">전투 ID</label>
        <input id="battleId" class="input" readonly placeholder="생성된 전투 ID가 표시됩니다">
      </div>

      <div class="row">
        <div class="field">
          <label for="adminOtp">관리자 OTP</label>
          <input id="adminOtp" class="input" readonly placeholder="관리자 인증 토큰">
        </div>
        <div class="field">
          <label for="spectatorOtp">관전자 OTP</label>
          <input id="spectatorOtp" class="input" readonly placeholder="관전자 인증 토큰">
        </div>
      </div>

      <!-- 제어 버튼 -->
      <div class="control-actions">
        <button id="btnConnect" class="btn">관리자 로그인</button>
        <button id="btnStartBattle" class="btn btn-gold">전투 시작</button>
        <button id="btnPauseBattle" class="btn">일시정지</button>
        <button id="btnEndBattle" class="btn btn-danger">전투 종료</button>
      </div>
    </div>

    <!-- 링크 생성 섹션 -->
    <div class="links-section">
      <div class="section-title" style="font-size:18px; margin-bottom:12px;">링크 생성</div>
      
      <div class="field">
        <label for="spectatorUrl">관전자 링크</label>
        <div class="link-item">
          <input id="spectatorUrl" class="input link-input" readonly placeholder="관전자 링크가 생성됩니다">
          <button id="copySpectatorUrl" class="btn copy-btn">복사/발급</button>
        </div>
      </div>

      <button id="btnGenerateLinks" class="btn">플레이어별 링크 생성</button>
      <div id="playerLinksContainer" class="hide" style="margin-top:12px;"></div>
    </div>
  </section>

  <!-- 로그 및 채팅 섹션 -->
  <section class="card">
    <div class="section-header">
      <div class="section-title">실시간 로그 · 채팅</div>
    </div>

    <div class="log-chat-container">
      <div id="logViewer" class="log-viewer" aria-label="전투 로그"></div>
      
      <div class="chat-input-container">
        <select id="chatChannel" class="select chat-channel-select">
          <option value="all">전체</option>
          <option value="team">팀</option>
        </select>
        <input id="chatInput" class="input chat-input" placeholder="메시지 입력 (/t 팀 채팅)" maxlength="200">
        <button id="btnSendChat" class="btn">전송</button>
      </div>
    </div>
  </section>

  <!-- 참여자 구성 섹션 -->
  <section class="card">
    <div class="section-header">
      <div class="section-title">참여자 구성</div>
    </div>

    <!-- 플레이어 추가 폼 -->
    <div class="roster-form">
      <div class="field">
        <label for="playerName">플레이어 이름</label>
        <input id="playerName" class="input" placeholder="이름 입력" maxlength="20">
      </div>
      
      <div class="field">
        <label for="playerTeam">소속 팀</label>
        <!-- 서버는 팀 값을 'A' / 'B' 로 사용 -->
        <select id="playerTeam" class="select">
          <option value="A">불사조 기사단</option>
          <option value="B">죽음을 먹는 자들</option>
        </select>
      </div>
    </div>

    <!-- 스탯 설정 -->
    <div class="field" style="margin-bottom:12px;">
      <label>능력치 배분 (1-5)</label>
      <div class="stats-grid">
        <div class="field">
          <label for="statAttack">공격</label>
          <input id="statAttack" class="input" type="number" value="3" min="1" max="5">
        </div>
        <div class="field">
          <label for="statDefense">방어</label>
          <input id="statDefense" class="input" type="number" value="3" min="1" max="5">
        </div>
        <div class="field">
          <label for="statAgility">민첩</label>
          <input id="statAgility" class="input" type="number" value="3" min="1" max="5">
        </div>
        <div class="field">
          <label for="statLuck">행운</label>
          <input id="statLuck" class="input" type="number" value="3" min="1" max="5">
        </div>
      </div>
    </div>

    <!-- 아이템 설정 -->
    <div class="field" style="margin-bottom:16px;">
      <label>시작 아이템 (0-9개)</label>
      <div class="items-grid">
        <div class="field">
          <label for="itemHealing">디터니</label>
          <input id="itemHealing" class="input" type="number" value="0" min="0" max="9">
        </div>
        <div class="field">
          <label for="itemAttackBoost">공격 보정기</label>
          <input id="itemAttackBoost" class="input" type="number" value="0" min="0" max="9">
        </div>
        <div class="field">
          <label for="itemDefenseBoost">방어 보정기</label>
          <input id="itemDefenseBoost" class="input" type="number" value="0" min="0" max="9">
        </div>
      </div>
    </div>

    <button id="btnAddPlayer" class="btn btn-gold">플레이어 추가</button>

    <!-- 현재 로스터 -->
    <div class="section-title" style="font-size:18px; margin:20px 0 12px; border-top:1px solid rgba(201,169,110,.1); padding-top:16px;">
      현재 로스터
    </div>
    
    <div class="teams-roster">
      <div class="team-section">
        <div class="team-header">불사조 기사단</div>
        <div id="team1Roster"></div>
      </div>
      
      <div class="team-section">
        <div class="team-header">죽음을 먹는 자들</div>
        <div id="team2Roster"></div>
      </div>
    </div>
  </section>
</main>

<script>
(function(){
  'use strict';
  
  // DOM 요소 참조
  const $ = id => document.getElementById(id);
  
  // 전투 생성 & 제어
  const battleMode = $('battleMode');
  const btnCreateBattle = $('btnCreateBattle');
  const battleId = $('battleId');
  const adminOtp = $('adminOtp');
  const spectatorOtp = $('spectatorOtp');
  const spectatorUrl = $('spectatorUrl');
  const statusDot = $('statusDot');
  const statusText = $('statusText');
  
  // 제어 버튼
  const btnConnect = $('btnConnect');
  const btnStartBattle = $('btnStartBattle');
  const btnPauseBattle = $('btnPauseBattle');
  const btnEndBattle = $('btnEndBattle');
  
  // 링크 생성
  const btnGenerateLinks = $('btnGenerateLinks');
  const copySpectatorUrl = $('copySpectatorUrl');
  const playerLinksContainer = $('playerLinksContainer');
  
  // 채팅
  const logViewer = $('logViewer');
  const chatChannel = $('chatChannel');
  const chatInput = $('chatInput');
  const btnSendChat = $('btnSendChat');
  
  // 플레이어 추가
  const playerName = $('playerName');
  const playerTeam = $('playerTeam');
  const statAttack = $('statAttack');
  const statDefense = $('statDefense');
  const statAgility = $('statAgility');
  const statLuck = $('statLuck');
  const itemHealing = $('itemHealing');
  const itemAttackBoost = $('itemAttackBoost');
  const itemDefenseBoost = $('itemDefenseBoost');
  const btnAddPlayer = $('btnAddPlayer');
  const team1Roster = $('team1Roster');
  const team2Roster = $('team2Roster');

  // 소켓 및 상태
  const socket = io({ transports:['websocket','polling'], reconnection:true, reconnectionAttempts:Infinity });
  let currentBattleId = '';
  let battleState = null;
  let isConnected = false;

  // 유틸리티 함수
  const formatTime = timestamp => {
    try { return new Date(timestamp).toLocaleTimeString([], { hour12: false }); }
    catch { return '--:--:--'; }
  };

  const makeApiCall = async (endpoint, options = {}) => {
    try {
      const response = await fetch(endpoint, {
        headers: { 'Content-Type': 'application/json' },
        ...options
      });
      return await response.json();
    } catch (error) {
      console.error('API 호출 실패:', error);
      return { ok: false, msg: 'API 호출 실패' };
    }
  };

  const showNotification = (message, type = 'info') => {
    console.log(`[${type.toUpperCase()}] ${message}`);
    if (type === 'error') alert(`오류: ${message}`);
  };

  const updateStatus = status => {
    const statusMap = {
      lobby:   { text: '대기중', class: '' },
      active:  { text: '진행중', class: 'active' },
      ended:   { text: '종료됨', class: 'ended' },
      waiting: { text: '대기중', class: '' },
      ongoing: { text: '진행중', class: 'active' }
    };
    const info = statusMap[status] || statusMap.lobby;
    statusText.textContent = info.text;
    statusDot.className = `status-dot ${info.class}`;
  };

  const addLogEntry = (content, type = 'info') => {
    const entry = document.createElement('div');
    entry.className = `log-entry ${type}`;
    const timeSpan = document.createElement('span');
    timeSpan.className = 'log-time';
    timeSpan.textContent = formatTime(Date.now());
    const contentSpan = document.createElement('span');
    contentSpan.className = 'log-content';
    contentSpan.textContent = content;
    entry.appendChild(timeSpan);
    entry.appendChild(contentSpan);
    logViewer.appendChild(entry);
    logViewer.scrollTop = logViewer.scrollHeight;
  };

  const copyToClipboard = async (text, button) => {
    try {
      await navigator.clipboard.writeText(text);
      button.textContent = '복사됨!';
      button.classList.add('copy-success');
      setTimeout(() => {
        button.textContent = '복사/발급';
        button.classList.remove('copy-success');
      }, 1500);
    } catch {
      showNotification('클립보드 복사 실패', 'error');
    }
  };

  // ─────────────────────────────────────────────────────────────
  // 서버 스펙 호환 렌더링 (state.teams 사용)
  // ─────────────────────────────────────────────────────────────
  const renderPlayerCard = p => {
    const card = document.createElement('div');
    card.className = 'player-card';
    const hpPercent = Math.max(0, Math.min(100, (p.hp / 100) * 100));
    card.innerHTML = `
      <div class="player-avatar" ${p.avatar ? `style="background-image:url(${p.avatar})"` : ''}></div>
      <div class="player-info">
        <div class="player-name">${p.name}${p.hp<=0 ? ' (불능)' : ''}</div>
        <div class="player-stats">공격 ${p.atk} · 방어 ${p.def} · 민첩 ${p.agi} · 행운 ${p.luk}</div>
        <div class="player-hp"><div class="player-hp-fill" style="width:${hpPercent}%"></div></div>
      </div>
      <div class="player-actions">
        <button class="btn btn-danger" disabled>삭제</button>
      </div>
    `;
    return card;
  };

  const renderRoster = () => {
    team1Roster.innerHTML = '';
    team2Roster.innerHTML = '';
    if (!battleState?.teams) return;
    const teamA = battleState.teams.find(t=>t.side==='A');
    const teamB = battleState.teams.find(t=>t.side==='B');
    (teamA?.players||[]).forEach(p => team1Roster.appendChild(renderPlayerCard(p)));
    (teamB?.players||[]).forEach(p => team2Roster.appendChild(renderPlayerCard(p)));
  };

  const renderBattleState = () => {
    if (!battleState) return;
    updateStatus(battleState.status);
    renderRoster();
  };

  // ─────────────────────────────────────────────────────────────
  // 전투 생성
  // ─────────────────────────────────────────────────────────────
  btnCreateBattle.onclick = async () => {
    const mode = battleMode.value;
    btnCreateBattle.classList.add('loading');
    const result = await makeApiCall('/api/admin/battles', {
      method: 'POST',
      body: JSON.stringify({ mode })
    });
    btnCreateBattle.classList.remove('loading');
    if (!result?.ok) return showNotification(result?.msg || '전투 생성 실패', 'error');

    currentBattleId = result.battleId;
    battleId.value   = result.battleId;
    adminOtp.value   = result.adminOTP;
    spectatorOtp.value = ''; // 관전자 OTP는 별도 발급
    spectatorUrl.value = '';

    addLogEntry('전투가 생성되었습니다', 'system');
  };

  // ─────────────────────────────────────────────────────────────
  // 소켓 로그인 (join)
  // ─────────────────────────────────────────────────────────────
  btnConnect.onclick = () => {
    if (!battleId.value || !adminOtp.value) {
      return showNotification('전투 ID와 관리자 OTP가 필요합니다', 'error');
    }
    btnConnect.textContent = '로그인 중...';
    btnConnect.disabled = true;

    socket.emit('join', {
      role: 'admin',
      battleId: battleId.value,
      token: adminOtp.value
    }, (ack) => {
      if (ack?.ok) {
        isConnected = true;
        battleState = ack.state;
        renderBattleState();
        addLogEntry('관리자 로그인 성공', 'system');
        btnConnect.textContent = '로그인 완료';
        btnConnect.classList.add('btn-success');
      } else {
        btnConnect.textContent = '관리자 로그인';
        btnConnect.disabled = false;
        showNotification(ack?.msg || '관리자 로그인 실패', 'error');
      }
    });
  };

  // ─────────────────────────────────────────────────────────────
  // 전투 제어 (start만 지원)
  // ─────────────────────────────────────────────────────────────
  btnStartBattle.onclick = async () => {
    if (!battleId.value || !adminOtp.value) return;
    const result = await makeApiCall(`/api/admin/battles/${battleId.value}/start`, {
      method: 'POST',
      body: JSON.stringify({ adminOtp: adminOtp.value })
    });
    if (!result?.ok) return showNotification(result?.msg || '전투 시작 실패', 'error');
    addLogEntry('전투가 시작되었습니다', 'system');
  };
  btnPauseBattle.onclick = () => alert('일시정지는 현재 서버에서 미지원입니다.');
  btnEndBattle.onclick   = () => alert('전투 종료는 시간만료/전멸 시 자동 처리됩니다.');

  // ─────────────────────────────────────────────────────────────
  // 관전자 링크: 버튼 클릭 시 없으면 발급 → 즉시 복사
  // ─────────────────────────────────────────────────────────────
  copySpectatorUrl.onclick = async () => {
    if (!spectatorUrl.value) {
      if (!battleId.value || !adminOtp.value) return showNotification('전투 생성 및 관리자 로그인 후 사용하세요', 'error');
      const r = await makeApiCall(`/api/admin/battles/${battleId.value}/watcher-otp`, {
        method:'POST',
        body: JSON.stringify({ adminOtp: adminOtp.value })
      });
      if (!r?.ok) return showNotification(r?.msg || '관전자 링크 발급 실패', 'error');
      spectatorOtp.value = r.otp || '';
      spectatorUrl.value = r.watchURL || '';
      addLogEntry('관전자 링크가 발급되었습니다', 'system');
    }
    if (spectatorUrl.value) copyToClipboard(spectatorUrl.value, copySpectatorUrl);
  };

  // ─────────────────────────────────────────────────────────────
  // 플레이어별 링크 생성 버튼: (서버에 개별 생성 API 없음)
  // 안내만 표시 — 플레이어 추가 시 개별 링크가 반환됩니다.
  // ─────────────────────────────────────────────────────────────
  btnGenerateLinks.onclick = () => {
    alert('플레이어별 접속 링크는 "플레이어 추가" 시 각각 반환됩니다.');
  };

  // ─────────────────────────────────────────────────────────────
  // 플레이어 추가 -> /api/admin/battles/:id/players (서버 스펙)
  // ─────────────────────────────────────────────────────────────
  btnAddPlayer.onclick = async () => {
    const name = (playerName.value || '').trim();
    if (!name) return showNotification('플레이어 이름을 입력하세요', 'error');
    if (!battleId.value || !adminOtp.value) return showNotification('전투를 먼저 생성하고 관리자 로그인하세요', 'error');

    const items = {
      dittany:   Math.max(0, parseInt(itemHealing.value) || 0),
      atkBoost:  Math.max(0, parseInt(itemAttackBoost.value) || 0),
      defBoost:  Math.max(0, parseInt(itemDefenseBoost.value) || 0),
    };
    btnAddPlayer.classList.add('loading');
    const r = await makeApiCall(`/api/admin/battles/${battleId.value}/players`, {
      method:'POST',
      body: JSON.stringify({
        adminOtp: adminOtp.value,
        name,
        team: playerTeam.value,          // 'A' | 'B'
        atk:  parseInt(statAttack.value)  || 3,
        def:  parseInt(statDefense.value) || 3,
        agi:  parseInt(statAgility.value) || 3,
        luk:  parseInt(statLuck.value)    || 3,
        items
        // avatar: '/avatars/...'  // 필요 시 /api/upload/avatar로 먼저 업로드 후 URL 전달
      })
    });
    btnAddPlayer.classList.remove('loading');

    if (!r?.ok) return showNotification(r?.msg || '플레이어 추가 실패', 'error');

    // 접속 링크 표시
    playerLinksContainer.classList.remove('hide');
    const linkItem = document.createElement('div');
    linkItem.className = 'link-item';
    linkItem.innerHTML = `
      <input class="input link-input" readonly value="${r.joinURL}">
      <button class="btn copy-btn">복사</button>
    `;
    const btn = linkItem.querySelector('button');
    btn.addEventListener('click', ()=> copyToClipboard(r.joinURL, btn));
    playerLinksContainer.appendChild(linkItem);

    addLogEntry(`플레이어 '${name}' 추가됨`, 'system');

    // 화면 상태 갱신(서버 상태 반영은 join ack 이후 소켓 이벤트로 갱신됨)
    if (battleState?.teams) {
      // 간단히 목록을 refetch 대용으로 push
      const side = playerTeam.value;
      const team = battleState.teams.find(t=>t.side===side);
      if (team) {
        team.players.push({ id:r.pid, name, hp:100, atk:parseInt(statAttack.value)||3, def:parseInt(statDefense.value)||3, agi:parseInt(statAgility.value)||3, luk:parseInt(statLuck.value)||3 });
        renderRoster();
      }
    }
    // 입력 리셋
    playerName.value = '';
    statAttack.value = '3';
    statDefense.value = '3';
    statAgility.value = '3';
    statLuck.value = '3';
    itemHealing.value = '0';
    itemAttackBoost.value = '0';
    itemDefenseBoost.value = '0';
  };

  // ─────────────────────────────────────────────────────────────
  // 채팅 전송 (관리자 → 항상 전체 브로드캐스트)
  // ─────────────────────────────────────────────────────────────
  const sendChatMessage = () => {
    const message = chatInput.value.trim();
    if (!message || !battleId.value) return;
    // 관리자 채팅은 서버에서 항상 전체로 처리됨(프리픽스 무시)
    socket.emit('chat:send', {
      battleId: battleId.value,
      text: message,
      nickname: '관리자',
      role: 'admin'
    });
    chatInput.value = '';
  };
  btnSendChat.onclick = sendChatMessage;
  chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChatMessage(); });

  // ─────────────────────────────────────────────────────────────
  // 소켓 수신 이벤트 (서버 스펙에 맞춤)
  // ─────────────────────────────────────────────────────────────
  socket.on('chat:new', (m) => {
    const scope = m.scope === 'team' ? '[팀] ' : '';
    const nick  = m.from?.nickname || '익명';
    addLogEntry(`${scope}${nick}: ${m.text}`, m.from?.role === 'admin' ? 'admin' : 'info');
  });

  socket.on('log:new', (ev)=>{
    addLogEntry(ev.text || '', 'system');
  });

  socket.on('phase:change', (p)=>{
    addLogEntry(`▶︎ 턴 전환: ${(p.phase==='A'?'불사조 기사단':'죽음을 먹는 자들')} (라운드 ${p.round})`, 'system');
    if (battleState) { battleState.phase = p.phase; battleState.round = p.round; }
  });

  socket.on('battle:end', (r)=>{
    addLogEntry(`◆ 전투 종료: ${r.winner==='draw'?'무승부':(r.winner==='A'?'불사조 기사단':'죽음을 먹는 자들')} / A=${r.scoreA} / B=${r.scoreB}`, 'system');
    updateStatus('ended');
  });

  // 타이머 동기화
  socket.on('timer:sync', (t) => {
    // 상태 표시만 필요하면 알림으로 충분 — 별도 UI 요소가 없으므로 로그에 주기적으로 넣지는 않음
    // 필요 시 상단에 별도 타이머 표시 영역 추가 가능
  });

  // 초기화 (URL 쿼리로 battle/token 넘겨온 경우 세팅)
  (function initializeFromUrl(){
    const urlParams = new URLSearchParams(window.location.search);
    const battleParam = urlParams.get('battle');
    const tokenParam  = urlParams.get('token');
    if (battleParam) { currentBattleId = battleParam; battleId.value = battleParam; }
    if (tokenParam)   { adminOtp.value = tokenParam; }
  })();

})();
</script>
</body>
</html>
