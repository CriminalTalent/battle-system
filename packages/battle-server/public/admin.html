<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>PYXIS 전투 관리자</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root {
      --bg:#0b1117; --panel:#121a23; --panel-2:#0f1620;
      --fg:#e9e4d7; --muted:#cdbfa5; --brand:#dcc7a2;
      --line:rgba(220,199,162,.22);
      --accent:#2f81f7; --danger:#c73e1d; --ok:#2d5a27;
    }
    body{margin:0;background:var(--bg);color:var(--fg);font-family:sans-serif;}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    h1{font-family:Cinzel,serif;color:var(--brand);text-align:center;margin-bottom:20px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px;margin-bottom:16px}
    .title{font-weight:bold;margin-bottom:12px;color:var(--brand)}
    input,select{background:var(--panel-2);border:1px solid var(--line);color:var(--fg);padding:6px;border-radius:6px;width:100%;margin-bottom:8px}
    button{padding:8px 12px;border-radius:8px;border:1px solid var(--line);background:var(--panel-2);color:var(--fg);cursor:pointer}
    button:hover{background:var(--brand);color:#000}
    /* 요청: 전투 생성 버튼만 블랙+골드 */
    #btnCreate{
      background:#000;
      border:1px solid var(--brand);
      color:var(--brand);
      font-weight:600;
    }
    #btnCreate:hover{
      background:var(--brand);
      color:#000;
    }
    .logs-section{height:300px;overflow-y:auto;background:var(--panel-2);border:1px solid var(--line);padding:8px;border-radius:8px}
    .log-item{margin-bottom:4px;font-size:12px;line-height:1.4;padding:2px 4px;border-radius:4px}
    .log-time{color:var(--brand);font-weight:normal} /* 날짜 색상 골드 */
    .chat-section{height:200px;overflow-y:auto;background:var(--panel-2);border:1px solid var(--line);padding:8px;border-radius:8px;margin-top:8px}
    .chat-item{margin-bottom:4px;font-size:12px}
    .chat-name{color:var(--brand);font-weight:600}
    .copy-btn{margin-left:8px}
    .link-url{cursor:pointer;color:var(--accent);word-break:break-all}
    .remove-btn{margin-top:4px;background:var(--danger);border:none;color:#fff;padding:4px 6px;border-radius:4px;cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>PYXIS 전투 관리자</h1>

    <div class="card">
      <div class="title">전투 제어</div>
      <select id="battleMode">
        <option value="1v1">1v1</option>
        <option value="2v2">2v2</option>
      </select>
      <button id="btnCreate">전투 생성</button>
      <button id="btnStart">시작</button>
      <button id="btnPause">일시정지</button>
      <button id="btnResume">재개</button>
      <button id="btnEnd">종료</button>
    </div>

    <div class="card">
      <div class="title">링크 생성</div>
      <button id="btnGenPlayerLinks">참가자 링크</button>
      <button id="btnGenSpectatorLink">관전자 링크</button>
      <div id="linksContainer" style="margin-top:12px"></div>
    </div>

    <div class="card">
      <div class="title">전투 참가자 추가</div>
      <input id="playerName" placeholder="이름 입력"/>
      <select id="playerTeam"><option value="A">A팀</option><option value="B">B팀</option></select>
      <input id="playerHP" type="number" value="100" />
      <input id="playerAttack" type="number" value="1" />
      <input id="playerDefense" type="number" value="1" />
      <input id="playerAgility" type="number" value="1" />
      <input id="playerLuck" type="number" value="1" />
      <input id="playerDittany" type="number" value="0" />
      <input id="playerAttackBooster" type="number" value="0" />
      <input id="playerDefenseBooster" type="number" value="0" />
      <input type="file" id="avatarUpload"/>
      <button id="btnAddPlayer">추가</button>
      <div id="teamA" class="team"></div>
      <div id="teamB" class="team"></div>
    </div>

    <div class="card">
      <div class="title">실시간 로그</div>
      <div id="logPanel" class="logs-section"></div>
    </div>

    <div class="card">
      <div class="title">채팅</div>
      <div id="chatPanel" class="chat-section"></div>
      <input id="chatInput" placeholder="메시지 입력"/>
      <button id="chatSend">전송</button>
    </div>
  </div>

  <script>
  (()=>{

    const socket = io();
    const logPanel=document.getElementById('logPanel');
    const chatPanel=document.getElementById('chatPanel');
    let currentBattleId=null;
    let battleState=null;
    let uploadedAvatarUrl=null;

    const seenLogs=new Map(), seenChats=new Map(), DEDUP=1000;

    function esc(s){return s?s.replace(/</g,'&lt;').replace(/>/g,'&gt;'):'';}

    function addLog({ts,type,message}){
      if(!message)return;
      const key=type+'::'+message, now=Date.now(), last=seenLogs.get(key)||0;
      if(now-last<DEDUP)return; seenLogs.set(key,now);
      const time=new Date(ts).toLocaleTimeString('ko-KR',{hour12:false});
      const div=document.createElement('div');
      div.className='log-item';
      div.innerHTML='<span class="log-time">['+time+']</span> '+esc(message);
      logPanel.appendChild(div); logPanel.scrollTop=logPanel.scrollHeight;
    }

    function addChat({name,message}){
      if(!name||!message)return;
      const key=name+'::'+message, now=Date.now(), last=seenChats.get(key)||0;
      if(now-last<DEDUP)return; seenChats.set(key,now);
      const div=document.createElement('div');
      div.className='chat-item';
      div.innerHTML='<span class="chat-name">'+esc(name)+'</span>: '+esc(message);
      chatPanel.appendChild(div); chatPanel.scrollTop=chatPanel.scrollHeight;
    }

    function createBattle(){
      const mode=document.getElementById('battleMode').value;
      socket.emit('createBattle',{mode},(res)=>{
        if(res&&res.ok){
          currentBattleId=res.battleId||null;
          addLog({ts:Date.now(),type:'notice',message:mode+' 전투 생성됨 ID:'+currentBattleId});
          if(currentBattleId)socket.emit('join',{battleId:currentBattleId});
        } else alert('전투 생성 실패');
      });
    }

    function addPlayer(){
      if(!currentBattleId){alert('먼저 전투 생성');return;}
      const name=document.getElementById('playerName').value.trim();
      if(!name){alert('이름 입력');return;}
      const team=document.getElementById('playerTeam').value;
      const hp=+document.getElementById('playerHP').value||100;
      const data={name,team,hp,maxHp:hp,stats:{
        attack:+document.getElementById('playerAttack').value||1,
        defense:+document.getElementById('playerDefense').value||1,
        agility:+document.getElementById('playerAgility').value||1,
        luck:+document.getElementById('playerLuck').value||1
      },items:{
        dittany:+document.getElementById('playerDittany').value||0,
        attackBooster:+document.getElementById('playerAttackBooster').value||0,
        defenseBooster:+document.getElementById('playerDefenseBooster').value||0
      },avatar:uploadedAvatarUrl};
      socket.emit('addPlayer',{battleId:currentBattleId,player:data},(res)=>{
        if(res&&res.ok)addLog({ts:Date.now(),type:'notice',message:name+' 추가됨'});
      });
    }

    function generateLinks(){
      if(!currentBattleId){alert('먼저 전투 생성');return;}
      fetch('/api/admin/battles/'+currentBattleId+'/links',{method:'POST'})
        .then(r=>r.json()).then(d=>{
          if(d&&d.links) displayLinks(d.links);
        });
    }

    function displayLinks(links){
      const c=document.getElementById('linksContainer'); let h='';
      if(links.spectator){
        h+='<div class="link-item"><div class="link-label">관전자</div>'+
           '<div class="link-url" onclick="copyToClipboard(\''+links.spectator.url+'\',event)">'+links.spectator.url+'</div>'+
           '<button class="copy-btn" onclick="copyToClipboard(\''+links.spectator.url+'\',event)">복사</button></div>';
      }
      if(Array.isArray(links.players)){
        links.players.forEach(l=>{
          h+='<div class="link-item"><div class="link-label">'+esc(l.name)+'('+esc(l.team)+')</div>'+
             '<div class="link-url" onclick="copyToClipboard(\''+l.url+'\',event)">'+l.url+'</div>'+
             '<button class="copy-btn" onclick="copyToClipboard(\''+l.url+'\',event)">복사</button></div>';
        });
      }
      c.innerHTML=h;
    }

    window.copyToClipboard=function(text,ev){
      navigator.clipboard.writeText(text).then(()=>{
        if(ev&&ev.target){const b=ev.target;const t=b.textContent;b.textContent='복사됨!';
          setTimeout(()=>b.textContent=t,800);}
      });
    };

    function sendChat(){
      const input=document.getElementById('chatInput');const msg=input.value.trim();
      if(!msg||!currentBattleId)return;
      socket.emit('chatMessage',{battleId:currentBattleId,name:'관리자',message:msg});
      input.value='';
    }

    // 버튼 이벤트
    document.getElementById('btnCreate').onclick=createBattle;
    document.getElementById('btnAddPlayer').onclick=addPlayer;
    document.getElementById('btnGenPlayerLinks').onclick=generateLinks;
    document.getElementById('btnGenSpectatorLink').onclick=generateLinks;
    document.getElementById('chatSend').onclick=sendChat;
    document.getElementById('chatInput').addEventListener('keypress',e=>{
      if(e.key==='Enter'){e.preventDefault();sendChat();}
    });

    // 소켓 이벤트
    socket.on('connect',()=>addLog({ts:Date.now(),type:'notice',message:'서버 연결됨'}));
    socket.on('disconnect',()=>addLog({ts:Date.now(),type:'error',message:'서버 끊김'}));
    socket.on('battle:log',addLog);
    socket.on('battleLog',addLog);
    socket.on('chatMessage',addChat);
    socket.on('battle:chat',addChat);

  })();
  </script>
</body>
</html>
