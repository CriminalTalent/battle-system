<!-- packages/battle-server/public/admin.html -->
<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>PYXIS 관리자</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&display=swap" rel="stylesheet">
<script src="/socket.io/socket.io.js"></script>
<style>
  :root{
    --gold:#c9a96e;
    --ink:#e9e3d0; --ink-dim:#bfb7a5;
    --bg:#0a0f1a; --panel:#0c1326; --panel2:#0b1020;
    --line:#20283c; --line2:#1a2234;
    --blur: blur(10px) saturate(120%);
    --lift: 0 10px 22px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 600px at 20% -10%, rgba(201,169,110,.12), transparent 60%), #0a0f1a; color:var(--ink); font-family:system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif}

  /* 헤더: 회전 그라디언트 */
  header{position:relative;padding:18px 16px 10px 16px}
  header::before{
    content:""; position:absolute; inset:-40% -10% auto -10%; height:280px;
    background:conic-gradient(from 0deg, rgba(201,169,110,.18), rgba(201,169,110,.03), rgba(201,169,110,.18));
    filter:blur(40px); animation:spin 28s linear infinite; opacity:.65; pointer-events:none;
  }
  @keyframes spin{to{transform:rotate(360deg)}}

  .wrap{max-width:1200px;margin:0 auto}
  .brand{font-family:"Playfair Display", serif; font-weight:800; letter-spacing:.06em; font-size:28px;
    color:var(--gold); position:relative; display:inline-block}
  .twinkles{position:absolute; inset:0; pointer-events:none}
  .twinkles span{position:absolute; width:3px; height:3px; background:var(--gold); border-radius:999px; opacity:.7; animation:twinkle 2.2s ease-in-out infinite}
  .twinkles span:nth-child(1){left:8%; top:40%; animation-delay:.1s}
  .twinkles span:nth-child(2){left:30%; top:15%; animation-delay:.6s}
  .twinkles span:nth-child(3){left:58%; top:35%; animation-delay:1.1s}
  .twinkles span:nth-child(4){left:80%; top:22%; animation-delay:1.6s}
  @keyframes twinkle{0%,100%{opacity:.15; transform:scale(.7)}50%{opacity:1; transform:scale(1)}}

  .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:14px;padding:10px 16px}
  @media (max-width:1000px){.grid{grid-template-columns:1fr}}

  .card{position:relative;background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--line); border-radius:16px; padding:14px; backdrop-filter:var(--blur); box-shadow:var(--lift); transition:transform .25s ease, box-shadow .25s ease}
  .card:hover{transform:translateY(-2px)}
  .title{margin:0 0 10px 0; color:var(--gold); font-weight:700}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .input, select, textarea{background:#0c172c; color:var(--ink); border:1px solid var(--line); border-radius:12px; padding:10px}
  .btn{border:1px solid var(--line2); color:var(--ink); background:linear-gradient(180deg,#212f4a,#15243f); padding:10px 12px; border-radius:12px; cursor:pointer; position:relative; overflow:hidden}
  .btn::after{content:""; position:absolute; inset:0; background:linear-gradient(90deg, transparent, rgba(255,255,255,.25), transparent); transform:translateX(-120%); transition:transform .8s; mix-blend-mode:overlay}
  .btn:hover::after{transform:translateX(120%)}
  .btn.gold{border-color:#6f5a33; background:linear-gradient(180deg,#e6d2a6,#c9a96e); color:#231b0b}
  .btn.success{border-color:#2e5f46; background:linear-gradient(180deg,#3f8f69,#2e5f46)}
  .btn.warn{border-color:#7b5b20; background:linear-gradient(180deg,#c1994e,#896d33)}
  .btn.danger{border-color:#6a2b2b; background:linear-gradient(180deg,#be5a5a,#8f3f3f)}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0d172b; color:#9aaccc}
  .chat{height:340px;overflow:auto;background:#0a1326;border:1px solid var(--line);border-radius:12px;padding:10px}
  .chat .row{display:flex;gap:8px;align-items:baseline;margin-bottom:6px}
  .ts{font-size:11px;color:#8aa0c2;min-width:54px}
  .list{display:grid;gap:8px}
  .unit{display:flex;gap:10px;align-items:center;padding:10px;border:1px solid var(--line);border-radius:12px;background:#0e152a}
  .bar{height:8px;background:#1b2336;border-radius:8px;overflow:hidden}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,#4da3ff,#67e8f9)}
  .items-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .item-row{display:flex;gap:8px;align-items:center}
  .item-row input[type="number"]{width:80px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">PYXIS
      <span class="twinkles"><span></span><span></span><span></span><span></span></span>
    </div>
    <div style="height:6px"></div>
  </div>
</header>

<div class="wrap grid">
  <div class="card">
    <h3 class="title">전투 생성 및 인증</h3>
    <div class="row" style="justify-content:space-between">
      <label>전투 모드
        <select id="mode" class="input">
          <option value="1v1">1 vs 1</option>
          <option value="2v2" selected>2 vs 2</option>
          <option value="3v3">3 vs 3</option>
          <option value="4v4">4 vs 4</option>
        </select>
      </label>
      <div class="row">
        <button id="btnCreate" class="btn gold">생성</button>
        <span id="statusPill" class="pill">대기중</span>
      </div>
    </div>

    <div style="height:8px"></div>
    <div class="row" style="gap:12px;flex-wrap:wrap">
      <label>전투 ID
        <input id="battleId" class="input" placeholder="생성 후 자동" readonly>
      </label>
      <label>관리자 OTP
        <input id="adminOtp" class="input" placeholder="생성 후 자동" readonly>
      </label>
      <label>관전자 OTP
        <input id="spectatorOtp" class="input" placeholder="생성 후 자동" readonly>
      </label>
    </div>

    <div style="height:8px"></div>
    <div class="row">
      <button id="btnAuth" class="btn">인증 연결</button>
      <button id="btnStart" class="btn success">시작</button>
      <button id="btnPause" class="btn warn">일시정지</button>
      <button id="btnEnd" class="btn danger">종료</button>
    </div>
  </div>

  <div class="card">
    <h3 class="title">로그 · 채팅</h3>
    <div id="chat" class="chat"></div>
    <div class="row" style="margin-top:6px">
      <input id="chatInput" class="input" placeholder="메시지 입력" style="flex:1 1 auto" />
      <select id="chatChannel" class="input">
        <option value="all">전체</option>
        <option value="team">팀</option>
      </select>
      <button id="chatSend" class="btn gold">보내기</button>
    </div>
  </div>

  <div class="card">
    <h3 class="title">로스터 구성</h3>
    <div class="row" style="gap:12px;flex-wrap:wrap">
      <label>이름
        <input id="pName" class="input" placeholder="이름">
      </label>
      <label>팀
        <select id="pTeam" class="input">
          <option value="team1">불사조 기사단</option>
          <option value="team2">죽음을 먹는 자들</option>
        </select>
      </label>
      <label>ATK <input id="pAtk" class="input" type="number" min="1" max="5" value="3"></label>
      <label>DEF <input id="pDef" class="input" type="number" min="1" max="5" value="3"></label>
      <label>AGI <input id="pAgi" class="input" type="number" min="1" max="5" value="3"></label>
      <label>LUCK <input id="pLuck" class="input" type="number" min="1" max="5" value="3"></label>
    </div>

    <div style="height:8px"></div>
    <div class="items-grid" id="itemsGrid"></div>

    <div style="height:8px"></div>
    <div class="row">
      <button id="btnAdd" class="btn gold">플레이어 추가</button>
      <button id="btnLinks" class="btn">플레이어별 링크 생성</button>
    </div>

    <div style="height:10px"></div>
    <div class="row" style="gap:16px;align-items:flex-start;flex-wrap:wrap">
      <div style="min-width:280px;flex:1">
        <div class="title" style="margin:0 0 6px 0;color:var(--ink-dim);font-weight:600">불사조 기사단</div>
        <div id="team1" class="list"></div>
      </div>
      <div style="min-width:280px;flex:1">
        <div class="title" style="margin:0 0 6px 0;color:var(--ink-dim);font-weight:600">죽음을 먹는 자들</div>
        <div id="team2" class="list"></div>
      </div>
    </div>

    <div style="height:10px"></div>
    <div id="linkList" class="list"></div>
  </div>

  <div class="card">
    <h3 class="title">전장 정보</h3>
    <div id="headInfo" style="color:var(--ink-dim)"></div>
  </div>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const statusPill = $('statusPill');
  const battleId = $('battleId'), adminOtp = $('adminOtp'), spectatorOtp = $('spectatorOtp');
  const modeSel = $('mode');
  const chatEl = $('chat'), chatInput = $('chatInput'), chatSend = $('chatSend'), chatChannel = $('chatChannel');
  const team1 = $('team1'), team2 = $('team2'), headInfo = $('headInfo');
  const itemsGrid = $('itemsGrid');

  const ITEM_LIST = ['디터니','공격 보정기','방어 보정기'];
  function buildItemsUI() {
    itemsGrid.innerHTML = '';
    ITEM_LIST.forEach(name => {
      const row = document.createElement('div');
      row.className = 'item-row';
      const label = document.createElement('label');
      label.textContent = name;
      const qty = document.createElement('input');
      qty.type = 'number'; qty.min = '0'; qty.max = '99'; qty.value = '0';
      qty.dataset.item = name;
      row.appendChild(label); row.appendChild(qty);
      itemsGrid.appendChild(row);
    });
  }
  buildItemsUI();

  const socket = io({ path: '/socket.io/' });
  let state = null;

  const qs = new URLSearchParams(location.search);
  if (qs.get('battle')) battleId.value = qs.get('battle');
  if (qs.get('token'))  adminOtp.value = qs.get('token');

  function setStatusPill(status){
    statusPill.textContent = status==='waiting'?'대기중':status==='ongoing'?'진행중':status==='paused'?'일시정지':'종료';
  }
  function fmtTs(ts){ try{ return new Date(ts).toLocaleTimeString([], {hour12:false}); }catch{return '--:--:--';} }
  function lineEl(klass, tsText, bodyText){
    const row = document.createElement('div'); row.className = 'row ' + klass;
    const ts = document.createElement('span'); ts.className = 'ts'; ts.textContent = tsText;
    const msg = document.createElement('span'); msg.textContent = bodyText;
    row.appendChild(ts); row.appendChild(msg); return row;
  }
  function appendChat(msg){
    if (!msg) return;
    const t = fmtTs(msg.ts || Date.now());
    let text = '';
    if (msg.type === 'system') text = '[시스템] ' + msg.text;
    else if (msg.type === 'cheer') text = '[응원] ' + (msg.from||'관전자') + ': ' + msg.text;
    else if (msg.type === 'chat') text = '[' + (msg.channel === 'team' ? '팀':'전체') + '] ' + (msg.from||'익명') + ': ' + msg.text;
    chatEl.appendChild(lineEl('', t, text));
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function render(){
    if (!state) return;
    setStatusPill(state.status);
    const T = state.turn || {turnIndex:0, frameIndex:0, framePlan:[]};
    headInfo.textContent = `전투 ${state.id} · 모드 ${state.mode} · 턴 ${T.turnIndex} / 프레임 ${T.frameIndex+1} / 총 ${T.framePlan.length}`;

    team1.innerHTML = ''; team2.innerHTML = '';
    const mkUnit = (p) => {
      const box = document.createElement('div'); box.className = 'unit';
      const info = document.createElement('div'); info.style.flex='1';
      const name = document.createElement('div'); name.style.fontWeight='600'; name.textContent = `${p.name}${p.alive?'':' (불능)'}`;
      const bar = document.createElement('div'); bar.className = 'bar';
      const span = document.createElement('span'); span.style.width=`${Math.round((p.hp/p.maxHp)*100)}%`; bar.appendChild(span);
      const meta = document.createElement('div'); meta.style.color='#a8b0c6'; meta.textContent = `ATK ${p.stats.attack} / DEF ${p.stats.defense} / AGI ${p.stats.agility} / LUCK ${p.stats.luck}`;
      info.appendChild(name); info.appendChild(bar); info.appendChild(meta);
      box.appendChild(info);
      return box;
    };
    Object.values(state.players).filter(p=>p.team==='team1').forEach(p=>team1.appendChild(mkUnit(p)));
    Object.values(state.players).filter(p=>p.team==='team2').forEach(p=>team2.appendChild(mkUnit(p)));
  }

  socket.on('connect', ()=>{
    if (battleId.value && adminOtp.value) {
      socket.emit('auth', { battle: battleId.value, token: adminOtp.value, role:'admin' }, (ack)=>{
        if (!ack || !ack.ok) { alert('인증 실패'); return; }
        state = ack.state; render();
      });
    }
  });
  socket.on('state', s => { state = s; render(); });
  socket.on('chat', appendChat);
  socket.on('chatError', (m)=> alert(m));

  $('btnCreate').onclick = async ()=>{
    try {
      const mode = modeSel.value || '1v1';
      const res = await fetch('/api/admin/battles', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ mode })});
      if (!res.ok) { const txt = await res.text().catch(()=> ''); alert('생성 실패: '+res.status+' '+txt); return; }
      const data = await res.json();
      battleId.value = data.battle.id;
      adminOtp.value = data.otps.admin;
      spectatorOtp.value = data.otps.spectator;
      alert('전투가 생성되었습니다: ' + data.battle.id);
    } catch (e) { alert('생성 실패: ' + (e && (e.message||e))); }
  };

  $('btnAuth').onclick = ()=>{
    if (!battleId.value || !adminOtp.value) { alert('전투ID/관리자 OTP를 확인하세요'); return; }
    socket.emit('auth', { battle:battleId.value, token:adminOtp.value, role:'admin' }, (ack)=>{
      if (!ack || !ack.ok) { alert('인증 실패'); return; }
      state = ack.state; render();
      alert('인증 성공');
    });
  };

  $('btnStart').onclick = async ()=>{
    if (!battleId.value) return alert('전투ID가 없습니다');
    const r = await fetch(`/api/admin/battles/${battleId.value}/start`, { method:'POST' });
    if (!r.ok) return alert('시작 실패');
  };
  $('btnPause').onclick = async ()=>{
    if (!battleId.value) return alert('전투ID가 없습니다');
    const r = await fetch(`/api/admin/battles/${battleId.value}/pause`, { method:'POST' });
    if (!r.ok) return alert('일시정지 실패');
  };
  $('btnEnd').onclick = async ()=>{
    if (!battleId.value) return alert('전투ID가 없습니다');
    const r = await fetch(`/api/admin/battles/${battleId.value}/end`, { method:'POST' });
    if (!r.ok) return alert('종료 실패');
  };

  $('btnAdd').onclick = async ()=>{
    if (!battleId.value) return alert('전투ID가 없습니다');
    const name = $('pName').value.trim();
    const team = $('pTeam').value;
    const stats = { attack: Number($('pAtk').value||3), defense:Number($('pDef').value||3), agility:Number($('pAgi').value||3), luck:Number($('pLuck').value||3) };
    if (!name) return alert('이름을 입력하세요');

    const inv = {};
    itemsGrid.querySelectorAll('input[type="number"]').forEach(inp=>{
      const n = inp.dataset.item; const q = Math.max(0, Math.floor(Number(inp.value || 0)));
      if (q > 0) inv[n] = q;
    });

    const r = await fetch(`/api/battles/${battleId.value}/players`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ name, team, stats, inventory: inv })
    });
    if (!r.ok) { const t = await r.text().catch(()=> ''); alert('추가 실패: '+t); return; }

    $('pName').value=''; buildItemsUI();
  };

  $('btnLinks').onclick = async ()=>{
    if (!battleId.value) return alert('전투ID가 없습니다');
    const r = await fetch(`/api/admin/battles/${battleId.value}/links`, { method:'POST' });
    if (!r.ok) return alert('링크 생성 실패');
    const d = await r.json();
    const box = $('linkList'); box.innerHTML = '';
    d.playerLinks.forEach(pl=>{
      const div = document.createElement('div');
      div.className='unit';
      div.textContent = `${pl.name}: ${pl.url}`;
      box.appendChild(div);
    });
  };

  chatSend.onclick = ()=>{
    const text = chatInput.value.trim(); if (!text) return;
    socket.emit('chatMessage', { message: text, channel: chatChannel.value });
    chatInput.value = '';
  };
})();
</script>
</body>
</html>
