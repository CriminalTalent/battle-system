<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PYXIS 전투 관리석</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@300;400;500;600;700;800;900&display=swap');
    
    /* 기본 리셋 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Playfair Display', serif;
      background: 
        radial-gradient(circle at 30% 20%, rgba(201, 169, 110, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 70% 80%, rgba(26, 35, 50, 0.8) 0%, transparent 70%),
        linear-gradient(135deg, #0a0e1a 0%, #1a2332 50%, #2a3441 100%);
      color: #f8f9fa;
      min-height: 100vh;
      line-height: 1.6;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 80% 20%, rgba(201, 169, 110, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 20% 80%, rgba(201, 169, 110, 0.02) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 50px;
      padding: 60px 20px;
      background: rgba(10, 14, 26, 0.8);
      border: 1px solid rgba(201, 169, 110, 0.2);
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(20px);
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(201, 169, 110, 0.1) 0%, transparent 70%);
      animation: rotate 20s linear infinite;
      pointer-events: none;
    }

    @keyframes rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .title {
      font-family: 'Playfair Display', serif;
      font-size: 4.5rem;
      font-weight: 400;
      color: #c9a96e;
      margin-bottom: 16px;
      letter-spacing: 0.05em;
      position: relative;
      z-index: 1;
      text-shadow: 0 0 30px rgba(201, 169, 110, 0.5);
    }

    .title::before {
      content: '✦';
      position: absolute;
      top: -15px;
      left: 20px;
      font-size: 2rem;
      color: #c9a96e;
      animation: twinkle 3s ease-in-out infinite;
    }

    .title::after {
      content: '✧';
      position: absolute;
      bottom: -10px;
      right: 30px;
      font-size: 1.5rem;
      color: #d4b982;
      animation: twinkle 2.5s ease-in-out infinite reverse;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
    }

    .subtitle {
      font-family: 'Playfair Display', serif;
      font-size: 1.4rem;
      color: #adb5bd;
      font-weight: 300;
      letter-spacing: 2px;
      position: relative;
      z-index: 1;
    }

    .card {
      background: rgba(26, 35, 50, 0.4);
      border: 1px solid rgba(201, 169, 110, 0.15);
      border-radius: 20px;
      padding: 35px;
      margin-bottom: 35px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(15px);
      position: relative;
      transition: all 0.3s ease;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, #c9a96e, transparent);
      opacity: 0.6;
    }

    .card:hover {
      border-color: rgba(201, 169, 110, 0.3);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
      transform: translateY(-2px);
    }

    .card-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.8rem;
      color: #c9a96e;
      margin-bottom: 24px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(201, 169, 110, 0.2);
      display: flex;
      align-items: center;
      gap: 14px;
      font-weight: 500;
      letter-spacing: 0.02em;
    }

    .card-title::before {
      content: '';
      width: 4px;
      height: 28px;
      background: linear-gradient(to bottom, #d4b982, #c9a96e, #b8935a);
      border-radius: 2px;
      box-shadow: 0 0 10px rgba(201, 169, 110, 0.4);
    }

    .form-grid {
      display: grid;
      gap: 18px;
    }

    .form-grid.cols-2 { grid-template-columns: 1fr 1fr; }
    .form-grid.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
    .form-grid.cols-4 { grid-template-columns: repeat(4, 1fr); }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .form-label {
      font-family: 'Playfair Display', serif;
      color: #c9a96e;
      font-size: 1rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .form-input, .form-select {
      font-family: 'Playfair Display', serif;
      background: rgba(10, 14, 26, 0.7);
      border: 1px solid rgba(201, 169, 110, 0.25);
      border-radius: 10px;
      padding: 14px 18px;
      color: #f8f9fa;
      font-size: 1rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #c9a96e;
      box-shadow: 0 0 0 3px rgba(201, 169, 110, 0.1), 0 0 20px rgba(201, 169, 110, 0.2);
      transform: translateY(-1px);
    }

    .btn {
      font-family: 'Playfair Display', serif;
      background: linear-gradient(135deg, #b8935a, #c9a96e, #d4b982);
      border: none;
      border-radius: 10px;
      padding: 14px 28px;
      color: #0a0e1a;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 0.95rem;
      box-shadow: 0 2px 8px rgba(201, 169, 110, 0.3);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(201, 169, 110, 0.4);
      background: linear-gradient(135deg, #c9a96e, #d4b982, #e8d5b7);
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
      background: rgba(52, 58, 64, 0.8);
      color: #adb5bd;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #3a4451, #2c3e50, #34495e);
      color: #f8f9fa;
      box-shadow: 0 2px 8px rgba(52, 58, 64, 0.3);
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, #2c3e50, #34495e, #3a4451);
    }

    .btn-danger {
      background: linear-gradient(135deg, #dc3545, #c82333, #e74c3c);
      color: white;
      box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
    }

    .btn-success {
      background: linear-gradient(135deg, #28a745, #20c997, #17a2b8);
      color: white;
      box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }

    .btn-warning {
      background: linear-gradient(135deg, #ffc107, #fd7e14, #f39c12);
      color: #0a0e1a;
      box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 18px;
      margin: 24px 0;
    }

    .status-card {
      background: rgba(10, 14, 26, 0.6);
      border: 1px solid rgba(201, 169, 110, 0.2);
      border-radius: 14px;
      padding: 18px;
      text-align: center;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      position: relative;
    }

    .status-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, #b8935a, #c9a96e, #d4b982);
      border-radius: 14px 14px 0 0;
    }

    .status-card:hover {
      border-color: rgba(201, 169, 110, 0.4);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    .status-label {
      font-family: 'Playfair Display', serif;
      color: #adb5bd;
      font-size: 0.85rem;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 500;
    }

    .status-value {
      font-family: 'Playfair Display', serif;
      color: #c9a96e;
      font-size: 1.3rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .url-display {
      margin-top: 24px;
      padding: 24px;
      background: rgba(10, 14, 26, 0.6);
      border-radius: 14px;
      border: 1px solid rgba(201, 169, 110, 0.2);
      backdrop-filter: blur(15px);
    }

    .url-item {
      display: flex;
      align-items: center;
      margin-bottom: 14px;
      gap: 18px;
    }

    .url-label {
      font-family: 'Playfair Display', serif;
      color: #c9a96e;
      font-weight: 600;
      min-width: 130px;
      font-size: 1rem;
    }

    .code-display {
      background: rgba(10, 14, 26, 0.8);
      border: 1px solid rgba(201, 169, 110, 0.2);
      border-radius: 8px;
      padding: 10px 14px;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      color: #d4b982;
      cursor: pointer;
      flex: 1;
      word-break: break-all;
      transition: all 0.3s ease;
    }

    .code-display:hover {
      background: rgba(201, 169, 110, 0.1);
      border-color: #c9a96e;
      transform: translateY(-1px);
    }

    .player-list {
      max-height: 320px;
      overflow-y: auto;
      margin-top: 18px;
    }

    .player-list::-webkit-scrollbar {
      width: 6px;
    }

    .player-list::-webkit-scrollbar-track {
      background: rgba(10, 14, 26, 0.5);
      border-radius: 3px;
    }

    .player-list::-webkit-scrollbar-thumb {
      background: #c9a96e;
      border-radius: 3px;
    }

    .player-card {
      background: rgba(10, 14, 26, 0.6);
      border: 1px solid rgba(201, 169, 110, 0.2);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 10px;
      border-left: 3px solid #c9a96e;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .player-card:hover {
      border-color: rgba(201, 169, 110, 0.4);
      transform: translateX(4px);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .player-name {
      font-family: 'Playfair Display', serif;
      color: #c9a96e;
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 1.1rem;
    }

    .player-stats {
      font-family: 'Playfair Display', serif;
      color: #adb5bd;
      font-size: 0.95rem;
      font-weight: 400;
    }

    .chat-area {
      background: rgba(10, 14, 26, 0.8);
      border: 1px solid rgba(201, 169, 110, 0.2);
      border-radius: 10px;
      height: 220px;
      overflow-y: auto;
      padding: 18px;
      margin-bottom: 18px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      backdrop-filter: blur(15px);
    }

    .chat-area::-webkit-scrollbar {
      width: 6px;
    }

    .chat-area::-webkit-scrollbar-track {
      background: rgba(10, 14, 26, 0.5);
      border-radius: 3px;
    }

    .chat-area::-webkit-scrollbar-thumb {
      background: #c9a96e;
      border-radius: 3px;
    }

    .chat-controls {
      display: flex;
      gap: 14px;
    }

    .chat-input {
      font-family: 'Playfair Display', serif;
      flex: 1;
      background: rgba(10, 14, 26, 0.8);
      border: 1px solid rgba(201, 169, 110, 0.25);
      border-radius: 10px;
      padding: 14px;
      color: #f8f9fa;
      font-size: 1rem;
      backdrop-filter: blur(10px);
    }

    .chat-input:focus {
      outline: none;
      border-color: #c9a96e;
      box-shadow: 0 0 0 2px rgba(201, 169, 110, 0.1);
    }

    .battle-controls {
      display: flex;
      gap: 14px;
      justify-content: center;
      margin-top: 24px;
    }

    .team-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-top: 24px;
    }

    .team-card {
      background: rgba(10, 14, 26, 0.6);
      border: 1px solid rgba(201, 169, 110, 0.2);
      border-radius: 14px;
      padding: 20px;
      backdrop-filter: blur(10px);
      position: relative;
    }

    .team-card.phoenix {
      border-left: 4px solid #dc3545;
    }

    .team-card.death {
      border-left: 4px solid #28a745;
    }

    .team-name {
      font-family: 'Playfair Display', serif;
      color: #c9a96e;
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 14px;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .hidden {
      display: none !important;
    }

    .action-log {
      background: rgba(10, 14, 26, 0.8);
      border: 1px solid rgba(201, 169, 110, 0.2);
      border-radius: 10px;
      height: 200px;
      overflow-y: auto;
      padding: 16px;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      color: #adb5bd;
    }

    .action-log::-webkit-scrollbar {
      width: 6px;
    }

    .action-log::-webkit-scrollbar-track {
      background: rgba(10, 14, 26, 0.5);
      border-radius: 3px;
    }

    .action-log::-webkit-scrollbar-thumb {
      background: #c9a96e;
      border-radius: 3px;
    }

    /* 반응형 */
    @media (max-width: 768px) {
      .form-grid.cols-2,
      .form-grid.cols-3,
      .form-grid.cols-4 {
        grid-template-columns: 1fr;
      }
      
      .title {
        font-size: 3rem;
      }
      
      .chat-controls {
        flex-direction: column;
      }
      
      .team-info {
        grid-template-columns: 1fr;
      }
      
      .container {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 헤더 -->
    <div class="header">
      <h1 class="title">PYXIS</h1>
      <p class="subtitle">전투 관리석</p>
    </div>

    <!-- 전투 구성 -->
    <section class="card">
      <div class="card-title">전투 구성</div>
      
      <div class="form-grid cols-3">
        <div class="form-group">
          <label class="form-label">전투 ID</label>
          <input type="text" id="battleId" class="form-input" placeholder="전투 ID" readonly>
        </div>
        <div class="form-group">
          <label class="form-label">전투 모드</label>
          <select id="mode" class="form-select">
            <option value="1v1">1v1</option>
            <option value="2v2">2v2</option>
            <option value="3v3">3v3</option>
            <option value="4v4">4v4</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">동작</label>
          <div class="form-grid cols-3">
            <button class="btn" id="btnCreate">전투 생성</button>
            <button class="btn btn-secondary" id="btnLinks" disabled>링크 생성</button>
            <button class="btn btn-secondary" id="btnFetch">상태 갱신</button>
          </div>
        </div>
      </div>
      
      <div id="urlSection" class="url-display hidden">
        <div class="url-item">
          <span class="url-label">관리자 URL:</span>
          <code id="adminUrl" class="code-display">-</code>
        </div>
        <div class="url-item">
          <span class="url-label">플레이어 URL:</span>
          <code id="playerUrl" class="code-display">-</code>
        </div>
        <div class="url-item">
          <span class="url-label">관전자 URL:</span>
          <code id="spectUrl" class="code-display">-</code>
        </div>
      </div>

      <div class="status-grid">
        <div class="status-card">
          <div class="status-label">전투 ID</div>
          <div class="status-value" id="statusId">-</div>
        </div>
        <div class="status-card">
          <div class="status-label">모드</div>
          <div class="status-value" id="statusMode">-</div>
        </div>
        <div class="status-card">
          <div class="status-label">상태</div>
          <div class="status-value" id="statusState">준비중</div>
        </div>
        <div class="status-card">
          <div class="status-label">플레이어</div>
          <div class="status-value" id="statusPlayers">0/0</div>
        </div>
        <div class="status-card">
          <div class="status-label">턴</div>
          <div class="status-value" id="statusTurn">0</div>
        </div>
        <div class="status-card">
          <div class="status-label">현재 팀</div>
          <div class="status-value" id="statusCurrentTeam">-</div>
        </div>
      </div>
    </section>

    <!-- 전투 관리 -->
    <section class="card">
      <div class="card-title">전투 관리</div>
      
      <div class="battle-controls">
        <button class="btn btn-success" id="btnStart" disabled>전투 시작</button>
        <button class="btn btn-warning" id="btnPause" disabled>일시 정지</button>
        <button class="btn btn-danger" id="btnEnd" disabled>전투 종료</button>
        <button class="btn btn-secondary" id="btnReset" disabled>초기화</button>
      </div>

      <div class="team-info">
        <div class="team-card phoenix">
          <div class="team-name">불사조 기사단</div>
          <div class="player-list" id="phoenixPlayers">
            <div class="status-label">플레이어 없음</div>
          </div>
        </div>
        <div class="team-card death">
          <div class="team-name">죽음을 먹는자들</div>
          <div class="player-list" id="deathPlayers">
            <div class="status-label">플레이어 없음</div>
          </div>
        </div>
      </div>
    </section>

    <!-- 실시간 로그 -->
    <section class="card">
      <div class="card-title">실시간 전투 로그</div>
      <div class="action-log" id="actionLog">
        시스템: 전투 관리석이 준비되었습니다.<br>
      </div>
    </section>

    <!-- 관리자 채팅 -->
    <section class="card">
      <div class="card-title">관리자 공지</div>
      <div class="chat-area" id="chatArea">
        시스템: 관리자 채팅이 활성화되었습니다.<br>
      </div>
      <div class="chat-controls">
        <input type="text" id="chatInput" class="chat-input" placeholder="관리자 공지사항을 입력하세요...">
        <button class="btn" id="btnSendChat">전송</button>
      </div>
    </section>
  </div>

  <script src="https://cdn.socket.io/4.7.0/socket.io.min.js"></script>
  <script>
    // 전역 변수
    let currentBattle = null;
    let socket = null;
    let isAuthenticated = false;

    // DOM 요소
    const elements = {
      battleId: document.getElementById('battleId'),
      mode: document.getElementById('mode'),
      statusId: document.getElementById('statusId'),
      statusMode: document.getElementById('statusMode'),
      statusState: document.getElementById('statusState'),
      statusPlayers: document.getElementById('statusPlayers'),
      statusTurn: document.getElementById('statusTurn'),
      statusCurrentTeam: document.getElementById('statusCurrentTeam'),
      urlSection: document.getElementById('urlSection'),
      adminUrl: document.getElementById('adminUrl'),
      playerUrl: document.getElementById('playerUrl'),
      spectUrl: document.getElementById('spectUrl'),
      phoenixPlayers: document.getElementById('phoenixPlayers'),
      deathPlayers: document.getElementById('deathPlayers'),
      actionLog: document.getElementById('actionLog'),
      chatArea: document.getElementById('chatArea'),
      chatInput: document.getElementById('chatInput'),
      btnCreate: document.getElementById('btnCreate'),
      btnLinks: document.getElementById('btnLinks'),
      btnFetch: document.getElementById('btnFetch'),
      btnStart: document.getElementById('btnStart'),
      btnPause: document.getElementById('btnPause'),
      btnEnd: document.getElementById('btnEnd'),
      btnReset: document.getElementById('btnReset'),
      btnSendChat: document.getElementById('btnSendChat')
    };

    // 이벤트 리스너
    elements.btnCreate.addEventListener('click', createBattle);
    elements.btnLinks.addEventListener('click', generateLinks);
    elements.btnFetch.addEventListener('click', fetchBattleState);
    elements.btnStart.addEventListener('click', startBattle);
    elements.btnPause.addEventListener('click', pauseBattle);
    elements.btnEnd.addEventListener('click', endBattle);
    elements.btnReset.addEventListener('click', resetBattle);
    elements.btnSendChat.addEventListener('click', sendChat);

    elements.chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendChat();
      }
    });

    // URL 복사 이벤트
    elements.adminUrl.addEventListener('click', () => copyToClipboard(elements.adminUrl.textContent));
    elements.playerUrl.addEventListener('click', () => copyToClipboard(elements.playerUrl.textContent));
    elements.spectUrl.addEventListener('click', () => copyToClipboard(elements.spectUrl.textContent));

    // 전투 생성
    async function createBattle() {
      try {
        const response = await fetch('/api/battles', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            mode: elements.mode.value
          })
        });

        const result = await response.json();
        
        if (result.success) {
          currentBattle = result.battle;
          elements.battleId.value = result.battle.id;
          elements.btnLinks.disabled = false;
          updateStatus();
          addLog('전투가 생성되었습니다: ' + result.battle.id);
        } else {
          alert('전투 생성 실패: ' + result.error);
        }
      } catch (error) {
        console.error('전투 생성 오류:', error);
        alert('전투 생성 중 오류가 발생했습니다.');
      }
    }

    // 링크 생성
    async function generateLinks() {
      if (!currentBattle) return;

      try {
        const response = await fetch(`/api/admin/battles/${currentBattle.id}/links`, {
          method: 'POST'
        });

        const result = await response.json();
        
        if (result.success) {
          const baseUrl = window.location.origin;
          elements.adminUrl.textContent = `${baseUrl}/admin?battle=${currentBattle.id}&token=${result.otps.admin}`;
          elements.playerUrl.textContent = `${baseUrl}/play?battle=${currentBattle.id}&token=${result.otps.player}`;
          elements.spectUrl.textContent = `${baseUrl}/watch?battle=${currentBattle.id}&token=${result.otps.spectator}`;
          
          elements.urlSection.classList.remove('hidden');
          addLog('OTP 링크가 생성되었습니다.');
          
          // Socket 연결 시도
          connectSocket(result.otps.admin);
        } else {
          alert('링크 생성 실패: ' + result.error);
        }
      } catch (error) {
        console.error('링크 생성 오류:', error);
        alert('링크 생성 중 오류가 발생했습니다.');
      }
    }

    // Socket 연결
    function connectSocket(adminOtp) {
      if (socket) {
        socket.disconnect();
      }

      socket = io();
      
      socket.on('connect', () => {
        console.log('Socket 연결됨');
        // 관리자 인증
        socket.emit('adminAuth', {
          battleId: currentBattle.id,
          otp: adminOtp
        });
      });

      socket.on('authSuccess', (data) => {
        isAuthenticated = true;
        addLog('관리자 인증 성공');
        elements.btnStart.disabled = false;
      });

      socket.on('authError', (data) => {
        addLog('인증 실패: ' + data.message);
      });

      socket.on('battleUpdate', (battleData) => {
        currentBattle = battleData;
        updateStatus();
        updatePlayerLists();
      });

      socket.on('chatMessage', (data) => {
        addChatMessage(`${data.player}: ${data.message}`);
      });

      socket.on('actionResult', (data) => {
        addLog(`${data.player}: ${data.action} - ${data.result}`);
      });

      socket.on('disconnect', () => {
        isAuthenticated = false;
        addLog('서버 연결이 끊어졌습니다.');
      });
    }

    // 전투 상태 갱신
    async function fetchBattleState() {
      if (!elements.battleId.value) return;

      try {
        const response = await fetch(`/api/battles/${elements.battleId.value}`);
        const result = await response.json();
        
        if (result.success) {
          currentBattle = result.battle;
          updateStatus();
          updatePlayerLists();
          addLog('전투 상태가 갱신되었습니다.');
        } else {
          alert('전투 조회 실패: ' + result.error);
        }
      } catch (error) {
        console.error('상태 갱신 오류:', error);
        alert('상태 갱신 중 오류가 발생했습니다.');
      }
    }

    // 전투 시작
    function startBattle() {
      if (!socket || !isAuthenticated) return;

      socket.emit('startBattle', {
        battleId: currentBattle.id
      });
      
      addLog('전투 시작을 요청했습니다.');
    }

    // 전투 일시정지
    function pauseBattle() {
      if (!socket || !isAuthenticated) return;

      socket.emit('pauseBattle', {
        battleId: currentBattle.id
      });
      
      addLog('전투 일시정지를 요청했습니다.');
    }

    // 전투 종료
    async function endBattle() {
      if (!currentBattle) return;

      if (!confirm('정말로 전투를 종료하시겠습니까?')) return;

      try {
        const response = await fetch(`/api/admin/battles/${currentBattle.id}/end`, {
          method: 'POST'
        });

        const result = await response.json();
        
        if (result.success) {
          addLog('전투가 강제 종료되었습니다.');
          elements.btnStart.disabled = true;
          elements.btnPause.disabled = true;
          elements.btnEnd.disabled = true;
        } else {
          alert('전투 종료 실패: ' + result.error);
        }
      } catch (error) {
        console.error('전투 종료 오류:', error);
        alert('전투 종료 중 오류가 발생했습니다.');
      }
    }

    // 전투 초기화
    function resetBattle() {
      if (!confirm('전투를 초기화하시겠습니까? 모든 데이터가 삭제됩니다.')) return;

      currentBattle = null;
      elements.battleId.value = '';
      elements.urlSection.classList.add('hidden');
      elements.btnLinks.disabled = true;
      elements.btnStart.disabled = true;
      elements.btnPause.disabled = true;
      elements.btnEnd.disabled = true;
      elements.btnReset.disabled = true;

      // Socket 연결 해제
      if (socket) {
        socket.disconnect();
        socket = null;
      }

      // 상태 초기화
      updateStatus();
      elements.phoenixPlayers.innerHTML = '<div class="status-label">플레이어 없음</div>';
      elements.deathPlayers.innerHTML = '<div class="status-label">플레이어 없음</div>';
      
      addLog('전투가 초기화되었습니다.');
    }

    // 채팅 전송
    function sendChat() {
      const message = elements.chatInput.value.trim();
      if (!message || !socket || !isAuthenticated) return;

      socket.emit('adminMessage', {
        battleId: currentBattle.id,
        message: message
      });

      addChatMessage(`관리자: ${message}`);
      elements.chatInput.value = '';
    }

    // 상태 업데이트
    function updateStatus() {
      if (!currentBattle) {
        elements.statusId.textContent = '-';
        elements.statusMode.textContent = '-';
        elements.statusState.textContent = '준비중';
        elements.statusPlayers.textContent = '0/0';
        elements.statusTurn.textContent = '0';
        elements.statusCurrentTeam.textContent = '-';
        return;
      }

      elements.statusId.textContent = currentBattle.id;
      elements.statusMode.textContent = currentBattle.mode;
      elements.statusState.textContent = getStateText(currentBattle.state);
      elements.statusPlayers.textContent = `${currentBattle.players.length}/${getMaxPlayers(currentBattle.mode)}`;
      elements.statusTurn.textContent = currentBattle.turn || 0;
      elements.statusCurrentTeam.textContent = currentBattle.currentTeam || '-';

      // 버튼 상태 업데이트
      updateButtonStates();
    }

    // 플레이어 목록 업데이트
    function updatePlayerLists() {
      if (!currentBattle) return;

      const phoenixPlayers = currentBattle.players.filter(p => p.team === 'phoenix');
      const deathPlayers = currentBattle.players.filter(p => p.team === 'death');

      updateTeamPlayerList(elements.phoenixPlayers, phoenixPlayers);
      updateTeamPlayerList(elements.deathPlayers, deathPlayers);
    }

    // 팀별 플레이어 목록 업데이트
    function updateTeamPlayerList(container, players) {
      if (players.length === 0) {
        container.innerHTML = '<div class="status-label">플레이어 없음</div>';
        return;
      }

      container.innerHTML = players.map(player => `
        <div class="player-card">
          <div class="player-name">${player.name}</div>
          <div class="player-stats">
            HP: ${player.hp}/100 | 
            공격: ${player.attack} | 
            방어: ${player.defense} | 
            민첩: ${player.agility} | 
            행운: ${player.luck}
          </div>
        </div>
      `).join('');
    }

    // 버튼 상태 업데이트
    function updateButtonStates() {
      if (!currentBattle) return;

      const canStart = currentBattle.state === 'waiting' && 
                      currentBattle.players.length >= 2 && 
                      isAuthenticated;
      const canPause = currentBattle.state === 'active' && isAuthenticated;
      const canEnd = ['waiting', 'active', 'paused'].includes(currentBattle.state) && isAuthenticated;
      const canReset = true;

      elements.btnStart.disabled = !canStart;
      elements.btnPause.disabled = !canPause;
      elements.btnEnd.disabled = !canEnd;
      elements.btnReset.disabled = !canReset;
    }

    // 로그 추가
    function addLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      elements.actionLog.innerHTML += `[${timestamp}] ${message}<br>`;
      elements.actionLog.scrollTop = elements.actionLog.scrollHeight;
    }

    // 채팅 메시지 추가
    function addChatMessage(message) {
      const timestamp = new Date().toLocaleTimeString();
      elements.chatArea.innerHTML += `[${timestamp}] ${message}<br>`;
      elements.chatArea.scrollTop = elements.chatArea.scrollHeight;
    }

    // 클립보드 복사
    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        addLog('URL이 클립보드에 복사되었습니다.');
      } catch (error) {
        console.error('복사 실패:', error);
        // Fallback
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        addLog('URL이 클립보드에 복사되었습니다.');
      }
    }

    // 헬퍼 함수들
    function getStateText(state) {
      const stateMap = {
        'waiting': '대기중',
        'active': '진행중',
        'paused': '일시정지',
        'ended': '종료됨'
      };
      return stateMap[state] || '알수없음';
    }

    function getMaxPlayers(mode) {
      const modeMap = {
        '1v1': 2,
        '2v2': 4,
        '3v3': 6,
        '4v4': 8
      };
      return modeMap[mode] || 0;
    }

    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', () => {
      // URL 파라미터 확인
      const urlParams = new URLSearchParams(window.location.search);
      const battleParam = urlParams.get('battle');
      const tokenParam = urlParams.get('token');

      if (battleParam && tokenParam) {
        elements.battleId.value = battleParam;
        addLog('URL에서 전투 정보를 감지했습니다.');
        
        // 자동으로 전투 정보 조회
        setTimeout(() => {
          fetchBattleState();
        }, 1000);
      }

      addLog('PYXIS 전투 관리석이 시작되었습니다.');
    });

    // 페이지 새로고침 시 확인
    window.addEventListener('beforeunload', (e) => {
      if (currentBattle && currentBattle.state === 'active') {
        e.preventDefault();
        e.returnValue = '진행 중인 전투가 있습니다. 정말로 페이지를 닫으시겠습니까?';
      }
    });
  </script>
</body>
</html>
