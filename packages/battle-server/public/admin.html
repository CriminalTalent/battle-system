<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>PYXIS - 관리자</title>
<script src="/socket.io/socket.io.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#0e0e0e; --bg2:#141414;
    --glass-1:rgba(0,0,0,.7); --glass-2:rgba(0,0,0,.5);
    --border:rgba(220,199,162,.3);
    --text:#F8F9FA; --muted:#A9AFB6;
    --gold:#DCC7A2; --gold2:#E6D2A8;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --shadow:0 10px 30px rgba(0,0,0,.45);
    --team-a-color:#8b5757; --team-b-color:#5d6b8d;
    --result-bg:#DCC7A2; --result-text:#000;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:linear-gradient(135deg,#000813,#001122);color:var(--text);font-family:system-ui,-apple-system,sans-serif;min-height:100vh;padding:8px}
  .container{max-width:1400px;margin:0 auto}
  .header{text-align:center;padding:16px;font-family:Cinzel,serif;color:var(--gold);font-size:24px;letter-spacing:.1em}

  .grid{display:grid;gap:12px;grid-template-columns:1fr;}
  @media (min-width: 1024px){ .grid{ grid-template-columns:1fr 2fr 1fr; } }

  .card{background:var(--glass-1);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:var(--shadow)}
  .title{font-family:Cinzel,serif;color:var(--gold);font-weight:700;letter-spacing:.08em;margin-bottom:8px;font-size:14px}

  .team-container{background:var(--glass-1);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:var(--shadow);height:fit-content}
  .team-title{font-family:Cinzel,serif;color:var(--gold);font-weight:700;letter-spacing:.08em;margin-bottom:12px;font-size:16px;text-align:center}
  .player-card{background:var(--glass-2);border:1px solid var(--border);border-radius:8px;padding:8px;margin-bottom:8px;display:flex;align-items:center;gap:8px}
  .player-card.dead{opacity:.5}
  .player-avatar{width:32px;height:32px;border-radius:50%;object-fit:cover;border:1px solid var(--gold);background:#000}
  .player-info{flex:1;min-width:0}
  .player-name{font-size:12px;font-weight:600;color:var(--gold);margin-bottom:2px}
  .hp{height:6px;background:#0b0b0b;border:1px solid var(--border);border-radius:999px;overflow:hidden;margin-bottom:2px}
  .hp>span{display:block;height:100%;background:linear-gradient(90deg,#4ade80,#22c55e);transition:width .3s}
  .hp-text{font-size:10px;color:var(--muted);margin-bottom:2px}
  .stats{font-size:10px;color:var(--muted)}
  .items-info{font-size:9px;color:var(--text);margin-top:2px}

  .controls .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .input, select{background:var(--glass-2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:8px;font-size:12px}
  .btn{background:transparent;color:var(--gold);border:2px solid var(--gold);padding:8px 12px;border-radius:10px;font-size:12px;cursor:pointer;font-weight:700;transition:.2s}
  .btn:hover{background:var(--gold2);color:#000}
  .btn.warn{border-color:var(--warn);color:var(--warn)}
  .btn.bad{border-color:var(--bad);color:var(--bad)}
  .btn.full{width:100%}

  .logs-section{height:480px;overflow-y:auto;background:var(--glass-2);border:1px solid var(--border);padding:8px;border-radius:8px}
  .log-item{margin-bottom:4px;font-size:11px;line-height:1.4;padding:2px 4px;border-radius:4px}
  .log-time{color:var(--muted);font-weight:normal} /* ← 검은색 안보이는 문제 수정 */
  .log-team-a{background-color:var(--team-a-color);color:var(--text)}
  .log-team-b{background-color:var(--team-b-color);color:var(--text)}
  .log-result{background-color:var(--result-bg);color:var(--result-text)}
  .log-notice{background-color:var(--glass-1);color:var(--gold)}
  .log-error{background-color:#000;color:var(--gold)}
  .log-system{background-color:transparent;color:var(--muted)}

  .links ul{list-style:none;margin-top:8px}
  .links li{margin:4px 0;word-break:break-all}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
</style>
</head>
<body>
<div class="container">
  <div class="header">PYXIS 전투 시스템 — 관리자</div>

  <div class="grid">
    <!-- 좌측: 팀 -->
    <div>
      <div class="team-container" style="margin-bottom:12px">
        <div class="team-title">A팀</div>
        <div id="teamA"></div>
      </div>
      <div class="team-container">
        <div class="team-title">B팀</div>
        <div id="teamB"></div>
      </div>
    </div>

    <!-- 중앙: 컨트롤 + 로그 -->
    <div class="card">
      <div class="title">전투 컨트롤</div>
      <div class="controls">
        <div class="row">
          <select id="modeSel" class="input">
            <option value="2v2">2v2</option>
            <option value="3v3">3v3</option>
            <option value="4v4">4v4</option>
          </select>
          <button id="createBtn" class="btn">전투 생성</button>
          <button id="startBtn" class="btn">전투 시작</button>
          <button id="pauseBtn" class="btn warn">일시정지</button>
          <button id="resumeBtn" class="btn">재개</button>
          <button id="endBtn" class="btn bad">종료</button>
        </div>

        <div class="row">
          <input id="nameInp" class="input" placeholder="이름"/>
          <select id="teamSel" class="input">
            <option value="A">A팀</option>
            <option value="B">B팀</option>
          </select>
          <input id="atkInp" type="number" class="input" placeholder="공(기본1)" min="0"/>
          <input id="defInp" type="number" class="input" placeholder="방(기본1)" min="0"/>
          <input id="agiInp" type="number" class="input" placeholder="민(기본1)" min="0"/>
          <input id="lukInp" type="number" class="input" placeholder="행(기본1)" min="0"/>
          <button id="addBtn" class="btn">참가자 추가</button>
        </div>

        <div class="row">
          <input id="playerIdDel" class="input mono" placeholder="삭제할 플레이어 ID"/>
          <button id="delBtn" class="btn bad">참가자 제거</button>
        </div>

        <div class="row links">
          <button id="linkBtn" class="btn">플레이어/관전자 링크 생성</button>
          <ul id="linkList"></ul>
        </div>
      </div>

      <div class="title" style="margin-top:12px">실시간 로그</div>
      <div id="logPanel" class="logs-section"></div>
    </div>

    <!-- 우측: 현재 턴 -->
    <div class="card">
      <div class="title">현재 턴</div>
      <div id="turnBox" class="mono" style="font-size:12px;line-height:1.5"></div>
    </div>
  </div>
</div>

<script>
(()=> {
  const socket = io();
  let battleId = null;
  let battleState = null;

  const logPanel = document.getElementById('logPanel');
  const linkList = document.getElementById('linkList');
  const turnBox  = document.getElementById('turnBox');

  // 중복 로그 방지: 마지막 N개(100개) 키(ts|msg) 보관
  const recentLogKeys = new Set();
  const maxLogKeep = 100;
  const logKeyQueue = [];

  function esc(s){return s?String(s).replace(/</g,'&lt;').replace(/>/g,'&gt;'):''}

  function getLogClass(message, type){
    if (type === 'result') return 'log-result';
    if (type === 'battle' || type === 'item') {
      if (message.includes('[A]') || message.includes('A팀') || message.includes('=== A팀')) return 'log-team-a';
      if (message.includes('[B]') || message.includes('B팀') || message.includes('=== B팀')) return 'log-team-b';
      if (message.includes('===') || message.includes('라운드 해석') || message.includes('승리') || message.includes('전투가')) return 'log-result';
    }
    if (type === 'notice') return 'log-notice';
    if (type === 'error') return 'log-error';
    return 'log-system';
  }

  function addLog({ts,type,message}){
    if(!message) return;
    const key = ts + '|' + message; // 단순 키
    if (recentLogKeys.has(key)) return; // 중복 차단

    recentLogKeys.add(key);
    logKeyQueue.push(key);
    while (logKeyQueue.length > maxLogKeep) {
      const old = logKeyQueue.shift();
      recentLogKeys.delete(old);
    }

    const time=new Date(ts).toLocaleTimeString('ko-KR',{hour12:false});
    const div=document.createElement('div');
    div.className = `log-item ${getLogClass(message,type)}`;
    div.innerHTML = `<span class="log-time">[${time}]</span> ${esc(message)}`;
    logPanel.appendChild(div);
    logPanel.scrollTop = logPanel.scrollHeight;
  }

  function renderTeams(){
    if(!battleState?.players) return;
    const teamA=battleState.players.filter(p=>p.team==='A');
    const teamB=battleState.players.filter(p=>p.team==='B');

    function renderTeam(players, id){
      let html='';
      players.forEach(p=>{
        const hpPct=Math.max(0, p.hp/(p.maxHp||100)*100);
        const items=[];
        if((p.items?.dittany||p.items?.ditany)>0) items.push(`디터니 ${p.items?.dittany||p.items?.ditany}`);
        if((p.items?.attackBooster||p.items?.attack_boost)>0) items.push(`공격보정 ${p.items?.attackBooster||p.items?.attack_boost}`);
        if((p.items?.defenseBooster||p.items?.defense_boost)>0) items.push(`방어보정 ${p.items?.defenseBooster||p.items?.defense_boost}`);

        html+=`<div class="player-card ${p.hp>0?'':'dead'}">
          <img src="${p.avatar||''}" class="player-avatar" alt="${esc(p.name)}" onerror="this.src='';this.style.background='#000'"/>
          <div class="player-info">
            <div class="player-name">${esc(p.name)}</div>
            <div class="hp"><span style="width:${hpPct}%"></span></div>
            <div class="hp-text">HP ${p.hp}/${p.maxHp||100}</div>
            <div class="stats">공${p.stats?.attack||0} 방${p.stats?.defense||0} 민${p.stats?.agility||0} 행${p.stats?.luck||0}</div>
            <div class="items-info">${items.length?items.join(', '):'아이템 없음'}</div>
          </div>
        </div>`;
      });
      document.getElementById(id).innerHTML = html;
    }

    renderTeam(teamA,'teamA');
    renderTeam(teamB,'teamB');
  }

  function renderTurn(){
    const t=battleState?.currentTurn;
    if(!t){ turnBox.textContent='대기중'; return; }
    const phase = battleState.phase;
    const phaseText =
      phase==='A_select' ? 'A팀 선택 중' :
      phase==='B_select' ? 'B팀 선택 중' :
      phase==='resolve'  ? '라운드 해석 중' :
      phase==='inter'    ? '다음 라운드 대기' : '대기중';
    const timeLeft=t.timeLeftSec||0; const mm=Math.floor(timeLeft/60); const ss=timeLeft%60;
    const line1 = `라운드: ${t.turnNumber}`;
    const line2 = `페이즈: ${phaseText} ${t.currentPlayer?`- ${t.currentPlayer.name} 차례`:''}`;
    const line3 = `남은 시간: ${mm}:${ss.toString().padStart(2,'0')} (${timeLeft}s)`;
    const line4 = `현재팀: ${t.currentTeam||'-'}`;
    turnBox.innerHTML = [line1,line2,line3,line4].join('<br/>');
  }

  function renderAll(){
    renderTeams();
    renderTurn();
  }

  /* ───────────── 컨트롤 핸들러 ───────────── */
  document.getElementById('createBtn').onclick = ()=>{
    const mode = document.getElementById('modeSel').value || '2v2';
    socket.emit('createBattle',{mode},(res)=>{
      if(!res?.ok) return alert('전투 생성 실패');
      battleId = res.battleId;
      alert('전투 생성됨: ' + battleId);
      // 새 방 join
      socket.emit('join',{battleId});
    });
  };

  document.getElementById('startBtn').onclick = ()=>{
    if(!battleId) return alert('전투 ID 없음');
    socket.emit('startBattle',{battleId},(r)=>{ if(!r?.ok) alert('시작 실패'); });
  };
  document.getElementById('pauseBtn').onclick = ()=>{
    if(!battleId) return alert('전투 ID 없음');
    socket.emit('pauseBattle',{battleId},(r)=>{ if(!r?.ok) alert('일시정지 실패'); });
  };
  document.getElementById('resumeBtn').onclick = ()=>{
    if(!battleId) return alert('전투 ID 없음');
    socket.emit('resumeBattle',{battleId},(r)=>{ if(!r?.ok) alert('재개 실패'); });
  };
  document.getElementById('endBtn').onclick = ()=>{
    if(!battleId) return alert('전투 ID 없음');
    if(!confirm('정말 종료할까요?')) return;
    socket.emit('endBattle',{battleId},(r)=>{ if(!r?.ok) alert('종료 실패'); });
  };

  document.getElementById('addBtn').onclick = ()=>{
    if(!battleId) return alert('전투 ID 없음');
    const name = document.getElementById('nameInp').value.trim();
    if(!name) return alert('이름을 입력');
    const team = document.getElementById('teamSel').value;
    const atk = Number(document.getElementById('atkInp').value||1);
    const def = Number(document.getElementById('defInp').value||1);
    const agi = Number(document.getElementById('agiInp').value||1);
    const luk = Number(document.getElementById('lukInp').value||1);

    socket.emit('addPlayer',{
      battleId,
      player:{
        name, team,
        stats:{attack:atk, defense:def, agility:agi, luck:luk}
      }
    },(r)=>{
      if(!r?.ok) return alert('추가 실패');
      document.getElementById('nameInp').value='';
    });
  };

  document.getElementById('delBtn').onclick = ()=>{
    if(!battleId) return alert('전투 ID 없음');
    const pid = document.getElementById('playerIdDel').value.trim();
    if(!pid) return alert('플레이어 ID 입력');
    socket.emit('deletePlayer',{battleId, playerId:pid},(r)=>{
      if(!r?.ok) alert('삭제 실패');
      else document.getElementById('playerIdDel').value='';
    });
  };

  // 링크 생성 (서버가 PUBLIC_BASE_URL 사용해 절대주소 반환)
  document.getElementById('linkBtn').onclick = async ()=>{
    if(!battleId) return alert('전투 ID 없음');
    linkList.innerHTML='';
    try{
      const res = await fetch(`/api/admin/battles/${encodeURIComponent(battleId)}/links`, { method:'POST' });
      const data = await res.json();
      if(!data?.ok) throw new Error(data?.error||'LINK_FAIL');

      const { spectator, players } = data.links || {};
      const f = (u)=> `<li><a class="mono" href="${u}" target="_blank" rel="noopener">${u}</a></li>`;

      let html = '';
      if (spectator?.url) {
        html += `<li><b>관전자:</b></li>${f(spectator.url)}`;
      }
      if (Array.isArray(players)) {
        html += `<li style="margin-top:6px"><b>플레이어:</b></li>`;
        players.forEach(p=>{
          html += `<li>${esc(p.team)}팀 ${esc(p.name)} — ${f(p.url)}</li>`;
        });
      }
      linkList.innerHTML = html;
    }catch(e){
      alert('링크 생성 실패: '+ (e?.message||e));
    }
  };

  /* ───────────── Socket: 방 입장/스냅샷/로그 ───────────── */
  socket.on('connect', ()=>{
    // 새로고침으로 관리자 먼저 열었을 때 최근 배틀이 없어 join 안될 수 있음
  });

  // 방 입장(관리자에서 전투 생성 직후 호출됨)
  socket.on('battle:update', (snap)=>{
    // 하나만 듣는다(중복 제거) — 'battleUpdate'는 미사용
    battleState = snap;
    battleId = battleState.id;
    renderAll();
  });

  // 로그 — 하나만 듣는다(중복 제거)
  socket.on('battle:log', addLog);

  // (참고) 서버에서 'battleUpdate' / 'battleLog'도 뿌리지만, 여기선 미수신

})();
</script>
</body>
</html>
