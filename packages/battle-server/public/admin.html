<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PYXIS - 관리자 콘솔</title>
  <script src="/socket.io/socket.io.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --black:#000000;
      --dark:#0C0C0C;
      --mid:#1A1A1A;
      --glass-1:rgba(255,255,255,0.03);
      --glass-2:rgba(255,255,255,0.06);
      --border:rgba(255,255,255,0.12);
      --border-2:rgba(255,255,255,0.2);
      --gold:#DCC7A2;
      --gold-bright:#E6D2A8;
      --gold-shimmer:#F0E6C8;
      --text:#F8F9FA;
      --muted:#ADB5BD;
      --success:#27AE60;
      --danger:#E74C3C;
      --info:#3498DB;
      --radius:12px;
      --shadow:0 8px 20px rgba(0,0,0,0.35);
      --serif:'Cinzel',serif;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{font-family:var(--serif);background:linear-gradient(135deg,var(--black),var(--dark));color:var(--text);min-height:100vh;overflow-x:hidden}
    /* header */
    .header{position:sticky;top:0;z-index:50;background:var(--glass-2);backdrop-filter:blur(10px);border-bottom:1px solid var(--border-2)}
    .header-inner{max-width:1400px;margin:0 auto;padding:14px 20px;display:flex;justify-content:space-between;align-items:center}
    .logo{font-size:26px;font-weight:800;color:var(--gold-bright);letter-spacing:2px}
    .subtitle{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px}
    .connection-status{display:flex;gap:8px;align-items:center;font-size:12px;color:var(--muted)}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--danger);animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

    /* layout */
    .main{max-width:1400px;margin:0 auto;padding:18px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px}
    @media(max-width:1200px){.main{grid-template-columns:1fr;gap:14px}}

    /* card */
    .card{background:var(--glass-2);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .title{font-weight:800;color:var(--gold-bright);text-align:center;text-transform:uppercase;letter-spacing:1px;border-bottom:1px solid var(--border);padding-bottom:10px;margin-bottom:14px}

    /* fields */
    .field{margin-bottom:12px}
    .label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px;letter-spacing:.5px;text-transform:uppercase}
    .input,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:var(--glass-1);color:var(--text);font-size:14px}
    .input[readonly]{color:#98a2ad}
    .row{display:grid;gap:12px}
    .row.grid-2{grid-template-columns:1fr 140px}
    .row.grid-2b{grid-template-columns:1fr 220px}
    .grid-4{display:grid;gap:10px;grid-template-columns:repeat(4,1fr)}
    .grid-3{display:grid;gap:10px;grid-template-columns:repeat(3,1fr)}

    /* buttons */
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:700;letter-spacing:.6px;text-transform:uppercase}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-gold{background:linear-gradient(135deg,var(--gold),var(--gold-bright));color:#111}
    .btn-green{background:linear-gradient(135deg,#29b765,#219653);color:#fff}
    .btn-red{background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff}
    .btn-blue{background:linear-gradient(135deg,#3498db,#21618c);color:#fff}
    .btn-ghost{background:var(--glass-1);color:var(--text);border:1px solid var(--border)}
    .btn-sm{padding:7px 10px;font-size:12px}

    .btn-group{display:flex;gap:8px;margin-bottom:10px}
    .btn-group .btn{flex:1}

    /* lists */
    .list{background:var(--glass-1);border:1px solid var(--border);border-radius:10px;max-height:220px;overflow:auto}
    .item{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid var(--border);font-size:12px}
    .item:last-child{border-bottom:none}
    .left{display:flex;gap:10px;align-items:center}
    .avatar{width:24px;height:24px;border-radius:6px;object-fit:cover;border:1px solid var(--border);background:#222}
    .name{font-weight:700}
    .sub{font-size:11px;color:var(--muted)}

    /* preview */
    .preview-wrap{display:flex;align-items:center;gap:12px}
    .preview{width:60px;height:60px;border:2px solid var(--border);border-radius:10px;background:#111;display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--muted);background-size:cover;background-position:center}

    /* logs / chat */
    .logbox{height:300px;overflow:auto;background:var(--glass-1);border:1px solid var(--border);border-radius:10px;padding:10px}
    .log{font-size:12px;line-height:1.5;border-bottom:1px solid rgba(255,255,255,.08);padding:5px 0}
    .log:last-child{border-bottom:none}
    .time{font-size:10px;color:var(--muted);margin-right:8px}
    .log.system{color:#9bd0ff}
    .log.success{color:#80e5a0}
    .log.error{color:#ff9b9b}
    .chatbox{height:150px;overflow:auto;background:var(--glass-1);border:1px solid var(--border);border-radius:10px;padding:10px}
    .chat{font-size:12px;margin-bottom:6px}
    .chat .who{font-weight:800;color:var(--gold)}

    /* toast */
    .toast{position:fixed;top:92px;right:20px;z-index:999;background:var(--glass-2);border:1px solid var(--border-2);border-left:4px solid var(--info);padding:12px 14px;border-radius:10px;transform:translateX(420px);transition:transform .25s ease;max-width:320px}
    .toast.show{transform:translateX(0)}
    .toast.success{border-left-color:var(--success)}
    .toast.error{border-left-color:var(--danger)}
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <div>
        <div class="logo">PYXIS</div>
        <div class="subtitle">관리자 콘솔</div>
      </div>
      <div class="connection-status">
        <span id="connText">연결 대기</span><span id="connDot" class="dot"></span>
      </div>
    </div>
  </header>

  <main class="main">
    <!-- 좌: 전투 제어 & 링크 생성 -->
    <section class="card">
      <div class="title">전투 제어</div>

      <div class="field">
        <label class="label" for="battleMode">전투 모드</label>
        <select id="battleMode" class="input">
          <option value="1v1">1 vs 1</option>
          <option value="2v2" selected>2 vs 2</option>
          <option value="3v3">3 vs 3</option>
          <option value="4v4">4 vs 4</option>
        </select>
      </div>

      <div class="btn-group">
        <button id="btnCreate" class="btn btn-gold">전투 생성</button>
        <button id="btnStart" class="btn btn-green" disabled>시작</button>
      </div>
      <div class="btn-group">
        <button id="btnPause" class="btn btn-ghost" disabled>일시정지</button>
        <button id="btnResume" class="btn btn-ghost" disabled>재개</button>
      </div>
      <div class="btn-group">
        <button id="btnEnd" class="btn btn-red" disabled>종료</button>
      </div>

      <div id="battleInfo" style="display:none;margin-top:12px">
        <div class="field">
          <label class="label">전투 ID</label>
          <input id="battleId" class="input" type="text" readonly />
        </div>
        <div class="field">
          <label class="label">상태</label>
          <input id="battleStatus" class="input" type="text" readonly />
        </div>
      </div>

      <!-- ▼ 참가자 링크 생성 (관전자 비번/링크는 제거) -->
      <div style="margin-top:16px">
        <div class="title" style="font-size:14px;margin-bottom:10px">전투 참가자 링크</div>

        <div class="field">
          <button id="btnBuildPlayerLinks" class="btn btn-blue" style="width:100%">참가자 링크 생성/갱신</button>
          <div class="sub" style="margin-top:6px;line-height:1.5">
            현재 전투에 **추가된 전투 참가자들**에 대해 <b>개인 링크(자동 로그인)</b>를 생성합니다.
          </div>
        </div>

        <div class="field">
          <label class="label">생성된 참가자 링크</label>
          <div id="playerLinksList" class="list">
            <div class="item" style="justify-content:center;color:var(--muted)">아직 생성된 링크가 없습니다.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- 중: 전투 참가자 관리 -->
    <section class="card">
      <div class="title">전투 참가자 관리</div>

      <div class="row grid-2">
        <div class="field">
          <label for="playerName" class="label">이름</label>
          <input id="playerName" class="input" type="text" placeholder="전투 참가자 이름" maxlength="20"/>
        </div>
        <div class="field">
          <label for="playerTeam" class="label">팀</label>
          <select id="playerTeam" class="input">
            <option value="A">A팀</option>
            <option value="B">B팀</option>
          </select>
        </div>
      </div>

      <div class="row grid-2b">
        <div class="field">
          <label for="playerHp" class="label">체력 (최대 100)</label>
          <input id="playerHp" class="input" type="number" min="1" max="100" value="100"/>
        </div>
        <div class="field">
          <label class="label">아바타 이미지</label>
          <div class="preview-wrap">
            <div id="avatarPreview" class="preview">미리보기</div>
            <input id="avatarFile" class="input" type="file" accept="image/*"/>
          </div>
        </div>
      </div>

      <div class="field">
        <label class="label">스탯 (각 1~5)</label>
        <div class="grid-4">
          <div class="field">
            <label for="statAttack" class="label">공격</label>
            <input id="statAttack" class="input" type="number" min="1" max="5" value="3"/>
          </div>
          <div class="field">
            <label for="statDefense" class="label">방어</label>
            <input id="statDefense" class="input" type="number" min="1" max="5" value="3"/>
          </div>
          <div class="field">
            <label for="statAgility" class="label">민첩</label>
            <input id="statAgility" class="input" type="number" min="1" max="5" value="3"/>
          </div>
          <div class="field">
            <label for="statLuck" class="label">행운</label>
            <input id="statLuck" class="input" type="number" min="1" max="5" value="2"/>
          </div>
        </div>
      </div>

      <div class="field">
        <label class="label">시작 아이템</label>
        <div class="grid-3">
          <div class="field">
            <label for="itemDittany" class="label">디터니</label>
            <input id="itemDittany" class="input" type="number" min="0" max="99" value="1"/>
          </div>
          <div class="field">
            <label for="itemAtkBoost" class="label">공격 보정기</label>
            <input id="itemAtkBoost" class="input" type="number" min="0" max="99" value="0"/>
          </div>
          <div class="field">
            <label for="itemDefBoost" class="label">방어 보정기</label>
            <input id="itemDefBoost" class="input" type="number" min="0" max="99" value="0"/>
          </div>
        </div>
      </div>

      <button id="btnAddPlayer" class="btn btn-gold" style="width:100%;margin-top:6px">전투 참가자 추가</button>

      <div style="margin-top:16px">
        <div class="field">
          <label class="label">A팀</label>
          <div id="teamAList" class="list">
            <div class="item" style="justify-content:center;color:var(--muted)">아직 추가된 참가자가 없습니다.</div>
          </div>
        </div>
        <div class="field">
          <label class="label">B팀</label>
          <div id="teamBList" class="list">
            <div class="item" style="justify-content:center;color:var(--muted)">아직 추가된 참가자가 없습니다.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- 우: 실시간 로그/채팅 -->
    <section class="card">
      <div class="title">실시간 로그</div>
      <div id="logContainer" class="logbox"></div>

      <div style="margin-top:16px" class="field">
        <label class="label">채팅</label>
        <div id="chatMessages" class="chatbox"></div>
        <div class="btn-group" style="margin-top:8px">
          <input id="chatInput" class="input" type="text" placeholder="관리자 메시지 입력..." maxlength="100"/>
          <button id="btnSendChat" class="btn btn-ghost">전송</button>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <script>
    // ---------- DOM ----------
    const $ = (q)=>document.querySelector(q);
    const connText=$('#connText'); const connDot=$('#connDot');

    const battleMode=$('#battleMode');
    const btnCreate=$('#btnCreate'); const btnStart=$('#btnStart');
    const btnPause=$('#btnPause'); const btnResume=$('#btnResume'); const btnEnd=$('#btnEnd');

    const battleInfo=$('#battleInfo'); const battleIdEl=$('#battleId'); const battleStatusEl=$('#battleStatus');

    const btnBuildPlayerLinks=$('#btnBuildPlayerLinks'); const playerLinksList=$('#playerLinksList');

    const playerName=$('#playerName'); const playerTeam=$('#playerTeam'); const playerHp=$('#playerHp');
    const avatarFile=$('#avatarFile'); const avatarPreview=$('#avatarPreview');
    const statAttack=$('#statAttack'); const statDefense=$('#statDefense'); const statAgility=$('#statAgility'); const statLuck=$('#statLuck');
    const itemDittany=$('#itemDittany'); const itemAtkBoost=$('#itemAtkBoost'); const itemDefBoost=$('#itemDefBoost');
    const btnAddPlayer=$('#btnAddPlayer');

    const teamAList=$('#teamAList'); const teamBList=$('#teamBList');

    const logContainer=$('#logContainer'); const chatMessages=$('#chatMessages');
    const chatInput=$('#chatInput'); const btnSendChat=$('#btnSendChat');

    const toast=$('#toast');

    const escapeHtml=(s)=>String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    // ---------- State ----------
    let socket=null; let currentBattle=null;

    // ---------- UI helpers ----------
    function showToast(msg,type='info'){
      toast.textContent=msg;
      toast.className='toast show '+(type==='success'?'success':type==='error'?'error':'');
      setTimeout(()=>toast.classList.remove('show'),2200);
    }
    function addLog(message,type='system'){
      const row=document.createElement('div'); row.className='log '+type;
      const t=document.createElement('span'); t.className='time';
      t.textContent=new Date().toLocaleTimeString('ko-KR',{hour12:false,hour:'2-digit',minute:'2-digit'});
      const m=document.createElement('span'); m.textContent=message;
      row.appendChild(t); row.appendChild(m); logContainer.appendChild(row);
      logContainer.scrollTop=logContainer.scrollHeight;
      while(logContainer.children.length>300) logContainer.removeChild(logContainer.firstChild);
    }
    function addChat(name,message){
      const el=document.createElement('div'); el.className='chat';
      el.innerHTML=`<span class="who">${escapeHtml(name)}</span>: ${escapeHtml(message)}`;
      chatMessages.appendChild(el); chatMessages.scrollTop=chatMessages.scrollHeight;
      while(chatMessages.children.length>120) chatMessages.removeChild(chatMessages.firstChild);
    }
    async function copyToClipboard(text){
      try{ await navigator.clipboard.writeText(text); showToast('URL이 복사되었습니다.','success'); }
      catch(_){
        const t=document.createElement('textarea'); t.value=text; document.body.appendChild(t); t.select();
        document.execCommand('copy'); document.body.removeChild(t); showToast('URL이 복사되었습니다.','success');
      }
    }

    // ---------- Socket ----------
    function connectSocket(){
      socket = window.io ? window.io({ path: '/socket.io' }) : null;
      if(!socket){ showToast('소켓 초기화 실패','error'); return; }

      socket.on('connect',()=>{
        connText.textContent='연결됨'; connDot.style.background= 'var(--success)';
        addLog('서버에 연결되었습니다.','system');
      });
      socket.on('disconnect',()=>{
        connText.textContent='연결 끊김'; connDot.style.background= 'var(--danger)';
        addLog('서버 연결이 끊어졌습니다.','error');
      });

      // battle snapshot
      socket.on('battleUpdate', onBattleUpdate);
      socket.on('battle:update', onBattleUpdate);

      // 채팅 수신(참가자/관전자 포함)
      socket.on('chatMessage', (d)=> addChat(d.name||'익명', d.message||''));
      socket.on('battle:chat',  (d)=> addChat(d.name||d.senderName||'익명', d.message||''));

      // 로그 브로드캐스트
      socket.on('battleLog', (d)=> addLog(d.message||'로그', d.type||'system'));
      socket.on('battle:log', (d)=> addLog(d.message||'로그', d.type||'system'));
    }

    // ---------- Battle update ----------
    function onBattleUpdate(b){
      if(!b) return;
      currentBattle=b;
      battleStatusEl.value = b.status || 'waiting';
      // 버튼 상태
      const st=b.status;
      btnStart.disabled = st!=='waiting';
      btnPause.disabled = st!=='active';
      btnResume.disabled = st!=='paused';
      btnEnd.disabled   = (st==='waiting');

      renderTeams();
    }

    function renderTeams(){
      if(!currentBattle){ return; }
      const A = (currentBattle.players||[]).filter(p=> (p.team||'A')==='A');
      const B = (currentBattle.players||[]).filter(p=> (p.team||'A')==='B');

      const empty=(msg)=>{ const d=document.createElement('div'); d.className='item'; d.style.justifyContent='center'; d.style.color='var(--muted)'; d.textContent=msg; return d; };

      teamAList.innerHTML=''; teamBList.innerHTML='';
      if(A.length===0) teamAList.appendChild(empty('아직 추가된 참가자가 없습니다.'));
      if(B.length===0) teamBList.appendChild(empty('아직 추가된 참가자가 없습니다.'));

      A.forEach(p=> teamAList.appendChild(playerRow(p)));
      B.forEach(p=> teamBList.appendChild(playerRow(p)));
    }

    function playerRow(p){
      const row=document.createElement('div'); row.className='item';
      row.innerHTML = `
        <div class="left">
          <img class="avatar" src="${escapeHtml(p.avatar||'')}" alt="${escapeHtml(p.name||'전투 참가자')}"/>
          <div>
            <div class="name">${escapeHtml(p.name||'전투 참가자')}</div>
            <div class="sub">HP ${p.hp||100}/100 · 공${p.stats?.attack??3} 방${p.stats?.defense??3} 민${p.stats?.agility??3} 행${p.stats?.luck??2}</div>
          </div>
        </div>
        <div>
          <button class="btn btn-sm btn-red" data-id="${p.id}">삭제</button>
        </div>
      `;
      row.querySelector('button').addEventListener('click', ()=> deletePlayer(p.id));
      return row;
    }

    // ---------- Actions ----------
    function bindEvents(){
      // 전투 생성
      btnCreate.addEventListener('click', ()=>{
        if(!socket) return;
        const mode = battleMode.value;
        socket.emit('createBattle', { mode }, (res)=>{
          if(!res || !res.ok){ showToast('전투 생성 실패','error'); return; }
          currentBattle=res.battle; battleInfo.style.display='block';
          battleIdEl.value = res.battleId; battleStatusEl.value = res.battle.status || 'waiting';
          btnCreate.disabled=true; btnStart.disabled=false;
          addLog(`전투가 생성되었습니다. (ID: ${res.battleId})`,'success');
          // 관리 소켓도 방에 참여
          socket.emit('join',{ battleId: res.battleId });
        });
        addLog(`전투 생성 요청: ${mode}`,'system');
      });

      btnStart.addEventListener('click',()=>{
        if(!socket||!currentBattle) return;
        socket.emit('startBattle',{ battleId: currentBattle.id }, (r)=> {
          if(r?.ok){ addLog('전투 시작','success'); } else { showToast('전투 시작 실패','error');}
        });
      });
      btnPause.addEventListener('click',()=>{
        if(!socket||!currentBattle) return;
        socket.emit('pauseBattle',{ battleId: currentBattle.id }, (r)=>{
          if(r?.ok){ addLog('전투 일시정지','success'); } else { showToast('일시정지 실패','error');}
        });
      });
      btnResume.addEventListener('click',()=>{
        if(!socket||!currentBattle) return;
        socket.emit('resumeBattle',{ battleId: currentBattle.id }, (r)=>{
          if(r?.ok){ addLog('전투 재개','success'); } else { showToast('재개 실패','error');}
        });
      });
      btnEnd.addEventListener('click',()=>{
        if(!socket||!currentBattle) return;
        if(!confirm('정말로 전투를 종료하시겠습니까?')) return;
        socket.emit('endBattle',{ battleId: currentBattle.id }, (r)=>{
          if(r?.ok){ addLog('전투 종료','success'); } else { showToast('전투 종료 실패','error');}
        });
      });

      // 참가자 추가
      btnAddPlayer.addEventListener('click', addPlayer);

      // 링크 생성/갱신
      btnBuildPlayerLinks.addEventListener('click', buildPlayerLinks);

      // 채팅
      btnSendChat.addEventListener('click', sendChat);
      chatInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter') sendChat(); });

      // 아바타 프리뷰
      avatarFile.addEventListener('change',(e)=>{
        const f=e.target.files[0]; if(!f){ avatarPreview.style.backgroundImage=''; avatarPreview.textContent='미리보기'; return; }
        const r=new FileReader(); r.onload=(ev)=>{ avatarPreview.style.backgroundImage=`url(${ev.target.result})`; avatarPreview.textContent=''; }; r.readAsDataURL(f);
      });
    }

    async function addPlayer(){
      const name=playerName.value.trim();
      if(!name){ showToast('참가자 이름을 입력해주세요.','error'); return; }
      if(!currentBattle){ showToast('먼저 전투를 생성해주세요.','error'); return; }

      const payload = {
        name,
        team: playerTeam.value,
        hp: parseInt(playerHp.value)||100,
        maxHp: 100,
        stats: {
          attack: parseInt(statAttack.value)||3,
          defense: parseInt(statDefense.value)||3,
          agility: parseInt(statAgility.value)||3,
          luck: parseInt(statLuck.value)||2
        },
        items: {
          // 서버 쪽 키 호환: ditany/dittany 모두 수용
          dittany: parseInt(itemDittany.value)||0,
          attackBooster: parseInt(itemAtkBoost.value)||0,
          defenseBooster: parseInt(itemDefBoost.value)||0
        }
      };

      // 아바타 업로드(있다면)
      if(avatarFile.files[0]){
        try{
          const fd=new FormData();
          fd.append('avatar', avatarFile.files[0]);
          fd.append('playerId', Date.now().toString());
          const resp=await fetch(`/api/battles/${currentBattle.id}/avatar`,{ method:'POST', body:fd });
          if(resp.ok){
            const r=await resp.json();
            payload.avatar = r.url || r.fileUrl || null;
          }
        }catch(e){ console.warn('아바타 업로드 실패:', e); }
      }

      socket.emit('addPlayer', { battleId: currentBattle.id, player: payload }, (res)=>{
        if(res?.ok){
          addLog(`전투 참가자 추가: ${payload.name} (${payload.team}팀)`,'success');
          // 폼 리셋
          resetPlayerForm();
        }else{
          showToast('전투 참가자 추가 실패','error');
        }
      });
    }

    function resetPlayerForm(){
      playerName.value=''; playerHp.value='100';
      avatarFile.value=''; avatarPreview.style.backgroundImage=''; avatarPreview.textContent='미리보기';
      statAttack.value='3'; statDefense.value='3'; statAgility.value='3'; statLuck.value='2';
      itemDittany.value='1'; itemAtkBoost.value='0'; itemDefBoost.value='0';
    }

    function deletePlayer(playerId){
      if(!socket||!currentBattle) return;
      // 서버는 deletePlayer를 메인으로 받고 removePlayer는 잘못 매핑돼 있으므로 deletePlayer로 직접 보냄
      socket.emit('deletePlayer', { battleId: currentBattle.id, playerId }, (r)=>{
        if(r?.ok){ addLog(`전투 참가자 삭제: ${playerId}`,'success'); }
        else{ showToast('삭제 실패','error'); }
      });
    }

    function sendChat(){
      const msg = chatInput.value.trim(); if(!msg||!socket||!currentBattle) return;
      socket.emit('chatMessage',{ battleId: currentBattle.id, name:'관리자', message: msg });
      chatInput.value=''; addLog(`[채팅] 관리자: ${msg}`,'system');
    }

    async function buildPlayerLinks(){
      if(!currentBattle){ showToast('먼저 전투를 생성해주세요.','error'); return; }
      try{
        const res = await fetch(`/api/admin/battles/${currentBattle.id}/links`, { method:'POST' });
        const data = await res.json();
        if(!data.ok){ showToast('링크 생성 실패','error'); return; }
        const links = Array.isArray(data.playerLinks) ? data.playerLinks : [];
        renderPlayerLinks(links);
        addLog(`참가자 링크 ${links.length}개 생성/갱신 완료`,'success');
      }catch(e){
        console.error(e); showToast('링크 생성 중 오류','error');
      }
    }

    function renderPlayerLinks(links){
      playerLinksList.innerHTML='';
      if(links.length===0){
        const empty=document.createElement('div');
        empty.className='item'; empty.style.justifyContent='center'; empty.style.color='var(--muted)';
        empty.textContent='플레이어가 없거나 아직 추가되지 않았습니다.';
        playerLinksList.appendChild(empty);
        return;
      }
      links.forEach(link=>{
        const row=document.createElement('div'); row.className='item'; row.style.gap='10px';
        row.innerHTML = `
          <div class="left" style="min-width:220px">
            <div>
              <div class="name">${escapeHtml(link.playerName || '전투 참가자')}</div>
              <div class="sub">${link.team}팀 · OTP ${escapeHtml(link.otp||'')}</div>
            </div>
          </div>
          <div class="sub" style="flex:1;word-break:break-all">${escapeHtml(link.url||'')}</div>
          <div><button class="btn btn-sm btn-blue">복사</button></div>
        `;
        row.querySelector('button').addEventListener('click', ()=> copyToClipboard(link.url||''));
        playerLinksList.appendChild(row);
      });
    }

    // ---------- init ----------
    function init(){
      connectSocket();
      bindEvents();
      addLog('PYXIS 관리자 콘솔이 시작되었습니다.','system');
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
