<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Pyxis - 전투 관리자</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="/socket.io/socket.io.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --deep-navy:#0a0f1a;
      --midnight:#121827;
      --navy:#1a202c;

      --glass:#111726cc;            /* rgba + blur 전용 */
      --glass-weak:#111726a6;
      --glass-line:rgba(201,169,110,.14);

      --gold:#c9a96e;
      --gold-weak:#d4b77e;
      --gold-bright:#e0c494;
      --gold-dark:#b8985f;

      --text:#f7f3ea;
      --text-weak:#d5c9b8;
      --muted:#9a8d7a;

      --radius:14px;
      --font-serif:'Playfair Display',serif;
      --font-sans:'Inter',system-ui,-apple-system,Segoe UI,Roboto;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family:var(--font-sans);
      background:radial-gradient(1200px 900px at 10% -10%, rgba(201,169,110,.06), transparent 60%),
                 radial-gradient(1200px 900px at 110% 110%, rgba(201,169,110,.05), transparent 60%),
                 linear-gradient(135deg, var(--deep-navy), var(--midnight) 50%, var(--navy));
    }

    .container{max-width:1200px;margin:auto;padding:20px}

    /* 헤더 */
    .title{
      font-family:var(--font-serif);
      font-weight:700;
      text-align:center;
      font-size:clamp(28px,4.2vw,40px);
      letter-spacing:.04em;
      margin:10px 0 18px;
      background:linear-gradient(135deg,var(--gold),#f2e5c7,var(--gold-bright));
      -webkit-background-clip:text;background-clip:text;
      -webkit-text-fill-color:transparent;
      position:relative;display:block;
    }
    .title::before,.title::after{
      content:'✦';position:absolute;top:-6px;color:var(--gold-weak);font-size:.6em;
      animation:twinkle 2.6s ease-in-out infinite alternate;
    }
    .title::before{left:12%;animation-delay:0s}
    .title::after{right:12%;animation-delay:1.1s}
    @keyframes twinkle{0%,100%{opacity:.5;transform:scale(.85)}50%{opacity:1;transform:scale(1.2)}}

    /* 상단 상태바 */
    .topbar{
      display:grid;grid-template-columns:repeat(4,1fr);gap:12px;
      background:linear-gradient(145deg,rgba(201,169,110,.06),rgba(201,169,110,.10));
      border:1px solid var(--glass-line);backdrop-filter:blur(12px);
      padding:12px;border-radius:var(--radius);margin-bottom:18px;
      box-shadow:0 6px 22px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.05);
    }
    .topcell{font-size:14px;font-weight:600;color:var(--text-weak)}
    .topcell span{color:var(--gold)}

    /* 카드 */
    .card{
      background:var(--glass);
      border:1px solid var(--glass-line);
      border-radius:var(--radius);
      padding:16px; margin-bottom:18px;
      backdrop-filter:blur(14px);
      box-shadow:0 8px 24px rgba(0,0,0,.30), inset 0 1px 0 rgba(255,255,255,.05);
    }
    .card-title{
      font-family:var(--font-serif);
      color:var(--gold-bright);
      font-size:18px;font-weight:600;margin:0 0 12px;
    }

    /* 폼 */
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .form-label{display:block;margin:2px 0 6px;color:var(--gold-weak);font-weight:600;font-size:13px}
    .form-input,.form-select{
      width:100%;padding:12px;border-radius:10px;
      border:1px solid var(--glass-line);background:#0f1421cc;color:var(--text);
      outline:0;transition:border-color .2s ease, box-shadow .2s ease;
      font-size:15px
    }
    .form-input:focus,.form-select:focus{
      border-color:var(--gold); box-shadow:0 0 0 3px rgba(201,169,110,.18);
    }

    /* 버튼 */
    .btn{
      display:inline-block;padding:11px 14px;border-radius:10px;border:1px solid transparent;
      font-weight:700;cursor:pointer;transition:transform .15s ease, box-shadow .2s ease,opacity .2s;
      background:linear-gradient(135deg,var(--gold-dark),var(--gold));color:#0d1017;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(201,169,110,.35)}
    .btn:disabled{opacity:.55;cursor:not-allowed;box-shadow:none}
    .btn-secondary{background:linear-gradient(135deg,#202836,#1b2232);color:var(--text-weak);border-color:var(--glass-line)}
    .btn-danger{background:linear-gradient(135deg,#8d3f3a,#b24e49);color:#fff}
    .btn-warning{background:linear-gradient(135deg,#806a31,#a58a42);color:#111}
    .btn-weak{background:#0f1421;border:1px solid var(--glass-line);color:var(--text)}

    /* 표 / 목록 */
    .scroll{max-height:270px;overflow-y:auto}
    .scroll::-webkit-scrollbar{height:10px;width:10px}
    .scroll::-webkit-scrollbar-thumb{background:rgba(201,169,110,.28);border-radius:6px}

    /* 로그 */
    .log{background:#0f142180;border:1px solid var(--glass-line);border-radius:12px;padding:12px;height:260px;overflow:auto}
    .log-line{font-size:13px;color:var(--text-weak);padding:4px 6px;border-bottom:1px dashed rgba(255,255,255,.05)}
    .log-line .t{color:var(--gold);font-weight:600;margin-right:6px}
    .log-line.admin{background:rgba(201,169,110,.10)}
    .muted{color:var(--muted);font-size:13px}

    /* 팀/플레이어 */
    .teamwrap{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .team{border:1px solid var(--glass-line);border-radius:12px;padding:12px;background:#0f142180}
    .team h4{margin:0 0 8px;font-family:var(--font-serif);color:var(--gold-bright)}
    .p{display:flex;gap:10px;align-items:center;padding:8px;border-radius:10px;border:1px solid var(--glass-line);background:#0e131d}
    .p .hp{height:6px;border:1px solid var(--glass-line);border-radius:4px;overflow:hidden;background:#111}
    .p .hp>i{display:block;height:100%;background:linear-gradient(90deg,var(--gold-dark),var(--gold))}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--glass-line);font-size:12px;color:var(--text-weak)}

    /* 링크 모달 */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center}
    .modal.show{display:flex}
    .modal-card{width:min(580px,92vw);background:var(--glass);border:1px solid var(--glass-line);border-radius:14px;padding:16px}

    /* 반응형 */
    @media (max-width:980px){.topbar{grid-template-columns:1fr 1fr}.grid-3{grid-template-columns:1fr 1fr}.teamwrap{grid-template-columns:1fr}}
    @media (max-width:640px){.topbar{grid-template-columns:1fr}.grid-2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">Pyxis 전투 관리자</h1>

    <!-- 상단 상태바 -->
    <div class="topbar" id="statusBar">
      <div class="topcell">전투 상태: <span id="sStatus">-</span></div>
      <div class="topcell">현재 팀: <span id="sTeam">-</span></div>
      <div class="topcell">라운드/턴: <span id="sRound">-</span></div>
      <div class="topcell">플레이어 수: <span id="sCount">0</span></div>
    </div>

    <!-- 인증 화면 -->
    <section id="authScreen" class="card">
      <h2 class="card-title">관리자 인증</h2>

      <!-- 빠른 전투 생성 -->
      <div class="card" style="background:rgba(201,169,110,.08); border:1px solid var(--glass-line); margin-bottom:12px;">
        <div class="grid grid-2" style="align-items:end">
          <div>
            <label class="form-label" for="battleModeQuick">전투 모드</label>
            <select id="battleModeQuick" class="form-select">
              <option value="1v1">1 vs 1</option>
              <option value="2v2">2 vs 2</option>
              <option value="3v3">3 vs 3</option>
              <option value="4v4">4 vs 4</option>
            </select>
          </div>
          <button id="btnQuickCreate" class="btn">전투 생성</button>
        </div>
        <p class="muted" style="margin-top:6px">생성 후 전투 ID와 관리자 OTP가 자동 입력되고 즉시 인증됩니다.</p>
      </div>

      <div class="grid grid-2" style="margin-bottom:10px">
        <div>
          <label class="form-label" for="battleId">전투 ID</label>
          <input id="battleId" class="form-input" placeholder="전투 ID 입력" />
        </div>
        <div>
          <label class="form-label" for="adminOtp">관리자 OTP</label>
          <input id="adminOtp" class="form-input" placeholder="관리자 OTP 입력" />
        </div>
      </div>
      <div style="display:flex;gap:10px">
        <button id="btnAuth" class="btn" style="flex:1">인증</button>
        <button id="btnFetch" class="btn btn-secondary" style="width:140px">전투 조회</button>
      </div>
      <p class="muted" style="margin-top:8px">URL ?battle=, ?token= 값이 있으면 자동으로 입력됩니다.</p>
    </section>

    <!-- 관리자 패널 -->
    <section id="adminScreen" class="card" style="display:none">
      <h2 class="card-title">전투 제어</h2>
      <div class="grid grid-3" style="margin-bottom:12px">
        <button id="btnStart" class="btn">전투 시작</button>
        <button id="btnEnd"   class="btn btn-danger">전투 종료</button>
        <button id="btnLinks" class="btn btn-secondary">링크 생성</button>
      </div>

      <div class="grid grid-2">
        <div class="card">
          <div class="card-title">전투 정보</div>
          <div id="battleInfo" class="muted">전투 로드 대기</div>
          <div class="teamwrap" style="margin-top:12px">
            <div class="team">
              <h4 id="t1Name">팀 1</h4>
              <div id="t1List" class="grid"></div>
            </div>
            <div class="team">
              <h4 id="t2Name">팀 2</h4>
              <div id="t2List" class="grid"></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">전투 로그</div>
          <div id="logBox" class="log"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="btnClearLog" class="btn btn-weak" style="flex:1">지우기</button>
            <button id="btnReload"   class="btn btn-secondary" style="width:130px">새로고침</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- 링크 모달 -->
  <div id="linkModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="card-title" style="display:flex;justify-content:space-between;align-items:center">
        링크 복사
        <button id="btnCloseModal" class="btn btn-secondary" style="padding:6px 10px">닫기</button>
      </div>
      <div class="grid" style="margin-top:10px">
        <div>
          <label class="form-label">관리자 링크</label>
          <input id="mAdmin" class="form-input" readonly />
        </div>
        <div class="grid grid-2">
          <div>
            <label class="form-label">팀1 링크</label>
            <input id="mTeam1" class="form-input" readonly />
          </div>
          <div>
            <label class="form-label">팀2 링크</label>
            <input id="mTeam2" class="form-input" readonly />
          </div>
        </div>
        <div>
          <label class="form-label">관전자 링크</label>
          <input id="mSpec" class="form-input" readonly />
        </div>
      </div>
      <div style="display:flex;gap:10px;margin-top:12px">
        <button id="btnCopyAll" class="btn" style="flex:1">모두 복사</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      'use strict';
      const $ = (s)=>document.querySelector(s);
      const byId = (id)=>document.getElementById(id);

      // Elements
      const elStatus = { s:$('#sStatus'), t:$('#sTeam'), r:$('#sRound'), c:$('#sCount') };
      const elAuth = $('#authScreen');
      const elAdmin = $('#adminScreen');

      const battleIdInput = $('#battleId');
      const adminOtpInput = $('#adminOtp');
      const btnAuth = $('#btnAuth');
      const btnFetch = $('#btnFetch');

      const qcMode = $('#battleModeQuick');
      const btnQuick = $('#btnQuickCreate');

      const btnStart = $('#btnStart');
      const btnEnd   = $('#btnEnd');
      const btnLinks = $('#btnLinks');
      const btnReload= $('#btnReload');
      const btnClear = $('#btnClearLog');

      const infoBox = $('#battleInfo');
      const t1Name = $('#t1Name'), t2Name = $('#t2Name');
      const t1List = $('#t1List'), t2List = $('#t2List');
      const logBox = $('#logBox');

      const linkModal = $('#linkModal');
      const mAdmin = $('#mAdmin'), mTeam1=$('#mTeam1'), mTeam2=$('#mTeam2'), mSpec=$('#mSpec');
      const btnCopyAll = $('#btnCopyAll'), btnCloseModal = $('#btnCloseModal');

      let socket = null;
      let currentBattleId = null;

      function esc(s=''){return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}

      // ---- UI helpers ----
      function showAdmin(){
        elAuth.style.display='none';
        elAdmin.style.display='block';
      }
      function showAuth(){
        elAdmin.style.display='none';
        elAuth.style.display='block';
      }
      function copy(v){navigator.clipboard?.writeText(v).catch(()=>{});}
      function fillTop(b){
        elStatus.s.textContent = b.status || '-';
        elStatus.t.textContent = b.currentTeam || '-';
        elStatus.r.textContent = (b.roundNumber ?? '-') + ' / ' + (b.turnNumber ?? '-');
        const cnt = (b.teams?.team1?.players?.length || 0) + (b.teams?.team2?.players?.length || 0);
        elStatus.c.textContent = cnt;
      }
      function renderTeams(b){
        const t1=b.teams?.team1||{name:'팀 1',players:[]};
        const t2=b.teams?.team2||{name:'팀 2',players:[]};
        t1Name.textContent = t1.name; t2Name.textContent = t2.name;

        function row(p){
          const pct = Math.max(0, Math.round((p.hp||0)/(p.maxHp||100)*100));
          const div = document.createElement('div'); div.className='p grid';
          div.innerHTML = `
            <div style="min-width:110px"><b>${esc(p.name||'플레이어')}</b> <span class="pill">${p.alive===false?'사망':'생존'}</span></div>
            <div class="hp"><i style="width:${pct}%;"></i></div>
            <div style="min-width:56px;text-align:right;color:var(--muted)">${pct}%</div>
          `;
          return div;
        }
        t1List.innerHTML=''; t2List.innerHTML='';
        (t1.players||[]).forEach(p=>t1List.appendChild(row(p)));
        (t2.players||[]).forEach(p=>t2List.appendChild(row(p)));
      }
      function renderLog(b){
        const lines = (b.battleLog||[]).slice(-300).map(e=>{
          const t = new Date(e.timestamp||Date.now()).toLocaleTimeString();
          return `<div class="log-line ${e.type==='system'?'admin':''}"><span class="t">[${t}]</span>${esc(e.message||'')}</div>`;
        }).join('');
        logBox.innerHTML = lines || '<div class="muted">로그 없음</div>';
        logBox.scrollTop = logBox.scrollHeight;
      }
      function renderInfo(b){
        infoBox.innerHTML = `
          <div>전투 ID: <b>${esc(b.id||'')}</b></div>
          <div>모드: <b>${esc(b.mode||'-')}</b></div>
          <div>상태: <b>${esc(b.status||'-')}</b></div>
          <div>생성: <span class="muted">${b.createdAt?new Date(b.createdAt).toLocaleString():'-'}</span></div>
          ${b.winner?`<div>승자: <b>${esc(b.winner)}</b></div>`:''}
        `;
      }

      function renderBattle(b){
        if(!b) return;
        fillTop(b); renderInfo(b); renderTeams(b); renderLog(b);
      }

      // ---- API ----
      async function apiCreate(mode){
        const r = await fetch('/api/battles',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mode})});
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        return r.json(); // { id,... } 또는 { battle, urls }
      }
      async function apiGet(id){
        const r = await fetch(`/api/battles/${encodeURIComponent(id)}`);
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        return r.json();
      }
      async function apiStart(id){
        const r = await fetch(`/api/admin/battles/${encodeURIComponent(id)}/start`,{method:'POST'});
        if(!r.ok) throw new Error('start failed');
        return r.json();
      }
      async function apiEnd(id){
        const r = await fetch(`/api/admin/battles/${encodeURIComponent(id)}/end`,{method:'POST'});
        if(!r.ok) throw new Error('end failed');
        return r.json();
      }
      async function apiLinks(id){
        const r = await fetch(`/api/admin/battles/${encodeURIComponent(id)}/links`,{method:'POST'});
        if(!r.ok) throw new Error('links failed');
        return r.json();
      }

      // ---- Socket ----
      function ensureSocket(){
        if(socket){ try{ socket.disconnect(); }catch{} }
        socket = io({ path:'/socket.io/', transports:['websocket','polling'] });
        socket.on('connect', ()=>{ /* no-op */ });
        socket.on('authSuccess', (d)=>{ if(d?.battle){ renderBattle(d.battle); } showAdmin(); });
        socket.on('authError', (m)=>{ alert('인증 실패: '+(m||'')); showAuth(); });
        socket.on('battleUpdate', (b)=> renderBattle(b) );
      }

      async function quickCreate(){
        try{
          btnQuick.disabled = true;
          const data = await apiCreate(qcMode.value);
          const b = data.battle || data;
          const id = b.id || data.id;
          const adminOtp = (b.otps && b.otps.admin) || (data.otps && data.otps.admin) || '';
          battleIdInput.value = id || '';
          adminOtpInput.value = adminOtp || '';
          // 자동 인증
          await adminAuth();
        }catch(e){ alert('전투 생성 실패: '+(e?.message||e)); }
        finally{ btnQuick.disabled=false; }
      }

      async function adminAuth(){
        const id = battleIdInput.value.trim();
        const otp = adminOtpInput.value.trim();
        if(!id||!otp){ alert('전투 ID와 OTP를 입력하세요.'); return; }
        ensureSocket();
        currentBattleId = id;
        socket.emit('adminAuth', { battleId:id, otp });
      }

      // ---- Events ----
      btnQuick.addEventListener('click', quickCreate);
      btnAuth.addEventListener('click', adminAuth);

      btnFetch.addEventListener('click', async ()=>{
        try{
          const id = battleIdInput.value.trim();
          if(!id) return alert('전투 ID를 입력하세요.');
          const b = await apiGet(id);
          renderBattle(b);
        }catch(e){ alert('조회 실패: '+(e?.message||e)); }
      });

      btnStart.addEventListener('click', async ()=>{
        if(!currentBattleId) return;
        try{ await apiStart(currentBattleId); }catch(e){ alert('시작 실패'); }
      });
      btnEnd.addEventListener('click', async ()=>{
        if(!currentBattleId) return;
        if(!confirm('전투를 종료하시겠습니까?')) return;
        try{ await apiEnd(currentBattleId); showAuth(); }catch(e){ alert('종료 실패'); }
      });
      btnReload.addEventListener('click', async ()=>{
        if(!currentBattleId) return;
        try{ renderBattle(await apiGet(currentBattleId)); }catch(e){}
      });
      btnClear.addEventListener('click', ()=>{ logBox.innerHTML=''; });

      btnLinks.addEventListener('click', async ()=>{
        if(!currentBattleId) return;
        try{
          const d = await apiLinks(currentBattleId);
          const urls = d.urls || {};
          mAdmin.value = urls.admin || '';
          // 플레이어는 서버 쪽 구현이 단수/복수 혼용 가능
          mTeam1.value = urls.team1 || urls.player || '';
          mTeam2.value = urls.team2 || '';
          mSpec.value  = urls.spectator || '';
          linkModal.classList.add('show');
        }catch(e){ alert('링크 생성 실패'); }
      });

      btnCloseModal.addEventListener('click', ()=> linkModal.classList.remove('show'));
      linkModal.addEventListener('click', (e)=>{ if(e.target===linkModal) linkModal.classList.remove('show'); });
      [mAdmin,mTeam1,mTeam2,mSpec].forEach(inp=> inp.addEventListener('click',()=>copy(inp.value)));
      btnCopyAll.addEventListener('click', ()=>{
        const all = [mAdmin.value,mTeam1.value,mTeam2.value,mSpec.value].filter(Boolean).join('\n');
        if(all) copy(all);
      });

      // 쿼리 자동 입력
      (function bootFromQuery(){
        const p = new URLSearchParams(location.search);
        const b = p.get('battle'), t = p.get('token');
        if(b) battleIdInput.value = b;
        if(t) adminOtpInput.value = t;
        if(b && t) adminAuth();
      })();
    })();
  </script>
</body>
</html>
