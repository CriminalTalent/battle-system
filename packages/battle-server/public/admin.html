<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PYXIS 관리자 콘솔</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --deep-navy:#00080D;
      --glass-1:rgba(15,25,40,.8);
      --glass-2:rgba(20,30,45,.9);
      --gold-1:#DCC7A2;
      --gold-2:#D4BA8D;
      --gold-bright:#F0E6C7;
      --gold-shimmer:#E8DDB5;
      --text:#E5E7EB;
      --text-dim:#D1D5DB;
      --text-muted:#9CA3AF;
      --border-light:rgba(212,183,126,.2);
      --border-subtle:rgba(212,183,126,.1);
      --success:#10B981;
      --danger:#EF4444;
      --warning:#F59E0B;
      --info:#3B82F6;
      --blur-light:blur(12px) saturate(180%);
      --blur-medium:blur(16px) saturate(180%);
      --radius:12px; --radius-sm:8px;
      --shadow-soft:0 4px 20px rgba(0,0,0,.3);
      --shadow-med:0 8px 30px rgba(0,0,0,.4);
      --t: .18s ease-out;
      --serif:'Cinzel',serif; --sans:'Inter',sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:var(--sans);background:linear-gradient(135deg,var(--deep-navy),#000B14 50%,var(--deep-navy));color:var(--text);min-height:100vh}
    .header{position:sticky;top:0;z-index:10;background:var(--glass-2);backdrop-filter:var(--blur-light);border-bottom:1px solid var(--border-light);padding:20px 0}
    .wrap{max-width:1400px;margin:0 auto;padding:0 20px}
    .logo{font-family:var(--serif);font-weight:900;font-size:34px;letter-spacing:.15em;background:linear-gradient(135deg,var(--gold-1),var(--gold-shimmer) 50%,var(--gold-2));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 0 20px rgba(220,199,162,.35)}
    .sub{font-size:13px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px}
    .main{max-width:1400px;margin:0 auto;padding:24px 20px}
    .grid{display:grid;gap:24px;grid-template-columns:1fr 1fr 1fr}
    .card{background:var(--glass-2);backdrop-filter:var(--blur-medium);border:1px solid var(--border-light);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow-soft);transition:transform var(--t),box-shadow var(--t),border-color var(--t)}
    .card:hover{transform:translateY(-2px);box-shadow:var(--shadow-med);border-color:var(--gold-2)}
    .title{font-family:var(--serif);font-weight:600;color:var(--gold-bright);border-bottom:1px solid var(--border-subtle);padding-bottom:10px;margin-bottom:16px}
    .row{display:grid;gap:12px}
    .row-2{grid-template-columns:1fr 1fr}
    .row-3{grid-template-columns:repeat(3,1fr)}
    label{font-size:12px;color:var(--text-dim);font-weight:600;text-transform:uppercase;letter-spacing:.4px;margin-bottom:6px;display:block}
    input,select{width:100%;background:var(--glass-1);border:1px solid var(--border-light);border-radius:var(--radius-sm);padding:10px 12px;color:var(--text);font-size:13px;transition:border var(--t),box-shadow var(--t)}
    input:focus,select:focus{outline:none;border-color:var(--gold-1);box-shadow:0 0 0 2px rgba(212,183,126,.18)}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 16px;border-radius:10px;border:1px solid var(--gold-1);background:linear-gradient(135deg,var(--gold-1),var(--gold-2));color:#091218;font-weight:700;font-size:12px;letter-spacing:.4px;text-transform:uppercase;cursor:pointer;transition:transform var(--t),box-shadow var(--t),filter var(--t)}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(212,183,126,.35)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-alt{background:linear-gradient(135deg,#6B7280,#4B5563);border-color:#6B7280;color:#fff}
    .btn-danger{background:linear-gradient(135deg,var(--danger),#DC2626);border-color:#DC2626;color:#fff}
    .btn-success{background:linear-gradient(135deg,var(--success),#059669);border-color:#059669;color:#fff}
    .btn-group{display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(120px,1fr))}
    .link-out{display:flex;align-items:center;justify-content:space-between;gap:10px;background:var(--glass-1);border:1px solid var(--border-light);border-radius:10px;padding:10px 12px;font-family:monospace;font-size:12px;color:var(--text-dim)}
    .roster{display:grid;gap:14px;grid-template-columns:1fr 1fr}
    .team{background:var(--glass-1);border:1px solid var(--border-subtle);border-radius:10px;padding:14px;min-height:150px}
    .team h4{font-size:13px;color:var(--gold-bright);text-align:center;margin-bottom:10px;border-bottom:1px solid var(--border-subtle);padding-bottom:8px}
    .pitem{display:flex;align-items:center;justify-content:space-between;gap:8px;background:var(--glass-1);border:1px solid var(--border-subtle);border-radius:8px;padding:8px 10px;font-size:12px}
    .pname{font-weight:700}
    .pmeta{font-size:11px;color:var(--text-muted)}
    .logs{height:300px;overflow:auto;background:var(--glass-1);border:1px solid var(--border-light);border-radius:10px;padding:12px;font-size:12px}
    .log{padding:6px 8px;border-left:2px solid transparent;border-radius:6px;margin-bottom:6px}
    .log.system{border-left-color:var(--info);background:rgba(59,130,246,.1)}
    .log.admin{border-left-color:var(--gold-1);background:rgba(212,183,126,.1)}
    .chatbox{height:200px;overflow:auto;background:var(--glass-1);border:1px solid var(--border-light);border-radius:10px;padding:12px;font-size:12px}
    .input-row{display:flex;gap:8px;margin-top:8px}
    .status{display:inline-block;padding:4px 8px;border-radius:12px;font-size:10px;font-weight:700;letter-spacing:.4px;text-transform:uppercase}
    .waiting{background:rgba(245,158,11,.16);color:var(--warning);border:1px solid var(--warning)}
    .active{background:rgba(16,185,129,.16);color:var(--success);border:1px solid var(--success)}
    .ended{background:rgba(107,114,128,.16);color:var(--text-muted);border:1px solid var(--text-muted)}
    @media (max-width:1200px){.grid{grid-template-columns:1fr 1fr}}
    @media (max-width:768px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header class="header">
    <div class="wrap" style="text-align:center">
      <div class="logo">PYXIS</div>
      <div class="sub">전투 시스템 관리자 콘솔</div>
    </div>
  </header>

  <main class="main">
    <!-- 상단 상태 요약 -->
    <div class="card" id="topSummary">
      <div class="row row-3">
        <div>
          <div class="title">전투 상태</div>
          <div id="statusBadge" class="status waiting">대기중</div>
        </div>
        <div>
          <div class="title">전투 ID</div>
          <div id="battleIdText" style="font-weight:700;color:var(--gold-bright)">미생성</div>
        </div>
        <div>
          <div class="title">전투 모드</div>
          <div id="battleModeText" style="font-weight:700">1v1</div>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- 좌측: 전투 제어 -->
      <div class="card">
        <div class="title">전투 제어</div>

        <div class="row">
          <div>
            <label>전투 모드</label>
            <select id="modeSel">
              <option value="1v1">1 vs 1</option>
              <option value="2v2">2 vs 2</option>
              <option value="3v3">3 vs 3</option>
              <option value="4v4">4 vs 4</option>
            </select>
          </div>
          <div class="btn-group">
            <button class="btn" id="btnCreate">전투 생성</button>
          </div>

          <div class="btn-group">
            <button class="btn btn-success" id="btnStart" disabled>시작</button>
            <button class="btn btn-alt" id="btnPause" disabled>정지</button>
            <button class="btn" id="btnResume" disabled>재개</button>
            <button class="btn btn-danger" id="btnEnd" disabled>종료</button>
          </div>
        </div>

        <div class="title" style="margin-top:12px">링크/비밀번호</div>
        <div class="row">
          <div class="btn-group">
            <button class="btn" id="btnGenPlayerLinks" disabled>전투 참가자 링크</button>
            <button class="btn" id="btnGenSpectatorOtp" disabled>관전자 비밀번호</button>
          </div>
          <div id="linkArea"></div>
        </div>
      </div>

      <!-- 중앙: 전투 참가자 관리 -->
      <div class="card">
        <div class="title">전투 참가자 관리</div>
        <div class="row row-2">
          <div>
            <label>이름</label>
            <input id="pName" type="text" placeholder="최대 20글자" maxlength="20"/>
          </div>
          <div>
            <label>팀</label>
            <select id="pTeam">
              <option value="A">A팀</option>
              <option value="B">B팀</option>
            </select>
          </div>
        </div>

        <div class="row row-4">
          <div class="row row-4" style="grid-template-columns:repeat(4,1fr);gap:8px">
            <div>
              <label>공격(1~5)</label>
              <input id="atk" type="number" min="1" max="5" value="1"/>
            </div>
            <div>
              <label>방어(1~5)</label>
              <input id="def" type="number" min="1" max="5" value="1"/>
            </div>
            <div>
              <label>민첩(1~5)</label>
              <input id="agi" type="number" min="1" max="5" value="1"/>
            </div>
            <div>
              <label>행운(1~5)</label>
              <input id="luk" type="number" min="1" max="5" value="1"/>
            </div>
          </div>
        </div>

        <div class="row row-3">
          <div>
            <label>공격 보정기</label>
            <input id="itemAtk" type="number" min="0" max="3" value="0"/>
          </div>
          <div>
            <label>방어 보정기</label>
            <input id="itemDef" type="number" min="0" max="3" value="0"/>
          </div>
          <div>
            <label>디터니</label>
            <input id="itemHeal" type="number" min="0" max="5" value="1"/>
          </div>
        </div>

        <div class="row">
          <div class="btn-group">
            <button class="btn" id="btnAdd" disabled>전투 참가자 추가</button>
          </div>
        </div>

        <div class="roster" style="margin-top:14px">
          <div class="team">
            <h4>A팀</h4>
            <div id="rosterA"></div>
          </div>
          <div class="team">
            <h4>B팀</h4>
            <div id="rosterB"></div>
          </div>
        </div>
      </div>

      <!-- 우측: 로그 & 채팅 -->
      <div class="card">
        <div class="title">실시간 로그</div>
        <div class="logs" id="logs"></div>

        <div class="title" style="margin-top:16px">채팅</div>
        <div class="chatbox" id="chatBox"></div>
        <div class="input-row">
          <input id="chatInput" type="text" placeholder="관리자 메시지 입력..." maxlength="100"/>
          <button class="btn" id="btnSend">전송</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    // 설정
    const API_BASE = location.origin; // 같은 호스트에서 정적 서빙 가정
    const $ = (id)=>document.getElementById(id);

    const state = {
      battleId: null,
      mode: '1v1',
      status: 'waiting',
      playersA: [],
      playersB: []
    };

    // 유틸
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,Number(v||0)));
    const nowTime = ()=>new Date().toLocaleTimeString();

    function setStatus(s){
      state.status = s;
      const el = $('statusBadge');
      el.className = 'status ' + (s==='active'?'active':s==='ended'?'ended':'waiting');
      el.textContent = s==='active'?'진행중':s==='ended'?'종료됨':'대기중';
    }

    function log(type,msg){
      const box = $('logs');
      const div = document.createElement('div');
      div.className = 'log '+ (type||'system');
      div.innerHTML = `<span style="color:var(--text-muted);font-size:10px;margin-right:6px">${nowTime()}</span>${msg}`;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    function chatLine(sender, msg){
      const box = $('chatBox');
      const div = document.createElement('div');
      div.className = 'log admin';
      div.innerHTML = `<span style="color:var(--text-muted);font-size:10px;margin-right:6px">${nowTime()}</span><strong>${sender}:</strong> ${msg}`;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    function refreshButtons(){
      const hasId = !!state.battleId;
      const hasAnyPlayer = (state.playersA.length+state.playersB.length)>0;
      $('btnStart').disabled = !hasId || !hasAnyPlayer || state.status==='active';
      $('btnPause').disabled = state.status!=='active';
      $('btnResume').disabled = state.status!=='paused';
      $('btnEnd').disabled = !hasId || state.status==='ended';
      $('btnAdd').disabled = !hasId || state.status==='active';
      $('btnGenPlayerLinks').disabled = !hasId || !hasAnyPlayer;
      $('btnGenSpectatorOtp').disabled = !hasId;
    }

    function renderRosters(){
      const a = $('rosterA'); const b = $('rosterB');
      const render = (list, root)=>{
        root.innerHTML = '';
        if(list.length===0){
          root.innerHTML = `<div style="text-align:center;color:var(--text-muted);font-size:12px;padding:10px 0">전투 참가자가 없습니다</div>`;
          return;
        }
        list.forEach(p=>{
          const div = document.createElement('div');
          const stat = p.stats||{};
          const items = p.items||{};
          div.className='pitem';
          div.innerHTML = `
            <div>
              <div class="pname">${p.name}</div>
              <div class="pmeta">ATK:${stat.attack} DEF:${stat.defense} AGI:${stat.agility} LUK:${stat.luck} | HP:${p.hp}</div>
            </div>
            <button class="btn btn-danger" style="padding:6px 10px;font-size:11px" data-id="${p.id}">삭제</button>
          `;
          div.querySelector('button').onclick = ()=>removePlayer(p.id);
          root.appendChild(div);
        });
      };
      render(state.playersA,a);
      render(state.playersB,b);
    }

    async function fetchBattle(){
      if(!state.battleId) return;
      const r = await fetch(`${API_BASE}/api/battles/${state.battleId}`);
      if(!r.ok){ log('system','전투 조회 실패'); return; }
      const {battle} = await r.json();
      setStatus(battle.status);
      $('battleIdText').textContent = battle.id;
      $('battleModeText').textContent = battle.mode;

      const A=[]; const B=[];
      (battle.players||[]).forEach(p=>{
        (p.team==='A'?A:B).push(p);
      });
      state.playersA = A; state.playersB = B;
      renderRosters();
      refreshButtons();
    }

    // 이벤트 바인딩
    window.addEventListener('DOMContentLoaded', ()=>{
      // 모드 선택
      $('modeSel').addEventListener('change', e=>{
        state.mode = e.target.value;
        $('battleModeText').textContent = state.mode;
      });

      // 전투 생성
      $('btnCreate').addEventListener('click', async ()=>{
        try{
          const r = await fetch(`${API_BASE}/api/battles`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ mode: state.mode })
          });
          const js = await r.json();
          if(!js.ok) throw new Error(js.error||'생성 실패');
          state.battleId = js.id;
          setStatus('waiting');
          $('battleIdText').textContent = js.id;
          $('battleModeText').textContent = state.mode;
          state.playersA = []; state.playersB = [];
          renderRosters();
          log('admin', `${state.mode} 전투가 생성되었습니다. (ID: ${state.battleId})`);
          refreshButtons();
        }catch(err){
          log('system', `전투 생성 오류: ${err.message}`);
        }
      });

      // 전투 시작
      $('btnStart').addEventListener('click', async ()=>{
        if(!state.battleId) return;
        try{
          const r = await fetch(`${API_BASE}/api/battles/${state.battleId}/start`,{method:'POST'});
          const js = await r.json();
          if(!js.ok) throw new Error(js.error||'시작 실패');
          setStatus('active');
          log('admin','전투가 시작되었습니다.');
          refreshButtons();
          await fetchBattle();
        }catch(err){
          log('system', `전투 시작 오류: ${err.message}`);
        }
      });

      // 일시정지/재개/종료(서버에 전용 API가 없으면 상태만 표시)
      $('btnPause').addEventListener('click', ()=>{
        setStatus('paused'); log('admin','전투가 일시정지되었습니다.'); refreshButtons();
      });
      $('btnResume').addEventListener('click', ()=>{
        setStatus('active'); log('admin','전투가 재개되었습니다.'); refreshButtons();
      });
      $('btnEnd').addEventListener('click', ()=>{
        setStatus('ended'); log('admin','전투가 종료되었습니다.'); refreshButtons();
      });

      // 전투 참가자 추가
      $('btnAdd').addEventListener('click', addPlayerHandler);

      // 링크 생성: 참가자
      $('btnGenPlayerLinks').addEventListener('click', ()=>{
        if(!state.battleId) return;
        const links=[];
        const build = (p)=> {
          const otp = genOTP();
          const url = `${location.origin}/player?battleId=${state.battleId}&otp=${otp}&playerId=${encodeURIComponent(p.id)}`;
          links.push({who:`${p.name} (${p.team}팀)`, url, otp});
        };
        [...state.playersA,...state.playersB].forEach(build);
        renderLinks('전투 참가자 링크', links);
        log('admin', `전투 참가자 링크가 생성되었습니다. (${links.length}개)`);
      });

      // 관전자 비밀번호
      $('btnGenSpectatorOtp').addEventListener('click', ()=>{
        if(!state.battleId) return;
        const otp = genOTP();
        const url = `${location.origin}/spectator?battleId=${state.battleId}&otp=${otp}`;
        renderLinks('관전자 비밀번호', [{who:'관전자', url, otp, note:'30분 유효(최대 30명)'}]);
        log('admin','관전자 비밀번호가 생성되었습니다.');
      });

      // 채팅
      $('btnSend').addEventListener('click', sendChat);
      $('chatInput').addEventListener('keydown', (e)=>{
        if(e.key==='Enter'){ e.preventDefault(); sendChat(); }
      });

      // 입력 범위 강제
      ['atk','def','agi','luk'].forEach(id=>{
        $(id).addEventListener('input',e=>{
          e.target.value = clamp(e.target.value,1,5);
        });
      });

      refreshButtons();
      log('system','관리자 콘솔이 시작되었습니다.');
    });

    async function addPlayerHandler(){
      if(!state.battleId){ log('system','전투가 없습니다. 전투를 먼저 생성하세요.'); return; }
      const name = $('pName').value.trim();
      const team = $('pTeam').value;
      const stats = {
        attack: clamp($('atk').value,1,5),
        defense: clamp($('def').value,1,5),
        agility: clamp($('agi').value,1,5),
        luck:   clamp($('luk').value,1,5),
      };
      const items = {
        attackBoost: clamp($('itemAtk').value,0,99),
        defenseBoost: clamp($('itemDef').value,0,99),
        healPotion: clamp($('itemHeal').value,0,99),
      };

      if(!name){ log('system','이름을 입력하세요.'); return; }

      try{
        const r = await fetch(`${API_BASE}/api/battles/${state.battleId}/players`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            name, team, hp:100,
            stats, items
          })
        });
        const js = await r.json();
        if(!js.ok) throw new Error(js.error||'추가 실패');

        const p = js.player;
        if(p.team==='A') state.playersA.push(p); else state.playersB.push(p);
        renderRosters();
        refreshButtons();
        log('admin', `${p.name} 이(가) ${p.team}팀에 추가되었습니다.`);
        $('pName').value='';
      }catch(err){
        log('system', `전투 참가자 추가 오류: ${err.message}`);
      }
    }

    async function removePlayer(pid){
      // 서버에 삭제 API가 없다면 클라 반영만 하지 않습니다.
      log('system','삭제 API가 아직 없습니다. 서버 지원 전까지는 수동 제거 불가.');
    }

    function renderLinks(title, list){
      const area = $('linkArea');
      const wrap = document.createElement('div');
      wrap.style.marginTop = '8px';
      wrap.innerHTML = `<div style="font-weight:700;color:var(--gold-bright);margin:6px 0">${title}</div>`;
      list.forEach(x=>{
        const line = document.createElement('div');
        line.className='link-out';
        line.innerHTML = `
          <div style="flex:1;word-break:break-all">
            <div style="font-weight:700">${x.who}</div>
            ${x.note?`<div style="font-size:11px;color:var(--text-muted)">${x.note}</div>`:''}
            <div style="margin-top:6px"><span style="color:var(--text-dim)">비밀번호:</span> <strong>${x.otp}</strong></div>
            <div style="margin-top:4px">${x.url}</div>
          </div>
          <button class="btn" style="padding:6px 10px;font-size:11px">복사</button>
        `;
        line.querySelector('button').onclick = ()=>copy(x.url);
        wrap.appendChild(line);
      });
      area.prepend(wrap);
    }

    function copy(text){
      navigator.clipboard.writeText(text).then(()=>{
        log('system','클립보드에 복사되었습니다.');
      }).catch(()=>{
        log('system','복사 실패');
      });
    }

    function genOTP(){
      // 관전자 비밀번호(간단 난수)
      return Math.random().toString(36).slice(2,8).toUpperCase();
    }

    function sendChat(){
      const v = $('chatInput').value.trim();
      if(!v) return;
      chatLine('관리자', v);
      $('chatInput').value='';
      // 서버 소켓 연동 전까지는 로컬 표시만
    }

    // 전투 상태 주기 동기화(선택)
    setInterval(()=>{ if(state.battleId) fetchBattle(); }, 5000);
  </script>
</body>
</html>
