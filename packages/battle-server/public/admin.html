<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PYXIS - 전투 관리자</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --deep-navy:#000813;
      --gold:#DCC7A2; --gold2:#D4BA8D;
      --glass-1:rgba(0,8,19,.70); --glass-2:rgba(0,8,19,.50);
      --border:rgba(220,199,162,.30);
      --text:#fff; --muted:rgba(255,255,255,.72);
      --radius:8px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Cinzel',serif;background:linear-gradient(135deg,#000813 0%,#001122 100%);color:var(--text);min-height:100vh}
    .header{padding:18px 0;text-align:center;background:var(--glass-1);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    .title{color:var(--gold);font-size:2.2rem;letter-spacing:.14em;text-shadow:0 0 20px rgba(220,199,162,.5)}
    .wrap{max-width:1400px;margin:0 auto;padding:20px}
    .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:24px;align-items:start}
    .card{background:var(--glass-1);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:var(--radius);padding:18px}
    h2{color:var(--gold);font-size:1.08rem;margin:0 0 12px 0}
    h3{color:var(--gold);font-size:.98rem;margin:0 0 10px 0}
    .field{margin:10px 0}
    .field label{display:block;color:var(--gold);font-weight:600;margin-bottom:6px;font-size:.9rem}
    .field input,.field select{width:100%;padding:9px 12px;background:#000914;color:#fff;border:1px solid var(--border);border-radius:6px}
    .field input:focus,.field select:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 2px rgba(220,199,162,.20)}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .btn{cursor:pointer;border:none;border-radius:8px;padding:10px 12px;font-weight:700}
    .btn.block{width:100%}
    .btn{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#111}
    .btn.ghost{background:#0a0f16;color:var(--gold);border:1px solid var(--gold)}
    .btn.danger{background:#2a0a0a;color:#f6d2d2;border:1px solid #7a3a3a}
    .hint{font-size:.82rem;color:var(--muted);margin-top:6px}
    .avatar-preview{width:70px;height:70px;border-radius:50%;border:2px solid var(--gold);margin-top:8px;object-fit:cover}
    .team-wrap{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .team h4{color:var(--gold);margin-bottom:6px}
    .player-card{background:var(--glass-2);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:8px}
    .row{display:flex;align-items:center;gap:10px}
    .row.between{justify-content:space-between}
    .player-card img{width:40px;height:40px;border-radius:50%;border:2px solid var(--gold);object-fit:cover}
    .hp{height:8px;background:#05101e;border:1px solid var(--border);border-radius:9px;margin:4px 0;position:relative}
    .hp .fill{height:100%;background:linear-gradient(90deg,#4ade80,#22c55e);border-radius:8px}
    .hp .text{position:absolute;left:6px;top:-16px;font-size:.72rem;color:var(--muted)}
    .stats{font-size:.74rem;color:var(--muted);font-family:'JetBrains Mono',monospace}
    .logs{height:360px;overflow:auto;background:rgba(0,0,0,.35);border:1px solid var(--border);border-radius:8px;padding:10px}
    .log{font-size:.86rem;margin-bottom:6px}
    .log.rule{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#111;padding:6px;border-radius:6px}
    @media(max-width:1200px){.grid{grid-template-columns:1fr 1fr}}
    @media(max-width:768px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="header"><div class="title">PYXIS</div></div>

  <div class="wrap">
    <div class="grid">
      <!-- 전투 제어 -->
      <section>
        <h2>전투 제어</h2>
        <div class="card">
          <div class="field">
            <label>전투 모드</label>
            <select id="battleMode">
              <option value="1v1">1v1</option>
              <option value="2v2" selected>2v2</option>
              <option value="3v3">3v3</option>
              <option value="4v4">4v4</option>
            </select>
          </div>
          <button id="btnCreate" class="btn block">전투 생성</button>
          <div class="hint">전투 생성 후 URL 파라미터가 자동으로 추가됩니다.</div>
        </div>

        <div class="card">
          <div class="field">
            <label>전투 ID</label>
            <input id="currentBattleId" type="text" readonly placeholder="전투 생성 후 표시">
          </div>
          <div class="grid-4">
            <button id="btnStart"  class="btn">시작</button>
            <button id="btnPause"  class="btn ghost">일시정지</button>
            <button id="btnResume" class="btn ghost">재개</button>
            <button id="btnEnd"    class="btn danger">종료</button>
          </div>
        </div>

        <div class="card">
          <h3>링크 / 비밀번호</h3>
          <button id="btnGenLinks" class="btn block">참가자 링크 / 관전자 비번 생성</button>
          <div class="field">
            <label>관전자 비밀번호</label>
            <input id="spectatorOtp" type="text" readonly>
          </div>
          <div class="field">
            <label>관전자 URL</label>
            <input id="spectatorUrl" type="text" readonly>
          </div>
          <div class="hint">참가자 개별 링크(이름/팀/OTP 포함)는 아래 목록에 표시됩니다.</div>
          <div id="playerLinks" class="field"></div>
        </div>
      </section>

      <!-- 전투 참가자 관리 -->
      <section>
        <h2>전투 참가자 관리</h2>
        <div class="card">
          <div class="grid-2">
            <div class="field">
              <label>이름</label>
              <input id="playerName" type="text" placeholder="전투 참가자 이름">
            </div>
            <div class="field">
              <label>팀</label>
              <select id="playerTeam">
                <option value="A">A</option>
                <option value="B" selected>B</option>
              </select>
            </div>
          </div>

          <div class="grid-2">
            <div class="field">
              <label>HP</label>
              <input id="playerHp" type="number" value="100" min="1" max="100">
            </div>
            <div class="field">
              <label>이미지 업로드</label>
              <input id="avatarFile" type="file" accept="image/*">
              <img id="avatarPreview" class="avatar-preview" alt="미리보기">
              <div class="hint">업로드 성공 시 `/uploads/avatars/...` URL이 내려옵니다.</div>
            </div>
          </div>

          <div class="grid-4">
            <div class="field"><label>공격</label><input id="playerAttack"  type="number" value="1" min="1" max="5"></div>
            <div class="field"><label>방어</label><input id="playerDefense" type="number" value="1" min="1" max="5"></div>
            <div class="field"><label>민첩</label><input id="playerAgility" type="number" value="1" min="1" max="5"></div>
            <div class="field"><label>행운</label><input id="playerLuck"    type="number" value="1" min="1" max="5"></div>
          </div>

          <div class="grid-3">
            <div class="field"><label>디터니</label><input id="playerDittany"        type="number" value="0" min="0" max="9"></div>
            <div class="field"><label>공격 보정기</label><input id="playerAttackBooster"  type="number" value="0" min="0" max="9"></div>
            <div class="field"><label>방어 보정기</label><input id="playerDefenseBooster" type="number" value="0" min="0" max="9"></div>
          </div>

          <button id="btnAddPlayer" class="btn block">전투 참가자 추가</button>
        </div>

        <div class="card">
          <h3>팀 목록</h3>
          <div class="team-wrap">
            <div class="team">
              <h4>A</h4>
              <div id="teamA"></div>
            </div>
            <div class="team">
              <h4>B</h4>
              <div id="teamB"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- 로그/채팅 -->
      <section>
        <h2>실시간 로그</h2>
        <div class="card"><div id="logs" class="logs"></div></div>
        <h2>채팅</h2>
        <div class="card">
          <div class="field row">
            <input id="chatMsg" type="text" placeholder="메시지 입력(관리자)">
            <button id="btnSend" class="btn">전송</button>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
  (function(){
    // ===== 소켓/상태 =====
    const socket = io({ path: "/socket.io" });
    let battleId = new URL(location.href).searchParams.get("battle") || "";

    // ===== 유틸 =====
    const $ = (id)=>document.getElementById(id);
    const esc = (s)=>String(s??"").replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    const logBox = $("logs");
    const addLog = (msg, cls="")=>{
      const d=document.createElement("div");
      d.className = "log " + cls;
      d.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logBox.appendChild(d); logBox.scrollTop=logBox.scrollHeight;
    };

    const setBattleId = (id)=>{
      battleId=id; $("currentBattleId").value=id;
      const url=new URL(location.href); url.searchParams.set("battle", id); history.replaceState(null,"",url.toString());
      socket.emit("join",{ battleId:id }); addLog(`전투 방 참여: ${id}`);
    };

    // ===== 팀 목록 렌더 =====
    function renderTeams(players=[]){
      const A=$("teamA"), B=$("teamB"); A.innerHTML=""; B.innerHTML="";
      players.forEach(p=>{
        const hpPct = Math.max(0, Math.min(100, Math.round((p.hp||0)/(p.maxHp||100)*100)));
        const card = document.createElement("div");
        card.className="player-card";
        card.innerHTML = `
          <div class="row between">
            <div class="row">
              <img src="${esc(p.avatar||"/uploads/avatars/default.svg")}" onerror="this.src='/uploads/avatars/default.svg'">
              <div>
                <div style="color:var(--gold);font-weight:700">${esc(p.name||"")}</div>
                <div class="hp"><div class="fill" style="width:${hpPct}%"></div><div class="text">${p.hp||0}/${p.maxHp||100}</div></div>
                <div class="stats">공:${p.stats?.attack||1} 방:${p.stats?.defense||1} 민:${p.stats?.agility||1} 행:${p.stats?.luck||1}</div>
              </div>
            </div>
            <button class="btn ghost" data-del="${esc(p.id)}">삭제</button>
          </div>`;
        (p.team==="A"?A:B).appendChild(card);
      });
    }

    // ===== 소켓 수신 =====
    socket.on("battleUpdate",(snap)=>{ renderTeams(snap?.players||[]); });
    const onBattleLog = (e)=>{
      const type = e?.type||"info"; const msg=e?.message||"";
      if(!msg) return;
      addLog(msg, type==="battle" ? "rule": "");
    };
    socket.on("battle:log", onBattleLog);
    socket.on("battleLog",  onBattleLog);

    const onChat = (p)=>{
      const msg=p?.message||p?.text||""; const name=p?.name||"익명";
      if(!msg) return; addLog(`[${name}] ${msg}`);
    };
    socket.on("chatMessage", onChat);
    socket.on("battle:chat", onChat);

    // ===== 전투 제어 =====
    $("btnCreate").onclick = async ()=>{
      try{
        const mode = $("battleMode").value;
        const r = await fetch("/api/battles",{method:"POST",headers:{ "Content-Type":"application/json"},body:JSON.stringify({mode})});
        const j = await r.json(); const id = j?.battleId || j?.id || j?.battle?.id;
        if(id){ setBattleId(id); addLog(`전투 생성 완료: ${id}`); } else { addLog("전투 생성 실패","error"); }
      }catch(err){ console.error(err); addLog("전투 생성 실패","error"); }
    };
    $("btnStart").onclick  = ()=> battleId && socket.emit("startBattle",  { battleId }, r=>addLog(r?.ok?"전투 시작":"전투 시작 실패"));
    $("btnPause").onclick  = ()=> battleId && socket.emit("pauseBattle",  { battleId }, r=>addLog(r?.ok?"일시정지":"일시정지 실패"));
    $("btnResume").onclick = ()=> battleId && socket.emit("resumeBattle", { battleId }, r=>addLog(r?.ok?"재개":"재개 실패"));
    $("btnEnd").onclick    = ()=> battleId && socket.emit("endBattle",    { battleId }, r=>addLog(r?.ok?"전투 종료":"전투 종료 실패"));

    // ===== 링크/비번 생성 =====
    const pick = (o,...keys)=>{ for(const k of keys){ const v=k.split(".").reduce((a,c)=>a?.[c],o); if(v!=null) return v; } };
    const unifyPlayers = (d)=>{
      if(Array.isArray(d?.players)) return d.players;
      if(Array.isArray(d?.playerLinks)) return d.playerLinks.map(pl=>({ playerId:pl.playerId||pl.id, name:pl.playerName||pl.name, team:pl.team, token:pl.otp||pl.token, url:pl.url }));
      return [];
    };
    const postJson = async (url)=>{ const r=await fetch(url,{method:"POST",headers:{ "Content-Type":"application/json"},body:"{}"}); if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); };

    async function genLinks(){
      const id = battleId || new URL(location.href).searchParams.get("battle") || "";
      if(!id){ addLog("전투 ID가 없습니다(?battle=...)", "error"); return; }
      let j;
      try{ j = await postJson(`/api/admin/battles/${id}/links`); }
      catch{ j = await postJson(`/api/battles/${id}/links`); }
      const otp = pick(j,"spectator.otp","spectatorOtp","otp") || "";
      let  url = pick(j,"spectator.url","spectatorUrl","url") || "";
      if(!url && otp) url = `${location.origin}/spectator?battle=${encodeURIComponent(id)}&otp=${encodeURIComponent(otp)}`;

      $("spectatorOtp").value = otp; $("spectatorUrl").value = url;

      const list = unifyPlayers(j); const base = location.origin; const box = $("playerLinks"); box.innerHTML="";
      list.forEach(p=>{
        const link = p.url || `${base}/player?battle=${encodeURIComponent(id)}&playerId=${encodeURIComponent(p.playerId||"")}&name=${encodeURIComponent(p.name||"")}&team=${encodeURIComponent(p.team||"")}&token=${encodeURIComponent(p.token||"")}`;
        const row = document.createElement("div");
        row.className="field";
        row.innerHTML = `
          <div class="row between" style="gap:8px">
            <div><strong>${esc(p.name||"")}</strong> <span style="background:var(--gold);color:#000;padding:2px 8px;border-radius:99px;font-size:.78rem">${esc(p.team||"")}</span></div>
            <button class="btn ghost" data-copy="${esc(link)}">URL복사</button>
          </div>
          <input type="text" readonly value="${esc(link)}">`;
        box.appendChild(row);
      });

      addLog("링크/비밀번호 생성 완료");
      if(otp) addLog("관전자 비밀번호: "+otp);
      if(url) addLog("관전자 URL: "+url);
    }
    $("btnGenLinks").onclick = (e)=>{ e.stopImmediatePropagation?.(); genLinks(); };

    // ===== 참가자 추가 =====
    $("avatarFile").addEventListener("change",(e)=>{
      const f=e.target.files?.[0]; const img=$("avatarPreview");
      if(!f){ img.src=""; return; }
      const reader=new FileReader(); reader.onload=(ev)=> img.src = ev.target.result; reader.readAsDataURL(f);
    });

    $("btnAddPlayer").onclick = async ()=>{
      if(!battleId){ addLog("전투 ID가 없습니다","error"); return; }
      const name = $("playerName").value.trim();
      if(!name){ addLog("이름을 입력해주세요","error"); return; }

      // 아바타 업로드
      let avatar=null;
      const file = $("avatarFile").files?.[0];
      if(file){
        try{
          const fd=new FormData(); fd.append("avatar", file);
          const r=await fetch("/api/upload/avatar",{ method:"POST", body:fd });
          const j=await r.json(); if(j?.ok && j?.url) avatar=j.url;
        }catch(_){}
      }

      const core = {
        name,
        team: ($("playerTeam").value||"").trim()==="A" ? "A":"B",
        hp: Number($("playerHp").value||100),
        avatar,
        stats:{
          attack:  Number($("playerAttack").value||1),
          defense: Number($("playerDefense").value||1),
          agility: Number($("playerAgility").value||1),
          luck:    Number($("playerLuck").value||1),
        },
        items:{
          dittany:        Number($("playerDittany").value||0),
          attackBooster:  Number($("playerAttackBooster").value||0),
          defenseBooster: Number($("playerDefenseBooster").value||0),
        }
      };

      // ★★ 구/신 서버 동시 호환: 한 번의 emit에 두 형태 모두 포함 ★★
      socket.emit("addPlayer",
        { battleId, player: core, ...core },
        (res)=>{
          addLog(res?.ok ? "참가자 추가 완료" : "참가자 추가 실패");
          if(res?.ok){ $("playerName").value=""; $("avatarFile").value=""; $("avatarPreview").src=""; }
        }
      );
    };

    // 삭제(위임)
    document.addEventListener("click",(e)=>{
      const del=e.target.closest("[data-del]"); if(!del || !battleId) return;
      socket.emit("deletePlayer",{ battleId, playerId: del.getAttribute("data-del") }, (r)=> addLog(r?.ok?"삭제 완료":"삭제 실패"));
    });

    // 복사(위임)
    document.addEventListener("click",(e)=>{
      const btn=e.target.closest("[data-copy]"); if(!btn) return;
      navigator.clipboard?.writeText(btn.getAttribute("data-copy")).then(()=> addLog("복사 완료"));
    });

    // 채팅
    const sendChat=()=>{ const v=$("chatMsg").value.trim(); if(!v||!battleId) return; socket.emit("chatMessage",{ battleId, name:"관리자", message:v }); $("chatMsg").value=""; };
    $("btnSend").onclick=sendChat; $("chatMsg").addEventListener("keydown",(e)=>{ if(e.key==="Enter") sendChat(); });

    // 초기 진입
    if(battleId) setBattleId(battleId);
    addLog("관리자 페이지 시작");
  })();
  </script>
</body>
</html>
