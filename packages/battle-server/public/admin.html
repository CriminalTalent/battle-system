<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>PYXIS - 전투 관리자</title>
<script src="/socket.io/socket.io.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#0e0e0e; --bg2:#141414;
    --glass-1:rgba(0,0,0,.7); --glass-2:rgba(0,0,0,.5);
    --border:rgba(220,199,162,.3);
    --text:#F8F9FA; --muted:#A9AFB6;
    --gold:#DCC7A2; --gold2:#E6D2A8;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --shadow:0 10px 30px rgba(0,0,0,.45);
    --team-a-color:#8b5757; --team-b-color:#5d6b8d;
    --result-bg:#DCC7A2; --result-text:#000;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:linear-gradient(135deg,#000813,#001122);color:var(--text);font-family:system-ui,-apple-system,sans-serif;min-height:100vh;padding:8px}
  .container{max-width:1400px;margin:0 auto}
  .header{text-align:center;padding:16px;font-family:Cinzel,serif;color:var(--gold);font-size:24px;letter-spacing:.1em}
  .main-grid{display:grid;gap:12px;grid-template-columns:1fr;}
  @media (min-width:768px){ .main-grid{ grid-template-columns:1fr 2fr 1fr; } }
  .card{background:var(--glass-1);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:var(--shadow)}
  .title{font-family:Cinzel,serif;color:var(--gold);font-weight:700;letter-spacing:.08em;margin-bottom:8px;font-size:14px}

  .control-section{background:var(--glass-2);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:12px}
  .control-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:12px}
  .control-grid.single{grid-template-columns:1fr}
  .control-btn{background:var(--glass-1);color:var(--text);border:1px solid var(--border);padding:8px 12px;border-radius:6px;font-size:12px;cursor:pointer;transition:all .2s;font-weight:600}
  .control-btn:hover:not(:disabled){background:var(--gold2);color:#000}
  .control-btn:disabled{opacity:.4;cursor:not-allowed}
  .control-btn.primary{background:var(--gold);color:#000}
  .control-btn.primary:hover:not(:disabled){background:var(--gold2)}
  .control-btn.danger{background:var(--bad);color:#fff}
  .control-btn.danger:hover:not(:disabled){background:#dc2626}
  #btnCreate{background:#000 !important;border:1px solid var(--gold) !important;color:var(--gold) !important}
  #btnCreate:hover{background:var(--gold2) !important;color:#000 !important}

  .player-form{background:var(--glass-2);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:12px}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
  .form-field{margin-bottom:8px}
  .form-label{color:var(--gold);font-size:11px;margin-bottom:2px;display:block;font-weight:600}
  .form-input,.form-select{width:100%;background:var(--glass-2);border:1px solid var(--border);color:var(--text);padding:6px 8px;border-radius:4px;font-size:11px}
  .form-input:focus,.form-select:focus{outline:none;border-color:var(--gold)}
  .upload-row{display:flex;align-items:center;gap:8px}
  .upload-btn{background:var(--glass-1);color:var(--text);border:1px solid var(--border);padding:6px 12px;border-radius:4px;font-size:10px;cursor:pointer}
  .upload-btn:hover{background:var(--gold2);color:#000}
  .preview{width:32px;height:32px;border-radius:6px;border:1px solid var(--gold);background:#000;object-fit:cover}

  .team-container{background:var(--glass-1);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:var(--shadow);height:fit-content}
  .team-title{font-family:Cinzel,serif;color:var(--gold);font-weight:700;letter-spacing:.08em;margin-bottom:12px;font-size:16px;text-align:center}
  .player-card{background:var(--glass-2);border:1px solid var(--border);border-radius:8px;padding:8px;margin-bottom:8px;display:flex;align-items:center;gap:8px}
  .player-card.dead{opacity:.5}
  .player-avatar{width:32px;height:32px;border-radius:50%;object-fit:cover;border:1px solid var(--gold)}
  .player-info{flex:1;min-width:0}
  .player-name{font-size:12px;font-weight:600;color:var(--gold);margin-bottom:2px}
  .hp{height:6px;background:#0b0b0b;border:1px solid var(--border);border-radius:999px;overflow:hidden;margin-bottom:2px}
  .hp>span{display:block;height:100%;background:linear-gradient(90deg,#4ade80,#22c55e);transition:width .3s}
  .hp-text{font-size:10px;color:var(--muted);margin-bottom:2px}
  .stats{font-size:10px;color:var(--muted)}
  .items-info{font-size:9px;color:var(--text);margin-top:2px}
  .ready-status{font-size:9px;color:var(--gold);margin-top:2px}
  .remove-btn{background:var(--bad);color:#fff;border:none;padding:4px 8px;border-radius:4px;font-size:10px;cursor:pointer;margin-top:4px}
  .remove-btn:hover{background:#dc2626}

  .links-section{background:var(--glass-2);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:12px}
  .links-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:12px}
  .link-item{background:var(--glass-1);border:1px solid var(--border);border-radius:6px;padding:8px;margin-bottom:6px}
  .link-label{color:var(--gold);font-size:10px;margin-bottom:4px;font-weight:600}
  .link-url{background:var(--glass-2);border:1px solid var(--border);color:var(--text);padding:4px 6px;border-radius:4px;font-size:9px;word-break:break-all;margin-bottom:4px;cursor:pointer}
  .link-url:hover{background:var(--gold2);color:#000}
  .copy-btn{background:var(--ok);color:#fff;border:none;padding:3px 6px;border-radius:3px;font-size:9px;cursor:pointer}
  .copy-btn:hover{background:#16a34a}

  .logs-section{height:300px;overflow-y:auto;background:var(--glass-2);border:1px solid var(--border);padding:8px;border-radius:8px;margin-bottom:12px}
  .chat-section{height:200px;overflow-y:auto;background:var(--glass-2);border:1px solid var(--border);padding:8px;border-radius:8px;margin-bottom:8px}
  .log-item{margin-bottom:4px;font-size:11px;line-height:1.4;padding:2px 4px;border-radius:4px}
  .log-time{color:var(--gold);font-weight:normal}
  .chat-item{margin-bottom:4px;font-size:11px}
  .chat-name{color:var(--gold);font-weight:600}
  .input-group{display:flex;gap:4px}
  .chat-input{flex:1;background:var(--glass-2);border:1px solid var(--border);color:var(--text);padding:6px 8px;border-radius:6px;font-size:11px}
  .send-btn{background:var(--gold);color:#000;border:none;padding:6px 12px;border-radius:6px;font-size:11px;cursor:pointer;font-weight:600}

  .log-team-a{background-color:var(--team-a-color);color:var(--text)}
  .log-team-b{background-color:var(--team-b-color);color:var(--text)}
  .log-result{background-color:var(--result-bg);color:var(--result-text)}
  .log-notice{background-color:var(--glass-1);color:var(--gold)}
  .log-error{background-color:#000;color:var(--gold)}
  .log-system{background-color:transparent;color:var(--muted)}

  @media (max-width:767px){
    .main-grid{grid-template-columns:1fr}
    .control-grid{grid-template-columns:1fr}
    .form-grid{grid-template-columns:1fr}
    .links-grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">PYXIS 전투 관리자</div>

  <div class="main-grid">
    <!-- 왼쪽: 전투 제어 + 링크 생성 -->
    <div>
      <div class="card">
        <div class="title">전투 제어</div>
        <div class="control-section">
          <div class="form-field">
            <label class="form-label">전투 모드</label>
            <select id="battleMode" class="form-select">
              <option value="1v1">1v1</option>
              <option value="2v2" selected>2v2</option>
              <option value="3v3">3v3</option>
              <option value="4v4">4v4</option>
            </select>
          </div>
          <div class="control-grid single">
            <button id="btnCreate" class="control-btn">전투 생성</button>
          </div>
          <div class="control-grid">
            <button id="btnStart" class="control-btn" disabled>시작</button>
            <button id="btnPause" class="control-btn" disabled>일시정지</button>
            <button id="btnResume" class="control-btn" disabled>재개</button>
            <button id="btnEnd" class="control-btn danger" disabled>종료</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="title">링크 생성</div>
        <div class="links-section">
          <div class="links-grid">
            <button id="btnGenPlayerLinks" class="control-btn">참가자 링크</button>
            <button id="btnGenSpectatorLink" class="control-btn">관전자 링크</button>
          </div>
          <div id="linksContainer"></div>
        </div>
      </div>
    </div>

    <!-- 가운데: 참가자 추가 + 팀 목록 -->
    <div>
      <div class="card">
        <div class="title">전투 참가자 추가</div>
        <div class="player-form">
          <div class="form-grid">
            <div class="form-field">
              <label class="form-label">이름</label>
              <input id="playerName" class="form-input" type="text" placeholder="이름 입력"/>
            </div>
            <div class="form-field">
              <label class="form-label">팀</label>
              <select id="playerTeam" class="form-select">
                <option value="A">A팀</option>
                <option value="B">B팀</option>
              </select>
            </div>
          </div>
          <div class="form-grid">
            <div class="form-field">
              <label class="form-label">HP</label>
              <input id="playerHP" class="form-input" type="number" value="100" min="1" max="1000"/>
            </div>
            <div class="form-field">
              <label class="form-label">이미지 업로드</label>
              <input id="avatarUpload" type="file" accept="image/*" style="display:none"/>
              <div class="upload-row">
                <button class="upload-btn" id="avatarPickBtn" type="button">이미지 선택</button>
                <img id="avatarPreview" class="preview" alt="미리보기"/>
              </div>
            </div>
          </div>
          <div class="form-grid">
            <div class="form-field">
              <label class="form-label">공격력 (1-5)</label>
              <input id="playerAttack" class="form-input" type="number" value="1" min="1" max="5"/>
            </div>
            <div class="form-field">
              <label class="form-label">방어력 (1-5)</label>
              <input id="playerDefense" class="form-input" type="number" value="1" min="1" max="5"/>
            </div>
            <div class="form-field">
              <label class="form-label">민첩성 (1-5)</label>
              <input id="playerAgility" class="form-input" type="number" value="1" min="1" max="5"/>
            </div>
            <div class="form-field">
              <label class="form-label">행운 (1-5)</label>
              <input id="playerLuck" class="form-input" type="number" value="1" min="1" max="5"/>
            </div>
          </div>
          <div class="form-grid">
            <div class="form-field">
              <label class="form-label">디터니</label>
              <input id="playerDittany" class="form-input" type="number" value="0" min="0" max="10"/>
            </div>
            <div class="form-field">
              <label class="form-label">공격 보정기</label>
              <input id="playerAttackBooster" class="form-input" type="number" value="0" min="0" max="10"/>
            </div>
            <div class="form-field">
              <label class="form-label">방어 보정기</label>
              <input id="playerDefenseBooster" class="form-input" type="number" value="0" min="0" max="10"/>
            </div>
          </div>
          <button id="btnAddPlayer" class="control-btn primary" style="width:100%">전투 참가자 추가</button>
        </div>
      </div>

      <div class="team-container" style="margin-bottom:12px">
        <div class="team-title">A팀</div>
        <div id="teamA"></div>
      </div>
      <div class="team-container">
        <div class="team-title">B팀</div>
        <div id="teamB"></div>
      </div>
    </div>

    <!-- 오른쪽: 로그 + 채팅 -->
    <div>
      <div class="card">
        <div class="title">실시간 로그</div>
        <div class="logs-section" id="logPanel"></div>
      </div>
      <div class="card">
        <div class="title">채팅</div>
        <div class="chat-section" id="chatPanel"></div>
        <div class="input-group">
          <input class="chat-input" id="chatInput" type="text" placeholder="메시지 입력..."/>
          <button class="send-btn" id="chatSend" type="button">전송</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // 서버에서 절대 URL을 내려주지만, 혹시 상대경로가 섞일 경우 대비
  const PUBLIC_BASE = 'https://pyxisbattlesystem.monster';
  const toAbs = (u) => {
    if (!u) return '';
    try {
      const test = new URL(u, PUBLIC_BASE);
      // 개발 포트(:3001 등) 제거 보정
      if (/^https?:\/\/(localhost|127\.|0\.0\.0\.0|10\.|172\.|192\.168\.)/i.test(test.origin)) {
        const prod = new URL(PUBLIC_BASE);
        test.protocol = prod.protocol;
        test.host = prod.host;
      }
      return test.toString();
    } catch {
      return u;
    }
  };

  const socket = io();
  const logPanel  = document.getElementById('logPanel');
  const chatPanel = document.getElementById('chatPanel');

  let currentBattleId = null;
  let battleState = null;
  let uploadedAvatarUrl = null;

  const seenLogs = new Map(); // dedup
  const seenChats = new Map();
  const now = () => Date.now();
  const esc = s => s ? s.replace(/</g,'&lt;').replace(/>/g,'&gt;') : '';

  function logClass(message, type){
    if (type === 'battle' || type === 'item') {
      if (/(^|\s)A팀|=== A팀| A[1-4]/.test(message)) return 'log-team-a';
      if (/(^|\s)B팀|=== B팀| B[1-4]/.test(message)) return 'log-team-b';
      if (/라운드 종료|승리|전투가|결과|===/.test(message)) return 'log-result';
    }
    if (type === 'notice') return 'log-notice';
    if (type === 'error')  return 'log-error';
    return 'log-system';
  }

  function renderTeams() {
    if (!battleState?.players) return;
    const A = battleState.players.filter(p => p.team === 'A');
    const B = battleState.players.filter(p => p.team === 'B');

    const renderTeam = (players, targetId) => {
      let html = '';
      players.forEach(p => {
        const hpPct = Math.max(0, p.hp/(p.maxHp||100)*100);
        const items = [];
        if ((p.items?.dittany || p.items?.ditany) > 0) items.push(`디터니 ${p.items?.dittany || p.items?.ditany}`);
        if ((p.items?.attackBooster || p.items?.attack_boost) > 0) items.push(`공격보정 ${p.items?.attackBooster || p.items?.attack_boost}`);
        if ((p.items?.defenseBooster || p.items?.defense_boost) > 0) items.push(`방어보정 ${p.items?.defenseBooster || p.items?.defense_boost}`);

        const av = p.avatar || '';
        html += `
        <div class="player-card ${p.hp>0?'':'dead'}">
          <img src="${av}" class="player-avatar" alt="${esc(p.name)}"
               onerror="this.removeAttribute('src');this.style.background='#000'"/>
          <div class="player-info">
            <div class="player-name">${esc(p.name)}</div>
            <div class="hp"><span style="width:${hpPct}%"></span></div>
            <div class="hp-text">HP ${p.hp}/${p.maxHp||100}</div>
            <div class="stats">공${p.stats?.attack||0} 방${p.stats?.defense||0} 민${p.stats?.agility||0} 행${p.stats?.luck||0}</div>
            <div class="items-info">${items.length ? items.join(', ') : '아이템 없음'}</div>
            <div class="ready-status">${p.ready ? '준비완료' : '대기중'}</div>
            <button class="remove-btn" onclick="removePlayer('${p.id}')">제거</button>
          </div>
        </div>`;
      });
      document.getElementById(targetId).innerHTML = html;
    };

    renderTeam(A, 'teamA');
    renderTeam(B, 'teamB');
  }

  function updateBattleControls(){
    const s = battleState?.status;
    document.getElementById('btnStart').disabled  = s !== 'waiting';
    document.getElementById('btnPause').disabled  = s !== 'active';
    document.getElementById('btnResume').disabled = s !== 'paused';
    document.getElementById('btnEnd').disabled    = !s || s === 'ended';
  }

  function render(){ renderTeams(); updateBattleControls(); }

  function addChat({name,message}) {
    if(!name||!message) return;
    const k = `${name}::${message}`, t=now(), last=seenChats.get(k)||0;
    if (t-last<1000) return; seenChats.set(k,t);
    const div=document.createElement('div');
    div.className='chat-item';
    div.innerHTML=`<span class="chat-name">${esc(name)}</span>: ${esc(message)}`;
    chatPanel.appendChild(div); chatPanel.scrollTop=chatPanel.scrollHeight;
    while (chatPanel.children.length>200) chatPanel.removeChild(chatPanel.firstChild);
  }

  function addLog({ts,type,message}) {
    if(!message) return;
    const k = `${type}::${message}`, t=now(), last=seenLogs.get(k)||0;
    if (t-last<1000) return; seenLogs.set(k,t);
    const time=new Date(ts).toLocaleTimeString('ko-KR',{hour12:false});
    const div=document.createElement('div');
    div.className = `log-item ${logClass(message,type)}`;
    div.innerHTML = `<span class="log-time">[${time}]</span> ${esc(message)}`;
    logPanel.appendChild(div); logPanel.scrollTop=logPanel.scrollHeight;
    while (logPanel.children.length>800) logPanel.removeChild(logPanel.firstChild);
  }

  // 액션들
  function createBattle(){
    const mode=document.getElementById('battleMode').value;
    socket.emit('createBattle',{mode},(res)=>{
      if(res?.ok){
        currentBattleId = res.battleId || res.battle?.id || null;
        if(currentBattleId){
          if(res.battle) battleState = res.battle;
          addLog({ts:Date.now(),type:'notice',message:`${mode} 전투가 생성되었습니다 (ID: ${currentBattleId})`});
          render();
          socket.emit('join',{battleId:currentBattleId});
        } else {
          alert('전투 생성 응답에서 ID를 찾을 수 없습니다');
        }
      } else {
        alert('전투 생성 실패: ' + (res?.error||'알 수 없는 오류'));
      }
    });
  }
  function startBattle(){ if(!currentBattleId) return; socket.emit('startBattle',{battleId:currentBattleId}); }
  function pauseBattle(){ if(!currentBattleId) return; socket.emit('pauseBattle',{battleId:currentBattleId}); }
  function resumeBattle(){ if(!currentBattleId) return; socket.emit('resumeBattle',{battleId:currentBattleId}); }
  function endBattle(){ if(!currentBattleId) return; if(!confirm('정말 전투를 종료하시겠습니까?')) return; socket.emit('endBattle',{battleId:currentBattleId}); }

  async function uploadAvatar(file){
    const fd=new FormData(); fd.append('avatar',file);
    try{
      const r=await fetch('/api/upload/avatar',{method:'POST',body:fd});
      const j=await r.json();
      if(j.url){ uploadedAvatarUrl=j.url; document.getElementById('avatarPreview').src=uploadedAvatarUrl; addLog({ts:Date.now(),type:'notice',message:'아바타 업로드 완료'}); }
      else throw new Error(j.error||'업로드 실패');
    }catch(e){ alert('아바타 업로드 실패: '+e.message); uploadedAvatarUrl=null; document.getElementById('avatarPreview').removeAttribute('src'); }
  }

  function addPlayer(){
    if(!currentBattleId){ alert('먼저 전투를 생성해주세요'); return; }
    const name=document.getElementById('playerName').value.trim();
    const team=document.getElementById('playerTeam').value;
    const hp=parseInt(document.getElementById('playerHP').value,10);
    const attack=parseInt(document.getElementById('playerAttack').value,10);
    const defense=parseInt(document.getElementById('playerDefense').value,10);
    const agility=parseInt(document.getElementById('playerAgility').value,10);
    const luck=parseInt(document.getElementById('playerLuck').value,10);
    const dittany=parseInt(document.getElementById('playerDittany').value,10);
    const attackBooster=parseInt(document.getElementById('playerAttackBooster').value,10);
    const defenseBooster=parseInt(document.getElementById('playerDefenseBooster').value,10);
    if(!name){ alert('이름을 입력해주세요'); return; }
    const playerData={
      name, team, hp, maxHp:hp,
      stats:{attack,defense,agility,luck},
      items:{dittany,attackBooster,defenseBooster},
      avatar:uploadedAvatarUrl
    };
    socket.emit('addPlayer',{battleId:currentBattleId,player:playerData},(res)=>{
      if(res?.ok){
        addLog({ts:Date.now(),type:'notice',message:`${name}이(가) ${team}팀에 추가되었습니다`});
        clearPlayerForm();
      } else {
        alert('전투 참가자 추가 실패: ' + (res?.error||'알 수 없는 오류'));
      }
    });
  }
  function removePlayer(playerId){
    if(!currentBattleId||!playerId) return;
    const p=battleState?.players?.find(x=>x.id===playerId);
    const nm=p?.name||'Unknown';
    if(!confirm(`${nm}을(를) 제거하시겠습니까?`)) return;
    socket.emit('deletePlayer',{battleId:currentBattleId,playerId},(res)=>{
      if(res?.ok){ addLog({ts:Date.now(),type:'notice',message:`${nm}이(가) 제거되었습니다`}); }
      else alert('전투 참가자 제거 실패: '+(res?.error||'알 수 없는 오류'));
    });
  }
  function clearPlayerForm(){
    playerName.value=''; playerTeam.value='A'; playerHP.value='100';
    playerAttack.value='1'; playerDefense.value='1'; playerAgility.value='1'; playerLuck.value='1';
    playerDittany.value='0'; playerAttackBooster.value='0'; playerDefenseBooster.value='0';
    avatarUpload.value=''; uploadedAvatarUrl=null; document.getElementById('avatarPreview').removeAttribute('src');
  }

  function requestLinks(){
    if(!currentBattleId){ alert('먼저 전투를 생성해주세요'); return; }
    fetch(`/api/admin/battles/${currentBattleId}/links`,{method:'POST'})
      .then(r=>r.json())
      .then(d=>{
        const payload=d?.links||d;
        if(!payload) throw new Error('링크 생성 실패');
        drawLinks(payload);
      })
      .catch(e=>alert('링크 생성 실패: '+e.message));
  }

  function drawLinks(data){
    const container=document.getElementById('linksContainer');
    let html='';
    if(data.spectator?.url){
      const sp = toAbs(data.spectator.url);
      html+=`<div class="link-item">
        <div class="link-label">관전자 링크</div>
        <div class="link-url" onclick="copyToClipboard('${sp}', event)">${sp}</div>
        <button class="copy-btn" onclick="copyToClipboard('${sp}', event)">복사</button>
      </div>`;
    }
    const list=Array.isArray(data.players)?data.players:(data.playerLinks||[]);
    list.forEach(link=>{
      const url=toAbs(link.url);
      const labelName = link.playerName || link.name || '참가자';
      html+=`<div class="link-item">
        <div class="link-label">${esc(labelName)} (${esc(link.team||'')}팀)</div>
        <div class="link-url" onclick="copyToClipboard('${url}', event)">${url}</div>
        <button class="copy-btn" onclick="copyToClipboard('${url}', event)">복사</button>
      </div>`;
    });
    container.innerHTML=html;
  }

  window.copyToClipboard=function(text,ev){
    navigator.clipboard.writeText(text).then(()=>{
      if(ev && ev.target){
        const btn=ev.target.tagName==='BUTTON'?ev.target:ev.currentTarget;
        const orig=btn.textContent; btn.textContent='복사됨!'; btn.style.background='#16a34a';
        setTimeout(()=>{btn.textContent=orig;btn.style.background='';},900);
      }else alert('복사 완료');
    }).catch(()=>alert('복사 실패'));
  };

  function sendChat(){
    const input=document.getElementById('chatInput');
    const message=input.value.trim(); if(!message||!currentBattleId) return;
    socket.emit('chatMessage',{battleId:currentBattleId,name:'관리자',message}); input.value='';
  }

  // 이벤트 바인딩
  document.getElementById('btnCreate').addEventListener('click',createBattle);
  document.getElementById('btnStart').addEventListener('click',startBattle);
  document.getElementById('btnPause').addEventListener('click',pauseBattle);
  document.getElementById('btnResume').addEventListener('click',resumeBattle);
  document.getElementById('btnEnd').addEventListener('click',endBattle);

  document.getElementById('btnAddPlayer').addEventListener('click',addPlayer);
  document.getElementById('avatarPickBtn').addEventListener('click',()=>avatarUpload.click());
  document.getElementById('avatarUpload').addEventListener('change',(e)=>{
    if(e.target.files[0]){
      const blob=URL.createObjectURL(e.target.files[0]);
      document.getElementById('avatarPreview').src=blob;
      uploadAvatar(e.target.files[0]);
    }
  });

  document.getElementById('btnGenPlayerLinks').addEventListener('click',requestLinks);
  document.getElementById('btnGenSpectatorLink').addEventListener('click',requestLinks);

  document.getElementById('chatSend').addEventListener('click',sendChat);
  document.getElementById('chatInput').addEventListener('keypress',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendChat(); } });

  // 소켓 이벤트 (중복 구독 방지: 한 채널만 사용)
  socket.on('connect', ()=>{ addLog({ts:Date.now(),type:'notice',message:'서버에 연결되었습니다'}); });
  socket.on('disconnect', ()=>{ addLog({ts:Date.now(),type:'error',message:'서버 연결이 끊어졌습니다'}); });
  socket.on('connect_error', (err)=>{ addLog({ts:Date.now(),type:'error',message:'서버 연결 오류: '+err.message}); });

  const onSnap=(snap)=>{ battleState=snap; render(); };
  socket.on('battle:update', onSnap); // 사용
  // socket.on('battleUpdate', onSnap); // 중복 방지로 미사용

  socket.on('battle:log', addLog);    // 사용
  // socket.on('battleLog', addLog);  // 미사용

  socket.on('chatMessage', addChat);  // 사용
  // socket.on('battle:chat', addChat); // 미사용

  // 쿼리로 전투 방 지정 시 바로 조인
  const qs=new URLSearchParams(location.search);
  const bid=qs.get('battle');
  if(bid){ currentBattleId=bid; socket.emit('join',{battleId:currentBattleId}); }

  // 전역에서 제거 핸들러 호출 가능
  window.removePlayer = removePlayer;
})();
</script>
</body>
</html>
