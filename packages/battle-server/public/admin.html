<!doctype html>
// 링크 새로고침
loadLinks();
} else {
$('#saveMsg').textContent = `저장 실패: ${j?.error||'ERROR'}`;
}
};


$('#createBtn').onclick = async ()=>{
const mode = $('#mode').value;
const r = await fetch('/api/battles',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mode})});
const j = await r.json();
if(j?.battle){
$('#createResult').innerHTML = `
<div>생성됨: <b>${j.battle.id}</b></div>
<div style="margin-top:6px">관리자 링크: <a class="hl" href="${j.links.admin}">${j.links.admin}</a></div>
<div>플레이어 링크(공용): ${j.links.player}</div>
<div>관전자 링크(공용): ${j.links.spectator}</div>
<div class="hint" style="margin-top:8px">이 페이지를 <b>관리자 링크</b>로 다시 열어 접속하세요.</div>`;
}
};


$('#connectBtn').onclick = ()=>{
connectAsAdmin($('#battleId').value.trim(), $('#adminToken').value.trim());
};


async function loadLinks(){
const b = $('#battleId').value.trim();
const t = $('#adminToken').value.trim();
if(!b||!t) return;
const r = await fetch(`/api/admin/battles/${b}/links?token=${encodeURIComponent(t)}`);
const j = await r.json();
if(!j?.ok) return;
const list = j.links.playerLinks.map(x=>`• ${x.name} → ${x.url}`).join('\n');
$('#links').style.display='block';
$('#links').innerHTML = `
<div class="grid cols-2">
<div>
<div class="tag">관리자</div>
<pre>${j.links.admin}</pre>
<div class="tag">플레이어(공용)</div>
<pre>${j.links.player}</pre>
<div class="tag">관전자(공용)</div>
<pre>${j.links.spectator}</pre>
</div>
<div>
<div class="tag">플레이어별 참가 링크</div>
<pre>${list||'로스터 저장 후 생성됩니다.'}</pre>
</div>
</div>`;
}


function connectAsAdmin(battleId, adminToken){
if(!battleId||!adminToken) return alert('Battle ID / Admin Token 입력');
socket = io();
socket.on('connect', ()=>{
socket.emit('adminAuth',{ battleId, token: adminToken });
});
socket.on('authError', (e)=> alert('인증 실패: '+(e?.code||'')) );
socket.on('authSuccess', (payload)=>{
roster = payload.roster||[];
renderPreview(roster);
// 로스터 편집 행 초기화
rosterRows.innerHTML='';
for(const p of roster) rowTemplate(p);
loadLinks();
});
socket.on('battleUpdate', ({ roster: r })=>{
roster = r||[]; renderPreview(roster);
});
}


// URL 파라미터 사전 채움
if(qs.get('battle')) $('#battleId').value = qs.get('battle');
if(qs.get('token')) $('#adminToken').value = qs.get('token');
if($('#battleId').value && $('#adminToken').value){ connectAsAdmin($('#battleId').value, $('#adminToken').value); }
</script>
</body>
</html>
