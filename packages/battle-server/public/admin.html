<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PYXIS 관리자</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@800;900&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
<script src="/socket.io/socket.io.js"></script>
<style>
  :root{
    /* 네이비/골드 팔레트 고정 */
    --navy:#001E35;
    --navy-0:#001528;
    --navy-1:#012443;
    --glass:#05223fcc;
    --glass-2:#062846cc;
    --border:#0b2a4a;
    --border-2:#0a355e;

    --gold:#D4BA8D;
    --gold-2:#E5D7BE;

    --ink:#F2F1ED;
    --muted:#BFD0E1;

    --ok:#3f9964;
    --warn:#c1994e;
    --bad:#b45c5c;

    --blur: blur(12px) saturate(120%);
    --lift: 0 14px 30px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:"Noto Sans KR",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    background:
      radial-gradient(1200px 600px at 20% -10%, rgba(212,186,141,.10), transparent 60%),
      linear-gradient(180deg, var(--navy-0) 0%, var(--navy) 40%, var(--navy-1) 100%);
  }
  header{position:relative; padding:18px 16px 8px 16px}
  header::before{
    content:""; position:absolute; inset:-35% -10% auto -10%; height:320px;
    background:conic-gradient(from 0deg, rgba(212,186,141,.20), rgba(212,186,141,.05), rgba(212,186,141,.20));
    filter:blur(48px); animation:spin 36s linear infinite; opacity:.55; pointer-events:none;
  }
  @keyframes spin{to{transform:rotate(360deg)}}
  .wrap{max-width:1280px; margin:0 auto}
  .brand{
    font-family:"Cinzel",serif; font-weight:900; letter-spacing:.06em;
    font-size:30px; display:inline-block;
    background:linear-gradient(180deg,var(--gold-2),var(--gold));
    -webkit-background-clip:text; background-clip:text; color:transparent;
  }

  .layout{display:grid; grid-template-columns:1fr 360px; gap:16px; padding:12px 16px}
  @media (max-width:1100px){ .layout{grid-template-columns:1fr} }

  .card{
    background:linear-gradient(180deg,var(--glass),var(--glass-2));
    border:1px solid var(--border); border-top:1px solid rgba(255,255,255,.05);
    border-radius:16px; padding:12px; backdrop-filter:var(--blur); box-shadow:var(--lift);
  }
  .title{font-weight:800; color:var(--gold); margin-bottom:8px}

  .aside{position:sticky; top:12px; align-self:start; height:calc(100vh - 100px); display:flex; flex-direction:column; gap:12px}
  .chatbox{display:flex; flex-direction:column; height:100%}
  .chatlog{flex:1; overflow:auto; background:#061c33; border:1px solid var(--border); border-radius:12px; padding:10px}
  .chatline{display:flex; gap:8px; align-items:baseline; margin-bottom:6px}
  .ts{font-size:11px;color:#8fb0ce;min-width:54px;flex:0 0 auto}

  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .grid-3{display:grid; grid-template-columns:repeat(3,1fr); gap:8px}
  .field{display:flex; align-items:center; gap:8px}
  .input, .select{
    width:100%; padding:10px 12px; border-radius:10px;
    background:#05243f; color:var(--ink); border:1px solid var(--border);
  }
  .input:focus, .select:focus{outline:1px solid var(--gold); box-shadow:0 0 0 3px rgba(212,186,141,.18)}
  .btn{
    border:1px solid var(--border-2); color:var(--ink);
    background:linear-gradient(180deg,#0c3458,#092a4b);
    padding:10px 12px; border-radius:12px; cursor:pointer;
    transition:transform .15s ease;
  }
  .btn:hover{transform:translateY(-1px)}
  .btn.gold{border-color:#7b694d;background:linear-gradient(180deg,#E5D7BE,#D4BA8D); color:#2a200f}
  .btn.ok{background:linear-gradient(180deg,#4aa578,#3f9964)}
  .btn.warn{background:linear-gradient(180deg,#cda45a,#8f6d34)}
  .btn.bad{background:linear-gradient(180deg,#c46c6c,#b45c5c)}
  .pill{display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:#06213a; color:#d9e4ee; font-weight:700}

  .links-list{
    max-height: 42vh;
    overflow:auto;
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px;
    background:#061c33;
  }
  .link-item{border:1px solid var(--border); border-radius:10px; padding:8px; background:#05243f; margin-bottom:8px}
  .copy{white-space:nowrap}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; color:#d9e4ee}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">Pyxis</div>
  </div>
</header>

<main class="wrap layout">
  <section class="main" style="display:flex; flex-direction:column; gap:16px">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="title">전투 생성 및 인증</div>
        <div class="pill" id="battleStatus">대기중</div>
      </div>
      <div class="row" style="margin:6px 0 12px 0">
        <label>전투 모드</label>
        <select id="mode" class="select" style="width:140px">
          <option value="1v1">1 vs 1</option>
          <option value="2v2">2 vs 2</option>
          <option value="3v3">3 vs 3</option>
          <option value="4v4">4 vs 4</option>
        </select>
        <button id="create" class="btn gold" title="전투 생성">생성</button>
      </div>

      <div class="grid-2">
        <div class="card" style="background:#061c33">
          <div class="title" style="margin-bottom:6px">토큰 / 링크</div>
          <div class="row field"><span style="width:84px">전투 ID</span><input id="battleId" class="input" readonly></div>
          <div class="row field"><span style="width:84px">관리자 OTP</span><input id="adminOtp" class="input" readonly></div>
          <div class="row field"><span style="width:84px">관전자 OTP</span><input id="specOtp" class="input" readonly></div>
          <div class="row field"><span style="width:84px">관전자 링크</span><input id="specUrl" class="input mono" readonly><button class="btn copy" data-copy="#specUrl">복사</button></div>
          <div class="row" style="margin-top:10px; gap:10px">
            <button id="connect" class="btn">인증 연결</button>
            <button id="start"   class="btn ok">시작</button>
            <button id="pause"   class="btn warn">일시정지</button>
            <button id="end"     class="btn bad">종료</button>
          </div>
        </div>

        <div class="card" style="background:#061c33">
          <div class="title" style="margin-bottom:6px">플레이어별 링크</div>
          <div class="row" style="margin-bottom:8px">
            <button id="genLinks" class="btn">플레이어별 링크 생성</button>
          </div>
          <div id="links" class="links-list"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="title">참여자 구성</div>
      <div class="grid-3" style="margin-bottom:8px">
        <div class="field"><span style="width:64px">이름</span><input id="pName" class="input" placeholder="플레이어 이름"></div>
        <div class="field">
          <span style="width:64px">팀</span>
          <select id="pTeam" class="select">
            <option value="team1">불사조 기사단</option>
            <option value="team2">죽음을 먹는 자들</option>
          </select>
        </div>
        <div class="field"><span style="width:64px">공격</span><input id="atk" class="input" type="number" value="3" min="1" max="10"></div>
        <div class="field"><span style="width:64px">방어</span><input id="def" class="input" type="number" value="3" min="1" max="10"></div>
        <div class="field"><span style="width:64px">민첩</span><input id="agi" class="input" type="number" value="3" min="1" max="10"></div>
        <div class="field"><span style="width:64px">행운</span><input id="luk" class="input" type="number" value="3" min="1" max="10"></div>
      </div>

      <div class="grid-3" style="margin-top:6px">
        <div class="field"><span style="width:88px">디터니</span><input id="it-heal" class="input" type="number" value="0" min="0" step="1"></div>
        <div class="field"><span style="width:88px">공격 보정기</span><input id="it-atk" class="input" type="number" value="0" min="0" step="1"></div>
        <div class="field"><span style="width:88px">방어 보정기</span><input id="it-def" class="input" type="number" value="0" min="0" step="1"></div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="add" class="btn gold">추가</button>
      </div>
    </div>
  </section>

  <aside class="aside">
    <div class="card chatbox">
      <div class="title">로그 · 채팅</div>
      <div id="chatlog" class="chatlog"></div>
      <div class="row" style="margin-top:8px">
        <select id="chatCh" class="select" style="width:92px">
          <option value="all">전체</option>
          <option value="team">팀</option>
        </select>
        <input id="chatInput" class="input" placeholder="메시지 입력">
        <button id="chatSend" class="btn">보내기</button>
      </div>
    </div>
  </aside>
</main>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const bySel = (sel)=>document.querySelector(sel);

  const mode=$('mode'), create=$('create'), battleStatus=$('battleStatus');
  const battleId=$('battleId'), adminOtp=$('adminOtp'), specOtp=$('specOtp'), specUrl=$('specUrl');
  const connect=$('connect'), start=$('start'), pause=$('pause'), end=$('end');
  const genLinks=$('genLinks'), links=$('links');
  const pName=$('pName'), pTeam=$('pTeam'), atk=$('atk'), def=$('def'), agi=$('agi'), luk=$('luk');
  const itHeal=$('it-heal'), itAtk=$('it-atk'), itDef=$('it-def'), add=$('add');
  const chatlog=$('chatlog'), chatInput=$('chatInput'), chatSend=$('chatSend'), chatCh=$('chatCh');

  const socket = io({ path:'/socket.io/' });
  let currentBattle = null;
  let myAdminToken = null;

  function fmtTs(ts){ try{ return new Date(ts).toLocaleTimeString([], {hour12:false}); }catch{return '--:--:--';} }
  function logLine(kind, text){
    const row = document.createElement('div'); row.className='chatline';
    const ts = document.createElement('span'); ts.className='ts'; ts.textContent = fmtTs(Date.now());
    const body = document.createElement('span'); body.textContent = (kind?('['+kind+'] '):'') + text;
    row.appendChild(ts); row.appendChild(body);
    chatlog.appendChild(row); chatlog.scrollTop = chatlog.scrollHeight;
  }
  function setStatus(s){
    battleStatus.textContent = s==='ongoing' ? '진행중' : s==='ended' ? '종료' : '대기중';
  }
  function copyFrom(sel){
    const el = typeof sel==='string' ? bySel(sel) : sel;
    if (!el) return;
    el.select?.(); navigator.clipboard.writeText(el.value || el.textContent || '');
  }
  document.querySelectorAll('.copy').forEach(btn=>btn.addEventListener('click', ()=>copyFrom(btn.dataset.copy)));

  // 공통 POST 함수
  async function postJSON(url, body){
    const r = await fetch(url, {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify(body||{})
    });
    let text=''; try{ text = await r.text(); }catch{}
    let json=null; try{ json = text ? JSON.parse(text) : null; }catch{}
    if (!r.ok || (json && json.ok===false)){
      const msg = (json && (json.error||json.message)) || text || `HTTP ${r.status}`;
      const err = new Error(msg); err.status=r.status; err.body=text; throw err;
    }
    return json || {};
  }

  // 전투 생성: 기본 → 폴백
  async function createBattle(){
    const payload = { mode: String(mode.value||'1v1') };
    try{
      return await postJSON('/api/admin/battles', payload);
    }catch(e1){
      console.warn('create /api/admin/battles 실패:', e1);
      // 폴백
      try{
        return await postJSON('/api/battles', payload);
      }catch(e2){
        console.error('create 폴백(/api/battles) 실패:', e2);
        // 에러 디테일 표시
        const details = `상태: ${e2.status||'N/A'}\n메시지: ${e2.message||'알 수 없음'}`;
        throw new Error('전투 생성 실패\n' + details);
      }
    }
  }

  // 관전자 링크 조립(응답에 urls.watch 없을 때)
  function buildWatchUrl(origin, id, spectatorOtp){
    const base = origin || (location.origin || '');
    const url = new URL(base);
    return `${url.origin}/watch?battle=${encodeURIComponent(id)}&token=${encodeURIComponent(spectatorOtp)}&name=${encodeURIComponent('관전자')}`;
    }

  // 생성 버튼
  create.onclick = async ()=>{
    try{
      const j = await createBattle();
      const b = j.battle || {};
      const otps = j.otps || {};
      const urls = j.urls || {};
      currentBattle = b.id;
      myAdminToken = otps.admin || null;

      battleId.value = b.id || '';
      adminOtp.value = otps.admin || '';
      specOtp.value  = otps.spectator || '';

      // urls.watch가 비어있으면 직접 구성
      specUrl.value  = urls.watch || buildWatchUrl('', b.id, otps.spectator);

      setStatus(b.status||'waiting');
      logLine('시스템','전투 생성 완료');
    }catch(e){
      alert(e.message || '생성 실패');
    }
  };

  // 링크 생성
  genLinks.onclick = async ()=>{
    if (!currentBattle) return alert('전투가 없습니다');
    try{
      const j = await postJSON(`/api/admin/battles/${currentBattle}/links`);
      specUrl.value = (j.urls && j.urls.watch) ? j.urls.watch : specUrl.value;
      links.innerHTML = '';
      (j.playerLinks||[]).forEach(pl=>{
        const box = document.createElement('div'); box.className='link-item';
        const title = document.createElement('div'); title.style.fontWeight='800'; title.textContent = pl.name;
        const row = document.createElement('div'); row.className='row'; row.style.marginTop='6px';
        const input = document.createElement('input'); input.className='input mono'; input.value = pl.url; input.readOnly = true;
        const btn = document.createElement('button'); btn.className='btn copy'; btn.textContent='복사';
        btn.onclick = ()=> copyFrom(input);
        row.appendChild(input); row.appendChild(btn);
        box.appendChild(title); box.appendChild(row);
        links.appendChild(box);
      });
    }catch(e){
      alert(e.message || '링크 생성 실패');
    }
  };

  // 플레이어 추가
  add.onclick = async ()=>{
    if (!currentBattle) return alert('전투가 없습니다');
    const payload = {
      name: pName.value.trim(),
      team: pTeam.value,
      stats:{ attack:Number(atk.value||0), defense:Number(def.value||0), agility:Number(agi.value||0), luck:Number(luk.value||0) },
      inventory:{
        '디터니': Math.max(0, Number(itHeal.value||0)|0),
        '공격 보정기': Math.max(0, Number(itAtk.value||0)|0),
        '방어 보정기': Math.max(0, Number(itDef.value||0)|0)
      }
    };
    try{
      await postJSON(`/api/battles/${currentBattle}/players`, payload);
      pName.value=''; itHeal.value=itAtk.value=itDef.value='0';
      logLine('시스템','참여자 추가 완료');
    }catch(e){
      alert(e.message || '추가 실패');
    }
  };

  // 소켓 인증/제어
  connect.onclick = ()=>{
    if (!currentBattle || !myAdminToken) return alert('전투/토큰이 없습니다');
    socket.emit('auth', { battle: currentBattle, token: myAdminToken, role:'admin', name:'관리자' }, (ack)=>{
      if (!ack || !ack.ok) return alert('인증 실패');
      setStatus(ack.state.status);
      logLine('시스템','소켓 인증 성공');
    });
  };
  start.onclick = async ()=>{ if (!currentBattle) return alert('전투가 없습니다'); try{ await postJSON(`/api/admin/battles/${currentBattle}/start`); logLine('시스템','전투 시작'); }catch(e){ alert(e.message||'시작 실패'); } };
  pause.onclick = async ()=>{ if (!currentBattle) return alert('전투가 없습니다'); try{ await postJSON(`/api/admin/battles/${currentBattle}/pause`); logLine('시스템','전투 일시정지'); }catch(e){ alert(e.message||'일시정지 실패'); } };
  end.onclick   = async ()=>{ if (!currentBattle) return alert('전투가 없습니다'); try{ await postJSON(`/api/admin/battles/${currentBattle}/end`);   logLine('시스템','전투 종료'); }catch(e){ alert(e.message||'종료 실패'); } };

  // 채팅
  chatSend.onclick = ()=>{
    const text = chatInput.value.trim(); if (!text) return;
    socket.emit('chatMessage', { message:text, channel: chatCh.value }, (ack)=>{
      if (ack && ack.error) alert('보내기 실패: ' + ack.error);
    });
    chatInput.value='';
  };

  // 수신
  socket.on('state', s => { setStatus(s.status); });
  socket.on('chat', m => {
    const who = m.type==='chat' ? (m.channel==='team'?'[팀] ':'[전체] ') : (m.type==='cheer'?'[응원] ':'[시스템] ');
    const msg = m.type==='system' ? m.text : (m.type==='cheer' ? (m.from+': '+m.text) : (m.from+': '+(m.text||m.message||'')));
    const row = document.createElement('div'); row.className='chatline';
    const ts = document.createElement('span'); ts.className='ts'; ts.textContent = new Date(m.ts||Date.now()).toLocaleTimeString([], {hour12:false});
    const body = document.createElement('span'); body.textContent = who + msg;
    row.appendChild(ts); row.appendChild(body);
    chatlog.appendChild(row); chatlog.scrollTop = chatlog.scrollHeight;
  });

  // URL 파라미터 자동 인증(관리자)
  (function auto(){
    const qs = new URLSearchParams(location.search);
    const b = qs.get('battle'), t = qs.get('token');
    if (b && t){
      currentBattle = b; myAdminToken = t;
      battleId.value = b; adminOtp.value = t;
      socket.emit('auth', { battle:b, token:t, role:'admin', name:'관리자' }, (ack)=>{ if (ack && ack.ok){ setStatus(ack.state.status); } });
    }
  })();
})();
</script>
</body>
</html>
