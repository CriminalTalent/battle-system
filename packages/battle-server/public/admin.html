<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>PYXIS - 관리자 콘솔</title>
  <script src="/socket.io/socket.io.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --deep-navy: #0A0F1A;
      --dark-blue: #0C1221;
      --mid-blue: #1E2A47;
      --light-blue: #3D5A80;
      --gold: #DCC7A2;
      --gold-bright: #E6D2A8;
      --gold-shimmer: #F0E6C8;
      --text: #F8F9FA;
      --text-accent: #E9ECEF;
      --text-muted: #ADB5BD;
      --glass-1: rgba(30, 42, 71, 0.3);
      --glass-2: rgba(30, 42, 71, 0.5);
      --border: rgba(61, 90, 128, 0.4);
      --border-light: rgba(61, 90, 128, 0.6);
      --blur-light: blur(10px);
      --transition-fast: 0.2s ease-out;
      --radius: 12px;
      --shadow-soft: 0 4px 6px rgba(0, 0, 0, 0.1);
      --shadow-medium: 0 8px 15px rgba(0, 0, 0, 0.2);
      --shadow-glow: 0 0 20px rgba(212, 183, 126, 0.2);
      --serif: 'Cinzel', serif;
      --success: #27AE60;
      --danger: #E74C3C;
      --warning: #F39C12;
      --info: #3498DB;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      font-family: var(--serif);
      background: linear-gradient(135deg, var(--deep-navy) 0%, var(--dark-blue) 100%);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
    }
    .header {
      background: var(--glass-2);
      backdrop-filter: var(--blur-light);
      border-bottom: 1px solid var(--border-light);
      padding: 16px 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-soft);
    }
    .header-inner {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }
    .brand .logo {
      font-size: 28px;
      font-weight: 800;
      color: var(--gold-bright);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      letter-spacing: 2px;
    }
    .brand .subtitle {
      font-size: 12px;
      color: var(--text-muted);
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 2s infinite;
    }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }

    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
      align-items: start;
    }
    @media (max-width: 1200px) {
      .main-container { grid-template-columns: 1fr; gap: 16px; }
    }

    .card {
      background: var(--glass-2);
      backdrop-filter: var(--blur-light);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow-soft);
      transition: all var(--transition-fast);
    }
    .card:hover { transform: translateY(-2px); box-shadow: var(--shadow-medium); }
    .card-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--gold-bright);
      margin-bottom: 20px;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }

    .field { margin-bottom: 16px; }
    .field label {
      display: block;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: .5px;
      font-weight: 600;
    }
    .field input, .field select {
      width: 100%;
      padding: 10px 12px;
      background: var(--glass-1);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-family: var(--serif);
      font-size: 14px;
      transition: all var(--transition-fast);
    }
    .field input:focus, .field select:focus {
      outline: none;
      border-color: var(--gold);
      box-shadow: 0 0 0 2px rgba(220, 199, 162, 0.2);
      background: var(--glass-2);
    }
    .field input[readonly] { background: var(--glass-1); color: var(--text-muted); cursor: default; }

    .btn {
      padding: 10px 16px;
      background: linear-gradient(135deg, var(--gold), var(--gold-bright));
      color: var(--deep-navy);
      border: none;
      border-radius: var(--radius);
      font-family: var(--serif);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      text-transform: uppercase;
      letter-spacing: .5px;
      box-shadow: var(--shadow-soft);
      min-height: 40px;
      display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    .btn:hover:not(:disabled) { background: linear-gradient(135deg, var(--gold-bright), var(--gold-shimmer)); transform: translateY(-2px); box-shadow: var(--shadow-medium); }
    .btn:disabled { background: var(--glass-1); color: var(--text-muted); cursor: not-allowed; transform: none; box-shadow: none; }
    .btn-success { background: linear-gradient(135deg, var(--success), #2ecc71); color: #fff; }
    .btn-success:hover:not(:disabled) { background: linear-gradient(135deg, #2ecc71, #27ae60); }
    .btn-danger { background: linear-gradient(135deg, var(--danger), #c0392b); color: #fff; }
    .btn-danger:hover:not(:disabled) { background: linear-gradient(135deg, #c0392b, #a93226); }
    .btn-sm { padding: 6px 10px; font-size: 11px; min-height: 28px; }
    .btn-copy { background: linear-gradient(135deg, var(--info), #2980b9); color: #fff; font-size: 12px; padding: 6px 12px; min-height: 32px; }
    .btn-copy:hover:not(:disabled) { background: linear-gradient(135deg, #2980b9, #21618c); }
    .btn-group { display: flex; gap: 8px; margin-bottom: 12px; }
    .btn-group .btn { flex: 1; }

    .team-section { margin-top: 18px; }
    .team-title { font-size: 14px; font-weight: 600; color: var(--gold); margin-bottom: 12px; text-transform: uppercase; letter-spacing: .5px; }

    .player-list {
      background: var(--glass-1);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      max-height: 220px;
      overflow-y: auto;
    }
    .player-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 12px; border-bottom: 1px solid var(--border); font-size: 12px;
      transition: all var(--transition-fast);
    }
    .player-item:last-child { border-bottom: none; }
    .player-item:hover { background: var(--glass-2); }
    .player-info { display: flex; align-items: center; gap: 8px; }
    .player-avatar { width: 24px; height: 24px; border-radius: 6px; object-fit: cover; background: var(--mid-blue); border: 1px solid var(--border); }
    .player-name { color: var(--text-accent); font-weight: 600; }
    .player-hp { color: var(--text-muted); font-size: 11px; }

    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 16px; }
    .items-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px; }

    .preview-section { display: flex; align-items: center; gap: 12px; }
    .preview {
      width: 60px; height: 60px; border-radius: var(--radius);
      background: var(--glass-1); border: 2px solid var(--border);
      display: flex; align-items: center; justify-content: center; color: var(--text-muted);
      font-size: 10px; text-align: center; background-size: cover; background-position: center;
    }
    .file-input { flex: 1; }

    .log-container {
      height: 300px; overflow-y: auto; background: var(--glass-1);
      border: 1px solid var(--border); border-radius: var(--radius); padding: 12px;
    }
    .log-entry { padding: 6px 0; border-bottom: 1px solid rgba(61, 90, 128, 0.2); font-size: 12px; line-height: 1.4; }
    .log-entry:last-child { border-bottom: none; }
    .log-time { color: var(--text-muted); font-size: 10px; margin-right: 8px; }
    .log-entry.system { color: var(--info); }
    .log-entry.error { color: var(--danger); }
    .log-entry.success { color: var(--success); }

    .player-links { margin-top: 16px; }
    .link-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; padding: 8px; background: var(--glass-1); border: 1px solid var(--border); border-radius: var(--radius); }
    .link-info { flex: 1; font-size: 12px; }
    .link-name { color: var(--text-accent); font-weight: 600; }
    .link-team { color: var(--text-muted); font-size: 11px; }
    .link-url { font-family: 'Courier New', monospace; color: var(--text-muted); font-size: 10px; margin-top: 2px; word-break: break-all; }

    .chat-section { margin-top: 20px; }
    .chat-messages { height: 150px; overflow-y: auto; background: var(--glass-1); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; margin-bottom: 8px; }
    .chat-entry { font-size: 12px; line-height: 1.4; margin-bottom: 6px; color: var(--text-accent); }
    .chat-entry .name { color: var(--gold); font-weight: 600; }
    .chat-input-row { display: flex; gap: 8px; }
    .chat-input { flex: 1; padding: 8px 12px; background: var(--glass-1); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); font-family: var(--serif); font-size: 12px; }
    .chat-input:focus { outline: none; border-color: var(--gold); box-shadow: 0 0 0 2px rgba(220, 199, 162, 0.2); }

    .toast {
      position: fixed; top: 100px; right: 20px; background: var(--glass-2); backdrop-filter: var(--blur-light);
      border: 1px solid var(--border-light); border-radius: var(--radius); padding: 16px; color: var(--text); font-size: 14px;
      box-shadow: var(--shadow-medium); transform: translateX(400px); transition: transform .3s ease-out; z-index: 3000; max-width: 300px;
    }
    .toast.show { transform: translateX(0); }
    .toast.success { border-left: 4px solid var(--success); }
    .toast.error { border-left: 4px solid var(--danger); }
    .toast.info { border-left: 4px solid var(--info); }

    .otp-display {
      background: var(--glass-1); border: 2px solid var(--gold); border-radius: var(--radius); padding: 12px; text-align: center; margin: 12px 0;
    }
    .otp-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; }
    .otp-value { font-family: 'Courier New', monospace; font-size: 18px; font-weight: 700; color: var(--gold-bright); letter-spacing: 2px; }
    .otp-expire { font-size: 10px; color: var(--text-muted); margin-top: 4px; }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <div class="brand">
        <div class="logo">PYXIS</div>
        <div class="subtitle">관리자 콘솔</div>
      </div>
      <div class="connection-status">
        <span id="connText">서버 연결</span>
        <div class="status-dot" id="connDot"></div>
      </div>
    </div>
  </header>

  <div class="main-container">
    <!-- 좌측: 전투 제어 + 링크/비번 -->
    <div class="card">
      <div class="card-title">전투 제어</div>

      <div class="field">
        <label for="battleMode">전투 모드</label>
        <select id="battleMode">
          <option value="1v1">1 vs 1</option>
          <option value="2v2" selected>2 vs 2</option>
          <option value="3v3">3 vs 3</option>
          <option value="4v4">4 vs 4</option>
        </select>
      </div>

      <div class="btn-group">
        <button id="btnCreate" class="btn">전투 생성</button>
        <button id="btnStart" class="btn btn-success" disabled>시작</button>
      </div>
      <div class="btn-group">
        <button id="btnPause" class="btn" disabled>일시정지</button>
        <button id="btnResume" class="btn" disabled>재개</button>
      </div>
      <div class="btn-group">
        <button id="btnEnd" class="btn btn-danger" disabled>종료</button>
      </div>

      <div id="battleInfo" style="margin-top: 20px; display: none;">
        <div class="field">
          <label>전투 ID</label>
          <input id="battleId" type="text" readonly>
        </div>
        <div class="field">
          <label>상태</label>
          <input id="battleStatus" type="text" readonly>
        </div>
      </div>

      <!-- 링크 및 비밀번호 -->
      <div style="margin-top: 18px;">
        <div class="card-title" style="font-size: 14px; margin-bottom: 12px;">링크 및 비밀번호</div>

        <!-- 관전자 비밀번호 -->
        <div class="field">
          <label>관전자 비밀번호</label>
          <button id="btnGenSpectator" class="btn">관전자 비밀번호 발급</button>
          <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px; line-height: 1.3;">
            관전자는 접속 시 이름을 직접 입력합니다
          </div>
        </div>

        <div id="spectatorOtpDisplay" style="display: none;">
          <div class="otp-display">
            <div class="otp-label">관전자 비밀번호</div>
            <div id="spectatorOtp" class="otp-value">------</div>
            <div class="otp-expire">30분간 유효 · 최대 30명</div>
          </div>
          <button id="btnCopySpectatorUrl" class="btn btn-copy" style="width: 100%;">관전자 URL 복사</button>
        </div>

        <!-- 전투 참가자 OTP -->
        <div style="margin-top: 14px;">
          <div class="field">
            <label>전투 참가자 비밀번호</label>
            <div style="display: flex; gap: 6px;">
              <input id="playerNameForOtp" type="text" placeholder="참가자 이름 입력" style="flex: 1;">
              <button id="btnGenPlayerOtp" class="btn">OTP 발급</button>
            </div>
          </div>

          <div id="playerOtpDisplay" style="display: none;">
            <div class="otp-display">
              <div class="otp-label">전투 참가자 비밀번호</div>
              <div id="playerOtpName" style="font-size: 11px; color: var(--text-muted); margin-bottom: 3px;"></div>
              <div id="playerOtp" class="otp-value">------</div>
              <div class="otp-expire">30분간 유효</div>
            </div>
            <button id="btnCopyPlayerUrl" class="btn btn-copy" style="width: 100%;">전투 참가자 URL 복사</button>
          </div>
        </div>

        <!-- 생성된 링크 목록 -->
        <div class="player-links">
          <div class="team-title">생성된 참가자 링크</div>
          <div id="generatedLinks" class="player-list">
            <div style="padding: 14px; text-align: center; color: var(--text-muted); font-size: 11px;">
              아직 생성된 링크가 없습니다.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 중앙: 전투 참가자 관리 -->
    <div class="card">
      <div class="card-title">전투 참가자 관리</div>

      <div style="display: grid; grid-template-columns: 1fr 120px; gap: 12px; margin-bottom: 16px;">
        <div class="field">
          <label for="playerName">이름</label>
          <input id="playerName" type="text" placeholder="전투 참가자 이름" maxlength="20">
        </div>
        <div class="field">
          <label for="playerTeam">팀</label>
          <select id="playerTeam">
            <option value="A">A팀</option>
            <option value="B">B팀</option>
          </select>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 200px; gap: 12px; margin-bottom: 16px;">
        <div class="field">
          <label for="playerHp">체력 (최대 100)</label>
          <input id="playerHp" type="number" min="1" max="100" value="100">
        </div>
        <div class="field">
          <label>아바타 이미지</label>
          <div class="preview-section">
            <div id="avatarPreview" class="preview">미리보기</div>
            <input id="avatarFile" type="file" accept="image/*" class="file-input">
          </div>
        </div>
      </div>

      <div style="margin-bottom: 12px;">
        <label style="display: block; font-size: 11px; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase;">스탯 (각 1~5)</label>
        <div class="stats-grid">
          <div class="field">
            <label for="statAttack">공격</label>
            <input id="statAttack" type="number" min="1" max="5" value="3">
          </div>
          <div class="field">
            <label for="statDefense">방어</label>
            <input id="statDefense" type="number" min="1" max="5" value="3">
          </div>
          <div class="field">
            <label for="statAgility">민첩</label>
            <input id="statAgility" type="number" min="1" max="5" value="3">
          </div>
          <div class="field">
            <label for="statLuck">행운</label>
            <input id="statLuck" type="number" min="1" max="5" value="2">
          </div>
        </div>
      </div>

      <div style="margin-bottom: 14px;">
        <label style="display: block; font-size: 11px; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase;">시작 아이템</label>
        <div class="items-grid">
          <div class="field">
            <label for="itemDittany">디터니</label>
            <input id="itemDittany" type="number" min="0" max="99" value="1">
          </div>
          <div class="field">
            <label for="itemAtkBoost">공격 보정기</label>
            <input id="itemAtkBoost" type="number" min="0" max="99" value="0">
          </div>
          <div class="field">
            <label for="itemDefBoost">방어 보정기</label>
            <input id="itemDefBoost" type="number" min="0" max="99" value="0">
          </div>
        </div>
      </div>

      <button id="btnAddPlayer" class="btn" style="width: 100%;">전투 참가자 추가</button>

      <div style="margin-top: 18px;">
        <div class="team-section">
          <div class="team-title">A팀</div>
          <div id="teamAList" class="player-list">
            <div style="padding: 14px; text-align: center; color: var(--text-muted); font-size: 11px;">
              아직 추가된 참가자가 없습니다.
            </div>
          </div>
        </div>

        <div class="team-section">
          <div class="team-title">B팀</div>
          <div id="teamBList" class="player-list">
            <div style="padding: 14px; text-align: center; color: var(--text-muted); font-size: 11px;">
              아직 추가된 참가자가 없습니다.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 우측: 실시간 로그 + 채팅 -->
    <div class="card">
      <div class="card-title">실시간 로그</div>
      <div id="logContainer" class="log-container"></div>

      <div class="chat-section">
        <div class="team-title">채팅</div>
        <div id="chatMessages" class="chat-messages"></div>
        <div class="chat-input-row">
          <input id="chatInput" class="chat-input" type="text" placeholder="관리자 메시지 입력..." maxlength="100">
          <button id="btnSendChat" class="btn btn-sm">전송</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const $ = (q) => document.querySelector(q);
    const escapeHtml = (s) => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    let socket = null;
    let currentBattle = null;
    let generatedLinks = new Map();

    const connText = $('#connText');
    const connDot = $('#connDot');

    const battleMode = $('#battleMode');
    const btnCreate = $('#btnCreate');
    const btnStart = $('#btnStart');
    const btnPause = $('#btnPause');
    const btnResume = $('#btnResume');
    const btnEnd = $('#btnEnd');

    const battleInfo = $('#battleInfo');
    const battleId = $('#battleId');
    const battleStatus = $('#battleStatus');

    const btnGenSpectator = $('#btnGenSpectator');
    const spectatorOtpDisplay = $('#spectatorOtpDisplay');
    const spectatorOtp = $('#spectatorOtp');
    const btnCopySpectatorUrl = $('#btnCopySpectatorUrl');

    const playerNameForOtp = $('#playerNameForOtp');
    const btnGenPlayerOtp = $('#btnGenPlayerOtp');
    const playerOtpDisplay = $('#playerOtpDisplay');
    const playerOtpName = $('#playerOtpName');
    const playerOtp = $('#playerOtp');
    const btnCopyPlayerUrl = $('#btnCopyPlayerUrl');

    const generatedLinksEl = $('#generatedLinks');

    const playerName = $('#playerName');
    const playerTeam = $('#playerTeam');
    const playerHp = $('#playerHp');
    const avatarFile = $('#avatarFile');
    const avatarPreview = $('#avatarPreview');
    const statAttack = $('#statAttack');
    const statDefense = $('#statDefense');
    const statAgility = $('#statAgility');
    const statLuck = $('#statLuck');
    const itemDittany = $('#itemDittany');
    const itemAtkBoost = $('#itemAtkBoost');
    const itemDefBoost = $('#itemDefBoost');
    const btnAddPlayer = $('#btnAddPlayer');

    const teamAList = $('#teamAList');
    const teamBList = $('#teamBList');

    const logContainer = $('#logContainer');
    const chatMessages = $('#chatMessages');
    const chatInput = $('#chatInput');
    const btnSendChat = $('#btnSendChat');

    const toastEl = $('#toast');

    const showToast = (message, type = 'info') => {
      toastEl.textContent = message;
      toastEl.className = `toast ${type} show`;
      setTimeout(() => toastEl.classList.remove('show'), 3000);
    };

    const addLog = (message, type = 'system') => {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const time = document.createElement('span');
      time.className = 'log-time';
      time.textContent = new Date().toLocaleTimeString('ko-KR',{hour12:false,hour:'2-digit',minute:'2-digit'});
      const content = document.createElement('span');
      content.textContent = message;
      entry.appendChild(time); entry.appendChild(content);
      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
      while (logContainer.children.length > 100) logContainer.removeChild(logContainer.firstChild);
    };

    const addChat = (name, message) => {
      const entry = document.createElement('div');
      entry.className = 'chat-entry';
      entry.innerHTML = `<span class="name">${escapeHtml(name)}</span>: ${escapeHtml(message)}`;
      chatMessages.appendChild(entry);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      while (chatMessages.children.length > 50) chatMessages.removeChild(chatMessages.firstChild);
    };

    const copyToClipboard = async (text) => {
      try {
        await navigator.clipboard.writeText(text);
        showToast('URL이 클립보드에 복사되었습니다.', 'success');
      } catch (err) {
        const textarea = document.createElement('textarea');
        textarea.value = text; document.body.appendChild(textarea);
        textarea.select(); document.execCommand('copy'); document.body.removeChild(textarea);
        showToast('URL이 복사되었습니다.', 'success');
      }
    };

    const connectSocket = () => {
      socket = window.io ? window.io() : null;
      if (!socket) { showToast('소켓 연결 실패', 'error'); return; }

      socket.on('connect', () => {
        connText.textContent = '연결됨';
        connDot.style.background = 'var(--success)';
        addLog('서버에 연결되었습니다.', 'system');
      });
      socket.on('disconnect', () => {
        connText.textContent = '연결 끊김';
        connDot.style.background = 'var(--danger)';
        addLog('서버 연결이 끊어졌습니다.', 'system');
      });

      socket.on('battleCreated', (data) => {
        currentBattle = data.battle;
        battleInfo.style.display = 'block';
        battleId.value = currentBattle.id;
        battleStatus.value = currentBattle.status || 'waiting';
        btnCreate.disabled = true; btnStart.disabled = false;
        showToast(`전투가 생성되었습니다. (ID: ${currentBattle.id})`, 'success');
        addLog(`전투 생성: ${currentBattle.id} (${battleMode.value})`, 'success');
      });
      socket.on('battle:created', (data) => { socket.emit('battleCreated', data); });

      socket.on('battleUpdate', onBattleUpdate);
      socket.on('battle:update', onBattleUpdate);

      socket.on('playerAdded', (data) => {
        showToast(`${data.player.name}이(가) 추가되었습니다.`, 'success');
        addLog(`전투 참가자 추가: ${data.player.name} (${data.player.team}팀)`, 'success');
        updateTeamLists();
      });
      socket.on('player:added', (data) => { socket.emit('playerAdded', data); });

      socket.on('chatMessage', (data) => { addChat(data.name || '익명', data.message || ''); });
      socket.on('battle:chat', (data) => { addChat(data.name || data.senderName || '익명', data.message || ''); });

      socket.on('battleLog', (data) => { addLog(data.message || '로그', data.type || 'system'); });
      socket.on('battle:log', (data) => { addLog(data.message || '로그', data.type || 'system'); });

      socket.on('cheerMessage', (data) => { addLog(`[응원] ${data.name || '관전자'}: ${data.message}`, 'info'); });
      socket.on('spectator:cheer', (data) => { addLog(`[응원] ${data.name || '관전자'}: ${data.message}`, 'info'); });
    };

    const onBattleUpdate = (data) => {
      if (!data) return;
      currentBattle = data;
      if (battleStatus) battleStatus.value = data.status || 'waiting';
      const status = data.status;
      btnStart.disabled = status !== 'waiting';
      btnPause.disabled = status !== 'active';
      btnResume.disabled = status !== 'paused';
      btnEnd.disabled = status === 'waiting';
      updateTeamLists();
    };

    const updateTeamLists = () => {
      if (!currentBattle || !currentBattle.players) return;
      const teamA = currentBattle.players.filter(p => (p.team || 'A') === 'A');
      const teamB = currentBattle.players.filter(p => (p.team || 'A') === 'B');

      const fill = (el, list) => {
        if (list.length === 0) {
          el.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted); font-size: 12px;">아직 추가된 참가자가 없습니다.</div>';
        } else {
          el.innerHTML = '';
          list.forEach(player => el.appendChild(createPlayerItem(player)));
        }
      };
      fill(teamAList, teamA);
      fill(teamBList, teamB);
    };

    const createPlayerItem = (player) => {
      const item = document.createElement('div');
      item.className = 'player-item';
      const hp = player.hp || 100;
      const maxHp = player.maxHp || 100;
      const stats = player.stats || {};
      item.innerHTML = `
        <div class="player-info">
          <img class="player-avatar" src="${player.avatar || ''}" alt="${escapeHtml(player.name || '전투 참가자')}">
          <div>
            <div class="player-name">${escapeHtml(player.name || '전투 참가자')}</div>
            <div class="player-hp">HP: ${hp}/${maxHp} | 공:${stats.attack || 3} 방:${stats.defense || 3} 민:${stats.agility || 3} 행:${stats.luck || 2}</div>
          </div>
        </div>
        <button class="btn btn-sm btn-danger" onclick="removePlayer('${player.id}')">삭제</button>
      `;
      return item;
    };

    window.removePlayer = (playerId) => {
      if (!socket || !currentBattle) return;
      socket.emit('removePlayer', { battleId: currentBattle.id, playerId });
      socket.emit('player:remove', { battleId: currentBattle.id, playerId });
    };

    avatarFile.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          avatarPreview.style.backgroundImage = `url(${ev.target.result})`;
          avatarPreview.textContent = '';
        };
        reader.readAsDataURL(file);
      } else {
        avatarPreview.style.backgroundImage = '';
        avatarPreview.textContent = '미리보기';
      }
    });

    const generateOTP = (length = 6) => {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let result = '';
      for (let i = 0; i < length; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
      return result;
    };

    const generateSpectatorPassword = () => {
      if (!currentBattle) { showToast('먼저 전투를 생성해주세요.', 'error'); return; }
      const otp = generateOTP(6);
      spectatorOtp.textContent = otp;
      spectatorOtpDisplay.style.display = 'block';
      showToast('관전자 비밀번호가 발급되었습니다.', 'success');
      addLog(`관전자 비밀번호 발급: ${otp}`, 'success');
    };

    const generatePlayerOTP = () => {
      const name = playerNameForOtp.value.trim();
      if (!name) { showToast('참가자 이름을 입력해주세요.', 'error'); return; }
      if (!currentBattle) { showToast('먼저 전투를 생성해주세요.', 'error'); return; }

      const otp = generateOTP(8);
      playerOtpName.textContent = `${name}님의 비밀번호`;
      playerOtp.textContent = otp;
      playerOtpDisplay.style.display = 'block';

      const linkData = { name, team: 'A', otp, createdAt: Date.now() };
      generatedLinks.set(name, linkData);
      updateGeneratedLinks();

      showToast(`${name}님의 비밀번호가 발급되었습니다.`, 'success');
      addLog(`전투 참가자 OTP 발급: ${name} - ${otp}`, 'success');
    };

    const updateGeneratedLinks = () => {
      if (generatedLinks.size === 0) {
        generatedLinksEl.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted); font-size: 12px;">아직 생성된 링크가 없습니다.</div>';
        return;
      }
      generatedLinksEl.innerHTML = '';
      generatedLinks.forEach((linkData, name) => {
        const item = document.createElement('div'); item.className = 'link-item';
        const playerUrl = `${window.location.origin}/player.html?battle=${currentBattle.id}&name=${encodeURIComponent(name)}&password=${linkData.otp}&team=${linkData.team}`;
        item.innerHTML = `
          <div class="link-info">
            <div class="link-name">${escapeHtml(name)}</div>
            <div class="link-team">${linkData.team}팀</div>
            <div class="link-url">${playerUrl}</div>
          </div>
          <button class="btn btn-copy btn-sm" onclick="copyToClipboard('${playerUrl}')">복사</button>
        `;
        generatedLinksEl.appendChild(item);
      });
    };

    const copySpectatorUrl = () => {
      if (!currentBattle || !spectatorOtp.textContent || spectatorOtp.textContent === '------') { showToast('먼저 관전자 비밀번호를 발급해주세요.', 'error'); return; }
      const url = `${window.location.origin}/spectator.html?battle=${currentBattle.id}&password=${spectatorOtp.textContent}`;
      copyToClipboard(url);
    };

    const copyPlayerUrl = () => {
      if (!currentBattle || !playerOtp.textContent || playerOtp.textContent === '------') { showToast('먼저 전투 참가자 비밀번호를 발급해주세요.', 'error'); return; }
      const name = playerNameForOtp.value.trim();
      const url = `${window.location.origin}/player.html?battle=${currentBattle.id}&name=${encodeURIComponent(name)}&password=${playerOtp.textContent}&team=A`;
      copyToClipboard(url);
    };

    const bindEvents = () => {
      btnCreate.addEventListener('click', () => {
        if (!socket) return;
        const mode = battleMode.value;
        socket.emit('createBattle', { mode });
        socket.emit('battle:create', { mode });
        btnCreate.disabled = true;
        addLog(`전투 생성 요청: ${mode}`, 'system');
      });

      btnStart.addEventListener('click', () => {
        if (!socket || !currentBattle) return;
        socket.emit('startBattle', { battleId: currentBattle.id });
        socket.emit('battle:start', { battleId: currentBattle.id });
        addLog('전투 시작 요청', 'system');
      });

      btnPause.addEventListener('click', () => {
        if (!socket || !currentBattle) return;
        socket.emit('pauseBattle', { battleId: currentBattle.id });
        socket.emit('battle:pause', { battleId: currentBattle.id });
        addLog('전투 일시정지 요청', 'system');
      });

      btnResume.addEventListener('click', () => {
        if (!socket || !currentBattle) return;
        socket.emit('resumeBattle', { battleId: currentBattle.id });
        socket.emit('battle:resume', { battleId: currentBattle.id });
        addLog('전투 재개 요청', 'system');
      });

      btnEnd.addEventListener('click', () => {
        if (!socket || !currentBattle) return;
        if (confirm('정말로 전투를 종료하시겠습니까?')) {
          socket.emit('endBattle', { battleId: currentBattle.id });
          socket.emit('battle:end', { battleId: currentBattle.id });
          addLog('전투 종료 요청', 'system');
        }
      });

      btnGenSpectator.addEventListener('click', generateSpectatorPassword);
      btnGenPlayerOtp.addEventListener('click', generatePlayerOTP);

      btnCopySpectatorUrl.addEventListener('click', copySpectatorUrl);
      btnCopyPlayerUrl.addEventListener('click', copyPlayerUrl);

      btnAddPlayer.addEventListener('click', addPlayer);

      btnSendChat.addEventListener('click', sendChat);
      chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendChat(); });

      playerNameForOtp.addEventListener('keydown', (e) => { if (e.key === 'Enter') generatePlayerOTP(); });
    };

    const addPlayer = async () => {
      const name = playerName.value.trim();
      if (!name) { showToast('참가자 이름을 입력해주세요.', 'error'); return; }
      if (!currentBattle) { showToast('먼저 전투를 생성해주세요.', 'error'); return; }

      const playerData = {
        battleId: currentBattle.id,
        name,
        team: playerTeam.value,
        hp: parseInt(playerHp.value) || 100,
        maxHp: parseInt(playerHp.value) || 100,
        stats: {
          attack: parseInt(statAttack.value) || 3,
          defense: parseInt(statDefense.value) || 3,
          agility: parseInt(statAgility.value) || 3,
          luck: parseInt(statLuck.value) || 2
        },
        items: {
          dittany: parseInt(itemDittany.value) || 0,
          attack_boost: parseInt(itemAtkBoost.value) || 0,
          defense_boost: parseInt(itemDefBoost.value) || 0
        }
      };

      // ★ 변경: 아바타 업로드 API 경로 및 응답키(url/fileUrl/publicUrl) 호환
      if (avatarFile.files[0]) {
        try {
          const formData = new FormData();
          formData.append('avatar', avatarFile.files[0]);
          formData.append('playerId', Date.now().toString());

          const response = await fetch(`/api/upload/avatar`, {
            method: 'POST',
            body: formData
          });

          if (response.ok) {
            const result = await response.json();
            playerData.avatar = result.url || result.fileUrl || result.publicUrl || '';
          } else {
            addLog('아바타 업로드 실패: 응답 오류', 'error');
          }
        } catch (err) {
          console.error('아바타 업로드 실패:', err);
          addLog('아바타 업로드 실패: 네트워크 오류', 'error');
        }
      }

      socket.emit('addPlayer', playerData);
      socket.emit('player:add', playerData);

      resetPlayerForm();
    };

    const resetPlayerForm = () => {
      playerName.value = '';
      playerHp.value = '100';
      avatarFile.value = '';
      avatarPreview.style.backgroundImage = '';
      avatarPreview.textContent = '미리보기';
      statAttack.value = '3';
      statDefense.value = '3';
      statAgility.value = '3';
      statLuck.value = '2';
      itemDittany.value = '1';
      itemAtkBoost.value = '0';
      itemDefBoost.value = '0';
    };

    const sendChat = () => {
      const message = chatInput.value.trim();
      if (!message || !socket || !currentBattle) return;
      socket.emit('chatMessage', { battleId: currentBattle.id, name: '관리자', message });
      socket.emit('battle:chat', { battleId: currentBattle.id, name: '관리자', senderName: '관리자', message });
      chatInput.value = '';
      addLog(`[채팅] 관리자: ${message}`, 'info');
    };

    // 디버깅용
    window.debugSocketEvents = () => {
      addLog('소켓 이벤트 디버깅 시작', 'system');
      const originalEmit = socket.emit;
      socket.emit = function(...args) {
        addLog(`[송신] ${args[0]}: ${JSON.stringify(args[1] || {})}`, 'info');
        return originalEmit.apply(this, args);
      };
      if (socket.connected) addLog('소켓 연결 상태: 정상', 'success');
      else addLog('소켓 연결 상태: 끊어짐', 'error');
      if (currentBattle) addLog(`현재 전투: ${currentBattle.id} (${currentBattle.status})`, 'info');
      else addLog('현재 전투: 없음', 'error');
    };
    window.testConnection = () => {
      if (!socket) { addLog('소켓이 초기화되지 않았습니다.', 'error'); return; }
      if (!socket.connected) { addLog('소켓이 연결되지 않았습니다. 재연결 시도...', 'error'); socket.connect(); return; }
      socket.emit('ping', { timestamp: Date.now() });
      addLog('핑 테스트 전송', 'info');
      fetch('/api/health').then(r=>r.json()).then(d=> addLog(`서버 상태: ${d.ok?'정상':'오류'}`, d.ok?'success':'error')).catch(e=> addLog(`서버 헬스체크 실패: ${e.message}`, 'error'));
    };

    const init = () => {
      connectSocket();
      bindEvents();
      addLog('PYXIS 관리자 콘솔이 시작되었습니다.', 'system');
    };
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
