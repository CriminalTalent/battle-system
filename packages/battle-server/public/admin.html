<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Pyxis - 전투 관리자</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="/socket.io/socket.io.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@500;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --deep:#0a0f1a; --mid:#121827; --mist:#1a202c;
      --glass: rgba(201,169,110,.06); --glass2: rgba(201,169,110,.10);
      --line: rgba(201,169,110,.18);  --line2: rgba(201,169,110,.28);

      --gold:#c9a96e; --gold-d:#b8985f; --gold-b:#e0c494; --shim:#f2e5c7;

      --text:#f8f4ec; --text2:#d4c7b0; --muted:#9a8d7a;
      --phoenix:#d2691e; --death:#2f4f2f;

      --radius:16px;
      --serif:'Playfair Display',serif; --sans:'Inter',system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text); font-family:var(--sans);
      background:
        radial-gradient(1000px 800px at 12% -10%, rgba(201,169,110,.08), transparent 60%),
        radial-gradient(900px 700px at 88% 110%, rgba(201,169,110,.06), transparent 60%),
        linear-gradient(135deg, var(--deep), var(--mid) 50%, var(--mist));
    }
    .container{max-width:1400px;margin:auto;padding:20px}
    .title{
      font-family:var(--serif); font-weight:700; text-align:center;
      font-size:clamp(28px,4.2vw,40px); letter-spacing:.04em; margin:6px 0 18px;
      background:linear-gradient(135deg,var(--gold),var(--shim),var(--gold-b));
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
      position:relative; display:block;
    }
    .title::before,.title::after{
      content:'✦'; position:absolute; top:-6px; color:var(--gold-b); font-size:.55em;
      animation:twinkle 2.6s ease-in-out infinite alternate;
    }
    .title::before{left:12%} .title::after{right:12%; animation-delay:1.1s}
    @keyframes twinkle{0%,100%{opacity:.5; transform:scale(.85)} 50%{opacity:1; transform:scale(1.2)}}

    .card{
      background:linear-gradient(145deg, rgba(201,169,110,.05), var(--glass));
      border:1px solid var(--line); border-radius:var(--radius);
      padding:16px; margin-bottom:18px; backdrop-filter:blur(14px);
      box-shadow:0 8px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
      transition:box-shadow .25s ease, border-color .25s ease, transform .2s ease;
    }
    .card:hover{border-color:var(--line2); transform:translateY(-2px)}
    .card-title{font-family:var(--serif); color:var(--gold-b); margin:0 0 10px; font-weight:600}

    .topbar{display:grid; grid-template-columns:repeat(4,1fr); gap:12px;
      background:linear-gradient(145deg, rgba(201,169,110,.06), var(--glass2));
      border:1px solid var(--line); border-radius:var(--radius); padding:12px; margin-bottom:18px}
    .topcell{font-weight:600; color:var(--text2)} .topcell span{color:var(--gold)}

    .battlefield{display:grid; grid-template-columns:1fr 1.8fr 1fr; gap:20px}
    @media (max-width:1200px){ .battlefield{grid-template-columns:1fr 1fr} .center{grid-column:1/-1; order:-1} }
    @media (max-width:800px){ .battlefield{grid-template-columns:1fr} .topbar{grid-template-columns:1fr} }

    .zone{position:relative; background:linear-gradient(145deg, rgba(201,169,110,.06), rgba(201,169,110,.08));
      border:1px solid var(--line); border-radius:var(--radius); padding:16px; box-shadow:0 8px 22px rgba(0,0,0,.3)}
    .zone::before{content:''; position:absolute; top:0; left:0; right:0; height:3px; opacity:1}
    .phoenix::before{background:linear-gradient(90deg, var(--phoenix), transparent)}
    .death::before{background:linear-gradient(90deg, var(--death), transparent)}

    .zone-header{display:flex; align-items:center; justify-content:space-between; margin-bottom:12px}
    .zone-title{font-family:var(--serif); font-weight:700; color:var(--gold-b)}
    .badge{padding:4px 8px; border-radius:12px; font-size:11px; font-weight:700; border:1px solid var(--line)}
    .phoenix .badge{background:rgba(210,105,30,.2); color:#ff8c42; border-color:#d2691e}
    .death .badge{background:rgba(47,79,47,.2); color:#90ee90; border-color:#2f4f2f}

    .form-grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .stats-grid{display:grid; grid-template-columns:repeat(4,1fr); gap:8px}
    .inv-grid{display:grid; grid-template-columns:repeat(3,1fr); gap:8px}
    label{display:block; font-size:12px; color:var(--gold-b); font-weight:600; margin:4px 0}
    input, select, button{
      width:100%; padding:10px; border-radius:10px; outline:none; font-size:14px;
      transition:.2s ease; border:1px solid var(--line); background:rgba(16,21,35,.75); color:var(--text)
    }
    input:focus, select:focus{border-color:var(--gold); box-shadow:0 0 0 2px rgba(201,169,110,.18)}

    .btn{border:1px solid var(--gold-d); background:linear-gradient(135deg, var(--gold-d), var(--gold)); color:#091018; font-weight:700; cursor:pointer}
    .btn:hover{filter:brightness(1.06)} .btn:active{transform:translateY(1px)}
    .btn-ghost{background:rgba(16,21,35,.65); border:1px solid var(--line); color:var(--text); font-weight:600}
    .btn-ghost:hover{border-color:var(--line2)}
    .btn-danger{background:linear-gradient(135deg,#8d3f3a,#b24e49); color:#fff; border:none}
    .btn-success{background:linear-gradient(135deg,#2d5a3d,#4a7c59); color:#fff; border:none}
    .muted{color:var(--muted); font-size:12px}
    .player-card{border:1px solid var(--line); border-radius:12px; padding:10px; background:rgba(12,16,26,.65); margin-bottom:10px}

    .log, .chat{height:260px; overflow:auto; border:1px solid var(--line); border-radius:12px; padding:10px; background:rgba(12,16,26,.6)}
    .line{padding:4px 6px; border-radius:6px; margin:2px 0}
    .line:hover{background:rgba(201,169,110,.06)}
    .line .t{color:var(--muted); margin-right:6px; font-weight:600}
    .tag{display:inline-block; padding:2px 6px; border-radius:999px; border:1px solid var(--line); font-size:10px; font-weight:600; margin-right:6px}
    .tag-admin{background:var(--shim); color:#0a0f1a; border-color:var(--shim)}
    .tag-team{background:var(--gold); color:#0a0f1a; border-color:var(--gold)}

    .modal{position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:50}
    .modal.show{display:flex}
    .modal-card{width:min(700px,95vw); max-height:90vh; overflow:auto; background:linear-gradient(145deg, rgba(201,169,110,.06), rgba(201,169,110,.1)); border:1px solid var(--line); border-radius:16px; padding:18px}
    .link-row{display:flex; gap:8px; margin-bottom:8px} .link-row input{flex:1}
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">Pyxis 전투 관리자</h1>

    <div class="topbar" id="statusBar">
      <div class="topcell">전투 상태: <span id="sStatus">-</span></div>
      <div class="topcell">현재 팀: <span id="sTeam">-</span></div>
      <div class="topcell">라운드/턴: <span id="sRound">-</span></div>
      <div class="topcell">플레이어 수: <span id="sCount">0</span></div>
    </div>

    <!-- 인증/빠른 생성 -->
    <section class="card" id="authCard">
      <h2 class="card-title">관리자 인증 & 전투 생성</h2>

      <div class="card" style="border-style:dashed; margin-bottom:14px">
        <h3 class="card-title" style="margin:0 0 10px">빠른 전투 생성</h3>
        <div style="display:grid; grid-template-columns:1fr 120px; gap:10px">
          <div>
            <label>전투 모드</label>
            <select id="quickMode">
              <option value="1v1">1 vs 1</option>
              <option value="2v2">2 vs 2</option>
              <option value="3v3">3 vs 3</option>
              <option value="4v4">4 vs 4</option>
            </select>
          </div>
          <button id="btnQuickCreate" class="btn">생성</button>
        </div>
        <p class="muted" style="margin-top:8px">생성 후 전투ID/관리자OTP가 자동 입력되고 즉시 인증됩니다.</p>
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
        <div>
          <label>전투 ID</label>
          <input id="battleId" placeholder="전투 ID"/>
        </div>
        <div>
          <label>관리자 OTP</label>
          <input id="adminOtp" placeholder="관리자 OTP"/>
        </div>
      </div>
      <div style="display:flex; gap:10px; margin-top:10px">
        <button id="btnAdminAuth" class="btn" style="flex:1">인증</button>
        <button id="btnFetchBattle" class="btn-ghost" style="width:120px">조회</button>
      </div>
      <p class="muted" style="margin-top:8px">URL의 ?battle=, ?token= 값이 있으면 자동 입력됩니다.</p>
    </section>

    <!-- 메인 패널 -->
    <section id="adminPanel" class="card" style="display:none">
      <!-- 전투 제어 -->
      <div class="card" style="border-color:var(--gold)">
        <h3 class="card-title">전투 제어</h3>
        <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:8px">
          <button id="btnStart" class="btn">전투 시작</button>
          <button id="btnPause" class="btn-ghost">일시정지/재개</button>
          <button id="btnEnd" class="btn-danger">전투 종료</button>
          <button id="btnLinks" class="btn-success">링크 관리</button>
        </div>
      </div>

      <div class="battlefield">
        <!-- 불사조 -->
        <div class="zone phoenix">
          <div class="zone-header">
            <div class="zone-title">불사조 기사단</div>
            <div class="badge">PHOENIX</div>
          </div>

          <div class="card" style="padding:12px">
            <div class="form-grid">
              <div>
                <label>이름</label>
                <input id="ph_name" placeholder="플레이어 이름"/>
              </div>
              <div>
                <label>아바타 파일 (선택)</label>
                <input id="ph_avatar" type="file" accept="image/*"/>
              </div>
            </div>
            <div class="stats-grid" style="margin-top:6px">
              <div><label>공격</label><input id="ph_atk" type="number" min="1" max="5" value="3"/></div>
              <div><label>방어</label><input id="ph_def" type="number" min="1" max="5" value="3"/></div>
              <div><label>민첩</label><input id="ph_agi" type="number" min="1" max="5" value="3"/></div>
              <div><label>행운</label><input id="ph_luk" type="number" min="1" max="5" value="3"/></div>
            </div>
            <div class="inv-grid" style="margin-top:6px">
              <div><label>공격 보정기</label><input id="ph_i_atk" type="number" min="0" max="3" value="1"/></div>
              <div><label>방어 보정기</label><input id="ph_i_def" type="number" min="0" max="3" value="1"/></div>
              <div><label>디터니</label><input id="ph_i_heal" type="number" min="0" max="5" value="2"/></div>
            </div>
            <button id="btnAddPh" class="btn" style="margin-top:10px">불사조에 추가</button>
          </div>

          <div id="ph_list"></div>
        </div>

        <!-- 중앙 -->
        <div class="zone center" style="border-color:var(--gold)">
          <h3 class="card-title" style="margin-top:0">전투 로그</h3>
          <div id="logBox" class="log"></div>

          <h3 class="card-title" style="margin:12px 0 8px">관리자 채팅</h3>
          <div id="chatBox" class="chat"></div>
          <div style="display:flex; gap:8px; margin-top:8px">
            <input id="adminChatInput" placeholder="메시지 입력… /t 로 팀채팅 아님(관리자는 전체 고정)"/>
            <button id="btnSendChat" class="btn" style="width:130px">보내기</button>
          </div>
          <div style="display:flex; gap:8px; margin-top:10px">
            <button id="btnClearLog" class="btn-ghost" style="flex:1">로그 지우기</button>
            <button id="btnReload" class="btn-ghost" style="flex:1">새로고침</button>
          </div>
        </div>

        <!-- 죽먹자 -->
        <div class="zone death">
          <div class="zone-header">
            <div class="zone-title">죽음을 먹는 자들</div>
            <div class="badge">DEATH EATER</div>
          </div>

          <div class="card" style="padding:12px">
            <div class="form-grid">
              <div>
                <label>이름</label>
                <input id="de_name" placeholder="플레이어 이름"/>
              </div>
              <div>
                <label>아바타 파일 (선택)</label>
                <input id="de_avatar" type="file" accept="image/*"/>
              </div>
            </div>
            <div class="stats-grid" style="margin-top:6px">
              <div><label>공격</label><input id="de_atk" type="number" min="1" max="5" value="3"/></div>
              <div><label>방어</label><input id="de_def" type="number" min="1" max="5" value="3"/></div>
              <div><label>민첩</label><input id="de_agi" type="number" min="1" max="5" value="3"/></div>
              <div><label>행운</label><input id="de_luk" type="number" min="1" max="5" value="3"/></div>
            </div>
            <div class="inv-grid" style="margin-top:6px">
              <div><label>공격 보정기</label><input id="de_i_atk" type="number" min="0" max="3" value="1"/></div>
              <div><label>방어 보정기</label><input id="de_i_def" type="number" min="0" max="3" value="1"/></div>
              <div><label>디터니</label><input id="de_i_heal" type="number" min="0" max="5" value="2"/></div>
            </div>
            <button id="btnAddDe" class="btn" style="margin-top:10px">죽먹자에 추가</button>
          </div>

          <div id="de_list"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- 링크 모달 -->
  <div id="linkModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px">
        <h3 class="card-title" style="margin:0">참여 링크 관리</h3>
        <button id="btnCloseModal" class="btn-ghost" style="width:auto; padding:6px 10px">닫기</button>
      </div>

      <h4 style="margin:8px 0; color:var(--gold-b)">관리자</h4>
      <div class="link-row"><input id="linkAdmin" readonly/><button class="btn" id="copyAdmin" style="width:100px">복사</button></div>

      <h4 style="margin:8px 0; color:var(--gold-b)">관전자</h4>
      <div class="link-row"><input id="linkSpectator" readonly/><button class="btn" id="copySpectator" style="width:100px">복사</button></div>

      <h4 style="margin:8px 0; color:var(--gold-b)">불사조 기사단</h4>
      <div id="phoenixLinks"></div>

      <h4 style="margin:8px 0; color:var(--gold-b)">죽음을 먹는 자들</h4>
      <div id="deathLinks"></div>

      <div style="display:flex; gap:8px; margin-top:12px">
        <button id="btnCopyAll" class="btn" style="flex:1">모든 링크 복사</button>
        <button id="btnRefreshLinks" class="btn-ghost" style="width:120px">새로고침</button>
      </div>
    </div>
  </div>

<script>
(() => {
  'use strict';
  const $  = (s)=>document.querySelector(s);
  const $$ = (s)=>document.querySelectorAll(s);
  const esc=(s='')=>String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const t  =(ms)=>new Date(ms).toLocaleTimeString();

  // 엘리먼트
  const sStatus = $('#sStatus'), sTeam=$('#sTeam'), sRound=$('#sRound'), sCount=$('#sCount');

  const authCard = $('#authCard');
  const adminPanel = $('#adminPanel');

  const battleIdInput = $('#battleId');
  const adminOtpInput = $('#adminOtp');
  const btnAdminAuth  = $('#btnAdminAuth');
  const btnFetchBattle= $('#btnFetchBattle');
  const btnQuickCreate= $('#btnQuickCreate');
  const quickMode     = $('#quickMode');

  const btnStart = $('#btnStart'), btnPause = $('#btnPause'), btnEnd = $('#btnEnd'), btnLinks = $('#btnLinks');
  const logBox = $('#logBox'), chatBox = $('#chatBox');
  const adminChatInput = $('#adminChatInput');
  const btnSendChat = $('#btnSendChat');
  const btnClearLog = $('#btnClearLog'), btnReload = $('#btnReload');

  const linkModal = $('#linkModal'), btnCloseModal = $('#btnCloseModal');
  const linkAdmin=$('#linkAdmin'), linkSpectator=$('#linkSpectator');
  const copyAdmin=$('#copyAdmin'), copySpectator=$('#copySpectator');
  const btnCopyAll = $('#btnCopyAll'), btnRefreshLinks = $('#btnRefreshLinks');
  const phoenixLinks = $('#phoenixLinks'), deathLinks = $('#deathLinks');

  const ph = {
    name: $('#ph_name'), avatar: $('#ph_avatar'),
    atk: $('#ph_atk'), def: $('#ph_def'), agi: $('#ph_agi'), luk: $('#ph_luk'),
    i_atk: $('#ph_i_atk'), i_def: $('#ph_i_def'), i_heal: $('#ph_i_heal'),
    list: $('#ph_list'),
  };
  const de = {
    name: $('#de_name'), avatar: $('#de_avatar'),
    atk: $('#de_atk'), def: $('#de_def'), agi: $('#de_agi'), luk: $('#de_luk'),
    i_atk: $('#de_i_atk'), i_def: $('#de_i_def'), i_heal: $('#de_i_heal'),
    list: $('#de_list'),
  };

  let socket = null;
  let currentBattleId = null;
  let currentBattle = null;

  // ===== 공통 =====
  function qs() {
    const p = new URLSearchParams(location.search);
    return { battle: p.get('battle') || p.get('b'), token: p.get('token') || p.get('otp') };
  }
  function setStatus(b) {
    if (!b) return;
    sStatus.textContent = b.status || '-';
    sTeam.textContent = b.currentTeam === 'team1' ? '불사조 기사단' :
                        b.currentTeam === 'team2' ? '죽음을 먹는 자들' : '-';
    sRound.textContent = `${b.roundNumber ?? '-'} / ${b.turnNumber ?? '-'}`;
    const cnt = (b.teams?.team1?.players?.length || 0) + (b.teams?.team2?.players?.length || 0);
    sCount.textContent = String(cnt);
  }
  function renderRoster(b) {
    const painter = (teamKey, root) => {
      const team = b.teams?.[teamKey] || { players: [] };
      root.innerHTML = (team.players || []).map(p => `
        <div class="player-card">
          <div style="display:flex; align-items:center; gap:10px; justify-content:space-between">
            <div style="display:flex; gap:10px; align-items:center">
              <div style="width:40px;height:40px;border-radius:50%;border:1px solid var(--line);
                background:${p.imageUrl?`url('${esc(p.imageUrl)}') center/cover`:`linear-gradient(135deg,#0f1724,#1b2232)`}">
              </div>
              <div>
                <div style="font-weight:700">${esc(p.name)}</div>
                <div style="font-size:12px; color:var(--muted)">ATK ${p.stats?.attack} · DEF ${p.stats?.defense} · AGI ${p.stats?.agility} · LUK ${p.stats?.luck}</div>
              </div>
            </div>
            <div style="display:flex; gap:6px">
              <button class="btn-ghost" data-copy="${esc(p.name)}">링크</button>
              <button class="btn-danger" data-remove="${esc(p.id)}">제거</button>
            </div>
          </div>
          <div style="font-size:12px; color:var(--text2); margin-top:6px">인벤토리: ${(p.inventory||[]).join(', ') || '없음'}</div>
        </div>
      `).join('') || `<div class="muted">플레이어 없음</div>`;
      root.querySelectorAll('[data-remove]').forEach(btn=>{
        btn.addEventListener('click',()=>removePlayer(b.id, btn.dataset.remove));
      });
      root.querySelectorAll('[data-copy]').forEach(btn=>{
        btn.addEventListener('click',()=>openLinks(true)); // 모달에서 개별 링크 복사
      });
    };
    painter('team1', ph.list);
    painter('team2', de.list);
  }
  function renderLog(b) {
    logBox.innerHTML = (b.battleLog || []).map(e => `<div class="line"><span class="t">[${t(e.timestamp)}]</span>${esc(e.message||'')}</div>`).join('');
    logBox.scrollTop = logBox.scrollHeight;
  }
  function renderChat(b) {
    chatBox.innerHTML = (b.chatLog || []).map(c=>{
      const tag = c.senderType === 'admin' ? '<span class="tag tag-admin">관리자</span>'
                 : (c.channel==='team' ? '<span class="tag tag-team">팀</span>' : '<span class="tag">전체</span>');
      return `<div class="line"><span class="t">[${t(c.timestamp)}]</span>${tag} <b>${esc(c.sender||'-')}</b>: ${esc(c.message||'')}</div>`;
    }).join('');
    chatBox.scrollTop = chatBox.scrollHeight;
  }
  function hydrate(b){
    currentBattle = b; setStatus(b); renderRoster(b); renderLog(b); renderChat(b);
  }

  // ===== 소켓 =====
  function connect(){
    if (socket) { try{ socket.disconnect(); }catch(_){ } }
    socket = io({ path: '/socket.io/', transports: ['websocket','polling'] });

    socket.on('connect', ()=> {
      socket.emit('adminAuth', { battleId: currentBattleId, otp: adminOtpInput.value.trim() });
    });
    socket.on('authSuccess', (data) => {
      if (data?.battle) hydrate(data.battle);
      authCard.style.display = 'none';
      adminPanel.style.display = 'block';
    });
    socket.on('authError', (msg)=> alert(msg || '인증 실패'));

    socket.on('battleUpdate', (b)=> hydrate(b));

    socket.on('chatMessage', ({sender, senderType, message, channel, timestamp})=>{
      const line = document.createElement('div');
      const tag = senderType === 'admin' ? '<span class="tag tag-admin">관리자</span>'
                : (channel==='team' ? '<span class="tag tag-team">팀</span>' : '<span class="tag">전체</span>');
      line.className = 'line';
      line.innerHTML = `<span class="t">[${t(timestamp)}]</span>${tag} <b>${esc(sender||'-')}</b>: ${esc(message||'')}`;
      chatBox.appendChild(line);
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    socket.on('connect_error', (e)=> console.warn('Socket error:', e?.message || e));
  }

  // ===== API =====
  async function api(method, url, body, isForm=false) {
    const res = await fetch(url, {
      method,
      headers: isForm? {} : { 'Content-Type':'application/json' },
      body: body ? (isForm ? body : JSON.stringify(body)) : undefined,
    });
    if (!res.ok) throw new Error(`${res.status}`);
    return res.json();
  }

  // 업로드 후 URL 반환
  async function uploadAvatar(file){
    if(!file) return '';
    const fd = new FormData();
    fd.append('avatar', file);
    const res = await fetch('/api/upload/avatar', { method:'POST', body: fd });
    if(!res.ok) throw new Error('upload_failed');
    const json = await res.json();
    return json.url || '';
  }

  // 플레이어 추가
  async function addPlayer(teamKey, refs){
    if(!currentBattleId) return alert('전투가 없습니다.');
    const name = refs.name.value.trim();
    if(!name) return alert('이름을 입력하세요.');

    let imageUrl = '';
    if (refs.avatar.files && refs.avatar.files[0]) {
      try { imageUrl = await uploadAvatar(refs.avatar.files[0]); }
      catch { return alert('아바타 업로드 실패'); }
    }

    const stats = {
      attack: Number(refs.atk.value||3),
      defense: Number(refs.def.value||3),
      agility: Number(refs.agi.value||3),
      luck: Number(refs.luk.value||3),
    };
    const inventory = [];
    const nAtk = Number(refs.i_atk.value||0);
    const nDef = Number(refs.i_def.value||0);
    const nHeal= Number(refs.i_heal.value||0);
    for(let i=0;i<nAtk;i++) inventory.push('공격 보정기');
    for(let i=0;i<nDef;i++) inventory.push('방어 보정기');
    for(let i=0;i<nHeal;i++) inventory.push('디터니');

    try {
      const res = await api('POST', `/api/battles/${currentBattleId}/players`, {
        name, team: teamKey, stats, inventory, imageUrl
      });
      if (!res?.ok) throw new Error('fail');
      // 폼 초기화(이름/파일만)
      refs.name.value = '';
      refs.avatar.value = '';
    } catch {
      return alert('추가 실패');
    }
    // 최신화
    await refreshBattle();
  }

  async function removePlayer(battleId, playerId){
    if(!confirm('정말 제거하시겠습니까?')) return;
    try {
      await api('DELETE', `/api/battles/${battleId}/players/${playerId}`);
      await refreshBattle();
    } catch {
      alert('제거 실패');
    }
  }

  async function refreshBattle(){
    if(!currentBattleId) return;
    try{
      const b = await api('GET', `/api/battles/${currentBattleId}`);
      hydrate(b);
    }catch{}
  }

  async function openLinks(scrollToPlayerSection=false){
    if(!currentBattleId) return;
    try{
      const data = await api('POST', `/api/admin/battles/${currentBattleId}/links`);
      linkAdmin.value     = data.urls?.admin     || '';
      linkSpectator.value = data.urls?.spectator || '';

      const renderList = (list, root) => {
        root.innerHTML = (list||[]).map(p => `
          <div class="link-row">
            <input readonly value="${esc(p.url)}"/>
            <button class="btn" data-copy="${esc(p.url)}" style="width:90px">복사</button>
          </div>
        `).join('') || `<div class="muted">플레이어 없음</div>`;
        root.querySelectorAll('[data-copy]').forEach(btn=>{
          btn.addEventListener('click', ()=>navigator.clipboard.writeText(btn.dataset.copy||''));
        });
      };
      const pList = (data.playerLinks||[]).filter(p=>p.team==='team1');
      const dList = (data.playerLinks||[]).filter(p=>p.team==='team2');
      renderList(pList, phoenixLinks);
      renderList(dList, deathLinks);

      linkModal.classList.add('show');
      if (scrollToPlayerSection) {
        phoenixLinks.scrollIntoView({behavior:'smooth'});
      }
    }catch{
      alert('링크 생성 실패');
    }
  }

  // ===== 이벤트 바인딩 =====
  $('#btnAddPh').addEventListener('click', ()=>addPlayer('team1', ph));
  $('#btnAddDe').addEventListener('click', ()=>addPlayer('team2', de));

  btnStart.addEventListener('click', async ()=>{
    try{ await api('POST', `/api/admin/battles/${currentBattleId}/start`); await refreshBattle(); }
    catch(e){ alert('시작 실패: 최소 각 팀 1명 필요'); }
  });
  btnPause.addEventListener('click', async ()=>{
    try{ await api('POST', `/api/admin/battles/${currentBattleId}/pause`); await refreshBattle(); }
    catch(e){ alert('일시정지 실패'); }
  });
  btnEnd.addEventListener('click', async ()=>{
    if(!confirm('전투를 종료할까요?')) return;
    try{ await api('POST', `/api/admin/battles/${currentBattleId}/end`); await refreshBattle(); }
    catch(e){ alert('종료 실패'); }
  });

  btnLinks.addEventListener('click', ()=>openLinks());
  btnCloseModal.addEventListener('click', ()=> linkModal.classList.remove('show'));
  btnRefreshLinks.addEventListener('click', ()=> openLinks());
  copyAdmin.addEventListener('click', ()=> navigator.clipboard.writeText(linkAdmin.value||''));
  copySpectator.addEventListener('click', ()=> navigator.clipboard.writeText(linkSpectator.value||''));
  btnCopyAll.addEventListener('click', async ()=>{
    const all = [linkAdmin.value, linkSpectator.value];
    $$('#phoenixLinks input, #deathLinks input').forEach(i=> all.push(i.value));
    await navigator.clipboard.writeText(all.filter(Boolean).join('\n'));
    alert('복사되었습니다.');
  });

  btnSendChat.addEventListener('click', ()=>{
    const msg = adminChatInput.value.trim();
    if (!msg) return;
    if (!socket || socket.disconnected) return alert('연결이 끊겼습니다.');
    // 관리자 채팅은 항상 전체 채널
    socket.emit('chatMessage', { message: msg, channel: 'all' });
    adminChatInput.value = '';
  });
  adminChatInput.addEventListener('keydown',(e)=>{
    if (e.key === 'Enter') { e.preventDefault(); btnSendChat.click(); }
  });

  btnClearLog.addEventListener('click', ()=>{
    logBox.innerHTML='';
  });
  btnReload.addEventListener('click', refreshBattle);

  btnQuickCreate.addEventListener('click', async ()=>{
    try{
      const r = await api('POST','/api/battles',{ mode: quickMode.value });
      battleIdInput.value = r.battle.id;
      adminOtpInput.value = r.battle.otps.admin;
      currentBattleId = r.battle.id;
      connect();
    }catch{
      alert('생성 실패');
    }
  });

  btnAdminAuth.addEventListener('click', ()=>{
    const bid = battleIdInput.value.trim();
    const otp = adminOtpInput.value.trim();
    if (!bid || !otp) return alert('전투ID/OTP를 입력하세요.');
    currentBattleId = bid;
    connect();
  });

  btnFetchBattle.addEventListener('click', async ()=>{
    const bid = battleIdInput.value.trim();
    if (!bid) return alert('전투ID를 입력하세요.');
    try{
      const b = await api('GET', `/api/battles/${bid}`);
      hydrate(b);
      currentBattleId = bid;
    }catch{
      alert('조회 실패');
    }
  });

  // 부팅
  (function boot(){
    const q = qs();
    if (q.battle) battleIdInput.value = q.battle;
    if (q.token)  adminOtpInput.value = q.token;
    if (q.battle && q.token) {
      currentBattleId = q.battle;
      connect();
    }
  })();
})();
</script>
</body>
</html>
