<!-- packages/battle-server/public/admin.html -->
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>PYXIS | 관리자</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400..900&display=swap" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root{
      --bg:#0b1020; --bg2:#09122a; --panel:#0f1830; --panel2:#0c1428;
      --ink:#e8e2cf; --ink-dim:#b8b3a2;
      --gold:#e4c476; --gold-2:#c9ab5f; --gold-3:#a98b45;
      --line:#28324a; --line-subtle:#1c2540;
      --glass: blur(10px) saturate(120%);
      --shadow-1: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
      --top-line: 0 -1px 0 rgba(255,255,255,.06) inset, 0 1px 0 rgba(0,0,0,.4) inset;
      --grad-gold: linear-gradient(90deg,#f6e3a1,#e4c476,#d2b062);
      --grad-card: radial-gradient(1200px 600px at 10% -10%,rgba(255,255,255,.06),transparent 40%),
                   radial-gradient(1000px 600px at 110% -20%,rgba(255,215,160,.08),transparent 50%),
                   linear-gradient(180deg,rgba(20,28,50,.7),rgba(8,10,22,.8));
      --grad-btn: linear-gradient(180deg,#2a3c66,#192746);
      --grad-btn-gold: linear-gradient(180deg,#f2d98b,#d0b266);
      --st-wait:#6a7aa5; --st-go:#49c07d; --st-pause:#d5a746; --st-end:#c04c4c;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--ink);
      background:
        radial-gradient(1000px 500px at 50% -10%, rgba(255,255,255,.05), transparent 60%),
        linear-gradient(180deg, #0a0f1e, #080c18 60%, #060a14);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
      line-height:1.45;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:16px;animation:fadeIn .5s ease both}
    @keyframes fadeIn{from{opacity:.0; transform:translateY(6px)}to{opacity:1; transform:none}}

    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{font-family:"Cinzel", serif; letter-spacing:.06em; font-weight:800; font-size:20px;
      background:var(--grad-gold); -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow:0 0 20px rgba(226,197,118,.15);}

    .tools{display:flex;gap:8px;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0c1526a6;backdrop-filter:var(--glass)}
    .pill.wait{border-color:var(--st-wait); color:var(--st-wait)}
    .pill.go{border-color:var(--st-go); color:var(--st-go)}
    .pill.pause{border-color:var(--st-pause); color:var(--st-pause)}
    .pill.end{border-color:var(--st-end); color:var(--st-end)}

    .grid{display:grid;grid-template-columns:1.1fr 1fr;gap:14px}
    @media (max-width: 1000px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--grad-card); border:1px solid var(--line); border-radius:16px; padding:14px; position:relative;
      backdrop-filter:var(--glass); box-shadow:var(--shadow-1)}
    .card::before{content:""; position:absolute; inset:0; pointer-events:none; border-radius:16px; box-shadow:var(--top-line)}
    .card .title{display:flex;align-items:center;gap:8px;margin:0 0 10px 0;color:var(--gold)}
    .title .dot{width:8px;height:8px;border-radius:999px;background:var(--gold-2); box-shadow:0 0 10px rgba(240,205,110,.5)}

    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--ink-dim)}
    .input, select, textarea{background:rgba(12,20,38,.7); color:var(--ink);
      border:1px solid var(--line); border-radius:12px; padding:10px; backdrop-filter:var(--glass); outline:none}
    .input::placeholder{color:#7f86a1}
    .btn{border:1px solid var(--line); color:var(--ink); padding:10px 12px; border-radius:12px; cursor:pointer; background:var(--grad-btn); transition:transform .15s ease}
    .btn:hover{transform:translateY(-1px)}
    .btn.gold{border-color:var(--gold-3); background:var(--grad-btn-gold); color:#261b06}
    .btn.warn{border-color:#7a5a20; background:linear-gradient(180deg,#caa455,#9a7a36); color:#231a07}
    .btn.danger{border-color:#6b2b2b; background:linear-gradient(180deg,#c95b5b,#983f3f)}
    .btn.success{border-color:#2f6e53; background:linear-gradient(180deg,#3d996f,#2a6b50)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .list{display:grid;gap:8px}
    .unit{display:flex;gap:10px;align-items:center;padding:10px;border:1px solid var(--line);border-radius:12px;background:rgba(16,22,40,.55)}
    .unit .name{font-weight:600}
    .bar{height:8px;background:#202a44;border-radius:8px;overflow:hidden}
    .bar>span{display:block;height:100%;background:linear-gradient(90deg,#4da3ff,#67e8f9)}

    .chat{height:340px;overflow:auto;background:rgba(10,16,32,.7);border:1px solid var(--line);border-radius:12px;padding:10px; backdrop-filter:var(--glass)}
    .chat .row{display:flex;gap:8px;align-items:baseline; margin-bottom:6px}
    .chat .ts{font-size:11px;color:#8aa0c2;min-width:54px}
    .chat .sys .msg{color:#9fb0d0}
    .chat .cheer .msg{color:#a6e6a6}
    .chat .me .msg{color:#e8d4a8}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="brand">PYXIS</div>
      <div class="muted">Administrator Console</div>
    </div>
    <div class="tools">
      <span id="statusPill" class="pill wait">대기중</span>
    </div>
  </header>

  <div class="grid">
    <div class="card">
      <h3 class="title"><span class="dot"></span> 전투 생성 및 인증</h3>
      <div class="grid3">
        <label class="muted">전투 모드
          <select id="mode" class="input" style="width:100%">
            <option value="1v1">1 vs 1</option>
            <option value="2v2" selected>2 vs 2</option>
            <option value="3v3">3 vs 3</option>
            <option value="4v4">4 vs 4</option>
          </select>
        </label>
        <div></div>
        <div class="row" style="justify-content:flex-end">
          <button id="btnCreate" class="btn gold">생성</button>
        </div>
      </div>

      <div style="height:8px"></div>
      <div class="grid3">
        <label>전투 ID
          <input id="battleId" class="input mono" placeholder="생성 후 자동 입력" readonly>
        </label>
        <label>관리자 OTP
          <input id="adminOtp" class="input mono" placeholder="생성 후 자동 입력" readonly>
        </label>
        <label>관전자 OTP
          <input id="spectatorOtp" class="input mono" placeholder="생성 후 자동 입력" readonly>
        </label>
      </div>

      <div style="height:10px"></div>
      <div class="row">
        <button id="btnAuth" class="btn">인증 연결</button>
        <button id="btnStart" class="btn success">시작</button>
        <button id="btnPause" class="btn warn">일시정지</button>
        <button id="btnEnd" class="btn danger">종료</button>
      </div>
    </div>

    <div class="card">
      <h3 class="title"><span class="dot"></span> 로그 · 채팅</h3>
      <div class="chat" id="chat"></div>
      <div class="row" style="margin-top:6px">
        <input id="chatInput" class="input" placeholder="메시지 입력" style="flex:1 1 auto" />
        <select id="chatChannel" class="input">
          <option value="all">전체</option>
          <option value="team">팀</option>
        </select>
        <button id="chatSend" class="btn gold">보내기</button>
      </div>
    </div>

    <div class="card">
      <h3 class="title"><span class="dot"></span> 로스터 구성</h3>
      <div class="grid2">
        <label>이름
          <input id="pName" class="input" placeholder="이름">
        </label>
        <label>팀
          <select id="pTeam" class="input">
            <option value="team1">불사조 기사단</option>
            <option value="team2">죽음을 먹는 자들</option>
          </select>
        </label>
      </div>
      <div class="grid3" style="margin-top:8px">
        <label>ATK <input id="pAtk" class="input" type="number" min="1" max="5" value="3"></label>
        <label>DEF <input id="pDef" class="input" type="number" min="1" max="5" value="3"></label>
        <label>AGI <input id="pAgi" class="input" type="number" min="1" max="5" value="3"></label>
      </div>
      <div class="grid3" style="margin-top:8px">
        <label>LUCK <input id="pLuck" class="input" type="number" min="1" max="5" value="3"></label>
        <label>아이템
          <select id="pItem" class="input">
            <option value="">없음</option>
            <option>디터니</option>
            <option>공격 보정기</option>
            <option>방어 보정기</option>
          </select>
        </label>
        <div class="row" style="justify-content:flex-end;align-items:end">
          <button id="btnAdd" class="btn gold">플레이어 추가</button>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="row">
        <button id="btnLinks" class="btn">플레이어별 링크 생성</button>
      </div>

      <div style="height:10px"></div>
      <div class="grid2">
        <div>
          <div class="muted">팀1: <span id="t1name">불사조 기사단</span></div>
          <div id="team1" class="list"></div>
        </div>
        <div>
          <div class="muted">팀2: <span id="t2name">죽음을 먹는 자들</span></div>
          <div id="team2" class="list"></div>
        </div>
      </div>

      <div style="height:10px"></div>
      <div id="linkList" class="list"></div>
    </div>

    <div class="card">
      <h3 class="title"><span class="dot"></span> 전장 정보</h3>
      <div id="headInfo" class="muted"></div>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const statusPill = $('statusPill');
  const battleId = $('battleId'), adminOtp = $('adminOtp'), spectatorOtp = $('spectatorOtp');
  const modeSel = $('mode');
  const chatEl = $('chat'), chatInput = $('chatInput'), chatSend = $('chatSend'), chatChannel = $('chatChannel');

  const team1 = $('team1'), team2 = $('team2'), t1name = $('t1name'), t2name = $('t2name'), headInfo = $('headInfo');

  const socket = io({ path: '/socket.io/' });
  let state = null;

  // URL 파라미터로 들어온 battle/token이 있으면 먼저 채워둔다
  const qs = new URLSearchParams(location.search);
  if (qs.get('battle')) battleId.value = qs.get('battle');
  if (qs.get('token'))  adminOtp.value = qs.get('token');

  function setStatusPill(status){
    statusPill.classList.remove('wait','go','pause','end');
    if (status === 'waiting') { statusPill.classList.add('wait'); statusPill.textContent = '대기중'; }
    else if (status === 'ongoing') { statusPill.classList.add('go'); statusPill.textContent = '진행중'; }
    else if (status === 'paused') { statusPill.classList.add('pause'); statusPill.textContent = '일시정지'; }
    else if (status === 'ended') { statusPill.classList.add('end'); statusPill.textContent = '종료'; }
  }
  function fmtTs(ts){
    try{ const d = new Date(ts); return d.toLocaleTimeString([], {hour12:false}); }catch{ return '--:--:--'; }
  }
  function lineEl(klass, tsText, bodyText){
    const row = document.createElement('div'); row.className = 'row ' + klass;
    const ts = document.createElement('span'); ts.className = 'ts mono'; ts.textContent = tsText;
    const msg = document.createElement('span'); msg.className = 'msg'; msg.textContent = bodyText;
    row.appendChild(ts); row.appendChild(msg); return row;
  }
  function appendChat(msg){
    if (!msg) return;
    const t = fmtTs(msg.ts || Date.now());
    let klass = ''; let text = '';
    if (msg.type === 'system') { text = '[시스템] ' + msg.text; klass = 'sys'; }
    else if (msg.type === 'cheer') { text = '[응원] ' + (msg.from||'관전자') + ': ' + msg.text; klass = 'cheer'; }
    else if (msg.type === 'chat') { text = '[' + (msg.channel === 'team' ? '팀':'전체') + '] ' + (msg.from||'익명') + ': ' + msg.text; klass = (msg.role==='admin' ? 'me' : ''); }
    chatEl.appendChild(lineEl(klass, t, text));
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function render(){
    if (!state) return;

    setStatusPill(state.status);
    const T = state.turn || {turnIndex:0, frameIndex:0, framePlan:[]};
    headInfo.textContent = `전투 ${state.id} · 모드 ${state.mode} · 턴 ${T.turnIndex} / 프레임 ${T.frameIndex+1} / 총 ${T.framePlan.length}`;

    t1name.textContent = state.teams.team1;
    t2name.textContent = state.teams.team2;

    team1.innerHTML = ''; team2.innerHTML = '';
    const mkUnit = (p) => {
      const box = document.createElement('div'); box.className = 'unit';
      const info = document.createElement('div'); info.style.flex='1';
      const name = document.createElement('div'); name.className='name'; name.textContent = `${p.name}${p.alive?'':' (불능)'}`;
      const bar = document.createElement('div'); bar.className='bar';
      const span = document.createElement('span'); span.style.width=`${Math.round((p.hp/p.maxHp)*100)}%`; bar.appendChild(span);
      const meta = document.createElement('div'); meta.className='muted'; meta.textContent = `ATK ${p.stats.attack} / DEF ${p.stats.defense} / AGI ${p.stats.agility} / LUCK ${p.stats.luck}`;
      info.appendChild(name); info.appendChild(bar); info.appendChild(meta);
      box.appendChild(info);
      return box;
    };
    Object.values(state.players).filter(p=>p.team==='team1').forEach(p=>team1.appendChild(mkUnit(p)));
    Object.values(state.players).filter(p=>p.team==='team2').forEach(p=>team2.appendChild(mkUnit(p)));
  }

  // 소켓 이벤트
  socket.on('connect', ()=>{
    // 자동 인증 시도(입력되어 있으면)
    if (battleId.value && adminOtp.value) {
      socket.emit('auth', { battle: battleId.value, token: adminOtp.value, role:'admin' }, (ack)=>{
        if (!ack || !ack.ok) { alert('인증 실패'); return; }
        state = ack.state; render();
      });
    }
  });
  socket.on('state', s => { state = s; render(); });
  socket.on('chat', appendChat);
  socket.on('chatError', (m)=> alert(m));

  // UI 동작
  $('btnCreate').onclick = async ()=>{
    try {
      const mode = modeSel.value || '1v1';
      const res = await fetch('/api/admin/battles', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ mode })});
      if (!res.ok) { const txt = await res.text().catch(()=> ''); alert('생성 실패: '+res.status+' '+txt); return; }
      const data = await res.json();
      battleId.value = data.battle.id;
      adminOtp.value = data.otps.admin;
      spectatorOtp.value = data.otps.spectator;
      alert('전투가 생성되었습니다: ' + data.battle.id);
    } catch (e) { alert('생성 실패: ' + (e && (e.message||e))); }
  };

  $('btnAuth').onclick = ()=>{
    if (!battleId.value || !adminOtp.value) { alert('전투ID/관리자 OTP를 확인하세요'); return; }
    socket.emit('auth', { battle:battleId.value, token:adminOtp.value, role:'admin' }, (ack)=>{
      if (!ack || !ack.ok) { alert('인증 실패'); return; }
      state = ack.state; render();
      alert('인증 성공');
    });
  };

  $('btnStart').onclick = async ()=>{
    if (!battleId.value) return alert('전투ID가 없습니다');
    const r = await fetch(`/api/admin/battles/${battleId.value}/start`, { method:'POST' });
    if (!r.ok) return alert('시작 실패');
  };
  $('btnPause').onclick = async ()=>{
    if (!battleId.value) return alert('전투ID가 없습니다');
    const r = await fetch(`/api/admin/battles/${battleId.value}/pause`, { method:'POST' });
    if (!r.ok) return alert('일시정지 실패');
  };
  $('btnEnd').onclick = async ()=>{
    if (!battleId.value) return alert('전투ID가 없습니다');
    const r = await fetch(`/api/admin/battles/${battleId.value}/end`, { method:'POST' });
    if (!r.ok) return alert('종료 실패');
  };

  $('btnAdd').onclick = async ()=>{
    if (!battleId.value) return alert('전투ID가 없습니다');
    const name = $('pName').value.trim();
    const team = $('pTeam').value;
    const stats = { attack: Number($('pAtk').value||3), defense:Number($('pDef').value||3), agility:Number($('pAgi').value||3), luck:Number($('pLuck').value||3) };
    const item = $('pItem').value;
    const inventory = item ? [item] : [];
    if (!name) return alert('이름을 입력하세요');
    const r = await fetch(`/api/battles/${battleId.value}/players`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ name, team, stats, inventory })
    });
    if (!r.ok) { const t = await r.text().catch(()=> ''); alert('추가 실패: '+t); return; }
    $('pName').value=''; $('pItem').value='';
  };

  $('btnLinks').onclick = async ()=>{
    if (!battleId.value) return alert('전투ID가 없습니다');
    const r = await fetch(`/api/admin/battles/${battleId.value}/links`, { method:'POST' });
    if (!r.ok) return alert('링크 생성 실패');
    const d = await r.json();
    const box = $('linkList'); box.innerHTML = '';
    d.playerLinks.forEach(pl=>{
      const div = document.createElement('div');
      div.className='unit';
      div.textContent = `${pl.name}: ${pl.url}`;
      box.appendChild(div);
    });
  };

  chatSend.onclick = ()=>{
    const text = chatInput.value.trim(); if (!text) return;
    socket.emit('chatMessage', { message: text, channel: chatChannel.value });
    chatInput.value = '';
  };
})();
</script>
</body>
</html>
