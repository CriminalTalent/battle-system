<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>전투 아레나</title>
<style>
:root {
  --deep-navy: #0a0f1a;
  --navy: #0f1419;
  --navy-light: #1a1f26;
  --gold: #E5C88A;
  --gold-light: #F5E6B8;
  --gold-dark: #C8A882;
  --accent: #2a3441;
  --text-primary: #F5E6B8;
  --text-secondary: #D4C39A;
  --border: rgba(229, 200, 138, 0.3);
  --border-light: rgba(229, 200, 138, 0.15);
  --shadow: rgba(229, 200, 138, 0.2);
  --glass: rgba(15, 20, 25, 0.85);
  --glass-dark: rgba(10, 15, 26, 0.9);
  --timer-warning: #e74c3c;
  --timer-critical: #c0392b;
  --success: #27ae60;
  --warning: #f39c12;
  --danger: #e74c3c;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  -webkit-tap-highlight-color: transparent;
}

body {
  background: linear-gradient(135deg, var(--deep-navy) 0%, var(--navy) 50%, var(--navy-light) 100%);
  color: var(--text-primary);
  font-family: 'Cinzel', 'Times New Roman', serif;
  min-height: 100vh;
  overflow-x: hidden;
  position: relative;
  font-size: 16px;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: 
    radial-gradient(circle at 20% 20%, rgba(229, 200, 138, 0.05) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(229, 200, 138, 0.05) 0%, transparent 50%),
    radial-gradient(circle at 40% 60%, rgba(229, 200, 138, 0.03) 0%, transparent 50%);
  pointer-events: none;
  z-index: -1;
}

.arena-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 15px;
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.arena-header {
  background: var(--glass-dark);
  border: 2px solid var(--border);
  border-radius: 16px;
  padding: 20px;
  text-align: center;
  backdrop-filter: blur(20px);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(229, 200, 138, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.arena-title {
  font-size: clamp(1.5rem, 4vw, 2.2rem);
  color: var(--gold);
  text-shadow: 0 0 20px rgba(229, 200, 138, 0.5);
  letter-spacing: 1px;
  margin: 0;
}

.connection-status {
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
  border: 2px solid;
}

.connection-status.connected {
  background: var(--success);
  color: white;
  border-color: #2ecc71;
}

.connection-status.disconnected {
  background: var(--danger);
  color: white;
  border-color: #e74c3c;
}

.connection-status.connecting {
  background: var(--warning);
  color: white;
  border-color: #f39c12;
}

.login-screen {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 80vh;
  padding: 20px;
}

.login-form {
  background: var(--glass);
  border: 2px solid var(--border);
  border-radius: 16px;
  padding: 30px;
  backdrop-filter: blur(20px);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  max-width: 500px;
  width: 100%;
}

.login-title {
  font-size: 1.8rem;
  color: var(--gold);
  text-align: center;
  margin-bottom: 25px;
  text-shadow: 0 0 15px rgba(229, 200, 138, 0.3);
}

.form-field {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  color: var(--text-secondary);
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 6px;
}

.form-input {
  width: 100%;
  background: var(--navy-light);
  border: 2px solid var(--border-light);
  border-radius: 8px;
  padding: 12px 16px;
  color: var(--text-primary);
  font-size: 16px;
  transition: all 0.3s ease;
}

.form-input:focus {
  outline: none;
  border-color: var(--gold);
  box-shadow: 0 0 0 3px rgba(229, 200, 138, 0.2);
}

.form-grid {
  display: grid;
  gap: 15px;
}

.form-grid.cols-2 {
  grid-template-columns: 1fr 1fr;
}

.team-selection {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

.team-btn {
  background: var(--accent);
  border: 2px solid var(--border-light);
  border-radius: 8px;
  padding: 15px 20px;
  color: var(--text-primary);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: center;
}

.team-btn:hover {
  border-color: var(--border);
  background: var(--navy-light);
}

.team-btn.selected {
  background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
  color: var(--deep-navy);
  border-color: var(--gold);
}

.btn {
  background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
  color: var(--deep-navy);
  border: none;
  border-radius: 8px;
  padding: 15px 25px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  width: 100%;
  box-shadow: 0 4px 15px rgba(229, 200, 138, 0.3);
}

.btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(229, 200, 138, 0.4);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.login-actions {
  margin-top: 25px;
}

.character-setup {
  display: none;
  max-width: 800px;
  margin: 0 auto;
}

.character-form {
  background: var(--glass);
  border: 2px solid var(--border);
  border-radius: 16px;
  padding: 25px;
  backdrop-filter: blur(20px);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.character-title {
  font-size: 1.6rem;
  color: var(--gold);
  text-align: center;
  margin-bottom: 20px;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.stat-field {
  text-align: center;
}

.stat-value {
  font-size: 2rem;
  font-weight: bold;
  color: var(--gold);
  display: block;
  margin: 8px 0;
}

.stat-controls {
  display: flex;
  justify-content: center;
  gap: 10px;
}

.stat-btn {
  background: var(--accent);
  border: 1px solid var(--border-light);
  border-radius: 6px;
  width: 32px;
  height: 32px;
  color: var(--text-primary);
  cursor: pointer;
  font-size: 18px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.stat-btn:hover:not(:disabled) {
  background: var(--navy-light);
  border-color: var(--border);
}

.stat-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.points-info {
  text-align: center;
  margin-bottom: 20px;
  font-size: 16px;
  color: var(--text-secondary);
}

.points-remaining {
  color: var(--gold);
  font-weight: bold;
}

.image-upload {
  margin-bottom: 20px;
}

.upload-area {
  border: 2px dashed var(--border-light);
  border-radius: 8px;
  padding: 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  background: var(--navy-light);
}

.upload-area:hover {
  border-color: var(--border);
  background: var(--accent);
}

.upload-preview {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  margin: 0 auto 10px;
  border: 3px solid var(--border);
  background-size: cover;
  background-position: center;
  background-color: var(--accent);
}

.items-section {
  margin-bottom: 20px;
}

.items-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
}

.item-field {
  text-align: center;
}

.item-count {
  font-size: 1.5rem;
  font-weight: bold;
  color: var(--gold);
  margin: 8px 0;
}

.battle-screen {
  display: none;
}

.battlefield {
  display: grid;
  grid-template-columns: 1fr 2fr 1fr;
  gap: 20px;
  margin-bottom: 20px;
}

.team-panel {
  background: var(--glass);
  border: 2px solid var(--border-light);
  border-radius: 12px;
  padding: 20px;
  backdrop-filter: blur(10px);
}

.team-header {
  font-size: 1.3rem;
  font-weight: bold;
  color: var(--gold);
  text-align: center;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border-light);
}

.player-card {
  background: var(--navy-light);
  border: 1px solid var(--border-light);
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.player-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background-color: var(--accent);
  background-size: cover;
  background-position: center;
  border: 2px solid var(--border-light);
  flex-shrink: 0;
}

.player-info {
  flex: 1;
}

.player-name {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 4px;
}

.player-hp {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 6px;
}

.hp-bar {
  width: 100%;
  height: 8px;
  background: var(--accent);
  border-radius: 4px;
  overflow: hidden;
}

.hp-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--danger) 0%, var(--warning) 50%, var(--success) 100%);
  transition: width 0.3s ease;
}

.player-stats {
  display: flex;
  gap: 6px;
  margin-top: 6px;
}

.stat-badge {
  background: var(--accent);
  color: var(--text-secondary);
  padding: 2px 6px;
  border-radius: 10px;
  font-size: 11px;
}

.battle-center {
  background: var(--glass);
  border: 2px solid var(--border);
  border-radius: 12px;
  padding: 25px;
  text-align: center;
  backdrop-filter: blur(10px);
}

.turn-info {
  font-size: 1.4rem;
  color: var(--gold);
  margin-bottom: 20px;
  font-weight: 600;
}

.actions-panel {
  display: flex;
  justify-content: center;
  gap: 15px;
  flex-wrap: wrap;
  margin-bottom: 20px;
}

.action-btn {
  background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
  color: var(--deep-navy);
  border: none;
  border-radius: 8px;
  padding: 12px 20px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  min-width: 100px;
}

.action-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(229, 200, 138, 0.4);
}

.action-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.action-btn.danger {
  background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
  color: white;
}

.target-selection {
  display: none;
  margin-top: 15px;
}

.target-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 10px;
  margin-top: 10px;
}

.target-btn {
  background: var(--accent);
  border: 2px solid var(--border-light);
  border-radius: 8px;
  padding: 10px;
  color: var(--text-primary);
  font-size: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: center;
}

.target-btn:hover {
  border-color: var(--border);
  background: var(--navy-light);
}

.battle-log {
  background: var(--navy-light);
  border: 1px solid var(--border-light);
  border-radius: 8px;
  padding: 15px;
  height: 200px;
  overflow-y: auto;
}

.log-title {
  font-size: 1.1rem;
  color: var(--gold);
  margin-bottom: 10px;
  font-weight: 600;
}

.log-entry {
  padding: 4px 0;
  border-bottom: 1px solid var(--border-light);
  font-size: 13px;
  line-height: 1.4;
}

.log-entry:last-child {
  border-bottom: none;
}

.chat-section {
  background: var(--glass);
  border: 2px solid var(--border-light);
  border-radius: 12px;
  padding: 20px;
  backdrop-filter: blur(10px);
}

.chat-log {
  background: var(--navy-light);
  border: 1px solid var(--border-light);
  border-radius: 8px;
  padding: 15px;
  height: 200px;
  overflow-y: auto;
  margin-bottom: 15px;
}

.chat-message {
  padding: 6px 0;
  border-bottom: 1px solid var(--border-light);
  font-size: 13px;
  line-height: 1.4;
}

.chat-message:last-child {
  border-bottom: none;
}

.chat-sender {
  font-weight: 600;
  color: var(--gold);
}

.chat-controls {
  display: flex;
  gap: 10px;
}

.chat-input {
  flex: 1;
  background: var(--navy-light);
  border: 1px solid var(--border-light);
  border-radius: 6px;
  padding: 10px 12px;
  color: var(--text-primary);
  font-size: 14px;
}

.chat-input:focus {
  outline: none;
  border-color: var(--gold);
}

.send-btn {
  background: var(--accent);
  border: 1px solid var(--border-light);
  border-radius: 6px;
  padding: 10px 15px;
  color: var(--text-primary);
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s ease;
}

.send-btn:hover {
  background: var(--navy-light);
  border-color: var(--border);
}

.notifications {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 1000;
}

.notification {
  background: var(--glass-dark);
  border: 2px solid;
  border-radius: 8px;
  padding: 12px 20px;
  margin-bottom: 10px;
  color: white;
  font-weight: 600;
  backdrop-filter: blur(20px);
  transform: translateX(100%);
  opacity: 0;
  transition: all 0.3s ease;
}

.notification.show {
  transform: translateX(0);
  opacity: 1;
}

.notification.success {
  border-color: var(--success);
  background: rgba(39, 174, 96, 0.9);
}

.notification.error {
  border-color: var(--danger);
  background: rgba(231, 76, 60, 0.9);
}

.notification.info {
  border-color: var(--warning);
  background: rgba(243, 156, 18, 0.9);
}

@media (max-width: 768px) {
  .arena-container {
    padding: 10px;
    gap: 10px;
  }
  
  .arena-header {
    flex-direction: column;
    gap: 10px;
    text-align: center;
  }
  
  .battlefield {
    grid-template-columns: 1fr;
    gap: 15px;
  }
  
  .form-grid.cols-2 {
    grid-template-columns: 1fr;
  }
  
  .team-selection {
    grid-template-columns: 1fr;
  }
  
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .actions-panel {
    flex-direction: column;
    align-items: center;
  }
  
  .action-btn {
    width: 100%;
    max-width: 200px;
  }
}
</style>
</head>
<body>

<div class="arena-container">
  <!-- 헤더 -->
  <header class="arena-header">
    <h1 class="arena-title">전투 아레나</h1>
    <div id="connectionStatus" class="connection-status disconnected">연결 끊김</div>
  </header>

  <!-- 로그인 화면 -->
  <div id="loginScreen" class="login-screen">
    <div class="login-form">
      <div class="login-title">전투 참가</div>
      <div class="form-grid cols-2">
        <div class="form-field">
          <div class="form-label">플레이어 이름</div>
          <input id="playerName" class="form-input" placeholder="예: 전사123">
        </div>
        <div class="form-field">
          <div class="form-label">전투 ID</div>
          <input id="battleId" class="form-input" placeholder="예: ABC123">
        </div>
        <div class="form-field">
          <div class="form-label">토큰</div>
          <input id="tokenInput" class="form-input" placeholder="토큰">
        </div>
        <div class="form-field" style="grid-column: 1 / -1;">
          <div class="form-label">참가 코드</div>
          <input id="otp" class="form-input" placeholder="6자리 코드">
        </div>
        <div class="form-field" style="grid-column: 1 / -1;">
          <div class="form-label">팀 선택</div>
          <div class="team-selection">
            <button id="joinTeam1" class="team-btn" type="button">팀 1</button>
            <button id="joinTeam2" class="team-btn" type="button">팀 2</button>
          </div>
        </div>
      </div>
      <div class="login-actions">
        <button id="loginBtn" class="btn" disabled>참가</button>
      </div>
    </div>
  </div>

  <!-- 캐릭터 설정 화면 -->
  <div id="characterScreen" class="character-setup">
    <div class="character-form">
      <div class="character-title">캐릭터 설정</div>
      
      <!-- 스탯 배분 -->
      <div class="stats-grid">
        <div class="stat-field">
          <div class="form-label">공격력</div>
          <span id="attackValue" class="stat-value">3</span>
          <div class="stat-controls">
            <button class="stat-btn" onclick="adjustStat('attack', -1)">-</button>
            <button class="stat-btn" onclick="adjustStat('attack', 1)">+</button>
          </div>
        </div>
        <div class="stat-field">
          <div class="form-label">방어력</div>
          <span id="defenseValue" class="stat-value">3</span>
          <div class="stat-controls">
            <button class="stat-btn" onclick="adjustStat('defense', -1)">-</button>
            <button class="stat-btn" onclick="adjustStat('defense', 1)">+</button>
          </div>
        </div>
        <div class="stat-field">
          <div class="form-label">민첩성</div>
          <span id="agilityValue" class="stat-value">3</span>
          <div class="stat-controls">
            <button class="stat-btn" onclick="adjustStat('agility', -1)">-</button>
            <button class="stat-btn" onclick="adjustStat('agility', 1)">+</button>
          </div>
        </div>
        <div class="stat-field">
          <div class="form-label">행운</div>
          <span id="luckValue" class="stat-value">3</span>
          <div class="stat-controls">
            <button class="stat-btn" onclick="adjustStat('luck', -1)">-</button>
            <button class="stat-btn" onclick="adjustStat('luck', 1)">+</button>
          </div>
        </div>
      </div>
      
      <div class="points-info">
        남은 포인트: <span id="remainingPoints" class="points-remaining">8</span>
      </div>

      <!-- 이미지 업로드 -->
      <div class="image-upload">
        <div class="form-label">캐릭터 이미지</div>
        <div class="upload-area" onclick="document.getElementById('imageFile').click()">
          <div id="imagePreview" class="upload-preview"></div>
          <div>클릭하여 이미지 업로드</div>
          <input id="imageFile" type="file" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
        </div>
      </div>

      <!-- 아이템 설정 -->
      <div class="items-section">
        <div class="form-label">아이템 (총 3개)</div>
        <div class="items-grid">
          <div class="item-field">
            <div class="form-label">공격 보정기</div>
            <div id="attackBoostCount" class="item-count">1</div>
            <div class="stat-controls">
              <button class="stat-btn" onclick="adjustItem('attackBoost', -1)">-</button>
              <button class="stat-btn" onclick="adjustItem('attackBoost', 1)">+</button>
            </div>
          </div>
          <div class="item-field">
            <div class="form-label">방어 보정기</div>
            <div id="defenseBoostCount" class="item-count">1</div>
            <div class="stat-controls">
              <button class="stat-btn" onclick="adjustItem('defenseBoost', -1)">-</button>
              <button class="stat-btn" onclick="adjustItem('defenseBoost', 1)">+</button>
            </div>
          </div>
          <div class="item-field">
            <div class="form-label">디터니 (회복)</div>
            <div id="healCount" class="item-count">1</div>
            <div class="stat-controls">
              <button class="stat-btn" onclick="adjustItem('heal', -1)">-</button>
              <button class="stat-btn" onclick="adjustItem('heal', 1)">+</button>
            </div>
          </div>
        </div>
      </div>

      <div class="login-actions">
        <button id="joinBattleBtn" class="btn">전투 참가</button>
      </div>
    </div>
  </div>

  <!-- 전투 화면 -->
  <div id="battleScreen" class="battle-screen">
    <!-- 전장 -->
    <div class="battlefield">
      <div class="team-panel">
        <div class="team-header">팀 1</div>
        <div id="team1Players"></div>
      </div>
      
      <div class="battle-center">
        <div id="turnInfo" class="turn-info">전투 대기 중...</div>
        
        <div class="actions-panel">
          <button id="attackBtn" class="action-btn">공격</button>
          <button id="defendBtn" class="action-btn">방어</button>
          <button id="evadeBtn" class="action-btn">회피</button>
          <button id="useItemBtn" class="action-btn">아이템 사용</button>
        </div>

        <div id="targetSelection" class="target-selection">
          <div class="form-label">대상 선택:</div>
          <div id="targetGrid" class="target-grid"></div>
        </div>

        <div id="itemSelection" class="target-selection">
          <div class="form-label">아이템 선택:</div>
          <div id="itemGrid" class="target-grid"></div>
        </div>
      </div>
      
      <div class="team-panel">
        <div class="team-header">팀 2</div>
        <div id="team2Players"></div>
      </div>
    </div>

    <!-- 로그 -->
    <div class="battle-log">
      <div class="log-title">전투 로그</div>
      <div id="battleLogContent"></div>
    </div>

    <!-- 채팅 -->
    <div class="chat-section">
      <div class="log-title">채팅</div>
      <div id="chatLog" class="chat-log"></div>
      <div class="chat-controls">
        <input id="chatInput" class="chat-input" placeholder="메시지를 입력하세요..." maxlength="200">
        <button id="sendChatBtn" class="send-btn">전송</button>
      </div>
    </div>
  </div>
</div>

<div id="notifications" class="notifications"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const $ = s => document.querySelector(s);
  const qs = new URLSearchParams(location.search);
  
  let selectedTeam = null;
  let socket = null;
  let battleId = '';
  let playerId = '';
  let playerName = '';
  let gameState = null;
  let currentAction = null;

  // 캐릭터 스탯 및 아이템
  let stats = { attack: 3, defense: 3, agility: 3, luck: 3 };
  let items = { attackBoost: 1, defenseBoost: 1, heal: 1 };
  let availablePoints = 8;
  let selectedImage = null;

  // URL 파라미터에서 초기값 설정
  $('#battleId').value = qs.get('battle') || '';
  $('#tokenInput').value = qs.get('token') || '';

  // 유틸리티 함수
  function showNotification(msg, type = 'success') {
    const notificationDiv = document.createElement('div');
    notificationDiv.className = `notification ${type}`;
    notificationDiv.textContent = msg;
    $('#notifications').appendChild(notificationDiv);
    setTimeout(() => notificationDiv.classList.add('show'), 10);
    setTimeout(() => {
      notificationDiv.style.transform = 'translateX(100%)';
      notificationDiv.style.opacity = '0';
      setTimeout(() => notificationDiv.remove(), 300);
    }, type === 'error' ? 5000 : 3000);
  }

  function showSuccess(msg) { showNotification(msg, 'success'); }
  function showError(msg) { showNotification(msg, 'error'); }
  function showInfo(msg) { showNotification(msg, 'info'); }

  function updateConnectionStatus(status, message) {
    const el = $('#connectionStatus');
    el.className = `connection-status ${status}`;
    el.textContent = message;
  }

  // 폼 검증
  function validateForm() {
    const name = $('#playerName').value.trim();
    const battleIdValue = $('#battleId').value.trim();
    const otp = $('#otp').value.trim();
    const hasTeam = selectedTeam !== null;
    
    $('#loginBtn').disabled = !(name && battleIdValue && otp && hasTeam);
  }

  // 스탯 조정
  window.adjustStat = function(statName, delta) {
    const currentValue = stats[statName];
    const newValue = currentValue + delta;
    
    if (newValue < 1 || newValue > 10) return;
    
    if (delta > 0 && availablePoints <= 0) return;
    if (delta < 0 && currentValue <= 1) return;
    
    stats[statName] = newValue;
    availablePoints -= delta;
    
    updateStatsDisplay();
  };

  // 아이템 조정
  window.adjustItem = function(itemName, delta) {
    const currentValue = items[itemName];
    const newValue = currentValue + delta;
    
    if (newValue < 0) return;
    
    const totalItems = Object.values(items).reduce((sum, count) => sum + count, 0);
    if (delta > 0 && totalItems >= 3) return;
    
    items[itemName] = newValue;
    updateItemsDisplay();
  };

  // 이미지 업로드 처리
  window.handleImageUpload = function(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (file.size > 5 * 1024 * 1024) {
      showError('이미지 파일은 5MB 이하만 업로드 가능합니다.');
      return;
    }
    
    selectedImage = file;
    const reader = new FileReader();
    reader.onload = function(e) {
      $('#imagePreview').style.backgroundImage = `url(${e.target.result})`;
    };
    reader.readAsDataURL(file);
  };

  function updateStatsDisplay() {
    $('#attackValue').textContent = stats.attack;
    $('#defenseValue').textContent = stats.defense;
    $('#agilityValue').textContent = stats.agility;
    $('#luckValue').textContent = stats.luck;
    $('#remainingPoints').textContent = availablePoints;
    
    // 버튼 상태 업데이트
    Object.keys(stats).forEach(stat => {
      const minusBtn = document.querySelector(`[onclick="adjustStat('${stat}', -1)"]`);
      const plusBtn = document.querySelector(`[onclick="adjustStat('${stat}', 1)"]`);
      
      if (minusBtn) minusBtn.disabled = stats[stat] <= 1;
      if (plusBtn) plusBtn.disabled = availablePoints <= 0 || stats[stat] >= 10;
    });
  }

  function updateItemsDisplay() {
    $('#attackBoostCount').textContent = items.attackBoost;
    $('#defenseBoostCount').textContent = items.defenseBoost;
    $('#healCount').textContent = items.heal;
    
    const totalItems = Object.values(items).reduce((sum, count) => sum + count, 0);
    
    // 버튼 상태 업데이트
    Object.keys(items).forEach(item => {
      const minusBtn = document.querySelector(`[onclick="adjustItem('${item}', -1)"]`);
      const plusBtn = document.querySelector(`[onclick="adjustItem('${item}', 1)"]`);
      
      if (minusBtn) minusBtn.disabled = items[item] <= 0;
      if (plusBtn) plusBtn.disabled = totalItems >= 3;
    });
  }

  // 소켓 연결
  function connectSocket() {
    if (socket) socket.disconnect();
    
    socket = io({
      transports: ['websocket', 'polling'],
      upgrade: true,
      rememberUpgrade: true
    });

    socket.on('connect', () => {
      updateConnectionStatus('connected', '연결됨');
      if (battleId && playerId) {
        socket.emit('join-player', { battleId, playerId, name: playerName });
      }
    });

    socket.on('disconnect', () => {
      updateConnectionStatus('disconnected', '연결 끊김');
    });

    socket.on('battle-state', (data) => {
      if (data.battleId === battleId) {
        gameState = data.state;
        updateBattleDisplay();
      }
    });

    socket.on('chat-message', (data) => {
      if (data.battleId === battleId) {
        addChatMessage(data.message);
      }
    });

    socket.on('error', (error) => {
      showError(error.message || '오류가 발생했습니다.');
    });
  }

  // API 호출
  async function apiCall(url, options = {}) {
    try {
      const response = await fetch(url, {
        headers: {
          'Content-Type': 'application/json',
          ...options.headers
        },
        ...options
      });
      
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: '서버 오류가 발생했습니다' }));
        throw new Error(errorData.error || `HTTP ${response.status}`);
      }
      
      return await response.json();
    } catch (error) {
      showError(error.message);
      throw error;
    }
  }

  // 전투 참가
  async function joinBattle() {
    try {
      battleId = $('#battleId').value.trim();
      playerName = $('#playerName').value.trim();
      const otp = $('#otp').value.trim();
      const token = $('#tokenInput').value.trim();
      
      // 로그인
      const loginResponse = await apiCall('/api/auth/login', {
        method: 'POST',
        body: JSON.stringify({
          battleId,
          otp,
          role: 'player',
          playerName
        })
      });

      showSuccess('로그인 성공! 캐릭터를 설정하세요.');
      
      // 캐릭터 설정 화면으로 전환
      $('#loginScreen').style.display = 'none';
      $('#characterScreen').style.display = 'block';
      
    } catch (error) {
      // 오류는 이미 apiCall에서 처리됨
    }
  }

  // 전투 참가 완료
  async function completeBattleJoin() {
    try {
      const formData = new FormData();
      formData.append('name', playerName);
      formData.append('team', selectedTeam);
      formData.append('attack', stats.attack);
      formData.append('defense', stats.defense);
      formData.append('agility', stats.agility);
      formData.append('luck', stats.luck);
      formData.append('공격 보정기', items.attackBoost);
      formData.append('방어 보정기', items.defenseBoost);
      formData.append('디터니', items.heal);
      
      if (selectedImage) {
        formData.append('image', selectedImage);
      }

      const response = await fetch(`/api/battles/${battleId}/players`, {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: '서버 오류가 발생했습니다' }));
        throw new Error(errorData.error || `HTTP ${response.status}`);
      }

      const result = await response.json();
      playerId = result.playerId;

      showSuccess('전투 참가 완료!');
      
      // 전투 화면으로 전환
      $('#characterScreen').style.display = 'none';
      $('#battleScreen').style.display = 'block';
      
      connectSocket();
      
    } catch (error) {
      showError(error.message);
    }
  }

  // 전투 화면 업데이트
  function updateBattleDisplay() {
    if (!gameState) return;

    // 팀별 플레이어 표시
    renderTeam(gameState.teams?.team1?.players || [], $('#team1Players'));
    renderTeam(gameState.teams?.team2?.players || [], $('#team2Players'));

    // 턴 정보 업데이트
    updateTurnInfo();

    // 전투 로그 업데이트
    updateBattleLog();

    // 액션 버튼 상태 업데이트
    updateActionButtons();
  }

  function renderTeam(players, container) {
    if (!container) return;
    
    container.innerHTML = '';
    players.forEach(player => {
      const div = document.createElement('div');
      div.className = 'player-card';
      
      const hpPercent = player.maxHp > 0 ? (player.hp / player.maxHp) * 100 : 0;
      
      div.innerHTML = `
        <div class="player-avatar" style="background-image: url('${player.imageUrl || ''}')"></div>
        <div class="player-info">
          <div class="player-name">${player.name}</div>
          <div class="player-hp">${player.hp}/${player.maxHp} HP</div>
          <div class="hp-bar">
            <div class="hp-fill" style="width: ${hpPercent}%"></div>
          </div>
          <div class="player-stats">
            <span class="stat-badge">공격 ${player.stats?.attack || 0}</span>
            <span class="stat-badge">방어 ${player.stats?.defense || 0}</span>
            <span class="stat-badge">민첩 ${player.stats?.agility || 0}</span>
            <span class="stat-badge">행운 ${player.stats?.luck || 0}</span>
          </div>
        </div>
      `;
      container.appendChild(div);
    });
  }

  function updateTurnInfo() {
    const turnInfoEl = $('#turnInfo');
    if (!gameState || !turnInfoEl) return;

    if (gameState.status === 'waiting') {
      turnInfoEl.textContent = '플레이어를 기다리는 중...';
    } else if (gameState.status === 'ongoing') {
      const currentTeam = gameState.currentTeam;
      turnInfoEl.textContent = `${currentTeam} 턴`;
    } else if (gameState.status === 'ended') {
      turnInfoEl.textContent = `전투 종료 - ${gameState.winner || '무승부'}`;
    }
  }

  function updateBattleLog() {
    const logEl = $('#battleLogContent');
    if (!gameState?.battleLog || !logEl) return;

    const logs = gameState.battleLog.slice(-20);
    logEl.innerHTML = logs.map(log => `
      <div class="log-entry">
        <strong>${log.type}:</strong> ${log.message}
      </div>
    `).join('');
    logEl.scrollTop = logEl.scrollHeight;
  }

  function updateActionButtons() {
    const isMyTurn = gameState?.currentTeam === selectedTeam && gameState?.status === 'ongoing';
    const myPlayer = getCurrentPlayer();
    const canAct = isMyTurn && myPlayer?.alive && !myPlayer?.hasActed;

    $('#attackBtn').disabled = !canAct;
    $('#defendBtn').disabled = !canAct;
    $('#evadeBtn').disabled = !canAct;
    $('#useItemBtn').disabled = !canAct || !hasUsableItems(myPlayer);
  }

  function getCurrentPlayer() {
    if (!gameState?.teams || !selectedTeam) return null;
    const team = gameState.teams[selectedTeam];
    return team?.players?.find(p => p.id === playerId);
  }

  function hasUsableItems(player) {
    return player?.inventory && player.inventory.length > 0;
  }

  // 액션 처리
  function performAction(actionType) {
    if (!gameState || gameState.status !== 'ongoing') return;
    
    currentAction = actionType;
    hideSelections();

    if (actionType === 'attack') {
      showTargetSelection(getEnemyPlayers());
    } else if (actionType === 'item') {
      showItemSelection();
    } else {
      // 방어, 회피는 즉시 실행
      executeAction(actionType);
    }
  }

  function showTargetSelection(targets) {
    const selectionEl = $('#targetSelection');
    const gridEl = $('#targetGrid');
    
    if (!selectionEl || !gridEl) return;
    
    gridEl.innerHTML = '';
    targets.forEach(target => {
      const btn = document.createElement('button');
      btn.className = 'target-btn';
      btn.textContent = `${target.name} (${target.hp}/${target.maxHp})`;
      btn.onclick = () => executeAction(currentAction, target.id);
      gridEl.appendChild(btn);
    });
    
    selectionEl.style.display = 'block';
  }

  function showItemSelection() {
    const selectionEl = $('#itemSelection');
    const gridEl = $('#itemGrid');
    const player = getCurrentPlayer();
    
    if (!selectionEl || !gridEl || !player?.inventory) return;
    
    gridEl.innerHTML = '';
    [...new Set(player.inventory)].forEach(item => {
      const count = player.inventory.filter(i => i === item).length;
      const btn = document.createElement('button');
      btn.className = 'target-btn';
      btn.textContent = `${item} (${count}개)`;
      btn.onclick = () => executeAction('item', null, item);
      gridEl.appendChild(btn);
    });
    
    selectionEl.style.display = 'block';
  }

  function hideSelections() {
    const targetSel = $('#targetSelection');
    const itemSel = $('#itemSelection');
    if (targetSel) targetSel.style.display = 'none';
    if (itemSel) itemSel.style.display = 'none';
  }

  function getEnemyPlayers() {
    if (!gameState?.teams) return [];
    const enemyTeam = selectedTeam === 'team1' ? 'team2' : 'team1';
    return gameState.teams[enemyTeam]?.players?.filter(p => p.alive) || [];
  }

  async function executeAction(action, targetId = null, item = null) {
    try {
      const payload = { action, playerId };
      if (targetId) payload.targetId = targetId;
      if (item) payload.item = item;

      await apiCall(`/api/battles/${battleId}/actions`, {
        method: 'POST',
        body: JSON.stringify(payload)
      });

      hideSelections();
      currentAction = null;
      
    } catch (error) {
      // 오류는 이미 apiCall에서 처리됨
    }
  }

  // 채팅
  function addChatMessage(message) {
    const chatEl = $('#chatLog');
    if (!chatEl) return;

    const div = document.createElement('div');
    div.className = 'chat-message';
    div.innerHTML = `
      <span class="chat-sender">${message.sender}:</span>
      ${message.message}
    `;
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function sendChat() {
    const input = $('#chatInput');
    const message = input.value.trim();
    
    if (!message || !socket) return;
    
    socket.emit('send-chat', {
      battleId,
      message,
      senderType: 'player'
    });
    
    input.value = '';
  }

  // 이벤트 리스너
  $('#playerName').addEventListener('input', validateForm);
  $('#battleId').addEventListener('input', validateForm);
  $('#otp').addEventListener('input', validateForm);

  $('#joinTeam1').addEventListener('click', () => {
    selectedTeam = 'team1';
    $('#joinTeam1').classList.add('selected');
    $('#joinTeam2').classList.remove('selected');
    validateForm();
  });

  $('#joinTeam2').addEventListener('click', () => {
    selectedTeam = 'team2';
    $('#joinTeam2').classList.add('selected');
    $('#joinTeam1').classList.remove('selected');
    validateForm();
  });

  $('#loginBtn').addEventListener('click', joinBattle);
  $('#joinBattleBtn').addEventListener('click', completeBattleJoin);

  $('#attackBtn').addEventListener('click', () => performAction('attack'));
  $('#defendBtn').addEventListener('click', () => performAction('defend'));
  $('#evadeBtn').addEventListener('click', () => performAction('evade'));
  $('#useItemBtn').addEventListener('click', () => performAction('item'));

  $('#chatInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendChat();
  });
  $('#sendChatBtn').addEventListener('click', sendChat);

  // 초기 설정
  updateStatsDisplay();
  updateItemsDisplay();
  updateConnectionStatus('connecting', '연결 중...');

  // 소켓 연결 시도
  setTimeout(connectSocket, 500);
});
</script>

</body>
</html>
