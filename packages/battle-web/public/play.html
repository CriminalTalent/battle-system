<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>PYXIS 전투 아레나</title>
<style>
:root {
  --deep-navy: #0a0f1a;
  --navy: #0f1419;
  --navy-light: #1a1f26;
  --gold: #E5C88A;
  --gold-light: #F5E6B8;
  --gold-dark: #C8A882;
  --accent: #2a3441;
  --text-primary: #F5E6B8;
  --text-secondary: #D4C39A;
  --border: rgba(229, 200, 138, 0.3);
  --border-light: rgba(229, 200, 138, 0.15);
  --shadow: rgba(229, 200, 138, 0.2);
  --glass: rgba(15, 20, 25, 0.85);
  --glass-dark: rgba(10, 15, 26, 0.9);
  --timer-warning: #e74c3c;
  --timer-critical: #c0392b;
  --success: #27ae60;
  --warning: #f39c12;
  --danger: #e74c3c;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  -webkit-tap-highlight-color: transparent;
}

body {
  background: linear-gradient(135deg, var(--deep-navy) 0%, var(--navy) 50%, var(--navy-light) 100%);
  color: var(--text-primary);
  font-family: 'Cinzel', 'Times New Roman', serif;
  min-height: 100vh;
  overflow-x: hidden;
  position: relative;
  font-size: 16px;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: 
    radial-gradient(circle at 20% 20%, rgba(229, 200, 138, 0.05) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(229, 200, 138, 0.05) 0%, transparent 50%),
    radial-gradient(circle at 40% 60%, rgba(229, 200, 138, 0.03) 0%, transparent 50%);
  pointer-events: none;
  z-index: -1;
}

.arena-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 15px;
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.arena-header {
  background: var(--glass-dark);
  border: 2px solid var(--border);
  border-radius: 16px;
  padding: 20px;
  text-align: center;
  backdrop-filter: blur(20px);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(229, 200, 138, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.arena-title {
  font-size: clamp(1.5rem, 4vw, 2.2rem);
  color: var(--gold);
  text-shadow: 0 0 20px rgba(229, 200, 138, 0.5);
  letter-spacing: 2px;
  font-weight: 700;
}

.connection-status {
  display: inline-block;
  background: rgba(229, 200, 138, 0.15);
  border: 1px solid var(--border-light);
  border-radius: 20px;
  padding: 8px 16px;
  font-size: 0.9rem;
  color: var(--gold);
  font-weight: 600;
}

.connection-status.connected {
  background: rgba(39, 174, 96, 0.2);
  border-color: var(--success);
  color: var(--success);
}

.connection-status.disconnected {
  background: rgba(231, 76, 60, 0.2);
  border-color: var(--danger);
  color: var(--danger);
}

.login-panel {
  background: var(--glass);
  border: 1px solid var(--border-light);
  border-radius: 16px;
  padding: 25px;
  backdrop-filter: blur(15px);
  max-width: 800px;
  margin: 40px auto;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.login-title {
  font-size: 1.5rem;
  color: var(--gold);
  margin-bottom: 20px;
  text-align: center;
  font-weight: 700;
}

.form-grid {
  display: grid;
  gap: 16px;
}

.form-grid.cols-2 { grid-template-columns: 1fr 1fr; }
.form-grid.cols-3 { grid-template-columns: 1fr 1fr 1fr; }

.form-field {
  background: var(--glass);
  border: 1px solid var(--border-light);
  border-radius: 12px;
  padding: 16px;
}

.form-label {
  font-size: 0.9rem;
  color: var(--gold);
  font-weight: 600;
  margin-bottom: 8px;
}

.form-input {
  width: 100%;
  background: rgba(10, 15, 26, 0.8);
  border: 1px solid var(--border-light);
  border-radius: 8px;
  padding: 12px 16px;
  color: var(--text-primary);
  font-size: 0.95rem;
  transition: all 0.3s ease;
  font-family: inherit;
}

.form-input:focus {
  outline: none;
  border-color: var(--gold);
  box-shadow: 0 0 0 2px rgba(229, 200, 138, 0.2);
}

.team-selection {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.team-btn {
  background: transparent;
  border: 2px solid var(--border-light);
  border-radius: 12px;
  padding: 16px 20px;
  color: var(--text-primary);
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: inherit;
  text-align: center;
}

.team-btn:hover {
  border-color: var(--gold);
  color: var(--gold);
}

.team-btn.selected {
  background: rgba(229, 200, 138, 0.15);
  border-color: var(--gold);
  color: var(--gold);
  box-shadow: 0 0 20px rgba(229, 200, 138, 0.2);
}

.btn {
  background: linear-gradient(135deg, var(--gold-dark), var(--gold));
  border: 1px solid var(--gold);
  border-radius: 8px;
  padding: 14px 24px;
  color: var(--deep-navy);
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-size: 0.9rem;
  font-family: inherit;
  border: none;
}

.btn:hover:not(:disabled) {
  background: linear-gradient(135deg, var(--gold), var(--gold-light));
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(229, 200, 138, 0.3);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
  background: var(--accent);
  color: var(--text-secondary);
}

.login-actions {
  text-align: center;
  margin-top: 20px;
}

.battle-status {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.status-card {
  background: var(--glass);
  border: 1px solid var(--border-light);
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  backdrop-filter: blur(10px);
}

.status-label {
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 8px;
  font-weight: 600;
  text-transform: uppercase;
}

.status-value {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--gold);
}

.timer-display {
  font-size: 1.8rem;
  font-weight: 900;
  color: var(--gold);
  text-shadow: 0 0 10px rgba(229, 200, 138, 0.5);
}

.timer-display.warning {
  color: var(--timer-warning);
  text-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
}

.timer-display.critical {
  color: var(--timer-critical);
  text-shadow: 0 0 10px rgba(192, 57, 43, 0.5);
  animation: pulse 1s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

.battlefield {
  display: grid;
  gap: 20px;
}

@media (min-width: 1024px) {
  .battlefield {
    grid-template-columns: 1fr 1.2fr 1fr;
  }
}

@media (max-width: 1023px) {
  .battlefield {
    grid-template-columns: 1fr;
  }
}

.team-panel {
  background: var(--glass);
  border: 1px solid var(--border-light);
  border-radius: 16px;
  padding: 20px;
  backdrop-filter: blur(15px);
}

.team-header {
  text-align: center;
  font-size: 1.2rem;
  font-weight: 700;
  margin-bottom: 20px;
  padding: 12px;
  border-radius: 10px;
  background: rgba(229, 200, 138, 0.1);
  color: var(--gold);
  border: 1px solid var(--border-light);
}

.player-list {
  display: grid;
  gap: 12px;
}

.player-card {
  background: rgba(10, 15, 26, 0.6);
  border: 1px solid var(--border-light);
  border-radius: 12px;
  padding: 15px;
  transition: all 0.3s ease;
  display: grid;
  grid-template-columns: 60px 1fr auto;
  gap: 12px;
  align-items: center;
}

.player-card:hover {
  border-color: var(--gold);
  transform: translateY(-2px);
}

.player-avatar {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  border: 2px solid var(--border-light);
  background: radial-gradient(circle at 30% 30%, rgba(229, 200, 138, 0.3), rgba(229, 200, 138, 0.1));
  background-size: cover;
  background-position: center;
}

.player-info {
  min-width: 0;
}

.player-name {
  font-weight: 700;
  color: var(--gold);
  margin-bottom: 4px;
  font-size: 1rem;
}

.player-status {
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 8px;
}

.health-bar {
  background: rgba(10, 15, 26, 0.8);
  border-radius: 10px;
  height: 8px;
  overflow: hidden;
  margin-bottom: 8px;
}

.health-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--success), var(--warning), var(--danger));
  transition: width 0.5s ease;
}

.player-stats {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 4px;
  font-size: 0.75rem;
  color: var(--text-secondary);
}

.stat-item {
  text-align: center;
  padding: 2px;
}

.action-panel {
  background: var(--glass-dark);
  border: 2px solid var(--border);
  border-radius: 16px;
  padding: 20px;
  margin-top: 20px;
}

.action-title {
  font-size: 1.1rem;
  color: var(--gold);
  margin-bottom: 16px;
  font-weight: 700;
  text-align: center;
}

.action-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-bottom: 20px;
}

.action-btn {
  background: transparent;
  border: 2px solid var(--gold);
  border-radius: 12px;
  padding: 16px 12px;
  color: var(--gold);
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: inherit;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  min-height: 60px;
  font-size: 0.9rem;
}

.action-btn:hover:not(:disabled) {
  background: rgba(229, 200, 138, 0.15);
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(229, 200, 138, 0.3);
}

.action-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  border-color: var(--border-light);
  color: var(--text-secondary);
}

.target-selection {
  margin-bottom: 16px;
}

.selection-label {
  color: var(--gold);
  font-weight: 700;
  margin-bottom: 8px;
  font-size: 0.9rem;
}

.target-select {
  width: 100%;
  background: rgba(10, 15, 26, 0.8);
  border: 1px solid var(--border-light);
  border-radius: 8px;
  padding: 12px;
  color: var(--text-primary);
  font-family: inherit;
  min-height: 120px;
}

.target-select:focus {
  outline: none;
  border-color: var(--gold);
}

.item-section {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 12px;
  align-items: end;
}

.item-select {
  background: rgba(10, 15, 26, 0.8);
  border: 1px solid var(--border-light);
  border-radius: 8px;
  padding: 12px;
  color: var(--text-primary);
  font-family: inherit;
  min-height: 80px;
}

.item-controls {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.item-qty {
  width: 80px;
  background: rgba(10, 15, 26, 0.8);
  border: 1px solid var(--border-light);
  border-radius: 6px;
  padding: 8px;
  color: var(--text-primary);
  text-align: center;
  font-family: inherit;
}

.center-panel {
  display: grid;
  gap: 20px;
}

.battle-info {
  background: var(--glass);
  border: 1px solid var(--border-light);
  border-radius: 16px;
  padding: 20px;
  backdrop-filter: blur(15px);
}

.info-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}

.info-item {
  background: rgba(10, 15, 26, 0.6);
  border: 1px solid var(--border-light);
  border-radius: 8px;
  padding: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.info-label {
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.info-value {
  color: var(--gold);
  font-weight: 700;
}

.chat-panel {
  background: var(--glass-dark);
  border: 2px solid var(--border);
  border-radius: 16px;
  padding: 20px;
}

.chat-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border-light);
}

.chat-title {
  color: var(--gold);
  font-weight: 700;
  font-size: 1.1rem;
}

.chat-info {
  color: var(--text-secondary);
  font-size: 0.85rem;
}

.chat-messages {
  background: rgba(10, 15, 26, 0.8);
  border: 1px solid var(--border-light);
  border-radius: 10px;
  padding: 15px;
  height: 250px;
  overflow-y: auto;
  margin-bottom: 15px;
  line-height: 1.5;
  font-size: 0.9rem;
}

.chat-messages::-webkit-scrollbar {
  width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
  background: transparent;
}

.chat-messages::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 3px;
}

.chat-input-area {
  display: flex;
  gap: 12px;
}

.chat-input {
  flex: 1;
  background: rgba(10, 15, 26, 0.8);
  border: 1px solid var(--border-light);
  border-radius: 8px;
  padding: 12px 16px;
  color: var(--text-primary);
  font-family: inherit;
}

.chat-input:focus {
  outline: none;
  border-color: var(--gold);
}

.btn-secondary {
  background: linear-gradient(135deg, var(--accent), var(--navy-light));
  border-color: var(--accent);
  color: var(--text-primary);
}

.btn-secondary:hover:not(:disabled) {
  background: linear-gradient(135deg, var(--navy-light), var(--accent));
}

.battle-log {
  background: var(--glass);
  border: 1px solid var(--border-light);
  border-radius: 16px;
  padding: 20px;
}

.log-content {
  background: rgba(10, 15, 26, 0.8);
  border: 1px solid var(--border-light);
  border-radius: 10px;
  padding: 15px;
  height: 200px;
  overflow-y: auto;
  line-height: 1.5;
  font-size: 0.9rem;
}

.notifications {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-width: 350px;
}

.notification {
  background: var(--glass-dark);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px 16px;
  color: var(--text-primary);
  backdrop-filter: blur(15px);
  animation: slideIn 0.3s ease;
  font-size: 0.9rem;
}

.notification.success {
  border-color: var(--success);
  color: var(--success);
}

.notification.error {
  border-color: var(--danger);
  color: var(--danger);
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@media (max-width: 768px) {
  .arena-container {
    padding: 10px;
  }
  
  .arena-header {
    flex-direction: column;
    gap: 12px;
  }
  
  .form-grid.cols-2,
  .form-grid.cols-3 {
    grid-template-columns: 1fr;
  }
  
  .action-grid {
    grid-template-columns: 1fr 1fr;
  }
  
  .info-grid {
    grid-template-columns: 1fr;
  }
  
  .item-section {
    grid-template-columns: 1fr;
  }
  
  .chat-input-area {
    flex-direction: column;
  }
}

@media (hover: none) and (pointer: coarse) {
  .btn:hover {
    transform: none;
    box-shadow: none;
  }
  
  .btn:active {
    transform: scale(0.98);
  }
  
  .action-btn:hover {
    transform: none;
    box-shadow: none;
  }
  
  .action-btn:active {
    transform: scale(0.98);
  }
}
</style>
</head>
<body>

<div class="arena-container">
  <header class="arena-header">
    <h1 class="arena-title">PYXIS 전투 아레나</h1>
    <div class="connection-status" id="connStatus">연결 준비</div>
  </header>

  <!-- 로그인 패널 -->
  <div id="loginPanel" class="login-panel">
    <div class="login-title">전투 참가</div>
    <div class="form-grid cols-2">
      <div class="form-field">
        <div class="form-label">플레이어 이름</div>
        <input id="playerName" class="form-input" placeholder="예: 플레이어1">
      </div>
      <div class="form-field">
        <div class="form-label">아바타 URL</div>
        <input id="avatarUrl" class="form-input" placeholder="선택사항">
      </div>
      <div class="form-field">
        <div class="form-label">전투 ID</div>
        <input id="battleId" class="form-input" placeholder="예: ABC123">
      </div>
      <div class="form-field">
        <div class="form-label">토큰</div>
        <input id="tokenInput" class="form-input" placeholder="토큰">
      </div>
      <div class="form-field" style="grid-column: 1 / -1;">
        <div class="form-label">참가 코드</div>
        <input id="otp" class="form-input" placeholder="6자리 코드">
      </div>
      <div class="form-field" style="grid-column: 1 / -1;">
        <div class="form-label">팀 선택</div>
        <div class="team-selection">
          <button id="joinTeam1" class="team-btn" type="button">불사조 기사단</button>
          <button id="joinTeam2" class="team-btn" type="button">죽음을 먹는 자들</button>
        </div>
      </div>
    </div>
    <div class="login-actions">
      <button id="loginBtn" class="btn" disabled>참가</button>
    </div>
  </div>

  <!-- 전투 상태 요약 -->
  <div id="battleStatus" class="battle-status" style="display: none;">
    <div class="status-card">
      <div class="status-label">단계</div>
      <div class="status-value" id="battlePhase">-</div>
    </div>
    <div class="status-card">
      <div class="status-label">현재 턴</div>
      <div class="status-value" id="turnSide">-</div>
    </div>
    <div class="status-card">
      <div class="status-label">턴 타이머</div>
      <div class="timer-display" id="turnTimer">-</div>
    </div>
    <div class="status-card">
      <div class="status-label">승자</div>
      <div class="status-value" id="winnerStatus">-</div>
    </div>
  </div>

  <!-- 전투장 -->
  <div id="battlefield" class="battlefield" style="display: none;">
    <!-- 불사조 기사단 -->
    <div class="team-panel">
      <div class="team-header">불사조 기사단</div>
      <div id="team1List" class="player-list"></div>
      <div id="actionBoxTeam1"></div>
    </div>

    <!-- 중앙 패널 -->
    <div class="center-panel">
      <div class="battle-info">
        <div class="form-label" style="margin-bottom: 12px;">전투 상태</div>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">단계</span>
            <span class="info-value" id="phaseDetail">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">턴 시간</span>
            <span class="info-value" id="turnRemain">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">시작 시간</span>
            <span class="info-value" id="startAt">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">경과 시간</span>
            <span class="info-value" id="duration">-</span>
          </div>
        </div>
      </div>

      <div class="chat-panel">
        <div class="chat-header">
          <div class="chat-title">실시간 채팅</div>
          <div class="chat-info">플레이어 채널</div>
        </div>
        <div id="chatMessages" class="chat-messages"></div>
        <div class="chat-input-area">
          <input id="chatInput" class="chat-input" placeholder="메시지 입력..." maxlength="200">
          <button id="chatSendBtn" class="btn">전송</button>
          <button id="refreshBtn" class="btn-secondary">새로고침</button>
        </div>
      </div>

      <div class="battle-log">
        <div class="form-label" style="margin-bottom: 12px;">전투 로그</div>
        <div id="battleLogContent" class="log-content"></div>
      </div>
    </div>

    <!-- 죽음을 먹는 자들 -->
    <div class="team-panel">
      <div class="team-header">죽음을 먹는 자들</div>
      <div id="team2List" class="player-list"></div>
      <div id="actionBoxTeam2"></div>
    </div>
  </div>
</div>

<div id="notifications" class="notifications"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
window.addEventListener('DOMContentLoaded', () => {
  const $ = s => document.querySelector(s);
  const on = (sel, ev, fn) => { const el = $(sel); if (el) el.addEventListener(ev, fn); };
  const qs = new URLSearchParams(location.search);
  
  const ioSock = io({ 
    path: '/socket.io',
    timeout: 10000,
    transports: ['websocket', 'polling']
  });

  let __connectedOnce = false;

  let BATTLE = qs.get('battle') || '';
  $('#battleId').value = BATTLE;
  let TOKEN = qs.get('token') || '';
  $('#tokenInput').value = TOKEN;
  
  let state = {
    socket: null,
    battleId: null,
    playerId: null,
    token: null,
    name: null,
    avatar: null,
    team: null,
    data: null,
    timer: {
      lastMs: 0,
      lastSync: 0,
      interval: null
    }
  };

  function showNotification(msg, type = 'success') {
    const notificationDiv = document.createElement('div');
    notificationDiv.className = `notification ${type}`;
    notificationDiv.textContent = msg;
    $('#notifications').appendChild(notificationDiv);
    setTimeout(() => {
      if (notificationDiv.parentNode) {
        notificationDiv.style.opacity = '0';
        notificationDiv.style.transform = 'translateX(100%)';
        setTimeout(() => notificationDiv.remove(), 300);
      }
    }, type === 'error' ? 4000 : 2500);
  }

  function selectTeam(key) {
    state.team = key;
    $('#joinTeam1').classList.toggle('selected', key === 'team1');
    $('#joinTeam2').classList.toggle('selected', key === 'team2');
    validateForm();
  }

  function validateForm() {
    const ok = $('#playerName').value.trim() && 
               $('#battleId').value.trim() && 
               $('#otp').value.trim() && 
               $('#tokenInput').value.trim() && 
               state.team;
    $('#loginBtn').disabled = !ok;
  }

  ['playerName', 'battleId', 'otp', 'tokenInput'].forEach(id => 
    $('#' + id).addEventListener('input', validateForm)
  );

  $('#joinTeam1').onclick = () => selectTeam('team1');
  $('#joinTeam2').onclick = () => selectTeam('team2');

  $('#loginBtn').onclick = login;
  document.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !$('#loginBtn').disabled && $('#loginPanel').style.display !== 'none') {
      login();
    }
  });

  async function login() {
    try {
      const body = {
        battleId: $('#battleId').value.trim(),
        role: 'player',
        name: $('#playerName').value.trim(),
        otp: $('#otp').value.trim(),
        token: $('#tokenInput').value.trim()
      };

      console.log('Attempting login with:', body);

      const r = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (!r.ok) throw new Error('인증 실패');

      const j = await r.json();
      console.log('Login successful:', j);
      
      state.battleId = body.battleId;
      state.playerId = 'p_' + Math.random().toString(36).slice(2, 8);
      state.token = body.token;
      state.name = body.name || '플레이어';
      state.avatar = $('#avatarUrl').value.trim() || '';

      // 전투에 참가
      await joinBattle();

      $('#loginPanel').style.display = 'none';
      $('#battleStatus').style.display = 'grid';
      $('#battlefield').style.display = 'grid';
      
      // 소켓 연결 및 초기 데이터 로딩
      connect();
      await refresh(); // 초기 상태 로딩
      
      showNotification('전투에 성공적으로 참가했습니다!');
    } catch (e) {
      console.error('Login error:', e);
      showNotification(e.message || '로그인 실패', 'error');
    }
  }

  async function joinBattle() {
    const body = {
      playerId: state.playerId,
      playerName: state.name,
      teamId: state.team,
      stats: { attack: 3, defense: 3, agility: 3, luck: 3 },
      imageUrl: state.avatar,
      items: {},
      customHp: 100
    };

    const r = await fetch(`/api/battles/${state.battleId}/join`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    if (!r.ok) {
      const errorData = await r.json();
      throw new Error(errorData.error || '전투 참가 실패');
    }

    const result = await r.json();
    if (!result.success) {
      throw new Error(result.error || '전투 참가 실패');
    }
  }

  function connect() {
    state.socket = ioSock;
    
    ioSock.on('connect', () => {
      if (!__connectedOnce) { __connectedOnce = true; }

      console.log('Socket connected');
      $('#connStatus').textContent = '연결됨';
      $('#connStatus').className = 'connection-status connected';
      ioSock.emit('join-battle', {
        battleId: state.battleId,
        playerId: state.playerId,
        role: (state && state.playerId ? 'player' : 'spectator'),
        team: state.team
      });
      setTimeout(refresh, 500);
    });

    ioSock.on('disconnect', () => {
      console.log('Socket disconnected');
      $('#connStatus').textContent = '연결 끊김';
      $('#connStatus').className = 'connection-status disconnected';
    });

    ioSock.on('reconnect', () => {
      console.log('Socket reconnected');
      showNotification('연결이 복구되었습니다!');
      if (state.battleId) {
        ioSock.emit('join-battle', {
          battleId: state.battleId,
          playerId: state.playerId,
          role: 'player',
          team: state.team
        });
        setTimeout(refresh, 300);
      }
    });

    ioSock.on('battle-state', d => {
      console.log('Battle state received:', d);
      if (d && d.id === state.battleId) {
        state.data = d;
        render(true);
      }
    });

    ioSock.on('player-joined', d => {
      console.log('Player joined event:', d);
      if (d && d.state && d.battleId === state.battleId) {
        state.data = d.state;
        render(true);
        showNotification('새 플레이어가 참가했습니다');
      }
    });

    ioSock.on('battle-started', d => {
      console.log('Battle started event:', d);
      if (d && d.state && d.battleId === state.battleId) {
        state.data = d.state;
        render(true);
        showNotification('전투가 시작되었습니다!');
      }
    });

    ioSock.on('action-executed', d => {
      console.log('Action executed event:', d);
      if (d && d.state && d.battleId === state.battleId) {
        state.data = d.state;
        render(true);
      }
    });

    ioSock.on('battle-ended', d => {
      console.log('Battle ended event:', d);
      if (d && d.state && d.battleId === state.battleId) {
        state.data = d.state;
        render(true);
        const winnerText = d.winner === 'team1' ? '불사조 기사단' : 
                          d.winner === 'team2' ? '죽음을 먹는 자들' : '무승부';
        showNotification(`전투 종료! 승자: ${winnerText}`);
      }
    });

    ioSock.on('chat-message', ({ battleId, message }) => {
      console.log('Chat message received:', { battleId, message });
      if (battleId === state.battleId && message) {
        if (!state.data) state.data = { chatLog: [] };
        if (!state.data.chatLog) state.data.chatLog = [];
        
        // 중복 메시지 방지
        const isDuplicate = state.data.chatLog.some(existing => 
          existing.id === message.id || 
          (existing.timestamp === message.timestamp && existing.message === message.message && existing.sender === message.sender)
        );
        
        if (!isDuplicate) {
          state.data.chatLog.push(message);
          // 최대 100개 메시지 유지
          if (state.data.chatLog.length > 100) {
            state.data.chatLog = state.data.chatLog.slice(-100);
          }
        }
        
        renderChat();
      }
    });

    // 연결 실패 시 재시도
    ioSock.on('connect_error', (error) => {
      console.error('Socket connection error:', error);
      $('#connStatus').textContent = '연결 실패';
      $('#connStatus').className = 'connection-status disconnected';
    });
  }

  function myTeam() {
    const id = state.playerId;
    const t1 = state.data?.teams?.team1 || [];
    const t2 = state.data?.teams?.team2 || [];
    if (t1.find(p => p.id === id)) return 'team1';
    if (t2.find(p => p.id === id)) return 'team2';
    return state.team || null;
  }

  function me() {
    const t = myTeam();
    return t ? (state.data?.teams?.[t] || []).find(p => p.id === state.playerId) || null : null;
  }

  function startTimerFromState() {
    const d = state.data;
    if (!d || !d.remainingTurnTime || d.phase !== 'battle') {
      setTimerLabel('-');
      clearTimer();
      return;
    }
    state.timer.lastMs = Math.max(0, d.remainingTurnTime);
    state.timer.lastSync = Date.now();
    clearTimer();
    state.timer.interval = setInterval(tickTimer, 1000);
    tickTimer();
  }

  function clearTimer() {
    if (state.timer.interval) {
      clearInterval(state.timer.interval);
      state.timer.interval = null;
    }
  }

  function tickTimer() {
    const left = Math.max(0, state.timer.lastMs - (Date.now() - state.timer.lastSync));
    const m = Math.floor(left / 60000);
    const s = Math.floor((left % 60000) / 1000);
    const t = `${m}:${s.toString().padStart(2, '0')}`;
    
    const el = $('#turnTimer');
    el.textContent = t;
    el.className = 'timer-display';
    if (left < 30000) el.className += ' critical';
    else if (left < 60000) el.className += ' warning';
    
    $('#turnRemain').textContent = t;
    if (left === 0) clearTimer();
  }

  function setTimerLabel(t) {
    const el = $('#turnTimer');
    el.textContent = t;
    el.className = 'timer-display';
  }

  function render(fromServer = false) {
    const d = state.data;
    if (!d) return;

    console.log('Rendering data:', d);
    console.log('My team:', myTeam(), 'My player:', me());

    const phaseText = {
      'lobby': '대기실',
      'battle': '전투 중',
      'ended': '종료'
    };

    const teamText = {
      'team1': '불사조 기사단',
      'team2': '죽음을 먹는 자들'
    };

    const winnerText = {
      'team1': '불사조 기사단',
      'team2': '죽음을 먹는 자들',
      'draw': '무승부'
    };

    $('#battlePhase').textContent = phaseText[d.phase] || d.phase;
    $('#turnSide').textContent = d.currentTeam ? `${teamText[d.currentTeam]} 턴` : '-';
    $('#phaseDetail').textContent = phaseText[d.phase] || d.phase;
    $('#winnerStatus').textContent = winnerText[d.winner] || '미정';

    if (d.startTime) {
      $('#startAt').textContent = new Date(d.startTime).toLocaleTimeString();
    }

    if (d.startTime && d.phase === 'battle') {
      const elapsed = Date.now() - d.startTime;
      const minutes = Math.floor(elapsed / 60000);
      const seconds = Math.floor((elapsed % 60000) / 1000);
      $('#duration').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    } else {
      $('#duration').textContent = '-';
    }

    if (fromServer) startTimerFromState();

    renderTeam('team1', '#team1List');
    renderTeam('team2', '#team2List');
    renderActionBox(); // 액션 박스 렌더링
    renderBattleLog();
    renderChat();
  }

  function renderTeam(key, sel) {
    const box = $(sel);
    const list = state.data?.teams?.[key] || [];
    
    if (!list.length) {
      box.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">참가 대기</div>';
      return;
    }

    box.innerHTML = '';
    list.forEach(p => {
      const hp = p.maxHp ? Math.max(0, Math.round((p.hp / p.maxHp) * 100)) : 0;
      
      // 아이템 개수 계산
      const itemCounts = {};
      (p.inventory || []).forEach(item => {
        itemCounts[item] = (itemCounts[item] || 0) + 1;
      });
      const itemText = Object.entries(itemCounts)
        .map(([item, count]) => `${item}: ${count}`)
        .join(', ') || '없음';
      
      const div = document.createElement('div');
      div.className = 'player-card';
      div.innerHTML = `
        <div class="player-avatar" style="background-image: url('${p.imageUrl || ''}')"></div>
        <div class="player-info">
          <div class="player-name">${p.name}</div>
          <div class="player-status">${p.hp}/${p.maxHp} HP • ${p.alive ? '생존' : '전사'} • ${p.hasActed ? '행동완료' : '대기'}</div>
          <div class="health-bar">
            <div class="health-fill" style="width: ${hp}%"></div>
          </div>
          <div class="player-stats">
            <div class="stat-item">공격 ${p.stats?.attack ?? '-'}</div>
            <div class="stat-item">방어 ${p.stats?.defense ?? '-'}</div>
            <div class="stat-item">민첩 ${p.stats?.agility ?? '-'}</div>
            <div class="stat-item">행운 ${p.stats?.luck ?? '-'}</div>
          </div>
          <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;">
            아이템: ${itemText}
          </div>
        </div>
        <div style="text-align: center; color: var(--gold); font-weight: 700;">${hp}%</div>
      `;
      box.appendChild(div);
    });
  }

  function renderActionBox() {
    const t = myTeam();
    const myPlayer = me();
    const canAct = state.data?.phase === 'battle' && 
                   state.data?.currentTeam === t && 
                   myPlayer?.alive && 
                   !myPlayer?.hasActed;

    console.log('renderActionBox:', { 
      team: t, 
      phase: state.data?.phase, 
      currentTeam: state.data?.currentTeam, 
      alive: myPlayer?.alive, 
      hasActed: myPlayer?.hasActed,
      canAct 
    });

    // 항상 액션 패널을 표시하되, 버튼만 비활성화
    const html = `
      <div class="action-panel">
        <div class="action-title">전투 행동 ${canAct ? '(내 턴)' : '(대기 중)'}</div>
        <div class="action-grid">
          <button id="attackBtn" class="action-btn" ${!canAct ? 'disabled' : ''}>공격</button>
          <button id="defendBtn" class="action-btn" ${!canAct ? 'disabled' : ''}>방어</button>
          <button id="dodgeBtn" class="action-btn" ${!canAct ? 'disabled' : ''}>회피</button>
          <button id="itemBtn" class="action-btn" ${!canAct ? 'disabled' : ''}>아이템</button>
          <button id="passBtn" class="action-btn" ${!canAct ? 'disabled' : ''}>패스</button>
        </div>
        <div class="target-selection">
          <div class="selection-label">대상 선택</div>
          <select id="targetSelect" class="target-select" size="4" ${!canAct ? 'disabled' : ''}>
            <option value="" selected>적을 선택하세요</option>
          </select>
        </div>
        <div class="target-selection">
          <div class="selection-label">아이템 사용</div>
          <div class="item-section">
            <select id="itemSelect" class="item-select" size="3" ${!canAct ? 'disabled' : ''}></select>
            <div class="item-controls">
              <input id="itemQty" class="item-qty" type="number" min="1" value="1" ${!canAct ? 'disabled' : ''}>
              <button id="itemUseBtn" class="action-btn" ${!canAct ? 'disabled' : ''}>사용</button>
            </div>
          </div>
        </div>
      </div>
    `;

    // 내 팀에만 액션 박스 표시
    if (t === 'team1') {
      $('#actionBoxTeam1').innerHTML = html;
      $('#actionBoxTeam2').innerHTML = '';
    } else if (t === 'team2') {
      $('#actionBoxTeam1').innerHTML = '';
      $('#actionBoxTeam2').innerHTML = html;
    } else {
      $('#actionBoxTeam1').innerHTML = '';
      $('#actionBoxTeam2').innerHTML = '';
    }

    // 이벤트 리스너 등록 (항상)
    setTimeout(() => {
      const attackBtn = $('#attackBtn');
      const defendBtn = $('#defendBtn');
      const dodgeBtn = $('#dodgeBtn');
      const passBtn = $('#passBtn');
      const itemUseBtn = $('#itemUseBtn');

      if (attackBtn) attackBtn.onclick = () => {
        if (!canAct) return;
        const tgt = $('#targetSelect').value;
        if (!tgt) {
          showNotification('공격 대상을 선택하세요', 'error');
          return;
        }
        doAction('attack', { targetId: tgt });
      };

      if (defendBtn) defendBtn.onclick = () => {
        if (!canAct) return;
        doAction('defend');
      };
      
      if (dodgeBtn) dodgeBtn.onclick = () => {
        if (!canAct) return;
        doAction('dodge');
      };
      
      if (passBtn) passBtn.onclick = () => {
        if (!canAct) return;
        doAction('pass');
      };
      
      if (itemUseBtn) itemUseBtn.onclick = () => {
        if (!canAct) return;
        const opt = $('#itemSelect')?.selectedOptions?.[0];
        if (!opt) {
          showNotification('아이템을 선택하세요', 'error');
          return;
        }
        doAction('use_item', { itemName: opt.value });
      };

      // 대상과 아이템 렌더링
      renderTargets();
      renderItems();
    }, 100);
  }

  function renderTargets() {
    const sel = $('#targetSelect');
    if (!sel) return;
    
    sel.innerHTML = '<option value="">적을 선택하세요</option>';
    const t = myTeam();
    if (!t || !state.data?.teams) return;
    
    const enemies = t === 'team1' ? (state.data.teams.team2 || []) : (state.data.teams.team1 || []);
    enemies.filter(p => p.alive).forEach(p => {
      const o = document.createElement('option');
      o.value = p.id;
      o.textContent = `${p.name} (HP ${p.hp}/${p.maxHp})`;
      sel.appendChild(o);
    });
  }

  function renderItems() {
    const sel = $('#itemSelect');
    if (!sel) return;
    
    const m = me();
    const list = (m?.inventory || []);
    
    sel.innerHTML = list.length ? 
      list.map(it => `<option value="${it}">${it}</option>`).join('') :
      '<option disabled>아이템 없음</option>';
  }

  function renderBattleLog() {
    const el = $('#battleLogContent');
    if (!el) return;
    
    const entries = (state.data?.battleLog || []).slice(-20);
    el.innerHTML = entries.map(e => `
      <div style="padding: 8px 0; border-bottom: 1px solid rgba(229, 200, 138, 0.1); line-height: 1.4;">
        <strong style="color: var(--gold);">${e.type}</strong> - 
        <span style="color: var(--text-primary);">${e.result || ''}</span>
        <br><small style="color: var(--text-secondary);">${new Date(e.timestamp).toLocaleTimeString()}</small>
      </div>
    `).join('') || '<div style="text-align: center; color: var(--text-secondary);">전투 로그가 없습니다</div>';
    el.scrollTop = el.scrollHeight;
  }

  function renderChat() {
    const el = $('#chatMessages');
    if (!el) return;
    
    const messages = (state.data?.chatLog || []).slice(-30);
    console.log('Rendering chat messages:', messages.length);
    
    if (messages.length === 0) {
      el.innerHTML = '<div style="color: var(--gold); text-align: center; padding: 20px; font-style: italic;">채팅이 없습니다</div>';
    } else {
      el.innerHTML = messages.map(e => {
        const time = new Date(e.timestamp).toLocaleTimeString();
        const senderColor = e.senderType === 'system' ? '#E5C88A' : 
                           e.senderType === 'admin' ? '#C8A882' : 
                           e.senderType === 'spectator' ? '#F5E6B8' : '#D4C39A';
        return `
          <div style="padding: 6px 0; border-bottom: 1px dashed rgba(229, 200, 138, 0.1); line-height: 1.4;">
            <span style="color: ${senderColor}; font-weight: 600; font-size: 0.85rem;">[${time}] ${e.sender}:</span>
            <span style="color: #F5E6B8; margin-left: 8px; font-size: 0.9rem;">${e.message}</span>
          </div>
        `;
      }).join('');
    }
    
    el.scrollTop = el.scrollHeight;
  }

  async function doAction(type, payload = {}) {
    try {
      const r = await fetch(`/api/battles/${state.battleId}/action`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          playerId: state.playerId,
          action: { type, ...payload }
        })
      });

      const j = await r.json();
      
      if (!r.ok) {
        throw new Error(j.error || `HTTP ${r.status}`);
      }

      if (!j.success) {
        throw new Error(j.error || '행동 실행 실패');
      }
      
      showNotification('행동이 성공적으로 실행되었습니다!');
    } catch (e) {
      showNotification(e.message || '행동 실행 실패', 'error');
    }
  }

  $('#chatSendBtn').onclick = sendChat;
  $('#chatInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') sendChat();
  });

  function sendChat() {
    const v = $('#chatInput').value.trim();
    if (!v || !state.socket) return;
    
    if (v.length > 200) {
      showNotification('메시지는 200자 이하여야 합니다', 'error');
      return;
    }

    state.socket.emit('chat-message', {
      battleId: state.battleId,
      sender: state.name || 'Player',
      message: v,
      senderType: 'player'
    });

    $('#chatInput').value = '';
  }

  $('#refreshBtn').onclick = refresh;

  async function refresh() {
    if (!state.battleId) return;
    try {
      console.log('Refreshing battle state for:', state.battleId);
      const r = await fetch(`/api/battles/${state.battleId}/state`);
      if (!r.ok) throw new Error('새로고침 실패');
      const newData = await r.json();
      console.log('Received battle data:', newData);
      state.data = newData;
      render(true);
    } catch (e) {
      console.error('Refresh failed:', e);
      showNotification('새로고침 실패', 'error');
    }
  }

  // 주기적 새로고침 설정
  setInterval(() => {
    if (state.battleId && !ioSock.connected) {
      console.log('Socket disconnected, manual refresh...');
      refresh();
    }
  }, 10000);

  // 초기 설정
  if (BATTLE) {
    $('#battleId').value = BATTLE;
    console.log('Initial battle ID set:', BATTLE);
  }
  if (TOKEN) {
    $('#tokenInput').value = TOKEN;
    console.log('Initial token set:', TOKEN);
  }
});
</script>
</body>
</html>
