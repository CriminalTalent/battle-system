<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>PYXIS 전투 아레나</title>
<style>
:root {
  --deep-navy: #0a0f1a;
  --navy: #0f1419;
  --navy-light: #1a1f26;
  --gold: #E5C88A;
  --gold-light: #F5E6B8;
  --gold-dark: #C8A882;
  --accent: #2a3441;
  --text-primary: #F5E6B8;
  --text-secondary: #D4C39A;
  --border: rgba(229, 200, 138, 0.3);
  --border-light: rgba(229, 200, 138, 0.15);
  --shadow: rgba(229, 200, 138, 0.2);
  --glass: rgba(15, 20, 25, 0.85);
  --glass-dark: rgba(10, 15, 26, 0.9);
  --timer-warning: #e74c3c;
  --timer-critical: #c0392b;
  --success: #27ae60;
  --warning: #f39c12;
  --danger: #e74c3c;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  -webkit-tap-highlight-color: transparent;
}

body {
  background: linear-gradient(135deg, var(--deep-navy) 0%, var(--navy) 50%, var(--navy-light) 100%);
  color: var(--text-primary);
  font-family: 'Cinzel', 'Times New Roman', serif;
  min-height: 100vh;
  overflow-x: hidden;
  position: relative;
  font-size: 16px;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: 
    radial-gradient(circle at 20% 20%, rgba(229, 200, 138, 0.05) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(229, 200, 138, 0.05) 0%, transparent 50%),
    radial-gradient(circle at 40% 60%, rgba(229, 200, 138, 0.03) 0%, transparent 50%);
  pointer-events: none;
  z-index: -1;
}

.arena-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 15px;
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.arena-header {
  background: var(--glass-dark);
  border: 2px solid var(--border);
  border-radius: 16px;
  padding: 20px;
  text-align: center;
  backdrop-filter: blur(20px);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(229, 200, 138, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.arena-title {
  font-size: clamp(1.5rem, 4vw, 2.2rem);
  color: var(--gold);
  text-shadow: 0 0 20px rgba(229, 200, 138, 0.5);
  letter-spacing: 2px;
  font-weight: 700;
}

.connection-status {
  display: inline-block;
  background: rgba(229, 200, 138, 0.15);
  border: 1px solid var(--border-light);
  border-radius: 20px;
  padding: 8px 16px;
  font-size: 0.9rem;
  color: var(--gold);
  font-weight: 600;
}

.connection-status.connected {
  background: rgba(39, 174, 96, 0.2);
  border-color: rgba(39, 174, 96, 0.5);
  color: var(--success);
}

.connection-status.disconnected {
  background: rgba(231, 76, 60, 0.2);
  border-color: rgba(231, 76, 60, 0.5);
  color: var(--danger);
}

.login-panel {
  background: var(--glass);
  border: 1px solid var(--border-light);
  border-radius: 16px;
  padding: 30px;
  backdrop-filter: blur(15px);
  max-width: 500px;
  margin: 50px auto;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.login-title {
  font-size: 2rem;
  color: var(--gold);
  text-align: center;
  margin-bottom: 30px;
  font-weight: 700;
  text-shadow: 0 0 15px rgba(229, 200, 138, 0.5);
}

.form-grid {
  display: grid;
  gap: 15px;
}

.cols-2 { grid-template-columns: repeat(2, 1fr); }
.cols-3 { grid-template-columns: repeat(3, 1fr); }

@media (max-width: 768px) {
  .cols-2, .cols-3 { grid-template-columns: 1fr; }
}

.form-field {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-label {
  font-size: 0.9rem;
  color: var(--text-secondary);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.form-input {
  background: rgba(42, 52, 65, 0.7);
  border: 1px solid var(--border-light);
  border-radius: 8px;
  padding: 14px 18px;
  color: var(--text-primary);
  font-size: 1rem;
  font-family: inherit;
  transition: all 0.3s ease;
}

.form-input:focus {
  outline: none;
  border-color: var(--gold);
  box-shadow: 0 0 0 3px rgba(229, 200, 138, 0.1);
  background: rgba(42, 52, 65, 0.9);
}

.form-input::placeholder {
  color: var(--text-secondary);
  opacity: 0.7;
}

.btn {
  background: linear-gradient(135deg, var(--gold), var(--gold-dark));
  color: var(--deep-navy);
  padding: 14px 28px;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-size: 1rem;
  font-family: inherit;
  border: none;
  width: 100%;
}

.btn:hover:not(:disabled) {
  background: linear-gradient(135deg, var(--gold-light), var(--gold));
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(229, 200, 138, 0.4);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
  background: var(--accent);
  color: var(--text-secondary);
}

.btn-secondary {
  background: linear-gradient(135deg, var(--accent), var(--navy-light));
  color: var(--text-primary);
  border: 1px solid var(--border-light);
}

.btn-secondary:hover:not(:disabled) {
  background: linear-gradient(135deg, var(--navy-light), var(--accent));
  border-color: var(--border);
}

.btn-action {
  padding: 10px 20px;
  font-size: 0.9rem;
  margin: 0 5px;
  border-radius: 8px;
}

.btn-danger {
  background: linear-gradient(135deg, var(--danger), #c0392b);
  color: white;
}

.btn-danger:hover:not(:disabled) {
  background: linear-gradient(135deg, #c0392b, var(--danger));
}

.login-actions {
  text-align: center;
  margin-top: 25px;
}

.battle-layout {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 20px;
}

@media (max-width: 1024px) {
  .battle-layout {
    grid-template-columns: 1fr;
    gap: 15px;
  }
}

.team-display {
  background: var(--glass);
  border: 1px solid var(--border-light);
  border-radius: 16px;
  padding: 20px;
  backdrop-filter: blur(15px);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
}

.team-header {
  text-align: center;
  font-size: 1.3rem;
  font-weight: 700;
  margin-bottom: 20px;
  padding: 15px;
  border-radius: 12px;
  text-shadow: 0 0 10px rgba(229, 200, 138, 0.5);
}

.team-phoenix .team-header {
  background: linear-gradient(135deg, rgba(231, 76, 60, 0.2), rgba(192, 57, 43, 0.2));
  color: #e74c3c;
  border: 1px solid rgba(231, 76, 60, 0.3);
}

.team-deatheater .team-header {
  background: linear-gradient(135deg, rgba(52, 152, 219, 0.2), rgba(41, 128, 185, 0.2));
  color: #3498db;
  border: 1px solid rgba(52, 152, 219, 0.3);
}

.player-card {
  background: rgba(15, 20, 25, 0.7);
  border: 1px solid var(--border-light);
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 15px;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.player-card:hover {
  border-color: var(--border);
  background: rgba(15, 20, 25, 0.9);
  transform: translateY(-2px);
}

.player-card.current-turn {
  border-color: var(--gold);
  box-shadow: 0 0 20px rgba(229, 200, 138, 0.3);
  background: rgba(229, 200, 138, 0.1);
}

.player-card.my-character {
  border-color: var(--success);
  box-shadow: 0 0 15px rgba(39, 174, 96, 0.2);
}

.player-card.dead {
  opacity: 0.5;
  filter: grayscale(70%);
}

.player-info {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 15px;
}

.player-avatar {
  width: 60px;
  height: 60px;
  border-radius: 12px;
  background: var(--accent);
  border: 2px solid var(--border-light);
  object-fit: cover;
  transition: all 0.3s ease;
}

.player-card.current-turn .player-avatar {
  border-color: var(--gold);
  box-shadow: 0 0 15px rgba(229, 200, 138, 0.4);
}

.player-details {
  flex: 1;
}

.player-name {
  font-weight: 700;
  color: var(--gold);
  font-size: 1.1rem;
  margin-bottom: 5px;
}

.player-status {
  font-size: 0.9rem;
  color: var(--text-secondary);
}

.hp-bar {
  background: rgba(42, 52, 65, 0.7);
  border-radius: 10px;
  height: 8px;
  margin: 8px 0;
  overflow: hidden;
}

.hp-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--success) 0%, var(--warning) 70%, var(--danger) 100%);
  transition: width 0.5s ease;
  border-radius: 10px;
}

.player-stats {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
  margin-bottom: 15px;
}

.stat-item {
  text-align: center;
  background: rgba(42, 52, 65, 0.5);
  border-radius: 8px;
  padding: 8px 4px;
  border: 1px solid var(--border-light);
}

.stat-label {
  font-size: 0.7rem;
  color: var(--text-secondary);
  display: block;
  text-transform: uppercase;
}

.stat-value {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--gold);
  display: block;
  margin-top: 2px;
}

.player-items {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.item-tag {
  background: rgba(229, 200, 138, 0.15);
  color: var(--gold);
  border: 1px solid var(--border-light);
  border-radius: 12px;
  padding: 4px 8px;
  font-size: 0.7rem;
  font-weight: 600;
}

.turn-info {
  background: var(--glass);
  border: 1px solid var(--border-light);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  text-align: center;
  backdrop-filter: blur(10px);
}

.turn-player {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--gold);
  margin-bottom: 10px;
}

.turn-timer {
  font-size: 2.5rem;
  font-weight: 900;
  color: var(--gold);
  text-shadow: 0 0 20px rgba(229, 200, 138, 0.6);
  margin: 15px 0;
}

.turn-timer.warning {
  color: var(--timer-warning);
  text-shadow: 0 0 20px rgba(231, 76, 60, 0.6);
}

.turn-timer.critical {
  color: var(--timer-critical);
  text-shadow: 0 0 20px rgba(192, 57, 43, 0.6);
  animation: pulse 1s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.action-panel {
  background: var(--glass);
  border: 1px solid var(--border-light);
  border-radius: 12px;
  padding: 20px;
  backdrop-filter: blur(10px);
}

.action-title {
  font-size: 1.3rem;
  color: var(--gold);
  margin-bottom: 20px;
  text-align: center;
  font-weight: 700;
}

.action-buttons {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.target-selection {
  margin: 15px 0;
}

.target-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-top: 10px;
}

.target-option {
  background: rgba(42, 52, 65, 0.7);
  border: 1px solid var(--border-light);
  border-radius: 8px;
  padding: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 12px;
}

.target-option:hover {
  border-color: var(--border);
  background: rgba(42, 52, 65, 0.9);
}

.target-option.selected {
  border-color: var(--gold);
  background: rgba(229, 200, 138, 0.1);
}

.battle-log {
  background: var(--glass);
  border: 1px solid var(--border-light);
  border-radius: 12px;
  padding: 20px;
  backdrop-filter: blur(10px);
  max-height: 300px;
  overflow-y: auto;
}

.log-title {
  font-size: 1.2rem;
  color: var(--gold);
  margin-bottom: 15px;
  font-weight: 700;
}

.log-entry {
  padding: 8px 0;
  border-bottom: 1px solid var(--border-light);
  font-size: 0.9rem;
  line-height: 1.4;
}

.log-entry:last-child {
  border-bottom: none;
}

.log-timestamp {
  color: var(--text-secondary);
  font-size: 0.8rem;
  margin-right: 10px;
}

.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 16px 20px;
  border-radius: 10px;
  font-weight: 600;
  color: white;
  z-index: 1000;
  max-width: 400px;
  word-wrap: break-word;
  box-shadow: 0 6px 25px rgba(0, 0, 0, 0.3);
  backdrop-filter: blur(10px);
}

.notification.success {
  background: linear-gradient(135deg, var(--success), #27ae60);
}

.notification.error {
  background: linear-gradient(135deg, var(--danger), #c0392b);
}

.notification.warning {
  background: linear-gradient(135deg, var(--warning), #e67e22);
}

.spectator-mode {
  background: rgba(52, 152, 219, 0.1);
  border: 1px solid rgba(52, 152, 219, 0.3);
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 20px;
  text-align: center;
}

.spectator-mode h3 {
  color: #3498db;
  margin-bottom: 10px;
}

.hidden { display: none !important; }

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.arena-container > * {
  animation: fadeIn 0.5s ease-out;
}
</style>
</head>

<body>
<div class="arena-container">
  <!-- 로그인 패널 -->
  <div id="loginPanel" class="login-panel">
    <div class="login-title">전투 참가</div>
    <div class="form-grid cols-2">
      <div class="form-field" style="grid-column: 1 / -1;">
        <div class="form-label">캐릭터 이름</div>
        <input id="playerName" class="form-input" placeholder="예: 해리 포터">
      </div>
      <div class="form-field">
        <div class="form-label">전투 ID</div>
        <input id="battleId" class="form-input" placeholder="예: ABC123">
      </div>
      <div class="form-field">
        <div class="form-label">토큰</div>
        <input id="tokenInput" class="form-input" placeholder="토큰">
      </div>
      <div class="form-field" style="grid-column: 1 / -1;">
        <div class="form-label">참가 코드</div>
        <input id="otp" class="form-input" placeholder="6자리 코드">
      </div>
      <div class="form-field">
        <div class="form-label">팀 선택</div>
        <select id="teamSelect" class="form-input">
          <option value="team1">불사조 기사단</option>
          <option value="team2">죽음을 먹는 자들</option>
        </select>
      </div>
    </div>
    <div class="login-actions">
      <button id="loginBtn" class="btn" disabled>전투 참가</button>
    </div>
  </div>

  <!-- 메인 게임 화면 -->
  <div id="gameScreen" class="hidden">
    <!-- 헤더 -->
    <header class="arena-header">
      <div class="arena-title">PYXIS 전투 아레나</div>
      <div class="connection-status" id="connectionStatus">연결 중...</div>
    </header>

    <!-- 관전자 모드 알림 -->
    <div id="spectatorMode" class="spectator-mode hidden">
      <h3>관전자 모드</h3>
      <p>현재 관전자로서 전투를 지켜보고 있습니다.</p>
    </div>

    <!-- 턴 정보 -->
    <div id="turnInfo" class="turn-info">
      <div class="turn-player" id="currentPlayer">대기 중...</div>
      <div class="turn-timer" id="turnTimer">00:00</div>
      <div id="turnDescription">전투가 시작되기를 기다리는 중입니다</div>
    </div>

    <!-- 전투 레이아웃 -->
    <div class="battle-layout">
      <!-- 불사조 기사단 -->
      <div class="team-display team-phoenix">
        <div class="team-header">불사조 기사단</div>
        <div id="team1Players"></div>
      </div>

      <!-- 죽음을 먹는 자들 -->
      <div class="team-display team-deatheater">
        <div class="team-header">죽음을 먹는 자들</div>
        <div id="team2Players"></div>
      </div>
    </div>

    <!-- 액션 패널 -->
    <div id="actionPanel" class="action-panel hidden">
      <div class="action-title">행동 선택</div>
      
      <div class="action-buttons">
        <button class="btn btn-action" id="attackBtn">공격</button>
        <button class="btn btn-action btn-secondary" id="useItemBtn">아이템 사용</button>
        <button class="btn btn-action btn-secondary" id="passBtn">턴 패스</button>
      </div>

      <!-- 대상 선택 -->
      <div id="targetSelection" class="target-selection hidden">
        <div class="form-label">대상 선택</div>
        <div id="targetList" class="target-list"></div>
        <div style="margin-top: 15px;">
          <button class="btn btn-action btn-secondary" id="dodgeBtn">회피 시도</button>
          <button class="btn btn-action" id="confirmAttackBtn">공격 실행</button>
        </div>
      </div>

      <!-- 아이템 선택 -->
      <div id="itemSelection" class="target-selection hidden">
        <div class="form-label">아이템 선택</div>
        <div id="itemList" class="target-list"></div>
        <div style="margin-top: 15px;">
          <button class="btn btn-action btn-secondary" id="cancelItemBtn">취소</button>
          <button class="btn btn-action" id="confirmItemBtn">아이템 사용</button>
        </div>
      </div>
    </div>

    <!-- 전투 로그 -->
    <div class="battle-log">
      <div class="log-title">전투 기록</div>
      <div id="battleLogContent"></div>
    </div>
  </div>
</div>

<script>
// 전역 변수
let socket = null;
let currentBattleState = null;
let myPlayerId = null;
let myTeam = null;
let selectedTarget = null;
let selectedItem = null;
let turnTimer = null;
let isSpectator = false;

// 유틸리티 함수
const $ = id => document.getElementById(id);
const $ = sel => document.querySelectorAll(sel);

// 알림 함수들
function showNotification(message, type = 'success') {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 5000);
}

function showSuccess(message) {
  showNotification(message, 'success');
}

function showError(message) {
  showNotification(message, 'error');
}

// 소켓 연결
function connectSocket() {
  const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const wsUrl = `${protocol}//${location.host}`;
  
  socket = io(wsUrl);
  
  socket.on('connect', () => {
    updateConnectionStatus(true);
    showSuccess('서버에 연결되었습니다');
  });
  
  socket.on('disconnect', () => {
    updateConnectionStatus(false);
    showError('서버 연결이 끊어졌습니다');
  });
  
  socket.on('battle-state', handleBattleState);
  socket.on('player-joined', handlePlayerJoined);
  socket.on('battle-started', handleBattleStarted);
  socket.on('action-executed', handleActionExecuted);
  socket.on('battle-ended', handleBattleEnded);
  
  socket.on('error', (error) => {
    showError(error.message || '알 수 없는 오류가 발생했습니다');
  });
}

// 연결 상태 업데이트
function updateConnectionStatus(connected) {
  const status = $('connectionStatus');
  if (connected) {
    status.textContent = '연결됨';
    status.className = 'connection-status connected';
  } else {
    status.textContent = '연결 끊김';
    status.className = 'connection-status disconnected';
  }
}

// 로그인 처리
async function login() {
  const playerName = $('playerName').value.trim();
  const battleId = $('battleId').value.trim();
  const token = $('tokenInput').value.trim();
  const otp = $('otp').value.trim();
  const teamId = $('teamSelect').value;
  
  if (!playerName || !battleId || !otp) {
    showError('모든 필드를 입력해주세요');
    return;
  }
  
  try {
    // 인증
    const authRes = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        battleId,
        role: 'player',
        name: playerName,
        otp,
        token
      })
    });
    
    if (!authRes.ok) {
      const error = await authRes.json();
      throw new Error(error.error || '인증 실패');
    }
    
    // 전투 참가
    const joinRes = await fetch(`/api/battles/${battleId}/join`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        playerId: generatePlayerId(),
        name: playerName,
        teamId,
        stats: { attack: 3, defense: 3, agility: 3, luck: 3 }
      })
    });
    
    if (!joinRes.ok) {
      const error = await joinRes.json();
      throw new Error(error.error || '전투 참가 실패');
    }
    
    const result = await joinRes.json();
    myPlayerId = result.character.id;
    myTeam = teamId;
    
    // 소켓 룸 참가
    socket.emit('join-battle', {
      battleId,
      playerId: myPlayerId,
      role: 'player'
    });
    
    // 화면 전환
    $('loginPanel').classList.add('hidden');
    $('gameScreen').classList.remove('hidden');
    
    showSuccess(`${playerName}으로 전투에 참가했습니다!`);
    
  } catch (error) {
    showError(error.message);
  }
}

// 플레이어 ID 생성
function generatePlayerId() {
  return 'p_' + Math.random().toString(36).substr(2, 9);
}

// 전투 상태 처리
function handleBattleState(state) {
  currentBattleState = state;
  updateUI();
}

function handlePlayerJoined(data) {
  if (currentBattleState) {
    currentBattleState = data.state;
    updateUI();
  }
  showSuccess(`${data.player.name}이 전투에 참가했습니다`);
}

function handleBattleStarted(data) {
  currentBattleState = data.state;
  updateUI();
  showSuccess('전투가 시작되었습니다!');
}

function handleActionExecuted(data) {
  currentBattleState = data.state;
  updateUI();
  addBattleLog(data.result.description);
  
  if (data.result.battleEnded) {
    showSuccess(`전투 종료! 승자: ${getTeamName(data.result.winner)}`);
  }
}

function handleBattleEnded(data) {
  currentBattleState = data.state;
  updateUI();
  showSuccess(`전투가 종료되었습니다. 승자: ${getTeamName(data.winner)}`);
}

// UI 업데이트
function updateUI() {
  if (!currentBattleState) return;
  
  updateTurnInfo();
  updateTeamDisplays();
  updateActionPanel();
}

function updateTurnInfo() {
  const { phase, turnOrder, turnIndex } = currentBattleState;
  
  if (phase === 'lobby') {
    $('currentPlayer').textContent = '대기 중...';
    $('turnDescription').textContent = '전투가 시작되기를 기다리는 중입니다';
    $('turnTimer').textContent = '00:00';
  } else if (phase === 'battle' && turnOrder && turnOrder.length > 0) {
    const currentPlayer = turnOrder[turnIndex];
    $('currentPlayer').textContent = `${currentPlayer.name}의 턴`;
    
    if (currentPlayer.id === myPlayerId) {
      $('turnDescription').textContent = '당신의 차례입니다!';
    } else if (currentPlayer.teamId === myTeam) {
      $('turnDescription').textContent = '아군의 차례입니다';
    } else {
      $('turnDescription').textContent = '적의 차례입니다';
    }
    
    startTurnTimer();
  } else if (phase === 'ended') {
    $('currentPlayer').textContent = '전투 종료';
    $('turnDescription').textContent = `승자: ${getTeamName(currentBattleState.winner)}`;
    $('turnTimer').textContent = '00:00';
    stopTurnTimer();
  }
}

function updateTeamDisplays() {
  const { teams } = currentBattleState;
  
  // 불사조 기사단
  if (teams.team1) {
    $('team1Players').innerHTML = teams.team1.map(player => renderPlayerCard(player, 'team1')).join('');
  }
  
  // 죽음을 먹는 자들
  if (teams.team2) {
    $('team2Players').innerHTML = teams.team2.map(player => renderPlayerCard(player, 'team2')).join('');
  }
}

function renderPlayerCard(player, teamId) {
  const isCurrentTurn = currentBattleState.phase === 'battle' && 
                        currentBattleState.turnOrder && 
                        currentBattleState.turnOrder[currentBattleState.turnIndex]?.id === player.id;
  
  const isMyCharacter = player.id === myPlayerId;
  const isDead = !player.alive;
  
  let cardClasses = 'player-card';
  if (isCurrentTurn) cardClasses += ' current-turn';
  if (isMyCharacter) cardClasses += ' my-character';
  if (isDead) cardClasses += ' dead';
  
  const hpPercentage = (player.hp / player.maxHp) * 100;
  
  const items = player.inventory || [];
  const itemsHtml = items.length > 0 
    ? items.map(item => `<span class="item-tag">${item}</span>`).join('')
    : '<span class="item-tag">없음</span>';
  
  return `
    <div class="${cardClasses}">
      <div class="player-info">
        <img src="${player.imageUrl || '/default-avatar.png'}" alt="${player.name}" class="player-avatar">
        <div class="player-details">
          <div class="player-name">${player.name}</div>
          <div class="player-status">${isDead ? '사망' : '생존'}</div>
          <div class="hp-bar">
            <div class="hp-fill" style="width: ${hpPercentage}%"></div>
          </div>
          <div style="font-size: 0.8rem; color: var(--text-secondary);">
            HP: ${player.hp}/${player.maxHp}
          </div>
        </div>
      </div>
      <div class="player-stats">
        <div class="stat-item">
          <span class="stat-label">공격</span>
          <span class="stat-value">${player.stats.attack}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">방어</span>
          <span class="stat-value">${player.stats.defense}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">민첩</span>
          <span class="stat-value">${player.stats.agility}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">행운</span>
          <span class="stat-value">${player.stats.luck}</span>
        </div>
      </div>
      <div class="player-items">
        ${itemsHtml}
      </div>
    </div>
  `;
}

function updateActionPanel() {
  const { phase, turnOrder, turnIndex } = currentBattleState;
  
  if (phase !== 'battle' || !turnOrder || turnOrder.length === 0) {
    $('actionPanel').classList.add('hidden');
    return;
  }
  
  const currentPlayer = turnOrder[turnIndex];
  const isMyTurn = currentPlayer && currentPlayer.id === myPlayerId;
  
  if (isMyTurn && currentPlayer.alive && !currentPlayer.hasActed) {
    $('actionPanel').classList.remove('hidden');
  } else {
    $('actionPanel').classList.add('hidden');
  }
}

// 턴 타이머
function startTurnTimer() {
  stopTurnTimer();
  
  const duration = 300; // 5분 = 300초
  let timeLeft = duration;
  
  updateTimerDisplay(timeLeft);
  
  turnTimer = setInterval(() => {
    timeLeft--;
    updateTimerDisplay(timeLeft);
    
    if (timeLeft <= 0) {
      stopTurnTimer();
    }
  }, 1000);
}

function stopTurnTimer() {
  if (turnTimer) {
    clearInterval(turnTimer);
    turnTimer = null;
  }
}

function updateTimerDisplay(seconds) {
  const minutes = Math.floor(seconds / 60);
  const secs = seconds % 60;
  const display = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  
  const timerEl = $('turnTimer');
  timerEl.textContent = display;
  
  // 색상 변경
  if (seconds <= 30) {
    timerEl.className = 'turn-timer critical';
  } else if (seconds <= 60) {
    timerEl.className = 'turn-timer warning';
  } else {
    timerEl.className = 'turn-timer';
  }
}

// 액션 처리
function showTargetSelection() {
  const enemies = getEnemyPlayers();
  const targetList = $('targetList');
  
  targetList.innerHTML = enemies.map(player => `
    <div class="target-option" data-target="${player.id}">
      <img src="${player.imageUrl || '/default-avatar.png'}" alt="${player.name}" style="width: 30px; height: 30px; border-radius: 6px;">
      <div>
        <div style="font-weight: 600; color: var(--gold);">${player.name}</div>
        <div style="font-size: 0.8rem; color: var(--text-secondary);">HP: ${player.hp}/${player.maxHp}</div>
      </div>
    </div>
  `).join('');
  
  // 클릭 이벤트 추가
  $('.target-option').forEach(option => {
    option.addEventListener('click', () => {
      $('.target-option').forEach(opt => opt.classList.remove('selected'));
      option.classList.add('selected');
      selectedTarget = option.dataset.target;
    });
  });
  
  $('targetSelection').classList.remove('hidden');
  $('itemSelection').classList.add('hidden');
}

function showItemSelection() {
  const myPlayer = getMyPlayer();
  if (!myPlayer || !myPlayer.inventory || myPlayer.inventory.length === 0) {
    showError('사용할 수 있는 아이템이 없습니다');
    return;
  }
  
  const itemList = $('itemList');
  const uniqueItems = [...new Set(myPlayer.inventory)];
  
  itemList.innerHTML = uniqueItems.map(item => {
    const count = myPlayer.inventory.filter(i => i === item).length;
    return `
      <div class="target-option" data-item="${item}">
        <div>
          <div style="font-weight: 600; color: var(--gold);">${item}</div>
          <div style="font-size: 0.8rem; color: var(--text-secondary);">보유: ${count}개</div>
        </div>
      </div>
    `;
  }).join('');
  
  // 클릭 이벤트 추가
  $('.target-option').forEach(option => {
    option.addEventListener('click', () => {
      $('.target-option').forEach(opt => opt.classList.remove('selected'));
      option.classList.add('selected');
      selectedItem = option.dataset.item;
    });
  });
  
  $('itemSelection').classList.remove('hidden');
  $('targetSelection').classList.add('hidden');
}

function hideSelections() {
  $('targetSelection').classList.add('hidden');
  $('itemSelection').classList.add('hidden');
  selectedTarget = null;
  selectedItem = null;
}

// 액션 실행
async function executeAction(actionType, params = {}) {
  if (!currentBattleState || !myPlayerId) return;
  
  try {
    const response = await fetch(`/api/battles/${currentBattleState.id}/action`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        playerId: myPlayerId,
        action: {
          type: actionType,
          ...params
        }
      })
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || '액션 실행 실패');
    }
    
    hideSelections();
    
  } catch (error) {
    showError(error.message);
  }
}

// 유틸리티 함수들
function getMyPlayer() {
  if (!currentBattleState || !myPlayerId) return null;
  
  const allPlayers = [
    ...(currentBattleState.teams.team1 || []),
    ...(currentBattleState.teams.team2 || [])
  ];
  
  return allPlayers.find(p => p.id === myPlayerId);
}

function getEnemyPlayers() {
  if (!currentBattleState || !myTeam) return [];
  
  const enemyTeam = myTeam === 'team1' ? 'team2' : 'team1';
  return (currentBattleState.teams[enemyTeam] || []).filter(p => p.alive);
}

function getTeamName(teamId) {
  if (teamId === 'team1') return '불사조 기사단';
  if (teamId === 'team2') return '죽음을 먹는 자들';
  if (teamId === 'draw') return '무승부';
  return '알 수 없음';
}

function addBattleLog(message) {
  const logContent = $('battleLogContent');
  const timestamp = new Date().toLocaleTimeString();
  
  const logEntry = document.createElement('div');
  logEntry.className = 'log-entry';
  logEntry.innerHTML = `
    <span class="log-timestamp">${timestamp}</span>
    ${message}
  `;
  
  logContent.appendChild(logEntry);
  logContent.scrollTop = logContent.scrollHeight;
}

// 이벤트 리스너
document.addEventListener('DOMContentLoaded', () => {
  // URL 파라미터 처리
  const params = new URLSearchParams(location.search);
  const battleId = params.get('battle');
  const token = params.get('token');
  
  if (battleId) $('battleId').value = battleId;
  if (token) $('tokenInput').value = token;
  
  // 입력 검증
  function validateForm() {
    const playerName = $('playerName').value.trim();
    const battleId = $('battleId').value.trim();
    const otp = $('otp').value.trim();
    
    $('loginBtn').disabled = !playerName || !battleId || !otp;
  }
  
  $('playerName').addEventListener('input', validateForm);
  $('battleId').addEventListener('input', validateForm);
  $('otp').addEventListener('input', validateForm);
  
  // 로그인 버튼
  $('loginBtn').addEventListener('click', login);
  
  // 액션 버튼들
  $('attackBtn').addEventListener('click', () => {
    showTargetSelection();
  });
  
  $('useItemBtn').addEventListener('click', () => {
    showItemSelection();
  });
  
  $('passBtn').addEventListener('click', () => {
    executeAction('pass');
  });
  
  // 공격 관련 버튼들
  $('confirmAttackBtn').addEventListener('click', () => {
    if (!selectedTarget) {
      showError('공격할 대상을 선택해주세요');
      return;
    }
    executeAction('attack', { targetId: selectedTarget, actionType: 'defend' });
  });
  
  $('dodgeBtn').addEventListener('click', () => {
    if (!selectedTarget) {
      showError('공격할 대상을 선택해주세요');
      return;
    }
    executeAction('attack', { targetId: selectedTarget, actionType: 'dodge' });
  });
  
  // 아이템 관련 버튼들
  $('confirmItemBtn').addEventListener('click', () => {
    if (!selectedItem) {
      showError('사용할 아이템을 선택해주세요');
      return;
    }
    executeAction('use_item', { itemName: selectedItem });
  });
  
  $('cancelItemBtn').addEventListener('click', hideSelections);
  
  // 소켓 연결
  connectSocket();
  
  validateForm();
});
</script>

<!-- Socket.IO 클라이언트 라이브러리 -->
<script src="/socket.io/socket.io.js"></script>
</body>
</html>
