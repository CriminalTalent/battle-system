<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pyxis 전투 아레나 - 전사 인터페이스</title>
<style>
:root {
  --deep-navy: #0a1628;
  --navy: #0f2a44;
  --navy-light: #1a3a5c;
  --gold: #d4af37;
  --gold-light: #f4d03f;
  --gold-dark: #b8860b;
  --accent: #2c5f7c;
  --text-primary: #e8dcc0;
  --text-secondary: #c4b896;
  --border: rgba(212, 175, 55, 0.3);
  --border-light: rgba(212, 175, 55, 0.15);
  --shadow: rgba(212, 175, 55, 0.2);
  --glass: rgba(15, 42, 68, 0.85);
  --glass-dark: rgba(10, 22, 40, 0.9);
  --phoenix: #d4af37;
  --death: #b8860b;
  --hp-gradient: linear-gradient(90deg, var(--gold-light), var(--gold), var(--gold-dark));
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  background: linear-gradient(135deg, var(--deep-navy) 0%, var(--navy) 50%, var(--navy-light) 100%);
  color: var(--text-primary);
  font-family: 'Cinzel', 'Times New Roman', serif;
  height: 100vh;
  overflow: hidden;
  position: relative;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: 
    radial-gradient(circle at 25% 25%, rgba(212, 175, 55, 0.08) 0%, transparent 50%),
    radial-gradient(circle at 75% 75%, rgba(212, 175, 55, 0.08) 0%, transparent 50%),
    radial-gradient(circle at 50% 50%, rgba(212, 175, 55, 0.05) 0%, transparent 70%);
  pointer-events: none;
  z-index: -1;
}

/* Login Overlay */
.login-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 1000;
  background: rgba(10, 22, 40, 0.95);
  display: flex;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(20px);
}

.login-panel {
  background: var(--glass-dark);
  border: 2px solid var(--gold);
  border-radius: 20px;
  padding: 40px;
  max-width: 500px;
  width: 90%;
  backdrop-filter: blur(15px);
  box-shadow: 0 20px 40px rgba(212, 175, 55, 0.3);
}

.login-title {
  text-align: center;
  font-size: 2.5rem;
  color: var(--gold);
  margin-bottom: 30px;
  text-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
  letter-spacing: 2px;
}

.login-form {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
  margin-bottom: 20px;
}

.form-field {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-field label {
  color: var(--gold);
  font-weight: 600;
  font-size: 0.9rem;
}

.form-field input {
  background: rgba(10, 22, 40, 0.8);
  border: 1px solid var(--border-light);
  border-radius: 8px;
  padding: 12px;
  color: var(--text-primary);
  font-size: 0.9rem;
  transition: all 0.3s ease;
}

.form-field input:focus {
  outline: none;
  border-color: var(--gold);
  box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
}

.form-field input[readonly] {
  background: rgba(10, 22, 40, 0.5);
  color: var(--text-secondary);
}

.login-btn {
  width: 100%;
  background: linear-gradient(135deg, var(--gold-dark), var(--gold));
  border: 1px solid var(--gold);
  border-radius: 10px;
  padding: 15px;
  color: var(--deep-navy);
  font-weight: 600;
  font-size: 1.1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.login-btn:hover {
  background: linear-gradient(135deg, var(--gold), var(--gold-light));
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4);
}

/* Team Selection */
.team-selection {
  margin-top: 30px;
}

.stats-builder {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 15px;
  margin-bottom: 25px;
}

.stat-control {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.stat-control label {
  font-size: 0.8rem;
  font-weight: 600;
}

.stat-slider-container {
  display: flex;
  align-items: center;
  gap: 10px;
}

.stat-slider {
  flex: 1;
  height: 6px;
  background: rgba(10, 22, 40, 0.8);
  border-radius: 3px;
  outline: none;
  cursor: pointer;
}

.stat-slider::-webkit-slider-thumb {
  appearance: none;
  width: 16px;
  height: 16px;
  background: var(--gold);
  border-radius: 50%;
  cursor: pointer;
}

.stat-value {
  min-width: 20px;
  text-align: center;
  font-weight: bold;
  color: var(--gold);
}

.items-select {
  grid-column: span 3;
}

.items-select select {
  width: 100%;
  background: rgba(10, 22, 40, 0.8);
  border: 1px solid var(--border-light);
  border-radius: 8px;
  padding: 8px;
  color: var(--text-primary);
}

.team-buttons {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 20px;
}

.team-btn {
  padding: 20px;
  border: 2px solid;
  border-radius: 12px;
  background: transparent;
  color: inherit;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.team-btn.phoenix {
  border-color: var(--gold);
  color: var(--gold);
}

.team-btn.phoenix:hover,
.team-btn.phoenix.selected {
  background: rgba(212, 175, 55, 0.2);
  box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
}

.team-btn.death {
  border-color: var(--gold-dark);
  color: var(--gold-dark);
}

.team-btn.death:hover,
.team-btn.death.selected {
  background: rgba(184, 134, 11, 0.2);
  box-shadow: 0 0 20px rgba(184, 134, 11, 0.3);
}

.confirm-btn {
  width: 100%;
  background: var(--accent);
  border: 1px solid var(--accent);
  border-radius: 10px;
  padding: 15px;
  color: var(--text-primary);
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.confirm-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.confirm-btn:not(:disabled):hover {
  background: var(--navy-light);
  transform: translateY(-1px);
}

/* Battle Arena Layout */
.battle-arena {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: grid;
  grid-template-areas:
    "header header header header"
    "team1 battlefield battlefield team2"
    "actions actions actions actions"
    "chat chat chat chat";
  grid-template-rows: 80px 1fr 160px 140px;
  grid-template-columns: 280px 1fr 1fr 280px;
  gap: 12px;
  padding: 12px;
}

/* Header */
.battle-header {
  grid-area: header;
  background: var(--glass-dark);
  border: 2px solid var(--gold);
  border-radius: 15px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 30px;
  backdrop-filter: blur(15px);
  box-shadow: 0 0 30px rgba(212, 175, 55, 0.4);
}

.header-title {
  font-size: 1.8rem;
  font-weight: bold;
  color: var(--gold);
  text-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
  letter-spacing: 1px;
}

.header-status {
  display: flex;
  gap: 15px;
  font-size: 0.9rem;
}

.status-pill {
  padding: 8px 16px;
  border-radius: 20px;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  font-weight: 600;
}

.status-critical {
  color: var(--death);
  animation: pulse 1s infinite;
}

/* Team Panels */
.team-panel {
  background: var(--glass);
  border: 2px solid;
  border-radius: 15px;
  padding: 20px;
  backdrop-filter: blur(10px);
  overflow-y: auto;
}

.team-panel.phoenix {
  grid-area: team1;
  border-color: var(--gold);
  box-shadow: 0 0 20px rgba(212, 175, 55, 0.15);
}

.team-panel.death {
  grid-area: team2;
  border-color: var(--gold-dark);
  box-shadow: 0 0 20px rgba(184, 134, 11, 0.15);
}

.team-header {
  text-align: center;
  font-size: 1.3rem;
  font-weight: bold;
  margin-bottom: 20px;
  padding: 12px;
  border-radius: 10px;
  text-shadow: 0 0 10px currentColor;
}

.team-panel.phoenix .team-header {
  color: var(--gold);
  background: rgba(212, 175, 55, 0.1);
}

.team-panel.death .team-header {
  color: var(--gold-dark);
  background: rgba(184, 134, 11, 0.1);
}

/* Player Cards */
.player-card {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 12px;
  transition: all 0.3s ease;
  position: relative;
}

.player-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

.player-card.dead {
  opacity: 0.4;
  filter: grayscale(1);
}

.player-card.active {
  border-color: var(--gold);
  box-shadow: 0 0 20px rgba(212, 175, 55, 0.4);
}

.player-avatar {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  border: 2px solid var(--gold);
  float: left;
  margin-right: 15px;
  object-fit: cover;
  background: var(--navy);
}

.player-info {
  overflow: hidden;
}

.player-name {
  font-size: 1.1rem;
  font-weight: bold;
  color: var(--gold);
  margin-bottom: 8px;
}

.player-hp {
  margin-bottom: 8px;
}

.hp-bar {
  height: 10px;
  background: var(--navy);
  border-radius: 5px;
  overflow: hidden;
  margin-top: 5px;
}

.hp-fill {
  height: 100%;
  background: var(--hp-gradient);
  transition: width 0.5s ease;
}

.player-stats {
  font-size: 0.8rem;
  color: var(--text-secondary);
  margin-top: 8px;
}

/* Battlefield */
.battlefield {
  grid-area: battlefield;
  background: var(--glass);
  border: 2px solid var(--accent);
  border-radius: 15px;
  padding: 25px;
  backdrop-filter: blur(10px);
  display: flex;
  flex-direction: column;
  position: relative;
  overflow: hidden;
}

.battlefield::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: radial-gradient(circle at center, rgba(44, 95, 124, 0.1) 0%, transparent 70%);
  pointer-events: none;
}

.battle-log {
  flex: 1;
  background: rgba(10, 22, 40, 0.8);
  border-radius: 12px;
  padding: 20px;
  overflow-y: auto;
  font-size: 0.85rem;
  line-height: 1.6;
  margin-bottom: 20px;
}

.battle-log::-webkit-scrollbar {
  width: 6px;
}

.battle-log::-webkit-scrollbar-track {
  background: transparent;
}

.battle-log::-webkit-scrollbar-thumb {
  background: var(--gold);
  border-radius: 3px;
}

.my-status {
  background: rgba(212, 175, 55, 0.1);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
}

.my-status-title {
  color: var(--gold);
  font-weight: bold;
  margin-bottom: 15px;
  font-size: 1.1rem;
}

.my-status-content {
  font-family: 'Monaco', 'Consolas', monospace;
  font-size: 0.8rem;
  line-height: 1.4;
  color: var(--text-secondary);
}

/* Action Panel */
.action-panel {
  grid-area: actions;
  background: var(--glass-dark);
  border: 2px solid var(--gold);
  border-radius: 15px;
  padding: 25px;
  backdrop-filter: blur(15px);
  display: flex;
  gap: 25px;
  align-items: center;
}

.action-buttons {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 15px;
  flex: 1;
}

.action-btn {
  padding: 18px 12px;
  border: 2px solid var(--gold);
  background: rgba(212, 175, 55, 0.1);
  color: var(--gold);
  border-radius: 12px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.9rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.action-btn:hover:not(:disabled) {
  background: var(--gold);
  color: var(--deep-navy);
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(212, 175, 55, 0.4);
}

.action-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.target-panel {
  width: 220px;
  background: rgba(10, 22, 40, 0.8);
  border-radius: 12px;
  padding: 20px;
}

.target-label {
  color: var(--gold);
  font-size: 0.9rem;
  font-weight: bold;
  margin-bottom: 10px;
}

.target-select {
  width: 100%;
  background: rgba(10, 22, 40, 0.9);
  color: var(--text-primary);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px;
  font-size: 0.8rem;
}

/* Chat Area */
.chat-area {
  grid-area: chat;
  background: var(--glass-dark);
  border: 2px solid var(--accent);
  border-radius: 15px;
  padding: 20px;
  backdrop-filter: blur(10px);
  display: flex;
  flex-direction: column;
}

.chat-messages {
  flex: 1;
  background: rgba(10, 22, 40, 0.8);
  border-radius: 10px;
  padding: 15px;
  overflow-y: auto;
  font-size: 0.8rem;
  margin-bottom: 15px;
  line-height: 1.4;
}

.chat-messages::-webkit-scrollbar {
  width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
  background: transparent;
}

.chat-messages::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 3px;
}

.chat-input-area {
  display: flex;
  gap: 12px;
}

.chat-input {
  flex: 1;
  background: rgba(10, 22, 40, 0.9);
  color: var(--text-primary);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px;
  font-size: 0.9rem;
}

.chat-send {
  padding: 12px 20px;
  background: var(--accent);
  color: var(--text-primary);
  border: 1px solid var(--accent);
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s ease;
}

.chat-send:hover {
  background: var(--navy-light);
}

/* Notifications */
.notifications {
  position: fixed;
  bottom: 20px;
  right: 20px;
  max-width: 350px;
  z-index: 2000;
}

.notification {
  padding: 12px 18px;
  margin-bottom: 10px;
  border-radius: 8px;
  font-weight: 500;
  animation: slideIn 0.3s ease;
}

.notification.error {
  background: linear-gradient(135deg, #c0392b, #e74c3c);
  border: 1px solid #e74c3c;
  color: white;
}

.notification.success {
  background: linear-gradient(135deg, #27ae60, #2ecc71);
  border: 1px solid #2ecc71;
  color: white;
}

.notification.info {
  background: var(--glass);
  border: 1px solid var(--border);
  color: var(--text-primary);
}

/* Animations */
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
  .battle-arena {
    grid-template-areas:
      "header"
      "battlefield"
      "actions"
      "chat";
    grid-template-rows: 70px 1fr 140px 120px;
    grid-template-columns: 1fr;
  }
  
  .team-panel {
    display: none;
  }
  
  .action-buttons {
    grid-template-columns: repeat(3, 1fr);
  }
  
  .login-form {
    grid-template-columns: 1fr;
  }
  
  .stats-builder {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .team-buttons {
    grid-template-columns: 1fr;
  }
}

.loading {
  opacity: 0.7;
  pointer-events: none;
}
</style>
</head>
<body>

<!-- Login Overlay -->
<div id="loginOverlay" class="login-overlay">
  <div class="login-panel">
    <div class="login-title">전투 아레나</div>
    <div class="login-form">
      <div class="form-field">
        <label>전투 ID</label>
        <input id="battleId" type="text">
      </div>
      <div class="form-field">
        <label>전사 이름</label>
        <input id="playerName" type="text">
      </div>
      <div class="form-field">
        <label>접근 코드</label>
        <input id="otpCode" type="text">
      </div>
    </div>
    <input id="tokenInput" type="text" placeholder="인증 토큰" readonly style="width:100%;padding:12px;border-radius:8px;border:1px solid #666;background:rgba(10,22,40,.5);color:#999;margin-bottom:20px">
    <button id="loginBtn" class="login-btn">전투 입장</button>
    <div id="loginStatus" style="margin-top:15px;text-align:center"></div>
  </div>
</div>

<!-- Team Selection Overlay -->
<div id="teamSelect" class="login-overlay" style="display:none">
  <div class="login-panel">
    <div class="login-title">전사 설정</div>
    
    <!-- Stats Configuration -->
    <div class="stats-builder">
      <div class="stat-control">
        <label style="color:var(--death)">체력</label>
        <div class="stat-slider-container">
          <input id="hpSlider" type="range" min="1" max="100" value="100" class="stat-slider">
          <span id="hpValue" class="stat-value">100</span>
        </div>
      </div>
      <div class="stat-control">
        <label style="color:#e67e22">공격력</label>
        <div class="stat-slider-container">
          <input id="atkSlider" type="range" min="1" max="5" value="3" class="stat-slider">
          <span id="atkValue" class="stat-value">3</span>
        </div>
      </div>
      <div class="stat-control">
        <label style="color:var(--phoenix)">방어력</label>
        <div class="stat-slider-container">
          <input id="defSlider" type="range" min="1" max="5" value="3" class="stat-slider">
          <span id="defValue" class="stat-value">3</span>
        </div>
      </div>
      <div class="stat-control">
        <label style="color:var(--accent)">민첩성</label>
        <div class="stat-slider-container">
          <input id="agiSlider" type="range" min="1" max="5" value="3" class="stat-slider">
          <span id="agiValue" class="stat-value">3</span>
        </div>
      </div>
      <div class="stat-control">
        <label style="color:var(--gold)">행운</label>
        <div class="stat-slider-container">
          <input id="lukSlider" type="range" min="1" max="5" value="3" class="stat-slider">
          <span id="lukValue" class="stat-value">3</span>
        </div>
      </div>
      <div class="items-select">
        <label style="color:var(--gold)">장비</label>
        <select id="itemSelect" multiple size="3">
          <option>공격 보정기</option>
          <option>방어 보정기</option>
          <option>디터니</option>
        </select>
      </div>
    </div>

    <!-- Team Selection -->
    <div class="team-buttons">
      <button id="joinTeam1" class="team-btn phoenix">불사조 기사단 참가</button>
      <button id="joinTeam2" class="team-btn death">죽음을 먹는 자들 참가</button>
    </div>
    
    <button id="confirmJoin" class="confirm-btn" disabled>먼저 팀을 선택하세요</button>
    <div id="joinStatus" style="margin-top:15px;text-align:center"></div>
  </div>
</div>

<!-- Main Battle Arena -->
<div id="battleArena" class="battle-arena" style="display:none">
  <!-- Header -->
  <div class="battle-header">
    <div class="header-title">Pyxis 전투 아레나</div>
    <div class="header-status">
      <div class="status-pill" id="battlePhase">대기실</div>
      <div class="status-pill" id="currentTurn">-</div>
      <div class="status-pill" id="turnTimer">-</div>
    </div>
  </div>

  <!-- Team 1 Panel -->
  <div class="team-panel phoenix">
    <div class="team-header">불사조 기사단</div>
    <div id="team1Players"></div>
  </div>

  <!-- Battlefield Center -->
  <div class="battlefield">
    <div class="battle-log" id="battleLog"></div>
    <div class="my-status">
      <div class="my-status-title">전사 상태</div>
      <div class="my-status-content" id="myStatusDisplay"></div>
    </div>
  </div>

  <!-- Team 2 Panel -->
  <div class="team-panel death">
    <div class="team-header">죽음을 먹는 자들</div>
    <div id="team2Players"></div>
  </div>

  <!-- Action Panel -->
  <div class="action-panel">
    <div class="action-buttons">
      <button id="attackBtn" class="action-btn" disabled>공격</button>
      <button id="defendBtn" class="action-btn" disabled>방어</button>
      <button id="itemBtn" class="action-btn" disabled>아이템</button>
      <button id="dodgeBtn" class="action-btn" disabled>회피</button>
      <button id="passBtn" class="action-btn" disabled>패스</button>
    </div>
    <div class="target-panel">
      <div class="target-label">대상 선택</div>
      <select id="targetSelect" class="target-select" size="4"></select>
    </div>
  </div>

  <!-- Chat Area -->
  <div class="chat-area">
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input-area">
      <input id="chatInput" class="chat-input" placeholder="메시지 입력..." maxlength="200">
      <button id="chatSendBtn" class="chat-send">전송</button>
    </div>
  </div>
</div>

<div id="notifications" class="notifications"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
const $ = s => document.querySelector(s);

// URL parameters auto-fill
const qs = new URLSearchParams(location.search);
$('#battleId').value = qs.get('battle') || '';
$('#tokenInput').value = qs.get('token') || '';

let gameState = {
  battleId: null,
  token: null,
  playerName: null,
  playerId: null,
  selectedTeam: null,
  socket: null,
  state: null,
  joined: false
};

// Notification system
function showNotification(msg, type = 'info') {
  const div = document.createElement('div');
  div.className = `notification ${type}`;
  div.textContent = msg;
  $('#notifications').appendChild(div);
  setTimeout(() => div.remove(), 4000);
}

// Slider events
['hp','atk','def','agi','luk'].forEach(stat => {
  $(`#${stat}Slider`).addEventListener('input', e => {
    $(`#${stat}Value`).textContent = e.target.value;
  });
});

// Login
$('#loginBtn').onclick = async () => {
  const battleId = $('#battleId').value.trim();
  const token = $('#tokenInput').value.trim();
  const name = $('#playerName').value.trim();
  const otp = $('#otpCode').value.trim();
  
  if (!battleId || !token || !name || !otp) {
    showNotification('모든 필드를 입력해주세요', 'error');
    return;
  }

  try {
    const response = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ battleId, role: 'player', name, otp, token })
    });
    
    const result = await response.json();
    if (!result.ok) throw new Error(result.error);
    
    gameState.battleId = battleId;
    gameState.token = token;
    gameState.playerName = name;
    gameState.playerId = name;
    
    // Socket connection
    gameState.socket = io({ path: '/socket.io' });
    setupSocketEvents();
    
    $('#loginOverlay').style.display = 'none';
    $('#teamSelect').style.display = 'flex';
    
    showNotification('로그인 성공!', 'success');
    await refreshGameState();
    
  } catch (err) {
    showNotification(`로그인 실패: ${err.message}`, 'error');
  }
};

// Team selection
$('#joinTeam1').onclick = () => selectTeam('team1');
$('#joinTeam2').onclick = () => selectTeam('team2');

function selectTeam(team) {
  gameState.selectedTeam = team;
  document.querySelectorAll('.team-btn').forEach(btn => btn.classList.remove('selected'));
  $(`#joinTeam${team === 'team1' ? '1' : '2'}`).classList.add('selected');
  $('#confirmJoin').disabled = false;
  $('#confirmJoin').style.background = 'linear-gradient(135deg, var(--gold-dark), var(--gold))';
  $('#confirmJoin').style.color = 'var(--deep-navy)';
  $('#confirmJoin').style.cursor = 'pointer';
  $('#confirmJoin').textContent = `${team === 'team1' ? '불사조 기사단' : '죽음을 먹는 자들'} 참가`;
}

// Confirm team join
$('#confirmJoin').onclick = async () => {
  if (!gameState.selectedTeam) return;
  
  try {
    const stats = {
      attack: +$('#atkSlider').value,
      defense: +$('#defSlider').value,
      agility: +$('#agiSlider').value,
      luck: +$('#lukSlider').value
    };
    const customHp = +$('#hpSlider').value;
    const items = [...$('#itemSelect').selectedOptions].map(o => o.value);
    
    const response = await fetch(`/api/battles/${gameState.battleId}/join`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        playerId: gameState.playerName,
        playerName: gameState.playerName,
        teamId: gameState.selectedTeam,
        stats,
        items,
        customHp
      })
    });
    
    const result = await response.json();
    if (!result.success) throw new Error(result.error);
    
    gameState.joined = true;
    $('#teamSelect').style.display = 'none';
    $('#battleArena').style.display = 'grid';
    
    showNotification('팀 참가 완료!', 'success');
    await refreshGameState();
    
  } catch (err) {
    showNotification(`참가 실패: ${err.message}`, 'error');
  }
};

// Socket events
function setupSocketEvents() {
  const socket = gameState.socket;
  
  socket.on('connect', () => {
    socket.emit('join-battle', { 
      battleId: gameState.battleId, 
      playerId: gameState.playerId, 
      role: 'player' 
    });
  });
  
  socket.on('disconnect', () => {
    showNotification('연결이 끊어졌습니다', 'error');
  });
  
  socket.on('battle-state', refreshGameState);
  socket.on('player-joined', refreshGameState);
  socket.on('action-executed', refreshGameState);
  socket.on('battle-started', () => {
    refreshGameState();
    showNotification('전투 시작!', 'success');
  });
  socket.on('battle-ended', () => {
    refreshGameState();
    showNotification('전투 종료!', 'success');
  });
  socket.on('chat-message', ({ message }) => {
    if (gameState.state && gameState.state.chatLog) {
      gameState.state.chatLog.push(message);
      renderChat();
    }
  });
}

// Refresh game state
async function refreshGameState() {
  if (!gameState.battleId) return;
  
  try {
    const response = await fetch(`/api/battles/${gameState.battleId}`);
    gameState.state = await response.json();
    renderGame();
  } catch (err) {
    showNotification('상태 업데이트 실패', 'error');
  }
}

// Render game
function renderGame() {
  if (!gameState.state) return;
  
  renderHUD();
  renderTeams();
  renderBattleLog();
  renderMyStatus();
  renderActions();
  renderTargets();
  renderChat();
}

function renderHUD() {
  const state = gameState.state;
  $('#battlePhase').textContent = state.phase === 'lobby' ? '대기실' : 
                                  state.phase === 'battle' ? '전투 중' :
                                  state.phase === 'ended' ? '종료' : state.phase.toUpperCase();
  $('#currentTurn').textContent = state.currentTeam === 'team1' ? '불사조 기사단 턴' : 
                                   state.currentTeam === 'team2' ? '죽음을 먹는 자들 턴' : '-';
  
  if (state.remainingTurnTime && state.phase === 'battle') {
    const minutes = Math.floor(state.remainingTurnTime / 60000);
    const seconds = Math.floor((state.remainingTurnTime % 60000) / 1000);
    $('#turnTimer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    $('#turnTimer').className = state.remainingTurnTime < 60000 ? 'status-pill status-critical' : 'status-pill';
  } else {
    $('#turnTimer').textContent = '-';
    $('#turnTimer').className = 'status-pill';
  }
}

function renderTeams() {
  renderTeamPanel(gameState.state.teams.team1, '#team1Players');
  renderTeamPanel(gameState.state.teams.team2, '#team2Players');
}

function renderTeamPanel(players, selector) {
  const container = $(selector);
  container.innerHTML = '';
  
  players.forEach(player => {
    const div = document.createElement('div');
    div.className = `player-card ${!player.alive ? 'dead' : ''} ${player.hasActed ? '' : 'active'}`;
    
    const hpPercent = player.maxHp ? (player.hp / player.maxHp) * 100 : 0;
    
    div.innerHTML = `
      <div class="player-avatar" style="background-image:url('${player.imageUrl || ''}')"></div>
      <div class="player-info">
        <div class="player-name">${player.name}</div>
        <div class="player-hp">
          HP: ${player.hp}/${player.maxHp}
          <div class="hp-bar">
            <div class="hp-fill" style="width:${hpPercent}%"></div>
          </div>
        </div>
        <div class="player-stats">
          공격:${player.stats.attack} 방어:${player.stats.defense} 
          민첩:${player.stats.agility} 행운:${player.stats.luck}
        </div>
      </div>
    `;
    
    container.appendChild(div);
  });
}

function renderBattleLog() {
  const log = $('#battleLog');
  const entries = (gameState.state.battleLog || []).slice(-20).map(entry => {
    const time = new Date(entry.timestamp).toLocaleTimeString();
    return `[${time}] ${entry.result || entry.actor || entry.type}`;
  }).join('\n');
  log.textContent = entries;
  log.scrollTop = log.scrollHeight;
}

function renderMyStatus() {
  const myPlayer = findMyPlayer();
  $('#myStatusDisplay').textContent = myPlayer ? 
    JSON.stringify(myPlayer, null, 2) : '전사를 찾을 수 없음';
}

function renderActions() {
  const myTeam = getMyTeam();
  const isMyTurn = myTeam === gameState.state.currentTeam;
  const myPlayer = findMyPlayer();
  const canAct = isMyTurn && myPlayer && myPlayer.alive && !myPlayer.hasActed;
  
  ['attackBtn', 'defendBtn', 'itemBtn', 'dodgeBtn', 'passBtn'].forEach(btnId => {
    $(btnId).disabled = !canAct;
  });
}

function renderTargets() {
  const select = $('#targetSelect');
  select.innerHTML = '';
  
  const myTeam = getMyTeam();
  const enemies = myTeam === 'team1' ? gameState.state.teams.team2 : gameState.state.teams.team1;
  
  enemies.forEach(player => {
    if (player.alive) {
      const option = document.createElement('option');
      option.value = player.id;
      option.textContent = `${player.name} (${player.hp}HP)`;
      select.appendChild(option);
    }
  });
}

function renderChat() {
  const chat = $('#chatMessages');
  const messages = (gameState.state.chatLog || []).slice(-15).map(msg => {
    const time = new Date(msg.timestamp).toLocaleTimeString();
    const colorMap = {
      system: '#d4af37',
      admin: '#b8860b',
      player: '#c4a56a',
      spectator: '#f4d03f'
    };
    const color = colorMap[msg.senderType] || '#fff';
    return `<div style="margin-bottom:5px"><span style="color:${color}">[${time}] ${msg.sender}:</span> ${msg.message}</div>`;
  }).join('');
  chat.innerHTML = messages;
  chat.scrollTop = chat.scrollHeight;
}

// Utility functions
function findMyPlayer() {
  if (!gameState.state) return null;
  const all = [...gameState.state.teams.team1, ...gameState.state.teams.team2];
  return all.find(p => p.id === gameState.playerId);
}

function getMyTeam() {
  if (!gameState.state) return null;
  for (const player of gameState.state.teams.team1) {
    if (player.id === gameState.playerId) return 'team1';
  }
  for (const player of gameState.state.teams.team2) {
    if (player.id === gameState.playerId) return 'team2';
  }
  return null;
}

// Execute action
async function executeAction(type, payload = {}) {
  if (!gameState.joined) return;
  
  try {
    const response = await fetch(`/api/battles/${gameState.battleId}/action`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        playerId: gameState.playerId,
        action: { type, ...payload }
      })
    });
    
    const result = await response.json();
    if (!result.success) {
      showNotification(result.error, 'error');
    } else {
      showNotification(`${type.toUpperCase()} 실행!`, 'success');
    }
  } catch (err) {
    showNotification(`액션 실패: ${err.message}`, 'error');
  }
}

// Action button events
$('#attackBtn').onclick = () => {
  const target = $('#targetSelect').value;
  if (!target) {
    showNotification('대상을 선택하세요', 'error');
    return;
  }
  executeAction('attack', { targetId: target });
};

$('#defendBtn').onclick = () => executeAction('defend');
$('#dodgeBtn').onclick = () => executeAction('dodge');
$('#passBtn').onclick = () => executeAction('pass');

$('#itemBtn').onclick = () => {
  const item = prompt('Enter item name:\n- 공격 보정기\n- 방어 보정기\n- 디터니');
  if (item) executeAction('use_item', { itemName: item });
};

// Chat
$('#chatSendBtn').onclick = () => {
  const message = $('#chatInput').value.trim();
  if (!message || !gameState.socket) return;
  
  gameState.socket.emit('send-chat', {
    battleId: gameState.battleId,
    sender: gameState.playerName,
    message: message,
    senderType: 'player'
  });
  
  $('#chatInput').value = '';
};

$('#chatInput').addEventListener('keypress', e => {
  if (e.key === 'Enter') $('#chatSendBtn').click();
});

// Timer update (every second)
setInterval(() => {
  if (gameState.state && gameState.state.remainingTurnTime && gameState.state.phase === 'battle') {
    const remaining = gameState.state.remainingTurnTime - (Date.now() - (gameState.state.turnStartTime || 0));
    if (remaining > 0) {
      const minutes = Math.floor(remaining / 60000);
      const seconds = Math.floor((remaining % 60000) / 1000);
      $('#turnTimer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      $('#turnTimer').className = remaining < 60000 ? 'status-pill status-critical' : 'status-pill';
    }
  }
}, 1000);
</script>
</body>
</html>
