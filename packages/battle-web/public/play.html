<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>PYXIS 전투 아레나</title>
<style>
:root{--deep:#0a0f1a;--navy:#0f1419;--navy2:#1a1f26;--gold:#E5C88A;--gold2:#C8A882;--text:#F5E6B8;--muted:#D4C39A;--b1:rgba(229,200,138,.30);--b2:rgba(229,200,138,.15);--glass:rgba(15,20,25,.85);--glass2:rgba(10,15,26,.90)}
*{box-sizing:border-box;margin:0;padding:0}
body{min-height:100vh;background:linear-gradient(135deg,var(--deep),var(--navy),var(--navy2));color:var(--text);font-family:Pretendard,"Noto Sans KR",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.container{width:min(1200px,92vw);margin:0 auto;padding:16px 0 56px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.brand{font-weight:800;color:var(--gold);font-size:clamp(1.2rem,2.2vw,1.6rem)}
.badge{border:1px solid var(--b1);color:var(--muted);border-radius:999px;padding:6px 10px;font-size:.85rem}

.summary{display:none;gap:14px;grid-template-columns:1fr 1fr 1fr;margin-bottom:14px}
.card{background:var(--glass);border:1px solid var(--b1);border-radius:14px;padding:14px}
.title{color:var(--muted);font-weight:700;margin-bottom:8px}
.value{font-weight:800;color:var(--gold);font-size:clamp(1.05rem,2vw,1.35rem)}
.value.timer.warning{color:#e67e22}.value.timer.critical{color:#c0392b}

.main{display:none;gap:16px}
@media(min-width:1024px){.main{grid-template-columns:1fr 1.1fr 1fr;display:grid}}
@media(max-width:1023.98px){.main{display:grid;grid-template-columns:1fr;gap:12px}}

.panel{background:var(--glass);border:1px solid var(--b1);border-radius:14px;padding:14px}
.panel-title{font-weight:800;color:var(--gold);margin-bottom:10px}

.player-card{display:grid;grid-template-columns:56px 1fr auto;gap:12px;align-items:center;background:rgba(10,15,26,.55);border:1px solid var(--b2);border-radius:12px;padding:10px;margin-bottom:10px}
.avatar{width:56px;height:56px;border-radius:50%;border:1px solid var(--b1);background:radial-gradient(circle at 30% 30%,rgba(229,200,138,.35),rgba(229,200,138,.1))}
.pname{font-weight:700}.psub{color:var(--muted);font-size:.85rem}

.action-box{background:var(--glass2);border:1px solid var(--b1);border-radius:12px;padding:12px;margin-top:10px}
.actions{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px}
.act{border:2px solid var(--gold);color:var(--gold);background:transparent;border-radius:12px;padding:12px 8px;font-weight:800;min-height:52px;cursor:pointer}

.sel-wrap{margin-top:8px}
.sel-label{color:var(--gold);font-weight:700;margin-bottom:6px}
.select{width:100%;background:rgba(10,15,26,.85);color:var(--text);border:1px solid var(--b1);border-radius:8px;padding:10px;min-height:110px}

.center{display:grid;gap:14px}
.grid2{display:grid;gap:10px;grid-template-columns:repeat(2,1fr)}
.stat{background:rgba(10,15,26,.55);border:1px solid var(--b2);border-radius:10px;padding:10px;display:flex;justify-content:space-between}
.stat .k{color:var(--muted);font-size:.9rem}.stat .v{font-weight:700}

.chat{background:var(--glass2);border:2px solid var(--gold);border-radius:15px;padding:14px}
.chat-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.chat-title{color:var(--gold);font-weight:800}
.chat-log{background:rgba(10,15,26,.80);border:1px solid var(--b2);border-radius:10px;padding:12px;min-height:150px;max-height:260px;overflow:auto;line-height:1.5}
.chat-row{display:flex;gap:10px;margin-top:10px}
.chat-in{flex:1;background:rgba(10,15,26,.85);border:1px solid var(--b1);color:var(--text);border-radius:10px;padding:12px;min-height:46px}
.btn{border:1px solid var(--gold);background:linear-gradient(135deg,#C8A882,#E5C88A);color:#0a0f1a;font-weight:800;border-radius:12px;padding:12px 16px;min-width:84px}
.btn.sec{background:transparent;color:var(--text);border-color:var(--b1)}
.log{background:rgba(10,15,26,.80);border:1px solid var(--b2);border-radius:10px;padding:12px;min-height:160px;max-height:320px;overflow:auto;line-height:1.5}

/* 로그인 */
#login{max-width:680px;margin:28px auto}
.field{background:var(--glass);border:1px solid var(--b1);border-radius:14px;padding:12px}
.field input{width:100%;padding:12px;border-radius:10px;border:1px solid var(--b1);background:rgba(10,15,26,.85);color:var(--text)}
.grid{display:grid;gap:12px;grid-template-columns:1fr 1fr}
.team-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.team-btn{border:1px solid var(--gold);background:transparent;color:var(--gold);font-weight:800;border-radius:12px;padding:12px;cursor:pointer}
.team-btn.selected{background:rgba(229,200,138,.12)}
.login-actions{display:flex;justify-content:flex-end;margin-top:12px}
#loginBtn:disabled{opacity:.5;cursor:not-allowed;background:var(--glass2);color:var(--muted);border-color:var(--b2)}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">PYXIS 전투 아레나</div>
    <div class="badge" id="connBadge">연결 준비</div>
  </div>

  <!-- 로그인 -->
  <div id="login" class="panel">
    <div class="panel-title">전투 참가</div>
    <div class="grid">
      <div class="field"><div class="title">플레이어 이름</div><input id="playerName" placeholder="예: 플레이어1"></div>
      <div class="field"><div class="title">아바타 URL</div><input id="avatarUrl" placeholder="선택"></div>
      <div class="field"><div class="title">전투 ID</div><input id="battleId" placeholder="예: ABC123"></div>
      <div class="field"><div class="title">토큰</div><input id="tokenInput" placeholder="토큰"></div>
      <div class="field" style="grid-column:1/3"><div class="title">참가 코드</div><input id="otp" placeholder="6자리 코드"></div>
      <div class="field" style="grid-column:1/3">
        <div class="title">팀 선택</div>
        <div class="team-row">
          <button id="joinTeam1" class="team-btn" type="button">불사조 기사단</button>
          <button id="joinTeam2" class="team-btn" type="button">죽음을 먹는 자들</button>
        </div>
      </div>
    </div>
    <div class="login-actions"><button id="loginBtn" class="btn" disabled>참가</button></div>
  </div>

  <!-- 요약 -->
  <div id="summaryBar" class="summary">
    <div class="card"><div class="title">단계</div><div class="value" id="battlePhase">-</div></div>
    <div class="card"><div class="title">턴</div><div class="value" id="turnSide">-</div></div>
    <div class="card"><div class="title">타이머</div><div class="value timer" id="turnTimer">-</div></div>
  </div>

  <!-- 본문 -->
  <div id="main" class="main">
    <div class="panel">
      <div class="panel-title">불사조 기사단</div>
      <div id="team1List"></div>
      <div id="actionBoxTeam1"></div>
    </div>

    <div class="center">
      <div class="panel">
        <div class="panel-title">전투 상태</div>
        <div class="grid2">
          <div class="stat"><span class="k">단계</span><span class="v" id="phaseDetail">-</span></div>
          <div class="stat"><span class="k">턴 시간</span><span class="v" id="turnRemain">-</span></div>
          <div class="stat"><span class="k">시작</span><span class="v" id="startAt">-</span></div>
          <div class="stat"><span class="k">경과</span><span class="v" id="duration">-</span></div>
        </div>
      </div>

      <section class="chat">
        <div class="chat-head"><div class="chat-title">실시간 채팅</div><div class="psub">플레이어 채널</div></div>
        <div id="chatMessages" class="chat-log"></div>
        <div class="chat-row">
          <input id="chatInput" class="chat-in" placeholder="메시지 입력…" maxlength="200">
          <button id="chatSendBtn" class="btn">전송</button>
          <button id="refreshBtn" class="btn sec">새로고침</button>
        </div>
      </section>

      <div class="panel"><div class="panel-title">전투 로그</div><div id="battleLog" class="log"></div></div>
    </div>

    <div class="panel">
      <div class="panel-title">죽음을 먹는 자들</div>
      <div id="team2List"></div>
      <div id="actionBoxTeam2"></div>
    </div>
  </div>
</div>

<div id="notes" style="position:fixed;right:16px;bottom:16px;display:grid;gap:8px;z-index:50"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
const $=s=>document.querySelector(s);
function toast(m){const w=$('#notes');const d=document.createElement('div');d.style.cssText='background:rgba(15,20,25,.85);border:1px solid rgba(229,200,138,.3);border-radius:10px;padding:10px 12px;color:#F5E6B8';d.textContent=m;w.appendChild(d);setTimeout(()=>{d.style.opacity='0';setTimeout(()=>w.removeChild(d),250)},1800);}

const qs=new URLSearchParams(location.search);
$('#battleId').value=qs.get('battle')||''; $('#tokenInput').value=qs.get('token')||'';

const st={socket:null,battleId:null,playerId:null,token:null,name:null,avatar:null,team:null,data:null,
          timer:{lastMs:0,lastSync:0,interval:null}, poll:null};

/* 팀 선택/검증 */
function selectTeam(key){st.team=key;$('#joinTeam1').classList.toggle('selected',key==='team1');$('#joinTeam2').classList.toggle('selected',key==='team2');validateForm();}
$('#joinTeam1').onclick=()=>selectTeam('team1'); $('#joinTeam2').onclick=()=>selectTeam('team2');
['playerName','battleId','otp','tokenInput'].forEach(id=>$('#'+id).addEventListener('input',validateForm));
function validateForm(){const ok=$('#playerName').value.trim()&&$('#battleId').value.trim()&&$('#otp').value.trim()&&$('#tokenInput').value.trim()&&st.team;$('#loginBtn').disabled=!ok}

/* 로그인 */
$('#loginBtn').onclick=login;
document.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!$('#loginBtn').disabled&&$('#login').style.display!=='none') login(); });
async function login(){
  try{
    const body={battleId:$('#battleId').value.trim(),role:'player',name:$('#playerName').value.trim(),otp:$('#otp').value.trim(),token:$('#tokenInput').value.trim()};
    const r=await fetch('/api/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    if(!r.ok) throw new Error('인증 실패');
    const j=await r.json();
    st.battleId=body.battleId; st.playerId=j.playerId; st.token=body.token; st.name=body.name||'플레이어'; st.avatar=$('#avatarUrl').value.trim()||'';
    $('#login').style.display='none'; $('#summaryBar').style.display='grid'; $('#main').style.display='grid';
    connect();
  }catch(e){toast(e.message||'로그인 실패');}
}

/* 소켓 + 폴링 */
function connect(){
  const s=io({path:'/socket.io',transports:['websocket']}); st.socket=s;
  s.on('connect',()=>{ $('#connBadge').textContent='연결됨'; s.emit('join-battle',{battleId:st.battleId,playerId:st.playerId,role:'player',team:st.team}); refresh(); st.poll=setInterval(refresh,2000); });
  s.on('disconnect',()=>$('#connBadge').textContent='연결 끊김');
  s.on('state',d=>{st.data=d; render(true);});
  s.on('player-joined',d=>{st.data=d.state; render(true);});
  s.on('action-result',d=>{st.data=d.state; render(true);});
  s.on('chat-message',({message})=>{ if(!st.data) st.data={}; if(!st.data.chatLog) st.data.chatLog=[]; st.data.chatLog.push(message); renderChat(); });
}

/* 유틸 */
function myTeam(){const id=st.playerId,t1=st.data?.teams?.team1||[],t2=st.data?.teams?.team2||[];if(t1.find(p=>p.id===id))return'team1';if(t2.find(p=>p.id===id))return'team2';return st.team||null}
function me(){const t=myTeam();return t?(st.data?.teams?.[t]||[]).find(p=>p.id===st.playerId)||null:null}

/* 타이머 */
function startTimerFromState(){
  const d=st.data; if(!d||!d.remainingTurnTime||d.phase!=='battle'){ setTimerLabel('-'); clearTimer(); return; }
  st.timer.lastMs=Math.max(0,d.remainingTurnTime); st.timer.lastSync=Date.now(); clearTimer();
  st.timer.interval=setInterval(tickTimer,1000); tickTimer();
}
function clearTimer(){ if(st.timer.interval){clearInterval(st.timer.interval); st.timer.interval=null;} }
function tickTimer(){
  const left=Math.max(0, st.timer.lastMs - (Date.now()-st.timer.lastSync));
  const m=Math.floor(left/60000), s=Math.floor((left%60000)/1000), t=`${m}:${s.toString().padStart(2,'0')}`;
  const el=$('#turnTimer'); el.textContent=t; el.className='value timer'+(left<30000?' critical':left<60000?' warning':''); $('#turnRemain').textContent=t;
  if(left===0) clearTimer();
}
function setTimerLabel(t){const el=$('#turnTimer');el.textContent=t;el.className='value timer'}

/* 렌더 */
function render(fromServer=false){
  const d=st.data; if(!d) return;
  $('#battlePhase').textContent=d.phase||'-';
  $('#turnSide').textContent= d.currentTeam==='team1'?'불사조 기사단 턴': d.currentTeam==='team2'?'죽음을 먹는 자들 턴':'-';
  $('#phaseDetail').textContent=d.phase||'-'; $('#startAt').textContent=d.startAt||'-'; $('#duration').textContent=d.duration||'-';
  if(fromServer) startTimerFromState();

  renderTeam('team1','#team1List'); renderTeam('team2','#team2List');
  renderActionBoxBoth();
  $('#battleLog').innerHTML=(d.log||[]).map(x=>`<div>${x}</div>`).join('');
  renderTargets('team1'); renderTargets('team2'); renderItems(); renderChat();
  forceEnableButtons(); // 항상 활성
}

function renderTeam(key,sel){
  const box=$(sel), list=(st.data?.teams?.[key]||[]);
  box.innerHTML='';
  if(!list.length){ box.textContent='참가 대기'; return; }
  list.forEach(p=>{
    const hp=p.maxHp?Math.max(0,Math.round((p.hp/p.maxHp)*100)):0;
    const div=document.createElement('div');
    div.className='player-card';
    div.innerHTML=`<div class="avatar" style="background-image:url('${p.avatar||''}');background-size:cover;background-position:center"></div>
      <div><div class="pname">${p.name}</div><div class="psub">${p.hp}/${p.maxHp} HP · ${p.alive?'생존':'전사'} · ${p.hasActed?'행동완료':'대기'}</div></div>
      <div class="psub">${hp}%</div>`;
    box.appendChild(div);
  });
}

/* 액션 박스: 양쪽에 항상 렌더 */
function boxHTML(side){
  return `<div class="action-box">
    <div class="actions">
      <button id="${side}-attack" class="act">공격</button>
      <button id="${side}-defend" class="act">방어</button>
      <button id="${side}-dodge"  class="act">회피</button>
      <button id="${side}-item"   class="act">아이템</button>
      <button id="${side}-pass"   class="act">패스</button>
    </div>
    <div class="sel-wrap"><div class="sel-label">대상 선택</div>
      <select id="${side}-targets" class="select" size="5"><option value="" selected>적을 선택하세요</option></select>
    </div>
    <div class="sel-wrap"><div class="sel-label">아이템 사용</div>
      <div class="grid" style="grid-template-columns:1fr auto">
        <select id="${side}-items" class="select" size="3" style="min-height:auto"></select>
        <div>
          <input id="${side}-qty" class="select" type="number" min="1" value="1" style="min-height:auto;width:110px">
          <button id="${side}-use" class="act" style="margin-top:10px;min-height:46px">사용</button>
        </div>
      </div>
      <div id="${side}-hint" class="psub" style="margin-top:6px"></div>
    </div>
  </div>`;
}
function renderActionBoxBoth(){
  $('#actionBoxTeam1').innerHTML=boxHTML('t1');
  $('#actionBoxTeam2').innerHTML=boxHTML('t2');

  bindBoxHandlers('t1','team1'); bindBoxHandlers('t2','team2');
}
function bindBoxHandlers(side,teamKey){
  const g=id=>document.getElementById(`${side}-${id}`);
  g('attack')  .onclick=()=>{const v=g('targets').value; if(!v){toast('공격 대상을 선택하세요');return;} doAction('attack',{targetId:v});};
  g('defend')  .onclick=()=>doAction('defend');
  g('dodge')   .onclick=()=>doAction('dodge');
  g('pass')    .onclick=()=>doAction('pass');
  g('item')    .onclick=()=>g('items').focus();
  g('use')     .onclick=()=>{const opt=g('items').selectedOptions[0]; if(!opt){toast('아이템을 선택하세요');return;} const qty=Math.max(1,Math.min(parseInt(opt.dataset.qty||'1',10),parseInt(g('qty').value||'1',10))); doAction('use_item',{itemId:opt.value,qty});};
  g('targets') .onchange=forceEnableButtons;
  g('items')   .onchange=()=>applyItemSide(side);
  g('qty')     .oninput =()=>applyItemSide(side);
  applyItemSide(side);
}

/* 대상/아이템 */
function renderTargets(teamKey){
  const side=(teamKey==='team1')?'t1':'t2';
  const sel=document.getElementById(`${side}-targets`); if(!sel) return;
  sel.innerHTML='';
  if(!st.data?.teams) return;
  const enemies = (teamKey==='team1') ? (st.data.teams.team2||[]) : (st.data.teams.team1||[]);
  enemies.filter(p=>p.alive).forEach(p=>{const o=document.createElement('option');o.value=p.id;o.textContent=`${p.name} (HP ${p.hp}/${p.maxHp})`; sel.appendChild(o);});
}
function renderItems(){
  ['t1','t2'].forEach(side=>{
    const sel=document.getElementById(`${side}-items`), qty=document.getElementById(`${side}-qty`), hint=document.getElementById(`${side}-hint`); if(!sel) return;
    const m=me(); const list=(m?.inventory||[]).map(it=>({id:it.id,name:it.name||it.id,qty:(typeof it.qty==='number'?it.qty:it.quantity??1)}));
    sel.innerHTML=list.length?list.map(it=>`<option value="${it.id}" data-qty="${it.qty}">${it.name} × ${it.qty}</option>`).join(''):'<option disabled>아이템 없음</option>';
    const apply=()=>{const opt=sel.selectedOptions[0];const max=opt?parseInt(opt.dataset.qty||'1',10):1;qty.min=1;qty.max=Math.max(1,max);if(parseInt(qty.value||'1',10)>max)qty.value=max; if(hint) hint.textContent=`사용 가능 수량: ${max}`;};
    sel.onchange=apply; qty.oninput=apply; apply();
  });
}
function applyItemSide(side){
  const sel=document.getElementById(`${side}-items`), qty=document.getElementById(`${side}-qty`), hint=document.getElementById(`${side}-hint`);
  if(!sel||!qty) return; const opt=sel.selectedOptions[0]; const max=opt?parseInt(opt.dataset.qty||'1',10):1;
  qty.min=1; qty.max=Math.max(1,max); if(parseInt(qty.value||'1',10)>max) qty.value=max; if(hint) hint.textContent=`사용 가능 수량: ${max}`;
}

/* 채팅 */
function renderChat(){
  const log=$('#chatMessages'); if(!log) return;
  const arr=(st.data?.chatLog||[]).slice(-50);
  log.innerHTML=arr.length?arr.map(m=>`<div>[${new Date(m.timestamp||Date.now()).toLocaleTimeString()}] ${m.name||'system'}: ${m.text||''}</div>`).join(''):'<div style="color:#E5C88A;text-align:center">채팅이 없습니다.</div>';
  log.scrollTop=log.scrollHeight;
}
$('#chatSendBtn').onclick=sendChat; $('#chatInput').addEventListener('keydown',e=>{if(e.key==='Enter')sendChat();});
function sendChat(){
  const v=$('#chatInput').value.trim(); if(!v||!st.socket) return;
  if(!st.data) st.data={}; if(!st.data.chatLog) st.data.chatLog=[];
  st.data.chatLog.push({name:st.name||'me',text:v,timestamp:Date.now()}); renderChat();
  st.socket.emit('chat-message',{battleId:st.battleId,playerId:st.playerId,text:v}); $('#chatInput').value='';
}

/* 항상 활성 */
function forceEnableButtons(){
  ['t1','t2'].forEach(side=>{
    ['attack','defend','dodge','pass','use'].forEach(k=>{const el=document.getElementById(`${side}-${k}`); if(el) el.disabled=false;});
  });
}

/* 액션 */
async function doAction(type,payload={}){try{const r=await fetch(`/api/battles/${st.battleId}/action`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({battleId:st.battleId,playerId:st.playerId,action:{type,...payload}})});if(!r.ok){throw new Error(await r.text()||'액션 실패');}const j=await r.json();if(!j.success)throw new Error(j.error||'실패');}catch(e){toast(e.message||'실패');} finally { refresh(); }}

/* 새로고침(주기 폴링 포함) */
$('#refreshBtn').onclick=refresh;
async function refresh(){try{const r=await fetch(`/api/battles/${st.battleId}/state`);if(!r.ok)throw 0;st.data=await r.json();render(true);}catch(e){}}
</script>
</body>
</html>
