<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ê´€ë¦¬ì í˜ì´ì§€</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h1>ì „íˆ¬ ê´€ë¦¬</h1>
    <button id="createBattleBtn">ì „íˆ¬ ìƒì„±</button>
    <button id="generateLinksBtn">ë§í¬ ìƒì„±</button>
    <button id="refreshBtn">ìƒíƒœ ê°±ì‹ </button>

    <h3>ê´€ë¦¬ì URL:</h3>
    <input type="text" id="adminUrl" readonly>

    <h3>í”Œë ˆì´ì–´ URL:</h3>
    <input type="text" id="playerUrl" readonly>

    <h3>ê´€ì „ì URL:</h3>
    <input type="text" id="spectatorUrl" readonly>

    <div class="otp-section">
      <h2>ğŸ”’ ì¸ì¦ ë° ì ‘ê·¼ ì œì–´</h2>

      <button id="generateOtpBtn">ê´€ë¦¬ì OTP</button>
      <input type="text" id="otpDisplay" readonly>

      <input type="text" id="otpInput" placeholder="OTP ì…ë ¥">
      <button id="loginBtn">ê´€ë¦¬ì ë¡œê·¸ì¸</button>
      <div id="authStatus">ì¸ì¦ë˜ì§€ ì•ŠìŒ</div>
    </div>

    <input type="text" id="playerNameInput" placeholder="í”Œë ˆì´ì–´ ì´ë¦„" />
    <button id="playerJoinBtn">í”Œë ˆì´ì–´ ì…ì¥</button>

    <div id="logBox" style="margin-top: 20px; white-space: pre-wrap; color: red;"></div>
  </div>

  <script>
    let battleId = null;
    let token = null;

    const $ = id => document.getElementById(id);

    function log(msg) {
      $("logBox").textContent = msg;
    }

    async function createBattle() {
      const res = await fetch("/api/battles", { method: "POST" });
      const data = await res.json();
      battleId = data.battleId;
      log("ì „íˆ¬ ìƒì„± ì™„ë£Œ: " + battleId);
    }

    function generateLinks() {
      if (!battleId) return alert("ì „íˆ¬ë¥¼ ë¨¼ì € ìƒì„±í•˜ì„¸ìš”.");

      const adminToken = generateToken("admin");
      const playerToken = generateToken("player");
      const spectatorToken = generateToken("spectator");

      $("adminUrl").value = `${location.origin}/admin?token=${adminToken}&battle=${battleId}`;
      $("playerUrl").value = `${location.origin}/play?token=${playerToken}&battle=${battleId}`;
      $("spectatorUrl").value = `${location.origin}/watch?token=${spectatorToken}&battle=${battleId}`;
    }

    function generateToken(role) {
      return btoa(`${role}-${Date.now()}`);
    }

    async function refreshBattle() {
      if (!battleId) return alert("ì „íˆ¬ ID ì—†ìŒ");

      const res = await fetch(`/api/battles/${battleId}`);
      const data = await res.json();
      renderTeam(data.teams?.team1?.players || [], "team1");
      renderTeam(data.teams?.team2?.players || [], "team2");
    }

    function renderTeam(list, teamName) {
      if (!Array.isArray(list)) return;
      list.forEach(player => {
        console.log(`[${teamName}] ${player}`);
      });
    }

    async function issueOtp() {
      if (!battleId) return alert("ì „íˆ¬ ìƒì„± í›„ ì‹¤í–‰í•˜ì„¸ìš”.");

      const form = new URLSearchParams();
      form.append("role", "admin");

      const res = await fetch(`/api/admin/battles/${battleId}/issue-otp`, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: form.toString()
      });

      const data = await res.json();
      if (data.success) {
        $("otpDisplay").value = data.otp;
        log("OTP ë°œê¸‰ ì„±ê³µ");
      } else {
        log("OTP ë°œê¸‰ ì‹¤íŒ¨: " + data.error);
      }
    }

    async function loginAsAdmin() {
      const otp = $("otpInput").value.trim();
      if (!otp || !battleId) return alert("OTPì™€ ì „íˆ¬ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.");

      const form = new URLSearchParams();
      form.append("otp", otp);
      form.append("role", "admin");
      form.append("battleId", battleId);

      const res = await fetch("/api/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: form.toString()
      });

      const data = await res.json();
      if (data.success) {
        token = data.token;
        $("authStatus").textContent = "ì¸ì¦ ì™„ë£Œ";
        $("authStatus").style.color = "green";
        log("ê´€ë¦¬ì ì¸ì¦ ì„±ê³µ");
      } else {
        $("authStatus").textContent = "ì¸ì¦ ì‹¤íŒ¨";
        $("authStatus").style.color = "red";
        log("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + (data.error || "ì˜¤ë¥˜ ë°œìƒ"));
      }
    }

    $("createBattleBtn").onclick = createBattle;
    $("generateLinksBtn").onclick = generateLinks;
    $("refreshBtn").onclick = refreshBattle;
    $("generateOtpBtn").onclick = issueOtp;
    $("loginBtn").onclick = loginAsAdmin;
  </script>
</body>
</html>
