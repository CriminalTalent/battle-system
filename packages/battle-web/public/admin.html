<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <title>전투 시스템 - 관리자 콘솔</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="root"></div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    let BATTLE = null;
    let TOK = {};
    let socket = null;

    const $ = (sel) => document.querySelector(sel);

    async function api(url, opts = {}) {
      try {
        const res = await fetch(url, {
          headers: { 'Content-Type': 'application/json', ...opts.headers },
          ...opts
        });
        if (!res.ok) {
          const error = await res.json().catch(() => ({ error: `HTTP ${res.status}` }));
          throw new Error(error.error || `HTTP ${res.status}`);
        }
        return await res.json();
      } catch (error) {
        alert(error.message);
        throw error;
      }
    }

    function getParams() {
      const params = new URLSearchParams(location.search);
      return {
        battleId: params.get("battle") || '',
        token: params.get("token") || ''
      };
    }

    async function loadBattle(battleId) {
      const battle = await api(`/api/battles/${battleId}`);
      console.log("Battle loaded:", battle);
      // 필요한 UI 반영
    }

    async function authAsAdmin(battleId, otp) {
      const result = await api(`/api/admin/battles/${battleId}/auth`, {
        method: 'POST',
        body: JSON.stringify({ otp, role: 'admin' })
      });
      TOK.admin = result.token;
      console.log("Admin authenticated:", result.token);
    }

    function connectSocket() {
      socket = io();
      socket.on('connect', () => {
        console.log('Socket connected:', socket.id);
        if (TOK.admin && BATTLE) {
          socket.emit('adminAuth', { battleId: BATTLE, otp: TOK.admin });
        }
      });
      socket.on('battleUpdate', (battle) => {
        console.log('Battle updated:', battle);
      });
      socket.on('disconnect', () => {
        console.log('Socket disconnected');
      });
    }

    async function init() {
      const { battleId, token } = getParams();
      if (!battleId || !token) {
        document.body.innerHTML = '<h2>잘못된 접근입니다. battle ID와 token이 필요합니다.</h2>';
        return;
      }

      BATTLE = battleId;
      TOK.admin = token;

      await loadBattle(battleId);
      connectSocket();
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
