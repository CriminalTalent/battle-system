<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>관리자 콘솔</title>
<style>
:root {
  --deep-navy:#0a0f1a; --navy:#0f1419; --navy-light:#1a1f26;
  --gold:#E5C88A; --gold-light:#F5E6B8; --gold-dark:#C8A882;
  --accent:#2a3441; --text-primary:#F5E6B8; --text-secondary:#D4C39A;
  --border:rgba(229,200,138,0.3); --border-light:rgba(229,200,138,0.15);
  --glass:rgba(15,20,25,0.85); --glass-dark:rgba(10,15,26,0.9);
  --success:#27ae60; --warning:#f39c12; --danger:#e74c3c;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  background:linear-gradient(135deg,var(--deep-navy),var(--navy),var(--navy-light));
  color:var(--text-primary);
  font-family:'Cinzel','Times New Roman',serif;
  min-height:100vh; padding:16px;
}
.container{max-width:1200px;margin:0 auto;display:grid;gap:16px}
.panel{background:var(--glass-dark);border:2px solid var(--border);border-radius:12px;padding:16px}
.h1{font-size:clamp(1.4rem,3.5vw,2.0rem);color:var(--gold);text-align:center;margin-bottom:8px}
.label{font-size:13px;color:var(--text-secondary);margin-bottom:6px}
.input,select,button{font-size:14px}
.input,select{
  width:100%;background:var(--navy-light);border:2px solid var(--border-light);
  border-radius:8px;padding:10px 12px;color:var(--text-primary)
}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.btn{background:linear-gradient(135deg,var(--gold),var(--gold-dark));color:#0a0f1a;border:none;border-radius:8px;padding:12px 16px;font-weight:700;cursor:pointer}
.btn-outline{background:var(--accent);color:var(--text-primary);border:2px solid var(--border)}
.grid{display:grid;gap:10px}
.grid-3{grid-template-columns:repeat(3,1fr)}
.grid-2{grid-template-columns:repeat(2,1fr)}
.table{border:1px solid var(--border);border-radius:8px;overflow:hidden}
.table header{background:var(--navy-light);padding:8px 12px;font-weight:700}
.table .body{max-height:220px;overflow:auto}
.item{padding:8px 12px;border-top:1px solid var(--border-light);font-size:13px}
.flex{display:flex;gap:8px;align-items:center}
.link{word-break:break-all;background:var(--navy-light);border:1px dashed var(--border);padding:8px;border-radius:8px}
.small{font-size:12px;color:var(--text-secondary)}
.badge{display:inline-block;border:1px solid var(--border);padding:2px 6px;border-radius:999px;font-size:11px;background:var(--accent)}
hr{border:none;border-top:1px solid var(--border-light);margin:8px 0}
@media(max-width:768px){.row,.grid-3,.grid-2{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
  <div class="panel">
    <div class="h1">관리자 콘솔</div>
    <div class="small">전투 모드 선택 → 전투 생성 → 링크/OTP 발급 → 전투 시작 순으로 진행하세요.</div>
  </div>

  <div class="panel grid grid-3">
    <div>
      <div class="label">전투 모드</div>
      <select id="mode">
        <option value="1v1">1v1</option>
        <option value="2v2">2v2</option>
        <option value="3v3">3v3</option>
        <option value="4v4">4v4</option>
      </select>
    </div>
    <div class="flex" style="align-items:flex-end">
      <button id="createBattle" class="btn">전투 생성</button>
      <span id="battleIdBadge" class="badge" style="display:none"></span>
    </div>
    <div class="flex" style="align-items:flex-end">
      <button id="startBattle" class="btn-outline" disabled>전투 시작</button>
      <button id="endBattle" class="btn-outline" disabled>강제 종료</button>
      <button id="nextTurn" class="btn-outline" disabled>다음 턴</button>
    </div>
  </div>

  <div class="panel grid grid-2">
    <div>
      <div class="label">링크/토큰 발급</div>
      <div class="flex">
        <button id="issueLinks" class="btn-outline" disabled>관리자/플레이어/관전자 토큰 생성</button>
      </div>
      <div class="grid" style="margin-top:8px">
        <div>
          <div class="label">관리자 접속 URL</div>
          <div id="adminUrl" class="link"></div>
        </div>
        <div>
          <div class="label">플레이어 접속 URL</div>
          <div id="playerUrl" class="link"></div>
        </div>
        <div>
          <div class="label">관전자 접속 URL</div>
          <div id="spectatorUrl" class="link"></div>
        </div>
      </div>
    </div>
    <div>
      <div class="label">OTP 발급</div>
      <div class="row">
        <select id="otpRole">
          <option value="admin">관리자</option>
          <option value="player">플레이어</option>
          <option value="spectator">관전자</option>
        </select>
        <input id="otpPlayerName" class="input" placeholder="플레이어 이름(선택)">
      </div>
      <div class="flex" style="margin-top:8px">
        <button id="issueOtp" class="btn-outline" disabled>OTP 발급</button>
        <div id="otpOut" class="badge" style="display:none"></div>
      </div>
    </div>
  </div>

  <div class="panel grid grid-2">
    <div class="table">
      <header>전투 로그</header>
      <div id="logBody" class="body"></div>
    </div>
    <div class="table">
      <header>채팅</header>
      <div id="chatBody" class="body"></div>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
(function(){
  const $ = s=>document.querySelector(s);
  let battleId = null;
  let socket = null;

  function connectSocket(id){
    if (socket) socket.disconnect();
    socket = io({ path: '/socket.io' });
    socket.on('connect', ()=>{
      socket.emit('join-admin', { battleId: id });
    });
    socket.on('battle-state', ({ state })=> renderState(state));
    socket.on('chat-message', ({ message })=>{
      append($('#chatBody'), formatChat(message));
    });
  }

  function formatLog(e){
    const d = new Date(e.timestamp);
    return `<div class="item"><span class="small">${d.toLocaleTimeString()}</span> · ${e.message}</div>`;
  }
  function formatChat(e){
    const d = new Date(e.timestamp);
    return `<div class="item"><span class="small">${d.toLocaleTimeString()}</span> · <b>${e.sender}</b>: ${e.message}</div>`;
  }
  function append(el, html){ const div=document.createElement('div'); div.innerHTML=html; el.appendChild(div.firstChild); el.scrollTop=el.scrollHeight; }

  function renderState(state){
    // 버튼 활성화
    $('#startBattle').disabled = !(state && state.status==='waiting');
    $('#endBattle').disabled = !(state && state.status!=='ended');
    $('#nextTurn').disabled = !(state && state.status==='ongoing');

    // 로그/채팅
    const lb=$('#logBody'); lb.innerHTML='';
    (state.battleLog||[]).slice(-200).forEach(e=> append(lb, formatLog(e)));
    const cb=$('#chatBody'); cb.innerHTML='';
    (state.chatLog||[]).slice(-200).forEach(e=> append(cb, formatChat(e)));
  }

  // API
  async function post(url, data){
    const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data||{}) });
    const j = await r.json();
    if (!r.ok || j.error) throw new Error(j.error||'요청 실패');
    return j;
  }

  // 이벤트
  $('#createBattle').addEventListener('click', async ()=>{
    const mode = $('#mode').value;
    const j = await post('/api/battles', { mode });
    battleId = j.battleId;
    $('#battleIdBadge').style.display='inline-block';
    $('#battleIdBadge').textContent = `전투 ID: ${battleId}`;
    $('#issueLinks').disabled = false;
    $('#issueOtp').disabled = false;
    connectSocket(battleId);
  });

  $('#issueLinks').addEventListener('click', async ()=>{
    if (!battleId) return;
    const j = await post(`/api/admin/battles/${battleId}/links`);
    const { admin, player, spectator } = j.tokens;
    $('#adminUrl').textContent    = `${location.origin}/admin.html?battle=${battleId}&token=${admin}`;
    $('#playerUrl').textContent   = `${location.origin}/play.html?battle=${battleId}&token=${player}`;
    $('#spectatorUrl').textContent= `${location.origin}/watch.html?battle=${battleId}&token=${spectator}`;
  });

  $('#issueOtp').addEventListener('click', async ()=>{
    if (!battleId) return;
    const role = $('#otpRole').value;
    const playerName = $('#otpPlayerName').value || undefined;
    const j = await post(`/api/admin/battles/${battleId}/issue-otp`, { role, playerName });
    $('#otpOut').style.display='inline-block';
    $('#otpOut').textContent = `OTP: ${j.otp}`;
  });

  $('#startBattle').addEventListener('click', async ()=>{
    if (!battleId) return;
    await post(`/api/admin/battles/${battleId}/start`);
  });
  $('#endBattle').addEventListener('click', async ()=>{
    if (!battleId) return;
    await post(`/api/admin/battles/${battleId}/end`, {});
  });
  $('#nextTurn').addEventListener('click', async ()=>{
    if (!battleId) return;
    await post(`/api/admin/battles/${battleId}/next-turn`, {});
  });
})();
</script>
</body>
</html>
