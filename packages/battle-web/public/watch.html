<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pyxis 전투 관전석 - 관전자 인터페이스</title>
<style>
:root {
  --deep-navy: #0a0f1a;
  --navy: #0f1419;
  --navy-light: #1a1f26;
  --gold: #E5C88A;
  --gold-light: #F5E6B8;
  --gold-dark: #C8A882;
  --accent: #2a3441;
  --text-primary: #F5E6B8;
  --text-secondary: #D4C39A;
  --border: rgba(229, 200, 138, 0.3);
  --border-light: rgba(229, 200, 138, 0.15);
  --shadow: rgba(229, 200, 138, 0.2);
  --glass: rgba(15, 20, 25, 0.85);
  --glass-dark: rgba(10, 15, 26, 0.9);
  --phoenix: #E5C88A;
  --death: #C8A882;
  --spectator: #D4C39A;
  --hp-gradient: linear-gradient(90deg, var(--gold-light), var(--gold), var(--gold-dark));
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  background: linear-gradient(135deg, var(--deep-navy) 0%, var(--navy) 50%, var(--navy-light) 100%);
  color: var(--text-primary);
  font-family: 'Cinzel', 'Times New Roman', serif;
  height: 100vh;
  overflow: hidden;
  position: relative;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: 
    radial-gradient(circle at 20% 30%, rgba(229, 200, 138, 0.06) 0%, transparent 50%),
    radial-gradient(circle at 80% 70%, rgba(229, 200, 138, 0.06) 0%, transparent 50%),
    radial-gradient(circle at 40% 80%, rgba(229, 200, 138, 0.04) 0%, transparent 60%);
  pointer-events: none;
  z-index: -1;
}

/* Spectator Login */
.spectator-login {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 1000;
  background: rgba(10, 15, 26, 0.95);
  display: flex;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(20px);
}

.login-panel {
  background: var(--glass-dark);
  border: 2px solid var(--spectator);
  border-radius: 20px;
  padding: 40px;
  max-width: 500px;
  width: 90%;
  backdrop-filter: blur(15px);
  box-shadow: 0 20px 40px rgba(212, 195, 154, 0.3);
}

.login-title {
  text-align: center;
  font-size: 2.5rem;
  color: var(--spectator);
  margin-bottom: 30px;
  text-shadow: 0 0 20px rgba(212, 195, 154, 0.5);
  letter-spacing: 2px;
}

.login-form {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
  margin-bottom: 25px;
}

.form-field {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-field label {
  color: var(--spectator);
  font-weight: 600;
  font-size: 0.9rem;
}

.form-field input {
  background: rgba(10, 15, 26, 0.8);
  border: 1px solid var(--border-light);
  border-radius: 8px;
  padding: 12px;
  color: var(--text-primary);
  font-size: 0.9rem;
  transition: all 0.3s ease;
}

.form-field input:focus {
  outline: none;
  border-color: var(--spectator);
  box-shadow: 0 0 0 2px rgba(212, 195, 154, 0.2);
}

.form-field input[readonly] {
  background: rgba(10, 15, 26, 0.5);
  color: var(--text-secondary);
}

.login-btn {
  width: 100%;
  background: linear-gradient(135deg, #9B8355, var(--spectator));
  border: 1px solid var(--spectator);
  border-radius: 10px;
  padding: 15px;
  color: var(--deep-navy);
  font-weight: 600;
  font-size: 1.1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.login-btn:hover {
  background: linear-gradient(135deg, var(--spectator), #E8D5A3);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(212, 195, 154, 0.4);
}

/* Spectator Arena Layout */
.spectator-arena {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: grid;
  grid-template-areas:
    "header header header header"
    "team1 battlefield battlefield team2"
    "sidebar sidebar sidebar sidebar"
    "chat chat chat chat";
  grid-template-rows: 80px 1fr 200px 140px;
  grid-template-columns: 280px 1fr 1fr 280px;
  gap: 12px;
  padding: 12px;
}

/* Header */
.spectator-header {
  grid-area: header;
  background: var(--glass-dark);
  border: 2px solid var(--spectator);
  border-radius: 15px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 30px;
  backdrop-filter: blur(15px);
  box-shadow: 0 0 30px rgba(212, 195, 154, 0.4);
}

.header-title {
  font-size: 1.8rem;
  font-weight: bold;
  color: var(--spectator);
  text-shadow: 0 0 15px rgba(212, 195, 154, 0.5);
  letter-spacing: 1px;
  display: flex;
  align-items: center;
  gap: 15px;
}

.live-indicator {
  width: 12px;
  height: 12px;
  background: var(--death);
  border-radius: 50%;
  animation: pulse 2s infinite;
}

.header-status {
  display: flex;
  gap: 15px;
  font-size: 0.9rem;
}

.status-badge {
  padding: 8px 16px;
  border-radius: 20px;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  font-weight: 600;
}

/* Team Panels */
.team-panel {
  background: var(--glass);
  border: 2px solid;
  border-radius: 15px;
  padding: 20px;
  backdrop-filter: blur(10px);
  overflow-y: auto;
}

.team-panel.phoenix {
  grid-area: team1;
  border-color: var(--gold);
  box-shadow: 0 0 20px rgba(229, 200, 138, 0.15);
}

.team-panel.death {
  grid-area: team2;
  border-color: var(--gold-dark);
  box-shadow: 0 0 20px rgba(200, 168, 130, 0.15);
}

.team-header {
  text-align: center;
  font-size: 1.3rem;
  font-weight: bold;
  margin-bottom: 20px;
  padding: 12px;
  border-radius: 10px;
  text-shadow: 0 0 10px currentColor;
}

.team-panel.phoenix .team-header {
  color: var(--gold);
  background: rgba(229, 200, 138, 0.1);
}

.team-panel.death .team-header {
  color: var(--gold-dark);
  background: rgba(200, 168, 130, 0.1);
}

.team-stats {
  text-align: center;
  margin-top: 15px;
  font-size: 0.8rem;
  color: var(--text-secondary);
  padding: 8px;
  background: rgba(10, 15, 26, 0.5);
  border-radius: 8px;
}

/* Player Cards */
.player-card {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 12px;
  transition: all 0.3s ease;
  position: relative;
}

.player-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

.player-card.dead {
  opacity: 0.4;
  filter: grayscale(1);
}

.player-card.active-turn {
  border-color: var(--gold);
  box-shadow: 0 0 20px rgba(229, 200, 138, 0.4);
}

.player-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  border: 2px solid var(--gold);
  float: left;
  margin-right: 12px;
  object-fit: cover;
  background: var(--navy);
}

.player-info {
  overflow: hidden;
}

.player-name {
  font-size: 1rem;
  font-weight: bold;
  color: var(--gold);
  margin-bottom: 6px;
}

.player-hp {
  margin-bottom: 6px;
  font-size: 0.85rem;
}

.hp-bar {
  height: 6px;
  background: var(--navy);
  border-radius: 3px;
  overflow: hidden;
  margin-top: 3px;
}

.hp-fill {
  height: 100%;
  background: var(--hp-gradient);
  transition: width 0.5s ease;
}

.player-stats {
  font-size: 0.75rem;
  color: var(--text-secondary);
  margin-top: 5px;
}

.player-status {
  font-size: 0.7rem;
  margin-top: 4px;
  padding: 2px 6px;
  border-radius: 4px;
  display: inline-block;
}

.status-acting {
  background: rgba(229, 200, 138, 0.2);
  color: var(--gold);
}

.status-done {
  background: rgba(108, 122, 137, 0.2);
  color: #6c7a89;
}

/* Central Battlefield */
.battlefield {
  grid-area: battlefield;
  background: var(--glass);
  border: 2px solid var(--accent);
  border-radius: 15px;
  padding: 25px;
  backdrop-filter: blur(10px);
  display: flex;
  flex-direction: column;
  position: relative;
  overflow: hidden;
}

.battlefield::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: radial-gradient(circle at center, rgba(42, 52, 65, 0.1) 0%, transparent 70%);
  pointer-events: none;
}

.battle-overview {
  background: rgba(10, 15, 26, 0.8);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  border: 1px solid var(--border-light);
}

.overview-title {
  color: var(--gold);
  font-size: 1.2rem;
  margin-bottom: 15px;
  font-weight: bold;
}

.battle-stats {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  font-size: 0.85rem;
}

.stat-item {
  display: flex;
  justify-content: space-between;
  padding: 4px 0;
  border-bottom: 1px solid var(--border-light);
}

.stat-label {
  color: var(--text-secondary);
}

.stat-value {
  color: var(--gold);
  font-weight: 600;
}

.battle-log {
  flex: 1;
  background: rgba(10, 15, 26, 0.8);
  border-radius: 12px;
  padding: 20px;
  overflow-y: auto;
  font-size: 0.8rem;
  line-height: 1.5;
}

.battle-log::-webkit-scrollbar {
  width: 6px;
}

.battle-log::-webkit-scrollbar-track {
  background: transparent;
}

.battle-log::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 3px;
}

/* Info Sidebar */
.info-sidebar {
  grid-area: sidebar;
  background: var(--glass-dark);
  border: 2px solid var(--gold);
  border-radius: 15px;
  padding: 20px;
  backdrop-filter: blur(10px);
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.info-panel {
  background: rgba(10, 15, 26, 0.8);
  border-radius: 12px;
  padding: 16px;
  border: 1px solid var(--border-light);
}

.info-title {
  color: var(--gold);
  font-size: 1rem;
  margin-bottom: 12px;
  font-weight: bold;
}

.info-content {
  font-size: 0.8rem;
  line-height: 1.4;
  color: var(--text-secondary);
  font-family: 'Monaco', 'Consolas', monospace;
}

/* Chat Area */
.spectator-chat {
  grid-area: chat;
  background: var(--glass-dark);
  border: 2px solid var(--spectator);
  border-radius: 15px;
  padding: 20px;
  backdrop-filter: blur(10px);
  display: flex;
  flex-direction: column;
}

.chat-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.chat-title {
  color: var(--spectator);
  font-weight: bold;
  font-size: 1.1rem;
}

.viewer-count {
  color: var(--text-secondary);
  font-size: 0.85rem;
}

.chat-messages {
  flex: 1;
  background: rgba(10, 15, 26, 0.8);
  border-radius: 10px;
  padding: 15px;
  overflow-y: auto;
  font-size: 0.8rem;
  margin-bottom: 15px;
  line-height: 1.4;
}

.chat-messages::-webkit-scrollbar {
  width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
  background: transparent;
}

.chat-messages::-webkit-scrollbar-thumb {
  background: var(--spectator);
  border-radius: 3px;
}

.chat-input-area {
  display: flex;
  gap: 12px;
}

.chat-input {
  flex: 1;
  background: rgba(10, 15, 26, 0.9);
  color: var(--text-primary);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 10px;
  font-size: 0.9rem;
}

.chat-send {
  padding: 10px 16px;
  background: var(--spectator);
  color: var(--deep-navy);
  border: 1px solid var(--spectator);
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s ease;
}

.chat-send:hover {
  background: #E8D5A3;
}

.refresh-btn {
  padding: 10px 16px;
  background: var(--accent);
  color: var(--text-primary);
  border: 1px solid var(--accent);
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s ease;
}

.refresh-btn:hover {
  background: var(--navy-light);
}

/* Notifications */
.notifications {
  position: fixed;
  bottom: 20px;
  right: 20px;
  max-width: 350px;
  z-index: 2000;
}

.notification {
  padding: 12px 18px;
  margin-bottom: 10px;
  border-radius: 8px;
  font-weight: 500;
  animation: slideIn 0.3s ease;
}

.notification.error {
  background: linear-gradient(135deg, #c0392b, #e74c3c);
  border: 1px solid #e74c3c;
  color: white;
}

.notification.success {
  background: linear-gradient(135deg, #27ae60, #2ecc71);
  border: 1px solid #2ecc71;
  color: white;
}

.notification.info {
  background: var(--glass);
  border: 1px solid var(--border);
  color: var(--text-primary);
}

/* Animations */
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
  .spectator-arena {
    grid-template-areas:
      "header"
      "battlefield"
      "sidebar"
      "chat";
    grid-template-rows: 70px 1fr 160px 120px;
    grid-template-columns: 1fr;
  }
  
  .team-panel {
    display: none;
  }
  
  .info-sidebar {
    grid-template-columns: 1fr;
  }
  
  .login-form {
    grid-template-columns: 1fr;
  }
  
  .battle-stats {
    grid-template-columns: 1fr;
  }
}

.loading {
  opacity: 0.7;
  pointer-events: none;
}
</style>
</head>
<body>

<!-- Spectator Login -->
<div id="spectatorLogin" class="spectator-login">
  <div class="login-panel">
    <div class="login-title">전투 관전</div>
    <div class="login-form">
      <div class="form-field">
        <label>전투 ID</label>
        <input id="battleId" type="text">
      </div>
      <div class="form-field">
        <label>접근 코드</label>
        <input id="otpCode" type="text">
      </div>
      <div class="form-field">
        <label>토큰</label>
        <input id="tokenInput" type="text" readonly>
      </div>
    </div>
    <button id="loginBtn" class="login-btn">관전석 입장</button>
    <div id="loginStatus" style="margin-top:15px;text-align:center"></div>
  </div>
</div>

<!-- Spectator Arena -->
<div id="spectatorArena" class="spectator-arena" style="display:none">
  <!-- Header -->
  <div class="spectator-header">
    <div class="header-title">
      <div class="live-indicator"></div>
      전투 관전석
    </div>
    <div class="header-status">
      <div class="status-badge" id="battlePhase">대기실</div>
      <div class="status-badge" id="battleMode">모드</div>
      <div class="status-badge" id="currentTurn">-</div>
      <div class="status-badge" id="winner">-</div>
    </div>
  </div>

  <!-- Team 1 Panel -->
  <div class="team-panel phoenix">
    <div class="team-header">불사조 기사단</div>
    <div id="team1Players"></div>
    <div class="team-stats" id="team1Stats"></div>
  </div>

  <!-- Central Battlefield -->
  <div class="battlefield">
    <div class="battle-overview">
      <div class="overview-title">전투 상태</div>
      <div class="battle-stats">
        <div class="stat-item">
          <span class="stat-label">단계:</span>
          <span class="stat-value" id="phaseDetail">-</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">턴 시간:</span>
          <span class="stat-value" id="turnTimeRemaining">-</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">시작 시간:</span>
          <span class="stat-value" id="battleStartTime">-</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">소요 시간:</span>
          <span class="stat-value" id="battleDuration">-</span>
        </div>
      </div>
    </div>
    <div class="battle-log" id="battleLog"></div>
  </div>

  <!-- Team 2 Panel -->
  <div class="team-panel death">
    <div class="team-header">죽음을 먹는 자들</div>
    <div id="team2Players"></div>
    <div class="team-stats" id="team2Stats"></div>
  </div>

  <!-- Info Sidebar -->
  <div class="info-sidebar">
    <div class="info-panel">
      <div class="info-title">전투 정보</div>
      <div class="info-content" id="battleInfo"></div>
    </div>
    <div class="info-panel">
      <div class="info-title">실시간 통계</div>
      <div class="info-content" id="battleStats"></div>
    </div>
  </div>

  <!-- Chat Area -->
  <div class="spectator-chat">
    <div class="chat-header">
      <div class="chat-title">실시간 채팅</div>
      <div class="viewer-count" id="viewerCount">관전 중</div>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input-area">
      <input id="chatInput" class="chat-input" placeholder="해설 입력..." maxlength="200">
      <button id="chatSendBtn" class="chat-send">전송</button>
      <button id="refreshBtn" class="refresh-btn">새로고침</button>
    </div>
  </div>
</div>

<div id="notifications" class="notifications"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
const $ = s => document.querySelector(s);

// URL parameters auto-fill
const qs = new URLSearchParams(location.search);
$('#battleId').value = qs.get('battle') || '';
$('#tokenInput').value = qs.get('token') || '';

let spectatorState = {
  battleId: null,
  token: null,
  socket: null,
  state: null
};

// Notification system
function showNotification(msg, type = 'info') {
  const div = document.createElement('div');
  div.className = `notification ${type}`;
  div.textContent = msg;
  $('#notifications').appendChild(div);
  setTimeout(() => div.remove(), 4000);
}

// Login
$('#loginBtn').onclick = async () => {
  const battleId = $('#battleId').value.trim();
  const token = $('#tokenInput').value.trim();
  const otp = $('#otpCode').value.trim();
  
  if (!battleId || !token || !otp) {
    showNotification('모든 필드를 입력해주세요', 'error');
    return;
  }

  try {
    const response = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ battleId, role: 'spectator', otp, token })
    });
    
    const result = await response.json();
    if (!result.ok) throw new Error(result.error);
    
    spectatorState.battleId = battleId;
    spectatorState.token = token;
    
    // Socket connection
    spectatorState.socket = io({ path: '/socket.io' });
    setupSocketEvents();
    
    $('#spectatorLogin').style.display = 'none';
    $('#spectatorArena').style.display = 'grid';
    
    showNotification('관전석 입장 완료!', 'success');
    await refreshState();
    
  } catch (err) {
    showNotification(`접근 거부: ${err.message}`, 'error');
  }
};

// Socket events
function setupSocketEvents() {
  const socket = spectatorState.socket;
  
  socket.on('connect', () => {
    socket.emit('join-battle', { battleId: spectatorState.battleId, role: 'spectator' });
  });
  
  socket.on('disconnect', () => {
    showNotification('관전석 연결이 끊어졌습니다', 'error');
  });
  
  socket.on('battle-state', refreshState);
  socket.on('player-joined', (data) => {
    refreshState();
    if (data.player) showNotification(`${data.player.name} 전투 참가`, 'success');
  });
  socket.on('action-executed', (data) => {
    refreshState();
    if (data.result?.description) showNotification(data.result.description, 'info');
  });
  socket.on('battle-started', () => {
    refreshState();
    showNotification('전투 개시!', 'success');
  });
  socket.on('battle-ended', (data) => {
    refreshState();
    const winner = data.winner === 'team1' ? '불사조 기사단' : 
                   data.winner === 'team2' ? '죽음을 먹는 자들' : '무승부';
    showNotification(`전투 종료! 승자: ${winner}`, 'success');
  });
  socket.on('chat-message', ({ message }) => {
    if (spectatorState.state?.chatLog) {
      spectatorState.state.chatLog.push(message);
      renderChat();
    }
  });
}

// Refresh state
async function refreshState() {
  if (!spectatorState.battleId) return;
  
  try {
    const response = await fetch(`/api/battles/${spectatorState.battleId}`);
    spectatorState.state = await response.json();
    renderAll();
  } catch (err) {
    showNotification('상태 업데이트 실패', 'error');
  }
}

// Render all components
function renderAll() {
  if (!spectatorState.state) return;
  
  renderHeader();
  renderTeams();
  renderBattleLog();
  renderInfo();
  renderChat();
}

function renderHeader() {
  const state = spectatorState.state;
  $('#battlePhase').textContent = state.phase === 'lobby' ? '대기실' : 
                                  state.phase === 'battle' ? '전투 중' :
                                  state.phase === 'ended' ? '종료' : state.phase;
  $('#battleMode').textContent = state.mode || '-';
  $('#currentTurn').textContent = state.currentTeam === 'team1' ? '불사조 기사단 턴' : 
                                   state.currentTeam === 'team2' ? '죽음을 먹는 자들 턴' : '-';
  $('#winner').textContent = state.winner === 'team1' ? '불사조 기사단 승리' :
                            state.winner === 'team2' ? '죽음을 먹는 자들 승리' :
                            state.winner === 'draw' ? '무승부' : '-';
}

function renderTeams() {
  renderTeamPanel(spectatorState.state.teams.team1, '#team1Players', '#team1Stats');
  renderTeamPanel(spectatorState.state.teams.team2, '#team2Players', '#team2Stats');
}

function renderTeamPanel(players, containerSelector, statsSelector) {
  const container = $(containerSelector);
  const statsEl = $(statsSelector);
  container.innerHTML = '';
  
  if (!players.length) {
    container.innerHTML = '<div style="text-align:center;color:var(--text-secondary);font-size:0.9rem">참가한 전사가 없습니다</div>';
    statsEl.textContent = '전사 0명';
    return;
  }
  
  const alive = players.filter(p => p.alive).length;
  const totalHp = players.reduce((sum, p) => sum + p.hp, 0);
  const maxHp = players.reduce((sum, p) => sum + p.maxHp, 0);
  
  players.forEach(player => {
    const div = document.createElement('div');
    const isCurrentPlayer = spectatorState.state.currentTeam === player.teamId && 
                           player.alive && !player.hasActed && spectatorState.state.phase === 'battle';
    
    div.className = `player-card ${!player.alive ? 'dead' : ''} ${isCurrentPlayer ? 'active-turn' : ''}`;
    
    const hpPercent = player.maxHp ? (player.hp / player.maxHp) * 100 : 0;
    
    div.innerHTML = `
      <div class="player-avatar" style="background-image:url('${player.imageUrl || ''}')"></div>
      <div class="player-info">
        <div class="player-name">${player.name}</div>
        <div class="player-hp">
          ${player.hp}/${player.maxHp} HP
          <div class="hp-bar">
            <div class="hp-fill" style="width:${hpPercent}%"></div>
          </div>
        </div>
        <div class="player-stats">
          공격:${player.stats.attack} 방어:${player.stats.defense} 민첩:${player.stats.agility} 행운:${player.stats.luck}
        </div>
        <div class="player-status ${!player.alive ? '' : player.hasActed ? 'status-done' : isCurrentPlayer ? 'status-acting' : ''}">
          ${!player.alive ? '전사' : player.hasActed ? '완료' : isCurrentPlayer ? '행동 중' : '대기'}
        </div>
      </div>
    `;
    
    container.appendChild(div);
  });
  
  statsEl.textContent = `${alive}/${players.length} 생존 (${totalHp}/${maxHp} HP)`;
}

function renderBattleLog() {
  const log = $('#battleLog');
  const entries = (spectatorState.state.battleLog || []).slice(-15).map(entry => {
    const time = new Date(entry.timestamp).toLocaleTimeString();
    return `[${time}] ${entry.result || entry.actor || entry.type}`;
  }).join('\n');
  log.textContent = entries;
  log.scrollTop = log.scrollHeight;
  
  // Update detailed status
  const state = spectatorState.state;
  $('#phaseDetail').textContent = state.phase;
  
  if (state.remainingTurnTime && state.phase === 'battle') {
    const minutes = Math.floor(state.remainingTurnTime / 60000);
    const seconds = Math.floor((state.remainingTurnTime % 60000) / 1000);
    $('#turnTimeRemaining').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
  } else {
    $('#turnTimeRemaining').textContent = '-';
  }
  
  $('#battleStartTime').textContent = state.startTime ? 
    new Date(state.startTime).toLocaleTimeString() : '-';
    
  if (state.startTime) {
    const duration = Math.floor((Date.now() - state.startTime) / 1000);
    const minutes = Math.floor(duration / 60);
    const seconds = duration % 60;
    $('#battleDuration').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
  } else {
    $('#battleDuration').textContent = '-';
  }
}

function renderInfo() {
  const state = spectatorState.state;
  
  // Battle information
  const battleInfo = `ID: ${state.id}
모드: ${state.mode}
단계: ${state.phase}
현재 팀: ${state.currentTeam === 'team1' ? '불사조 기사단' : 
               state.currentTeam === 'team2' ? '죽음을 먹는 자들' : '없음'}
승자: ${state.winner === 'team1' ? '불사조 기사단' :
          state.winner === 'team2' ? '죽음을 먹는 자들' :
          state.winner === 'draw' ? '무승부' : '미정'}`;
  $('#battleInfo').textContent = battleInfo;
  
  // Statistics
  const team1 = state.teams.team1 || [];
  const team2 = state.teams.team2 || [];
  const team1Alive = team1.filter(p => p.alive).length;
  const team2Alive = team2.filter(p => p.alive).length;
  const team1HP = team1.reduce((sum, p) => sum + p.hp, 0);
  const team2HP = team2.reduce((sum, p) => sum + p.hp, 0);
  const totalActions = (state.battleLog || []).filter(log => 
    ['attack', 'defend', 'use_item', 'dodge', 'pass'].includes(log.type)
  ).length;
  
  const stats = `불사조: ${team1Alive}/${team1.length} (${team1HP} HP)
죽음: ${team2Alive}/${team2.length} (${team2HP} HP)
총 행동: ${totalActions}
로그 항목: ${(state.battleLog || []).length}
메시지: ${(state.chatLog || []).length}`;
  $('#battleStats').textContent = stats;
}

function renderChat() {
  const chat = $('#chatMessages');
  const messages = (spectatorState.state.chatLog || []).slice(-12).map(msg => {
    const time = new Date(msg.timestamp).toLocaleTimeString();
    const colorMap = {
      system: '#E5C88A',
      admin: '#C8A882',
      player: '#D4C39A',
      spectator: '#F5E6B8'
    };
    const color = colorMap[msg.senderType] || '#fff';
    return `<div style="margin-bottom:6px;line-height:1.4">
      <span style="color:${color};font-weight:bold">[${time}] ${msg.sender}:</span>
      <span style="color:var(--text-primary)">${msg.message}</span>
    </div>`;
  }).join('');
  chat.innerHTML = messages;
  chat.scrollTop = chat.scrollHeight;
}

// Chat functionality
$('#chatSendBtn').onclick = () => {
  const message = $('#chatInput').value.trim();
  if (!message || !spectatorState.socket) return;
  
  spectatorState.socket.emit('send-chat', {
    battleId: spectatorState.battleId,
    sender: '관전자',
    message: message,
    senderType: 'spectator'
  });
  
  $('#chatInput').value = '';
};

$('#chatInput').addEventListener('keypress', e => {
  if (e.key === 'Enter') $('#chatSendBtn').click();
});

// Manual refresh
$('#refreshBtn').onclick = async () => {
  await refreshState();
  showNotification('관전석 새로고침 완료', 'success');
};

// Auto-refresh every 30 seconds
setInterval(() => {
  if (spectatorState.battleId && spectatorState.socket?.connected) {
    refreshState();
  }
}, 30000);

// Page visibility change refresh
document.addEventListener('visibilitychange', () => {
  if (!document.hidden && spectatorState.battleId) {
    refreshState();
  }
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
    e.preventDefault();
    refreshState();
  }
});

// Connection monitoring
setInterval(() => {
  if (spectatorState.socket && !spectatorState.socket.connected && spectatorState.battleId) {
    console.log('관전석 재연결 중...');
    spectatorState.socket.connect();
  }
}, 10000);
</script>
</body>
</html>
