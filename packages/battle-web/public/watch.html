<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ê´€ì „ì | Pyxis Battle</title>
<style>
:root{--navy:#012C4E;--beige:#EAD292;--line:rgba(234,210,146,.35)}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:var(--navy);color:var(--beige);font-family:"EB Garamond","Nanum Myeongjo",serif}
.container{max-width:1100px;margin:0 auto;padding:22px;display:flex;flex-direction:column;gap:16px}
header{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);padding:12px 16px;border-radius:10px}
h1{margin:0;font-size:26px}
.card{border:1px solid var(--line);background:rgba(1,44,78,.35);padding:14px;border-radius:10px}
.grid{display:grid;gap:12px}
.cols-2{grid-template-columns:1fr 1fr}
.cols-3{grid-template-columns:1fr 1fr 1fr}
label{display:block;margin:6px 0 4px 0}
input[type=text]{width:100%;padding:9px;border:1px solid var(--line);border-radius:8px;background:rgba(1,44,78,.5);color:var(--beige)}
button{border:1px solid var(--beige);background:transparent;color:var(--beige);padding:9px 12px;border-radius:8px;cursor:pointer}
button:hover{background:rgba(234,210,146,.12)}
button:disabled{opacity:0.5;cursor:not-allowed}
.btn-primary{background:var(--beige);color:var(--navy);border-color:var(--beige)}
pre{white-space:pre-wrap;word-break:break-word;margin:0}
.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
.card-mini{border:1px solid var(--line);border-radius:10px;padding:10px;background:rgba(0,0,0,.12)}
.thumb{width:100%;height:220px;object-fit:cover;border-radius:8px;border:1px solid var(--line);background:#06192a}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;margin-top:6px}
.list{border:1px solid var(--line);padding:10px;border-radius:8px;background:rgba(0,0,0,.15);height:160px;overflow:auto}
.small{font-size:12px;opacity:.9}
.error{color:#ef4444;background:rgba(239,68,68,.1);padding:8px;border-radius:6px;margin:4px 0}
.success{color:#22c55e;background:rgba(34,197,94,.1);padding:8px;border-radius:6px;margin:4px 0}
.loading{opacity:0.7;pointer-events:none}
.battle-info{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
.info-pill{background:rgba(1,44,78,.5);border:1px solid var(--line);padding:4px 8px;border-radius:6px;font-size:12px}
.live-indicator{animation:pulse 2s infinite}
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Pyxis Battle Spectator</h1>
    <div class="small">ë§í¬ì˜ token, battle + OTPë¡œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.</div>
  </header>

  <section id="login" class="card">
    <div class="grid cols-3">
      <div>
        <label>Battle ID</label>
        <input id="battle" type="text" placeholder="ì˜ˆ: ABC123">
      </div>
      <div>
        <label>OTP</label>
        <input id="otp" type="text" placeholder="1íšŒìš© ë¹„ë°€ë²ˆí˜¸">
      </div>
      <div>
        <label>ë§í¬ í† í°</label>
        <input id="token" type="text" placeholder="ìë™ ì…ë ¥ë¨" readonly>
      </div>
    </div>
    <div style="display:flex;align-items:center;justify-content:center;margin-top:10px">
      <button id="doLogin" class="btn-primary">ë¡œê·¸ì¸</button>
    </div>
    <div id="loginStatus"></div>
  </section>

  <section id="view" class="card" style="display:none">
    <div class="battle-info">
      <div class="info-pill">
        <span class="live-indicator">ğŸ”´</span> ì‹¤ì‹œê°„ ê´€ì „
      </div>
      <div class="info-pill" id="battleStatus">ìƒíƒœ: ë¡œë”©ì¤‘...</div>
      <div class="info-pill" id="battleMode">ëª¨ë“œ: -</div>
      <div class="info-pill" id="currentTurn">í˜„ì¬ í„´: -</div>
      <div class="info-pill" id="winner">ìŠ¹ì: -</div>
    </div>

    <div class="grid cols-2">
      <div class="card">
        <h3 style="margin:0 0 12px 0">ë¶ˆì‚¬ì¡° ê¸°ì‚¬ë‹¨ (Team 1)</h3>
        <div id="cards1" class="cards"></div>
        <div id="team1Status" class="small" style="margin-top:8px">í”Œë ˆì´ì–´: 0ëª…</div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 12px 0">ì£½ìŒì„ ë¨¹ëŠ” ìë“¤ (Team 2)</h3>
        <div id="cards2" class="cards"></div>
        <div id="team2Status" class="small" style="margin-top:8px">í”Œë ˆì´ì–´: 0ëª…</div>
      </div>
    </div>

    <div class="grid cols-2" style="margin-top:16px">
      <div>
        <label>ì „íˆ¬ ìƒíƒœ</label>
        <pre id="state" class="list" style="height:200px;font-size:11px"></pre>
      </div>
      <div>
        <label>ì‹¤ì‹œê°„ ë¡œê·¸</label>
        <pre id="log" class="list" style="height:200px;font-size:11px"></pre>
        <button id="refreshBtn" style="margin-top:4px;width:100%">ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>
  </section>

  <div id="notifications" style="position:fixed;bottom:10px;right:10px;max-width:400px;z-index:1000"></div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const $=s=>document.querySelector(s);
const api=(p,opt)=>fetch(p,opt).then(r=>r.json().catch(()=>r.text()));
const qs=new URLSearchParams(location.search);
$('#battle').value=qs.get('battle')||'';
$('#token').value=qs.get('token')||'';

let battleId=null, token=null, socket=null, state=null;

// ì•Œë¦¼ ì‹œìŠ¤í…œ
function showNotification(msg, type='info') {
  const div = document.createElement('div');
  div.className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'card';
  div.textContent = msg;
  div.style.cssText = 'margin-bottom:8px;animation:slideIn 0.3s ease';
  $('#notifications').appendChild(div);
  setTimeout(() => div.remove(), 5000);
}

// ë¡œë”© ìƒíƒœ ê´€ë¦¬
function setLoading(element, loading) {
  if (loading) {
    element.classList.add('loading');
    element.disabled = true;
  } else {
    element.classList.remove('loading');
    element.disabled = false;
  }
}

function renderCards(arr, mount){
  mount.innerHTML='';
  if (!arr || !arr.length) {
    mount.innerHTML = '<div class="small" style="text-align:center;opacity:0.6">ì°¸ê°€í•œ í”Œë ˆì´ì–´ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }

  arr.forEach(p=>{
    const div=document.createElement('div');
    div.className='card-mini';
    const hpPercent = p.maxHp ? Math.round((p.hp/p.maxHp)*100) : 0;
    const statusColor = p.alive ? '#22c55e' : '#ef4444';
    div.innerHTML=`
      <img class="thumb" src="${p.imageUrl||''}" onerror="this.style.display='none'" alt="${p.name}">
      <div style="margin-top:6px;font-weight:600">${p.name}</div>
      <div class="badge">HP ${p.hp}/${p.maxHp}</div>
      <div class="badge" style="border-color:${statusColor};color:${statusColor}">${p.alive?'ìƒì¡´':'ì‚¬ë§'}</div>
      <div style="font-size:10px;opacity:.8;margin-top:4px">
        ê³µê²©${p.stats?.attack} ë°©ì–´${p.stats?.defense}<br>
        ë¯¼ì²©${p.stats?.agility} í–‰ìš´${p.stats?.luck}
      </div>
      ${p.hasActed ? '<div style="font-size:10px;color:#fbbf24">í–‰ë™ì™„ë£Œ</div>' : ''}
    `;
    mount.appendChild(div);
  });
}

function updateBattleInfo() {
  if (!state) return;
  
  const statusMap = {
    lobby: 'ëŒ€ê¸°ì¤‘',
    battle: 'ì „íˆ¬ì¤‘',
    ended: 'ì¢…ë£Œ',
    paused: 'ì¼ì‹œì •ì§€'
  };
  
  $('#battleStatus').textContent = `ìƒíƒœ: ${statusMap[state.phase] || state.phase}`;
  $('#battleMode').textContent = `ëª¨ë“œ: ${state.mode || '-'}`;
  $('#currentTurn').textContent = `í˜„ì¬ í„´: ${state.currentTeam === 'team1' ? 'ë¶ˆì‚¬ì¡° ê¸°ì‚¬ë‹¨' : state.currentTeam === 'team2' ? 'ì£½ìŒì„ ë¨¹ëŠ” ìë“¤' : '-'}`;
  $('#winner').textContent = `ìŠ¹ì: ${state.winner === 'team1' ? 'ë¶ˆì‚¬ì¡° ê¸°ì‚¬ë‹¨' : state.winner === 'team2' ? 'ì£½ìŒì„ ë¨¹ëŠ” ìë“¤' : state.winner === 'draw' ? 'ë¬´ìŠ¹ë¶€' : '-'}`;
  
  // íŒ€ ìƒíƒœ ì—…ë°ì´íŠ¸
  const team1Count = state.teams?.team1?.length || 0;
  const team2Count = state.teams?.team2?.length || 0;
  const team1Alive = state.teams?.team1?.filter(p => p.alive).length || 0;
  const team2Alive = state.teams?.team2?.filter(p => p.alive).length || 0;
  
  $('#team1Status').textContent = `í”Œë ˆì´ì–´: ${team1Count}ëª… (ìƒì¡´: ${team1Alive}ëª…)`;
  $('#team2Status').textContent = `í”Œë ˆì´ì–´: ${team2Count}ëª… (ìƒì¡´: ${team2Alive}ëª…)`;
}

function render(){
  if(!state) return;
  
  updateBattleInfo();
  renderCards(state.teams?.team1, $('#cards1'));
  renderCards(state.teams?.team2, $('#cards2'));
  
  // ìƒíƒœ ì •ë³´ (ê°„ì†Œí™”)
  const stateInfo = {
    id: state.id,
    phase: state.phase,
    mode: state.mode,
    currentTeam: state.currentTeam,
    winner: state.winner,
    startTime: state.startTime ? new Date(state.startTime).toLocaleString() : null,
    endTime: state.endTime ? new Date(state.endTime).toLocaleString() : null
  };
  $('#state').textContent = JSON.stringify(stateInfo, null, 2);
  
  // ë¡œê·¸ (ìµœê·¼ 30ê°œë§Œ)
  const logs = (state.battleLog||[]).slice(-30).map(e => {
    const time = new Date(e.timestamp).toLocaleTimeString();
    return `[${time}] ${e.type}: ${e.result || e.actor || JSON.stringify(e)}`;
  }).join('\n');
  $('#log').textContent = logs;
  
  // ë¡œê·¸ ìë™ ìŠ¤í¬ë¡¤
  const logEl = $('#log');
  logEl.scrollTop = logEl.scrollHeight;
}

async function refresh(){
  if (!battleId) return;
  
  try {
    state = await api(`/api/battles/${battleId}`);
    if (state && !state.error) {
      render();
    } else {
      showNotification('ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨', 'error');
    }
  } catch(err) {
    showNotification(`ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜: ${err.message}`, 'error');
  }
}

// ë¡œê·¸ì¸ ì²˜ë¦¬
$('#doLogin').onclick = async ()=>{
  battleId = $('#battle').value.trim();
  token = $('#token').value.trim();
  const otp = $('#otp').value.trim();
  
  if(!battleId||!token||!otp) {
    showNotification('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
    return;
  }

  const btn = $('#doLogin');
  setLoading(btn, true);

  try {
    const r = await api('/api/auth/login',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({battleId,role:'spectator',otp,token})
    });
    
    if(!r.ok){ 
      throw new Error(r.error || 'ë¡œê·¸ì¸ ì‹¤íŒ¨');
    }

    $('#login').style.display='none';
    $('#view').style.display='';
    
    showNotification('ê´€ì „ ì‹œì‘!', 'success');
    await refresh();

    // Socket ì—°ê²°
    socket = io({path:'/socket.io'});
    socket.on('connect', ()=> {
      console.log('Socket connected');
      socket.emit('join-battle',{battleId});
    });
    
    socket.on('disconnect', () => {
      showNotification('ì‹¤ì‹œê°„ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤', 'error');
    });
    
    socket.on('battle-state', async ()=>{ 
      await refresh(); 
    });
    
    socket.on('player-joined', async (data)=>{ 
      await refresh(); 
      if (data.player) {
        showNotification(`${data.player.name}ì´ ì°¸ê°€í–ˆìŠµë‹ˆë‹¤`, 'success');
      }
    });
    
    socket.on('action-executed', async (data)=>{ 
      await refresh(); 
      if (data.result && data.result.description) {
        showNotification(data.result.description, 'info');
      }
    });
    
    socket.on('battle-started', async ()=>{ 
      await refresh(); 
      showNotification('ğŸš€ ì „íˆ¬ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
    });
    
    socket.on('battle-ended', async (data)=>{ 
      await refresh(); 
      const winnerText = data.winner === 'team1' ? 'ë¶ˆì‚¬ì¡° ê¸°ì‚¬ë‹¨' : 
                        data.winner === 'team2' ? 'ì£½ìŒì„ ë¨¹ëŠ” ìë“¤' : 
                        data.winner === 'draw' ? 'ë¬´ìŠ¹ë¶€' : 'ì•Œ ìˆ˜ ì—†ìŒ';
      showNotification(`ğŸ† ì „íˆ¬ ì¢…ë£Œ! ìŠ¹ì: ${winnerText}`, 'success');
    });

    // ìë™ ìƒˆë¡œê³ ì¹¨ (30ì´ˆë§ˆë‹¤)
    setInterval(refresh, 30000);
    
  } catch(err) {
    showNotification(`ë¡œê·¸ì¸ ì˜¤ë¥˜: ${err.message}`, 'error');
  } finally {
    setLoading(btn, false);
  }
};

// ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨
$('#refreshBtn').onclick = async () => {
  const btn = $('#refreshBtn');
  setLoading(btn, true);
  
  try {
    await refresh();
    showNotification('ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ', 'success');
  } catch(err) {
    showNotification(`ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: ${err.message}`, 'error');
  } finally {
    setLoading(btn, false);
  }
};

// ì´ˆê¸°í™” - URLì—ì„œ ê°’ì´ ìˆìœ¼ë©´ ìë™ ì…ë ¥
if ($('#battle').value && $('#token').value) {
  battleId = $('#battle').value;
  token = $('#token').value;
}

// í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
document.addEventListener('keydown', (e) => {
  if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
    e.preventDefault();
    if (battleId) {
      refresh();
      showNotification('ìƒˆë¡œê³ ì¹¨ (F5)', 'info');
    }
  }
});

// í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì‹œ ìë™ ìƒˆë¡œê³ ì¹¨
document.addEventListener('visibilitychange', () => {
  if (!document.hidden && battleId && socket && socket.connected) {
    refresh();
  }
});

// ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§
if (typeof io !== 'undefined') {
  setInterval(() => {
    if (socket && !socket.connected && battleId) {
      console.log('Attempting to reconnect...');
      socket.connect();
    }
  }, 10000); // 10ì´ˆë§ˆë‹¤ ì—°ê²° í™•ì¸
}
</script>

<style>
@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

/* ëª¨ë°”ì¼ ìµœì í™” */
@media (max-width: 768px) {
  .container { padding: 12px; }
  .cards { grid-template-columns: 1fr; }
  .grid.cols-2 { grid-template-columns: 1fr; }
  .grid.cols-3 { grid-template-columns: 1fr; }
  .battle-info { flex-direction: column; }
  .thumb { height: 160px; }
}

/* ë‹¤í¬ëª¨ë“œ ìŠ¤í¬ë¡¤ë°” */
.list::-webkit-scrollbar { width: 8px; }
.list::-webkit-scrollbar-track { background: rgba(1,44,78,.3); }
.list::-webkit-scrollbar-thumb { background: rgba(234,210,146,.3); border-radius: 4px; }
.list::-webkit-scrollbar-thumb:hover { background: rgba(234,210,146,.5); }
</style>
</body>
</html>
